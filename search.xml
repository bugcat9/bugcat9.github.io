<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Activityçš„ç”Ÿå‘½å‘¨æœŸç®€å•çš„ä¾‹å­</title>
    <url>/2021/08/18/Android%E5%AD%A6%E4%B9%A0/Activity%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
    <content><![CDATA[<h1 id="Activityçš„ç”Ÿå‘½å‘¨æœŸç®€å•çš„ä¾‹å­"><a href="#Activityçš„ç”Ÿå‘½å‘¨æœŸç®€å•çš„ä¾‹å­" class="headerlink" title="Activityçš„ç”Ÿå‘½å‘¨æœŸç®€å•çš„ä¾‹å­"></a>Activityçš„ç”Ÿå‘½å‘¨æœŸç®€å•çš„ä¾‹å­</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><code>Activity</code>æ˜¯androidå½“ä¸­é‡è¦çš„å†…å®¹ï¼Œæ¯ä¸ª<code>Activity</code>å®ä¾‹éƒ½æœ‰å…¶ç”Ÿå‘½å‘¨æœŸã€‚åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ï¼Œ<code>Activity</code>åœ¨è¿è¡Œã€æš‚åœã€åœæ­¢å’Œä¸å­˜åœ¨è¿™å››ç§çŠ¶æ€é—´è½¬æ¢ï¼Œæ¯æ¬¡çŠ¶æ€è½¬æ¢æ—¶ï¼Œéƒ½æœ‰ç›¸åº”çš„Activityæ–¹æ³•å‘æ¶ˆæ¯é€šçŸ¥activityã€‚Activity ç±»æä¾›å…­ä¸ªæ ¸å¿ƒå›è°ƒï¼š<code>onCreate()ã€onStart()ã€onResume()ã€onPause()ã€onStop()ã€onDestory()</code>ï¼Œå®˜æ–¹ç»™å‡ºçš„çŠ¶æ€å˜åŒ–ä»¥åŠå‡½æ•°è°ƒç”¨å¦‚ä¸‹å›¾æ‰€å±•ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/activity_lifecycle.png" alt="img"></p>
<p>ä½†æ˜¯æˆ‘æ„Ÿè§‰æ¯”è¾ƒå¥½ç†è§£çš„æ˜¯ã€ŠAndroidç¼–ç¨‹æƒå¨æŒ‡å—ã€‹ä¸­çš„å›¾è§£</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818155656276.png" alt="image-20210818155656276"></p>
<p>å¯ä»¥æ ¹æ®å†…å­˜ä¸­æœ‰æ²¡æœ‰<code>activity</code>çš„å®ä¾‹ï¼Œç”¨æˆ·æ˜¯å¦çœ‹å¾—åˆ°ï¼Œæ˜¯å¦æ´»è·ƒåœ¨å‰å°ï¼ˆç­‰å¾…æˆ–æ¥å—ç”¨æˆ·è¾“å…¥ä¸­ï¼‰ç­‰è¿™äº›ä½œä¸ºåˆ¤æ–­ï¼Œè°ƒç”¨äº†é‚£äº›å‡½æ•°ã€‚å®Œæ•´æ€»ç»“å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">çŠ¶æ€</th>
<th style="text-align:center">æœ‰å†…å­˜å®ä¾‹</th>
<th style="text-align:center">ç”¨æˆ·å¯è§</th>
<th style="text-align:center">å¤„äºå‰å°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ä¸å­˜åœ¨</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
</tr>
<tr>
<td style="text-align:center">åœæ­¢</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">å¦</td>
<td style="text-align:center">å¦</td>
</tr>
<tr>
<td style="text-align:center">æš‚åœ</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯æˆ–è€…éƒ¨åˆ†</td>
<td style="text-align:center">å¦</td>
</tr>
<tr>
<td style="text-align:center">è¿è¡Œ</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯</td>
<td style="text-align:center">æ˜¯</td>
</tr>
</tbody>
</table>
</div>
<span id="more"></span>
<h2 id="å®ä¾‹å±•ç¤º"><a href="#å®ä¾‹å±•ç¤º" class="headerlink" title="å®ä¾‹å±•ç¤º"></a>å®ä¾‹å±•ç¤º</h2><h3 id="å®ä¾‹ä¸€"><a href="#å®ä¾‹ä¸€" class="headerlink" title="å®ä¾‹ä¸€"></a>å®ä¾‹ä¸€</h3><p>åœ¨<code>Android Studio</code>ä¸­åˆ›å»ºé¡¹ç›®<code>ActivityLifecycle</code>ï¼Œç„¶ååœ¨<code>MainActivity</code>ä¸­å†™å…¥ä¸‹é¢ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.activitylifecycle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStart();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onStart() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResume</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onResume();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onResume() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPause();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onPause() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onStop();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onStop() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onDestroy();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onDestroy() called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åè¿è¡Œç¨‹åºï¼Œå®‰è£…åˆ°Androidæ‰‹æœºä¸Šï¼Œå†æŸ¥çœ‹LogCat</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818172208317.png" alt="image-20210818172208317"></p>
<p>å¯ä»¥çœ‹åˆ°<code>onCreate()ã€onStart()ã€onResume()</code>æŒ‰ç…§é¡ºåºè¢«è°ƒç”¨ï¼Œè¿™ä¹Ÿç¬¦åˆ<code>Activity</code>çš„çŠ¶æ€ä»<code>ä¸å­˜åœ¨â†’åœæ­¢â†’æš‚åœâ†’è¿è¡Œ</code>çš„è½¬å˜ã€‚</p>
<p>æ¥ç€åœ¨æ‰‹æœºä¸Šæˆ‘ä»¬å¯ä»¥å•å‡»åé€€é”®ï¼Œå†æŸ¥çœ‹LogCatã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ—¥å¿—æ˜¾ç¤º <code>MainActivity</code>çš„ <code>onPause()ã€ onStop() ã€onDestroy()</code>æ–¹æ³•è¢«ä¾æ¬¡è°ƒç”¨äº†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818173551090.png" alt="image-20210818173551090"></p>
<p>å•å‡»è®¾å¤‡çš„åé€€é”®ï¼Œç›¸å½“äºå‘Šè¯‰Androidç³»ç»Ÿï¼šâ€œactivityå·²ç”¨å®Œï¼Œç°åœ¨ä¸éœ€è¦å®ƒäº†ã€‚â€éšå³ï¼Œ ç³»ç»Ÿå°±é”€æ¯äº†è¯¥activityçš„è§†å›¾åŠå…¶å†…å­˜é‡Œçš„ç›¸å…³ä¿¡æ¯ã€‚è¿™å®é™…æ˜¯Androidç³»ç»ŸèŠ‚çº¦ä½¿ç”¨è®¾å¤‡æœ‰é™èµ„æºçš„ä¸€ç§æ–¹å¼ã€‚å¯¹åº”ç€<code>Activity</code>ä¸­çŠ¶æ€ä»<code>è¿è¡Œâ†’æš‚åœâ†’åœæ­¢â†’ä¸å­˜åœ¨</code>ï¼Œè¿™ä¹Ÿå¯¹åº”çš„å›¾ä¸­çš„å¯¹åº”å˜åŒ–ã€‚</p>
<h3 id="å®ä¾‹äºŒ"><a href="#å®ä¾‹äºŒ" class="headerlink" title="å®ä¾‹äºŒ"></a>å®ä¾‹äºŒ</h3><p>æˆ‘ä»¬å†æ¬¡ç‚¹å‡»åº”ç”¨ä»è€Œå¯åŠ¨åº”ç”¨ï¼Œå¯åŠ¨åº”ç”¨ä¹‹åæˆ‘ä»¬ç‚¹å‡»ä¸»å±å¹•é”®æˆ–è€…è¯´æ˜¯homeé”®ï¼Œé€€åˆ°ä¸»å±å¹•</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818181407786.png" alt="image-20210818181407786"></p>
<p>æ—¥å¿—ä¸Šæ˜¾ç¤ºï¼ŒAndroidå…ˆåˆ›å»ºäº†å…¨æ–°çš„<code>MainActivity</code>å®ä¾‹ï¼Œ ç„¶åè°ƒç”¨<code>onCreate()ã€onStart()å’ŒonResume()</code>æ–¹æ³•ã€‚<code>MainActivity</code>ä»ä¸å­˜åœ¨å˜ä¸ºè¿è¡ŒçŠ¶æ€ã€‚ç„¶åæˆ‘ä»¬ç‚¹å‡»ä¸»å±å¹•é”®åï¼Œç³»ç»Ÿè°ƒç”¨äº†<code>MainActivity</code>çš„<code>`onPause()å’ŒonStop()</code>æ–¹æ³•ï¼Œä½†å¹¶æ²¡æœ‰è°ƒç”¨<code>onDestroy()</code>æ–¹æ³•ï¼Œè¯´æ˜ç‚¹å‡»ä¸»å±å¹•é”®åªä¼šä½¿å¾—Activityå¤„äºåœæ­¢çŠ¶æ€ï¼ˆåœ¨å†…å­˜ä¸­ï¼Œ ä½†ä¸å¯è§ï¼Œä¸ä¼šæ´»åŠ¨åœ¨å‰å°ï¼‰ã€‚</p>
<p>ç„¶åå†æ¬¡ç‚¹å‡»åº”ç”¨ï¼Œå¯åŠ¨åº”ç”¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818181510264.png" alt="image-20210818181510264"></p>
<p>LogCatæ—¥å¿—æ˜¾ç¤ºï¼Œç³»ç»Ÿæ²¡æœ‰è°ƒç”¨onCreate()æ–¹æ³•ï¼ˆå› ä¸ºActivityå®ä¾‹è¿˜åœ¨å†…å­˜é‡Œï¼Œè‡ªç„¶ä¸ç”¨é‡å»ºäº†ï¼‰ï¼Œè€Œæ˜¯è°ƒç”¨äº†onStart()å’ŒonResume()æ–¹æ³•ã€‚ç”¨æˆ·æŒ‰äº†ä¸»å±å¹•é”®åï¼ŒMainActivity æœ€åè¿›å…¥åœæ­¢çŠ¶æ€ï¼Œå†æ¬¡è°ƒå‡ºåº”ç”¨æ—¶ï¼ŒMainActivity åªéœ€è¦é‡æ–°å¯åŠ¨ï¼ˆè¿›å…¥æš‚åœçŠ¶æ€ï¼Œç”¨æˆ·å¯ è§ï¼‰ï¼Œç„¶åç»§ç»­è¿è¡Œï¼ˆè¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œæ´»åŠ¨åœ¨å‰å°ï¼‰ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœæ­¢çš„activityèƒ½å¤Ÿå­˜åœ¨å¤šä¹…ï¼Œè°ä¹Ÿæ— æ³•ä¿è¯ã€‚ç³»ç»Ÿéœ€è¦å›æ”¶å†…å­˜æ—¶ï¼Œå®ƒå°†é¦–å…ˆé”€æ¯é‚£äº›åœæ­¢çš„activity</p>
<h3 id="å®ä¾‹ä¸‰"><a href="#å®ä¾‹ä¸‰" class="headerlink" title="å®ä¾‹ä¸‰"></a>å®ä¾‹ä¸‰</h3><p>æˆ‘ä»¬æ–°å¢åŠ ä¸€ä¸ª<code>OtherActivity</code>,ç„¶åæ›´æ”¹<code>MainActivity</code>ä¸­çš„ä»£ç å’Œ<code>activity_main.xml</code>ä¸­ä»£ç </p>
<p><code>MainActivity</code>ä¸­ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> <span class="string">&quot;MainActivity&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button mButton;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate() called&quot;</span>);</span><br><span class="line">        mButton = findViewById(R.id.button);</span><br><span class="line">        mButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, OtherActivity.class);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>activity_main.xml</code>ä¸­ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;to other activity&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬è¿è¡Œä»£ç ç‚¹å‡»å…¶ä¸­çš„æŒ‰é’®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210818222756707.png" alt="image-20210818222756707"></p>
<p>è¯¥å®ä¾‹å…¶å®æ˜¯å’Œå®ä¾‹äºŒç›¸åŒï¼Œè·³è½¬å…¶ä»–<code>OtherActivity</code>ä¹‹å,<code>MainActivity</code>å°±åœæ­¢äº†ã€‚</p>
<h3 id="å®ä¾‹å››"><a href="#å®ä¾‹å››" class="headerlink" title="å®ä¾‹å››"></a>å®ä¾‹å››</h3><p>æˆ‘ä»¬ç‚¹å‡»åº”ç”¨ï¼Œå†æ—‹è½¬å±å¹•æˆ‘ä»¬å¯ä»¥æˆªå›¾å¯ä»¥å‘ç°æ—‹è½¬ä¹‹å<code>Activity</code>æ˜¯æ¯ç­ä¹‹åå†æ¬¡é‡å»ºï¼Œç®€å•ç†è§£æ˜¯è®¾å¤‡æ—‹è½¬æ—¶ï¼Œç³»ç»Ÿä¼šé”€æ¯å½“å‰<code>Activity</code>å®ä¾‹ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„<code>Activity</code>å®ä¾‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819101657554.png" alt="image-20210819101657554"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>Activity</code>çš„çŠ¶æ€å˜åŒ–å¯ä»¥ä»¥å†…å­˜ä¸­æœ‰æ²¡æœ‰<code>activity</code>çš„å®ä¾‹ï¼Œç”¨æˆ·æ˜¯å¦çœ‹å¾—åˆ°ï¼Œæ˜¯å¦æ´»è·ƒåœ¨å‰å°ï¼ˆç­‰å¾…æˆ–æ¥å—ç”¨æˆ·è¾“å…¥ä¸­ï¼‰ç­‰è¿™äº›ä½œä¸ºåˆ¤æ–­ï¼ŒæŒæ¡çŠ¶æ€çš„è¿™å‡ ä¸ªç‚¹å°±æ¯”è¾ƒå¥½åŒºåˆ†ï¼Œç›®å‰ä¹Ÿä¸¾å‡ºäº†å‡ ä¸ªä¾‹å­æ–¹ä¾¿æˆ‘ä»¬ç†è§£<code>Activity</code>çŠ¶æ€æ”¹å˜ï¼Œä½†æ˜¯é—æ†¾çš„æ˜¯æ²¡æœ‰é‡åˆ°åªæ˜¯æš‚åœçš„è¿™ç§ç®€å•ä¾‹å­</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li>ã€ŠAndoridç¼–ç¨‹æƒå¨æŒ‡å—ã€‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>Activityä¹‹é—´é€šè®¯</title>
    <url>/2021/08/20/Android%E5%AD%A6%E4%B9%A0/Activity%E4%B9%8B%E9%97%B4%E9%80%9A%E8%AE%AF/</url>
    <content><![CDATA[<h1 id="Activityä¹‹é—´é€šè®¯"><a href="#Activityä¹‹é—´é€šè®¯" class="headerlink" title="Activityä¹‹é—´é€šè®¯"></a>Activityä¹‹é—´é€šè®¯</h1><p><code>Activity</code>ä¹‹é—´ç»å¸¸éœ€è¦ä¼ è¾“æ•°æ®ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨<code>Intent</code></p>
<span id="more"></span>
<h2 id="å®ä¾‹ä¸€å•æ–¹é¢ä¼ è¾“"><a href="#å®ä¾‹ä¸€å•æ–¹é¢ä¼ è¾“" class="headerlink" title="å®ä¾‹ä¸€å•æ–¹é¢ä¼ è¾“"></a>å®ä¾‹ä¸€å•æ–¹é¢ä¼ è¾“</h2><p>åˆ›å»ºé¡¹ç›®<code>TwoActivity</code>ï¼Œç„¶ååœ¨é¡¹ç›®ä¸­é™¤<code>MainActivity</code>ä¹‹å¤–ï¼Œå†æ·»åŠ ä¸€ä¸ª<code>SecondActivity</code></p>
<p>åœ¨<code>activity_main.xml</code>å†™ä¸‹ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/editText&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ems</span>=<span class="string">&quot;10&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">&quot;please input something&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">&quot;0.497&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;send to secondActivity&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@+id/editText&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨<code>MainActivity</code>ä¸­å†™ä¸‹ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.twoactivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> EditText mEditText;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button mButton;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mEditText = findViewById(R.id.editText);</span><br><span class="line">        mButton = findViewById(R.id.button);</span><br><span class="line">        mButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> mEditText.getText().toString();</span><br><span class="line">                <span class="comment">//å¯åŠ¨å¦ä¸€ä¸ªActivity</span></span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, SecondAcrivity.class);</span><br><span class="line">                intent.putExtra(<span class="string">&quot;information&quot;</span>, str);</span><br><span class="line">                startActivity(intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>activity_second.xml</code>å†™å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">EditText</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/editText&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ems</span>=<span class="string">&quot;10&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:hint</span>=<span class="string">&quot;please input something&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">&quot;0.497&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/button&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;send to secondActivity&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@+id/editText&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>åœ¨<code>SecondActivity</code>å†™ä¸‹ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.twoactivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondAcrivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView mTextView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_second);</span><br><span class="line">        mTextView = findViewById(R.id.textView);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">        <span class="type">String</span> <span class="variable">information</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;information&quot;</span>);</span><br><span class="line">        mTextView.setText(information);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç¨‹åºï¼Œå†è¾“å…¥æ¡†è¾“å…¥<code>test</code>ï¼Œç„¶åæŒ‰ä¸‹æŒ‰é’®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210820175350586.png" alt="image-20210820175350586"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨çš„<code>SecondActivity</code>ä¸Šå±•ç¤ºäº†æˆ‘ä»¬è¾“å…¥çš„å†…å®¹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210820175557003.png" alt="image-20210820175557003" style="zoom:50%;" /></p>
<p>å¯ä»¥çœ‹åˆ°éœ€è¦ä¼ è¾“çš„å†…å®¹ä»<code>MainActivity</code>ä¼ è¾“åˆ°äº†<code>SecondActivity</code></p>
<h2 id="å®ä¾‹äºŒåŒæ–¹äº’ç›¸ä¼ è¾“"><a href="#å®ä¾‹äºŒåŒæ–¹äº’ç›¸ä¼ è¾“" class="headerlink" title="å®ä¾‹äºŒåŒæ–¹äº’ç›¸ä¼ è¾“"></a>å®ä¾‹äºŒåŒæ–¹äº’ç›¸ä¼ è¾“</h2><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠä¿¡æ¯ä»<code>MainActivity</code>ä¼ è¾“åˆ°<code>SecondActivity</code>ï¼Œè¿™ç§ç±»ä¼¼äºçˆ¶å­<code>Activity</code>ä¹‹é—´çš„ä¼ è¾“ï¼ŒåŸæœ¬æ˜¯ä½¿ç”¨<code>startActivityForResult</code>è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯ç”±äº<code>startActivityForResult</code>å­˜åœ¨çš„é—®é¢˜ï¼Œç°åœ¨å®˜æ–¹æ¨èçš„æ˜¯ä½¿ç”¨<code>registerForActivityResult()</code>ç­‰<code>Activity Results API</code>ç›¸å…³çš„æ–¹æ³•</p>
<p>ğŸ‘‰å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://developer.android.com/training/basics/intents/result">https://developer.android.com/training/basics/intents/result</a></p>
<p>æ›´æ”¹<code>MainActivity</code>ä¸­ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.twoactivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.activity.result.ActivityResultCallback;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.result.ActivityResultLauncher;</span><br><span class="line"><span class="keyword">import</span> androidx.activity.result.contract.ActivityResultContract;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> EditText mEditText;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Button mButton;</span><br><span class="line">	<span class="comment">//åˆ¶å®šåè®®</span></span><br><span class="line">    <span class="keyword">private</span> ActivityResultContract&lt;String, String&gt; mStringStringActivityResultContract = <span class="keyword">new</span> <span class="title class_">ActivityResultContract</span>&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Intent <span class="title function_">createIntent</span><span class="params">(<span class="meta">@NonNull</span> Context context, String input)</span> &#123;</span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, SecondAcrivity.class);</span><br><span class="line">            intent.putExtra(<span class="string">&quot;information&quot;</span>, input);</span><br><span class="line">            <span class="keyword">return</span> intent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">parseResult</span><span class="params">(<span class="type">int</span> resultCode, <span class="meta">@Nullable</span> Intent intent)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resultCode != Activity.RESULT_OK || intent == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> intent.getStringExtra(<span class="string">&quot;second information&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"><span class="comment">//åˆ¶å®šå¯åŠ¨å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">ActivityResultLauncher</span> <span class="variable">mActivityResultLauncher</span> <span class="operator">=</span> registerForActivityResult(mStringStringActivityResultContract,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ActivityResultCallback</span>&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onActivityResult</span><span class="params">(String result)</span> &#123;</span><br><span class="line">                    Toast.makeText(MainActivity.<span class="built_in">this</span>, result, Toast.LENGTH_LONG).show();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mEditText = findViewById(R.id.editText);</span><br><span class="line">        mButton = findViewById(R.id.button);</span><br><span class="line"></span><br><span class="line">        mButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> mEditText.getText().toString();</span><br><span class="line">                mActivityResultLauncher.launch(str);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ActivityResultContract</code>å’Œ<code>ActivityResultLauncher</code>æ˜¯<code>Activity Results API</code>ä¸­ä¸¤ä¸ªé‡è¦çš„ç»„ä»¶</p>
<ul>
<li><code>ActivityResultContract</code>: åè®®ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•ä¼ é€’æ•°æ®å’Œå¦‚ä½•å¤„ç†è¿”å›çš„æ•°æ®ã€‚<code>ActivityResultContract</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½ éœ€è¦ç»§æ‰¿å®ƒæ¥åˆ›å»ºè‡ªå·±çš„åè®®ï¼Œæ¯ä¸ª <code>ActivityResultContract</code> éƒ½éœ€è¦å®šä¹‰è¾“å…¥å’Œè¾“å‡ºç±»ï¼Œå¦‚æœæ‚¨ä¸éœ€è¦ä»»ä½•è¾“å…¥ï¼Œå¯ä½¿ç”¨ Voidï¼ˆåœ¨ Kotlin ä¸­ï¼Œä½¿ç”¨ Void? æˆ– Unitï¼‰ä½œä¸ºè¾“å…¥ç±»å‹ã€‚</li>
<li><code>ActivityResultLauncher</code>: å¯åŠ¨å™¨ï¼Œè°ƒç”¨<code>ActivityResultLauncher</code>çš„<code>launch</code>æ–¹æ³•æ¥å¯åŠ¨é¡µé¢è·³è½¬ï¼Œä½œç”¨ç›¸å½“äºåŸæ¥çš„<code>startActivity()</code></li>
</ul>
<p><code>SecondAcrivity</code>å†™å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.twoactivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecondAcrivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> TextView mTextView;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_second);</span><br><span class="line">        mTextView = findViewById(R.id.textView);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> getIntent();</span><br><span class="line">        <span class="type">String</span> <span class="variable">information</span> <span class="operator">=</span> intent.getStringExtra(<span class="string">&quot;information&quot;</span>);</span><br><span class="line">        mTextView.setText(information);</span><br><span class="line">        <span class="type">Intent</span> <span class="variable">data</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">        data.putExtra(<span class="string">&quot;second information&quot;</span>, <span class="string">&quot;è¿”å›äº†secondActivityçš„ä¿¡æ¯&quot;</span>);</span><br><span class="line">        <span class="comment">//è®¾ç½®è¿”å›ç»“æœ</span></span><br><span class="line">        setResult(Activity.RESULT_OK, data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°å­<code>activity</code>å‘é€è¿”å›ä¿¡æ¯ç»™çˆ¶<code>activity</code>ï¼Œæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•å¯ç”¨ï¼š</p>
<p> <code>public final void setResult(int resultCode)</code></p>
<p>  <code>public final void setResult(int resultCode, Intent data)</code></p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå‚æ•°<code>resultCode</code>å¯ä»¥æ˜¯ä»¥ä¸‹ä»»æ„ä¸€ä¸ªé¢„å®šä¹‰å¸¸é‡ã€‚</p>
<ul>
<li><code>Activity.RESULT_OK</code></li>
<li><code>Activity.RESULT_CANCELED</code></li>
</ul>
<p>å½“ç„¶å¦‚éœ€è‡ªå·±å®šä¹‰ç»“æœä»£ç ï¼Œè¿˜å¯ä½¿ç”¨å¦ä¸€ä¸ªå¸¸é‡ï¼š<code>RESULT_FIRST_USER</code>ã€‚</p>
<p>åœ¨çˆ¶<code>activity</code>éœ€è¦ä¾æ®å­<code>activity</code>çš„å®Œæˆç»“æœé‡‡å–ä¸åŒæ“ä½œæ—¶ï¼Œè®¾ç½®ç»“æœä»£ç å°±éå¸¸æœ‰ç”¨ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾å­<code>activity</code>æœ‰ä¸€ä¸ª<code>OK</code>æŒ‰é’®å’Œä¸€ä¸ª<code>Cancel</code>æŒ‰é’®ï¼Œå¹¶ä¸”æ¯ä¸ªæŒ‰é’®çš„å•å‡»åŠ¨ä½œåˆ†åˆ«è®¾ç½® æœ‰ä¸åŒçš„ç»“æœä»£ç ã€‚é‚£ä¹ˆï¼Œæ ¹æ®ä¸åŒçš„ç»“æœä»£ç ï¼Œçˆ¶<code>activity</code>å°±èƒ½é‡‡å–ä¸åŒçš„æ“ä½œã€‚  å­<code>activity</code>å¯ä»¥ä¸è°ƒç”¨<code>setResult(...)</code>æ–¹æ³•ã€‚å¦‚æœä¸éœ€è¦åŒºåˆ†é™„åŠ åœ¨intentä¸Šçš„ç»“æœæˆ–å…¶ä»–ä¿¡ æ¯ï¼Œå¯è®©æ“ä½œç³»ç»Ÿå‘é€é»˜è®¤çš„ç»“æœä»£ç ã€‚å¦‚æœå­<code>activity</code>æ˜¯ä»¥è°ƒç”¨<code>startActivityForResult(...)</code>æˆ–è€…<code>ActivityResultLauncher</code>æ–¹æ³•å¯åŠ¨çš„ï¼Œç»“æœä»£ç åˆ™æ€»æ˜¯ä¼šè¿”å›ç»™çˆ¶<code>activity</code>ã€‚åœ¨æ²¡æœ‰è°ƒç”¨<code>setResult(...)</code>æ–¹æ³•çš„æƒ…å†µä¸‹ï¼Œ å¦‚æœç”¨æˆ·æŒ‰äº†åé€€æŒ‰é’®ï¼Œçˆ¶<code>activity</code>åˆ™ä¼šæ”¶åˆ°<code>Activity.RESULT_CANCELED</code>çš„ç»“æœä»£ç ã€‚</p>
<p>æœ€ç»ˆç»“æœå±•ç¤ºï¼Œå‘é€ä¿¡æ¯ä¹‹åæŒ‰è¿”å›é”®ï¼Œä¼šå‡ºç»“æœå±•ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210820215024582.png" alt="image-20210820215024582"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å†™äº†ä¸¤ä¸ªæœ‰å…³<code>Android</code>ä¹‹é—´<code>Activity</code>çš„ä¿¡æ¯ç›¸äº’ä¼ è¾“</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://segmentfault.com/a/1190000037601888">https://segmentfault.com/a/1190000037601888</a></li>
<li><a href="https://developer.android.com/training/basics/intents/result">https://developer.android.com/training/basics/intents/result</a></li>
<li>ã€ŠAndroidç¼–ç¨‹æƒå¨æŒ‡å—ä¸­æ–‡ç¬¬3ç‰ˆã€‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>Androidæƒé™å­¦ä¹ </title>
    <url>/2021/09/18/Android%E5%AD%A6%E4%B9%A0/Android%E6%9D%83%E9%99%90%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="Androidæƒé™å­¦ä¹ "><a href="#Androidæƒé™å­¦ä¹ " class="headerlink" title="Androidæƒé™å­¦ä¹ "></a>Androidæƒé™å­¦ä¹ </h1><p>Androidæƒé™å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼šå®‰è£…æ—¶æƒé™ã€è¿è¡Œæ—¶æƒé™å’Œç‰¹æ®Šæƒé™ï¼Œå®‰è£…æ—¶æƒé™åŒ…æ‹¬æ™®é€šæƒé™å’Œç­¾åæƒé™ã€‚</p>
<p>ä¸€èˆ¬åœ¨åº”ç”¨å•†åŸä¸Šæ¶çš„è½¯ä»¶éƒ½å¯ä»¥çœ‹åˆ°å¯¹åº”çš„éœ€è¦çš„æƒé™ï¼Œä¸‹é¢å°±æ˜¯Androidçš„ç‹è€…è£èª‰å½“ä¸­å±•ç¤ºçš„éœ€è¦çš„æƒé™</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210918202325809.png" alt="image-20210918202325809"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210918202805326.png" alt="image-20210918202805326"></p>
<p><strong>æœ¬æ–‡ä¸»è¦é’ˆå¯¹äº<code>Android6.0</code>ä¹‹åçš„ä»‹ç»ï¼ï¼ï¼</strong></p>
<span id="more"></span>
<h2 id="æƒé™ä»‹ç»"><a href="#æƒé™ä»‹ç»" class="headerlink" title="æƒé™ä»‹ç»"></a>æƒé™ä»‹ç»</h2><h3 id="æ™®é€šæƒé™"><a href="#æ™®é€šæƒé™" class="headerlink" title="æ™®é€šæƒé™"></a>æ™®é€šæƒé™</h3><p>åœ¨å®˜æ–¹æ–‡æ¡£å½“ä¸­ï¼Œæ™®é€šæƒé™æ­¤ç±»æƒé™å…è®¸è®¿é—®è¶…å‡ºåº”ç”¨æ²™ç›’çš„æ•°æ®å’Œæ‰§è¡Œè¶…å‡ºåº”ç”¨æ²™ç›’çš„æ“ä½œã€‚ä½†æ˜¯ï¼Œè¿™äº›æ•°æ®å’Œæ“ä½œå¯¹ç”¨æˆ·éšç§åŠå¯¹å…¶ä»–åº”ç”¨çš„æ“ä½œå¸¦æ¥çš„é£é™©éå¸¸å°ã€‚ç³»ç»Ÿä¼šä¸ºæ™®é€šæƒé™åˆ†é…â€œnormalâ€ä¿æŠ¤çº§åˆ«</p>
<p>è¿™ç±»æƒé™ä¸å¤ªéœ€è¦é‡ç‚¹å…³æ³¨ï¼Œç”³è¯·è¿™ç±»æƒé™åªéœ€è¦åœ¨<code>AndroidManifest</code>ä¸­å£°æ˜å³å¯</p>
<h3 id="ç­¾åæƒé™"><a href="#ç­¾åæƒé™" class="headerlink" title="ç­¾åæƒé™"></a>ç­¾åæƒé™</h3><p>å®˜æ–¹çš„ä»‹ç»æ˜¯å½“åº”ç”¨å£°æ˜äº†å…¶ä»–åº”ç”¨å·²å®šä¹‰çš„ç­¾åæƒé™æ—¶ï¼Œå¦‚æœä¸¤ä¸ªåº”ç”¨ä½¿ç”¨åŒä¸€è¯ä¹¦è¿›è¡Œç­¾åï¼Œç³»ç»Ÿä¼šåœ¨å®‰è£…æ—¶å‘å‰è€…æˆäºˆè¯¥æƒé™ã€‚å¦åˆ™ï¼Œç³»ç»Ÿæ— æ³•å‘å‰è€…æˆäºˆè¯¥æƒé™ã€‚</p>
<p>ç³»ç»Ÿä¼šä¸ºç­¾åæƒé™åˆ†é…â€œsignatureâ€ä¿æŠ¤çº§åˆ«</p>
<p>ç›®å‰æˆ‘å¹¶æ²¡æœ‰æŸ¥æ‰¾åˆ°å’Œç­¾åæƒé™ç›¸å…³çš„è¾ƒå¤šèµ„æ–™æš‚ä¸”è·³è¿‡ã€‚</p>
<h3 id="è¿è¡Œæ—¶æƒé™"><a href="#è¿è¡Œæ—¶æƒé™" class="headerlink" title="è¿è¡Œæ—¶æƒé™"></a>è¿è¡Œæ—¶æƒé™</h3><p>è¿è¡Œæ—¶æƒé™åˆæˆä¸ºå±é™©æƒé™ï¼Œä»–æ˜¯å­¦ä¹ çš„é‡ç‚¹ï¼Œè¯¥æƒé™åœ¨ç³»ç»Ÿè¯·æ±‚çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šæ˜¾ç¤ºè¿è¡Œæ—¶æƒé™æç¤ºã€‚</p>
<p>æ¯”å¦‚æˆ‘åœ¨å¸‚é¢ä¸Šæ‰¾åˆ°çš„ä¸€æ¬¾å°è¯´è½¯ä»¶ï¼Œä»–å°±ç”³è¯·çš„ç”µè¯æƒé™ã€‚</p>
<p>åé¢æˆ‘ä»¬ä¹Ÿä¼šå®ç°è¿™æ ·çš„åŠŸèƒ½</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210918205745566.png" alt="image-20210918205745566"></p>
<p>ç³»ç»Ÿä¼šä¸ºè¿è¡Œæ—¶æƒé™åˆ†é…â€œdangerousâ€ä¿æŠ¤çº§åˆ«</p>
<h3 id="ç‰¹æ®Šæƒé™"><a href="#ç‰¹æ®Šæƒé™" class="headerlink" title="ç‰¹æ®Šæƒé™"></a>ç‰¹æ®Šæƒé™</h3><p>ç‰¹æ®Šæƒé™ä¸ç‰¹å®šçš„åº”ç”¨æ“ä½œç›¸å¯¹åº”ã€‚åªæœ‰å¹³å°å’ŒåŸå§‹è®¾å¤‡åˆ¶é€ å•† (OEM) å¯ä»¥å®šä¹‰ç‰¹æ®Šæƒé™ã€‚æ­¤å¤–ï¼Œå¦‚æœå¹³å°å’Œ OEM æƒ³è¦é˜²æ­¢æœ‰äººæ‰§è¡ŒåŠŸèƒ½ç‰¹åˆ«å¼ºå¤§çš„æ“ä½œï¼ˆä¾‹å¦‚é€šè¿‡å…¶ä»–åº”ç”¨ç»˜å›¾ï¼‰ï¼Œé€šå¸¸ä¼šå®šä¹‰ç‰¹æ®Šæƒé™ã€‚</p>
<p>ç³»ç»Ÿè®¾ç½®ä¸­çš„<strong>ç‰¹æ®Šåº”ç”¨è®¿é—®æƒé™</strong>é¡µé¢åŒ…å«ä¸€ç»„ç”¨æˆ·å¯åˆ‡æ¢çš„æ“ä½œã€‚å…¶ä¸­çš„è®¸å¤šæ“ä½œéƒ½ä»¥ç‰¹æ®Šæƒé™çš„å½¢å¼å®ç°ã€‚</p>
<p>æ¯é¡¹ç‰¹æ®Šæƒé™éƒ½æœ‰è‡ªå·±çš„å®ç°ç»†èŠ‚ã€‚</p>
<p>ç³»ç»Ÿä¼šä¸ºç‰¹æ®Šæƒé™åˆ†é…â€œappopâ€ä¿æŠ¤çº§åˆ«ã€‚</p>
<p>ç‰¹æ®Šæƒé™ä¸åœ¨æœ¬æ¬¡å­¦ä¹ çš„é‡ç‚¹ä¹‹å†…ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥</p>
<h2 id="å£°æ˜åº”ç”¨æƒé™"><a href="#å£°æ˜åº”ç”¨æƒé™" class="headerlink" title="å£°æ˜åº”ç”¨æƒé™"></a>å£°æ˜åº”ç”¨æƒé™</h2><p>å£°æ˜æƒé™æ¯”è¾ƒç®€å•åªéœ€è¦åœ¨<code>AndroidManifest</code>ä¸­åŠ å…¥å¯¹åº”çš„æƒé™å°±è¡Œ</p>
<p>å¦‚ç”³æ˜ç½‘ç»œæƒé™ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç”³æ˜äº†æƒé™ä¹‹åå¦‚æœè¯¥æƒé™æ˜¯å®‰è£…æ—¶æƒé™ï¼Œç³»ç»Ÿä¼šåœ¨å®‰è£…æ‚¨çš„åº”ç”¨æ—¶è‡ªåŠ¨ä¸ºå…¶æˆäºˆç›¸åº”æƒé™ã€‚</p>
<p><strong>å¦‚æœè¯¥æƒé™æ—¶è¿è¡Œæ—¶æƒé™ï¼Œé‚£ä¹ˆå…‰å£°æ˜æƒé™è¿˜æ˜¯ä¸å¤Ÿçš„ï¼Œè¿˜éœ€è¦ç»§ç»­è¯·æ±‚æƒé™ã€‚</strong></p>
<p>å½“ç„¶å¦‚æœæ˜¯è¿è¡Œæ—¶æƒé™ï¼Œç›´æ¥ä¸å†™å£°æ˜ï¼Œé‚£ä¹ˆè¯·æ±‚æƒé™æ˜¯å‘ä¸å‡ºå»çš„ï¼Œä¸€å‘å‡ºå»å°±ä¼šè¢«æ‹’ç»ã€‚</p>
<h2 id="è¯·æ±‚æƒé™"><a href="#è¯·æ±‚æƒé™" class="headerlink" title="è¯·æ±‚æƒé™"></a>è¯·æ±‚æƒé™</h2><h3 id="æ£€æµ‹æƒé™"><a href="#æ£€æµ‹æƒé™" class="headerlink" title="æ£€æµ‹æƒé™"></a>æ£€æµ‹æƒé™</h3><p>è¯·æ±‚çš„æƒé™ä¸€èˆ¬æ˜¯å±é™©æƒé™ä¹Ÿå°±æ˜¯è¿è¡Œæ—¶æƒé™ï¼Œåœ¨è¯·æ±‚æƒé™ä¹‹å‰æˆ‘ä»¬å¯ä»¥æ£€æµ‹ä¸€ä¸‹æƒé™ï¼ŒæŸ¥çœ‹æƒé™æ˜¯å¦æˆäºˆ</p>
<p>æ£€æŸ¥æƒé™ä½¿ç”¨çš„å‡½æ•°æ˜¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">checkSelfPermission</span> <span class="params">(Context context, String permission)</span></span><br></pre></td></tr></table></figure>
<p>æ­¤æ–¹æ³•ä¼šè¿”å› <a href="https://developer.android.com/reference/android/content/pm/PackageManager#PERMISSION_GRANTED"><code>PERMISSION_GRANTED</code></a> æˆ– <a href="https://developer.android.com/reference/android/content/pm/PackageManager#PERMISSION_DENIED"><code>PERMISSION_DENIED</code></a>ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥çŸ¥é“æ˜¯å¦è·å¾—äº†è¯¥æƒé™</p>
<p>å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">int</span> <span class="variable">permissionCheck</span> <span class="operator">=</span> ContextCompat.checkSelfPermission(<span class="built_in">this</span>, Manifest.permission.CAMERA);</span><br><span class="line">    <span class="keyword">if</span> (permissionCheck == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Manifest.permission.CAMERA is  granted&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;Manifest.permission.CAMERA is not granted&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¯·æ±‚å¯¹åº”æƒé™"><a href="#è¯·æ±‚å¯¹åº”æƒé™" class="headerlink" title="è¯·æ±‚å¯¹åº”æƒé™"></a>è¯·æ±‚å¯¹åº”æƒé™</h3><p>è¯·æ±‚å¯¹åº”çš„æƒé™çš„ä»£ç ç›®å‰çœ‹æ¥æœ‰ä¸¤ç§æ–¹å¼ï¼Œç¬¬ä¸€ç§æ–¹å¼æ˜¯ä½¿ç”¨<code>ActivityResultLauncher</code>ï¼Œç¬¬äºŒç§æ˜¯ä½¿ç”¨å‡½æ•°<code>requestPermissions</code></p>
<h4 id="ä½¿ç”¨ActivityResultLauncher"><a href="#ä½¿ç”¨ActivityResultLauncher" class="headerlink" title="ä½¿ç”¨ActivityResultLauncher"></a>ä½¿ç”¨<code>ActivityResultLauncher</code></h4><p>ä½¿ç”¨<code>ActivityResultLauncher</code>éœ€è¦å…ˆæŒ‡å®š<code>ActivityResultContract</code>ç±»å‹çš„åè®®ä¸è¿‡åœ¨Androidå½“ä¸­å·²ç»æœ‰å®ç°å¥½çš„ç±»ï¼Œé‚£å°±æ˜¯<code>RequestPermission</code>ç±»</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210923204407573.png" alt="image-20210923204407573"></p>
<p>å¯ä»¥çœ‹åˆ°<code>RequestPermission</code>ç±»æ˜¯<code>ActivityResultContract&lt;String,Boolean&gt;</code>ç±»å‹çš„ï¼Œå…¶ä¸­<code>String</code>ä»£è¡¨æƒé™çš„åå­—ï¼Œè€Œ<code>Boolean</code>ä»£è¡¨æœ€åè¿”å›æ˜¯å¦æˆäºˆæƒé™çš„ç»“æœï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œç±»ä¼¼æœ‰Activityçš„è·³è½¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ³¨å†Œæƒé™å›è°ƒï¼Œå®ƒå¤„ç†ç”¨æˆ·å¯¹ç³»ç»Ÿæƒé™å¯¹è¯æ¡†çš„å“åº”ã€‚</span></span><br><span class="line"><span class="comment">//å°†è¿”å›å€¼(ActivityResultLauncherçš„ä¸€ä¸ªå®ä¾‹)ä¿å­˜ä¸ºå®ä¾‹å˜é‡ã€‚</span></span><br><span class="line"><span class="keyword">private</span> ActivityResultLauncher&lt;String&gt; requestPermissionLauncher =</span><br><span class="line">        registerForActivityResult(<span class="keyword">new</span> <span class="title class_">ActivityResultContracts</span>.RequestPermission(), isGranted -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (isGranted) &#123;</span><br><span class="line">                <span class="comment">// æƒé™è¢«æˆäºˆçš„æƒ…å†µ</span></span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç¬¬ä¸€ç§æ–¹å¼ï¼šæƒé™è¢«æˆäºˆ&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//å‘ç”¨æˆ·è§£é‡Šè¯¥åŠŸèƒ½ä¸å¯ç”¨ï¼Œå› ä¸ºè¯¥åŠŸèƒ½éœ€è¦ç”¨æˆ·æ‹’ç»çš„æƒé™ã€‚</span></span><br><span class="line">                <span class="comment">// åŒæ—¶ï¼Œå°Šé‡ç”¨æˆ·çš„å†³å®šã€‚ä¸è¦é“¾æ¥åˆ°ç³»ç»Ÿè®¾ç½®ï¼Œè¯•å›¾è¯´æœç”¨æˆ·æ”¹å˜ä»–ä»¬çš„å†³å®šã€‚</span></span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç¬¬ä¸€ç§æ–¹å¼ï¼šæƒé™æœªæˆäºˆ&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬è¯·æ±‚æ‘„åƒå¤´æƒé™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¬¬ä¸€ç§æ–¹å¼ä½¿ç”¨ ActivityResultLauncher</span></span><br><span class="line">requestPermissionLauncher.launch(Manifest.permission.CAMERA);</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210923205400390.png" alt="image-20210923205400390"></p>
<h4 id="ä½¿ç”¨requestPermissions"><a href="#ä½¿ç”¨requestPermissions" class="headerlink" title="ä½¿ç”¨requestPermissions"></a>ä½¿ç”¨<code>requestPermissions</code></h4><p><code>requestPermissions</code>ä¹Ÿå¯è¯·æ±‚æƒé™ï¼Œå¹¶ä¸”å¯ä»¥è¯·æ±‚å¤šä¸ªæƒé™</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">requestPermissions</span><span class="params">(<span class="meta">@NonNull</span> String[] permissions, <span class="type">int</span> requestCode)</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>requestPermissions</code>è¯·æ±‚æƒé™ä¹‹åï¼Œéœ€è¦ä½¿ç”¨<code>onRequestPermissionsResult</code>å‡½æ•°ä½œä¸ºå›è°ƒå‡½æ•°</p>
<p>egï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ç¬¬äºŒç§æ–¹å¼</span></span><br><span class="line"><span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">requestPermissions(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.CAMERA&#125;, PERMISSION_REQUEST_CODE);</span><br></pre></td></tr></table></figure>
<p>å›è°ƒåæ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onRequestPermissionsResult</span><span class="params">(<span class="type">int</span> requestCode, String[] permissions, <span class="type">int</span>[] grantResults)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</span><br><span class="line">    <span class="keyword">switch</span> (requestCode) &#123;</span><br><span class="line">        <span class="keyword">case</span> PERMISSION_REQUEST_CODE:</span><br><span class="line">            <span class="comment">// If request is cancelled, the result arrays are empty.</span></span><br><span class="line">            <span class="keyword">if</span> (grantResults.length &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                    grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">                <span class="comment">// Permission is granted. Continue the action or workflow</span></span><br><span class="line">                <span class="comment">// in your app.</span></span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç¬¬äºŒç§æ–¹å¼ï¼šæƒé™è¢«æˆäºˆ&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Explain to the user that the feature is unavailable because</span></span><br><span class="line">                <span class="comment">// the features requires a permission that the user has denied.</span></span><br><span class="line">                <span class="comment">// At the same time, respect the user&#x27;s decision. Don&#x27;t link to</span></span><br><span class="line">                <span class="comment">// system settings in an effort to convince the user to change</span></span><br><span class="line">                <span class="comment">// their decision.</span></span><br><span class="line">                Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;ç¬¬äºŒç§æ–¹å¼ï¼šæƒé™æœªè¢«æˆäºˆ&quot;</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Other &#x27;case&#x27; lines to check for other</span></span><br><span class="line">    <span class="comment">// permissions this app might request.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ä¹Ÿæ¯”è¾ƒæ–¹ä¾¿</p>
<h4 id="shouldShowRequestPermissionRationaleå‡½æ•°ç†è§£"><a href="#shouldShowRequestPermissionRationaleå‡½æ•°ç†è§£" class="headerlink" title="shouldShowRequestPermissionRationaleå‡½æ•°ç†è§£"></a><code>shouldShowRequestPermissionRationale</code>å‡½æ•°ç†è§£</h4><p><code>shouldShowRequestPermissionRationale</code>å‘ç”¨æˆ·æ˜¾ç¤ºæŒ‡å¯¼ç•Œé¢ï¼Œåœ¨æ­¤ç•Œé¢ä¸­è¯´æ˜ç”¨æˆ·å¸Œæœ›å¯ç”¨çš„åŠŸèƒ½ä¸ºä½•éœ€è¦ç‰¹å®šæƒé™ã€‚</p>
<p><code>shouldShowRequestPermissionRationale</code>å‡½æ•°ä¼šè¿”å›trueæˆ–è€…falseã€‚æŒ‰ç…§è¯·æ±‚æƒé™çš„æµç¨‹å¯ä»¥è¿™æ ·åŒºåˆ†</p>
<p>â‘ åˆšåˆšå®‰è£…ç¨‹åºæ‰“å¼€ç¨‹åºï¼Œ<code>shouldShowRequestPermissionRationale</code>è¿”å›falseï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¼¹å‡ºæƒé™è¯·æ±‚æ¡†ï¼Œå¦‚æœæˆ‘ä»¬å…è®¸é‚£ä¹ˆ<code>shouldShowRequestPermissionRationale</code>ä¼šä¸€ç›´è¿”å›false</p>
<p>â‘¡å¦‚æœâ‘ é‡Œé¢æ‹’ç»äº†æƒé™ï¼Œå†æ¬¡è¿›è¡Œç¨‹åº<code>shouldShowRequestPermissionRationale</code>ä¼šè¿”å›trueï¼Œè¿™æ—¶å€™æˆ‘ä»¬åº”è¯¥å±•ç¤ºä¸ºå•¥éœ€è¦æƒé™</p>
<p>â‘¢å¦‚æœæˆ‘ä»¬ä¸€ç›´è¯·æ±‚æƒé™ï¼Œç„¶åç”¨æˆ·ä¸è€çƒ¦äº†ï¼Œç‚¹å‡»äº†ä¸å†è¯¢é—®ï¼Œé‚£ä¹ˆ<code>shouldShowRequestPermissionRationale</code>ä¼šä¸€ç›´è¿”å›false</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬åœ¨ç¬¬äºŒä¸ªåˆ†æ”¯ä½¿ç”¨<code>shouldShowRequestPermissionRationale</code>ï¼Œå®ƒä¼šå¼¹å‡ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè¯´æ˜æƒé™çš„é‡è¦æ€§</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        mTextView = findViewById(R.id.textView);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ContextCompat.checkSelfPermission(<span class="built_in">this</span>, Manifest.permission.CAMERA) ==</span><br><span class="line">                PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">            <span class="comment">// You can use the API that requires the permission.</span></span><br><span class="line">            Log.d(TAG, <span class="string">&quot;Manifest.permission.CAMERA is  granted&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldShowRequestPermissionRationale(Manifest.permission.CAMERA)) &#123;</span><br><span class="line">            <span class="comment">//è¯´æ˜æƒé™é‡è¦æ€§</span></span><br><span class="line">            showNormalDialog();</span><br><span class="line">            <span class="comment">//ç¬¬ä¸€ç§æ–¹å¼ä½¿ç”¨ ActivityResultLauncher</span></span><br><span class="line">            requestPermissionLauncher.launch(Manifest.permission.CAMERA);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">            <span class="comment">// The registered ActivityResultCallback gets the result of this request.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//ç¬¬ä¸€ç§æ–¹å¼ä½¿ç”¨ ActivityResultLauncher</span></span><br><span class="line"><span class="comment">//            requestPermissionLauncher.launch(Manifest.permission.CAMERA);</span></span><br><span class="line">            <span class="comment">//ç¬¬äºŒç§æ–¹å¼</span></span><br><span class="line">            <span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">            requestPermissions(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;Manifest.permission.CAMERA&#125;, PERMISSION_REQUEST_CODE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">showNormalDialog</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">/* @setIcon è®¾ç½®å¯¹è¯æ¡†å›¾æ ‡</span></span><br><span class="line"><span class="comment">         * @setTitle è®¾ç½®å¯¹è¯æ¡†æ ‡é¢˜</span></span><br><span class="line"><span class="comment">         * @setMessage è®¾ç½®å¯¹è¯æ¡†æ¶ˆæ¯æç¤º</span></span><br><span class="line"><span class="comment">         * setXXXæ–¹æ³•è¿”å›Dialogå¯¹è±¡ï¼Œå› æ­¤å¯ä»¥é“¾å¼è®¾ç½®å±æ€§</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">final</span> AlertDialog.<span class="type">Builder</span> <span class="variable">normalDialog</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">        normalDialog.setTitle(<span class="string">&quot;æˆ‘æ˜¯ä¸€ä¸ªæ™®é€šDialog&quot;</span>);</span><br><span class="line">        normalDialog.setMessage(<span class="string">&quot;æˆ‘éœ€è¦æ‘„åƒå¤´æƒé™ï¼Œå¿«ç»™æˆ‘ï¼ï¼ï¼&quot;</span>);</span><br><span class="line">        normalDialog.setPositiveButton(<span class="string">&quot;ç¡®å®š&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">DialogInterface</span>.OnClickListener() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(DialogInterface dialog, <span class="type">int</span> which)</span> &#123;</span><br><span class="line">                        <span class="comment">//...To-do</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="comment">// æ˜¾ç¤º</span></span><br><span class="line">        normalDialog.show();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¸€å¼€å§‹å®‰è£…ç¨‹åºè¿›å…¥ç¨‹åºï¼Œ<code>shouldShowRequestPermissionRationale</code>è¿”å›falseï¼Œæ‰€ä»¥è¿›å…¥ç¬¬ä¸‰ä¸ªåˆ†æ”¯ï¼Œå¹¶ä¸”è¯·æ±‚æˆäºˆæƒé™</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927111601508.png" alt="image-20210927111601508"></p>
<p>æˆ‘ä»¬ç‚¹å‡»æ‹’ç»åï¼Œå…³é—­ç¨‹åº(åå°æ€æ­»)ï¼Œå†æ¬¡è¿›å…¥ç¨‹åº</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927111714036.png" alt="image-20210927111714036"></p>
<p>ç‚¹å‡»æ‹’ç»åå¯ä»¥çœ‹åˆ°ä¸‹å›¾çš„å†…å®¹ï¼Œè¯´æ˜è¿™ä¸ªæ—¶å€™è¿›å…¥ç¬¬äºŒä¸ªåˆ†æ”¯ï¼Œ<code>shouldShowRequestPermissionRationale</code>è¿”å›true</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927111813939.png" alt="image-20210927111813939"></p>
<p>å…³é—­ç¨‹åº(åå°æ€æ­»)ï¼Œå†æ¬¡è¿›å…¥ç¨‹åºï¼Œè¿™æ¬¡æˆ‘ä»¬ç‚¹å‡»æ‹’ç»å¹¶ä¸”ä¸åœ¨è¯¢é—®ï¼Œç„¶åå†å…³é—­ç¨‹åº(åå°æ€æ­»)ï¼Œå†è¿›å…¥</p>
<p>è¿™æ¬¡ç›´æ¥è·³è½¬ç¬¬ä¸‰ä¸ªåˆ†æ”¯ï¼Œå¹¶ä¸”ç›´æ¥æ‹’ç»æƒé™æˆäºˆï¼Œè¯´æ˜<code>shouldShowRequestPermissionRationale</code>è¿”å›false</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927112331524.png" alt="image-20210927112331524"></p>
<h3 id="è¯·æ±‚æƒé™å»ºè®®æµç¨‹ï¼š"><a href="#è¯·æ±‚æƒé™å»ºè®®æµç¨‹ï¼š" class="headerlink" title="è¯·æ±‚æƒé™å»ºè®®æµç¨‹ï¼š"></a>è¯·æ±‚æƒé™å»ºè®®æµç¨‹ï¼š</h3><p>å®˜æ–¹å»ºè®®æµç¨‹å°±æ˜¯ä¸Šé¢é‚£ç§ç±»ä¼¼äºä¸‰ä¸ªåˆ†æ”¯çš„æµç¨‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ContextCompat.checkSelfPermission(</span><br><span class="line">        CONTEXT, Manifest.permission.REQUESTED_PERMISSION) ==</span><br><span class="line">        PackageManager.PERMISSION_GRANTED) &#123;</span><br><span class="line">    <span class="comment">// You can use the API that requires the permission.</span></span><br><span class="line">    performAction(...);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (shouldShowRequestPermissionRationale(...)) &#123;</span><br><span class="line">    <span class="comment">// In an educational UI, explain to the user why your app requires this</span></span><br><span class="line">    <span class="comment">// permission for a specific feature to behave as expected. In this UI,</span></span><br><span class="line">    <span class="comment">// include a &quot;cancel&quot; or &quot;no thanks&quot; button that allows the user to</span></span><br><span class="line">    <span class="comment">// continue using your app without granting the permission.</span></span><br><span class="line">    showInContextUI(...);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// You can directly ask for the permission.</span></span><br><span class="line">    <span class="comment">// The registered ActivityResultCallback gets the result of this request.</span></span><br><span class="line">    requestPermissionLauncher.launch(</span><br><span class="line">            Manifest.permission.REQUESTED_PERMISSION);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‰ä¸ªåˆ†æ”¯ï¼Œä¸€ä¸ªæ˜¯è·å¾—äº†æƒé™ï¼Œä¸€ä¸ªæ˜¯æ²¡æœ‰å®Œå…¨æ‹’ç»ï¼Œå¯ä»¥è¯´æ˜æƒé™çš„é‡è¦æ€§ï¼Œä¸€ä¸ªæ˜¯è¯·æ±‚æƒé™ã€‚æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥çœ‹çœ‹ä¸Šé¢çš„ä¾‹å­</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯·æ±‚æƒé™æ€»ç®—æ˜¯å¼„æ‡‚äº†ä¸å°‘ï¼Œä½†æ˜¯å…·ä½“é‚£ä¸ªæƒé™éœ€è¦æŸ¥é‚£ä¸ªç›®å‰è¿˜ä¸æ¸…æ¥šï¼Œç­‰åç»­æ€»ç»“åå†æ¥è®²è®²ã€‚</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>Androidçš„è®¾å¤‡é…ç½®å’Œå¤‡é€‰èµ„æº</title>
    <url>/2021/08/19/Android%E5%AD%A6%E4%B9%A0/Android%E7%9A%84%E8%AE%BE%E5%A4%87%E9%85%8D%E7%BD%AE%E5%92%8C%E5%A4%87%E9%80%89%E8%B5%84%E6%BA%90/</url>
    <content><![CDATA[<h1 id="Androidçš„è®¾å¤‡é…ç½®å’Œé…ç½®ä¿®é¥°ç¬¦"><a href="#Androidçš„è®¾å¤‡é…ç½®å’Œé…ç½®ä¿®é¥°ç¬¦" class="headerlink" title="Androidçš„è®¾å¤‡é…ç½®å’Œé…ç½®ä¿®é¥°ç¬¦"></a>Androidçš„è®¾å¤‡é…ç½®å’Œé…ç½®ä¿®é¥°ç¬¦</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>è®¾å¤‡é…ç½®</strong>æ˜¯ä¸€ç³»åˆ—ç‰¹å¾ç»„åˆï¼Œç”¨æ¥æè¿°è®¾å¤‡å½“å‰çŠ¶æ€ã€‚è¿™äº›ç‰¹å¾æœ‰ï¼šå±å¹•æ–¹å‘ã€å±å¹•åƒç´ å¯†åº¦ã€å±å¹•å°ºå¯¸ã€é”®ç›˜ç±»å‹ã€åº•åº§æ¨¡å¼ä»¥åŠè¯­è¨€ç­‰ã€‚ é€šå¸¸ï¼Œä¸ºåŒ¹é…ä¸åŒçš„è®¾å¤‡é…ç½®ï¼Œåº”ç”¨ä¼šæä¾›ä¸åŒçš„å¤‡é€‰èµ„æºã€‚æ¯”å¦‚ï¼šä¸ºé€‚åº”ä¸åŒåˆ†è¾¨ç‡çš„å±å¹•ï¼Œå‘é¡¹ç›®æ·»åŠ å¤šå¥—æ ‡å°±æ˜¯è¿™æ ·ä¸€ä¸ªä½¿ç”¨æ¡ˆä¾‹ã€‚ å¯ä»¥è¯´è¿™äº›å„ç§å„æ ·çš„é…ç½®åªæ˜¯ä¸ºäº†å…¼å®¹å„ç§å„ç§ä¹±ä¸ƒå…«ç³Ÿçš„è®¾å¤‡</p>
<span id="more"></span>
<h2 id="æ—‹è½¬å±å¹•"><a href="#æ—‹è½¬å±å¹•" class="headerlink" title="æ—‹è½¬å±å¹•"></a>æ—‹è½¬å±å¹•</h2><p>è®¾å¤‡çš„å±å¹•åƒç´ å¯†åº¦æ˜¯ä¸ªå›ºå®šçš„è®¾å¤‡é…ç½®ï¼Œæ— æ³•åœ¨è¿è¡Œæ—¶å‘ç”Ÿæ”¹å˜ã€‚ç„¶è€Œï¼Œå±å¹•æ–¹å‘ç­‰ç‰¹å¾å¯ä»¥åœ¨åº”ç”¨è¿è¡Œæ—¶æ”¹å˜ã€‚ åœ¨è¿è¡Œæ—¶é…ç½®å˜æ›´ï¼ˆruntime configuration changeï¼‰å‘ç”Ÿæ—¶ï¼Œå¯èƒ½ä¼šæœ‰æ›´åˆé€‚çš„èµ„æºæ¥åŒ¹é…æ–° çš„è®¾å¤‡é…ç½®ã€‚äºæ˜¯ï¼ŒAndroidå›é”€æ¯å½“å‰activityï¼Œä¸ºæ–°é…ç½®å¯»æ‰¾æœ€ä½³èµ„æºï¼Œç„¶ååˆ›å»ºæ–°å®ä¾‹ä½¿ç”¨è¿™äº›èµ„æºã€‚</p>
<p>åˆ›å»ºä¸€ä¸ª<code>Activitycompatible</code>çš„é¡¹ç›®ï¼Œ<code>MainActivity</code>ä¿æŒé»˜è®¤</p>
<p>åœ¨<code>activity_main.xml</code>ä¸­å†™å…¥ä¸‹åˆ—ä»£ç </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;è¿™æ˜¯ç«–å±å±•ç¤º!&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>æ¥ç€æˆ‘ä»¬åˆ›å»ºå»ºæ°´å¹³æ¨¡å¼å¸ƒå±€ï¼Œåœ¨é¡¹ç›®å·¥å…·çª—å£ä¸­ï¼Œå³é”®å•å‡»resç›®å½•åé€‰æ‹©New â†’ Android resource directoryèœå•é¡¹ã€‚åˆ›å»ºèµ„æºç›®å½•ç•Œé¢åˆ—å‡ºäº†èµ„æºç±»å‹åŠå…¶å¯¹åº”çš„èµ„æºç‰¹å¾ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819173327553.png" alt="image-20210819173327553"></p>
<p>ä»èµ„æºç±»å‹ï¼ˆResource typeï¼‰ åˆ—è¡¨ä¸­é€‰æ‹©layoutï¼Œä¿æŒSource setçš„mainé€‰é¡¹ä¸å˜ã€‚</p>
<p>æ¥ä¸‹æ¥é€‰ä¸­å¾…é€‰èµ„æºç‰¹å¾åˆ—è¡¨ä¸­çš„Orientationï¼Œç„¶åå•å‡»<code>&gt;&gt;</code>æŒ‰é’®å°†å…¶ç§»åŠ¨è‡³å·²é€‰èµ„æºç‰¹å¾ ï¼ˆChosen qualifiersï¼‰åŒºåŸŸã€‚ æœ€åï¼Œç¡®è®¤é€‰ä¸­Screen orientationä¸‹æ‹‰åˆ—è¡¨ä¸­çš„Landscapeé€‰é¡¹ï¼Œå¹¶ç¡®ä¿ç›®å½•åï¼ˆDirectory  nameï¼‰æ˜¾ç¤ºä¸ºlayout-landï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p>è¿™ä¸ªçª—å£çœ‹èµ·æ¥æœ‰æ¨¡æœ‰æ ·ï¼Œä½†å®é™…ç”¨é€”ä»…é™äºè®¾ç½®ç›®å½•åã€‚ç‚¹å‡»OKæŒ‰é’®è®©Android Studioåˆ›å»ºres/layout-landã€‚ è¿™é‡Œçš„-landåç¼€åæ˜¯é…ç½®ä¿®é¥°ç¬¦çš„ä¸€ä¸ªä½¿ç”¨ä¾‹å­ã€‚Androidä¾é reså­ç›®å½•çš„é…ç½®ä¿®é¥°ç¬¦å®šä½æœ€ä½³èµ„æºä»¥åŒ¹é…å½“å‰è®¾å¤‡é…ç½®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819180013963.png" alt="image-20210819180013963"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819180056828.png" alt="image-20210819180056828"></p>
<p>æˆ‘ä»¬å°†<code>layout-land</code>ä¸­çš„<code>activity_main.xml</code>å†™å…¥ä»¥ä¸‹å†…å®¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;è¿™æ˜¯æ¨ªå±å±•ç¤º!&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç¨‹åºï¼Œç«–å±æ—¶ç»“æœå¦‚ä¸‹ï¼ˆè¿™ä¸ªæˆªå›¾æ˜¯ä½¿ç”¨Android studioæˆªå›¾çš„ï¼Œæœ‰ç‚¹é•¿ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819212529509.png" alt="image-20210819212529509" style="zoom:50%;" /></p>
<p>æˆ‘ä»¬å†è¿›è¡Œæ¨ªå±ï¼Œç»“æœå¦‚ä¸‹(åæ§½ä¸€ä¸‹ï¼Œè¿™ä¸ªé»‘å±éƒ¨åˆ†æ—¶åˆ˜æµ·å±)</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210819212627488.png" alt="image-20210819212627488"></p>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªç•Œé¢ä½¿ç”¨çš„<code>layput</code>æ–‡ä»¶æ˜¯ä¸ç›¸åŒçš„ï¼Œé€šè¿‡ä¸åŒç›®å½•åæˆ–è€…å«ä¿®é¥°ç¬¦ç”±ç³»ç»Ÿè¿›è¡Œé€‰æ‹©</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>Androidç¼–ç¨‹æƒå¨æŒ‡å—ç¬¬1ç« æŒ‘æˆ˜ç»ƒä¹ </title>
    <url>/2021/08/19/Android%E5%AD%A6%E4%B9%A0/Android%E7%BC%96%E7%A8%8B%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E7%AC%AC1%E7%AB%A0%E6%8C%91%E6%88%98%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="Androidç¼–ç¨‹æƒå¨æŒ‡å—ç¬¬1ç« æŒ‘æˆ˜ç»ƒä¹ "><a href="#Androidç¼–ç¨‹æƒå¨æŒ‡å—ç¬¬1ç« æŒ‘æˆ˜ç»ƒä¹ " class="headerlink" title="Androidç¼–ç¨‹æƒå¨æŒ‡å—ç¬¬1ç« æŒ‘æˆ˜ç»ƒä¹ "></a>Androidç¼–ç¨‹æƒå¨æŒ‡å—ç¬¬1ç« æŒ‘æˆ˜ç»ƒä¹ </h1><h2 id="å®šåˆ¶-toast-æ¶ˆæ¯"><a href="#å®šåˆ¶-toast-æ¶ˆæ¯" class="headerlink" title="å®šåˆ¶ toast æ¶ˆæ¯"></a>å®šåˆ¶ toast æ¶ˆæ¯</h2><p>è¿™ä¸ªç»ƒä¹ éœ€è¦ä½ å®šåˆ¶toastæ¶ˆæ¯ï¼Œæ”¹åœ¨å±å¹•é¡¶éƒ¨è€Œä¸æ˜¯åº•éƒ¨æ˜¾ç¤ºå¼¹å‡ºæ¶ˆæ¯ã€‚è¿™éœ€è¦ä½¿ç”¨Toast ç±»çš„setGravityæ–¹æ³•ï¼Œå¹¶ä½¿ç”¨Gravity.TOPé‡åŠ›å€¼ã€‚å…·ä½“å¦‚ä½•ä½¿ç”¨ï¼Œè¯·å‚è€ƒAndroidå¼€å‘è€…æ–‡æ¡£ã€‚ </p>
<h2 id="ç­”æ¡ˆ"><a href="#ç­”æ¡ˆ" class="headerlink" title="ç­”æ¡ˆ"></a>ç­”æ¡ˆ</h2><p>å‚è€ƒå®˜æ–¹ç»™å®šçš„<code>Toast</code>ä¾‹å­ç»“åˆå¯¹<code>setGravity</code>å‡½æ•°çš„è®²è§£</p>
<p>æˆ‘ä»¬åªéœ€è¦åœ¨<code>QuizActivity</code>ä¸­çš„å‡½æ•°ä¸­å¡«å…¥ä¸‹å±ä»£ç å³å¯</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">        mTrueButton = (Button) findViewById(R.id.true_button);</span><br><span class="line">        mTrueButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">                <span class="type">Toast</span> <span class="variable">toast</span> <span class="operator">=</span> Toast.makeText(QuizActivity.<span class="built_in">this</span>, R.string.correct_toast, Toast.LENGTH_SHORT);</span><br><span class="line"><span class="comment">//                ç¬¬ä¸€ç« æŒ‘æˆ˜ç»ƒä¹ :è®¾ç½®toaståœ¨ä¸Šæ–¹æ˜¾ç¤º</span></span><br><span class="line">                toast.setGravity(Gravity.TOP, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">                toast.show();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://developer.android.com/reference/android/widget/Toast?hl=en#setGravity(int,%20int,%20int">https://developer.android.com/reference/android/widget/Toast?hl=en#setGravity(int,%20int,%20int</a>)</li>
<li><a href="https://developer.android.com/guide/topics/ui/notifiers/toasts">https://developer.android.com/guide/topics/ui/notifiers/toasts</a></li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>ConstraintLayoutå­¦ä¹ </title>
    <url>/2021/08/21/Android%E5%AD%A6%E4%B9%A0/ConstraintLayout%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="ConstraintLayoutå­¦ä¹ "><a href="#ConstraintLayoutå­¦ä¹ " class="headerlink" title="ConstraintLayoutå­¦ä¹ "></a>ConstraintLayoutå­¦ä¹ </h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>ConstraintLayoutä¼¼ä¹æ˜¯ç°åœ¨Androidå®˜æ–¹ç›®å‰æ¨èçš„ä¸€ä¸ªlayoutï¼Œæ€§èƒ½ä¹Ÿä¸é”™ï¼Œä½†æ˜¯æˆ‘ç›®å‰è¿˜ä¸æ˜¯å¾ˆä¼šä½¿ç”¨è¿™ä¸ªä¸œè¥¿ï¼Œæ‰€ä»¥çœ‹ç½‘ä¸Šçš„èµ„æ–™å­¦ä¹ äº†ä¸€ä¸‹çˆ±ï¼Œé¡ºä¾¿è®°å½•ä¸€ä¸‹ã€‚</p>
<span id="more"></span>
<h2 id="ä½¿ç”¨ConstraintLayout"><a href="#ä½¿ç”¨ConstraintLayout" class="headerlink" title="ä½¿ç”¨ConstraintLayout"></a>ä½¿ç”¨ConstraintLayout</h2><h3 id="1-Constraintï¼ˆçº¦æŸï¼‰"><a href="#1-Constraintï¼ˆçº¦æŸï¼‰" class="headerlink" title="1.Constraintï¼ˆçº¦æŸï¼‰"></a>1.Constraintï¼ˆçº¦æŸï¼‰</h3><p>Constraintå³çº¦æŸï¼Œå¯¹ä¸€ä¸ªViewçš„Leftï¼ˆStartï¼‰ï¼ŒTopï¼ŒRightï¼ˆEndï¼‰ï¼ŒBottomå››ä¸ªæ–¹å‘æ·»åŠ Constraintæ¡ä»¶åï¼Œæ­¤Viewçš„ä½ç½®ä¹Ÿå°±ç¡®å®šä¸‹æ¥äº†ï¼ŒConstraintä¹Ÿæ˜¯ConstraintLayoutæœ€åŸºæœ¬çš„æ“ä½œã€‚</p>
<p>ConstraintLayoutåŒ…å«è¿™äº›å±æ€§</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">app:layout_constraintBottom_toBottomOf//ä¸¾ä¸€åä¸‰app:layout_constraintBottom_toTopOf</span><br><span class="line">app:layout_constraintEnd_toEndOf//ä¸¾ä¸€åä¸‰app:layout_constraintEnd_toStartOf</span><br><span class="line">app:layout_constraintStart_toStartOf//ä¸¾ä¸€åä¸‰app:layout_constraintStart_toEndOf</span><br><span class="line">app:layout_constraintTop_toTopOf//ä¸¾ä¸€åä¸‰app:layout_constraintTop_toBottomOf</span><br></pre></td></tr></table></figure>
<p>è¿™äº›å±æ€§æ¯”è¾ƒç®€å•ï¼Œç®€å•æ¥è¯´å°±æ˜¯åˆ°æŸä¸ªviewåˆ°æŸä¸ªæ–¹å‘çš„çº¦æŸï¼Œæ¯”å¦‚topçº¦æŸåŒ…å«ï¼š</p>
<p>çº¦æŸåœ¨æŸä¸ªViewçš„top(æ„æ€æ˜¯å’Œå½“å‰Viewçš„topè¿™ä¸ªViewçš„topå¯¹é½)æˆ–è€…æŸä¸ªViewçš„bottom(æ„æ€æ˜¯å’Œå½“å‰Viewçš„topè¿™ä¸ªViewçš„bottomå¯¹é½)ï¼Œå› æ­¤å››ä¸ªæ–¹å‘çš„çº¦æŸæ¡ä»¶ç›¸åŠ æ€»å…±æ˜¯æœ‰8ä¸ªçº¦æŸæ¡ä»¶ã€‚</p>
<p>åˆ›å»º<code>Constraint</code>å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/åŠ¨ç”».gif" alt="åŠ¨ç”»"></p>
<p><code>Constraint</code>çš„å±æ€§å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821174332342.png" alt="image-20210821174332342"></p>
<p><code>view</code>æ°´å¹³æ–¹å‘å’Œç«–ç›´æ–¹å‘çš„å°ºå¯¸æ˜¯åˆ†åˆ«ç”±å®½åº¦è®¾ç½®å’Œé«˜åº¦è®¾ç½®å†³å®šçš„ã€‚èƒ½è®¾ç½®çš„å€¼æœ‰ä»¥ä¸‹ä¸‰ç§</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821174936423.png" alt="image-20210821174936423"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>è®¾ç½®ç±»å‹</th>
<th>è®¾ç½®å€¼</th>
<th>ä»‹ç»</th>
</tr>
</thead>
<tbody>
<tr>
<td>å›ºå®šå¤§å°ï¼ˆFixedï¼‰</td>
<td>Xdp</td>
<td>ä»¥dpä¸ºå•ä½ï¼Œä¸ºè§†å›¾æŒ‡å®šå›ºå®šå€¼</td>
</tr>
<tr>
<td>åŒ…è£¹å†…å®¹ï¼ˆwrap_contentï¼‰</td>
<td>wrap_content</td>
<td>è®¾ç½®è§†å›¾æƒ³è¦çš„å°ºå¯¸ï¼ˆéšå†…å®¹èµ°ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¤§åˆ°è¶³å¤Ÿå®¹çº³å†…å®¹</td>
</tr>
<tr>
<td>åŠ¨æ€é€‚åº”(match Constraint)</td>
<td>0dp</td>
<td>å…è®¸è§†å›¾ç¼©æ”¾ä»¥æ»¡è¶³æŒ‡å®šçº¦æŸ</td>
</tr>
</tbody>
</table>
</div>
<p>å¯¹äºå‰ä¸¤ç±»ç†è§£èµ·æ¥å¯èƒ½æ¯”è¾ƒç®€å•ï¼Œå¯¹äºåŠ¨æ€é€‚åº”çš„è¯æˆ‘ç†è§£çš„æ˜¯å°±æ˜¯ä¹‹å‰çš„<code>match parent</code>,è®¾ç½®ä¸ºåŠ¨æ€é€‚åº”ä¹‹åå°±å›å……æ»¡æ•´ä¸ªConstraint</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821180855391.png" alt="image-20210821180855391"></p>
<h3 id="2-Bias"><a href="#2-Bias" class="headerlink" title="2.Bias"></a>2.Bias</h3><p><code>Bias</code>æ˜¯åç½®,ä¸»è¦ç”¨æ¥è®¾ç½®ä½ç½®åç§»æ¯”ä¾‹ï¼Œå–å€¼èŒƒå›´ä»0åˆ°1ï¼Œé»˜è®¤æ˜¯0.5ä¹Ÿå°±æ˜¯å±…ä¸­ã€‚è¿™ä¸ªåç½®å¯¹åº”ç€å›¾ä¸­çº¢è‰²æ¡†æ¡†éƒ¨åˆ†,å¯ä»¥é€šè¿‡ç§»åŠ¨è¿™ä¸€éƒ¨åˆ†è¿›è¡Œ<code>view</code>ç§»åŠ¨ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åœ¨è“è‰²æ¡†æ¡†éƒ¨åˆ†è¿›è¡Œå¡«å†™</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821220201491.png" alt="image-20210821220201491"></p>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹<code>Bias</code>çš„å€¼æ¥ç§»åŠ¨ä½ç½®ï¼Œæ¯”å¦‚ä¿®æ”¹æˆ0.2ï¼Œç„¶åå±•ç¤ºç»“æœå¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821220900560.png" alt="image-20210821220900560"></p>
<h3 id="3-Guideline"><a href="#3-Guideline" class="headerlink" title="3.Guideline"></a>3.Guideline</h3><p><code>Guideline</code>æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥ç†è§£æˆä¸€ä¸ªä¸å¯è§çš„<code>View</code>æ”¾åœ¨<code>ConstraintLayout</code>æŸä¸ªä½ç½®ï¼Œç„¶åå­<code>View</code>å°±å¯ä»¥ä»¥ä»–ä½œä¸º<code>Constraint</code>ç›®æ ‡æ¥å®šä½ã€‚</p>
<p>æ¯”å¦‚è¯´æˆ‘ä»¬åŠ ä¸€ä¸ª<code>horizontal guideline</code> </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210821230855642.png" alt="image-20210821230855642"></p>
<h3 id="4-Barrier"><a href="#4-Barrier" class="headerlink" title="4.Barrier"></a>4.Barrier</h3><p><code>Barrier</code>æ„ä¸ºå±éšœï¼Œå’Œ<code>Guideline</code>ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯è§çš„<code>View</code>ï¼Œä½†<code>Barrier</code>å¯ä»¥ä¿è¯ä¸€ç›´ä½äºæŸå‡ ä¸ª<code>View</code>çš„<code>Top/Bottom/Left/Right</code>ä¸‹é¢ï¼Œæœ‰äº›åœºæ™¯ä¸‹å¯èƒ½å¾ˆæœ‰ç”¨ã€‚</p>
<p>æ¯”å¦‚ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª<code>ImageView</code>ä¸€ç›´åœ¨ä¸€æ’æŒ‰é’®ä¹‹ä¸‹<code>100dp</code>çš„ä½ç½®ï¼Œå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ª<code>Barrier</code>ï¼Œå¯ä»¥çœ‹åˆ°åŠ¨å›¾ä¸Š<code>ImageView</code>æ˜¯ä¸€ç›´åœ¨è¿™ä¸‰ä¸ªæŒ‰é’®ä¹‹ä¸‹<code>100dp</code>çš„ä½ç½®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/åŠ¨ç”»2.gif" alt="åŠ¨ç”»2"></p>
<p>å…·ä½“åšæ³•æ˜¯å…ˆæ·»åŠ ä¸€ä¸ª<code>Barrier</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210822110903058.png" alt="image-20210822110903058"></p>
<p>ç„¶åå®Œæˆ<code>View</code>çš„ç»‘å®šï¼Œåœ¨<code>ComponentTree</code>çª—å£é‡Œï¼Œç›´æ¥æ‹–åŠ¨å¯¹åº”çš„å­<code>View</code>åˆ°<code>Barrier</code>é‡Œå°±å®Œæˆç»‘å®šäº†ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210822111508491.png" alt="image-20210822111508491"></p>
<p>ç„¶ååœ¨å±æ€§ä¸­è®¾ç½®<code>Barrier</code>çš„æ–¹å‘</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210822111630034.png" alt="image-20210822111630034"></p>
<p>æœ€å<code>View</code>æ·»åŠ çº¦æŸåˆ°<code>Barrier</code></p>
<p>æˆ‘åœ¨å¯è§†åŒ–ç¼–è¾‘å™¨ä¸Šæ·»åŠ æ·»åŠ ä¸äº†è¿™ä¸ªçº¦æŸï¼Œæˆ‘é‡‡å–çš„æ˜¯æ‰‹åŠ¨æ·»åŠ </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210822112652686.png" alt="image-20210822112652686"></p>
<p>æœ€ç»ˆè¾¾åˆ°çš„æ•ˆæœå¦‚ä¸Šé¢åŠ¨å›¾ä¸€æ ·</p>
<h3 id="5-Chain"><a href="#5-Chain" class="headerlink" title="5.Chain"></a>5.Chain</h3><p>é“¾æ˜¯ä¸€ç»„è§†å›¾ï¼Œè¿™äº›è§†å›¾é€šè¿‡åŒå‘ä½ç½®çº¦æŸæ¡ä»¶ç›¸äº’é“¾æ¥åˆ°ä¸€èµ·ï¼ŒConstraintLayoutå€ŸåŠ©æ­¤åŠŸèƒ½ï¼Œå¯ä»¥å®ç°LinearLayoutå¤§éƒ¨åˆ†æ•ˆæœã€‚</p>
<p>è¿™æ˜¯å®˜æ–¹ç»™å®šçš„ä¸€ç»„å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/constraint-chain-styles_2x.png" alt="img"></p>
<ol>
<li><strong>Spread</strong>ï¼šè§†å›¾æ˜¯å‡åŒ€åˆ†å¸ƒçš„ï¼ˆåœ¨è€ƒè™‘å¤–è¾¹è·ä¹‹åï¼‰ã€‚è¿™æ˜¯é»˜è®¤å€¼ã€‚</li>
<li><strong>Spread inside</strong>ï¼šç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªè§†å›¾å›ºå®šåœ¨é“¾ä¸¤ç«¯çš„çº¦æŸè¾¹ç•Œä¸Šï¼Œå…¶ä½™è§†å›¾å‡åŒ€åˆ†å¸ƒã€‚</li>
<li><strong>Weighted</strong>ï¼šå½“é“¾è®¾ç½®ä¸º <strong>spread</strong> æˆ– <strong>spread inside</strong> æ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªè§†å›¾è®¾ç½®ä¸ºâ€œmatch constraintsâ€(<code>0dp</code>) æ¥å¡«å……å‰©ä½™ç©ºé—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¾ç½®ä¸ºâ€œmatch constraintsâ€çš„æ¯ä¸ªè§†å›¾ä¹‹é—´çš„ç©ºé—´å‡åŒ€åˆ†å¸ƒï¼Œä½†æ‚¨å¯ä»¥ä½¿ç”¨ <code>layout_constraintHorizontal_weight</code> å’Œ <code>layout_constraintVertical_weight</code> å±æ€§ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…é‡è¦æ€§æƒé‡ã€‚å¦‚æœæ‚¨ç†Ÿæ‚‰<a href="https://developer.android.com/guide/topics/ui/layout/linear?hl=zh-cn">çº¿æ€§å¸ƒå±€</a>ä¸­çš„ <code>layout_weight</code> çš„è¯ï¼Œå°±ä¼šçŸ¥é“è¯¥æ ·å¼ä¸å®ƒçš„åŸç†æ˜¯ç›¸åŒçš„ã€‚å› æ­¤ï¼Œæƒé‡å€¼æœ€é«˜çš„è§†å›¾è·å¾—çš„ç©ºé—´æœ€å¤§ï¼›ç›¸åŒæƒé‡çš„è§†å›¾è·å¾—åŒæ ·å¤§å°çš„ç©ºé—´ã€‚</li>
<li><strong>Packed</strong>ï¼šè§†å›¾æ‰“åŒ…åœ¨ä¸€èµ·ï¼ˆåœ¨è€ƒè™‘å¤–è¾¹è·ä¹‹åï¼‰ã€‚ ç„¶åï¼Œæ‚¨å¯ä»¥é€šè¿‡æ›´æ”¹é“¾çš„å¤´è§†å›¾åå·®è°ƒæ•´æ•´æ¡é“¾çš„åå·®ï¼ˆå·¦/å³æˆ–ä¸Š/ä¸‹ï¼‰ã€‚</li>
</ol>
<p>å¦‚éœ€åˆ›å»ºé“¾ï¼Œè¯·é€‰æ‹©è¦åŒ…å«åœ¨é“¾ä¸­çš„æ‰€æœ‰è§†å›¾ï¼Œå³é”®ç‚¹å‡»å…¶ä¸­ä¸€ä¸ªè§†å›¾ï¼Œé€‰æ‹© <strong>Chains</strong>ï¼Œç„¶åé€‰æ‹© <strong>Center Horizontally</strong> æˆ– <strong>Center Vertically</strong>ï¼Œå¦‚ä¸‹åŠ¨å›¾ä¸­æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/åŠ¨ç”»3.gif" alt="åŠ¨ç”»3"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯åˆ›å»º<code>Chain</code>çš„æ—¶å€™è¿™äº›å­<code>View</code>ä¸è¦å¸¦<code>Constraint</code>ï¼Œæœ‰çš„è¯è¦æ¸…é™¤æ‰<code>Constraint</code>ï¼Œå› ä¸ºå·²æœ‰çš„<code>Constraint</code>ä¼šå½±å“åç»­çš„æ“ä½œ</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç›®å‰<code>ConstraintLayout</code>å°±æ€»ç»“åˆ°è¿™é‡Œï¼Œè¿˜æœ‰ä¸€äº›ç‚¹çš„è¯å¦‚æœéœ€è¦æ·»åŠ åˆ°æ—¶å€™å†æ·»åŠ ã€‚<code>ConstraintLayout</code>æ˜¯ç›®å‰æ¨èçš„å¸ƒå±€ï¼Œæ€§èƒ½ä¹Ÿé«˜ä¸€äº›ï¼Œåé¢å¯ä»¥å°½é‡éƒ½ä½¿ç”¨è¿™ä¸ª</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://developer.android.com/training/constraint-layout">https://developer.android.com/training/constraint-layout</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1684271">https://cloud.tencent.com/developer/article/1684271</a></li>
<li>ã€ŠAndroidæƒå¨ç¼–ç¨‹æŒ‡å—ã€‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>éšå¼intent</title>
    <url>/2021/08/25/Android%E5%AD%A6%E4%B9%A0/%E9%9A%90%E5%BC%8Fintent/</url>
    <content><![CDATA[<h1 id="éšå¼intent"><a href="#éšå¼intent" class="headerlink" title="éšå¼intent"></a>éšå¼intent</h1><p>Intent åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š</p>
<ul>
<li><strong>æ˜¾å¼ Intent</strong>ï¼šé€šè¿‡æä¾›ç›®æ ‡åº”ç”¨çš„è½¯ä»¶åŒ…åç§°æˆ–å®Œå…¨é™å®šçš„ç»„ä»¶ç±»åæ¥æŒ‡å®šå¯å¤„ç† Intent çš„åº”ç”¨ã€‚é€šå¸¸ï¼Œæ‚¨ä¼šåœ¨è‡ªå·±çš„åº”ç”¨ä¸­ä½¿ç”¨æ˜¾å¼ Intent æ¥å¯åŠ¨ç»„ä»¶ï¼Œè¿™æ˜¯å› ä¸ºæ‚¨çŸ¥é“è¦å¯åŠ¨çš„ Activity æˆ–æœåŠ¡çš„ç±»åã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¼šå¯åŠ¨æ‚¨åº”ç”¨å†…çš„æ–° Activity ä»¥å“åº”ç”¨æˆ·æ“ä½œï¼Œæˆ–è€…å¯åŠ¨æœåŠ¡ä»¥åœ¨åå°ä¸‹è½½æ–‡ä»¶ã€‚</li>
<li><strong>éšå¼ Intent</strong> ï¼šä¸ä¼šæŒ‡å®šç‰¹å®šçš„ç»„ä»¶ï¼Œè€Œæ˜¯å£°æ˜è¦æ‰§è¡Œçš„å¸¸è§„æ“ä½œï¼Œä»è€Œå…è®¸å…¶ä»–åº”ç”¨ä¸­çš„ç»„ä»¶æ¥å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚éœ€åœ¨åœ°å›¾ä¸Šå‘ç”¨æˆ·æ˜¾ç¤ºä½ç½®ï¼Œåˆ™å¯ä»¥ä½¿ç”¨éšå¼ Intentï¼Œè¯·æ±‚å¦ä¸€å…·æœ‰æ­¤åŠŸèƒ½çš„åº”ç”¨åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºæŒ‡å®šçš„ä½ç½®ã€‚</li>
</ul>
<p>å¯åŠ¨<code>Activity</code>æ—¶ä½¿ç”¨<code>Intent</code>ï¼Œå½“ä½¿ç”¨æ˜¾ç¤º<code>Intent</code>æ—¶ï¼Œ<code>Intent</code>å¯¹è±¡æ˜¯æ˜¾å¼å‘½åçš„æŸä¸ªå…·ä½“çš„<code>Activity</code>ç»„ä»¶æ—¶ï¼Œç³»ç»Ÿç«‹å³å¯åŠ¨è¯¥ç»„ä»¶ã€‚</p>
<p>å½“ä½¿ç”¨éšå¼<code>Intent</code>æ—¶ï¼ŒAndroid ç³»ç»Ÿé€šè¿‡å°† Intent çš„å†…å®¹ä¸åœ¨è®¾å¤‡ä¸Šå…¶ä»–åº”ç”¨<code>AndroidManifest</code>ä¸­ç”³æ˜çš„<code>Intent filter</code>è¿›è¡Œæ¯”è¾ƒï¼Œä»è€Œæ‰¾åˆ°è¦å¯åŠ¨çš„ç›¸åº”ç»„ä»¶ã€‚å¦‚æœ Intent ä¸ Intent è¿‡æ»¤å™¨åŒ¹é…ï¼Œåˆ™ç³»ç»Ÿå°†å¯åŠ¨è¯¥ç»„ä»¶ï¼Œå¹¶å‘å…¶ä¼ é€’<code>Intent</code>å¯¹è±¡ã€‚å¦‚æœå¤šä¸ª Intent è¿‡æ»¤å™¨å…¼å®¹ï¼Œåˆ™ç³»ç»Ÿä¼šæ˜¾ç¤ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œæ”¯æŒç”¨æˆ·é€‰å–è¦ä½¿ç”¨çš„åº”ç”¨ã€‚</p>
<p>å…·ä½“è¿‡ç¨‹å¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/intent-filters_2x.png" alt="img"></p>
<ol>
<li><em>Activity A</em> åˆ›å»ºåŒ…å«æ“ä½œæè¿°çš„ <code>Intent</code>ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ <code>startActivity()</code></li>
<li>Android ç³»ç»Ÿæœç´¢æ‰€æœ‰åº”ç”¨ä¸­ä¸ Intent åŒ¹é…çš„ Intent è¿‡æ»¤å™¨ã€‚å¯»æ‰¾åˆ°åŒ¹é…é¡¹</li>
<li>è¯¥ç³»ç»Ÿé€šè¿‡è°ƒç”¨åŒ¹é… Activity (<em>Activity B</em>) çš„ <code>onCreate()</code> æ–¹æ³•å¹¶å°†å…¶ä¼ é€’ç»™ <code>Intent</code>ï¼Œä»¥æ­¤å¯åŠ¨åŒ¹é… Activityã€‚</li>
</ol>
<p>ç®€å•ç†è§£æ˜¾ç¤ºå’Œéšå¼çš„åŒºåˆ«å°±ç±»ä¼¼äºç§Ÿæˆ¿å­ï¼Œæ˜¾ç¤º<code>Intent</code>å°±æ˜¯è‡ªå·±çŸ¥é“è‡ªå·±éœ€è¦ä»€ä¹ˆæ ·çš„æˆ¿å­ï¼Œå¹¶ä¸”å·²ç»ç¡®è®¤è‡ªå·±æƒ³ç§Ÿçš„æˆ¿å­åœ¨é‚£ä¸ªå°åŒºé‚£ä¸ªå•å…ƒé‚£ä¸ªæˆ¿é—´ï¼ˆå…·ä½“ç±»åï¼‰ï¼Œè€Œéšå¼<code>Intent</code>æ˜¯åªçŸ¥é“è‡ªå·±æƒ³ç§Ÿæˆ¿ï¼Œç„¶åæ¡ä»¶æ˜¯ä»€ä¹ˆï¼Œæ¯”å¦‚ï¼šæˆ¿é—´å¤§å°ã€æ˜¯å¦æ˜¯ç‹¬å«ã€æ˜¯å¦èƒ½å…»å® ç‰©ï¼Œç„¶åæŠŠè¿™äº›æ¡ä»¶äº¤ç»™ä¸­ä»‹ï¼ˆAndroidç³»ç»Ÿï¼‰ï¼Œæœ€ç»ˆç”±ä¸­ä»‹æŒ‘é€‰å‡ºä¸€äº›åˆé€‚çš„æˆ¿é—´ï¼Œç”±è‡ªå·±æŒ‘é€‰æ˜¯å¦ç§Ÿæˆ¿ã€‚</p>
<span id="more"></span>
<h2 id="æ˜¾ç¤ºIntent"><a href="#æ˜¾ç¤ºIntent" class="headerlink" title="æ˜¾ç¤ºIntent"></a>æ˜¾ç¤ºIntent</h2><p>æ˜¾ç¤º<code>Intent</code>è°ƒç”¨æ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦æŒ‡å®šå®Œæ•´çš„ç»„ä»¶ç±»åå³å¯ã€‚</p>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æ˜¾å¼Intentè°ƒç”¨â€”â€”æ„é€ æ–¹æ³•ä¼ å…¥Component</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(<span class="built_in">this</span>, TestActivity.class);</span><br><span class="line">startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶è¿˜æœ‰ä¸€äº›å…¶ä»–æ–¹æ³•ï¼Œå¤§è‡´éƒ½æ˜¯å·®ä¸å¤šéƒ½éœ€è¦æŒ‡å®šç±»åã€‚</p>
<p>ç›®å‰æˆ‘æœ‰ä¸€ä¸ªç–‘é—®å°±æ˜¯<strong>æ˜¾ç¤ºintentæ˜¯å¦èƒ½å¤Ÿè·¨åº”ç”¨å¯åŠ¨<code>Activity</code>ï¼Ÿ</strong></p>
<p>åé¢æ ¹æ®è‡ªå·±çš„å®éªŒå¾—æ¥æ˜¾ç¤º<code>Intent</code>æ˜¯å¯ä»¥è·¨åº”ç”¨å¯åŠ¨<code>Activity</code>ï¼Œå°±æ˜¯è¯´Aåº”ç”¨å¯ä»¥å¯åŠ¨Båº”ç”¨çš„<code>Activity</code></p>
<p>æ¯”å¦‚æˆ‘åˆ›å»ºä¸€ä¸ªåº”ç”¨ï¼Œç„¶ååœ¨é‡Œé¢åŠ å…¥ä¸€ä¸ªæŒ‰é’®ï¼Œåœ¨<code>onCreate()</code>ä¸­å†™ä¸‹ä¸‹é¢çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">Button</span> <span class="variable">mButton</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">    mButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">            <span class="comment">// å¯åŠ¨å…¶ä»–åº”ç”¨çš„Activityï¼Œç›®æ ‡Activityä¸åšä»»ä½•é…ç½®ï¼Œä¼šæŠ¥SecurityExceptioné”™è¯¯</span></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            <span class="comment">//String, String</span></span><br><span class="line">            intent.setClassName(<span class="string">&quot;com.example.testactivity&quot;</span>, <span class="string">&quot;com.example.testactivity.MainActivity&quot;</span>);</span><br><span class="line">            startActivity(intent);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬åˆ›å»ºå¯¹åº”çš„ä»¥<code>TestActivity</code>ä¸ºåº”ç”¨åçš„åº”ç”¨ï¼Œä»–çš„åŒ…åä¸º<code>com.example.testactivity</code>,å…¶ä¸­<code>MainActivity</code>çš„ç±»åæ˜¯<code>com.example.testactivity.MainActivity</code>ã€‚</p>
<p>ç„¶åæˆ‘ä»¬åœ¨<code>TestActivity</code>åº”ç”¨çš„<code>AndroidManifest.xml</code>ä¸­ï¼Œå¯¹åº”çš„ç›®æ ‡Activityä¸­åŠ å…¥<code>android:exported=&quot;true&quot;</code>å±æ€§å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åè¿è¡Œç¬¬ä¸€ä¸ªåº”ç”¨æŒ‰ä¸‹æŒ‰é’®å°±ä¼šå‘ç°è·³è½¬åˆ°äº†ç¬¬äºŒä¸ªåº”ç”¨ä¹‹ä¸­ã€‚</p>
<p>ä¸¾ä¸Šé¢çš„ä¾‹å­è¯´æ˜å…¶ä»–åº”ç”¨çš„ç»„ä»¶æˆ‘ä»¬æ˜¯å¯ä»¥é€šè¿‡æ˜¾ç¤ºçš„<code>Intent</code>è¿›è¡Œè°ƒç”¨ï¼Œä½†æ˜¯å¥½åƒå®˜æ–¹æ˜¯ä¸æ¨èä½¿ç”¨æ˜¾ç¤º<code>Intent</code>å¯åŠ¨å…¶ä»–çš„<code>Activity</code>ï¼Œå› ä¸ºæˆ‘ä»¬å†™çš„åŒ…åå’Œå…·ä½“ç±»åéƒ½æ˜¯ç¡¬ç¼–ç ï¼Œä¸€æ—¦ç›®æ ‡Activityä¿®æ”¹äº†ç±»åã€ä¿®æ”¹äº†åŒ…åæˆ–è€…ç§»åŠ¨äº†ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¹‹å‰å†™çš„å¯åŠ¨ä»£ç éƒ½ä¼šå¤±è´¥ï¼Œè¿™æ˜æ˜¾ä¸ç¬¦åˆæˆ‘ä»¬çš„ä»£ç è§„èŒƒã€‚</p>
<p>æ‰€ä»¥è¯´ï¼Œå¯åŠ¨å…¶ä»–åº”ç”¨çš„ç»„ä»¶æ—¶ï¼Œåº”è¯¥ä½¿ç”¨éšå¼Intentï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ä½¿ç”¨Intent-Filterè¿›è¡ŒåŒ¹é…ã€‚</p>
<h2 id="éšå¼Intent"><a href="#éšå¼Intent" class="headerlink" title="éšå¼Intent"></a>éšå¼Intent</h2><p>éšå¼Intentä¸ä¼šæŒ‡å®šç‰¹å®šçš„ç»„ä»¶ï¼Œè€Œæ˜¯å£°æ˜è¦æ‰§è¡Œçš„å¸¸è§„æ“ä½œï¼Œç³»ç»Ÿä¼šæ ¹æ®Intentçš„å†…å®¹å»åŒ¹é…å¯¹åº”çš„Activityå¹¶å¯åŠ¨ã€‚</p>
<p>éšå¼<code>Intent</code>æŒ‡å®šä¸€äº›æ“ä½œåä¼šæŠŠè¿™ä¸ª<code>Intent</code>ä¼ ç»™Androidç³»ç»Ÿï¼Œç„¶åç”±Androidç³»ç»Ÿè¿›è¡ŒåŒ¹é…ï¼ŒæŒ‘é€‰å‡ºå‡ºåˆé€‚çš„<code>Activity</code>å‡ºæ¥ç„¶åè¿›è¡Œå¯åŠ¨ã€‚è€Œ<code>Intent</code>æŒ‘é€‰çš„è§„åˆ™æ˜¯æ˜¯é€šè¿‡<code>Intent filter</code></p>
<p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<p>æˆ‘ä»¬å°†<code>TestActivity</code>åº”ç”¨ä¸­çš„<code>AndroidManifest.xml</code>çš„å†…å®¹è¿›è¡Œæ›´æ”¹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.MainActivity&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;Test&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>action</code>å…ƒç´ å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œactivityèƒ½å¤Ÿèƒœçš„ä»»æŒ‡å®šä»»åŠ¡ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>action</code>ä¸º<code>Test</code>ï¼Œ</p>
<p>ç„¶å<code>category</code>è®¾ç½®è°å¯ä»¥è®¿é—®ï¼Œ<code>DEFAULT</code>ç±»åˆ«å‘Šè¯‰æ“ä½œç³»ç»Ÿï¼ˆé—®è°å¯ä»¥åšæ—¶ï¼‰ï¼Œactivityæ„¿æ„å¤„ç†æŸé¡¹ä»»åŠ¡ã€‚DEFAULT ç±»åˆ«å®é™…éšå«äºæ‰€æœ‰éšå¼intentä¸­</p>
<p>ç„¶åæˆ‘ä»¬è®¾ç½®ç¬¬ä¸€ä¸ªåº”ç”¨å½“ä¸­çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line">    <span class="type">Button</span> <span class="variable">mButton</span> <span class="operator">=</span> findViewById(R.id.button);</span><br><span class="line">    mButton.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View v)</span> &#123;</span><br><span class="line">            <span class="comment">//éšå¼å¯åŠ¨</span></span><br><span class="line">            <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>();</span><br><span class="line">            intent.setAction(<span class="string">&quot;Test&quot;</span>);</span><br><span class="line">            startActivity(intent);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ ·çš„æˆ‘ä»¬å¯åŠ¨è¯¥åº”ç”¨ç‚¹å‡»æŒ‰é’®å°±èƒ½å¯åŠ¨<code>TestActivity</code>åº”ç”¨</p>
<h3 id="åŒ¹é…è§„åˆ™"><a href="#åŒ¹é…è§„åˆ™" class="headerlink" title="åŒ¹é…è§„åˆ™"></a>åŒ¹é…è§„åˆ™</h3><p>å…·ä½“æ¥è¯´éšå¼<code>Intent</code>æœ‰å…¶å›ºå®šçš„åŒ¹é…è§„åˆ™ï¼ŒåŒ¹é…æ—¶ä¼šå¯¹<code>Activity</code>çš„è¿‡æ»¤åˆ—è¡¨è¿›è¡Œå¯¹æ¯”ï¼Œå¯¹æ¯”è¿‡æ»¤åˆ—è¡¨å½“ä¸­çš„<code>actionã€categoryã€data</code>ä¿¡æ¯ï¼Œ</p>
<p><strong>action</strong></p>
<p>actionæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²åŒºåˆ†å¤§å°å†™ã€‚ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸€äº›actionï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åº”ç”¨ä¸­å®šä¹‰è‡ªå·±çš„actionã€‚</p>
<p>ä¸€ä¸ªä¸­å¯ä»¥æœ‰å¤šä¸ªactionï¼Œæ­¤æ—¶Intentä¸­çš„actionèƒ½å¤Ÿå’Œä¸­çš„ä»»ä½•ä¸€ä¸ªactionç›¸åŒå³å¯åŒ¹é…æˆåŠŸã€‚</p>
<p><strong>category</strong></p>
<p>categoryä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¹ŸåŒºåˆ†å¤§å°å†™ã€‚ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸€äº›categoryï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨åº”ç”¨ä¸­å®šä¹‰è‡ªå·±çš„categoryã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´<code>Intent</code>çš„categoryæœ‰é»˜è®¤å€¼ï¼Œæ˜¯ç”±äºç³»ç»Ÿåœ¨è°ƒç”¨startActivityæˆ–è€…startActivityForResultçš„æ—¶å€™ä¼šé»˜è®¤ä¸ºIntentåŠ ä¸Šâ€œandroid.intent.category.DEFAULTâ€è¿™ä¸ªcategoryã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬çš„é…ç½®ä¸­å¿…é¡»æ·»åŠ å¯¹åº”çš„é…ç½®ï¼Œä¸ç„¶ä¼šåŒ¹é…å¤±è´¥ã€‚</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Intentä¸­æˆ‘ä»¬å¯ä»¥ä¸è®¾ç½®categoryï¼Œå› ä¸ºç³»ç»Ÿé»˜è®¤ç»™æˆ‘ä»¬æ·»åŠ äº†â€œandroid.intent.category.DEFAULTâ€ã€‚å¦‚æœæˆ‘ä»¬è¦æ·»åŠ categoryçš„è¯ï¼Œè¿™ä¸ªcategoryå°±å¿…é¡»è·Ÿçš„ä»»æ„ä¸€ä¸ªåŒ¹é…ï¼Œå¦åˆ™ä¼šåŒ¹é…å¤±è´¥ã€‚</p>
<p><strong>data</strong></p>
<p>dataè®¾ç½®æ¥æ”¶æ•°æ®ç±»å‹ï¼Œä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆmimeTypeå’ŒURIã€‚</p>
<p>mimeTypeæŒ‡åª’ä½“ç±»å‹ï¼Œæ¯”å¦‚<code>image/jpeg</code>ã€<code>audio/mpeg4-generic</code>å’Œ<code>video/*</code>ç­‰ï¼Œå¯ä»¥è¡¨ç¤ºå›¾ç‰‡ã€æ–‡æœ¬ã€è§†é¢‘ç­‰ä¸åŒçš„åª’ä½“æ ¼å¼ã€‚</p>
<p>URIåŒ…å«çš„æ•°æ®æ¯”è¾ƒå¤šï¼Œç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;[&lt;path&gt;|&lt;pathPrefix&gt;|&lt;pathPattern&gt;]</span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">content://com.example.project:200/folder/subfolder/etc</span><br><span class="line">http://www.baidu.com:80/search/info</span><br></pre></td></tr></table></figure>
<p>dataçš„åŒ¹é…è§„åˆ™</p>
<p>dataæ˜¯éå¿…é¡»çš„ï¼Œå¯ä»¥ä¸è®¾ç½®ã€‚ä½†æ˜¯å¦‚æœåœ¨å®šä¹‰äº†dataï¼Œé‚£ä¹ˆIntentä¸­ä¹Ÿå¿…é¡»è®¾ç½®å¯åŒ¹é…çš„dataã€‚URIæœ‰é»˜è®¤å€¼fileå’Œcontentï¼Œå¦‚æœè®¾ç½®äº†URIï¼Œåˆ™é»˜è®¤å€¼å°±å¤±æ•ˆï¼ŒmimeTypeæ²¡ç”¨é»˜è®¤å€¼ï¼Œå¹¶ä¸”å¯ä»¥ä¸è®¾ç½®ã€‚dataçš„åŒ¹é…æ„å‘³ç€mimeTypeå’ŒURIåŒæ—¶åŒ¹é…ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><code>Intent</code>æœ‰æ˜¾ç¤ºå’Œéšå¼ä¸¤ç§ï¼Œæ˜¾ç¤ºçš„å†…å®¹ä¸å¤šï¼Œæ˜¾ç¤ºä¸»è¦ç”¨äºåº”ç”¨å†…ï¼Œè€Œéšå¼<code>Intent</code>æ¯”è¾ƒçµæ´»ï¼Œå†…å®¹ä¹Ÿæ¯”è¾ƒå¤š</p>
<p>å¯¹äºéšå¼Intentè€Œè¨€ï¼Œå¿…ä¸å¯å°‘çš„æ˜¯actionï¼Œå› ä¸ºé»˜è®¤çš„categoryä¼šæ·»åŠ ã€‚</p>
<p>å¦‚æœå®šä¹‰äº†dataï¼Œä¸ç®¡mimeTypeæ˜¯å¦è®¾ç½®ï¼ŒIntentä¸­éƒ½å¿…é¡»è®¾ç½®uriï¼Œå› ä¸ºuriæœ‰é»˜è®¤å€¼ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://blog.csdn.net/qq_26287435/article/details/98620772">https://blog.csdn.net/qq_26287435/article/details/98620772</a></li>
<li><a href="https://blog.csdn.net/xiao__gui/article/details/11392987">https://blog.csdn.net/xiao__gui/article/details/11392987</a></li>
<li><a href="https://developer.android.com/guide/components/intents-filters?hl=zh-cn">https://developer.android.com/guide/components/intents-filters?hl=zh-cn</a></li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>C++ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°</title>
    <url>/2024/09/20/C++/C++%E7%B1%BB%E4%B8%AD%E7%9A%84%E7%89%B9%E6%AE%8A%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="C-ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°"><a href="#C-ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°" class="headerlink" title="C++ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°"></a>C++ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°</h1><p>C++ç±»ä¸­å­˜åœ¨ä¸€äº›ç‰¹æ®Šçš„æˆå‘˜å‡½æ•°ï¼Œç¼–è¯‘å™¨é€šå¸¸ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬ç”Ÿæˆè¿™äº›å‡½æ•°ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè¿™äº›å‡½æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦äº†è§£è¿™äº›å‡½æ•°çš„ç”Ÿæˆè§„åˆ™ï¼Œå¹¶åšå¥½è®°å½•ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/C++ç±»ä¸­çš„ç‰¹æ®Šæˆå‘˜å‡½æ•°.jpeg" alt="ç”»æ¿"><br><span id="more"></span></p>
<ol>
<li>é»˜è®¤æ„é€ å‡½æ•°ã€‚ä»…å½“ç±»<strong>ä¸å­˜åœ¨ç”¨æˆ·å£°æ˜çš„æ„é€ å‡½æ•°æ—¶</strong>æ‰è‡ªåŠ¨ç”Ÿæˆã€‚ä¹Ÿå°±æ˜¯å•¥æ„é€ å‡½æ•°éƒ½æ²¡å®šä¹‰ï¼Œç¼–è¯‘å™¨æ‰ä¼šè‡ªåŠ¨ç”Ÿæˆã€‚</li>
<li>ææ„å‡½æ•°ã€‚ç¼–è¯‘å™¨æ€»æ˜¯ä¼šè¢«è‡ªåŠ¨ç”Ÿæˆï¼Œé™¤éä½ è‡ªå®šä¹‰äº†å®ƒã€‚</li>
<li>æ‹·è´æ„é€ å‡½æ•°ã€‚<ol>
<li>æ‹·è´æ„é€ å’Œæ‹·è´èµ‹å€¼ä¹‹é—´æ˜¯ç‹¬ç«‹çš„äº’ä¸å¹²æ‰°ï¼Œè‡ªå®šä¹‰äº†æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°ï¼ˆç†è®ºä¸Šå®šä¹‰äº†ä¸€ä¸ªæ‹·è´æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚å®šä¹‰äº†ä¸€ä¸ªæ‹·è´æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚ä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚</li>
<li>æ‹·è´å’Œç§»åŠ¨ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œè‡ªå®šä¹‰äº†<strong>ç§»åŠ¨æ“ä½œï¼ˆç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰</strong>ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºä½ ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼ˆç¼–è¯‘å™¨é€šè¿‡ç»™æ‹·è´æ“ä½œåŠ ä¸Šdeleteæ¥ä¿è¯ï¼‰ã€‚</li>
<li>ææ„å‡½æ•°<strong>ä¸ä¼šå½±å“</strong>æ‹·è´æ“ä½œï¼Œè‡ªå®šä¹‰äº†ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°ã€‚ï¼ˆç†è®ºä¸ŠæŒ‰ç…§big_threeç†è®ºï¼Œè‡ªå®šä¹‰äº†ææ„å‡½æ•°ï¼Œæ‹·è´æ“ä½œåº”è¯¥ä¹Ÿè‡ªå®šä¹‰äº†ï¼Œæ¯•ç«Ÿéœ€è¦è‡ªå·±è¿›è¡Œèµ„æºé‡Šæ”¾ï¼Œé‚£èµ„æºçš„æ‹·è´ä¹Ÿåº”è¯¥éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¥½åƒç¼–è¯‘å™¨ä¼šç”Ÿæˆè­¦å‘Šï¼‰</li>
</ol>
</li>
<li>æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚<ol>
<li>æ‹·è´æ„é€ å’Œæ‹·è´èµ‹å€¼ä¹‹é—´æ˜¯ç‹¬ç«‹çš„äº’ä¸å¹²æ‰°ï¼Œè‡ªå®šä¹‰äº†æ‹·è´æ„é€ å‡½æ•°ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šå¸®æˆ‘ä»¬ç”Ÿæˆæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼ˆç†è®ºä¸Šå®šä¹‰äº†ä¸€ä¸ªæ‹·è´æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚å®šä¹‰äº†ä¸€ä¸ªæ‹·è´æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªä¹Ÿåº”è¯¥å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚å®šä¹‰çš„ï¼Œç›®å‰å¥½åƒä¸å®šä¹‰ç¼–è¯‘è¿˜æ˜¯ä¼šç”Ÿæˆï¼Œä½†æ˜¯ä¼šç”Ÿæˆè­¦å‘Šï¼‰ã€‚</li>
<li>æ‹·è´å’Œç§»åŠ¨ä¹‹é—´æ˜¯äº’æ–¥çš„ï¼Œè‡ªå®šä¹‰äº†<strong>ç§»åŠ¨æ“ä½œï¼ˆç§»åŠ¨æ„é€ å‡½æ•°æˆ–ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼‰</strong>ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆæ‹·è´æ„é€ å‡½æ•°å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼ˆç¼–è¯‘å™¨é€šè¿‡ç»™æ‹·è´æ“ä½œåŠ ä¸Šdeleteæ¥ä¿è¯ï¼‰ã€‚</li>
<li>ææ„å‡½æ•°<strong>ä¸ä¼šå½±å“</strong>æ‹·è´æ“ä½œï¼Œè‡ªå®šä¹‰äº†ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆæ‹·è´èµ‹å€¼è¿ç®—ç¬¦ã€‚</li>
</ol>
</li>
<li>ç§»åŠ¨æ„é€ å‡½æ•°ã€‚<ol>
<li>ç§»åŠ¨æ“ä½œä¹‹é—´ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œè‡ªå®šä¹‰äº†ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚ç†ç”±ï¼šå¦‚æœä½ ç»™ç±»å£°æ˜äº†ï¼Œæ¯”å¦‚ï¼Œä¸€ä¸ªç§»åŠ¨æ„é€ å‡½æ•°ï¼Œå°±è¡¨æ˜å¯¹äºç§»åŠ¨æ“ä½œåº”æ€æ ·å®ç°ï¼Œä¸ç¼–è¯‘å™¨åº”ç”Ÿæˆçš„é»˜è®¤é€æˆå‘˜ç§»åŠ¨æœ‰äº›åŒºåˆ«ã€‚å¦‚æœé€æˆå‘˜ç§»åŠ¨æ„é€ æœ‰äº›é—®é¢˜ï¼Œé‚£ä¹ˆé€æˆå‘˜ç§»åŠ¨èµ‹å€¼åŒæ ·ä¹Ÿå¯èƒ½æœ‰é—®é¢˜ã€‚æ‰€ä»¥å£°æ˜ç§»åŠ¨æ„é€ å‡½æ•°é˜»æ­¢ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦çš„ç”Ÿæˆï¼Œå£°æ˜ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦åŒæ ·é˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚</li>
<li>ç§»åŠ¨å’Œæ‹·è´åŠ¨ä½œäº’æ–¥ï¼Œè‡ªå®šä¹‰äº†ä»»ä½•æ‹·è´æ“ä½œï¼ˆæ‹·è´æ„é€ æ´»æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼‰ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆç§»åŠ¨æ„é€ æˆ–è€…ç§»åŠ¨èµ‹å€¼ã€‚ç†ç”±ï¼šå¦‚æœå£°æ˜æ‹·è´æ“ä½œï¼ˆæ„é€ æˆ–è€…èµ‹å€¼ï¼‰å°±æš—ç¤ºç€å¹³å¸¸æ‹·è´å¯¹è±¡çš„æ–¹æ³•ï¼ˆé€æˆå‘˜æ‹·è´ï¼‰ä¸é€‚ç”¨äºè¯¥ç±»ï¼Œç¼–è¯‘å™¨ä¼šæ˜ç™½å¦‚æœé€æˆå‘˜æ‹·è´å¯¹æ‹·è´æ“ä½œæ¥è¯´ä¸åˆé€‚ï¼Œé€æˆå‘˜ç§»åŠ¨ä¹Ÿå¯èƒ½å¯¹ç§»åŠ¨æ“ä½œæ¥è¯´ä¸åˆé€‚ã€‚</li>
<li>ææ„å‡½æ•°<strong>ä¼šå½±å“</strong>ç§»åŠ¨æ“ä½œï¼Œè‡ªå®šä¹‰äº†ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚</li>
</ol>
</li>
<li>ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚<ol>
<li>ç§»åŠ¨æ“ä½œä¹‹é—´ä¸æ˜¯ç‹¬ç«‹çš„ï¼Œè‡ªå®šä¹‰äº†ç§»åŠ¨æ„é€ ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºæˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚ç†ç”±åŒä¸Š</li>
<li>ç§»åŠ¨å’Œæ‹·è´åŠ¨ä½œäº’æ–¥ï¼Œè‡ªå®šä¹‰äº†ä»»ä½•æ‹·è´æ“ä½œï¼ˆæ‹·è´æ„é€ æ´»æ‹·è´èµ‹å€¼è¿ç®—ç¬¦ï¼‰ï¼Œç¼–è¯‘å™¨å°±ä¸ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆç§»åŠ¨æ„é€ æˆ–è€…ç§»åŠ¨èµ‹å€¼ã€‚ç†ç”±åŒä¸Š</li>
<li>ææ„å‡½æ•°<strong>ä¼šå½±å“</strong>ç§»åŠ¨æ“ä½œï¼Œè‡ªå®šä¹‰äº†ææ„å‡½æ•°ï¼Œç¼–è¯‘å™¨è¿˜æ˜¯ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆç§»åŠ¨æ„é€ å‡½æ•°ã€‚</li>
</ol>
</li>
</ol>
<p>æ³¨æ„æ²¡æœ‰â€œæˆå‘˜å‡½æ•°æ¨¡ç‰ˆé˜»æ­¢ç¼–è¯‘å™¨ç”Ÿæˆç‰¹æ®Šæˆå‘˜å‡½æ•°â€çš„è§„åˆ™ã€‚è¿™æ„å‘³ç€å¦‚æœWidgetæ˜¯è¿™æ ·ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Widget</span> &#123;</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;                <span class="comment">//ä»ä»»ä½•ä¸œè¥¿æ„é€ Widget</span></span><br><span class="line">    <span class="built_in">Widget</span>(<span class="type">const</span> T&amp; rhs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;                <span class="comment">//ä»ä»»ä½•ä¸œè¥¿èµ‹å€¼ç»™Widget</span></span><br><span class="line">    Widget&amp; <span class="keyword">operator</span>=(<span class="type">const</span> T&amp; rhs);</span><br><span class="line">    â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br>ç¼–è¯‘å™¨ä»ä¼šç”Ÿæˆç§»åŠ¨å’Œæ‹·è´æ“ä½œï¼ˆå‡è®¾æ­£å¸¸ç”Ÿæˆå®ƒä»¬çš„æ¡ä»¶æ»¡è¶³ï¼‰ï¼Œå³ä½¿å¯ä»¥æ¨¡æ¿å®ä¾‹åŒ–äº§å‡ºæ‹·è´æ„é€ å’Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„å‡½æ•°ç­¾å</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œç°ä»£C++è¿˜æœ‰ä¸€ä¸ªä¸‰/äº”æ³•åˆ™ï¼Œä¹Ÿæ˜¯å¯¹è¿™æ–¹é¢çš„æ€»ç»“ï¼Œæ„Ÿå…´è¶£å¯ä»¥å»äº†è§£ä¸€ä¸‹ã€‚<br>å‚è€ƒï¼š</p>
<p><a href="https://learn.microsoft.com/zh-cn/cpp/cpp/explicitly-defaulted-and-deleted-functions?view=msvc-170">https://learn.microsoft.com/zh-cn/cpp/cpp/explicitly-defaulted-and-deleted-functions?view=msvc-170</a></p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>decltypeç±»å‹æ¨å¯¼</title>
    <url>/2024/09/01/C++/decltype%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC/</url>
    <content><![CDATA[<h1 id="decltypeç±»å‹æ¨å¯¼"><a href="#decltypeç±»å‹æ¨å¯¼" class="headerlink" title="decltypeç±»å‹æ¨å¯¼"></a>decltypeç±»å‹æ¨å¯¼</h1><p><code>decltype</code>å¯ä»¥æ¨å¯¼å‡ºå˜é‡æˆ–è€…è¡¨è¾¾å¼çš„ç±»å‹ï¼Œæ¯”å¦‚<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">5</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span>&amp; y = x;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨decltypeè·å–å˜é‡çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">decltype</span>(x) a = <span class="number">10</span>; <span class="comment">// açš„ç±»å‹ä¸ºint</span></span><br><span class="line">    <span class="keyword">decltype</span>(y) b = x; <span class="comment">// bçš„ç±»å‹ä¸ºconst int&amp;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨decltypeè·å–è¡¨è¾¾å¼çš„ç±»å‹</span></span><br><span class="line">    <span class="keyword">decltype</span>(x + a) c = x + a; <span class="comment">// cçš„ç±»å‹ä¸ºint</span></span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;a: &quot;</span> &lt;&lt; a &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;b: &quot;</span> &lt;&lt; b &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;c: &quot;</span> &lt;&lt; c &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><span id="more"></span><br>å¹³æ—¶è‡ªå·±ä½¿ç”¨<code>decltype</code>æœ€å¤šçš„æ—¶å€™æ˜¯å’Œlambdaè¿›è¡Œé…åˆï¼Œæ¨å¯¼lambdaçš„ç±»å‹<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨lambdaè¡¨è¾¾å¼å®šä¹‰æ¯”è¾ƒå™¨ï¼ŒæŒ‰å…ƒç´ çš„ç»å¯¹å€¼ä»å°åˆ°å¤§æ’åº</span></span><br><span class="line">    <span class="keyword">auto</span> cmp = [](<span class="type">int</span> a, <span class="type">int</span> b) &#123;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">abs</span>(a) &lt; std::<span class="built_in">abs</span>(b);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨std::setä¸­ä½¿ç”¨è‡ªå®šä¹‰çš„æ¯”è¾ƒå™¨</span></span><br><span class="line">    <span class="function">std::set&lt;<span class="type">int</span>, <span class="title">decltype</span><span class="params">(cmp)</span>&gt; <span class="title">mySet</span><span class="params">(cmp)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ’å…¥ä¸€äº›å…ƒç´ </span></span><br><span class="line">    mySet.<span class="built_in">insert</span>(<span class="number">-5</span>);</span><br><span class="line">    mySet.<span class="built_in">insert</span>(<span class="number">3</span>);</span><br><span class="line">    mySet.<span class="built_in">insert</span>(<span class="number">-2</span>);</span><br><span class="line">    mySet.<span class="built_in">insert</span>(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å‡ºæ’åºåçš„å…ƒç´ </span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; elem : mySet) &#123;</span><br><span class="line">        std::cout &lt;&lt; elem &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    std::cout &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ä¸»è¦ä½œç”¨"><a href="#ä¸»è¦ä½œç”¨" class="headerlink" title="ä¸»è¦ä½œç”¨"></a>ä¸»è¦ä½œç”¨</h2><p>å­¦ä¹ ä¹‹åå‘ç°<code>decltype</code>ä¸»è¦ä½œç”¨æ˜¯å’Œ<code>auto</code>ä¸€èµ·å¯¹<strong>å‡½æ•°æ¨¡æ¿è¿”å›å€¼ç±»å‹</strong>è¿›è¡Œæ¨å¯¼<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å‡½æ•°æ¨¡æ¿ï¼Œè¿”å›ä¸¤ä¸ªå‚æ•°çš„å’Œï¼ˆC++14ï¼‰</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T, <span class="keyword">typename</span> U&gt;</span><br><span class="line"> <span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">add</span><span class="params">(T a, U b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="autoå’Œdecltypeçš„åŒºåˆ«"><a href="#autoå’Œdecltypeçš„åŒºåˆ«" class="headerlink" title="autoå’Œdecltypeçš„åŒºåˆ«"></a>autoå’Œdecltypeçš„åŒºåˆ«</h3><p>è¿™é‡Œåªè¯´autoå’Œdecltypeæ¨å¯¼å‡½æ•°æ¨¡æ¿è¿”å›å€¼ç±»å‹çš„åŒºåˆ«</p>
<ul>
<li>autoæ¨å¯¼è¿”å›å€¼ç±»å‹ï¼Œèµ°çš„æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼çš„ä¸€å¥—è§„åˆ™ï¼Œæ¨å¯¼è¿‡ç¨‹ä¸­å¼•ç”¨æ€§ä¼šè¢«å¿½ç•¥</li>
<li>decltypeæ¨å¯¼å¯ä»¥ä¿ç•™å¼•ç”¨ç‰¹æ€§</li>
</ul>
<p>ï¼ˆä¹¦ä¸­ä¾‹å­ï¼‰æ¯”å¦‚ï¼šç°åœ¨éœ€è¦ä¸€ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªå½¢å‚ä¸ºå®¹å™¨ï¼Œä¸€ä¸ªå½¢å‚ä¸ºç´¢å¼•å€¼ï¼Œè¿™ä¸ªå‡½æ•°æ”¯æŒä½¿ç”¨æ–¹æ‹¬å·çš„æ–¹å¼ï¼ˆä¹Ÿå°±æ˜¯ä½¿ç”¨â€œ<code>[]</code>â€ï¼‰è®¿é—®å®¹å™¨ä¸­æŒ‡å®šç´¢å¼•å€¼çš„æ•°æ®ï¼Œç„¶ååœ¨è¿”å›ç´¢å¼•æ“ä½œçš„ç»“æœå‰æ‰§è¡Œè®¤è¯ç”¨æˆ·æ“ä½œã€‚<br>ä½¿ç”¨auto<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;    <span class="comment">//C++14ç‰ˆæœ¬ï¼Œ</span></span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> c[i];                                <span class="comment">//ä»c[i]ä¸­æ¨å¯¼è¿”å›ç±»å‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>ä½¿ç”¨autoè¿›è¡Œæ¨å¯¼çš„è¯ï¼Œç¼–è¯‘å™¨ä½¿ç”¨çš„æ˜¯æ¨¡æ¿ç±»å‹æ¨å¯¼çš„è§„åˆ™ï¼Œå®¹å™¨<code>[]</code>è¿”å›ç±»å‹ä¸º<code>T&amp;</code>ï¼Œ<code>T&amp;</code>è¿›è¡Œæ¨å¯¼æ—¶å¼•ç”¨æ€§è¢«å¿½ç•¥ï¼Œæœ€ç»ˆè¿”å›å€¼ç±»å‹è¢«æ¨å¯¼ä¸º<code>T</code>ã€‚<br>è¿™æ ·çš„è¯ï¼Œä¸‹é¢è¿™ç§ç±»å‹ä»£ç å°±ç¼–è¯‘ä¸è¿‡ï¼Œæœ‰ç‚¹å’Œå®¹å™¨<code>[]</code>ä½¿ç”¨ç›¸æ‚–<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">std::deque&lt;<span class="type">int</span>&gt; d;</span><br><span class="line">â€¦</span><br><span class="line"><span class="built_in">authAndAccess</span>(d, <span class="number">5</span>) = <span class="number">10</span>;               <span class="comment">//è®¤è¯ç”¨æˆ·ï¼Œè¿”å›d[5]ï¼Œ</span></span><br><span class="line">                                        <span class="comment">//ç„¶åæŠŠ10èµ‹å€¼ç»™å®ƒ</span></span><br><span class="line">                                        <span class="comment">//æ— æ³•é€šè¿‡ç¼–è¯‘å™¨ï¼</span></span><br></pre></td></tr></table></figure><br>ä½†æ˜¯å¦‚æœä½¿ç”¨decltypeè¿›è¡Œæ¨å¯¼ï¼Œå¯ä»¥ä¿ç•™åˆå§‹åŒ–è¡¨è¾¾å¼çš„æ‰€æœ‰å±æ€§ï¼Œæ‰€ä»¥è¿”å›å€¼ç±»å‹è¢«æ¨å¯¼ä¸º<code>T&amp;</code><br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;    <span class="comment">//C++14ç‰ˆæœ¬ï¼Œ</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp; c, Index i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> c[i];</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>å½“ç„¶ç›®å‰authAndAccess è¿˜ä¸æ˜¯æœ€å®Œç¾çš„ï¼Œå› ä¸ºauthAndAccessç›®å‰æ²¡æœ‰åŠæ³•æ¥å—å³å€¼ï¼Œä¸‹é¢çš„è°ƒç”¨æ–¹å¼æ˜æ˜¾å°±ä¸èƒ½ä½¿ç”¨<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">std::deque&lt;std::string&gt; <span class="title">makeStringDeque</span><span class="params">()</span></span>;      <span class="comment">//å·¥å‚å‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»makeStringDequeä¸­è·å¾—ç¬¬äº”ä¸ªå…ƒç´ çš„æ‹·è´å¹¶è¿”å›</span></span><br><span class="line"><span class="keyword">auto</span> s = <span class="built_in">authAndAccess</span>(<span class="built_in">makeStringDeque</span>(), <span class="number">5</span>);</span><br></pre></td></tr></table></figure><br>æ‰€ä»¥æœ€å®Œç¾çš„authAndAccessç¼–å†™æ–¹å¼<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> Index&gt;    <span class="comment">//æœ€ç»ˆçš„C++14ç‰ˆæœ¬</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">authAndAccess</span><span class="params">(Container&amp;&amp; c, Index i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">authenticateUser</span>();</span><br><span class="line">    <span class="keyword">return</span> std::forward&lt;Container&gt;(c)[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="éœ€è¦æ³¨æ„çš„ç‚¹"><a href="#éœ€è¦æ³¨æ„çš„ç‚¹" class="headerlink" title="éœ€è¦æ³¨æ„çš„ç‚¹"></a>éœ€è¦æ³¨æ„çš„ç‚¹</h2><p>decltypeä¼šå°†è¡¨è¾¾å¼æ¨å¯¼ä¸ºå¼•ç”¨ï¼Œæ‰€ä»¥å¯¹äºè¡¨è¾¾å¼<code>(x)</code>ï¼Œå°±ä¼šå‡ºç°ä¸‹é¢çš„å¥‡è‘©æƒ…å½¢<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">decltype</span>(x) 	<span class="comment">//int ç±»å‹</span></span><br><span class="line"><span class="keyword">decltype</span>((x))	<span class="comment">//int&amp;ç±»å‹</span></span><br></pre></td></tr></table></figure><br>ä»è€Œå‡ºç°è¿™ç§æƒ…å†µ<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">    â€¦</span><br><span class="line">    <span class="keyword">return</span> x;                            <span class="comment">//decltype(xï¼‰æ˜¯intï¼Œæ‰€ä»¥f1è¿”å›int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">f2</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> (x);                          <span class="comment">//decltype((x))æ˜¯int&amp;ï¼Œæ‰€ä»¥f2è¿”å›int&amp;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><br>è¿™ç§æƒ…å†µéœ€è¦æ³¨æ„</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>autoç±»å‹æ¨å¯¼</title>
    <url>/2024/08/26/C++/auto%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC/</url>
    <content><![CDATA[<h1 id="autoç±»å‹æ¨å¯¼"><a href="#autoç±»å‹æ¨å¯¼" class="headerlink" title="autoç±»å‹æ¨å¯¼"></a>autoç±»å‹æ¨å¯¼</h1><h2 id="æ¨å¯¼è§„åˆ™"><a href="#æ¨å¯¼è§„åˆ™" class="headerlink" title="æ¨å¯¼è§„åˆ™"></a>æ¨å¯¼è§„åˆ™</h2><p>autoç±»å‹æ¨å¯¼å’Œæ¨¡æ¿ç±»å‹å¤§è‡´ç›¸åŒï¼Œåˆ†ä¸ºä¸‰ç§ç±»å‹<br><span id="more"></span></p>
<ul>
<li><p>ç±»å‹è¯´æ˜ç¬¦æ˜¯ä¸€ä¸ªæŒ‡é’ˆæˆ–å¼•ç”¨ä½†ä¸æ˜¯é€šç”¨å¼•ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">27</span>;                </span><br><span class="line"><span class="keyword">auto</span> &amp; rx=x;             <span class="comment">//rxæ˜¯éé€šç”¨å¼•ç”¨ï¼Œrxæ¨å¯¼ä¸ºint &amp;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æƒ…æ™¯äºŒï¼šç±»å‹è¯´æ˜ç¬¦ä¸€ä¸ªé€šç”¨å¼•ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">27</span>;</span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; uref1 = x;  <span class="comment">//xæ˜¯intå·¦å€¼ï¼Œ</span></span><br><span class="line">                    <span class="comment">//æ‰€ä»¥uref1ç±»å‹ä¸ºint&amp;</span></span><br><span class="line"><span class="keyword">auto</span>&amp;&amp; uref2 = <span class="number">27</span>;	<span class="comment">//27æ˜¯intå³å€¼ï¼Œ</span></span><br><span class="line">                    <span class="comment">//æ‰€ä»¥uref3ç±»å‹ä¸ºint&amp;&amp;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æƒ…æ™¯ä¸‰ï¼šç±»å‹è¯´æ˜ç¬¦æ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> y = <span class="number">27</span>;    <span class="comment">//y æ¨å¯¼ä¸ºint </span></span><br></pre></td></tr></table></figure>
<p>vs2022ä»£ç è¿è¡Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">27</span>;</span><br><span class="line">	<span class="keyword">auto</span>&amp; rx = x;             <span class="comment">//rxæ˜¯éé€šç”¨å¼•ç”¨ï¼Œrxæ¨å¯¼ä¸ºint &amp;</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;rx = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(rx)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	<span class="keyword">auto</span>&amp;&amp; uref1 = x;         <span class="comment">//xæ˜¯intå·¦å€¼ï¼Œæ‰€ä»¥uref1ç±»å‹ä¸ºint&amp;</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;uref1 = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(uref1)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	<span class="keyword">auto</span>&amp;&amp; uref2 = <span class="number">27</span>;	    <span class="comment">//27æ˜¯intå³å€¼ï¼Œæ‰€ä»¥uref3ç±»å‹ä¸ºint&amp;&amp;</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;uref2 = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(uref2)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	<span class="keyword">auto</span> y = <span class="number">27</span>;            <span class="comment">//y æ¨å¯¼ä¸ºint </span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;y = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(y)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/autoç±»å‹æ¨å¯¼.png" alt="1723387016585.png"><br>è¿™éƒ¨åˆ†å†…å®¹å¯ä»¥å»æŸ¥çœ‹ <a href="https://bugcat.top/2024/08/10/C++/%E6%A8%A1%E6%9D%BF%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC/">æ¨¡æ¿ç±»å‹æ¨å¯¼çš„æ€»ç»“</a></p>
<h2 id="éœ€è¦æ³¨æ„çš„åœ°æ–¹"><a href="#éœ€è¦æ³¨æ„çš„åœ°æ–¹" class="headerlink" title="éœ€è¦æ³¨æ„çš„åœ°æ–¹"></a>éœ€è¦æ³¨æ„çš„åœ°æ–¹</h2><p><code>auto</code>å’Œ æ¨¡æ¿æ¨å¯¼ä¸åŒçš„åœ°æ–¹çš„åœ°æ–¹æ˜¯ï¼š autoç±»å‹æ¨å¯¼å‡å®šèŠ±æ‹¬å·è¡¨ç¤º<code>std::initializer_list</code>ï¼Œè€Œæ¨¡æ¿ç±»å‹æ¨å¯¼ä¸ä¼šè¿™æ ·</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> x = &#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;;         <span class="comment">//xçš„ç±»å‹æ˜¯std::initializer_list&lt;int&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;            <span class="comment">//å¸¦æœ‰ä¸xçš„å£°æ˜ç­‰ä»·çš„</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>;                <span class="comment">//å½¢å‚å£°æ˜çš„æ¨¡æ¿</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(&#123; <span class="number">11</span>, <span class="number">23</span>, <span class="number">9</span> &#125;);               <span class="comment">//é”™è¯¯ï¼ä¸èƒ½æ¨å¯¼å‡ºT</span></span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼ŒC++14è¿˜å…è®¸auto æ¨å¯¼å‡½æ•°è¿”å›å€¼ï¼Œlambdaå‡½æ•°ä¹Ÿå…è®¸åœ¨å½¢å‚å£°æ˜ä¸­ä½¿ç”¨<code>auto</code>ï¼Œä¸è¿‡è™½ç„¶ç”¨äº†autoå…³é”®å­—ï¼Œä½†æ˜¯åº•å±‚è¿˜æ˜¯<strong>æ¨¡æ¿ç±»å‹æ¨å¯¼</strong>çš„é‚£ä¸€å¥—è§„åˆ™åœ¨å·¥ä½œï¼Œæ‰€ä»¥ä¹Ÿä¸èƒ½æ¨å¯¼å‡º â€œèŠ±æ‹¬å·è¡¨ç¤º<code>std::initializer_list</code>â€</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">createInitList</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;;         <span class="comment">//é”™è¯¯ï¼ä¸èƒ½æ¨å¯¼&#123; 1, 2, 3 &#125;çš„ç±»å‹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">std::vector&lt;<span class="type">int</span>&gt; v;</span><br><span class="line"><span class="keyword">auto</span> resetV = </span><br><span class="line">    [&amp;v](<span class="type">const</span> <span class="keyword">auto</span>&amp; newValue)&#123; v = newValue; &#125;;        <span class="comment">//C++14</span></span><br><span class="line"><span class="built_in">resetV</span>(&#123; <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span> &#125;);            <span class="comment">//é”™è¯¯ï¼ä¸èƒ½æ¨å¯¼&#123; 1, 2, 3 &#125;çš„ç±»å‹</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>forward</title>
    <url>/2024/10/20/C++/forward/</url>
    <content><![CDATA[<p> C++ä¸­çš„<code>std::forward</code>å‡½æ•°æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ï¼Œä¸»è¦ç”¨äºåœ¨æ³›å‹ç¼–ç¨‹ä¸­å®Œç¾è½¬å‘ï¼ˆperfect forwardingï¼‰å‚æ•°ã€‚åœ¨C++ä¸­ï¼Œå®Œç¾è½¬å‘æ˜¯æŒ‡å°†å‡½æ•°æ¨¡æ¿ä¸­æ¥æ”¶åˆ°çš„å‚æ•°ä»¥<strong>åŸå§‹å½¢å¼ï¼ˆå·¦å€¼æˆ–å³å€¼ï¼‰è½¬å‘ç»™å¦ä¸€ä¸ªå‡½æ•°</strong>ï¼Œä¿æŒå‚æ•°çš„å€¼ç±»åˆ«ï¼ˆå·¦å€¼æˆ–å³å€¼ï¼‰ä¸å˜ã€‚<br><span id="more"></span><br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;                        <span class="comment">//C++14ï¼›ä»ç„¶åœ¨stdå‘½åç©ºé—´</span></span><br><span class="line"><span class="function">T&amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;T&gt;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;T&amp;&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°fï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; fParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦                                   <span class="comment">//åšäº›å·¥ä½œ</span></span><br><span class="line">    <span class="built_in">someFunc</span>(std::forward&lt;T&gt;(fParam));  <span class="comment">//è½¬å‘fParamåˆ°someFunc</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‡è®¾ä¼ å…¥æ˜¯å·¦å€¼"><a href="#å‡è®¾ä¼ å…¥æ˜¯å·¦å€¼" class="headerlink" title="å‡è®¾ä¼ å…¥æ˜¯å·¦å€¼"></a>å‡è®¾ä¼ å…¥æ˜¯å·¦å€¼</h2><p>ä¼ å…¥åˆ°<code>f</code>çš„å®å‚æ˜¯<code>Widget</code>çš„å·¦å€¼ç±»å‹ã€‚<code>T</code>è¢«æ¨å¯¼ä¸º<code>Widget&amp;</code>ï¼Œç„¶åè°ƒç”¨<code>std::forward</code>å°†å®ä¾‹åŒ–ä¸º<code>std::forward&lt;Widget&amp;&gt;</code>ã€‚<code>Widget&amp;</code>å¸¦å…¥åˆ°ä¸Šé¢çš„<code>std::forward</code>çš„å®ç°ä¸­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Widget&amp; &amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;Widget&amp;&gt;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp; &amp;&amp;&gt;(param); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆforwardè½¬åŒ–ä¸ºè¿”å›ä¸€ä¸ªå·¦å€¼å¼•ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Widget&amp; <span class="title">forward</span><span class="params">(Widget&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“å·¦å€¼å®å‚è¢«ä¼ å…¥åˆ°å‡½æ•°æ¨¡æ¿<code>f</code>æ—¶ï¼Œ<code>std::forward</code>è¢«å®ä¾‹åŒ–ä¸ºæ¥å—å’Œè¿”å›å·¦å€¼å¼•ç”¨ã€‚å†…éƒ¨çš„è½¬æ¢ä¸åšä»»ä½•äº‹ï¼Œå› ä¸º<code>param</code>çš„ç±»å‹å·²ç»æ˜¯<code>Widget&amp;</code>ï¼Œæ‰€ä»¥è½¬æ¢æ²¡æœ‰å½±å“ã€‚å·¦å€¼å®å‚ä¼ å…¥<code>std::forward</code>ä¼šè¿”å›å·¦å€¼å¼•ç”¨ã€‚é€šè¿‡å®šä¹‰ï¼Œå·¦å€¼å¼•ç”¨å°±æ˜¯å·¦å€¼ï¼Œå› æ­¤å°†å·¦å€¼ä¼ é€’ç»™<code>std::forward</code>ä¼šè¿”å›å·¦å€¼ï¼Œå°±åƒæœŸå¾…çš„é‚£æ ·</p>
<h2 id="å‡è®¾ä¼ å…¥æ˜¯å³å€¼"><a href="#å‡è®¾ä¼ å…¥æ˜¯å³å€¼" class="headerlink" title="å‡è®¾ä¼ å…¥æ˜¯å³å€¼"></a>å‡è®¾ä¼ å…¥æ˜¯å³å€¼</h2><p>ä¼ é€’ç»™<code>f</code>çš„å®å‚æ˜¯ä¸€ä¸ª<code>Widget</code>çš„å³å€¼ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>f</code>çš„ç±»å‹å‚æ•°<code>T</code>çš„æ¨å¯¼ç±»å‹å°±æ˜¯<code>Widget</code>ã€‚<code>f</code>å†…éƒ¨çš„<code>std::forward</code>è°ƒç”¨å› æ­¤ä¸º<code>std::forward&lt;Widget&gt;</code>ï¼Œ<code>std::forward</code>å®ç°ä¸­æŠŠ<code>T</code>æ¢ä¸º<code>Widget</code>å¾—åˆ°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Widget&amp;&amp; <span class="title">forward</span><span class="params">(<span class="type">remove_reference_t</span>&lt;Widget&gt;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&amp;&gt;(param); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè½¬åŒ–ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">Widget&amp;&amp; <span class="title">forward</span><span class="params">(Widget&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;Widget&amp;&amp;&gt;(param); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ä»å‡½æ•°è¿”å›çš„å³å€¼å¼•ç”¨å¯ä»¥è¢«å®šä¹‰ä¸ºå³å€¼</strong>ï¼Œæœ€ç»ˆç»“æœæ˜¯ï¼Œä¼ é€’ç»™<code>f</code>çš„å³å€¼å‚æ•°å°†ä½œä¸ºå³å€¼è½¬å‘ç»™<code>someFunc</code>ï¼Œæ­£æ˜¯æƒ³è¦çš„ç»“æœã€‚</p>
<p><strong>ä»å‡½æ•°è¿”å›çš„å³å€¼å¼•ç”¨å¯ä»¥è¢«å®šä¹‰ä¸ºå³å€¼çš„ç†è§£</strong>ï¼š</p>
<p>å¦‚æœä¸åŠ forwardï¼Œä¼ å…¥å³å€¼ï¼ŒfParamæ¨å¯¼ç±»å‹æ˜¯Widget&amp;&amp;ï¼Œæœ€ç»ˆç›´æ¥ä¼ å…¥someFuncï¼Œå®ƒæ˜¯æœ‰åå­—ï¼ˆfParamï¼‰çš„ï¼Œæ‰€ä»¥æ˜¯ä¸€ä¸ªå·¦å€¼ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; fParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦                                   <span class="comment">//åšäº›å·¥ä½œ</span></span><br><span class="line">    <span class="built_in">someFunc</span>(fParam);  <span class="comment">//è½¬å‘fParamåˆ°someFunc</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠ äº†forwardåï¼Œforwardè¿”å›ä¸€ä¸ªWidget&amp;&amp;ç±»å‹ï¼Œè¿”å›æ˜¯æœ‰ä¸ªåŒ¿åå˜é‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªå³å€¼</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; fParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    â€¦                                   <span class="comment">//åšäº›å·¥ä½œ</span></span><br><span class="line">    <span class="built_in">someFunc</span>(std::forward&lt;T&gt;(fParam));  <span class="comment">//è½¬å‘fParamåˆ°someFunc</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>move</title>
    <url>/2024/10/20/C++/move/</url>
    <content><![CDATA[<p><code>std::move</code>æ‰§è¡Œåˆ°å³å€¼çš„æ— æ¡ä»¶çš„è½¬æ¢ï¼Œä½†å°±è‡ªèº«è€Œè¨€ï¼Œå®ƒä¸ç§»åŠ¨ä»»ä½•ä¸œè¥¿</p>
<p>å†…éƒ¨çš„å®ç°ç±»ä¼¼è¿™æ ·ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">typename</span> remove_reference&lt;T&gt;::<span class="function">type&amp;&amp; <span class="title">move</span><span class="params">(T&amp;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ReturnType = <span class="keyword">typename</span> remove_reference&lt;T&gt;::type&amp;&amp;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;ReturnType&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<ol>
<li><code>remove_reference&lt;T&gt;::type</code>å¯¹<code>T</code>å»é™¤å¼•ç”¨</li>
<li><code>using ReturnType = typename remove_reference&lt;T&gt;::type&amp;&amp;</code>ï¼Œä½¿å¾—<code>ReturnType</code>æ˜¯ä¸€ä¸ªå³å€¼å¼•ç”¨</li>
<li><code>static_cast&lt;ReturnType&gt;(param)</code> å°†paramè½¬åŒ–ä¸ºå³å€¼å¼•ç”¨</li>
</ol>
<p>ç±»ä¼¼ä½¿ç”¨C++14ç‰ˆæœ¬æ›´ç®€å•ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">move</span><span class="params">(T&amp;&amp; param)</span>          <span class="comment">//C++14ï¼Œä»ç„¶åœ¨stdå‘½åç©ºé—´</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> ReturnType = <span class="type">remove_referece_t</span>&lt;T&gt;&amp;&amp;;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;ReturnType&gt;(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>push_backå’Œemplace_back</title>
    <url>/2024/10/20/C++/push-back%E5%92%8Cemplace-back/</url>
    <content><![CDATA[<p>modern C++ä¸­æåˆ°ä½¿ç”¨è€ƒè™‘ä½¿ç”¨ç½®å…¥ä»£æ›¿æ’å…¥ï¼Œä¸ªäººç†è§£å°±æ˜¯ä½¿ç”¨è€ƒè™‘ä½¿ç”¨<code>emplace_back</code>ä»£æ›¿<code>push_back</code>æ“ä½œï¼Œé‚£ä¹ˆè¿™ä¸¤è€…ä¹‹é—´ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæƒ³æ¢ç©¶ä¸€ä¸‹<br><span id="more"></span><br>é¦–å…ˆè¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰æ˜¯ä¸ä¸€æ ·çš„</p>
<h2 id="å‡½æ•°å®šä¹‰"><a href="#å‡½æ•°å®šä¹‰" class="headerlink" title="å‡½æ•°å®šä¹‰"></a>å‡½æ•°å®šä¹‰</h2><p><code>push_back</code>æ˜¯æœ‰ä¸¤ä¸ªå‡½æ•°çš„ï¼ˆé‡è½½ï¼‰ï¼Œä¸€ä¸ªæ¥å—å·¦å€¼ä¸€ä¸ªæ¥å—å³å€¼ï¼Œå¹¶ä¸”æ¥å—å³å€¼åè¿›è¡Œäº†<code>move</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">_CONSTEXPR20 <span class="type">void</span> <span class="title">push_back</span><span class="params">(<span class="type">const</span> _Ty&amp; _Val)</span> </span>&#123; <span class="comment">// insert element at end, provide strong guarantee</span></span><br><span class="line">    _Emplace_one_at_back(_Val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">_CONSTEXPR20 <span class="type">void</span> <span class="title">push_back</span><span class="params">(_Ty&amp;&amp; _Val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// insert by moving into element at end, provide strong guarantee</span></span><br><span class="line">    _Emplace_one_at_back(_STD <span class="built_in">move</span>(_Val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ<code>emplace_back</code>æ˜¯åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼Œæ˜¯ä¸€ä¸ªæ¨¡æ¿å‡½æ•°ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨å¹¶ä¸”æ˜¯å˜é•¿å‚æ•°ï¼Œç„¶åè¿›è¡Œäº†å®Œç¾è½¬å‘<code>forward</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span>... _Valty&gt;</span><br><span class="line">    <span class="function">_CONSTEXPR20 <span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">emplace_back</span><span class="params">(_Valty&amp;&amp;... _Val)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// insert by perfectly forwarding into element at end, provide strong guarantee</span></span><br><span class="line">       <span class="comment">// å®Œç¾è½¬å‘ç›´æ¥å°†å‚æ•°ä¼ å…¥å†…éƒ¨</span></span><br><span class="line">        _Ty&amp; _Result = _Emplace_one_at_back(_STD forward&lt;_Valty&gt;(_Val)...);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _HAS_CXX17</span></span><br><span class="line">        <span class="keyword">return</span> _Result;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// ^^^ _HAS_CXX17 / !_HAS_CXX17 vvv</span></span></span><br><span class="line">        (<span class="type">void</span>) _Result;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _HAS_CXX17</span></span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œ<code>push_back</code>å’Œ<code>emplace_back</code>éƒ½ä½¿ç”¨äº†_Emplace_one_at_backè¿›è¡Œæ’å…¥</p>
<h2 id="å·®å¼‚"><a href="#å·®å¼‚" class="headerlink" title="å·®å¼‚"></a>å·®å¼‚</h2><h3 id="æ€§èƒ½ä¸Š"><a href="#æ€§èƒ½ä¸Š" class="headerlink" title="æ€§èƒ½ä¸Š"></a>æ€§èƒ½ä¸Š</h3><p>å…ˆè¯´ç»“è®ºï¼š</p>
<p><strong>ç†è®ºä¸Šæ¥è¯´ï¼Œ<code>emplace_back</code>æ¯”<code>push_back</code>æ•ˆç‡æ›´é«˜ã€‚emplace_backèƒ½å¤Ÿåœ¨<code>vector</code>å†…éƒ¨æ„å»ºå…ƒç´ ï¼Œä»è€Œå‡å°‘æ‹·è´æˆ–è€…ç§»åŠ¨æ“ä½œ</strong></p>
<p>è¿™å¥è¯æ€ä¹ˆç†è§£å‘¢ï¼Œä¸¾ä¸ªä¾‹å­</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">std::vector&lt;std::string&gt; vs;        <span class="comment">//std::stringçš„å®¹å™¨</span></span><br><span class="line">vs.<span class="built_in">push_back</span>(<span class="string">&quot;xyzzy&quot;</span>);              <span class="comment">//æ·»åŠ å­—ç¬¦ä¸²å­—é¢é‡</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡ä¸Šé¢çš„æºç æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>push_back</code>æ¥å—çš„å‚æ•°æ˜¯ä¸€ä¸ª<code>T</code>çš„å…ƒç´ ï¼Œä½†æ˜¯è¿™é‡Œä¼ å…¥çš„æ˜¯å­—é¢é‡ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¼šé€šè¿‡å­—é¢é‡åˆ›å»ºå‡ºä¸€ä¸ªä¸´æ—¶å˜é‡ï¼ˆéšå¼è½¬æ¢ï¼‰ï¼Œç­‰ä»·äºä¸‹é¢çš„ä»£ç </p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vs.<span class="built_in">push_back</span>(std::<span class="built_in">string</span>(<span class="string">&quot;xyzzy&quot;</span>)); <span class="comment">//åˆ›å»ºä¸´æ—¶std::stringï¼ŒæŠŠå®ƒä¼ ç»™push_back</span></span><br></pre></td></tr></table></figure>
<p>ç»¼ä¸Švsçš„<code>push_back</code>æ€»å…±æœ‰ä¸‰ä¸ªæ“ä½œ</p>
<ol>
<li>ä¸€ä¸ª<code>std::string</code>çš„ä¸´æ—¶å¯¹è±¡ä»å­—é¢é‡â€œ<code>xyzzy</code>â€è¢«åˆ›å»ºã€‚è¿™ä¸ªå¯¹è±¡æ²¡æœ‰åå­—ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸º<code>temp</code>ã€‚<code>temp</code>çš„æ„é€ æ˜¯ç¬¬ä¸€æ¬¡<code>std::string</code>æ„é€ ã€‚å› ä¸ºæ˜¯ä¸´æ—¶å˜é‡ï¼Œæ‰€ä»¥<code>temp</code>æ˜¯å³å€¼ã€‚</li>
<li><code>temp</code>è¢«ä¼ é€’ç»™<code>push_back</code>çš„å³å€¼é‡è½½å‡½æ•°ï¼Œç»‘å®šåˆ°å³å€¼å¼•ç”¨å½¢å‚<code>_Val</code>ã€‚åœ¨<code>std::vector</code>çš„å†…å­˜ä¸­ä¸€ä¸ª<code>_Val</code>çš„å‰¯æœ¬è¢«åˆ›å»ºã€‚è¿™æ¬¡æ„é€ â€”â€”ä¹Ÿæ˜¯ç¬¬äºŒæ¬¡æ„é€ â€”â€”åœ¨<code>std::vector</code>å†…éƒ¨çœŸæ­£åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚</li>
<li>åœ¨<code>push_back</code>è¿”å›ä¹‹åï¼Œ<code>temp</code>ç«‹åˆ»è¢«é”€æ¯ï¼Œè°ƒç”¨äº†ä¸€æ¬¡<code>std::string</code>çš„ææ„å‡½æ•°ã€‚</li>
</ol>
<p>å½“æˆ‘ä»¬ä½¿ç”¨<code>emplace_back</code>æ—¶ï¼Œ</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vs.<span class="built_in">emplace_back</span>(<span class="string">&quot;xyzzy&quot;</span>);           <span class="comment">//ç›´æ¥ç”¨â€œxyzzyâ€åœ¨vså†…æ„é€ std::string</span></span><br></pre></td></tr></table></figure>
<p><code>emplace_back</code>ä½¿ç”¨å®Œç¾è½¬å‘å°†â€xyzzyâ€ä¼ å…¥äº†vectorå†…éƒ¨ï¼ˆå°±æ˜¯å‰é¢<code>_Ty&amp; _Result = _Emplace_one_at_back(_STD forward&lt;_Valty&gt;(_Val)...);</code>ï¼‰ï¼Œç›´æ¥åœ¨å†…éƒ¨çš„æ•°ç»„çš„æœ«å°¾<strong>æ„å»º</strong>å…ƒç´ æ’å…¥ï¼Œå‡å°‘äº†ä¸´æ—¶å˜é‡çš„äº§ç”Ÿï¼Œæé«˜äº†æ•ˆç‡ã€‚</p>
<h3 id="æ¥å—å‚æ•°ä¸Š"><a href="#æ¥å—å‚æ•°ä¸Š" class="headerlink" title="æ¥å—å‚æ•°ä¸Š"></a>æ¥å—å‚æ•°ä¸Š</h3><p><code>emplace_back</code>ä½¿ç”¨å®Œç¾è½¬å‘ï¼Œå› æ­¤åªè¦ä½ æ²¡æœ‰é‡åˆ°å®Œç¾è½¬å‘çš„é™åˆ¶ï¼ˆå®Œç¾è½¬å‘ä¹Ÿä¼šå¤±è´¥ï¼Œåœ¨è¿™é‡Œä¸å¤šè®²è§£ï¼‰ï¼Œå°±å¯ä»¥ä¼ é€’ä»»ä½•å®å‚ä»¥åŠç»„åˆåˆ°<code>emplace_back</code>ã€‚</p>
<p>æ¯”å¦‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">vs.<span class="built_in">emplace_back</span>(<span class="number">50</span>, <span class="string">&#x27;x&#x27;</span>);           <span class="comment">//æ’å…¥ç”±50ä¸ªâ€œxâ€ç»„æˆçš„ä¸€ä¸ªstd::string</span></span><br><span class="line">vs.<span class="built_in">push_back</span>(<span class="number">50</span>, <span class="string">&#x27;x&#x27;</span>);				<span class="comment">// error</span></span><br><span class="line">vs.<span class="built_in">push_back</span>(std::<span class="built_in">string</span>(<span class="number">50</span>, <span class="string">&#x27;x&#x27;</span>))  <span class="comment">// fine</span></span><br></pre></td></tr></table></figure>
<p>å†æ¯”å¦‚ä¸‹é¢è¿™ç§æƒ…å†µï¼Œä¸´æ—¶å˜é‡éƒ½ä¸ç»™ä½ è½¬åŒ–ï¼Œåªèƒ½ç”¨emplace_backä¼ å…¥</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">A</span><span class="params">(<span class="type">int</span> a)</span> :m_a(a) &#123;</span></span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">int</span> m_a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">std::vector&lt;A&gt; aVec;</span><br><span class="line">aVec.<span class="built_in">push_back</span>(<span class="number">1</span>);		<span class="comment">// error  </span></span><br><span class="line">aVec.<span class="built_in">emplace_back</span>(<span class="number">1</span>);	<span class="comment">// fine</span></span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥å†™èµ·æ¥<code>emplace_back</code>è‚¯å®šæ˜¯æ›´åŠ èˆ’æœçš„ï¼Œå°‘å†™å¥½å¤šå­—æ¯ï¼ˆç†è®ºä¸Šå‡å°‘å‡ºé”™ï¼‰ã€‚</p>
<h2 id="ä»£ç å®éªŒ"><a href="#ä»£ç å®éªŒ" class="headerlink" title="ä»£ç å®éªŒ"></a>ä»£ç å®éªŒ</h2><h3 id="å®éªŒä¸€ï¼ˆemplace-backé«˜æ•ˆæ€§ï¼‰"><a href="#å®éªŒä¸€ï¼ˆemplace-backé«˜æ•ˆæ€§ï¼‰" class="headerlink" title="å®éªŒä¸€ï¼ˆemplace_backé«˜æ•ˆæ€§ï¼‰"></a>å®éªŒä¸€ï¼ˆemplace_backé«˜æ•ˆæ€§ï¼‰</h3><p>ä½¿ç”¨push_back</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaseClass</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">BaseClass</span>(<span class="type">const</span> std::string name) : <span class="built_in">name_</span>(name)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; name_ &lt;&lt; <span class="string">&quot; constructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">BaseClass</span>(<span class="type">const</span> BaseClass&amp; b) :<span class="built_in">name_</span>(b.name_)</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; name_ &lt;&lt; <span class="string">&quot; copy constructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">BaseClass</span>(BaseClass&amp;&amp; b)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// æ­¤å¤„åªæ˜¯æ¼”ç¤ºï¼Œå¹¶æœªè¿›è¡ŒçœŸæ­£ç§»åŠ¨</span></span><br><span class="line">		name_ = b.name_;</span><br><span class="line">		b.name_ = b.name_ + <span class="string">&quot; have move&quot;</span>;</span><br><span class="line">		std::cout &lt;&lt; name_ &lt;&lt; <span class="string">&quot; move constructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">BaseClass</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		std::cout &lt;&lt; name_ &lt;&lt; <span class="string">&quot; destructor called&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	&#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::string name_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;BaseClass&gt; bcVec;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------push_back :&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	bcVec.<span class="built_in">push_back</span>(<span class="built_in">BaseClass</span>(<span class="string">&quot;push_back_obj&quot;</span>));</span><br><span class="line">  <span class="comment">// push_backï¼š</span></span><br><span class="line">  <span class="comment">//    (1) è°ƒç”¨ æœ‰å‚æ„é€ å‡½æ•° BaseClass (const std::string name) åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">  <span class="comment">//    (2ï¼‰è°ƒç”¨ ç§»åŠ¨æ„é€ å‡½æ•° BaseClass(BaseClass&amp;&amp; b) åˆ°vectorä¸­ï¼›</span></span><br><span class="line">  <span class="comment">//    (3) è°ƒç”¨     ææ„å‡½æ•°               é”€æ¯ä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">//   (4) vectorè¿›è¡Œææ„ï¼Œè°ƒç”¨ææ„å‡½æ•° </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœç¬¦åˆé¢„æœŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/push_back_obj.png" alt=""></p>
<p>ä½¿ç”¨emplace_back</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;BaseClass&gt; bcVec;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------emplace_back :&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	bcVec.<span class="built_in">emplace_back</span>(<span class="string">&quot;emplace_back_obj&quot;</span>);</span><br><span class="line">    <span class="comment">// (1) åœ¨vectorä¸­ç›´æ¥è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºå…ƒç´ </span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="comment">// (2) vectorè¿›è¡Œææ„ï¼Œè°ƒç”¨ææ„å‡½æ•° </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/emplace_back_obj.png" alt=""></p>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥emplace_backå°‘ä¸´æ—¶å˜é‡çš„<strong>æ„é€ ã€ç§»åŠ¨ã€é”€æ¯</strong>æ“ä½œï¼Œæ•ˆç‡è¦é«˜ä¸€äº›</p>
<h3 id="å®éªŒäºŒï¼ˆä¸¤è€…éƒ½ä¼ å…¥å³å€¼ï¼‰"><a href="#å®éªŒäºŒï¼ˆä¸¤è€…éƒ½ä¼ å…¥å³å€¼ï¼‰" class="headerlink" title="å®éªŒäºŒï¼ˆä¸¤è€…éƒ½ä¼ å…¥å³å€¼ï¼‰"></a>å®éªŒäºŒï¼ˆä¸¤è€…éƒ½ä¼ å…¥å³å€¼ï¼‰</h3><p>å¦‚æœä¼ å…¥å³å€¼ï¼Œpush_back å’Œ emplace_backæ•ˆç‡ç›¸åŒï¼Œéƒ½ä¼šæœ‰ä¸´æ—¶å˜é‡äº§ç”Ÿçš„<strong>æ„é€ ã€ç§»åŠ¨ã€é”€æ¯</strong>æ“ä½œã€‚</p>
<p>push_backä¼ å…¥å³å€¼ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">std::cout &lt;&lt; <span class="string">&quot;--------------------------------push_back rvalue:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">bcVec.<span class="built_in">push_back</span>(<span class="built_in">BaseClass</span>(<span class="string">&quot;push_back_rvalue&quot;</span>));</span><br><span class="line">  <span class="comment">// push_backï¼š</span></span><br><span class="line">  <span class="comment">//    (1) è°ƒç”¨ æœ‰å‚æ„é€ å‡½æ•° BaseClass (const std::string name) åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">  <span class="comment">//    (2ï¼‰è°ƒç”¨ ç§»åŠ¨æ„é€ å‡½æ•° BaseClass(BaseClass&amp;&amp; b) åˆ°vectorä¸­ï¼›</span></span><br><span class="line">  <span class="comment">//    (3) è°ƒç”¨     ææ„å‡½æ•°               é”€æ¯ä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">  <span class="comment">//   (4) vectorè¿›è¡Œææ„ï¼Œè°ƒç”¨ææ„å‡½æ•° </span></span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å·²ç»å±•ç¤ºè¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å¤šè§£é‡Šäº†ã€‚</p>
<p>emplace_backä¼ å…¥å³å€¼ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;BaseClass&gt; bcVec;</span><br><span class="line"></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------emplace_back rvalue:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">	bcVec.<span class="built_in">emplace_back</span>(<span class="built_in">BaseClass</span>(<span class="string">&quot;emplace_back_rvalue&quot;</span>));</span><br><span class="line">  <span class="comment">//    (1) è°ƒç”¨ æœ‰å‚æ„é€ å‡½æ•° BaseClass (const std::string name) åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">  <span class="comment">//    (2ï¼‰è°ƒç”¨ ç§»åŠ¨æ„é€ å‡½æ•° BaseClass(BaseClass&amp;&amp; b) åˆ°vectorä¸­ï¼›</span></span><br><span class="line">  <span class="comment">//    (3) è°ƒç”¨     ææ„å‡½æ•°               é”€æ¯ä¸´æ—¶å¯¹è±¡ï¼›</span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">  <span class="comment">//   (4) vectorè¿›è¡Œææ„ï¼Œè°ƒç”¨ææ„å‡½æ•° </span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼Œå¯ä»¥çœ‹å‡ºæ•ˆç‡æ²¡æœ‰æé«˜</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/emplace_back_rvalue.png" alt=""></p>
<h3 id="å®éªŒä¸‰ï¼ˆä¸¤è€…éƒ½ä¼ å…¥å·¦å€¼ï¼‰"><a href="#å®éªŒä¸‰ï¼ˆä¸¤è€…éƒ½ä¼ å…¥å·¦å€¼ï¼‰" class="headerlink" title="å®éªŒä¸‰ï¼ˆä¸¤è€…éƒ½ä¼ å…¥å·¦å€¼ï¼‰"></a>å®éªŒä¸‰ï¼ˆä¸¤è€…éƒ½ä¼ å…¥å·¦å€¼ï¼‰</h3><p>å¦‚æœä¼ å…¥å³å€¼ï¼Œpush_back å’Œ emplace_backæ•ˆç‡ç›¸åŒï¼Œä¸¤è€…éƒ½ä¼šè°ƒç”¨æ‹·è´æ„é€ å‡½æ•°</p>
<p>push_backä¼ å…¥å·¦å€¼ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;BaseClass&gt; bcVec;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------push_back lvalue:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">//  (1) è°ƒç”¨ æœ‰å‚æ„é€ å‡½æ•° BaseClass (const std::string name) åˆ›å»ºobjå¯¹è±¡ï¼›</span></span><br><span class="line">	<span class="function">BaseClass <span class="title">obj</span><span class="params">(<span class="string">&quot;obj&quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">//  (2) è°ƒç”¨ æ‹·è´æ„é€ å‡½æ•°ï¼›</span></span><br><span class="line">	bcVec.<span class="built_in">push_back</span>(obj);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">//  (3) objè¢«ææ„ï¼Œè°ƒç”¨BaseClassçš„ææ„å‡½æ•°</span></span><br><span class="line"><span class="comment">//  (4) vectorè¢«ææ„ï¼Œå…¶ä¸­çš„å…ƒç´ è°ƒç”¨BaseClassçš„ææ„å‡½æ•°</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/push_back_lvalue.png" alt=""></p>
<p>emplace_backä¼ å…¥å·¦å€¼ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	std::vector&lt;BaseClass&gt; bcVec;</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------emplace_back lvalue:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">//  (1) è°ƒç”¨ æœ‰å‚æ„é€ å‡½æ•° BaseClass (const std::string name) åˆ›å»ºobjå¯¹è±¡ï¼›</span></span><br><span class="line">	<span class="function">BaseClass <span class="title">obj</span><span class="params">(<span class="string">&quot;obj&quot;</span>)</span></span>;</span><br><span class="line"><span class="comment">//  (2) è°ƒç”¨ æ‹·è´æ„é€ å‡½æ•°ï¼›</span></span><br><span class="line">	bcVec.<span class="built_in">emplace_back</span>(obj);</span><br><span class="line">	std::cout &lt;&lt; <span class="string">&quot;--------------------------------destruct:&quot;</span> &lt;&lt; std::endl;</span><br><span class="line"><span class="comment">//  (3) objè¢«ææ„ï¼Œè°ƒç”¨BaseClassçš„ææ„å‡½æ•°</span></span><br><span class="line"><span class="comment">//  (4) vectorè¢«ææ„ï¼Œå…¶ä¸­çš„å…ƒç´ è°ƒç”¨BaseClassçš„ææ„å‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/emplace_back_lvalue.png" alt=""></p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/183861524">C++å§¿åŠ¿ç‚¹: push_backå’Œemplace_back</a></li>
</ul>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>staticã€externå’Œinline</title>
    <url>/2023/08/05/C++/static%E3%80%81extern%E5%92%8Cinline/</url>
    <content><![CDATA[<h1 id="staticã€externå’Œinline"><a href="#staticã€externå’Œinline" class="headerlink" title="staticã€externå’Œinline"></a>staticã€externå’Œinline</h1><p>åœ¨å®ä¹ å†™C++çš„æ—¶å€™é‡åˆ°staticã€externå’Œinlineç›¸å…³çš„æ¦‚å¿µå’Œä½¿ç”¨ï¼Œè®°å½•ä¸€ä¸‹<br><span id="more"></span></p>
<h2 id="static"><a href="#static" class="headerlink" title="static"></a>static</h2><p><code>static</code>å…³é”®å­—ä½œç”¨å¾ˆå¤šï¼Œè¿™é‡Œä¸»è¦è¯´æ˜<code>static</code>å˜é‡ã€‚<code>static</code>å˜é‡ç”Ÿå‘½å‘¨æœŸæ˜¯æ•´ä¸ªç¨‹åºï¼Œå¯è§æ€§æ˜¯æ–‡ä»¶å¯è§(è¿™äº›éƒ½æ˜¯å¾ˆåŸºç¡€çš„çŸ¥è¯†)<br>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯å‡å¦‚æˆ‘ä»¬åœ¨å¤´æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸€ä¸ª<code>static</code>å˜é‡ï¼ˆè¿™é‡Œå‡è®¾ä¸º<code>staticVar</code>ï¼‰ï¼Œé‚£ä¹ˆåŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶çš„æ–‡ä»¶éƒ½ä¼šæœ‰è¿™æ ·ä¸€ä¸ªå˜é‡<code>staticVar</code>ä¸ä¼šå‘ç”Ÿå†²çªã€‚è¿™ä¸ªç‰¹æ€§æœ‰æ—¶å€™æœ‰ç”¨ï¼Œ<strong>ä½†æ˜¯ç»å¤§å¤šæ•°æƒ…å†µè¿˜æ˜¯æ²¡æœ‰ç”¨çš„ï¼Œè€Œä¸”ä¼šæµªè´¹ç©ºé—´ï¼Œä¸å»ºè®®ä½¿ç”¨</strong>ã€‚<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å¤´æ–‡ä»¶A.h </span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> staticVar = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æºæ–‡ä»¶B.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;A.h&quot;</span> <span class="comment">// B.cppä¸­åŒ…å«ä¸€ä¸ª staticVar</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æºæ–‡ä»¶C.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;A.h&quot;</span> <span class="comment">// C.cppä¸­åŒ…å«ä¸€ä¸ª staticVar</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h2 id="extern"><a href="#extern" class="headerlink" title="extern"></a>extern</h2><p><code>extern</code>å…³é”®å­—åœ¨C++ä¸­ç”¨æ¥å£°æ˜å…¨å±€å˜é‡ï¼Œå®ƒç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå˜é‡åœ¨å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰çš„ï¼Œä»¥é¿å…é‡å¤å®šä¹‰ã€‚<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æºæ–‡ä»¶ A.cpp</span></span><br><span class="line"><span class="type">int</span> globalVariable = <span class="number">10</span>; <span class="comment">// å®šä¹‰å…¨å±€å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æºæ–‡ä»¶ B.cpp</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> globalVariable; <span class="comment">// å£°æ˜å…¨å±€å˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨å…¨å±€å˜é‡</span></span><br><span class="line">  globalVariable = <span class="number">20</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>æœ‰çš„æ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨å¤´æ–‡ä»¶ä¸­ä½¿ç”¨<code>extern</code>æ¥<strong>å£°æ˜</strong>ä¸€ä¸ªå˜é‡ï¼Œåœ¨æŸä¸ªæºæ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰ï¼Œç„¶åå…¶ä»–åŒ…å«è¿™ä¸ªå¤´æ–‡ä»¶çš„æºæ–‡ä»¶å°±éƒ½æœ‰è¿™ä¸ªå˜é‡çš„å£°æ˜ï¼Œå®ƒä»¬å…±äº«ä¸€ä»½å†…å®¹ã€‚</p>
<h2 id="inline"><a href="#inline" class="headerlink" title="inline"></a>inline</h2><p><code>inline</code>å…³é”®å­—ä¿®é¥°å‡½æ•°ï¼Œç”¨äºå‘ç¼–è¯‘å™¨æä¾›å‡½æ•°å†…è”çš„å»ºè®®ï¼Œä½†æ˜¯æˆ‘æ²¡æœ‰æƒ³åˆ°<code>inline</code>å…³é”®å­—å¯ä»¥è§£å†³è·¨æ¨¡å—ï¼ˆåŠ¨æ€åº“ï¼‰çš„ä½¿ç”¨å‡½æ•°çš„é—®é¢˜ã€‚<br>æ¯”å¦‚æˆ‘æœ‰ä¸€ä¸ªåŠ¨æ€åº“Aï¼ˆA.dllï¼‰å’Œä¸€ä¸ªåŠ¨æ€åº“Bï¼ˆB.dllï¼‰,åŠ¨æ€åº“Bä½¿ç”¨äº†Aé‡Œé¢çš„å‡½æ•°ï¼Œä½†æ˜¯Båœ¨é“¾æ¥çš„æ—¶å€™Aè¿˜æ²¡æœ‰ç¼–è¯‘ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å°†Aé‡Œé¢çš„å‡½æ•°åŠ ä¸Š<code>inline</code>è¿›è¡Œä¿®é¥°ï¼Œå°±ä¸ä¼šæŠ¥ç¬¦å·æ‰¾ä¸åˆ°çš„é—®é¢˜ã€‚<br>åº•å±‚æ¥çœ‹æ˜¯å› ä¸º<code>inline</code>å…³é”®å­—ä¿®é¥°çš„å‡½æ•°ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ä¼šè¿›è¡Œå±•å¼€ï¼Œè¿™æ ·å°±ä¸ä¼šæŸ¥æ‰¾è¿™ä¸ªç¬¦å·ï¼Œä½†æ˜¯è¿™ä¸ªç‰¹æ€§ç¡®å®æœ‰æ—¶å€™å¯ä»¥è§£å†³è¿™æ ·ç±»ä¼¼çš„ç¼–è¯‘é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>ä¼˜å…ˆä½¿ç”¨enum class</title>
    <url>/2024/10/03/C++/%E4%BC%98%E5%85%88%E4%BD%BF%E7%94%A8enum%20class/</url>
    <content><![CDATA[<p>C++ä¸­å­˜åœ¨<code>enum</code>å’Œ<code>enum class</code>ä¸¤ç§ï¼Œç°ä»£C++æ›´åŠ å»ºè®®ä½¿ç”¨<code>enum class</code>è¿™ç§ã€‚ç†ç”±ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š</p>
<ol>
<li><p><code>enum class</code>ä½œç”¨åŸŸæ›´å°ï¼Œå¯ä»¥å‡å°‘å‘½åç©ºé—´æ±¡æŸ“ã€‚<code>enum</code>å®šä¹‰åï¼Œå…¶ä¸­çš„æšä¸¾ç±»ä½œç”¨åŸŸæ˜¯æ•´ä¸ª<code>enum</code>æ‰€åœ¨ç©ºé—´ï¼Œå¯èƒ½å¯¹å…¶ä»–éƒ¨åˆ†äº§ç”Ÿå½±å“ã€‚æ¯”å¦‚</p>
<span id="more"></span>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123; black, white, red &#125;;   <span class="comment">//black, white, redåœ¨</span></span><br><span class="line">                                    <span class="comment">//Coloræ‰€åœ¨çš„ä½œç”¨åŸŸ</span></span><br><span class="line"><span class="keyword">auto</span> white = <span class="literal">false</span>;                 <span class="comment">//é”™è¯¯! whiteæ—©å·²åœ¨è¿™ä¸ªä½œç”¨</span></span><br><span class="line">                                    <span class="comment">//åŸŸä¸­å£°æ˜</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>enum</code>ä¼šå‘éšå¼è½¬æ¢ï¼Œä½†æ˜¯<code>enum class</code>ä¸ä¼šå‘ç”Ÿ</p>
</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span> &#123; black, white, red &#125;;       <span class="comment">//æœªé™åŸŸenum</span></span><br><span class="line"></span><br><span class="line">std::vector&lt;std::<span class="type">size_t</span>&gt;                <span class="comment">//funcè¿”å›xçš„è´¨å› å­</span></span><br><span class="line">  <span class="built_in">primeFactors</span>(std::<span class="type">size_t</span> x);</span><br><span class="line"></span><br><span class="line">Color c = red;</span><br><span class="line">â€¦</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c &lt; <span class="number">14.5</span>) &#123;                         <span class="comment">// Colorä¸doubleæ¯”è¾ƒ (!)</span></span><br><span class="line">    <span class="keyword">auto</span> factors =                      <span class="comment">// è®¡ç®—ä¸€ä¸ªColorçš„è´¨å› å­(!)</span></span><br><span class="line">      <span class="built_in">primeFactors</span>(c);</span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span> &#123; black, white, red &#125;; <span class="comment">//Colorç°åœ¨æ˜¯é™åŸŸenum</span></span><br><span class="line"></span><br><span class="line">Color c = Color::red;                   <span class="comment">//å’Œä¹‹å‰ä¸€æ ·ï¼Œåªæ˜¯</span></span><br><span class="line">...                                     <span class="comment">//å¤šäº†ä¸€ä¸ªåŸŸä¿®é¥°ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (c &lt; <span class="number">14.5</span>) &#123;                         <span class="comment">//é”™è¯¯ï¼ä¸èƒ½æ¯”è¾ƒ</span></span><br><span class="line">                                        <span class="comment">//Colorå’Œdouble</span></span><br><span class="line">    <span class="keyword">auto</span> factors =                      <span class="comment">//é”™è¯¯ï¼ä¸èƒ½å‘å‚æ•°ä¸ºstd::size_t</span></span><br><span class="line">      <span class="built_in">primeFactors</span>(c);                  <span class="comment">//çš„å‡½æ•°ä¼ é€’Colorå‚æ•°</span></span><br><span class="line">    â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>enum class</code><font style="color:rgb(0, 0, 0);">å¯ä»¥è¢«å‰ç½®å£°æ˜ã€‚å‰ç½®å£°æ˜æŸäº›æƒ…å†µä¸‹å¯ä»¥å‡å°‘ç¼–è¯‘ä¾èµ–ã€‚</font></li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span>;         <span class="comment">//é”™è¯¯ï¼</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span>;   <span class="comment">//æ²¡é—®é¢˜</span></span><br></pre></td></tr></table></figure>
<h2 id="enum-classä½¿ç”¨"><a href="#enum-classä½¿ç”¨" class="headerlink" title="enum classä½¿ç”¨"></a><code>enum class</code>ä½¿ç”¨</h2><ol>
<li>ç¬¬ä¸€é¡¹è¿›è¡Œèµ‹å€¼ã€‚å»ºè®®å¯¹æšä¸¾ç¬¬ä¸€é¡¹èµ‹å€¼0ï¼Œè¿™æ ·å¯ä»¥å¸®åŠ©æ˜ç¡®å„ä¸ªæšä¸¾é¡¹å€¼ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span></span><br><span class="line">&#123;</span><br><span class="line">    black=<span class="number">0</span>,</span><br><span class="line">    white,</span><br><span class="line">    red</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol>
<li>æ•´åŠ countã€‚è¿™ä¸ªæ˜¯æ–¹ä¾¿ç±»ä¼¼<code>vector&lt;int&gt; a(1,Color::count)</code>æƒ…å†µ</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span></span><br><span class="line">&#123;</span><br><span class="line">    black=<span class="number">0</span>,</span><br><span class="line">    white,</span><br><span class="line">    red,</span><br><span class="line">    count</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>æ¨¡æ¿ç±»å‹æ¨å¯¼</title>
    <url>/2024/08/10/C++/%E6%A8%A1%E6%9D%BF%E7%B1%BB%E5%9E%8B%E6%8E%A8%E5%AF%BC/</url>
    <content><![CDATA[<h1 id="æ¨¡æ¿ç±»å‹æ¨å¯¼"><a href="#æ¨¡æ¿ç±»å‹æ¨å¯¼" class="headerlink" title="æ¨¡æ¿ç±»å‹æ¨å¯¼"></a>æ¨¡æ¿ç±»å‹æ¨å¯¼</h1><p>å†™äº†è¿™ä¹ˆä¹…C++éƒ½æ²¡æ€è€ƒè¿‡æ¨¡æ¿æ¨å¯¼çš„ç›¸å…³å†…å®¹ï¼Œè¿™æ¬¡å­¦ä¹ Effective Modern C++è®°å½•ä¸€ä¸‹<br>å·²çŸ¥æ¨¡æ¿å‡½æ•°ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(ParamType param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(expr);                        <span class="comment">//ä½¿ç”¨è¡¨è¾¾å¼è°ƒç”¨f</span></span><br></pre></td></tr></table></figure><br>åœ¨ç¼–è¯‘æœŸé—´ï¼Œç¼–è¯‘å™¨ä½¿ç”¨<code>expr</code>è¿›è¡Œä¸¤ä¸ªç±»å‹æ¨å¯¼ï¼šä¸€ä¸ªæ˜¯é’ˆå¯¹<code>T</code>çš„ï¼Œå¦ä¸€ä¸ªæ˜¯é’ˆå¯¹<code>ParamType</code>çš„ã€‚è¿™ä¸¤ä¸ªç±»å‹é€šå¸¸æ˜¯ä¸åŒçš„ï¼Œå› ä¸º<code>ParamType</code>åŒ…å«ä¸€äº›ä¿®é¥°ï¼Œæ¯”å¦‚<code>const</code>å’Œå¼•ç”¨ä¿®é¥°ç¬¦<br>å¦‚ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp; param)</span></span>;         <span class="comment">//ParamTypeæ˜¯const T&amp;</span></span><br></pre></td></tr></table></figure><br>æ‰€ä»¥æ ¹æ®<code>ParamType</code>çš„ç±»å‹å­˜åœ¨ä¸‰ç§æƒ…å†µï¼š<br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼åˆ†ç±».jpeg" alt=""><br><span id="more"></span></p>
<h2 id="ParamTypeæ˜¯æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼ˆéé€šç”¨å¼•ç”¨ï¼‰"><a href="#ParamTypeæ˜¯æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼ˆéé€šç”¨å¼•ç”¨ï¼‰" class="headerlink" title="ParamTypeæ˜¯æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼ˆéé€šç”¨å¼•ç”¨ï¼‰"></a>ParamTypeæ˜¯æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼ˆéé€šç”¨å¼•ç”¨ï¼‰</h2><p>è§„åˆ™ï¼š</p>
<ol>
<li><strong>å¦‚æœ</strong><code>expr</code><strong>çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¿½ç•¥å¼•ç”¨éƒ¨åˆ†</strong></li>
<li><p>ç„¶å<code>expr</code>çš„ç±»å‹ä¸<code>ParamType</code>è¿›è¡Œæ¨¡å¼åŒ¹é…æ¥å†³å®š<code>T</code></p>
<h3 id="å¼•ç”¨ç±»å‹"><a href="#å¼•ç”¨ç±»å‹" class="headerlink" title="å¼•ç”¨ç±»å‹"></a>å¼•ç”¨ç±»å‹</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span>;               <span class="comment">//paramæ˜¯ä¸€ä¸ªå¼•ç”¨</span></span><br><span class="line"><span class="built_in">f</span>(expr);  </span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œ<code>ParamType</code>æ˜¯<code>T&amp;</code>ä¹Ÿå°±æ˜¯å¼•ç”¨ç±»å‹ï¼Œå¹¶ä¸”paramä¸€å®šæ˜¯ä¸ªå¼•ç”¨ï¼Œä½†æ˜¯å¾—çœ‹æ˜¯const &amp;è¿˜æ˜¯éconst &amp;</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x=<span class="number">27</span>;                       <span class="comment">//xæ˜¯int</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx=x;                 <span class="comment">//cxæ˜¯const int</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; rx=x;                <span class="comment">//rxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);                           <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(cx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(rx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>int x å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;ã€‚è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºæœ¬æ¥å°±æ˜¯T&amp;ï¼Œç”Ÿæˆçš„æ¨¡æ¿å‡½æ•°è‚¯å®šä¹Ÿæ˜¯å¸¦å¼•ç”¨çš„ï¼Œintå°±æ¨å‡ºint</p>
</li>
<li><code>const int cx å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯int&amp;ã€‚è¿™ä¸ªä¹Ÿå¥½ç†è§£å’Œåˆç†ï¼Œå› ä¸ºç”¨æˆ·å‘fä¼ å…¥constå¯¹è±¡æ—¶å°±æ˜¯æƒ³å¯¹è±¡ä¿æŒä¸å¯æ”¹å˜æ€§ï¼Œç¼–è¯‘å™¨è‡ªç„¶ä¹Ÿè¦æ»¡è¶³è¿™ç§éœ€æ±‚ï¼Œæ‰€ä»¥ä¹Ÿå¸¦const</li>
<li><code>const int&amp; rx å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;ã€‚è¿™ä¸ªç¬¦åˆç¬¬ä¸€ç‚¹è¦æ±‚ï¼Œå¼•ç”¨éƒ¨åˆ†è¢«å¿½ç•¥ï¼Œå¿½ç•¥åç»“æœå’Œ2ç›¸åŒ</li>
</ol>
<p>æµ‹è¯•ï¼š<br>åœ¨vs2022ä¸Šå†™ä»£ç ä½¿ç”¨booståº“é‡Œé¢çš„type_id_with_cvrè¿›è¡Œæµ‹è¯•<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::cout;</span><br><span class="line">	<span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºT</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;T =     &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºparamç±»å‹</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;param = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">27</span>;                       <span class="comment">//xæ˜¯int</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> cx = x;                 <span class="comment">//cxæ˜¯const int</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>&amp; rx = x;                <span class="comment">//rxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(x);                           <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;</span></span><br><span class="line">	<span class="built_in">f</span>(cx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line">	<span class="built_in">f</span>(rx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ1.png" alt="1723219601030.png"><br>æ­¤å¤–ï¼Œå¦‚æœParamTypeæ˜¯<code>const T&amp;</code>æ—¶ï¼Œæƒ…å†µä¼šæœ‰ä¸€äº›ä¸åŒï¼Œä½†æ˜¯æƒ…å†µå’Œä¸Šé¢ç±»ä¼¼ï¼Œä¸ç»†è®²<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(<span class="type">const</span> T&amp; param)</span></span>;         <span class="comment">//paramç°åœ¨æ˜¯reference-to-const</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">27</span>;                     <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx = x;               <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; rx = x;              <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);                           <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(cx);                          <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line"><span class="built_in">f</span>(rx);                          <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="æŒ‡é’ˆç±»å‹"><a href="#æŒ‡é’ˆç±»å‹" class="headerlink" title="æŒ‡é’ˆç±»å‹"></a>æŒ‡é’ˆç±»å‹</h3><p>å¼•ç”¨æ˜¯å¦ç±»çš„æŒ‡é’ˆï¼Œç†è§£ä¸Šé¢å¼•ç”¨åï¼ŒæŒ‡é’ˆä¹Ÿå¥½ç†è§£ï¼Œåªè¦æ³¨æ„constä¼šä¿æŒå°±è¡Œ<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T* param)</span></span>;               <span class="comment">//paramç°åœ¨æ˜¯æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> x = <span class="number">27</span>;                     <span class="comment">//åŒä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> *px = &amp;x;             <span class="comment">//pxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(&amp;x);                          <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int*</span></span><br><span class="line"><span class="built_in">f</span>(px);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int*</span></span><br></pre></td></tr></table></figure><br>vs2022 ä¸Šè¿è¡Œç»“æœ<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::cout;</span><br><span class="line">	<span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºT</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;T =     &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºparamç±»å‹</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;param = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">27</span>;                       <span class="comment">//xæ˜¯int</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> cx = x;                 <span class="comment">//cxæ˜¯const int</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>&amp; rx = x;                <span class="comment">//rxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„å¼•ç”¨</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(x);                           <span class="comment">//Tæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;</span></span><br><span class="line">	<span class="built_in">f</span>(cx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line">	<span class="built_in">f</span>(rx);                          <span class="comment">//Tæ˜¯const intï¼Œparamçš„ç±»å‹æ˜¯const int&amp;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ2.png" alt="1723220710506.png"></p>
<h2 id="ParamTypeæ˜¯é€šç”¨å¼•ç”¨"><a href="#ParamTypeæ˜¯é€šç”¨å¼•ç”¨" class="headerlink" title="ParamTypeæ˜¯é€šç”¨å¼•ç”¨"></a>ParamTypeæ˜¯é€šç”¨å¼•ç”¨</h2><p>é€šç”¨å¼•ç”¨æ˜¯universal Referenceç¿»è¯‘è¿‡æ¥çš„ï¼Œä¹Ÿæœ‰å«ä¸‡èƒ½å¼•ç”¨çš„ï¼Œå½¢å¼ä¸Šå’Œå³å€¼å¼•ç”¨ä¸€æ ·ï¼ˆ&amp;&amp;ï¼‰ï¼Œç¬¬ä¸€æ¬¡æ¥è§¦è¿™ç©æ„è¿˜æ˜¯å®ä¹ çš„æ—¶å€™å¸ˆå…„è·Ÿæˆ‘è®²çš„ï¼Œåé¢å°±å›å»äº†è§£äº†ä¸€ä¸‹ã€‚è¿™é‡Œé»˜è®¤å¤§ä¼™å·²ç»äº†è§£å·¦å€¼å³å€¼å“ˆã€‚<br>è§„åˆ™ï¼š</p>
<ol>
<li>å¦‚æœ<code>expr</code>æ˜¯å·¦å€¼ï¼Œ<code>T</code>å’Œ<code>ParamType</code>éƒ½ä¼šè¢«æ¨å¯¼ä¸ºå·¦å€¼å¼•ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯<strong>å³å€¼å¼•ç”¨</strong>ä¹Ÿæ˜¯å·¦å€¼ï¼ˆTå”¯ä¸€ä¸€ç§è¢«æ¨å¯¼ä¸ºå¼•ç”¨çš„æƒ…å†µï¼‰</li>
<li><p>å¦‚æœ<code>expr</code>æ˜¯å³å€¼ï¼Œå°±æœ‰ç‚¹ç±»ä¼¼ä¸Šé¢çš„å†…å®¹ï¼ˆå³å€¼ç‰ˆæ¨å¯¼ï¼‰</p>
<ol>
<li>å¦‚æœ<code>expr</code>çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¿½ç•¥å¼•ç”¨éƒ¨åˆ†</li>
<li>ç„¶å<code>expr</code>çš„ç±»å‹ä¸<code>ParamType</code>è¿›è¡Œæ¨¡å¼åŒ¹é…æ¥å†³å®š<code>T</code><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; param)</span></span>;              <span class="comment">//paramç°åœ¨æ˜¯ä¸€ä¸ªé€šç”¨å¼•ç”¨ç±»å‹</span></span><br><span class="line"><span class="built_in">f</span>(expr)</span><br></pre></td></tr></table></figure>
è¿™é‡ŒParamTypeæ˜¯T&amp;&amp; ï¼Œparamæœ€ç»ˆä¸€å®šæ˜¯ä¸ªå¼•ç”¨ï¼Œä½†æ˜¯å¾—çœ‹æ˜¯å·¦å€¼å¼•ç”¨&amp; è¿˜æ˜¯å³å€¼&amp;&amp;<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x=<span class="number">27</span>;                       <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx=x;                 <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> &amp; rx=cx;              <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);                           <span class="comment">//xæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯int&amp;ï¼Œ</span></span><br><span class="line">                                <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(cx);                          <span class="comment">//cxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯const int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(rx);                          <span class="comment">//rxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯const int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(std::<span class="built_in">move</span>(x));                <span class="comment">// å³å€¼å¼•ç”¨ä¹Ÿæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯int&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(<span class="number">27</span>);                          <span class="comment">//27æ˜¯å³å€¼ï¼Œæ‰€ä»¥Tæ˜¯intï¼Œ</span></span><br><span class="line">                                <span class="comment">//paramç±»å‹å°±æ˜¯int&amp;&amp;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p><code>int x å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯int &amp;ï¼Œparamçš„ç±»å‹æ˜¯int&amp;ã€‚æ¨¡æ¿å‡½æ•°åº”è¯¥æ˜¯è¿™æ ·void f(int&amp; &amp;&amp; param)ï¼Œï¼Œç„¶åé€šè¿‡å¼•ç”¨æŠ˜å å˜æˆvoid(int&amp; param)  </p>
</li>
<li><code>const int cx å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯const int&amp;ï¼Œparamçš„ç±»å‹æ˜¯int&amp;ã€‚åŒä¸Š,ä¸è¿‡åŠ äº†constã€‚</li>
<li><code>const int&amp; rx å’Œ f(x)</code>æ¨å¯¼å‡ºTæ˜¯const int&amp;ï¼Œparamçš„ç±»å‹æ˜¯const int&amp;ã€‚åŒä¸Š</li>
<li><code>27 å’Œ f(27)</code>æ¨å¯¼å‡ºTæ˜¯intï¼Œparamçš„ç±»å‹æ˜¯int&amp;&amp;ã€‚æ¨¡æ¿å‡½æ•°æ˜¯è¿™æ ·void(int&amp;&amp; param)ï¼Œä½¿å¾—få¯ä»¥æ¥å—å³å€¼è¿›è¡Œä¼ å…¥</li>
</ol>
<p>è¯´å®è¯è¿™ä¸ªé€šç”¨å¼•ç”¨è¿˜æŒºå¥‡å¦™ï¼Œæœ€ç»ˆfå¯ä»¥æ¥å—æ‰€æœ‰å€¼è¿›è¡Œä¼ å…¥ã€‚<br>ä»£ç å’Œè¿è¡Œç»“æœ<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp;&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::cout;</span><br><span class="line">	<span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºT</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;T =     &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºparamç±»å‹</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;param = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">27</span>;                       <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> cx = x;                 <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>&amp; rx = cx;              <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(x);                           <span class="comment">//xæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯int&amp;ï¼Œ</span></span><br><span class="line">                                        <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯int&amp;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(cx);                          <span class="comment">//cxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                    <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯const int&amp;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(rx);                          <span class="comment">//rxæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                    <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯const int&amp;</span></span><br><span class="line">	</span><br><span class="line">	<span class="built_in">f</span>(std::<span class="built_in">move</span>(x));                <span class="comment">// å³å€¼å¼•ç”¨ä¹Ÿæ˜¯å·¦å€¼ï¼Œæ‰€ä»¥Tæ˜¯const int&amp;ï¼Œ</span></span><br><span class="line">                                    <span class="comment">//paramç±»å‹ä¹Ÿæ˜¯int&amp;</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(<span class="number">27</span>);                          <span class="comment">//27æ˜¯å³å€¼ï¼Œæ‰€ä»¥Tæ˜¯intï¼Œ</span></span><br><span class="line">                                    <span class="comment">//paramç±»å‹å°±æ˜¯int&amp;&amp;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ3.png" alt="1723258751479.png"></p>
<h2 id="ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨"><a href="#ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨" class="headerlink" title="ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨"></a>ParamTypeæ—¢ä¸æ˜¯æŒ‡é’ˆä¹Ÿä¸æ˜¯å¼•ç”¨</h2><p>å¤§ç™½è¯å€¼ä¼ é€’<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>;                <span class="comment">//ä»¥ä¼ å€¼çš„æ–¹å¼å¤„ç†param</span></span><br><span class="line"><span class="built_in">f</span>(expr)</span><br></pre></td></tr></table></figure><br>è§„åˆ™ï¼š</p>
<ol>
<li>å’Œä¹‹å‰ä¸€æ ·ï¼Œå¦‚æœ<code>expr</code>çš„ç±»å‹æ˜¯ä¸€ä¸ªå¼•ç”¨ï¼Œå¿½ç•¥è¿™ä¸ªå¼•ç”¨éƒ¨åˆ†</li>
<li>å¦‚æœå¿½ç•¥<code>expr</code>çš„å¼•ç”¨æ€§ï¼ˆreference-nessï¼‰ä¹‹åï¼Œ<code>expr</code>æ˜¯ä¸€ä¸ª<code>const</code>ï¼Œé‚£å°±å†å¿½ç•¥<code>const</code>ã€‚å¦‚æœå®ƒæ˜¯<code>volatile</code>ï¼Œä¹Ÿå¿½ç•¥<code>volatile</code><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">27</span>;                       <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> cx = x;                 <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>&amp; rx = cx;              <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span>* px = &amp;x;             <span class="comment">//pxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="type">int</span>* <span class="type">const</span> px1 = &amp;x;             </span><br><span class="line"><span class="type">const</span> <span class="type">int</span>* <span class="type">const</span> px2 = &amp;x;      </span><br><span class="line"></span><br><span class="line"><span class="built_in">f</span>(x);                           <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int</span></span><br><span class="line"><span class="built_in">f</span>(cx);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int</span></span><br><span class="line"><span class="built_in">f</span>(&amp;x);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int*</span></span><br><span class="line"><span class="built_in">f</span>(px);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯cosnt int*</span></span><br><span class="line"><span class="built_in">f</span>(px1);                         <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯ int*</span></span><br><span class="line"><span class="built_in">f</span>(px2);                         <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯cosnt int*</span></span><br></pre></td></tr></table></figure>
æŒ‡é’ˆå¯èƒ½æœ‰äº›ä¸ä¸€æ ·ï¼Œconst <em>æŒ‡é’ˆä¼ è¿›å»ï¼Œæ¨å¯¼å‡ºæ¥è¿˜æ˜¯const </em>ï¼Œä½†æ˜¯ *constä¼ è¿›å»constç‰¹æ€§ä¼šè¢«å¿½ç•¥ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡é’ˆæ˜¯å¯ä»¥æ›´æ”¹æŒ‡å‘çš„ã€‚<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::cout;</span><br><span class="line">	<span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºT</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;T =     &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºparamç±»å‹</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;param = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> x = <span class="number">27</span>;                       <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span> cx = x;                 <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>&amp; rx = cx;              <span class="comment">//å¦‚ä¹‹å‰ä¸€æ ·</span></span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>* px = &amp;x;             <span class="comment">//pxæ˜¯æŒ‡å‘ä½œä¸ºconst intçš„xçš„æŒ‡é’ˆ</span></span><br><span class="line">	<span class="type">int</span>* <span class="type">const</span> px1 = &amp;x;             </span><br><span class="line">	<span class="type">const</span> <span class="type">int</span>* <span class="type">const</span> px2 = &amp;x;      </span><br><span class="line"></span><br><span class="line">	<span class="built_in">f</span>(x);                           <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int</span></span><br><span class="line">	<span class="built_in">f</span>(cx);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int</span></span><br><span class="line">	<span class="built_in">f</span>(&amp;x);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯int*</span></span><br><span class="line">	<span class="built_in">f</span>(px);                          <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯cosnt int*</span></span><br><span class="line">	<span class="built_in">f</span>(px1);                         <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯ int*</span></span><br><span class="line">	<span class="built_in">f</span>(px2);                         <span class="comment">//Tå’Œparamçš„ç±»å‹éƒ½æ˜¯cosnt int*</span></span><br><span class="line">&#125;	</span><br></pre></td></tr></table></figure>
<img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ4.png" alt="1723264877921.png"><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2>å­˜åœ¨ä¸€äº›ç‰¹åˆ—ï¼Œè®°å½•ä¸€ä¸‹<h3 id="æ•°ç»„å®å‚"><a href="#æ•°ç»„å®å‚" class="headerlink" title="æ•°ç»„å®å‚"></a>æ•°ç»„å®å‚</h3>ä¸€èˆ¬æ¥è¯´ï¼Œæ•°ç»„ä¼ å‚æ—¶æ˜¯é€€åŒ–ä¸ºæŒ‡é’ˆï¼Œæ¨å¯¼çš„æ—¶å€™ä¹Ÿåº”è¯¥å½±å“ä¸å¤§<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T param)</span></span>;                <span class="comment">//ä»¥ä¼ å€¼çš„æ–¹å¼å¤„ç†param</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>;     <span class="comment">//nameçš„ç±»å‹æ˜¯const char[13]</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ptrToName = name;          <span class="comment">//æ•°ç»„é€€åŒ–ä¸ºæŒ‡é’ˆ</span></span><br><span class="line"><span class="built_in">f</span>(name);								<span class="comment">//nameæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯Tè¢«æ¨å¯¼ä¸ºconst char*</span></span><br><span class="line"><span class="built_in">f</span>(ptrToName);</span><br></pre></td></tr></table></figure>
<img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ5.png" alt="1723267302280.png"><br>ä½†æ˜¯åœ¨ParamTypeä½œä¸ºå¼•ç”¨æ—¶ï¼Œå°±å¯ä»¥æœ‰æŒ‡å‘æ•°ç»„çš„å¼•ç”¨äº†ï¼Œå¹¶ä¸”å¯ä»¥è·å¾—æ•°ç»„çš„å¤§å°<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span>;                       <span class="comment">//ä¼ å¼•ç”¨å½¢å‚çš„æ¨¡æ¿</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>;     <span class="comment">//nameçš„ç±»å‹æ˜¯const char[13]</span></span><br><span class="line"><span class="built_in">f</span>(name);                        <span class="comment">//nameæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½†æ˜¯Tè¢«æ¨å¯¼ä¸ºconst char (&amp;)[13]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/type_index.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°æ¨¡æ¿</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f</span><span class="params">(T&amp; param)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> std::cout;</span><br><span class="line">	<span class="keyword">using</span> boost::typeindex::type_id_with_cvr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºT</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;T =     &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;T&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//æ˜¾ç¤ºparamç±»å‹</span></span><br><span class="line">	cout &lt;&lt; <span class="string">&quot;param = &quot;</span></span><br><span class="line">		&lt;&lt; <span class="built_in">type_id_with_cvr</span>&lt;<span class="keyword">decltype</span>(param)&gt;().<span class="built_in">pretty_name</span>()</span><br><span class="line">		&lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> name[] = <span class="string">&quot;J. P. Briggs&quot;</span>;     <span class="comment">//nameçš„ç±»å‹æ˜¯const char[13]</span></span><br><span class="line">	<span class="built_in">f</span>(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ¨¡æ¿ç±»å‹æ¨å¯¼è¿è¡Œç»“æœ6.png" alt="1723297363366.png"><br>åº”ç”¨ï¼š<br>ç¼–è¯‘å™¨å°±å¯ä»¥è·å¾—æ•°ç»„å¤§å°ï¼Œä¸è¿‡sizeofå¥½åƒä¹Ÿå¯ä»¥<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åœ¨ç¼–è¯‘æœŸé—´è¿”å›ä¸€ä¸ªæ•°ç»„å¤§å°çš„å¸¸é‡å€¼ï¼ˆ//æ•°ç»„å½¢å‚æ²¡æœ‰åå­—ï¼Œ</span></span><br><span class="line"><span class="comment">//å› ä¸ºæˆ‘ä»¬åªå…³å¿ƒæ•°ç»„çš„å¤§å°ï¼‰</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T, std::<span class="type">size_t</span> N&gt;                     <span class="comment">//å…³äº</span></span><br><span class="line"><span class="function"><span class="keyword">constexpr</span> std::<span class="type">size_t</span> <span class="title">arraySize</span><span class="params">(T (&amp;)[N])</span> <span class="keyword">noexcept</span>      <span class="comment">//constexpr</span></span></span><br><span class="line"><span class="function"></span>&#123;                                                       <span class="comment">//å’Œnoexcept</span></span><br><span class="line">    <span class="keyword">return</span> N;                                           <span class="comment">//çš„ä¿¡æ¯</span></span><br><span class="line">&#125;                                                       <span class="comment">//è¯·çœ‹ä¸‹é¢</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> keyVals[] = &#123; <span class="number">1</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">22</span>, <span class="number">35</span> &#125;;             <span class="comment">//keyValsæœ‰ä¸ƒä¸ªå…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> mappedVals[<span class="built_in">arraySize</span>(keyVals)];                     <span class="comment">//mappedValsä¹Ÿæœ‰ä¸ƒä¸ª</span></span><br></pre></td></tr></table></figure>
<h3 id="å‡½æ•°å®å‚"><a href="#å‡½æ•°å®å‚" class="headerlink" title="å‡½æ•°å®å‚"></a>å‡½æ•°å®å‚</h3>å‡½æ•°å’Œæ•°ç»„ç±»ä¼¼ï¼Œéƒ½ä¼šé€€åŒ–ä¸ºæŒ‡é’ˆ<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">someFunc</span><span class="params">(<span class="type">int</span>, <span class="type">double</span>)</span></span>;         <span class="comment">//someFuncæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ</span></span><br><span class="line">                                    <span class="comment">//ç±»å‹æ˜¯void(int, double)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">(T param)</span></span>;                   <span class="comment">//ä¼ å€¼ç»™f1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f2</span><span class="params">(T &amp; param)</span></span>;                 <span class="comment">//ä¼ å¼•ç”¨ç»™f2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">f1</span>(someFunc);                       <span class="comment">//paramè¢«æ¨å¯¼ä¸ºæŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆï¼Œ</span></span><br><span class="line">                                    <span class="comment">//ç±»å‹æ˜¯void(*)(int, double)</span></span><br><span class="line"><span class="built_in">f2</span>(someFunc);                       <span class="comment">//paramè¢«æ¨å¯¼ä¸ºæŒ‡å‘å‡½æ•°çš„å¼•ç”¨ï¼Œ</span></span><br><span class="line">                                    <span class="comment">//ç±»å‹æ˜¯void(&amp;)(int, double)</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>Linuxå®šæ—¶å™¨</title>
    <url>/2022/08/29/Linux/Linux%E5%AE%9A%E6%97%B6%E5%99%A8/</url>
    <content><![CDATA[<h1 id="Linuxå®šæ—¶å™¨"><a href="#Linuxå®šæ—¶å™¨" class="headerlink" title="Linuxå®šæ—¶å™¨"></a>Linuxå®šæ—¶å™¨</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬åä¸€ç« å®šæ—¶å™¨ï¼Œé‡Œé¢ä»‹ç»äº†å„ç§ç½‘ç»œç¨‹åºä¸­çš„å®šæ—¶äº‹ä»¶ï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­SIGALRMä¿¡å·è§¦å‘çš„å®šæ—¶å™¨ã€‚</p>
<span id="more"></span>
<h2 id="SIGALRMä¿¡å·"><a href="#SIGALRMä¿¡å·" class="headerlink" title="SIGALRMä¿¡å·"></a>SIGALRMä¿¡å·</h2><p>ç”±äº<code>alarm</code>å’Œ<code>setitimer</code>å‡½æ•°è®¾ç½®çš„å®æ—¶é—¹é’Ÿä¸€æ—¦è¶…æ—¶ï¼Œå°†è§¦å‘<code>SIGALRM</code>ä¿¡å·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¯¥ä¿¡å·çš„ä¿¡å·å¤„ç†å‡½æ•°æ¥å¤„ç†å®šæ—¶ä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¦å¤„ç†å¤šä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸æ–­åœ°è§¦å‘<code>SIGALRM</code>ä¿¡å·ï¼Œå¹¶åœ¨å…¶ä¿¡å·å¤„ç†å‡½æ•°ä¸­æ‰§è¡Œåˆ°æœŸçš„ä»»åŠ¡ã€‚</p>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œ<code>SIGALRM</code>ä¿¡å·æŒ‰ç…§å›ºå®šçš„é¢‘ç‡ç”Ÿæˆï¼Œå³ç”±<code>alarm</code>æˆ–<code>setitimer</code>å‡½æ•°è®¾ç½®çš„å®šæ—¶å‘¨æœŸ<code>T</code>ä¿æŒä¸å˜ã€‚å¦‚æœæŸä¸ªå®šæ—¶ä»»åŠ¡çš„è¶…æ—¶æ—¶é—´ä¸æ˜¯<code>T</code>çš„æ•´æ•°å€ï¼Œé‚£ä¹ˆå®ƒå®é™…è¢«æ‰§è¡Œçš„æ—¶é—´å’Œé¢„æœŸçš„æ—¶é—´å°†ç•¥æœ‰åå·®ã€‚å› æ­¤å®šæ—¶å‘¨æœŸ<code>T</code>åæ˜ äº†å®šæ—¶çš„ç²¾åº¦ã€‚</p>
<h3 id="alarmå‡½æ•°"><a href="#alarmå‡½æ•°" class="headerlink" title="alarmå‡½æ•°"></a>alarmå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span>;</span><br></pre></td></tr></table></figure>
<p><code>alarm</code>å®šæ—¶å‘é€ <code>SIGALRM</code>ç»™å½“å‰è¿›ç¨‹ï¼ˆéœ€è¦æ³¨æ„çš„æ˜¯<code>alarm</code>è°ƒç”¨åªä¼šå¼•èµ·ä¸€æ¬¡è°ƒç”¨ï¼‰ã€‚</p>
<p><code>seconds</code>å‚æ•°è¡¨ç¤ºç»è¿‡<code>seconds</code>ç§’æ•°åå‘é€<code>SIGALRM</code>ç»™ç›®å‰çš„è¿›ç¨‹</p>
<p><code>alarm</code>è¿”å›ä¸Šæ¬¡å®šæ—¶å‰©ä½™æ—¶é—´ã€‚</p>
<p>å¦‚æœè®¾ç½®<code>alarm(0)</code>åˆ™è¡¨ç¤ºå–æ¶ˆé—¹é’Ÿ</p>
<p>æˆ‘ä»¬ä¸¾ä¸ªå°ä¾‹å­ï¼Œç»“åˆå‰é¢çš„ä¿¡å·ä¸€èµ·å†™ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_alarm</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    alarm(<span class="number">3</span>);                   <span class="comment">// 3ç§’åå‘é€ä¿¡å·</span></span><br><span class="line">    signal(SIGALRM, sig_alarm); <span class="comment">//è®¾ç½®ä¿¡å·å¯¹åº”çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;------------------\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220829204127701.png" alt="image-20220829204127701"></p>
<h3 id="setitimerå‡½æ•°"><a href="#setitimerå‡½æ•°" class="headerlink" title="setitimerå‡½æ•°"></a>setitimerå‡½æ•°</h3><p><code>setitimer</code>ç›¸æ¯”<code>alarm</code>ï¼Œæä¾›äº†æ›´ä¸ºç²¾ç»†çš„å‚æ•°é€‰æ‹©</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getitimer</span><span class="params">(<span class="type">int</span> which, <span class="keyword">struct</span> itimerval *curr_value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setitimer</span><span class="params">(<span class="type">int</span> which, <span class="type">const</span> <span class="keyword">struct</span> itimerval *new_value, <span class="keyword">struct</span> itimerval *old_value)</span>;</span><br></pre></td></tr></table></figure>
<p><code>which</code>æŒ‡è®¡æ—¶å™¨é‡‡ç”¨é‚£ç§ç±»å‹çš„è®¡æ—¶æ–¹æ³•</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ä»‹ç»</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ITIMER_REAL</code></td>
<td>ä»¥ç³»ç»ŸçœŸå®çš„æ—¶é—´æ¥è®¡ç®—ï¼Œå®ƒé€å‡º<code>SIGALRM</code>ä¿¡å·ã€‚</td>
</tr>
<tr>
<td><code>ITIMER_VIRTUAL</code></td>
<td>ä»¥è¯¥è¿›ç¨‹ç”¨æˆ·ç©ºé—´ä¸‹èŠ±è´¹çš„æ—¶é—´æ¥è®¡ç®—ï¼Œå®ƒé€å‡º<code>SIGVTALRM</code>ä¿¡å·ã€‚</td>
</tr>
<tr>
<td><code>ITIMER_PROF</code></td>
<td>ä»¥è¯¥è¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´ä¸‹å’Œå†…æ ¸ä¸‹æ‰€è´¹çš„æ—¶é—´æ¥è®¡ç®—ï¼Œå®ƒé€å‡º<code>SIGPROF</code>ä¿¡å·ã€‚</td>
</tr>
</tbody>
</table>
</div>
<p><code>new_value</code>å’Œ<code>old_value</code>éƒ½æ˜¯<code>itimerval</code>ç±»å‹çš„ç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">it_interval</span>;</span> <span class="comment">/* Interval for periodic timer */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">it_value</span>;</span>    <span class="comment">/* Time until next expiration */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">   <span class="type">time_t</span>      tv_sec;         <span class="comment">/* seconds */</span></span><br><span class="line">   <span class="type">suseconds_t</span> tv_usec;        <span class="comment">/* microseconds */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>timeval</code>ç»“æ„ä½“ä¸­æˆå‘˜å¾ˆç®€å•ï¼Œ<code>tv_sec</code>è®¾ç½®ç§’ï¼Œ<code>tv_usec</code>è®¾ç½®å¾®å¦™ã€‚</p>
<p><code>itimerval</code>ç»“æ„ä½“ä¸­æˆå‘˜<code>it_interval</code>ä¸ºè®¡æ—¶é—´éš”ï¼Œ<code>it_value</code>ä¸ºå»¶æ—¶æ—¶é•¿ã€‚æ¯”å¦‚ï¼šæˆ‘æƒ³3såï¼Œä»¥æ¯æ¬¡5sçš„æ—¶é—´é—´éš”æ‰“å°hello worldï¼Œé‚£ä¹ˆå°±éœ€è¦è®¾ç½®<code>it_value</code>ä¸º3sï¼Œè®¾ç½®<code>it_interval</code>ä¸º5sï¼ˆ3såç¬¬ä¸€æ¬¡æ‰“å°ï¼Œæ­¤åæ¯æ¬¡ä»¥5sä¸ºé—´éš”æ‰“å°ï¼‰ã€‚</p>
<p>å…¶ä¸­çš„<code>new_value</code>å‚æ•°ç”¨æ¥å¯¹è®¡æ—¶å™¨è¿›è¡Œè®¾ç½®ã€‚</p>
<p><code>old_value</code>å‚æ•°ï¼Œé€šå¸¸ç”¨ä¸ä¸Šï¼Œè®¾ç½®ä¸ºNULLï¼Œå®ƒæ˜¯ç”¨æ¥å­˜å‚¨ä¸Šä¸€æ¬¡<code>setitimer</code>è°ƒç”¨æ—¶è®¾ç½®çš„new_valueå€¼ã€‚</p>
<p>å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1ï¼Œå¹¶ä¸”è®¾ç½®<code>errno</code>ã€‚</p>
<p><strong>å‡å¦‚it_valueä¸º0æ˜¯ä¸ä¼šè§¦å‘ä¿¡å·çš„ï¼Œæ‰€ä»¥è¦èƒ½è§¦å‘ä¿¡å·ï¼Œit_valueå¾—å¤§äº0ï¼›å¦‚æœit_intervalä¸º0ï¼Œåªä¼šå»¶æ—¶ï¼Œä¸ä¼šå®šæ—¶ï¼ˆä¹Ÿå°±æ˜¯è¯´åªä¼šè§¦å‘ä¸€æ¬¡ä¿¡å·)ã€‚</strong></p>
<p>ä¸‹é¢å°±å†™ä¸€ä¸ªå»¶æ—¶3såï¼Œä»¥5sä¸ºé—´éš”æ‰“å°hello world</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_alarm</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> <span class="title">it</span>, <span class="title">oldit</span>;</span></span><br><span class="line"></span><br><span class="line">    signal(SIGALRM, sig_alarm); <span class="comment">//æ³¨å†ŒSIGALRMä¿¡å·çš„æ•æ‰å¤„ç†å‡½æ•°ã€‚</span></span><br><span class="line"></span><br><span class="line">    it.it_value.tv_sec = <span class="number">3</span>; <span class="comment">//è®¾ç½®å»¶æ—¶3s</span></span><br><span class="line">    it.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    it.it_interval.tv_sec = <span class="number">5</span>; <span class="comment">//è®¾ç½®æ—¶é—´é—´éš”5s</span></span><br><span class="line">    it.it_interval.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setitimer(ITIMER_REAL, &amp;it, &amp;oldit) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;setitimer error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;------------------\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220829212215274.png" alt="image-20220829212215274"></p>
<h2 id="socketé€‰é¡¹SO-RCVTIMEOå’ŒSO-SNDTIMEO"><a href="#socketé€‰é¡¹SO-RCVTIMEOå’ŒSO-SNDTIMEO" class="headerlink" title="socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEO"></a>socketé€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEO</h2><p><code>socket</code>é€‰é¡¹<code>SO_RCVTIMEO</code>å’Œ<code>SO_SNDTIMEO</code>ï¼Œå®ƒä»¬åˆ†åˆ«ç”¨æ¥è®¾ç½®<code>socket</code>æ¥æ”¶æ•°æ®è¶…æ—¶æ—¶é—´å’Œå‘é€æ•°æ®è¶…æ—¶æ—¶é—´ã€‚å› æ­¤ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹ä»…å¯¹ä¸æ•°æ®æ¥æ”¶å’Œå‘é€ç›¸å…³çš„<code>socket</code>ä¸“ç”¨ç³»ç»Ÿè°ƒç”¨( socketä¸“ç”¨çš„ç³»ç»Ÿè°ƒç”¨æŒ‡çš„æ˜¯5.2ï½5.11èŠ‚ä»‹ç»çš„é‚£äº›socketAPI)æœ‰æ•ˆï¼Œè¿™äº›ç³»ç»Ÿè°ƒç”¨åŒ…æ‹¬<code>send</code>ã€<code>sendmsg</code>ã€<code>recv</code>ã€<code>recvmsg</code>ã€<code>accept</code>å’Œ <code>connect</code>ã€‚å°†é€‰é¡¹SO_RCVTIMEOå’ŒSO_SNDTIMEOå¯¹è¿™äº›ç³»ç»Ÿè°ƒç”¨çš„å½±å“æ€»ç»“äºè¡¨ä¸­ï¼ˆæ¥æºLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220830110132529.png" alt="image-20220830110132529"></p>
<p>è¿™é‡Œä¸¾ä¹¦ä¸Šçš„ä»£ç ä¾‹å­ï¼Œæ¯”è¾ƒç®€å• æ˜äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">timeout_connect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">int</span> port, <span class="type">int</span> time)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sockfd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sockfd &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    timeout.tv_sec = time;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(timeout);</span><br><span class="line">    ret = setsockopt(sockfd, SOL_SOCKET, SO_SNDTIMEO, &amp;timeout, len);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;connecting timeout\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error occur when connecting to server\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sockfd = timeout_connect(ip, port, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxç³»ç»Ÿæ—¥å¿—rsyslogd</title>
    <url>/2022/08/21/Linux/Linux%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97rsyslogd/</url>
    <content><![CDATA[<h1 id="Linuxç³»ç»Ÿæ—¥å¿—rsyslogd"><a href="#Linuxç³»ç»Ÿæ—¥å¿—rsyslogd" class="headerlink" title="Linuxç³»ç»Ÿæ—¥å¿—rsyslogd"></a>Linuxç³»ç»Ÿæ—¥å¿—rsyslogd</h1><h3 id="Linuxç³»ç»Ÿæ—¥å¿—"><a href="#Linuxç³»ç»Ÿæ—¥å¿—" class="headerlink" title="Linuxç³»ç»Ÿæ—¥å¿—"></a>Linuxç³»ç»Ÿæ—¥å¿—</h3><p>Linuxä¸Šä½¿ç”¨<code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹æ¥æ”¶<strong>ç”¨æˆ·è¿›ç¨‹</strong>è¾“å‡ºçš„æ—¥å¿—å’Œæ¥æ”¶<strong>å†…æ ¸</strong>æ—¥å¿—ã€‚</p>
<p>ç”¨æˆ·è¿›ç¨‹æ˜¯é€šè¿‡<code>syslogd</code>å‡½æ•°ç”Ÿæˆç³»ç»Ÿæ—¥å¿—ã€‚è¯¥å‡½æ•°å°†æ—¥å¿—è¾“å‡ºåˆ°ä¸€ä¸ªUNIXæœ¬åœ°åŸŸsocketç±»å‹(AF_UNIXï¼‰çš„æ–‡ä»¶<code>/dev/log</code>ä¸­ï¼Œ<code>rsyslogd</code>åˆ™ç›‘å¬è¯¥æ–‡ä»¶ä»¥è·å–ç”¨æˆ·è¿›ç¨‹çš„è¾“å‡ºã€‚</p>
<p>å†…æ ¸æ—¥å¿—æ˜¯å¦‚ä½•è¿›è¡Œç®¡ç†çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸è¿›è¡Œå…³ç³»ã€‚</p>
<p><code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹åœ¨æ¥æ”¶åˆ°<strong>ç”¨æˆ·è¿›ç¨‹</strong>æˆ–<strong>å†…æ ¸è¾“å…¥</strong>çš„æ—¥å¿—åï¼Œä¼šæŠŠå®ƒä»¬è¾“å‡ºè‡³æŸäº›ç‰¹å®šçš„æ—¥å¿—æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè°ƒè¯•ä¿¡æ¯ä¼šä¿å­˜è‡³<code>/var/log/debug</code>æ–‡ä»¶ï¼Œæ™®é€šä¿¡æ¯ä¿å­˜è‡³<code>/var/log/messages</code>æ–‡ä»¶ï¼Œå†…æ ¸æ¶ˆæ¯åˆ™ä¿å­˜è‡³<code>/var/log/kern.log</code>æ–‡ä»¶ã€‚</p>
<p>ä¸è¿‡ï¼Œæ—¥å¿—ä¿¡æ¯å…·ä½“å¦‚ä½•åˆ†å‘ï¼Œå¯ä»¥åœ¨<code>rsyslogd</code>çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ã€‚<code>rsyslogd</code>çš„ä¸»é…ç½®æ–‡ä»¶æ˜¯<code>/etc/rsyslog.conf</code>ï¼Œå…¶ä¸­ä¸»è¦å¯ä»¥è®¾ç½®çš„é¡¹åŒ…æ‹¬:å†…æ ¸æ—¥å¿—è¾“å…¥è·¯å¾„ï¼Œæ˜¯å¦æ¥æ”¶UDPæ—¥å¿—åŠå…¶ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤æ˜¯514ï¼Œè§<code>/etc/services</code>æ–‡ä»¶)ï¼Œæ˜¯å¦æ¥æ”¶TCPæ—¥å¿—åŠå…¶ç›‘å¬ç«¯å£ï¼Œæ—¥å¿—æ–‡ä»¶çš„æƒé™ï¼ŒåŒ…å«å“ªäº›å­é…ç½®æ–‡ä»¶(æ¯”å¦‚ <code>/etc/rsyslog.d/*.conf</code>)ã€‚<code>rsyslogd</code>çš„å­é…ç½®æ–‡ä»¶åˆ™æŒ‡å®šå„ç±»æ—¥å¿—çš„ç›®æ ‡å­˜å‚¨æ–‡ä»¶ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818105707879.png" alt="image-20220818105707879"></p>
<span id="more"></span>
<p><code>rsyslogd</code>ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½æ¯”è¾ƒå¤æ‚ï¼Œæœ‰facilityã€priorityã€actionç­‰æ¦‚å¿µã€‚è¿˜æœ‰Inputæ¨¡å—ã€Filetræ¨¡å—ã€Outputæ¨¡å—ç­‰æ¨¡å—å†…å®¹ï¼Œç›®å‰è¿˜æœªå¼„æ¸…æ¥šç›¸å…³çš„çŸ¥è¯†ã€‚</p>
<p>æŸ¥çœ‹äº†ä¸€ä¸‹<code>/etc/rsyslog.conf</code>çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/rsyslog.conf configuration file <span class="keyword">for</span> rsyslog</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># For more information install rsyslog-doc and see</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/usr/share/doc/rsyslog-doc/html/configuration/index.html</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Default logging rules can be found in /etc/rsyslog.d/50-default.conf</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### MODULES ####</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"></span><br><span class="line">module(load=&quot;imuxsock&quot;) # provides support for local system logging</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;immark&quot;</span>)  <span class="comment"># provides --MARK-- message capability</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides UDP syslog reception</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;imudp&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">input(<span class="built_in">type</span>=<span class="string">&quot;imudp&quot;</span> port=<span class="string">&quot;514&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides TCP syslog reception</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;imtcp&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">input(<span class="built_in">type</span>=<span class="string">&quot;imtcp&quot;</span> port=<span class="string">&quot;514&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides kernel logging support and <span class="built_in">enable</span> non-kernel klog messages</span></span><br><span class="line">module(load=&quot;imklog&quot; permitnonkernelfacility=&quot;on&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### GLOBAL DIRECTIVES ####</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use traditional timestamp format.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To <span class="built_in">enable</span> high precision timestamps, comment out the following line.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$ActionFileDefaultTemplate</span> RSYSLOG_TraditionalFileFormat</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Filter duplicated messages</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">RepeatedMsgReduction on</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Set the default permissions for all log files.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$FileOwner</span> syslog</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">FileGroup adm</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">FileCreateMode 0640</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">DirCreateMode 0755</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">Umask 0022</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">PrivDropToUser syslog</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">PrivDropToGroup syslog</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Where to place spool and state files</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$WorkDirectory</span> /var/spool/rsyslog</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Include all config files in /etc/rsyslog.d/</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$IncludeConfig</span> /etc/rsyslog.d/*.conf</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¨¡å—<code>module(load=&quot;imuxsock&quot;)</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å…¥æ¨¡å—</p>
<p>ç„¶åçœ‹åˆ°é»˜è®¤è§„åˆ™åœ¨<code>/etc/rsyslog.d/50-default.conf</code>ï¼ŒæŸ¥çœ‹ä¸€ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> Default rules <span class="keyword">for</span> rsyslog.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#                       For more information see rsyslog.conf(5) and /etc/rsyslog.conf</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># First some standard log files.  Log by facility.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">auth,authpriv.*                 /var/log/auth.log</span></span><br><span class="line">*.*;auth,authpriv.none          -/var/log/syslog</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cron.*                         /var/log/cron.log</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">daemon.*                       -/var/log/daemon.log</span></span><br><span class="line">kern.*                          -/var/log/kern.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">lpr.*                          -/var/log/lpr.log</span></span><br><span class="line">mail.*                          -/var/log/mail.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user.*                         -/var/log/user.log</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Logging for the mail system.  Split it up so that</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it is easy to write scripts to parse these files.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#mail.info                      -/var/log/mail.info</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mail.warn                      -/var/log/mail.warn</span></span><br><span class="line">mail.err                        /var/log/mail.err</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Some &quot;catch-all&quot; log files.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*.=debug;\</span></span><br><span class="line"><span class="language-bash"><span class="comment">#       auth,authpriv.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       news.none;mail.none     -/var/log/debug</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*.=info;*.=notice;*.=warn;\</span></span><br><span class="line"><span class="language-bash"><span class="comment">#       auth,authpriv.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       cron,daemon.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       mail,news.none          -/var/log/messages</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Emergencies are sent to everybody logged in.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">*.emerg                         :omusrmsg:*</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># I like to have messages displayed on the console, but only on a virtual</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">console I usually leave idle.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#daemon,mail.*;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       news.=crit;news.=err;news.=notice;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       *.=debug;*.=info;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       *.=notice;*.=warn       /dev/tty8</span></span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>auth</code>è¿™ç§å°±æ˜¯facilityï¼ˆè®¾æ–½ï¼‰ï¼Œ<code>mail.err</code>è¿™ç§å°±æ˜¯priorityï¼ˆç­‰çº§ï¼‰ï¼Œè€Œè¿™ç§è®¾ç½®æ—¥å¿—è®°å½•çš„ä½ç½®å°±æ˜¯action</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.*;auth,authpriv.none          -/var/log/syslog</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢è¿™ä¸€ä¸ªactionå¯ä»¥çœ‹å‡ºæ™®é€šçš„æ—¥å¿—ï¼ˆ<code>&quot;.&quot;</code>ï¼‰ï¼Œè®¾ç½®æ—¥å¿—è®°å½•ä½ç½®æ˜¯<code>/var/log/syslog</code>ï¼Œå‰é¢<code>-</code>è¡¨ç¤ºå¼‚æ­¥å†™å…¥</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>logger</code>å‘½ä»¤æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">logger -i -t <span class="string">&quot;my_test&quot;</span> <span class="string">&quot;test_log&quot;</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨vimæŸ¥çœ‹<code>/var/log/syslog</code>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„<code>logger</code>çš„ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818172612033.png" alt="image-20220818172612033"></p>
<p><code>rsyslogd</code>çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œåç»­å†è¡¥ã€‚</p>
<h3 id="syslogå‡½æ•°"><a href="#syslogå‡½æ•°" class="headerlink" title="syslogå‡½æ•°"></a>syslogå‡½æ•°</h3><p>åº”ç”¨ç¨‹åºä½¿ç”¨<code>syslog</code>å‡½æ•°å’Œ<code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šè®¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">openlog</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ident, <span class="type">int</span> option, <span class="type">int</span> facility)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">closelog</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p><code>openlog</code>ç”¨äºæ”¹å˜<code>syslog</code>é»˜è®¤çš„è¾“å‡ºæ–¹å¼ï¼Œè¿›è¡Œæ—¥å¿—ç»“æ„åŒ–</p>
<p><code>ident</code>å‚æ•°æŒ‡å®šçš„å­—ç¬¦ä¸²å°†è¢«æ·»åŠ åˆ°æ—¥å¿—æ¶ˆæ¯çš„æ—¥æœŸå’Œæ—¶é—´ä¹‹åï¼Œå®ƒé€šå¸¸è¢«è®¾ç½®ä¸ºç¨‹åºçš„åå­—ã€‚</p>
<p><code>option</code>å‚æ•°å¯¹åç»­<code>syslog</code>è°ƒç”¨çš„è¡Œä¸ºè¿›è¡Œé…ç½®ï¼Œå®ƒå¯å–ä¸‹åˆ—çš„å€¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_PID		0x01	<span class="comment">/* log the pid with each message */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CONS	0x02	<span class="comment">/* log on the console if errors in sending */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ODELAY	0x04	<span class="comment">/* delay open until first syslog() (default) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NDELAY	0x08	<span class="comment">/* don&#x27;t delay open */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NOWAIT	0x10	<span class="comment">/* don&#x27;t wait for console forks: DEPRECATED */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_PERROR	0x20	<span class="comment">/* log to stderr as well */</span></span></span><br></pre></td></tr></table></figure>
<p><code>facility</code>å‚æ•°å¯ä»¥ä¿®æ”¹<code>syslog</code>å‡½æ•°ä¸­çš„é»˜è®¤è®¾æ–½å€¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* facility codes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_KERN	(0&lt;&lt;3)	<span class="comment">/* kernel messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_USER	(1&lt;&lt;3)	<span class="comment">/* random user-level messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_MAIL	(2&lt;&lt;3)	<span class="comment">/* mail system */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_DAEMON	(3&lt;&lt;3)	<span class="comment">/* system daemons */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_AUTH	(4&lt;&lt;3)	<span class="comment">/* security/authorization messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_SYSLOG	(5&lt;&lt;3)	<span class="comment">/* messages generated internally by syslogd */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LPR		(6&lt;&lt;3)	<span class="comment">/* line printer subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NEWS	(7&lt;&lt;3)	<span class="comment">/* network news subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_UUCP	(8&lt;&lt;3)	<span class="comment">/* UUCP subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CRON	(9&lt;&lt;3)	<span class="comment">/* clock daemon */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_AUTHPRIV	(10&lt;&lt;3)	<span class="comment">/* security/authorization messages (private) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_FTP		(11&lt;&lt;3)	<span class="comment">/* ftp daemon */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* other codes through 15 reserved for system use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL0	(16&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL1	(17&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL2	(18&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL3	(19&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL4	(20&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL5	(21&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL6	(22&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL7	(23&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br></pre></td></tr></table></figure>
<p><code>syslog</code>ç”¨äºè¾“å‡ºæ—¥å¿—ã€‚</p>
<p><code>priority</code>å‚æ•°æ˜¯<strong>è®¾æ–½å€¼å’Œæ—¥å¿—çº§åˆ«</strong>çš„æŒ‰ä½ä¸ï¼Œé»˜è®¤æ˜¯<code>LOG_USER</code>ã€‚æ—¥å¿—çº§åˆ«æœ‰ä¸‹é¢å‡ ä¸ª</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_EMERG	0	<span class="comment">/* system is unusable */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ALERT	1	<span class="comment">/* action must be taken immediately */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CRIT	2	<span class="comment">/* critical conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ERR		3	<span class="comment">/* error conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_WARNING	4	<span class="comment">/* warning conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NOTICE	5	<span class="comment">/* normal but significant condition */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_INFO	6	<span class="comment">/* informational */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_DEBUG	7	<span class="comment">/* debug-level messages */</span></span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå‚æ•°<code>message</code>å’Œç¬¬ä¸‰ä¸ªå‚æ•°<code>...</code>æ¥ç»“æ„åŒ–è¾“å‡ºã€‚</p>
<p><code>closelog</code>ç”¨äºå…³é—­æ—¥å¿—</p>
<p>å°ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    openlog(argv[<span class="number">0</span>], LOG_CONS | LOG_PID, LOG_USER);</span><br><span class="line">    syslog(LOG_DEBUG, <span class="string">&quot;This is a syslog test message generated by program &#x27;%s&#x27;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    closelog();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818183131617.png" alt="image-20220818183131617"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxç½‘ç»œä¸­å°çŸ¥è¯†ç‚¹</title>
    <url>/2022/08/05/Linux/Linux%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%B0%8F%E7%9F%A5%E8%AF%86%E7%82%B9/</url>
    <content><![CDATA[<h1 id="Linuxç½‘ç»œä¸­å°çŸ¥è¯†ç‚¹"><a href="#Linuxç½‘ç»œä¸­å°çŸ¥è¯†ç‚¹" class="headerlink" title="Linuxç½‘ç»œä¸­å°çŸ¥è¯†ç‚¹"></a>Linuxç½‘ç»œä¸­å°çŸ¥è¯†ç‚¹</h1><p>è®°å½•ä¸€ä¸‹Linuxç½‘ç»œå½“ä¸­ä¸€äº›é›¶ç¢çš„å°çŸ¥è¯†ç‚¹ã€‚</p>
<span id="more"></span>
<h2 id="1-é€šè¿‡-etc-servicesæŸ¥çœ‹åº”ç”¨å±‚ç½‘ç»œåè®®"><a href="#1-é€šè¿‡-etc-servicesæŸ¥çœ‹åº”ç”¨å±‚ç½‘ç»œåè®®" class="headerlink" title="1.é€šè¿‡/etc/servicesæŸ¥çœ‹åº”ç”¨å±‚ç½‘ç»œåè®®"></a>1.é€šè¿‡<code>/etc/services</code>æŸ¥çœ‹åº”ç”¨å±‚ç½‘ç»œåè®®</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">vim /etc/services</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805144714394.png" alt="image-20220805144714394"></p>
<p>ä»é‡Œé¢æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¾ˆå¤š<strong>åº”ç”¨å±‚åè®®</strong>ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆ<strong>ä¼ è¾“å±‚åè®®</strong>ä»¥åŠå¸¸ç”¨çš„ç«¯å£ã€‚æ¯”å¦‚<code>ssh</code>ä½¿ç”¨2å·ç«¯å£ï¼Œå¹¶ä¸”ä½¿ç”¨tcpåè®®è¿›è¡Œé€šè®¯ã€‚</p>
<h2 id="2-é€šè¿‡-etc-resolv-confæŸ¥çœ‹å­˜æ”¾DNSæœåŠ¡å™¨çš„IPåœ°å€"><a href="#2-é€šè¿‡-etc-resolv-confæŸ¥çœ‹å­˜æ”¾DNSæœåŠ¡å™¨çš„IPåœ°å€" class="headerlink" title="2.é€šè¿‡/etc/resolv.confæŸ¥çœ‹å­˜æ”¾DNSæœåŠ¡å™¨çš„IPåœ°å€"></a>2.é€šè¿‡<code>/etc/resolv.conf</code>æŸ¥çœ‹å­˜æ”¾DNSæœåŠ¡å™¨çš„IPåœ°å€</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux//image-20220805171434655.png" alt="image-20220805171434655"></p>
<h2 id="3-é€šè¿‡-proc-sys-net-ipv4-tcp-tw-reuseæ¥è®¾ç½®"><a href="#3-é€šè¿‡-proc-sys-net-ipv4-tcp-tw-reuseæ¥è®¾ç½®" class="headerlink" title="3.é€šè¿‡/proc/sys/net/ipv4/tcp_tw_reuseæ¥è®¾ç½®"></a>3.é€šè¿‡<code>/proc/sys/net/ipv4/tcp_tw_reuse</code>æ¥è®¾ç½®</h2><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹å†…æ ¸å‚æ•°<code>/proc/sys/net/ipv4/tcp_tw_reuse</code>æ¥å¿«é€Ÿå›æ”¶è¢«å…³é—­çš„socketï¼Œä»è€Œä½¿å¾—TCPè¿æ¥æ ¹æœ¬å°±ä¸è¿›å…¥TIME_WAITçŠ¶æ€ï¼Œè¿›è€Œå…è®¸åº”ç”¨ç¨‹åºç«‹å³é‡ç”¨æœ¬åœ°çš„socketåœ°å€ã€‚</p>
<p><img src="æ–°å»ºæ–‡ä»¶å¤¹/image-20220813173711574.png" alt="image-20220813173711574"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>dupå’Œdup2å‡½æ•°</title>
    <url>/2022/08/19/Linux/dup%E5%92%8Cdup2%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="dupå’Œdup2å‡½æ•°"><a href="#dupå’Œdup2å‡½æ•°" class="headerlink" title="dupå’Œdup2å‡½æ•°"></a>dupå’Œdup2å‡½æ•°</h1><p><code>dup</code>å’Œ<code>dup2</code>ç”¨äºå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šå¸¸ç”¨äºé‡å®šå‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br></pre></td></tr></table></figure>
<p><code>dup</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥æ–°æ–‡ä»¶æè¿°ç¬¦å’ŒåŸæœ‰æ–‡ä»¶æè¿°ç¬¦<code>oldfd</code>æŒ‡å‘ç›¸åŒçš„æ–‡ä»¶ã€ç®¡é“æˆ–è€…ç½‘ç»œè¿æ¥ã€‚å¹¶ä¸”dupè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ˜¯å–ç³»ç»Ÿå½“å‰å¯ç”¨çš„æœ€å°æ•´æ•°å€¼ã€‚</p>
<p><code>dup2</code>å’Œ<code>dup</code>ç±»ä¼¼ï¼Œä¸è¿‡å®ƒå°†è¿”å›ç¬¬ä¸€ä¸ªä¸å°äº<code>newfd</code>çš„æ•´æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”<code>newfd</code>è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°†ä¼šæŒ‡å‘<code>oldfd</code>æŒ‡å‘çš„æ–‡ä»¶ï¼ŒåŸæ¥çš„<code>newfd</code>æŒ‡å‘çš„æ–‡ä»¶å°†ä¼šè¢«å…³é—­ï¼ˆé™¤é<code>newfd</code>å’Œ<code>oldfd</code>ç›¸åŒï¼‰ã€‚</p>
<p><code>dup</code>å’Œ<code>dup2</code>ç³»ç»Ÿè°ƒç”¨å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ï¼ŒæˆåŠŸå°±è¿”å›æ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong>é€šè¿‡dupå’Œdup2åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦å¹¶<strong>ä¸ç»§æ‰¿åŸæ–‡ä»¶æè¿°ç¬¦çš„å±æ€§</strong>ï¼Œæ¯”å¦‚close-on-execå’Œnon-blocking ç­‰</p>
<span id="more"></span>
<p><code>dup</code>ç®€å•ï¼Œè¾“å…¥<code>oldfd</code>ç›´æ¥è¿”å›å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;text.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    assert(fd != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd = %d\n&quot;</span>, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd2 = dup(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd2 = %d\n&quot;</span>, fd2);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    write(fd, str, <span class="keyword">sizeof</span>(str));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    write(fd2, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815171158327.png" alt="image-20220815171158327"></p>
<p><code>dup2</code>æ„Ÿè§‰å¤æ‚ä¸€äº›ï¼Œå…¶å®<code>dup2</code>å¿½ç•¥ç¬¬äºŒä¸ªå‚æ•°ï¼ŒåŠŸèƒ½æ˜¯å’Œ<code>dup</code>ä¸€æ ·çš„ï¼Œé™¤æ­¤ä¹‹å¤–<code>dup2</code>åŠ äº†ä¸€ä¸ªå°†è¿”å›ç¬¬ä¸€ä¸ªä¸å°äº<code>newfd</code>çš„æ•´æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦çš„åŠŸèƒ½ï¼Œå¹¶ä¸”<code>newfd</code>ä¹Ÿå°†æŒ‡å‘<code>oldfd</code>æŒ‡å‘çš„æ–‡ä»¶ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç è°ƒç”¨<code>dup2</code>ï¼Œæ–‡ä»¶æè¿°ç¬¦fd2åŸæ¥æŒ‡å‘â€text2.txtâ€æ–‡ä»¶çš„ï¼Œè°ƒç”¨<code>dup2</code>åï¼Œfd2æ”¹ä¸ºæŒ‡å‘â€text.txtâ€ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815173243219.png" alt="image-20220815173243219"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;text.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;text2.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    assert(fd1 != <span class="number">-1</span>);</span><br><span class="line">    assert(fd2 != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1 = %d, fd2 = %d\n&quot;</span>, fd1, fd2);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd3 = dup2(fd1, fd2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1 = %d,fd2 = %d,fd3 = %d\n&quot;</span>, fd1, fd2, fd3);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    write(fd1, str, <span class="keyword">sizeof</span>(str));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    write(fd2, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot; hello world\n&quot;</span>;</span><br><span class="line">    write(fd3, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line"></span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    close(fd3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815173321291.png" alt="image-20220815173321291"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>UIDã€EUIDã€GIDå’ŒEGID</title>
    <url>/2022/08/21/Linux/UID%E3%80%81EUID%E3%80%81GID%E5%92%8CEGID/</url>
    <content><![CDATA[<h1 id="UIDã€EUIDã€GIDå’ŒEGID"><a href="#UIDã€EUIDã€GIDå’ŒEGID" class="headerlink" title="UIDã€EUIDã€GIDå’ŒEGID"></a>UIDã€EUIDã€GIDå’ŒEGID</h1><p>Linuxä¸­idçœŸæ˜¯å¤ªå¤šäº†è¿›ç¨‹æœ‰pidï¼Œç„¶åç”¨æˆ·è¿˜æœ‰UIDè¿™ç§ï¼ŒçœŸæ˜¯æœ‰ç‚¹ç»•ã€‚</p>
<p>åœ¨Linuxå½“ä¸­ä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰æ‹¥æœ‰å››ä¸ªID:çœŸå®ç”¨æˆ·<code>UID</code>ã€æœ‰æ•ˆç”¨æˆ·<code>EUID</code>ã€çœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>ã€‚</p>
<p>è¿™é‡Œä»¥çœŸå®ç”¨æˆ·<code>UID</code>å’Œæœ‰æ•ˆç”¨æˆ·<code>EUID</code>ä¸ºä¾‹ï¼ŒçœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>é“ç†æ˜¯ç›¸åŒçš„ã€‚</p>
<p><code>EUID</code>å­˜åœ¨çš„ç›®çš„æ˜¯<strong>æ–¹ä¾¿èµ„æºè®¿é—®</strong>:å®ƒä½¿å¾—è¿è¡Œç¨‹åºçš„ç”¨æˆ·æ‹¥æœ‰è¯¥ç¨‹åºçš„æœ‰æ•ˆç”¨æˆ·çš„æƒé™ï¼ˆå¤ªè¿‡å®˜æ–¹è¿™ç§è¯´æ³•æ„Ÿè§‰ï¼‰ã€‚<code>EUID</code>ç¡®å®šè¿›ç¨‹å¯¹æŸäº›èµ„æºå’Œæ–‡ä»¶çš„è®¿é—®æƒé™ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çš„<code>UID</code>å’Œ<code>EUID</code>æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ç¨‹åºå¦‚<code>su</code>ã€<code>passwd</code>è¿™ç§<code>set-user-id</code>ç¨‹åºï¼Œå®ƒä»¬æœ‰å¯èƒ½æ˜¯ä¸ç›¸åŒçš„ã€‚å¯¹äº<code>set-user-id</code>ç¨‹åºè€Œè¨€ï¼Œç¨‹åºçš„<code>EUID</code>ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>çš„<code>UID</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ‰§è¡Œæ—¶ï¼Œæ˜¯ä»¥<strong>ç¨‹åºçš„æ‰€æœ‰è€…èº«ä»½</strong>è¿›è¡Œè¿è¡Œçš„ã€‚</p>
<span id="more"></span>
<p>ä»¥<code>passwd</code>ä¸ºä¾‹ã€‚<code>passwd</code>å…è®¸ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„ç™»å½•å¯†ç ï¼Œè¿™ä¸ª<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>æ˜¯<code>root</code>ï¼Œ<code>passwd</code>æƒé™ä¸­æœ‰<code>s</code>ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ª<code>set-user-id</code>ç¨‹åºã€‚<code>passwd</code>å‘½ä»¤éœ€è¦ä¿®æ”¹<code>/etc/shadow</code>æ–‡ä»¶ï¼Œå¯¹äº<code>/etc/shadow</code>æ–‡ä»¶ï¼Œæ™®é€šç”¨æˆ·æ˜¯ä¸å¯å†™ï¼ˆåªæœ‰è¯»æƒé™ï¼‰çš„ï¼Œé‚£ä¹ˆç”¨æˆ·æ€ä¹ˆèƒ½å¤Ÿé€šè¿‡<code>passwd</code>ä¿®æ”¹è‡ªå·±çš„å¯†ç å‘¢ï¼Œ<code>set-user-id</code>ç¨‹åºçš„æ ‡å¿—<code>s</code>å°±èµ·åˆ°äº†ä½œç”¨ï¼Œå®ƒåœ¨ç¨‹åºè¿è¡Œæ—¶å°†<code>EUID</code>ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>çš„<code>UID</code>ï¼Œé‚£ä¹ˆç¨‹åºæœ‰æ•ˆçš„ç”¨æˆ·å°±ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>ï¼Œåœ¨è¿™é‡Œæ˜¯<code>root</code>ç”¨æˆ·ï¼Œç†æ‰€å½“ç„¶çš„å¯ä»¥è¿›è¡Œ<code>/etc/shadow</code>æ–‡ä»¶çš„ä¿®æ”¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819104851240.png" alt="image-20220819104851240"></p>
<p>å†æ¯”å¦‚<code>su</code>ç¨‹åºå…è®¸ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨å®ƒæ¥ä¿®æ”¹è‡ªå·±çš„è´¦æˆ·ä¿¡æ¯ï¼Œä½†ä¿®æ”¹è´¦æˆ·æ—¶ç¨‹åºä¸å¾—ä¸è®¿é—®æ–‡ä»¶<code>/etc/passwd</code>æ–‡ä»¶ï¼Œè€Œè®¿é—®è¯¥æ–‡ä»¶æ˜¯éœ€è¦<code>root</code>æƒé™çš„ã€‚é‚£ä¹ˆä»¥<strong>æ™®é€šç”¨æˆ·èº«ä»½</strong>å¯åŠ¨çš„<code>su</code>ç¨‹åºå¦‚ä½•èƒ½è®¿é—®<code>/etc/passwd</code>æ–‡ä»¶å‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819130924743.png" alt="image-20220819130924743"></p>
<p><code>su</code>ç¨‹åºçš„æ‰€æœ‰è€…æ˜¯<code>root</code>ï¼Œå¹¶ä¸”å®ƒè¢«è®¾ç½®äº†<code>set-user-id</code>æ ‡å¿—ã€‚å’Œä¸Šé¢<code>passwd</code>ä¸€æ ·ï¼Œ<code>set-user-id</code>æ ‡å¿—è¡¨ç¤ºä»»ä½•æ™®é€šç”¨æˆ·è¿è¡Œ<code>su</code>ç¨‹åºæ—¶ï¼Œå…¶æœ‰æ•ˆç”¨æˆ·å°±æ˜¯è¯¥ç¨‹åºçš„<strong>æ‰€æœ‰è€…</strong><code>root</code>ã€‚</p>
<p>è·å–å’Œè®¾ç½®çœŸå®ç”¨æˆ·<code>UID</code>ã€æœ‰æ•ˆç”¨æˆ·<code>EUID</code>ã€çœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>çš„å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getuid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">geteuid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">getgid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">getegid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setuid</span><span class="params">(<span class="type">uid_t</span> uid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">seteuid</span><span class="params">(<span class="type">uid_t</span> euid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setgid</span><span class="params">(<span class="type">gid_t</span> gid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setegid</span><span class="params">(<span class="type">gid_t</span> egid)</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æµ‹è¯•ä¸Šé¢æ‰€è¯´ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·<code>bugcat</code>ï¼Œç›®å‰å·²ç»æœ‰æ™®é€šç”¨æˆ·<code>ubuntu</code>ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°<code>bugcat</code>çš„uidæ˜¯<code>1002</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819140826977.png" alt="image-20220819140826977"></p>
<p>æˆ‘ä»¬å†™ä¸‹è¯»å–ç¨‹åº<code>uid</code>å’Œ<code>euid</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="type">uid_t</span> euid = geteuid();</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;userid is %d, effective userid is: %d\n&quot;</span>, uid, euid );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†å…¶ç¼–è¯‘ä¸€ä¸‹ï¼Œç„¶åæŸ¥çœ‹æŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>å’Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>éƒ½æ˜¯<code>ubuntu</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141010532.png" alt="image-20220819141010532"></p>
<p>æ¥ç€å†å°†ç¨‹åºçš„æ‰€æœ‰è€…æ”¹ä¸º<code>root</code>ï¼Œå†åŠ ä¸Š<code>s</code>æƒé™ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºä¸ç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>æ˜¯<code>ubuntu</code>ï¼Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>æ˜¯<code>root</code>ï¼ˆç¬¦åˆ<code>set-user-id</code>ç¨‹åºç‰¹ç‚¹ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141209028.png" alt="image-20220819141209028"></p>
<p>ç„¶åå°†ç¨‹åºçš„æ‰€æœ‰è€…æ”¹ä¸º<code>bugcat</code>ï¼ˆsæƒé™ä¸çŸ¥é“ä¸ºå•¥è‡ªåŠ¨å–æ¶ˆäº†ï¼‰ï¼Œå†åŠ ä¸Š<code>s</code>æƒé™ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºä¸ç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>æ˜¯<code>ubuntu</code>ï¼Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>æ˜¯<code>bugcat</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141405860.png" alt="image-20220819141405860"></p>
<p>æœ€åæˆ‘ä»¬å»æ‰<code>s</code>æƒé™ï¼Œè¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>å’Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>éƒ½æ˜¯<code>ubuntu</code>ï¼Œä¹Ÿä»åé¢è¯´æ˜<code>s</code>æƒé™çš„ä½œç”¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819142209993.png" alt="image-20220819142209993"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>fcntlå‡½æ•°</title>
    <url>/2022/08/19/Linux/fcntl%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="fcntlå‡½æ•°"><a href="#fcntlå‡½æ•°" class="headerlink" title="fcntlå‡½æ•°"></a>fcntlå‡½æ•°</h1><p><code>fcntl</code>å‡½æ•°æä¾›äº†å¯¹æ–‡ä»¶æè¿°ç¬¦çš„å„ç§æ§åˆ¶æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span> )</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>å‚æ•°æ˜¯è¢«æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>cmd</code>å‚æ•°æŒ‡å®šæ‰§è¡Œä½•ç§ç±»å‹çš„æ“ä½œã€‚æ ¹æ®æ“ä½œç±»å‹çš„ä¸åŒï¼Œè¯¥å‡½æ•°å¯èƒ½è¿˜éœ€è¦ç¬¬ä¸‰ä¸ªå¯é€‰å‚æ•° <code>arg</code>ã€‚<code>fcntl</code>å‡½æ•°æ”¯æŒçš„å¸¸ç”¨æ“ä½œåŠå…¶å‚æ•°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<span id="more"></span>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816114524640.png" alt="image-20220816114524640"></p>
<p><code>fcntl</code>å‡½æ•°æˆåŠŸæ—¶çš„è¿”å›å€¼å¦‚è¡¨ä¸­æœ€åä¸€åˆ—æ‰€ç¤ºï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œ<code>fcntl</code>å‡½æ•°é€šå¸¸ç”¨æ¥å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚</p>
<p>æ¯”å¦‚ï¼šç»ˆç«¯æ–‡ä»¶é»˜è®¤æ˜¯é˜»å¡è¯»çš„ï¼Œè¿™é‡Œç”¨ fcntl å°†å…¶æ›´æ”¹ä¸ºéé˜»å¡è¯»</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TRY <span class="string">&quot;try again\n&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> flags, n;</span><br><span class="line"></span><br><span class="line">    flags = fcntl(STDIN_FILENO, F_GETFL); <span class="comment">//è·å–stdinå±æ€§ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (flags == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="type">int</span> ret = fcntl(STDIN_FILENO, F_SETFL, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        n = read(STDIN_FILENO, buf, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != EAGAIN)</span><br><span class="line">            &#123;</span><br><span class="line">                perror(<span class="string">&quot;read /dev/tty&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            write(STDOUT_FILENO, MSG_TRY, <span class="built_in">strlen</span>(MSG_TRY));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        write(STDOUT_FILENO, buf, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816115555375.png" alt="image-20220816115555375"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>sendfileå‡½æ•°</title>
    <url>/2022/08/19/Linux/sendfile%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="sendfileå‡½æ•°"><a href="#sendfileå‡½æ•°" class="headerlink" title="sendfileå‡½æ•°"></a>sendfileå‡½æ•°</h1><p><code>sendfile</code>å‡½æ•°åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç›´æ¥ä¼ é€’æ•°æ®ï¼ˆå®Œå…¨åœ¨å†…æ ¸ä¸­æ“ä½œ)ï¼Œä»è€Œé¿å…äº†å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œè¿™è¢«ç§°ä¸ºé›¶æ‹·è´ã€‚<code>sendfile</code>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendfile</span><span class="params">(<span class="type">int</span> out_fd, <span class="type">int</span> in_fd, <span class="type">off_t</span> *offset, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>
<p><code>out_fd</code>å‚æ•°æ˜¯å¾…å†™å…¥å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>in_fd</code>å‚æ•°æ˜¯å¾…è¯»å–å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>offset</code>å‚æ•°æ˜¯æŒ‡ä»è¯»å…¥æ–‡ä»¶æµçš„å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è¯»å…¥æ–‡ä»¶æµé»˜è®¤çš„èµ·å§‹ä½ç½®</p>
<p><code>count</code>å‚æ•°æŒ‡å®šåœ¨æ–‡ä»¶æè¿°ç¬¦<code>in_fd</code>å’Œ<code>out_fd</code>ä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°</p>
<p><code>sendfile</code>æˆåŠŸæ—¶è¿”å›ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>è¯¥å‡½æ•°çš„manæ‰‹å†Œæ˜ç¡®æŒ‡å‡ºï¼Œ<code>in_fd</code>å¿…é¡»æ˜¯ä¸€ä¸ªæ”¯æŒç±»ä¼¼<code>mmap</code>å‡½æ•°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³å®ƒå¿…é¡»æŒ‡å‘çœŸå®çš„æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯socketå’Œç®¡é“ã€‚è€Œ<code>out_fd</code>åˆ™å¿…é¡»æ˜¯ä¸€ä¸ªsocketã€‚ç”±æ­¤å¯è§ï¼Œ<code>sendfile</code>å‡ ä¹æ˜¯ä¸“é—¨ä¸ºåœ¨ç½‘ç»œä¸Šä¼ è¾“æ–‡ä»¶è€Œè®¾è®¡çš„ã€‚</p>
<span id="more"></span>
<p>ç”¨äº†ä¸€ä¸ªä¹¦ä¸Šçš„ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number filename\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *file_name = argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> filefd = open(file_name, O_RDONLY);</span><br><span class="line">    assert(filefd &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span></span><br><span class="line">    fstat(filefd, &amp;stat_buf);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendfile(connfd, filefd, <span class="literal">NULL</span>, stat_buf.st_size);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815185556863.png" alt="image-20220815185556863"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>readvå‡½æ•°å’Œwritevå‡½æ•°</title>
    <url>/2022/08/19/Linux/readv%E5%87%BD%E6%95%B0%E5%92%8Cwritev%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="readvå‡½æ•°å’Œwritevå‡½æ•°"><a href="#readvå‡½æ•°å’Œwritevå‡½æ•°" class="headerlink" title="readvå‡½æ•°å’Œwritevå‡½æ•°"></a>readvå‡½æ•°å’Œwritevå‡½æ•°</h1><p><code>readv</code>å‡½æ•°å°†æ•°æ®ä»æ–‡ä»¶æè¿°ç¬¦è¯»åˆ°åˆ†æ•£çš„å†…å­˜å—ä¸­ï¼Œå³åˆ†æ•£è¯»; </p>
<p><code>writev</code>å‡½æ•°åˆ™å°†å¤šå—åˆ†æ•£çš„å†…å­˜æ•°æ®ä¸€å¹¶å†™äººæ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œå³é›†ä¸­å†™ã€‚å®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">readv</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">writev</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>è¢«æ“ä½œçš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>iov</code>æ˜¯<code>iovec</code>ç±»å‹çš„æ•°ç»„ï¼Œåœ¨<code>recvmsg</code>å’Œ<code>sendmsg</code>ä¸­æ¥è§¦è¿‡ã€‚</p>
<p><code>iovcnt</code>æ˜¯<code>iov</code>æ•°ç»„çš„é•¿åº¦ã€‚</p>
<span id="more"></span>
<p><code>iovec</code>ç»“æ„ä½“å°è£…äº†ä¸€å—å†…å­˜çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> &#123;</span>                    <span class="comment">/* Scatter/gather array items */</span></span><br><span class="line">   <span class="type">void</span>  *iov_base;              <span class="comment">/* Starting address */</span></span><br><span class="line">   <span class="type">size_t</span> iov_len;               <span class="comment">/* Number of bytes to transfer */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>readv</code>å’Œ <code>writev</code>åœ¨æˆåŠŸæ—¶è¿”å›è¯»å‡º/å†™å…¥<code>fd</code>çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p>
<p><code>readv</code>å’Œ<code>writev</code>æ˜¯ä¸ªéå¸¸æœ‰ç”¨çš„å‡½æ•°ã€‚æ¯”å¦‚ï¼šå½“WebæœåŠ¡å™¨è§£æå®Œä¸€ä¸ªHTTPè¯·æ±‚ä¹‹åï¼Œå¦‚æœç›®æ ‡æ–‡æ¡£å­˜åœ¨ä¸”å®¢æˆ·å…·æœ‰è¯»å–è¯¥æ–‡æ¡£çš„æƒé™ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦å‘é€ä¸€ä¸ªHTTPåº”ç­”æ¥ä¼ è¾“è¯¥æ–‡æ¡£ã€‚è¿™ä¸ªHTTPåº”ç­”åŒ…å«1ä¸ªçŠ¶æ€è¡Œã€å¤šä¸ªå¤´éƒ¨å­—æ®µã€1ä¸ªç©ºè¡Œå’Œæ–‡æ¡£çš„å†…å®¹ã€‚å…¶ä¸­ï¼Œå‰3éƒ¨åˆ†çš„å†…å®¹å¯èƒ½è¢«WebæœåŠ¡å™¨æ”¾ç½®åœ¨ä¸€å—å†…å­˜ä¸­ï¼Œè€Œæ–‡æ¡£çš„å†…å®¹åˆ™é€šå¸¸è¢«è¯»å…¥åˆ°å¦å¤–ä¸€å—å•ç‹¬çš„å†…å­˜ä¸­ï¼ˆé€šè¿‡readå‡½æ•°æˆ–mmapå‡½æ•°)ã€‚æˆ‘ä»¬å¹¶ä¸éœ€è¦æŠŠè¿™ä¸¤éƒ¨åˆ†å†…å®¹æ‹¼æ¥åˆ°ä¸€èµ·å†å‘é€ï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨writevå‡½æ•°å°†å®ƒä»¬åŒæ—¶å†™å‡ºã€‚</p>
<p>ä¸¾ä¸€ä¸ªmanæ‰‹å†Œä¸Š<code>writev</code>å‡½æ•°çš„ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *str0 = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    <span class="type">char</span> *str1 = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[2];</span></span><br><span class="line">    <span class="type">ssize_t</span> nwritten;</span><br><span class="line"></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = str0;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="built_in">strlen</span>(str0);</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = str1;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="built_in">strlen</span>(str1);</span><br><span class="line"></span><br><span class="line">    nwritten = writev(STDOUT_FILENO, iov, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815180645424.png" alt="image-20220815180645424"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>spliceå‡½æ•°</title>
    <url>/2022/08/19/Linux/splice%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="spliceå‡½æ•°"><a href="#spliceå‡½æ•°" class="headerlink" title="spliceå‡½æ•°"></a>spliceå‡½æ•°</h1><p><code>splice</code>ç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œæ˜¯é›¶æ‹·è´æ“ä½œã€‚çœ‹äº†<code>man</code>æ‰‹å†Œï¼Œå‘ç°è¿™ä¸ª<code>splice</code>å‡½æ•°è·Ÿpipeç®¡é“å…³ç³»ä¸æµ…ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100155851.png" alt="image-20220816100155851"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">loff_t</span> *off_in, <span class="type">int</span> fd_out, <span class="type">loff_t</span> *off_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd_in</code>å‚æ•°æ˜¯å¾…è¾“äººæ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœ<code>fd_in</code>æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆ <code>off_in</code>å‚æ•°å¿…é¡»è¢«è®¾ç½®ä¸ºNULLã€‚å¦‚æœ<code>fd_in</code>ä¸æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ¯”å¦‚ socket)ï¼Œé‚£ä¹ˆ<code>off_in</code>è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å–æ•°æ®ã€‚æ­¤æ—¶ï¼Œè‹¥<code>off_in</code>è¢«è®¾ç½®ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„å½“å‰åç§»ä½ç½®è¯»å…¥ï¼›è‹¥<code>off_in</code>ä¸ä¸ºNULLï¼Œåˆ™å®ƒå°†æŒ‡å‡ºå…·ä½“çš„åç§»ä½ç½®ã€‚</p>
<p><code>fd_out/off_out</code>å‚æ•°çš„å«ä¹‰ä¸<code>fd_in/off_in</code>ç›¸åŒï¼Œä¸è¿‡ç”¨äºè¾“å‡ºæ•°æ®æµã€‚</p>
<p><code>len</code>å‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦</p>
<p><code>flags</code>å‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼Œå®ƒå¯ä»¥è¢«è®¾ç½®ä¸ºä¸‹è¡¨ä¸­çš„æŸäº›å€¼çš„æŒ‰ä½æˆ–ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100934412.png" alt="image-20220816100934412"></p>
<span id="more"></span>
<p>ä½¿ç”¨<code>splice</code>å‡½æ•°æ—¶ï¼Œ<code>fd_in</code>å’Œ<code>fd_out</code>å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>splice</code>å‡½æ•°è°ƒç”¨æˆåŠŸæ—¶è¿”å›ç§»åŠ¨å­—èŠ‚çš„æ•°é‡ã€‚å®ƒå¯èƒ½è¿”å›0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®éœ€è¦ç§»åŠ¨ï¼Œè¿™å‘ç”Ÿåœ¨ä»ç®¡é“ä¸­è¯»å–æ•°æ®ï¼ˆ<code>fd_in</code>æ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼‰è€Œè¯¥ç®¡é“æ²¡æœ‰è¢«å†™å…¥ä»»ä½•æ•°æ®æ—¶ã€‚<code>splice</code>å‡½æ•°å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å¸¸è§çš„<code>errno</code>å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816101918940.png" alt="image-20220816101918940"></p>
<p>ä¸‹é¢ç”¨äº†ä¸€ä¸ªä¹¦ä¸­çš„ä¾‹å­ï¼Œå®ç°ä¸€ä¸ªé›¶æ‹·è´çš„å›å°„æœåŠ¡å™¨ï¼Œå®ƒå°†å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯é€šè¿‡<code>splice</code>ä»<code>pipefd[1]</code>å†™å…¥ç®¡é“ï¼Œå†ä½¿ç”¨<code>splice</code>ä»<code>pipefd[0]</code>å‘å®¢æˆ·ç«¯å†™ä¸œè¥¿ï¼Œä»è€Œå®ç°é›¶æ‹·è´çš„å›å°„æœåŠ¡å™¨ï¼ˆæ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰ä½¿ç”¨<code>read</code>æˆ–è€…<code>write</code>æ“ä½œï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        ret = pipe(pipefd);</span><br><span class="line">        ret = splice(connfd, <span class="literal">NULL</span>, pipefd[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        ret = splice(pipefd[<span class="number">0</span>], <span class="literal">NULL</span>, connfd, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816102919876.png" alt="image-20220816102919876"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>tcpdumpè¿›è¡ŒARPæŠ“åŒ…</title>
    <url>/2022/08/05/Linux/tcpdump%E8%BF%9B%E8%A1%8CARP%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="tcpdumpè¿›è¡ŒARPæŠ“åŒ…"><a href="#tcpdumpè¿›è¡ŒARPæŠ“åŒ…" class="headerlink" title="tcpdumpè¿›è¡ŒARPæŠ“åŒ…"></a>tcpdumpè¿›è¡ŒARPæŠ“åŒ…</h1><p>åœ¨å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ä¸­ï¼Œçœ‹åˆ°ä½œè€…å¯¹ARPä½¿ç”¨<code>tcpdump</code>è¿›è¡ŒæŠ“åŒ…ï¼Œæ‰€ä»¥æœ¬ç€å®è·µå‡ºçœŸçŸ¥ã€å¤šçœ‹å¤šç»ƒçš„é“ç†ï¼Œä¹Ÿè¿›è¡ŒæŠ“åŒ…ï¼Œé¡ºå¸¦è®°å½•ä¸€ä¸‹ã€‚</p>
<p>ARPåè®®çš„åŠŸèƒ½æ˜¯å®ç°ç½‘ç»œå±‚åœ°å€åˆ°ä»»æ„ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œç®€å•ç†è§£ARPèƒ½å¤Ÿå®ç°ä»<strong>IPåœ°å€</strong>è½¬åŒ–ä¸º<strong>MACåœ°å€</strong>çš„è½¬åŒ–ã€‚</p>
<span id="more"></span>
<h2 id="arpå‘½ä»¤"><a href="#arpå‘½ä»¤" class="headerlink" title="arpå‘½ä»¤"></a>arpå‘½ä»¤</h2><p>Linuxå½“ä¸­ARP æ¨¡å—ç»´æŠ¤ä¸€ä¸ªç¡¬ä»¶åœ°å€åˆ°åè®®åœ°å€æ˜ å°„çš„ç¼“å­˜ï¼Œå¯ä»¥é€šè¿‡<code>arp</code>å‘½ä»¤æˆ–è€…<code>/proc/net/arp</code>æ–‡ä»¶æŸ¥çœ‹ã€‚</p>
<p>ä½¿ç”¨<code>arp -a</code>æŸ¥çœ‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux//image-20220805152235326.png" alt="image-20220805152235326"></p>
<p>ä½¿ç”¨<code>/proc/net/arp</code>æŸ¥çœ‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux//image-20220805152319586.png" alt="image-20220805152319586"></p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>arp</code>å‘½ä»¤å¯¹ç¼“å­˜è¿›è¡Œæ“ä½œã€‚</p>
<p>å°†<code>10.0.4.6</code>è¿™ä¸ªipå¯¹åº”çš„MACåœ°å€è¿›è¡Œåˆ é™¤</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">arp -d 10.0.4.6</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805152619382.png" alt="image-20220805152619382"></p>
<h2 id="tcpdumpè¿›è¡ŒARPæŠ“åŒ…-1"><a href="#tcpdumpè¿›è¡ŒARPæŠ“åŒ…-1" class="headerlink" title="tcpdumpè¿›è¡ŒARPæŠ“åŒ…"></a>tcpdumpè¿›è¡ŒARPæŠ“åŒ…</h2><p>ä¸Šé¢arpå‘½ä»¤æ˜¯åœ¨äº‘æœåŠ¡å™¨ä¸Šä½¿ç”¨çš„ï¼Œåœ¨ä½¿ç”¨tcpdumpè¿›è¡ŒæŠ“åŒ…æ—¶æ€»æ˜¯å‡ºç°ä¸€äº›é—®é¢˜ï¼Œæ„Ÿè§‰æ¯”ä¸ä¸Šç‰©ç†æœºï¼Œæ‰€ä»¥ä¸“é—¨æ‰¾äº†ä¸ªè£…Ubuntuçš„ç‰©ç†æœºè¿›è¡Œäº†æŠ“åŒ…æµ‹è¯•ã€‚å…¶ä¸­æœ¬æœºçš„ipï¼š172.27.27.202ï¼ŒæŠ“åŒ…æŠ“çš„æ˜¯ping 172.27.27.205çš„åŒ…ã€‚</p>
<p>å®éªŒè¿‡ç¨‹ï¼š</p>
<p>ä¸€ä¸ªçª—å£è¾“å…¥<code>tcpdump</code>å‘½ä»¤â€”-&gt;å¦ä¸€ä¸ªçª—å£è¾“å…¥pingå‘½ä»¤â€”-&gt;<code>tcpdump</code>å‘½ä»¤çª—å£è·å¾—æ•°æ®åŒ…</p>
<p>è¾“å…¥æŠ“åŒ…çš„<code>tcpdump</code>å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump -ent -c 2 arp</span><br></pre></td></tr></table></figure>
<p>å‘½ä»¤çš„å‚æ•°ä»‹ç»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-e åœ¨æ¯åˆ—å€¾å€’èµ„æ–™ä¸Šæ˜¾ç¤ºè¿æ¥å±‚çº§çš„æ–‡ä»¶å¤´ï¼›</span><br><span class="line">-n ä¸æŠŠä¸»æœºçš„ç½‘ç»œåœ°å€è½¬æ¢æˆåå­—ï¼›</span><br><span class="line">-t åœ¨æ¯åˆ—å€¾å€’èµ„æ–™ä¸Šä¸æ˜¾ç¤ºæ—¶é—´æˆ³è®°ï¼›</span><br><span class="line">-c æŠ“åŒ…çš„æ•°ç›®</span><br><span class="line">arp è¡¨ç¤ºåªæŠ“arpåè®®çš„åŒ…</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæŠ“åˆ°çš„åŒ…çš„ç»“æœå¦‚ä¸‹å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805154805611.png" alt="image-20220805154805611"></p>
<p>æ€»å…±æŠ“åˆ°2ä¸ªåŒ…ï¼Œä¸€ä¸ªè¯·æ±‚åŒ…ä¸€ä¸ªåº”ç­”åŒ…ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ä¸­ï¼ŒARPé€šè®¯çš„æºç«¯çš„ç‰©ç†åœ°å€ä¸º<code>d4:5d:64:d0:4c:5d</code>ï¼ˆæœ¬æœºï¼‰,ç›®çš„ç«¯çš„ç‰©ç†åœ°å€æ˜¯<code>ff:ff:ff:ff:ff:ff</code>ï¼Œè¿™æ˜¯ä»¥å¤ªç½‘çš„<strong>å¹¿æ’­</strong>åœ°å€ï¼Œè¯´æ˜ARPå¼€å§‹æ˜¯é€šè¿‡å¹¿æ’­æ¥è¯¢é—®çš„ã€‚æ•°å€¼<code>0x86</code>æ˜¯ä»¥å¤ªç½‘å¸§å¤´éƒ¨çš„ç±»å‹å­—æ®µçš„å€¼ï¼Œå®ƒè¡¨ç¤ºæ˜¯æ•°æ®æ˜¯ARPåè®®ã€‚<code>length 42</code>è¡¨ç¤ºè¯¥<strong>ä»¥å¤ªç½‘å¸§</strong>çš„é•¿åº¦æ˜¯42å­—èŠ‚ï¼ˆå®é™…ä¸Šæ˜¯46å­—èŠ‚ï¼Œtcpdumpæ²¡æœ‰ç»Ÿè®¡ä»¥å¤ªç½‘å¸§çš„æœ«å°¾4å­—èŠ‚çš„CRCå­—æ®µï¼‰ã€‚<code>length 28</code>è¡¨ç¤ºä»¥å¤ªç½‘å¸§çš„<strong>æ•°æ®éƒ¨åˆ†é•¿åº¦</strong>ä¸º28å­—èŠ‚ã€‚<code>Request</code>è¡¨ç¤ºè¿™æ˜¯ARPè¯·æ±‚ï¼Œ<code>who-has 172.27.27.205 tell 172.27.27.202</code>å°±æ˜¯å¾ˆç›´ç™½çš„â€è°æœ‰<code>172.27.27.205</code>çš„MACåœ°å€ï¼Œè¯·å‘Šè¯‰<code>172.27.27.202</code></p>
<p>ç¬¬äºŒä¸ªæ•°æ®åŒ…ä¸­ï¼ŒARPé€šè®¯çš„æºç«¯çš„ç‰©ç†åœ°å€ä¸º<code>d2:07:ca:1b:75:58</code>,ç›®çš„ç«¯çš„ç‰©ç†åœ°å€æ˜¯<code>d4:5d:64:d0:4c:5d</code>ã€‚<code>length 60</code>è¡¨ç¤ºè¯¥<strong>ä»¥å¤ªç½‘å¸§</strong>çš„é•¿åº¦æ˜¯60å­—èŠ‚ï¼ˆå®é™…ä¸Šæ˜¯64å­—èŠ‚ï¼Œtcpdumpæ²¡æœ‰ç»Ÿè®¡ä»¥å¤ªç½‘å¸§çš„æœ«å°¾4å­—èŠ‚çš„CRCå­—æ®µï¼‰ã€‚<code>length 46</code>è¡¨ç¤ºä»¥å¤ªç½‘å¸§çš„<strong>æ•°æ®éƒ¨åˆ†é•¿åº¦</strong>ä¸º46å­—èŠ‚ï¼ˆè¯´æ˜ARPåº”ç­”è¢«å¡«å……å­—èŠ‚äº†ï¼‰ã€‚<code>Reply</code>è¡¨ç¤ºè¿™æ˜¯ARPåº”ç­”ã€‚</p>
<h2 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h2><p>ä¹¦ä¸Šè¯´ARPè¯·æ±‚çš„æŠ¥æ–‡ä¸º<strong>28</strong>å­—èŠ‚ï¼Œå®ƒå±äºä»¥å¤ªç½‘å¸§çš„æ•°æ®éƒ¨åˆ†ï¼Œä»¥å¤ªç½‘å¸§çš„ä»¥å¤ªç½‘å¤´éƒ¨+CRCæ ¡éªŒçš„å°¾éƒ¨ä¸€å…±<strong>18</strong>å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªæºå¸¦ARPæŠ¥æ–‡çš„ä»¥å¤ªç½‘å¸§è‡³å°‘ä¸º<strong>46</strong>å­—èŠ‚ï¼Œä½†æ˜¯ç”±äºå®ç°è¦æ±‚<strong>ä»¥å¤ªç½‘å¸§æ•°æ®éƒ¨åˆ†</strong>çš„é•¿åº¦è‡³å°‘è¦<strong>46</strong>å­—èŠ‚ï¼ŒARPæŠ¥æ–‡æ­¤æ—¶ä¼šå¡«å……ä¸€äº›å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªæºå¸¦ARPæŠ¥æ–‡çš„ä»¥å¤ªç½‘å¸§è‡³å°‘ä¸º<strong>60</strong>å­—èŠ‚ã€‚è¿™é‡Œä»¥å¤ªç½‘å¸§çš„å¤§å°å’Œç¬¬äºŒä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿå°±æ˜¯ARPåº”ç­”æ•°æ®ç›¸å»åˆã€‚</p>
<p>ä½†æ˜¯ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ARPè¯·æ±‚æ•°æ®åŒ…åˆ™ä¸ç¬¦åˆè®¾å®šï¼Œå®ƒåªå†™äº†è‡ªå·±ARPè¯·æ±‚çš„æŠ¥æ–‡å¤§å°ï¼Œå¹¶æœªè¿›è¡Œå­—èŠ‚å¡«å……ï¼Œè¿™é‡Œæœ‰ä¸€äº›ä¸å¤ªç†è§£ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805165516292.png" alt="image-20220805165516292"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>tcpdumpè¿›è¡ŒDNSæŠ“åŒ…</title>
    <url>/2022/08/05/Linux/tcpdump%E8%BF%9B%E8%A1%8CDNS%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="tcpdumpè¿›è¡ŒDNSæŠ“åŒ…"><a href="#tcpdumpè¿›è¡ŒDNSæŠ“åŒ…" class="headerlink" title="tcpdumpè¿›è¡ŒDNSæŠ“åŒ…"></a>tcpdumpè¿›è¡ŒDNSæŠ“åŒ…</h1><p>åœ¨å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ä¸­ï¼Œçœ‹åˆ°ä½œè€…å¯¹DNSä½¿ç”¨<code>tcpdump</code>è¿›è¡ŒæŠ“åŒ…ï¼Œæ‰€ä»¥æœ¬ç€å®è·µå‡ºçœŸçŸ¥ã€å¤šçœ‹å¤šç»ƒçš„é“ç†ï¼Œä¹Ÿè¿›è¡ŒæŠ“åŒ…ï¼Œé¡ºå¸¦è®°å½•ä¸€ä¸‹ã€‚</p>
<p>æˆ‘ä»¬å…ˆç”¨<code>host</code>å‘½ä»¤æŸ¥è¯¢ä¸€ä¸‹ç™¾åº¦åŸŸåçš„IPåœ°å€</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">host -t A www.baidu.com</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>-t A</code>æ˜¯æŒ‡ æŸ¥è¯¢ä½ Aç±»å‹çš„åœ°å€ï¼Œä¸è¿‡æˆ‘ä¹Ÿæ²¡æœ‰å¼„æ¸…æ¥šè¿™ä¸ª<code>A</code>æ˜¯ä»€ä¹ˆç±»å‹</p>
<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805191657175.png" alt="image-20220805191657175"></p>
<p>www.baidu.comæ˜¯www.a.shifen.comçš„åˆ«åã€‚www.a.shifen.comæœ‰ä¸¤ä¸ªåœ°å€112.80.248.75å’Œ112.80.248.76</p>
<span id="more"></span>
<p>ä½¿ç”¨tcpdumpè¿›è¡ŒæŠ“åŒ…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump -i eth0 -nt -c 10  port domain</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-i æŒ‡å®šæŠ“åŒ…çš„ç½‘å¡</span><br><span class="line">-n ä¸æŠŠä¸»æœºçš„ç½‘ç»œåœ°å€è½¬æ¢æˆåå­—</span><br><span class="line">-t åœ¨æ¯åˆ—å€¾å€’èµ„æ–™ä¸Šä¸æ˜¾ç¤ºæ—¶é—´æˆ³è®°</span><br><span class="line">-c æŒ‡å®šæŠ“åŒ…çš„æ•°é‡</span><br><span class="line">port domainè¡¨ç¤ºåªæŠ“å–ä½¿ç”¨domainï¼ˆåŸŸåï¼‰æœåŠ¡çš„æ•°æ®åŒ…</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæŠ“å–çš„æœ‰ç”¨ç»“æœæˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805191641245.png" alt="image-20220805191641245"></p>
<p>æ€»å…±æ‰‹åŠ¨ä¸¤ä¸ªæ•°æ®åŒ…</p>
<p>ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ä¸­ï¼ˆDNSæŸ¥è¯¢æŠ¥æ–‡ï¼‰ï¼Œä»ipï¼š10.0.4.5ï¼ˆæœ¬æœºï¼‰ç«¯å£39454å‘å‘ipï¼š183.60.83.19ï¼ˆDNSæœåŠ¡å™¨ï¼‰çš„53ç«¯å£ï¼ˆDNSæœåŠ¡çš„ç«¯å£ï¼‰ï¼Œ47814æ˜¯DNSæŸ¥è¯¢æŠ¥æ–‡çš„æ ‡è¯†å€¼ï¼Œå› æ­¤è¯¥å€¼ä¹Ÿå‡ºç°åœ¨DNSåº”ç­”æŠ¥æ–‡ä¸­ã€‚â€œ+â€è¡¨ç¤ºå¯ç”¨é€’å½’æŸ¥è¯¢æ ‡å¿—ã€‚â€œAï¼Ÿâ€è¡¨ç¤ºä½¿ç”¨Aç±»å‹çš„æŸ¥è¯¢æ–¹å¼ã€‚â€œwww.baidu.comâ€åˆ™æ˜¯DNSæŸ¥è¯¢é—®é¢˜ä¸­çš„æŸ¥è¯¢åã€‚â€œ(31)â€è¡¨ç¤º DNSæŸ¥è¯¢æŠ¥æ–‡çš„é•¿åº¦ä¸º32å­—èŠ‚</p>
<p>ç¬¬äºŒä¸ªæ•°æ®åŒ…ä¸­ï¼ˆDNSåº”ç­”æŠ¥æ–‡ï¼‰ï¼Œâ€œ3/0/0â€è¡¨ç¤ºè¯¥æŠ¥æ–‡ä¸­åŒ…å«3ä¸ªåº”ç­”èµ„æºè®°å½•ã€0ä¸ªæˆæƒèµ„æºè®°å½•å’Œ0ä¸ªé¢å¤–ä¿¡æ¯è®°å½•ã€‚â€œCNAME www.a.shifen.com., A 112.80.248.76, A 112.80.248.75â€åˆ™è¡¨ç¤º3ä¸ªåº”ç­”èµ„æºè®°å½•çš„å†…å®¹ã€‚å…¶ä¸­CNAMEè¡¨ç¤ºç´§éšå…¶åçš„è®°å½•æ˜¯æœºå™¨çš„åˆ«åï¼ŒAè¡¨ç¤ºç´§éšå…¶åçš„è®°å½•æ˜¯ipåœ°å€ã€‚è¯¥åº”ç­”æŠ¥æ–‡çš„é•¿åº¦ä¸º90å­—èŠ‚ã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>tcpdumpè¿›è¡ŒIPæŠ“åŒ…</title>
    <url>/2022/08/05/Linux/tcpdump%E8%BF%9B%E8%A1%8CIP%E6%8A%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="tcpdumpè¿›è¡ŒIPæŠ“åŒ…"><a href="#tcpdumpè¿›è¡ŒIPæŠ“åŒ…" class="headerlink" title="tcpdumpè¿›è¡ŒIPæŠ“åŒ…"></a>tcpdumpè¿›è¡ŒIPæŠ“åŒ…</h1><p>åœ¨å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ä¸­ï¼Œçœ‹åˆ°ä½œè€…å¯¹IPå¤´éƒ¨ä½¿ç”¨<code>tcpdump</code>è¿›è¡ŒæŠ“åŒ…ï¼Œæ‰€ä»¥æœ¬ç€å®è·µå‡ºçœŸçŸ¥ã€å¤šçœ‹å¤šç»ƒçš„é“ç†ï¼Œä¹Ÿè¿›è¡ŒæŠ“åŒ…ï¼Œé¡ºå¸¦è®°å½•ä¸€ä¸‹ã€‚</p>
<p><strong>æ³¨æ„è¿™é‡Œçš„IPåè®®éƒ½æ˜¯æŒ‡IPv4åè®®ã€‚</strong></p>
<span id="more"></span>
<h2 id="IPå¤´éƒ¨ç»“æ„"><a href="#IPå¤´éƒ¨ç»“æ„" class="headerlink" title="IPå¤´éƒ¨ç»“æ„"></a>IPå¤´éƒ¨ç»“æ„</h2><p>IPåè®®å¯ä»¥è¯´æ˜¯ç½‘ç»œé€šè®¯ä¸­æœ€é‡è¦çš„åè®®ä¹‹ä¸€ï¼Œæ‰€ä»¥äº†è§£IPæ•°æ®åŒ…çš„ç»“æ„æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p>
<p>IPæ•°æ®æŠ¥ç”±<strong>æŠ¥å¤´</strong>å’Œ<strong>æ•°æ®</strong>ä¸¤éƒ¨åˆ†ç»„æˆï¼Œå…¶ä¸­ï¼Œæ•°æ®æ˜¯é«˜å±‚éœ€è¦ä¼ è¾“çš„æ•°æ®ï¼ŒæŠ¥å¤´æ˜¯ä¸ºäº†æ­£ç¡®ä¼ è¾“é«˜å±‚æ•°æ®è€Œå¢åŠ çš„æ§åˆ¶ä¿¡æ¯ã€‚</p>
<p>IPçš„<strong>å¤´éƒ¨ç»“æ„</strong>å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220806113346237.png" alt="image-20220806113346237"></p>
<p>å›ºå®šéƒ¨åˆ†ä¸ºå®çº¿éƒ¨åˆ†ï¼Œé•¿åº¦ä¸º20å­—èŠ‚ã€‚å¯å˜é•¿çš„é€‰é¡¹éƒ¨åˆ†é•¿åº¦æœ€å¤š40å­—èŠ‚ï¼Œæ‰€ä»¥IPå¤´éƒ¨æœ€å¤š60å­—èŠ‚é•¿ã€‚</p>
<p>1) ç‰ˆæœ¬å·</p>
<p>å  4 ä½ï¼Œè¡¨ç¤º IP åè®®çš„ç‰ˆæœ¬ã€‚åœ¨IPv4ä¸­çš„å€¼æ˜¯4ã€‚</p>
<p>2) å¤´éƒ¨é•¿åº¦</p>
<p>å  4 ä½ï¼Œå¯è¡¨ç¤ºçš„æœ€å¤§åè¿›åˆ¶æ•°å€¼æ˜¯ 15ã€‚å¤´éƒ¨é•¿åº¦è¡¨ç¤ºIPå¤´éƒ¨æœ‰å¤šå°‘ä¸ª32bitå­—ï¼ˆ4å­—èŠ‚ï¼‰ï¼Œæ‰€ä»¥IPå¤´éƒ¨æœ€é•¿æ˜¯60å­—èŠ‚ã€‚</p>
<p>3) æœåŠ¡ç±»å‹ï¼ˆtosï¼‰</p>
<p>å  8 ä½ï¼Œç”¨æ¥è·å¾—æ›´å¥½çš„æœåŠ¡ã€‚åˆ†ä¸º3ä½çš„ä¼˜å…ˆæƒå­—æ®µï¼ˆç°åœ¨ä»¥åŠè¢«å¿½ç•¥ï¼‰ï¼Œ4ä½çš„TOSå­—æ®µå’Œ1ä½ä¿ç•™å­—æ®µï¼ˆå¿…é¡»ç½®ä¸º0ï¼‰ã€‚4ä½çš„TOSå­—æ®µåˆ†åˆ«è¡¨ç¤ºï¼šæœ€å°å»¶æ—¶ï¼Œæœ€å¤§ååé‡ï¼Œæœ€é«˜å¯é æ€§å’Œæœ€å°éä¹Ÿã€‚å…¶ä¸­æœ€å¤šæœ‰ä¸€ä¸ªèƒ½ç½®ä¸º1ï¼Œåº”ç”¨ç¨‹åºæ ¹æ®å®é™…éœ€è¦æ¥è®¾ç½®ï¼Œæ¯”å¦‚sshå’Œtelnetè¿™æ ·çš„æœåŠ¡å°±éœ€è¦æœ€å°å»¶æ—¶æœåŠ¡ã€‚</p>
<p>4) æ€»é•¿åº¦ï¼ˆtotlenï¼‰</p>
<p>å 16 ä½ï¼Œè¡¨ç¤º<strong>æ•´ä¸ªæ•°æ®æŠ¥çš„é•¿åº¦</strong>ï¼ˆå­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œå› æ­¤IPæ•°æ®æŠ¥çš„æœ€å¤§é•¿åº¦ä¸º 2^16-1=65535 å­—èŠ‚ã€‚ä½†æ˜¯ç”±äºMTUçš„é™åˆ¶ï¼Œé•¿åº¦è¶…è¿‡MTUçš„æ•°æ®æŠ¥ä¼šè¢«åˆ†ç‰‡ï¼Œæ‰€ä»¥å®é™…ä¼ è¾“IPæ•°æ®æŠ¥çš„é•¿åº¦è¿œè¿œæ²¡æœ‰è¾¾åˆ°æœ€å¤§å€¼ã€‚</p>
<p>5) æ ‡è¯†ï¼ˆidentificationï¼‰</p>
<p>å  16 ä½ã€‚IP åè®®åœ¨å­˜å‚¨å™¨ä¸­ç»´æŒä¸€ä¸ªè®¡æ•°å™¨ã€‚æ¯äº§ç”Ÿä¸€ä¸ªæ•°æ®æŠ¥ï¼Œè®¡æ•°å™¨å°±åŠ  1ï¼Œå¹¶å°†æ­¤å€¼èµ‹ç»™æ ‡è¯†å­—æ®µï¼Œå…¶åˆå§‹å€¼ç”±ç³»ç»Ÿéšæœºç”Ÿæˆã€‚å½“æ•°æ®æŠ¥çš„é•¿åº¦è¶…è¿‡ç½‘ç»œçš„ MTUï¼Œè€Œå¿…é¡»åˆ†ç‰‡æ—¶ï¼Œè¿™ä¸ªæ ‡è¯†å­—æ®µçš„å€¼å°±è¢«å¤åˆ¶åˆ°æ‰€æœ‰çš„æ•°æ®æŠ¥çš„æ ‡è¯†å­—æ®µä¸­ã€‚å…·æœ‰ç›¸åŒçš„æ ‡è¯†å­—æ®µå€¼çš„åˆ†ç‰‡æŠ¥æ–‡ä¼šè¢«é‡ç»„æˆåŸæ¥çš„æ•°æ®æŠ¥ã€‚</p>
<p>6) æ ‡å¿—ï¼ˆflagï¼‰</p>
<p>å  3 ä½ã€‚ç¬¬ä¸€ä½ä¿ç•™ï¼Œå…¶å€¼ä¸º 0ã€‚ç¬¬äºŒä½ç§°ä¸º DFï¼ˆä¸åˆ†ç‰‡ï¼‰ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸åˆ†ç‰‡ã€‚å–å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºå…è®¸åˆ†ç‰‡ï¼›å–å€¼ä¸º 1 æ—¶ï¼Œè¡¨ç¤ºä¸å…è®¸åˆ†ç‰‡ã€‚ç¬¬ä¸‰ä½ç§°ä¸º MFï¼ˆæ›´å¤šåˆ†ç‰‡ï¼‰ï¼Œè¡¨ç¤ºæ˜¯å¦è¿˜æœ‰åˆ†ç‰‡æ­£åœ¨ä¼ è¾“ï¼Œè®¾ç½®ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæ²¡æœ‰æ›´å¤šåˆ†ç‰‡éœ€è¦å‘é€ï¼Œæˆ–æ•°æ®æŠ¥æ²¡æœ‰åˆ†ç‰‡ï¼Œæ¯”å¦‚ï¼šåœ¨åˆ†ç‰‡çš„æ•°æ®æŠ¥ä¸­æœ€åä¸€ä¸ªåˆ†ç‰‡å°†è¿™ä½è®¾ç½®ä½0ï¼Œå…¶ä»–åˆ†ç‰‡éƒ½è¦æŠŠå®ƒç½®ä¸º1ã€‚</p>
<p>7) ç‰‡åç§»ï¼ˆoffsetfragï¼‰</p>
<p>å  13 ä½ã€‚å½“æŠ¥æ–‡è¢«åˆ†ç‰‡åï¼Œè¯¥å­—æ®µæ ‡è®°è¯¥åˆ†ç‰‡åœ¨åŸæŠ¥æ–‡ä¸­çš„ç›¸å¯¹ä½ç½®ã€‚ç‰‡åç§»ä»¥ 8 ä¸ªå­—èŠ‚ä¸ºåç§»å•ä½ã€‚æ‰€ä»¥ï¼Œé™¤äº†æœ€åä¸€ä¸ªåˆ†ç‰‡ï¼Œå…¶ä»–åˆ†ç‰‡çš„åç§»å€¼éƒ½æ˜¯ 8 å­—èŠ‚ï¼ˆ64 ä½ï¼‰çš„æ•´æ•°å€ã€‚ç”±äºè¿™ä¸ªåŸå› ï¼Œæ¯ä¸ªIPåˆ†ç‰‡çš„æ•°æ®éƒ¨åˆ†çš„é•¿åº¦å¿…é¡»æ˜¯8çš„æ•´æ•°å€ï¼ˆæœ€åä¸€ä¸ªåˆ†ç‰‡é™¤å¤–ï¼‰ã€‚</p>
<p>8) ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰</p>
<p>å  8 ä½ï¼Œè¡¨ç¤ºæ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­çš„å¯¿å‘½ã€‚è¯¥å­—æ®µç”±å‘å‡ºæ•°æ®æŠ¥çš„æºä¸»æœºè®¾ç½®ã€‚å…¶ç›®çš„æ˜¯é˜²æ­¢æ— æ³•äº¤ä»˜çš„æ•°æ®æŠ¥æ— é™åˆ¶åœ°åœ¨ç½‘ç»œä¸­ä¼ è¾“ï¼Œä»è€Œæ¶ˆè€—ç½‘ç»œèµ„æºã€‚</p>
<p>è·¯ç”±å™¨åœ¨è½¬å‘æ•°æ®æŠ¥ä¹‹å‰ï¼Œå…ˆæŠŠ TTL å€¼å‡ 1ã€‚è‹¥ TTL å€¼å‡å°‘åˆ° 0ï¼Œåˆ™ä¸¢å¼ƒè¿™ä¸ªæ•°æ®æŠ¥ï¼Œä¸å†è½¬å‘ã€‚å› æ­¤ï¼ŒTTL æŒ‡æ˜æ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­æœ€å¤šå¯ç»è¿‡å¤šå°‘ä¸ªè·¯ç”±å™¨ã€‚TTL çš„æœ€å¤§æ•°å€¼ä¸º 255ã€‚è‹¥æŠŠ TTL çš„åˆå§‹å€¼è®¾ä¸º 1ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸ªæ•°æ®æŠ¥åªèƒ½åœ¨æœ¬å±€åŸŸç½‘ä¸­ä¼ é€ã€‚ </p>
<p>9) åè®®</p>
<p>å  8 ä½ï¼Œè¡¨ç¤ºè¯¥æ•°æ®æŠ¥æ–‡æ‰€æºå¸¦çš„æ•°æ®æ‰€ä½¿ç”¨çš„åè®®ç±»å‹ã€‚è¯¥å­—æ®µå¯ä»¥æ–¹ä¾¿ç›®çš„ä¸»æœºçš„ IP å±‚çŸ¥é“æŒ‰ç…§ä»€ä¹ˆåè®®æ¥å¤„ç†æ•°æ®éƒ¨åˆ†ã€‚ä¸åŒçš„åè®®æœ‰ä¸“é—¨ä¸åŒçš„åè®®å·ã€‚</p>
<p>ä¾‹å¦‚ï¼ŒTCP çš„åè®®å·ä¸º 6ï¼ŒUDP çš„åè®®å·ä¸º 17ï¼ŒICMP çš„åè®®å·ä¸º 1ã€‚</p>
<p>10) å¤´éƒ¨æ£€éªŒå’Œï¼ˆchecksumï¼‰</p>
<p>ç”¨äºæ ¡éªŒæ•°æ®æŠ¥çš„é¦–éƒ¨ï¼Œå  16 ä½ã€‚æ•°æ®æŠ¥æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œé¦–éƒ¨çš„å­—æ®µéƒ½å¯èƒ½å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚TTLï¼‰ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ ¡éªŒã€‚è€Œæ•°æ®éƒ¨åˆ†ä¸å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¸ç”¨é‡æ–°ç”Ÿæˆæ ¡éªŒå€¼ã€‚</p>
<p>11) æºåœ°å€</p>
<p>è¡¨ç¤ºæ•°æ®æŠ¥çš„æº IP åœ°å€ï¼Œå  32 ä½ã€‚</p>
<p>12) ç›®çš„åœ°å€</p>
<p>è¡¨ç¤ºæ•°æ®æŠ¥çš„ç›®çš„ IP åœ°å€ï¼Œå  32 ä½ã€‚è¯¥å­—æ®µç”¨äºæ ¡éªŒå‘é€æ˜¯å¦æ­£ç¡®ã€‚</p>
<p>13) å¯é€‰å­—æ®µ</p>
<p>è¯¥å­—æ®µç”¨äºä¸€äº›å¯é€‰çš„æŠ¥å¤´è®¾ç½®ï¼Œä¸»è¦ç”¨äºæµ‹è¯•ã€è°ƒè¯•å’Œå®‰å…¨çš„ç›®çš„ã€‚è¿™äº›é€‰é¡¹åŒ…æ‹¬ä¸¥æ ¼æºè·¯ç”±ï¼ˆæ•°æ®æŠ¥å¿…é¡»ç»è¿‡æŒ‡å®šçš„è·¯ç”±ï¼‰ã€ç½‘é™…æ—¶é—´æˆ³ï¼ˆç»è¿‡æ¯ä¸ªè·¯ç”±å™¨æ—¶çš„æ—¶é—´æˆ³è®°å½•ï¼‰å’Œå®‰å…¨é™åˆ¶ã€‚</p>
<p>14) å¡«å……</p>
<p>ç”±äºå¯é€‰å­—æ®µä¸­çš„é•¿åº¦ä¸æ˜¯å›ºå®šçš„ï¼Œä½¿ç”¨è‹¥å¹²ä¸ª 0 å¡«å……è¯¥å­—æ®µï¼Œå¯ä»¥ä¿è¯æ•´ä¸ªæŠ¥å¤´çš„é•¿åº¦æ˜¯ 32 ä½çš„æ•´æ•°å€ã€‚</p>
<h2 id="ä½¿ç”¨tcpdumpè§‚å¯ŸIPv4å¤´éƒ¨ç»“æ„"><a href="#ä½¿ç”¨tcpdumpè§‚å¯ŸIPv4å¤´éƒ¨ç»“æ„" class="headerlink" title="ä½¿ç”¨tcpdumpè§‚å¯ŸIPv4å¤´éƒ¨ç»“æ„"></a>ä½¿ç”¨tcpdumpè§‚å¯ŸIPv4å¤´éƒ¨ç»“æ„</h2><p>æˆ‘ä»¬æŠ“å–æœ¬åœ°å›è·¯ä¸Šçš„æ•°æ®åŒ…ï¼Œé€šè¿‡<code>telnet 127.0.0.1</code>é…åˆ<code>tcpdump</code>è¿›è¡ŒæŠ“åŒ…</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220806142812432.png" alt="image-20220806142812432"></p>
<p>æŠ“åŒ…å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump -ntx -i lo -c 1</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-n ä¸æŠŠä¸»æœºçš„ç½‘ç»œåœ°å€è½¬æ¢æˆåå­—</span><br><span class="line">-t åœ¨æ¯åˆ—å€¾å€’èµ„æ–™ä¸Šä¸æ˜¾ç¤ºæ—¶é—´æˆ³è®°</span><br><span class="line">-x ç”¨åå…­è¿›åˆ¶å­—ç åˆ—å‡ºæ•°æ®åŒ…èµ„æ–™</span><br><span class="line">-i æŠ“å–æŒ‡å®šç½‘å¡çš„åŒ…</span><br><span class="line">-c æŠ“å–åŒ…çš„ä¸ªæ•°</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆæŠ“åŒ…ç»“æœå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220805223608148.png" alt="image-20220805223608148"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IP 127.0.0.1.52904 &gt; 127.0.0.1.23: Flags [S], seq 1003093548, win 65495, options [mss 65495,sackOK,TS val 3642507651 ecr 0,nop,wscale 7], length 0</span><br><span class="line">	0x0000:  4510 003c af8c 4000 4006 8d1d 7f00 0001</span><br><span class="line">	0x0010:  7f00 0001 cea8 0017 3bc9 fe2c 0000 0000</span><br><span class="line">	0x0020:  a002 ffd7 fe30 0000 0204 ffd7 0402 080a</span><br><span class="line">	0x0030:  d91c 4183 0000 0000 0103 0307</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘ä»¬æ˜¯<code>telnet 127.0.0.1</code>æ‰€ä»¥æˆ‘ä»¬æºåœ°å€å’Œç›®æ ‡åœ°å€éƒ½æ˜¯<code>127.0.0.1</code>åªä¸è¿‡ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯ç«¯å£<code>52904</code>åˆ°ç›®æ ‡ç«¯å£<code>23</code>ï¼ˆtelnetç«¯å£ï¼‰ã€‚</p>
<p>â€œFlagâ€ã€â€œseqâ€ã€â€œwinâ€å’Œâ€œoptionsâ€éƒ½æ˜¯TCPå¤´éƒ¨ä¿¡æ¯ï¼ˆtelnetä½¿ç”¨çš„æ˜¯TCPåè®®ï¼‰ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä¸æ˜¯æˆ‘ä»¬çš„é‡ç‚¹ã€‚</p>
<p><code>length</code>è¡¨ç¤ºåº”ç”¨ç¨‹åºæ•°æ®çš„é•¿åº¦ï¼ˆå¹¶ä¸æ˜¯IPæ•°æ®éƒ¨åˆ†ï¼‰ã€‚è¿™é‡Œæ•°æ®åŒ…å…±åŒ…å«<strong>60å­—èŠ‚</strong>ï¼Œå…¶ä¸­<strong>å‰20å­—èŠ‚æ˜¯IPå¤´éƒ¨ï¼Œå40å­—èŠ‚æ˜¯TCPå¤´éƒ¨</strong>ï¼Œä¸åŒ…å«åº”ç”¨ç¨‹åºæ•°æ®ï¼ˆlengthå€¼ä¸º0ï¼‰ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬é‡ç‚¹å…³æ³¨IPå¤´éƒ¨çš„æ•°æ®ï¼Œæˆªå–ä¸€ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x0000:  4510 003c af8c 4000 4006 8d1d 7f00 0001</span><br><span class="line">0x0010:  7f00 0001</span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>åå…­è¿›åˆ¶æ•°</th>
<th>åè¿›åˆ¶æ•°</th>
<th>IPå¤´éƒ¨ä¿¡æ¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x4</td>
<td>4</td>
<td>IPç‰ˆæœ¬å·</td>
</tr>
<tr>
<td>0x5</td>
<td>5</td>
<td>å¤´éƒ¨é•¿åº¦ä¸º5ä¸ª32ä½ï¼ˆ20å­—èŠ‚ï¼‰</td>
</tr>
<tr>
<td>0x10</td>
<td></td>
<td>TOSé€‰é¡¹ä¸­æœ€å°å»¶æ—¶æœåŠ¡è¢«å¼€å¯</td>
</tr>
<tr>
<td>0x003c</td>
<td>60</td>
<td>æ•°æ®åŒ…æ€»é•¿åº¦ï¼Œ60å­—èŠ‚</td>
</tr>
<tr>
<td>0xaf8c</td>
<td></td>
<td>æ•°æ®æŠ¥æ ‡è¯†</td>
</tr>
<tr>
<td>0x4</td>
<td></td>
<td>3ä½æ ‡å¿—ï¼Œè®¾ç½®ç¦æ­¢åˆ†ç‰‡</td>
</tr>
<tr>
<td>0x000</td>
<td>0</td>
<td>åˆ†ç‰‡åç§»</td>
</tr>
<tr>
<td>0x40</td>
<td>64</td>
<td>TTLè¢«è®¾ä¸º64</td>
</tr>
<tr>
<td>0x06</td>
<td>6</td>
<td>åè®®å­—æ®µä¸º6ï¼Œè¡¨ç¤ºä¸Šå±‚åè®®æ˜¯TCPåè®®</td>
</tr>
<tr>
<td>0x8d1d</td>
<td></td>
<td>IPå¤´éƒ¨æ ¡éªŒå’Œ</td>
</tr>
<tr>
<td>0x7f00 0001</td>
<td></td>
<td>æºç«¯IPåœ°å€127.0.0.1</td>
</tr>
<tr>
<td>0x7f00 0001</td>
<td></td>
<td>ç›®çš„ç«¯IPåœ°å€127.0.0.1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="IPåˆ†ç‰‡æŠ“åŒ…"><a href="#IPåˆ†ç‰‡æŠ“åŒ…" class="headerlink" title="IPåˆ†ç‰‡æŠ“åŒ…"></a>IPåˆ†ç‰‡æŠ“åŒ…</h2><p>ä¸Šé¢æŠ“åŒ…å¹¶æ²¡æœ‰è¿›è¡Œåˆ†ç‰‡ï¼Œæ‰€ä»¥ä¸ºäº†äº†è§£åˆ†ç‰‡ï¼Œè¿˜éœ€è¦è¿›è¡ŒæŠ“åŒ…ï¼ŒæŸ¥çœ‹åˆ†ç‰‡æƒ…å†µã€‚</p>
<p>è¿™æ¬¡ä½¿ç”¨pingå‘½ä»¤é…åˆ<code>tcpdump</code>è¿›è¡ŒæŠ“åŒ…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ping baidu.com -s 1473</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºä»¥å¤ªç½‘å¸§MTUæ˜¯1500å­—èŠ‚ï¼Œå› æ­¤å®ƒæ‰€æºå¸¦çš„IPæ•°æ®æŠ¥çš„<strong>æ•°æ®éƒ¨åˆ†</strong>æœ€å¤š1480å­—èŠ‚ï¼ˆIPå¤´éƒ¨å 20å­—èŠ‚ï¼‰ï¼Œç„¶è¿˜å› ä¸ºpingä½¿ç”¨çš„æ˜¯ICMPåè®®ï¼ŒICMPå¤´éƒ¨å 8å­—èŠ‚ï¼Œæ‰€ä»¥ICMPæ•°æ®éƒ¨åˆ†æœ€å¤šå 1472å­—èŠ‚ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨pingå‘½ä»¤å‘é€1473ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆè¿™ä¸ªIPæ•°æ®æŠ¥è‡ªç„¶è€Œç„¶çš„ä¼šè¿›è¡Œåˆ†ç‰‡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220806153303334.png" alt="image-20220806153303334"></p>
<p>ç„¶è¿˜ä½¿ç”¨</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">sudo</span> tcpdump -ntx -i eth0  icmp &gt; a.txt</span><br></pre></td></tr></table></figure>
<p>å°†æŠ“çš„åŒ…çš„å†…å®¹æ”¾åˆ°æ–‡ä»¶<code>a.txt</code>å½“ä¸­ã€‚</p>
<p>ç„¶åå»é™¤å…¶ä¸­æœ‰ç”¨çš„éƒ¨åˆ†å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IP 10.0.4.5 &gt; 110.242.68.66: ICMP echo request, id 25, seq 1, length 1480</span><br><span class="line">	0x0000:  4500 05dc a74e 2000 4001 ec99 0a00 0405</span><br><span class="line">	0x0010:  6ef2 4442 0800 2d22 0019 0001 4df3 ed62</span><br><span class="line">	0x0020:  0000 0000 7e4a 0400 0000 0000 1011 1213</span><br><span class="line">	0x0030:  1415 1617 1819 1a1b 1c1d 1e1f 2021 2223</span><br><span class="line">	...(æ•°æ®å¤ªå¤šä¸è¿›è¡Œå…¨éƒ¨å±•ç¤º)</span><br><span class="line">	</span><br><span class="line">IP 10.0.4.5 &gt; 110.242.68.66: ip-proto-1</span><br><span class="line">	0x0000:  4500 0015 a74e 00b9 4001 11a8 0a00 0405</span><br><span class="line">	0x0010:  6ef2 4442 c0</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°</p>
<p><strong>ç¬¬ä¸€ä¸ªåŒ…çš„IPå¤´éƒ¨</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IP 10.0.4.5 &gt; 110.242.68.66: ICMP echo request, id 25, seq 1, length 1480</span><br><span class="line">	0x0000:  4500 05dc a74e 2000 4001 ec99 0a00 0405</span><br><span class="line">	0x0010:  6ef2 4442 </span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>0x05dc</code>ä»£è¡¨IPæ•°æ®æŠ¥çš„æ€»é•¿åº¦ä¸º1500å­—èŠ‚</p>
<p>å…¶ä¸­<code>0X2000</code>æ˜¯3ä½æ ‡å¿—å­—æ®µå’Œ13ä½åˆ†ç‰‡åç§»ã€‚å®ƒçš„äºŒè¿›åˆ¶ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0010 0000 0000 0000</span><br></pre></td></tr></table></figure>
<p>æ ‡å¿—ä½ç¬¬ä¸‰ä½ï¼ˆMFï¼‰ä¸º1ï¼Œè¡¨ç¤ºæœ‰åˆ†ç‰‡ã€‚å› ä¸ºæ˜¯ä¸€ä¸ªåˆ†ç‰‡åŒ…æ‰€ä»¥åç§»ä¸º0</p>
<p><strong>ç¬¬äºŒä¸ª åŒ…çš„IPå¤´éƒ¨</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">IP 10.0.4.5 &gt; 110.242.68.66: ip-proto-1</span><br><span class="line">	0x0000:  4500 0015 a74e 00b9 4001 11a8 0a00 0405</span><br><span class="line">	0x0010:  6ef2 4442 </span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>0x0015</code>ä»£è¡¨IPæ•°æ®æŠ¥çš„æ€»é•¿åº¦ä¸º21å­—èŠ‚</p>
<p>å…¶ä¸­<code>0X00b9</code>æ˜¯3ä½æ ‡å¿—å­—æ®µå’Œ13ä½åˆ†ç‰‡åç§»ã€‚å®ƒçš„äºŒè¿›åˆ¶ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0000 0000 1011 1001</span><br></pre></td></tr></table></figure>
<p>å‰ä¸‰ä½æ ‡å¿—ä½éƒ½ä¸º0ï¼Œè¡¨ç¤ºè¿™æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡åŒ…ï¼Œ<code>0xb9</code>åè¿›åˆ¶æ˜¯271ï¼Œç„¶åå†ä¹˜ä»¥8ç­‰äº1480ï¼Œå³åç§»æ˜¯1480å­—èŠ‚ï¼Œä¹Ÿå’Œå‰é¢ä»‹ç»çš„ç‰‡åç§»å†…å®¹å»åˆã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>teeå‡½æ•°</title>
    <url>/2022/08/19/Linux/tee%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="teeå‡½æ•°"><a href="#teeå‡½æ•°" class="headerlink" title="teeå‡½æ•°"></a>teeå‡½æ•°</h1><p><code>tee</code>å‡½æ•°åœ¨ä¸¤ä¸ªç®¡é“æè¿°ç¬¦ä¹‹é—´å¤åˆ¶æ•°æ®ï¼Œä¹Ÿæ˜¯é›¶æ‹·è´æ“ä½œã€‚å®ƒä¸æ¶ˆè€—æ•°æ®ï¼Œå› æ­¤æºæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æ•°æ®ä»ç„¶å¯ä»¥ç”¨äºåç»­æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">tee</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">int</span> fd_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd_in</code>å’Œ<code>fd_out</code>æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯å¿…é¡»æ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>len</code>å‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦</p>
<p><code>flags</code>å‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼Œå®ƒå¯ä»¥è¢«è®¾ç½®ä¸ºä¸‹è¡¨ä¸­çš„æŸäº›å€¼çš„æŒ‰ä½æˆ–ï¼Œå®ƒçš„å‚æ•°å…¶å®å’Œ<code>splice</code>å‡½æ•°ç›¸åŒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100934412.png" alt="image-20220816100934412"></p>
<p><code>tee</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´å¤åˆ¶çš„æ•°æ®æ•°é‡ï¼ˆå­—èŠ‚æ•°)ã€‚è¿”å›0è¡¨ç¤ºæ²¡æœ‰å¤åˆ¶ä»»ä½•æ•°æ®ã€‚<code>tee</code>å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<span id="more"></span>
<p>ä¹¦ä¸­ä»£ç åˆ©ç”¨<code>tee</code>å‡½æ•°å’Œ<code>splice</code>å‡½æ•°ï¼Œå®ç°äº†Linux ä¸‹<code>tee</code>ç¨‹åºï¼ˆåŒæ—¶è¾“å‡ºæ•°æ®åˆ°ç»ˆç«¯å’Œæ–‡ä»¶çš„ç¨‹åºï¼Œä¸è¦å’Œ<code>tee</code>å‡½æ•°æ··æ·†ï¼‰çš„åŸºæœ¬åŠŸèƒ½ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;usage: %s &lt;file&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> filefd = open(argv[<span class="number">1</span>], O_CREAT | O_WRONLY | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">	assert(filefd &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pipefd_stdout[<span class="number">2</span>];</span><br><span class="line">	<span class="type">int</span> ret = pipe(pipefd_stdout);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pipefd_file[<span class="number">2</span>];</span><br><span class="line">	ret = pipe(pipefd_file);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// close( STDIN_FILENO );</span></span><br><span class="line">	<span class="comment">//  dup2( pipefd_stdout[1], STDIN_FILENO );</span></span><br><span class="line">	<span class="comment">// write( pipefd_stdout[1], &quot;abc\n&quot;, 4 );</span></span><br><span class="line">	ret = splice(STDIN_FILENO, <span class="literal">NULL</span>, pipefd_stdout[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = tee(pipefd_stdout[<span class="number">0</span>], pipefd_file[<span class="number">1</span>], <span class="number">32768</span>, SPLICE_F_NONBLOCK);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = splice(pipefd_file[<span class="number">0</span>], <span class="literal">NULL</span>, filefd, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = splice(pipefd_stdout[<span class="number">0</span>], <span class="literal">NULL</span>, STDOUT_FILENO, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	close(filefd);</span><br><span class="line">	close(pipefd_stdout[<span class="number">0</span>]);</span><br><span class="line">	close(pipefd_stdout[<span class="number">1</span>]);</span><br><span class="line">	close(pipefd_file[<span class="number">0</span>]);</span><br><span class="line">	close(pipefd_file[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816111052593.png" alt="image-20220816111052593"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿¡å·</title>
    <url>/2022/08/22/Linux/%E4%BF%A1%E5%8F%B7/</url>
    <content><![CDATA[<h1 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬åç« ä¿¡å·ï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­</p>
<p>Linuxä¿¡å·æ¦‚è¿°ã€ä¿¡å·é›†ã€ä¿¡å·å‡½æ•°å’Œä¸€äº›ç–‘æƒ‘ã€‚</p>
<span id="more"></span>
<h2 id="Linuxä¿¡å·æ¦‚è¿°"><a href="#Linuxä¿¡å·æ¦‚è¿°" class="headerlink" title="Linuxä¿¡å·æ¦‚è¿°"></a>Linuxä¿¡å·æ¦‚è¿°</h2><h3 id="å‘é€ä¿¡å·"><a href="#å‘é€ä¿¡å·" class="headerlink" title="å‘é€ä¿¡å·"></a>å‘é€ä¿¡å·</h3><p>Linux ä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹ç»™å…¶ä»–è¿›ç¨‹å‘é€ä¿¡å·çš„APIæ˜¯<code>kill</code>å‡½æ•°ã€‚å…¶å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°æŠŠä¿¡å·<code>sig</code>å‘é€ç»™ç›®æ ‡è¿›ç¨‹ï¼›ç›®æ ‡è¿›ç¨‹<code>pid</code>å‚æ•°æŒ‡å®šï¼Œå…¶å¯èƒ½çš„å–å€¼ä»¥åŠå«ä¹‰å¦‚è¡¨æ‰€å±•ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220822113352089.png" alt="image-20220822113352089"></p>
<p><code>Linux</code>å½“ä¸­ä¿¡å·éƒ½å¤§äº0ï¼Œå¦‚æœ<code>sig</code>å–å€¼ä¸º0ï¼Œåˆ™<code>kill</code>å‡½æ•°ä¸å‘é€ä»»ä½•ä¿¡å·ã€‚è¿™ç§æ–¹æ³•å¯ä»¥ç”¨æ¥æ£€æµ‹ç›®æ ‡è¿›ç¨‹æˆ–è¿›ç¨‹ç»„æ˜¯å¦å­˜åœ¨ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•æ˜¯ä¸å¯é çš„ï¼ˆè¿™ç§æ–¹æ³•ä¸æ˜¯åŸå­æ“ä½œï¼‰ã€‚</p>
<p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å‡ ç§å¯èƒ½çš„<code>errno</code>å¦‚è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220822114203553.png" alt="image-20220822114203553"></p>
<h3 id="ä¿¡å·å¤„ç†æ–¹å¼"><a href="#ä¿¡å·å¤„ç†æ–¹å¼" class="headerlink" title="ä¿¡å·å¤„ç†æ–¹å¼"></a>ä¿¡å·å¤„ç†æ–¹å¼</h3><p>åœ¨ç›®æ ‡è¿›ç¨‹æ”¶åˆ°ä¿¡æ¯æ—¶ï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥æ”¶å‡½æ•°æ¥å¤„ç†ã€‚ä¿¡å·å¤„ç†å‡½æ•°çš„åŸåˆ™å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Type of a signal handler.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">__sighandler_t</span>)</span> <span class="params">(<span class="type">int</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>ä¿¡å·å¤„ç†å‡½æ•°åªå¸¦æœ‰ä¸€ä¸ªæ•´å‹å‚æ•°ï¼Œè¯¥å‚æ•°ç”¨æ¥æŒ‡ç¤ºä¿¡å·ç±»å‹ã€‚ä¿¡å·å¤„ç†å‡½æ•°åº”è¯¥æ˜¯<strong>å¯é‡å…¥</strong>çš„ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¼•å‘ä¸€äº›ç«æ€æ¡ä»¶ã€‚æ‰€ä»¥åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­<strong>ä¸¥ç¦</strong>è°ƒç”¨ä¸€äº›ä¸å®‰å…¨çš„å‡½æ•°ã€‚</p>
<p>é™¤äº†ç”¨æˆ·è‡ªå·±å®šä¹‰ä¿¡å·å¤„ç†å‡½æ•°ä¹‹å¤–ï¼ŒLinuxå½“ä¸­è¿˜å®šä¹‰äº†ä¿¡æ¯å·çš„ä¸¤ç§å…¶ä»–å¤„ç†æ–¹å¼ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	SIG_DFL	 ((__sighandler_t)  0)	<span class="comment">/* Default action.  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	SIG_IGN	 ((__sighandler_t)  1)	<span class="comment">/* Ignore signal.  */</span></span></span><br></pre></td></tr></table></figure>
<p><code>SIG_IGN</code>è¡¨ç¤ºå¿½ç•¥ç›®æ ‡ä¿¡å·ï¼Œ<code>SIG_DFL</code>è¡¨ç¤ºä½¿ç”¨ä¿¡å·é»˜è®¤å¤„ç†æ–¹å¼ã€‚ä¿¡å·é»˜è®¤å¤„ç†æ–¹å¼æœ‰å¦‚ä¸‹å‡ ç§:ç»“æŸè¿›ç¨‹ï¼ˆTerm)ã€å¿½ç•¥ä¿¡å·(Ign)ã€ç»“æŸè¿›ç¨‹å¹¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶(Core)ã€æš‚åœè¿›ç¨‹ï¼ˆStop)ï¼Œä»¥åŠç»§ç»­è¿›ç¨‹ï¼ˆCont)ã€‚</p>
<h3 id="Linuxä¿¡å·"><a href="#Linuxä¿¡å·" class="headerlink" title="Linuxä¿¡å·"></a>Linuxä¿¡å·</h3><p>åœ¨linuxä¸Šï¼Œå¯ä»¥ä½¿ç”¨<code>kill -l</code>å‘½ä»¤çœ‹åˆ°æ‰€æœ‰çš„ä¿¡å·ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶ä¸å…³å¿ƒè¿™äº›æ‰€æœ‰çš„ä¿¡å·ï¼Œåªç”¨é‡ç‚¹å…³å¿ƒ<code>SIGHUP</code>ã€<code>SIGPIPE</code>ã€<code>SIGURG</code>ã€<code>SIGALRM</code>ã€<code>SIGCHLD</code>ç­‰å‡ ä¸ªä¿¡å·å³å¯ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>ä¿¡å·</th>
<th>èµ·æº</th>
<th>é»˜è®¤è¡Œä¸º</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>SIGHUP</code></td>
<td>POSIX</td>
<td>Term</td>
<td>æ§åˆ¶ç»ˆç«¯æŒ‚èµ·</td>
</tr>
<tr>
<td><code>SIGPIPE</code></td>
<td>POSIX</td>
<td>Term</td>
<td>å¾€è¯»ç«¯è¢«å…³é—­çš„ç®¡é“æˆ–è€…socketè¿æ¥ä¸­äº›æ•°æ®</td>
</tr>
<tr>
<td><code>SIGURG</code></td>
<td>4.2BSD</td>
<td>Ign</td>
<td>socketè¿æ¥ä¸Šæ¥æ”¶åˆ°ç´§æ€¥æ•°æ®</td>
</tr>
<tr>
<td><code>SIGALRM</code></td>
<td>POSIX</td>
<td>Term</td>
<td>ç”±alarm æˆ–setitimerè®¾ç½®çš„å®æ—¶é—¹é’Ÿè¶…æ—¶å¼•èµ·</td>
</tr>
<tr>
<td><code>SIGCHLD</code></td>
<td>POSIX</td>
<td>Ign</td>
<td>å­è¿›ç¨‹çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼ˆé€€å‡ºæˆ–è€…æš‚åœ)</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ä¿¡å·é›†"><a href="#ä¿¡å·é›†" class="headerlink" title="ä¿¡å·é›†"></a>ä¿¡å·é›†</h2><h3 id="ä¿¡å·é›†å‡½æ•°"><a href="#ä¿¡å·é›†å‡½æ•°" class="headerlink" title="ä¿¡å·é›†å‡½æ•°"></a>ä¿¡å·é›†å‡½æ•°</h3><p>ä¿¡å·é›†<code>sigset_t</code>çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _SIGSET_NWORDS (1024 / (8 * sizeof (unsigned long int)))</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> __val[_SIGSET_NWORDS];</span><br><span class="line">&#125; <span class="type">__sigset_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>ç”±è¯¥å®šä¹‰å¯è§ï¼Œ<code>sigset_t</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªé•¿æ•´å‹æ•°ç»„ï¼Œæ•°ç»„çš„æ¯ä¸ªå…ƒç´ çš„æ¯ä¸ªä½è¡¨ç¤ºä¸€ä¸ªä¿¡å·ï¼ˆè™½ç„¶ä¸çŸ¥é“ä¸ºå•¥å®šä¹‰å¤šä¸ªå…ƒç´ ï¼‰ã€‚è¿™ç§å®šä¹‰æ–¹å¼å’Œæ–‡ä»¶æè¿°ç¬¦é›†<code>fd_set</code>ç±»ä¼¼ã€‚<code>Linux</code>æä¾›äº†å¦‚ä¸‹ä¸€ç»„å‡½æ•°æ¥è®¾ç½®ã€ä¿®æ”¹ã€åˆ é™¤å’ŒæŸ¥è¯¢ä¿¡å·é›†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigemptyset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;						<span class="comment">/* æ¸…ç©ºä¿¡å·é›† */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;						<span class="comment">/* åœ¨ä¿¡å·é›†ä¸­è®¾ç½®æ‰€æœ‰çš„ä¿¡æ¯ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;			<span class="comment">/* å°†ä¿¡å·signumæ·»åŠ åˆ°ä¿¡å·é›†ä¸­ */</span>	</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;			<span class="comment">/* å°†ä¿¡å·signumä»åˆ°ä¿¡å·é›†ä¸­åˆ é™¤ */</span>	</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>;	<span class="comment">/* æµ‹è¯•ä¿¡å·signumæ˜¯å¦åœ¨ä¿¡å·é›†ä¸­ */</span>	</span><br></pre></td></tr></table></figure>
<h3 id="è¿›ç¨‹æ©ç "><a href="#è¿›ç¨‹æ©ç " class="headerlink" title="è¿›ç¨‹æ©ç "></a>è¿›ç¨‹æ©ç </h3><p>å†…æ ¸ä¼šä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªä¿¡å·æ©ç ï¼Œå³ä¸€ç»„ä¿¡å·ï¼Œå¹¶å°†<strong>é˜»å¡</strong>å…¶é’ˆå¯¹è¯¥è¿›ç¨‹çš„ä¼ é€’ã€‚å¦‚æœå°†é­<strong>é˜»å¡</strong>çš„ä¿¡å·å‘ç»™æŸè¿›ç¨‹ï¼Œé‚£ä¹ˆå¯¹è¯¥ä¿¡å·çš„ä¼ é€’å°†å»¶åï¼Œç›´è‡³ä»è¿›ç¨‹ä¿¡å·æ©ç ä¸­ç§»é™¤è¯¥ä¿¡å·ï¼Œä»è€Œè§£é™¤é˜»å¡ä¸ºæ­¢ã€‚ï¼ˆä¿¡å·æ©ç å®é™…å±äºçº¿ç¨‹å±æ€§ï¼Œåœ¨å¤šçº¿ç¨‹è¿›ç¨‹ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½å¯ä½¿ç”¨ pthread_sigmask() å‡½æ•°æ¥ç‹¬ç«‹æ£€æŸ¥å’Œä¿®æ”¹å…¶ä¿¡å·æ©ç ã€‚ï¼‰</p>
<p>ä¸‹é¢çš„å‡½æ•°å¯ä»¥ç”¨äºè®¾ç½®æˆ–æŸ¥çœ‹è¿›ç¨‹çš„ä¿¡å·æ©ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Prototype for the glibc wrapper function */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> how, <span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">sigset_t</span> *oldset)</span>;</span><br></pre></td></tr></table></figure>
<p><code>set</code>å‚æ•°æŒ‡å®šæ–°çš„ä¿¡å·æ©ç </p>
<p><code>oldset</code>å‚æ•°è¾“å‡ºåŸæ¥çš„ä¿¡å·æ©ç ï¼ˆä¸è¿‡ä¸ä¸ºNULLï¼‰</p>
<p>å¦‚æœ<code>set</code>å‚æ•°ä¸ä¸ºNULLï¼Œåˆ™<code>how</code>å‚æ•°æŒ‡å®šè®¾ç½®è¿›ç¨‹ä¿¡å·æ©ç çš„æ–¹å¼ï¼Œå…¶å¯é€‰å€¼å¦‚è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220825111927286.png" alt="image-20220825111927286"></p>
<p>å¦‚æœ<code>set</code>ä¸º NULLï¼Œåˆ™è¿›ç¨‹ä¿¡å·æ©ç ä¸å˜ï¼Œæ­¤æ—¶æˆ‘ä»¬ä»ç„¶å¯ä»¥åˆ©ç”¨<code>oldset</code>å‚æ•°æ¥è·å¾—è¿›ç¨‹å½“å‰çš„ä¿¡å·æ©ç ã€‚</p>
<p><code>sigprocmask</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<h3 id="è¢«æŒ‚èµ·çš„ä¿¡å·"><a href="#è¢«æŒ‚èµ·çš„ä¿¡å·" class="headerlink" title="è¢«æŒ‚èµ·çš„ä¿¡å·"></a>è¢«æŒ‚èµ·çš„ä¿¡å·</h3><p>è®¾ç½®è¿›ç¨‹ä¿¡å·æ©ç åï¼Œè¢«å±è”½çš„ä¿¡å·å°†ä¸èƒ½è¢«è¿›ç¨‹æ¥æ”¶ã€‚å¦‚æœç»™è¿›ç¨‹å‘é€ä¸€ä¸ªè¢«å±è”½çš„ä¿¡å·ï¼Œåˆ™æ“ä½œç³»ç»Ÿå°†è¯¥ä¿¡å·è®¾ç½®ä¸ºè¿›ç¨‹çš„ä¸€ä¸ª<strong>è¢«æŒ‚èµ·çš„ä¿¡å·</strong>ã€‚å¦‚æœæˆ‘ä»¬å–æ¶ˆå¯¹è¢«æŒ‚èµ·ä¿¡å·çš„å±è”½ï¼Œåˆ™å®ƒèƒ½ç«‹å³è¢«è¿›ç¨‹æ¥æ”¶åˆ°ã€‚å¦‚ä¸‹å‡½æ•°å¯ä»¥è·å¾—è¿›ç¨‹å½“å‰è¢«æŒ‚èµ·çš„ä¿¡å·é›†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigpending</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br></pre></td></tr></table></figure>
<p><code>set</code>ç”¨äºä¿å­˜è¢«æŒ‚èµ·çš„ä¿¡å·é›†ã€‚</p>
<p><code>sigpending</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>è¿›ç¨‹<strong>å¤šæ¬¡</strong>æ¥æ”¶åˆ°åŒä¸€ä¸ªè¢«æŒ‚èµ·çš„ä¿¡å·,<code>sigpending</code>å‡½æ•°ä¹Ÿåªèƒ½åæ˜ ä¸€æ¬¡ã€‚å¹¶ä¸”ï¼Œå½“æˆ‘ä»¬å†æ¬¡ä½¿ç”¨<code>sigprocmask</code><strong>ä½¿èƒ½</strong>è¯¥æŒ‚èµ·çš„ä¿¡å·æ—¶ï¼Œè¯¥ä¿¡å·çš„å¤„ç†å‡½æ•°ä¹Ÿåªè¢«è§¦å‘ä¸€æ¬¡ã€‚</p>
<p>ä¿¡å·é›†è¿™å‡ ä¸ªå‡½æ•°<strong>ä¸¾ä¾‹</strong>ï¼š</p>
<p>æˆ‘ä»¬ä»¥<code>SIGINT</code>å’Œ<code>SIGQUIT</code>ä¸ºä¾‹ï¼Œå°±æ˜¯é”®ç›˜ä¸ŠæŒ‰ä¸‹ï¼ˆCtrl+Cï¼‰å’Œï¼ˆCtrl+\ï¼‰ä¸ºä¾‹ã€‚</p>
<p>é€šè¿‡<code>sigprocmask</code>è®¾ç½®è¿™ä¸¤ä¸ªä¿¡å·è¢«æŒ‚èµ·ï¼Œç„¶ååˆ†åˆ«æŒ‰ä¸‹ï¼ˆCtrl+Cï¼‰å’Œï¼ˆCtrl+\ï¼‰ï¼Œå†é€šè¿‡<code>sigpending</code>æŸ¥çœ‹é‚£äº›è¿›ç¨‹è¢«æŒ‚èµ·ï¼ˆè¿™ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡<code>kill</code>æ€æ­»ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220825181937952.png" alt="image-20220825181937952"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printset</span><span class="params">(<span class="type">sigset_t</span> *ped)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">32</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((sigismember(ped, i) == <span class="number">1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">sigset_t</span> <span class="built_in">set</span>, oldset, ped;</span><br><span class="line">    sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGINT);</span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGQUIT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;<span class="built_in">set</span>, &amp;oldset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è¿›ç¨‹ä¿¡å·æ©ç :&quot;</span>);</span><br><span class="line">    printset(&amp;<span class="built_in">set</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sigpending(&amp;ped); <span class="comment">//è·å–ä¿¡å·é›†</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;è¢«æŒ‚èµ·çš„ä¿¡å·æ©ç :&quot;</span>);</span><br><span class="line">        printset(&amp;ped);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220825215756905.png" alt="image-20220825215756905"></p>
<h2 id="ä¿¡å·å‡½æ•°"><a href="#ä¿¡å·å‡½æ•°" class="headerlink" title="ä¿¡å·å‡½æ•°"></a>ä¿¡å·å‡½æ•°</h2><p>å¤„ç†æˆ–è€…è¯´æ•æ‰ä¿¡å·çš„å‡½æ•°æœ‰<code>signal</code>å’Œ<code>sigaction</code></p>
<h3 id="signalç³»ç»Ÿè°ƒç”¨"><a href="#signalç³»ç»Ÿè°ƒç”¨" class="headerlink" title="signalç³»ç»Ÿè°ƒç”¨"></a>signalç³»ç»Ÿè°ƒç”¨</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sighandler_t</span>)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">sighandler_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sighandler_t</span> handler)</span>;</span><br></pre></td></tr></table></figure>
<p><code>signum</code>å‚æ•°æŒ‡å‡ºè¦æ•è·çš„ä¿¡å·ç±»å‹ã€‚</p>
<p><code>handler</code>å‚æ•°æ˜¯<code>sighandler_t</code>ç±»å‹çš„å‡½æ•°æŒ‡é’ˆï¼Œç”¨äºæŒ‡å®šä¿¡å·<code>signum</code>çš„å¤„ç†å‡½æ•°ã€‚</p>
<p><code>signal</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¯¥å‡½æ•°æŒ‡é’ˆçš„ç±»å‹ä¹Ÿæ˜¯<code>sighandler_t</code>ã€‚è¿™ä¸ªè¿”å›å€¼æ˜¯å‰ä¸€æ¬¡è°ƒç”¨<code>signal</code>å‡½æ•°æ—¶ä¼ å…¥çš„å‡½æ•°æŒ‡é’ˆï¼Œæˆ–è€…æ˜¯ä¿¡å·<code>signum</code>å¯¹åº”çš„é»˜è®¤å¤„ç†å‡½æ•°æŒ‡é’ˆ<code>SIG_DEF</code>ï¼ˆå¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨<code>signal</code>çš„è¯)ã€‚</p>
<p><code>signal</code>ç³»ç»Ÿè°ƒç”¨å‡ºé”™æ—¶è¿”å›<code>SIG_ERR</code>ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	SIG_ERR	 ((__sighandler_t) -1)	<span class="comment">/* Error return.  */</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_sig</span><span class="params">(<span class="type">int</span> a)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hi, SIGINT, how do you do !\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®SIGINTä¿¡å·ï¼ˆctrl+Cï¼‰å¯¹åº”çš„äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (signal(SIGINT, do_sig) == SIG_ERR)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;signal&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---------------------\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220825182345010.png" alt="image-20220825182345010"></p>
<p>å¯ä»¥çœ‹çš„æŒ‰ä¸‹<code>ctrl+c</code>ä¹‹åæ˜¯æ€ä¸æ­»è¿™ä¸ªè¿›ç¨‹çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡â€œctrl+\â€æˆ–è€…å…³é—­shellæˆ–è€…é€šè¿‡killå‘½ä»¤è¿›è¡Œæ€æ­»ã€‚</p>
<h3 id="sigactionç³»ç»Ÿå‡½æ•°"><a href="#sigactionç³»ç»Ÿå‡½æ•°" class="headerlink" title="sigactionç³»ç»Ÿå‡½æ•°"></a>sigactionç³»ç»Ÿå‡½æ•°</h3><p>è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°æ›´ä¸ºå¥å£®çš„æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *act, <span class="keyword">struct</span> sigaction *oldact)</span>;</span><br></pre></td></tr></table></figure>
<p><code>signum</code>å‚æ•°æŒ‡å‡ºè¦æ•è·çš„ä¿¡å·ç±»å‹</p>
<p><code>act</code>å‚æ•°æŒ‡å®šæ–°çš„ä¿¡å·å¤„ç†æ–¹å¼</p>
<p><code>oldact</code>å‚æ•°è¾“å‡ºä¿¡å·ä¹‹å‰å¤„ç†çš„æ–¹å¼ï¼ˆå¦‚æœä¸ä¸ºNULLçš„è¯ï¼‰ã€‚</p>
<p><code>act</code>å’Œ<code>oldact</code>éƒ½æ˜¯<code>sigaction</code>ç»“æ„ä½“ç±»å‹çš„æŒ‡é’ˆï¼Œ<code>sigaction</code>ç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">   <span class="type">void</span>     (*sa_handler)(<span class="type">int</span>);</span><br><span class="line">   <span class="type">void</span>     (*sa_sigaction)(<span class="type">int</span>, <span class="type">siginfo_t</span> *, <span class="type">void</span> *);</span><br><span class="line">   <span class="type">sigset_t</span>   sa_mask;</span><br><span class="line">   <span class="type">int</span>        sa_flags;</span><br><span class="line">   <span class="type">void</span>     (*sa_restorer)(<span class="type">void</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¯¥ç»“æ„ä½“ä¸­çš„<code>sa_handler</code>æˆå‘˜æŒ‡å®šä¿¡å·å¤„ç†å‡½æ•°ã€‚</p>
<p><code>sa_mask</code>æˆå‘˜è®¾ç½®è¿›ç¨‹çš„ä¿¡å·æ©ç (ç¡®åˆ‡åœ°è¯´æ˜¯åœ¨è¿›ç¨‹åŸæœ‰ä¿¡å·æ©ç çš„åŸºç¡€ä¸Š<strong>å¢åŠ </strong>ä¿¡å·æ©ç )ï¼Œä»¥æŒ‡å®šå“ªäº›ä¿¡å·<strong>ä¸èƒ½</strong>å‘é€ç»™æœ¬è¿›ç¨‹ã€‚<code>sa_mask</code>æ˜¯ä¿¡å·é›†<code>sigset_t</code>(<code>_sigset_t</code>çš„åŒä¹‰è¯ï¼‰ç±»å‹ï¼Œè¯¥ç±»å‹æŒ‡å®šä¸€ç»„ä¿¡å·ã€‚</p>
<p><code>sa_flags</code>æˆå‘˜ç”¨äºè®¾ç½®ç¨‹åºæ”¶åˆ°ä¿¡å·æ—¶çš„è¡Œä¸ºï¼Œå…¶å¯é€‰å€¼å¦‚è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220824165327097.png" alt="image-20220824165327097"></p>
<p><code>sa_restorer</code>æˆå‘˜å·²ç»è¿‡æ—¶ï¼Œæœ€å¥½ä¸è¦ä½¿ç”¨ã€‚</p>
<p><code>sigaction</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>sigaction</code>ä¸­æœ‰ä¿¡å·é›†ï¼Œæ‰€ä»¥æœ€å¥½é…åˆä¿¡å·é›†å‡½æ•°ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>ç®€å•æ˜¯ä½¿ç”¨ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*è‡ªå®šä¹‰çš„ä¿¡å·æ•æ‰å‡½æ•°*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_int</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;catch signal SIGINT\n&quot;</span>); <span class="comment">//å•æ¬¡æ‰“å°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line"></span><br><span class="line">	act.sa_handler = sig_int;</span><br><span class="line">	act.sa_flags = <span class="number">0</span>;</span><br><span class="line">	sigemptyset(&amp;act.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line"></span><br><span class="line">	sigaction(SIGINT, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---------------------\n&quot;</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220826155323696.png" alt="image-20220826155323696"></p>
<h2 id="ä¸€äº›ç–‘æƒ‘"><a href="#ä¸€äº›ç–‘æƒ‘" class="headerlink" title="ä¸€äº›ç–‘æƒ‘"></a>ä¸€äº›ç–‘æƒ‘</h2><p>ç¬¬ä¸€ä¸ªç–‘æƒ‘æ˜¯è¿›ç¨‹åœ¨å¤„ç†ä¸€ä¸ªä¿¡å·çš„è¿‡ç¨‹ä¸­ï¼Œèƒ½æ¥æ”¶å¦ä¸€ä¸ªä¿¡å·å—ï¼Ÿ</p>
<p>ç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä¸‹é¢çš„ä»£ç æ¥æ”¶äº†ä¸¤ä¸ª<code>SIGINT</code>å’Œ<code>SIGQUIT</code>ä¸¤ä¸ªä¿¡å·ï¼Œåœ¨æŒ‰ä¸‹ï¼ˆCtrl+Cï¼‰åç«‹åˆ»æŒ‰ä¸‹ï¼ˆCtrl+\ï¼‰ï¼Œéƒ½èƒ½è¿›è¡Œè¾“å‡ºï¼Œè¯´æ˜è¿›ç¨‹åœ¨å¤„ç†ä¸€ä¸ªä¿¡å·çš„è¿‡ç¨‹ä¸­ï¼Œèƒ½æ¥æ”¶å¦ä¸€ä¸ªä¿¡å·</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*è‡ªå®šä¹‰çš„ä¿¡å·æ•æ‰å‡½æ•°*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_int</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;catch signal SIGINT\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">10</span>); <span class="comment">//æ¨¡æ‹Ÿä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå¾ˆé•¿æ—¶é—´</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;end of SIGINT handler\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_quit</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;catch signal SIGQUIT\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">10</span>); <span class="comment">//æ¨¡æ‹Ÿä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå¾ˆé•¿æ—¶é—´</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;end of SIGQUIT handler\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act1</span>, <span class="title">act2</span>;</span></span><br><span class="line"></span><br><span class="line">    act1.sa_handler = sig_int;</span><br><span class="line">    sigemptyset(&amp;act1.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line">    act1.sa_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    act2.sa_handler = sig_quit;</span><br><span class="line">    sigemptyset(&amp;act2.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line">    act2.sa_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sigaction(SIGINT, &amp;act1, <span class="literal">NULL</span>);  <span class="comment">//æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    sigaction(SIGQUIT, &amp;act2, <span class="literal">NULL</span>); <span class="comment">//æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---------------------\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220826161922094.png" alt="image-20220826161922094"></p>
<p>ç¬¬äºŒä¸ªç–‘æƒ‘æ˜¯ä¿¡å·åœ¨å¤„ç†ä¸€ä¸ªä¿¡å·çš„è¿‡ç¨‹ä¸­ï¼Œä¼šé˜»å¡ï¼ˆæŒ‚èµ·ï¼‰è¿™ä¸ªä¿¡å·å—ï¼Ÿ</p>
<p>ä¸ªäººæ„Ÿè§‰æ˜¯é˜»å¡äº†è¿™ä¸ªä¿¡å·çš„ã€‚ä¹Ÿå°±æ˜¯ç¬¬1ä¸ªä¿¡å·åœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæ”¶åˆ°å†å¤šè¿™ä¸ªä¿¡å·ä¹Ÿæ˜¯ä¸ä¼šè¿›è¡Œå¤„ç†çš„ï¼ŒçŸ¥é“ç¬¬2ä¸ªä¿¡å·å¤„ç†å®Œæ¯•ï¼Œåé¢çš„ç¬¬2åˆ°nä¸ªä¿¡å·å½“ä½œä¸€æ¬¡ä¿¡å·è¿›è¡Œå¤„ç†ï¼ˆè¿™é‡Œçš„ä¿¡å·æŒ‡ç›¸åŒä¸€ç§ä¿¡æ¯ï¼‰ã€‚</p>
<p>æˆ‘ä»¬ä»¥<code>SIGINT</code>ä¸ºä¾‹ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹ï¼ˆCtrl+Cï¼‰åï¼Œ<code>SIGINT</code>ä¿¡å·çš„å›è°ƒå‡½æ•°åœ¨è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬ç–¯ç‹‚çš„æŒ‰ï¼ˆCtrl+Cï¼‰ï¼Œæœ€ç»ˆåç»­çš„<code>SIGINT</code>ä¿¡æ¯åªå½“ä½œä¸€æ¬¡ä¿¡æ¯è¿›è¡Œå¤„ç†äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*è‡ªå®šä¹‰çš„ä¿¡å·æ•æ‰å‡½æ•°*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_int</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;catch signal SIGINT\n&quot;</span>);</span><br><span class="line">	sleep(<span class="number">5</span>); <span class="comment">//æ¨¡æ‹Ÿä¿¡å·å¤„ç†å‡½æ•°æ‰§è¡Œå¾ˆé•¿æ—¶é—´</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;end of SIGINT handler\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">	act.sa_handler = sig_int;</span><br><span class="line">	sigemptyset(&amp;act.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line">	act.sa_flags = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	sigaction(SIGINT, &amp;act, <span class="literal">NULL</span>); <span class="comment">//æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---------------------\n&quot;</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220826163813060.png" alt="image-20220826163813060"></p>
<p>ç¬¬ä¸‰ä¸ªç–‘æƒ‘æ˜¯ä¿¡å·è¢«å±è”½ä¹‹åï¼Œæˆ‘ä»¬å¤šæ¬¡å‘é€è¯¥ä¿¡å·ï¼Œä¿¡å·è¢«æŒ‚èµ·äº†ï¼Œå†â€œè§£æŒ‚â€æˆ–è€…å«å–æ¶ˆå±è”½æƒ…å†µä¼šå¦‚ä½•ï¼Ÿ</p>
<p>å®é™…æƒ…å†µæ˜¯ï¼Œå–æ¶ˆå±è”½ååªä¼šæ‰§è¡Œä¸€æ¬¡ä¿¡å·å¤„ç†ï¼Œåç»­çš„ä¿¡å·å¤„ç†å’Œæ™®é€šä¿¡å·å¤„ç†ç›¸åŒã€‚</p>
<p>æˆ‘ä»¬ä»¥<code>SIGINT</code>ä¸ºä¾‹ï¼Œå…ˆå±è”½<code>SIGINT</code>è¿™ä¸ªä¿¡æ¯ï¼Œåœ¨æ­¤æœŸé—´æˆ‘ä»¬ä¸åœçš„å‘ä¿¡æ¯ï¼Œåç»­å–æ¶ˆå±è”½åï¼Œä¿¡å·çš„å›è°ƒå‡½æ•°è¢«å¤„ç†äº†ä¸€æ¬¡ã€‚å†åç»­çš„ä¿¡æ¯å¤„ç†å’Œæ™®é€šä¿¡å·ç±»ä¼¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*è‡ªå®šä¹‰çš„ä¿¡å·æ•æ‰å‡½æ•°*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sig_int</span><span class="params">(<span class="type">int</span> signo)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;catch signal SIGINT\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">	act.sa_handler = sig_int;</span><br><span class="line">	sigemptyset(&amp;act.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line">	act.sa_flags = <span class="number">0</span>;</span><br><span class="line">	sigaction(SIGINT, &amp;act, <span class="literal">NULL</span>); <span class="comment">//æ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">	<span class="type">sigset_t</span> <span class="built_in">set</span>, oldset, ped;</span><br><span class="line">	sigemptyset(&amp;<span class="built_in">set</span>);</span><br><span class="line">	sigaddset(&amp;<span class="built_in">set</span>, SIGINT); <span class="comment">// å°†SIGINTè¿›è¡Œå±è”½</span></span><br><span class="line">	sigprocmask(SIG_BLOCK, &amp;<span class="built_in">set</span>, &amp;oldset);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;-----begin sleep 10s--\n&quot;</span>);</span><br><span class="line">	sleep(<span class="number">10</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;-----end sleep 10s--\n&quot;</span>);</span><br><span class="line">	sigprocmask(SIG_UNBLOCK, &amp;<span class="built_in">set</span>, &amp;oldset);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;---------------------\n&quot;</span>);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220826165823734.png" alt="image-20220826165823734"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•</title>
    <url>/2022/08/21/Linux/%E6%94%B9%E5%8F%98%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%92%8C%E6%A0%B9%E7%9B%AE%E5%BD%95/</url>
    <content><![CDATA[<h1 id="æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•"><a href="#æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•" class="headerlink" title="æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•"></a>æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•</h1><p>è¿›ç¨‹æœ‰å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•ã€‚</p>
<p>å·¥ä½œç›®å½•ï¼šè¿›ç¨‹åœ¨å“ªä¸ªè·¯å¾„ä¸‹è¢«è¿è¡Œèµ·æ¥å“ªä¸ªè·¯å¾„å°±æ˜¯è¿›ç¨‹çš„å·¥ä½œç›®å½•(Current Woring Directory, CWD)</p>
<p>æ ¹ç›®å½•ï¼šå°±æ˜¯â€/â€œ</p>
<p>å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•å¯ä»¥é€šè¿‡<code>/proc/PID/cwd</code>å’Œ<code>/proc/PID/root</code>è¿›è¡ŒæŸ¥çœ‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821175748810.png" alt="image-20220821175748810"></p>
<span id="more"></span>
<p>å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•éƒ½å¯ä»¥è¿›è¡Œæ›´æ”¹ï¼Œè·å–è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•å’Œæ”¹å˜è¿›ç¨‹å·¥ä½œç›®å½•çš„å‡½æ•°åˆ†åˆ«æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">getcwd</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br></pre></td></tr></table></figure>
<p><code>buf</code>å‚æ•°æŒ‡å‘çš„å†…å­˜ç”¨äºå­˜å‚¨è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•çš„ç»å¯¹è·¯å¾„åï¼Œå…¶å¤§å°ç”±<code>size</code>å‚æ•°æŒ‡å®šã€‚</p>
<p>å¦‚æœå½“å‰å·¥ä½œç›®å½•çš„ç»å¯¹è·¯å¾„çš„é•¿åº¦ï¼ˆå†åŠ ä¸Šä¸€ä¸ªç©ºç»“æŸå­—ç¬¦â€œ\0â€)è¶…è¿‡äº†<code>size</code>ï¼Œåˆ™<code>getcwd</code>å°†è¿”å›<code>NULL</code>ï¼Œå¹¶è®¾ç½®<code>errno</code>ä¸º<code>ERANGE</code>ã€‚</p>
<p>å¦‚æœ<code>buf</code>ä¸º<code>NULL</code>å¹¶ä¸”<code>size</code>é0ï¼Œåˆ™<code>getcwd</code>å¯èƒ½åœ¨å†…éƒ¨ä½¿ç”¨<code>malloc</code>åŠ¨æ€åˆ†é…å†…å­˜ï¼Œå¹¶å°†è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•å­˜å‚¨åœ¨å…¶ä¸­ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œåˆ™æˆ‘ä»¬å¿…é¡»è‡ªå·±æ¥é‡Šæ”¾<code>getcwd</code>åœ¨å†…éƒ¨åˆ›å»ºçš„è¿™å—å†…å­˜ã€‚</p>
<p><code>getcwd</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæŒ‡å‘ç›®æ ‡å­˜å‚¨åŒºï¼ˆ<code>buf</code>æŒ‡å‘çš„ç¼“å­˜åŒºæˆ–æ˜¯<code>getcwd</code>åœ¨å†…éƒ¨åŠ¨æ€åˆ›å»ºçš„ç¼“å­˜åŒºï¼‰çš„æŒ‡é’ˆï¼Œå¤±è´¥åˆ™è¿”å›<code>NULL</code>å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>chdir</code>å‡½æ•°çš„<code>path</code>å‚æ•°æŒ‡å®šè¦åˆ‡æ¢åˆ°çš„ç›®æ ‡ç›®å½•ã€‚å®ƒæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æ”¹å˜è¿›ç¨‹æ ¹ç›®å½•å¯ä»¥ä½¿ç”¨<code>chroot</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">chroot</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br></pre></td></tr></table></figure>
<p><code>path</code>å‚æ•°æŒ‡å®šè¦åˆ‡æ¢åˆ°çš„ç›®æ ‡æ ¹ç›®å½•ã€‚å®ƒæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>chroot</code><strong>å¹¶ä¸æ”¹å˜</strong>è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ã€‚</p>
<p>æ”¹å˜è¿›ç¨‹çš„æ ¹ç›®å½•ä¹‹åï¼Œç¨‹åºå¯èƒ½æ— æ³•è®¿é—®ç±»ä¼¼<code>/dev</code>çš„æ–‡ä»¶ï¼ˆå’Œç›®å½•)ï¼Œå› ä¸ºè¿™äº›æ–‡ä»¶ï¼ˆå’Œç›®å½•ã€‰å¹¶éå¤„äºæ–°çš„æ ¹ç›®å½•ä¹‹ä¸‹ã€‚ä¸è¿‡å¥½åœ¨è°ƒç”¨<code>chroot</code>ä¹‹åï¼Œè¿›ç¨‹åŸå…ˆæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¾ç„¶ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™äº›æ—©å…ˆæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ¥è®¿é—®è°ƒç”¨<code>chroot</code>ä¹‹åä¸èƒ½ç›´æ¥è®¿é—®çš„æ–‡ä»¶ï¼ˆå’Œç›®å½•)ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ—¥å¿—æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œåªæœ‰<strong>ç‰¹æƒè¿›</strong>ç¨‹æ‰èƒ½æ”¹å˜æ ¹ç›®å½•ã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>è¿›ç¨‹é—´å…³ç³»</title>
    <url>/2022/08/21/Linux/%E8%BF%9B%E7%A8%8B%E9%97%B4%E5%85%B3%E7%B3%BB/</url>
    <content><![CDATA[<h1 id="è¿›ç¨‹é—´å…³ç³»"><a href="#è¿›ç¨‹é—´å…³ç³»" class="headerlink" title="è¿›ç¨‹é—´å…³ç³»"></a>è¿›ç¨‹é—´å…³ç³»</h1><h3 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h3><p>Linuxä¸‹æ¯ä¸ªè¿›ç¨‹éƒ½éš¶å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå› æ­¤å®ƒä»¬é™¤äº†PIDä¿¡æ¯å¤–ï¼Œè¿˜æœ‰è¿›ç¨‹ç»„ID(<code>PGID</code>)ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‡½æ•°æ¥è·å–æŒ‡å®šè¿›ç¨‹<code>PGID</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›è¿›ç¨‹pidæ‰€å±è¿›ç¨‹ç»„çš„<code>PGID</code>ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰ä¸€ä¸ªé¦–é¢†è¿›ç¨‹ï¼Œå…¶<code>PGID</code>å’Œ<code>PID</code>ç›¸åŒã€‚è¿›ç¨‹ç»„å°†ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å…¶ä¸­æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºï¼Œæˆ–è€…åŠ å…¥åˆ°å…¶ä»–è¿›ç¨‹ç»„ã€‚ä¸‹é¢çš„å‡½æ•°ç”¨äºè®¾ç½®<code>PGID</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setpgid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">pid_t</span> pgid)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°å°†<code>PID</code>ä¸º<code>pid</code>çš„è¿›ç¨‹çš„<code>PGID</code>è®¾ç½®ä¸º<code>pgid</code>ã€‚</p>
<p>å¦‚æœ<code>pid</code>å’Œ <code>pgid</code>ç›¸åŒï¼Œåˆ™ç”±<code>pid</code>æŒ‡å®šçš„è¿›ç¨‹å°†è¢«è®¾ç½®ä¸ºè¿›ç¨‹ç»„é¦–é¢†ï¼›</p>
<p>å¦‚æœ<code>pid</code>ä¸º0ï¼Œåˆ™è¡¨ç¤ºè®¾ç½®å½“å‰è¿›ç¨‹çš„<code>PGID</code>ä¸º<code>pgid</code>ï¼›</p>
<p>å¦‚æœ<code>pgid</code>ä¸º0ï¼Œåˆ™ä½¿ç”¨<code>pid</code>ä½œä¸ºç›®æ ‡<code>PGID</code>ã€‚</p>
<p><code>setpgid</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>.</p>
<p>ä¸€ä¸ªè¿›ç¨‹åªèƒ½è®¾ç½®<strong>è‡ªå·±</strong>æˆ–è€…<strong>å…¶å­è¿›ç¨‹</strong>çš„<code>PGID</code>ã€‚å¹¶ä¸”ï¼Œå½“å­è¿›ç¨‹è°ƒç”¨<code>exec</code>ç³»åˆ—å‡½æ•°åï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½å†åœ¨çˆ¶è¿›ç¨‹ä¸­å¯¹å®ƒè®¾ç½®<code>PGID</code>ã€‚</p>
<span id="more"></span>
<h3 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h3><p>ä¸€äº›æœ‰å…³è”çš„è¿›ç¨‹ç»„å°†å½¢æˆä¸€ä¸ªä¼šè¯(session)ã€‚ä¸‹é¢çš„å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä¼šè¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">setsid</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥è¿›ç¨‹ä¸èƒ½ç”±<strong>è¿›ç¨‹ç»„çš„é¦–é¢†</strong>è¿›ç¨‹è¿›è¡Œè°ƒç”¨ï¼Œä¼šæŠ¥é”™ã€‚</p>
<p>å¯¹äºéè¿›ç¨‹ç»„é¦–é¢†çš„è¿›ç¨‹ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¸ä»…åˆ›å»ºæ–°ä¼šè¯ï¼Œè¿˜ä¼šï¼š</p>
<ul>
<li>è°ƒç”¨è¿›ç¨‹æˆä¸ºä¼šè¯çš„é¦–é¢†ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹æ˜¯æ–°ä¼šè¯çš„å”¯ä¸€æˆå‘˜ã€‚</li>
<li>æ–°å»ºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå…¶<code>PGID</code>å°±æ˜¯è°ƒç”¨è¿›ç¨‹çš„<code>PID</code>ï¼Œè°ƒç”¨è¿›ç¨‹æˆä¸ºè¯¥ç»„çš„é¦–é¢†ã€‚</li>
<li>è°ƒç”¨è¿›ç¨‹å°†å¤±å»ç»ˆç«¯</li>
</ul>
<p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›æ–°çš„è¿›ç¨‹ç»„çš„<code>PGID</code>ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>Linuxè¿›ç¨‹å¹¶æœªæä¾›æ‰€è°“<strong>ä¼šè¯ID (SIDï¼‰</strong>çš„æ¦‚å¿µï¼Œä½†Linuxç³»ç»Ÿè®¤ä¸ºå®ƒç­‰äº<strong>ä¼šè¯é¦–é¢†</strong>æ‰€åœ¨çš„<strong>è¿›ç¨‹ç»„çš„PGID</strong>ï¼Œå¹¶æä¾›äº†å¦‚ä¸‹å‡½æ•°æ¥è¯»å–<code>SID</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getsid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»"><a href="#ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»" class="headerlink" title="ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»"></a>ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»</h3><p>åœ¨ç»ˆç«¯è¾“å…¥</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -o pid,ppid,pgid,sid,comm | less</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821164503929.png" alt="image-20220821164503929"></p>
<p>å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾</p>
<p>ä»å•ç‹¬çš„è¿›ç¨‹è§’åº¦çœ‹ï¼Œzshæ˜¯pså’Œlessçš„çˆ¶è¿›ç¨‹</p>
<p>ä»ç»„çš„è§’åº¦çœ‹ï¼Œzshæ˜¯ä¸€ä¸ªç»„ï¼ˆç»„é‡Œé¢åªæœ‰zshï¼Œæ‰€ä»¥zshæ˜¯è¿›ç¨‹ç»„é¦–é¢†ï¼‰ï¼Œpså’Œlessæ˜¯ä¸€ä¸ªç»„ï¼ˆpsæ˜¯è¿›ç¨‹ç»„é¦–é¢†ï¼‰</p>
<p>ä»ä¼šè¯çš„è§’åº¦çœ‹ï¼Œä¼šè¯é‡Œé¢æœ‰ä¸¤ä¸ªå…³è”çš„è¿›ç¨‹ç»„ï¼Œå…¶å®zshæ˜¯ä¼šè¯çš„é¦–é¢†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821165830395.png" alt="image-20220821165830395"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ç³»ç»Ÿç›‘æµ‹å·¥å…·</title>
    <url>/2022/09/29/Linux/%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%B5%8B%E5%B7%A5%E5%85%B7/</url>
    <content><![CDATA[<h1 id="ç³»ç»Ÿæ£€æµ‹å·¥å…·"><a href="#ç³»ç»Ÿæ£€æµ‹å·¥å…·" class="headerlink" title="ç³»ç»Ÿæ£€æµ‹å·¥å…·"></a>ç³»ç»Ÿæ£€æµ‹å·¥å…·</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬åä¸ƒç« å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œé‡Œé¢ä»‹ç»äº†å„ç§Linuxä¸­æä¾›ç»™å¼€å‘äººå‘˜è°ƒè¯•å’Œæµ‹è¯„çš„æœåŠ¡å™¨ç¨‹åºï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚</p>
<span id="more"></span>
<h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><p><code>tcpdump</code>æ˜¯ä¸€æ¬¾ç»å…¸çš„ç½‘ç»œæŠ“åŒ…å·¥å…·ã€‚<code>tcpdump</code>ç»™ä½¿ç”¨è€…æä¾›äº†å¤§é‡çš„é€‰é¡¹ï¼Œç”¨ä»¥è¿‡æ»¤æ•°æ®åŒ…æˆ–è€…å®šåˆ¶è¾“å‡ºæ ¼å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	-n,ä½¿ç”¨IPåœ°å€è¡¨ç¤ºä¸»æœºï¼Œè€Œä¸æ˜¯ä¸»æœºå;ä½¿ç”¨æ•°å­—è¡¨ç¤ºç«¯å£å·ï¼Œè€Œä¸æ˜¯æœåŠ¡åç§°ã€‚</span><br><span class="line">-i,æŒ‡å®šè¦ç›‘å¬çš„ç½‘å¡æ¥å£ã€‚â€œ-i anyâ€è¡¨ç¤ºæŠ“å–æ‰€æœ‰ç½‘å¡æ¥å£ä¸Šçš„æ•°æ®åŒ…ã€‚</span><br><span class="line">-v,è¾“å‡ºä¸€ä¸ªç¨å¾®è¯¦ç»†çš„ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼Œæ˜¾ç¤ºIPæ•°æ®åŒ…ä¸­çš„TTLå’ŒTOSä¿¡æ¯ã€‚</span><br><span class="line">-t,ä¸æ‰“å°æ—¶é—´æˆ³ã€‚</span><br><span class="line">-e,æ˜¾ç¤ºä»¥å¤ªç½‘å¸§å¤´éƒ¨ä¿¡æ¯ã€‚</span><br><span class="line">-c,è¿‘æŠ“å–æŒ‡å®šæ•°é‡çš„æ•°æ®åŒ…ã€‚</span><br><span class="line">-x,ä»¥åå…­è¿›åˆ¶æ•°æ˜¾ç¤ºæ•°æ®åŒ…çš„å†…å®¹ï¼Œä½†ä¸æ˜¾ç¤ºåŒ…ä¸­ä»¥å¤ªç½‘å¸§çš„å¤´éƒ¨ä¿¡æ¯ã€‚</span><br><span class="line">-X,ä¸-xé€‰é¡¹ç±»ä¼¼ï¼Œä¸è¿‡è¿˜æ‰“å°æ¯ä¸ªåå…­è¿›åˆ¶å­—èŠ‚å¯¹åº”çš„ASCIIå­—ç¬¦ã€‚</span><br><span class="line">-XX,ä¸-Xç›¸åŒï¼Œä¸è¿‡è¿˜æ‰“å°ä»¥å¤ªç½‘å¸§çš„å¤´éƒ¨ä¿¡æ¯ã€‚</span><br><span class="line">-s,è®¾ç½®æŠ“åŒ…æ—¶çš„æŠ“å–é•¿åº¦ã€‚</span><br><span class="line">-S,ä»¥ç»å¯¹å€¼æ¥æ˜¾ç¤ºTCPæŠ¥æ–‡æ®µçš„åºå·ï¼Œè€Œä¸æ˜¯ç›¸å¯¹å€¼ã€‚</span><br><span class="line">-w,ä»¥ç»å¯¹å€¼æ¥æ˜¾ç¤ºTCPæŠ¥æ–‡æ®µçš„åºå·ï¼Œè€Œä¸æ˜¯ç›¸å¯¹å€¼ã€‚</span><br><span class="line">-r,ä»æ–‡ä»¶è¯»å–æ•°æ®åŒ…ä¿¡æ¯å¹¶æ˜¾ç¤ºä¹‹ã€‚</span><br></pre></td></tr></table></figure>
<p>é™¤äº†ä½¿ç”¨é€‰é¡¹å¤–ï¼Œ<code>tcpdump</code>è¿˜æ”¯æŒç”¨è¡¨è¾¾å¼æ¥è¿›ä¸€æ­¥è¿‡æ»¤æ•°æ®åŒ…ã€‚<code>tcpdump</code>è¡¨è¾¾å¼çš„æ“ä½œæ•°åˆ†ä¸º3ç§ï¼šç±»å‹(type)ã€æ–¹å‘(dir)å’Œåè®®(proto)</p>
<ul>
<li><p>ç±»å‹ï¼Œè§£é‡Šå…¶åé¢ç´§è·Ÿç€çš„å‚æ•°çš„å«ä¹‰ã€‚<code>tcpdump</code>æ”¯æŒçš„ç±»å‹åŒ…æ‹¬hostã€netã€portå’Œportrangeã€‚å®ƒä»¬åˆ†åˆ«æŒ‡å®šä¸»æœºåï¼ˆæˆ–IPåœ°å€)ï¼Œç”¨CIDRæ–¹æ³•è¡¨ç¤ºçš„ç½‘ç»œåœ°å€ï¼Œç«¯å£å·ä»¥åŠç«¯å£èŒƒå›´ã€‚æ¯”å¦‚ï¼Œè¦æŠ“å–æ•´ä¸ª1.2.3.0/255.255.255.0ç½‘ç»œä¸Šçš„æ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tcpdump net 1.2.3.0/24</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ–¹å‘ï¼ŒsrcæŒ‡å®šæ•°æ®åŒ…çš„å‘é€ç«¯ï¼ŒdstæŒ‡å®šæ•°æ®åŒ…çš„ç›®çš„ç«¯ã€‚æ¯”å¦‚è¦æŠ“å–è¿›äººç«¯å£13579çš„æ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">tecpdump dst port 13579 </span><br></pre></td></tr></table></figure>
</li>
<li><p>åè®®ï¼ŒæŒ‡å®šç›®æ ‡åè®®ã€‚æ¯”å¦‚è¦æŠ“å–æ‰€æœ‰ICMPæ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump icmp</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨é€»è¾‘æ“ä½œç¬¦æ¥ç»„ç»‡ä¸Šè¿°æ“ä½œæ•°ä»¥åˆ›å»ºæ›´å¤æ‚çš„è¡¨è¾¾å¼ã€‚<code>tcpdump</code>æ”¯æŒçš„é€»è¾‘æ“ä½œç¬¦å’Œç¼–ç¨‹è¯­è¨€ä¸­çš„é€»è¾‘æ“ä½œç¬¦å®Œå…¨ç›¸åŒï¼ŒåŒ…æ‹¬and(æˆ–è€…&amp;&amp;)ã€or(æˆ–è€…ll)ã€not(æˆ–è€…!)ã€‚æ¯”å¦‚è¦æŠ“å–ä¸»æœº ernest-laptopå’Œæ‰€æœ‰é Kongming20 çš„ä¸»æœºä¹‹é—´äº¤æ¢çš„IPæ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump ip host ernest-laptop and not Kongming20</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¡¨è¾¾å¼æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ‹¬å·å°†å®ƒä»¬åˆ†ç»„ã€‚ä¸è¿‡åœ¨ä½¿ç”¨æ‹¬å·æ—¶ï¼Œæˆ‘ä»¬è¦ä¹ˆä½¿ç”¨åæ–œæ â€œ\â€å¯¹å®ƒè½¬ä¹‰ï¼Œè¦ä¹ˆç”¨å•å¼•å·â€œ â€å°†å…¶æ‹¬ä½ï¼Œä»¥é¿å…å®ƒè¢«shellæ‰€è§£é‡Šã€‚æ¯”å¦‚è¦æŠ“å–æ¥è‡ªä¸»æœº10.0.2.4ï¼Œç›®æ ‡ç«¯å£æ˜¯3389æˆ–22çš„æ•°æ®åŒ…ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tepdump &#x27;src 10.o.2.4 and (dst port 3389 or 22) &#x27;</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œtcpdumpè¿˜å…è®¸ç›´æ¥ä½¿ç”¨æ•°æ®åŒ…ä¸­çš„éƒ¨åˆ†åè®®å­—æ®µçš„å†…å®¹æ¥è¿‡æ»¤æ•°æ®åŒ…ã€‚æ¯”å¦‚ï¼Œä»…æŠ“å–TCPåŒæ­¥æŠ¥æ–‡æ®µï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump &#x27;tcp[13]&amp;2 != 0&#x27;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºTCPå¤´éƒ¨çš„ç¬¬14ä¸ªå­—èŠ‚çš„ç¬¬2ä¸ªä½æ­£æ˜¯åŒæ­¥æ ‡å¿—ã€‚è¯¥å‘½ä»¤ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tcpdump &#x27;tcp[tcpflags] &amp; tcp-syn != 0 &#x27;</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œtcpdumpçš„å…·ä½“è¾“å‡ºæ ¼å¼é™¤äº†ä¸é€‰é¡¹æœ‰å…³å¤–ï¼Œè¿˜ä¸åè®®æœ‰å…³ã€‚å¯ä»¥æŸ¥è¯¢manæ‰‹å†Œè¿›è¡Œå­¦ä¹ ã€‚</p>
<h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><p><code>lsof</code>(list open fileï¼‰æ˜¯ä¸€ä¸ªåˆ—å‡ºå½“å‰ç³»ç»Ÿæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦çš„å·¥å…·ã€‚é€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥äº†è§£æ„Ÿå…´è¶£çš„è¿›ç¨‹æ‰“å¼€äº†å“ªäº›æ–‡ä»¶æè¿°ç¬¦ï¼Œæˆ–è€…æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦è¢«å“ªäº›è¿›ç¨‹æ‰“å¼€äº†ã€‚</p>
<p><code>lsof</code>å‘½ä»¤å¸¸ç”¨çš„é€‰é¡¹åŒ…æ‹¬:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-i æ˜¾ç¤ºsocketæ–‡ä»¶æè¿°ç¬¦ã€‚</span><br><span class="line">lsof -i[46] [protocol] [@hostname|ipaddr] [:service|port]</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ4è¡¨ç¤ºIPv4åè®®ï¼Œ6è¡¨ç¤ºIPv6åè®®ï¼›protocolæŒ‡å®šä¼ è¾“å±‚åè®®ï¼Œå¯ä»¥æ˜¯TCPæˆ–è€…UDP ï¼› hostnameæŒ‡å®šä¸»æœºåï¼›ipaddræŒ‡å®šä¸»æœºçš„IPåœ°å€; serviceæŒ‡å®šæœåŠ¡åï¼›portæŒ‡å®šç«¯å£å·ã€‚æ¯”å¦‚ï¼Œè¦æ˜¾ç¤ºæ‰€æœ‰è¿æ¥åˆ°ä¸»æœº192.168.1.108çš„ sshæœåŠ¡çš„socketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨å‘½ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lsof -i@192.168.1.108:22</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ-ié€‰é¡¹åä¸æŒ‡å®šä»»ä½•å‚æ•°ï¼Œåˆ™<code>lsof</code>å‘½ä»¤å°†æ˜¾ç¤ºæ‰€æœ‰socketæ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20221001174639842.png" alt="image-20221001174639842"></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å…¶ä»–å‚æ•°ï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-u æ˜¾ç¤ºæŒ‡å®šç”¨æˆ·å¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚</span><br><span class="line">-c æ˜¾ç¤ºæŒ‡å®šçš„å‘½ä»¤æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚æ¯”å¦‚è¦æŸ¥çœ‹websrvç¨‹åºæ‰“å¼€äº†å“ªäº›æ–‡ä»¶æè¿°ç¬¦ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:lsof -c websrv</span><br><span class="line">-pï¼Œæ˜¾ç¤ºæŒ‡å®šè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚</span><br><span class="line">-tï¼Œä»…æ˜¾ç¤ºæ‰“å¼€äº†ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦çš„è¿›ç¨‹çš„PIDã€‚</span><br></pre></td></tr></table></figure>
<h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><p><code>nc</code> (netcatã€‰å‘½ä»¤çŸ­å°ç²¾å¹²ã€åŠŸèƒ½å¼ºå¤§ï¼Œæœ‰ç€â€œç‘å£«å†›åˆ€â€çš„ç¾èª‰ã€‚å®ƒä¸»è¦è¢«ç”¨æ¥å¿«é€Ÿæ„å»ºç½‘ç»œè¿æ¥ã€‚æˆ‘ä»¬å¯ä»¥è®©å®ƒä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œï¼Œç›‘å¬æŸä¸ªç«¯å£å¹¶æ¥æ”¶å®¢æˆ·è¿æ¥ï¼Œå› æ­¤å®ƒå¯ç”¨æ¥è°ƒè¯•å®¢æˆ·ç«¯ç¨‹åºã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ä¹‹ä»¥å®¢æˆ·ç«¯æ–¹å¼è¿è¡Œï¼Œå‘æœåŠ¡å™¨å‘èµ·è¿æ¥å¹¶æ”¶å‘æ•°æ®ï¼Œå› æ­¤å®ƒå¯ä»¥ç”¨æ¥è°ƒè¯•æœåŠ¡å™¨ç¨‹åºï¼Œæ­¤æ—¶å®ƒæœ‰ç‚¹åƒtelnetç¨‹åºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-i è®¾ç½®æ•°æ®åŒ…ä¼ é€çš„æ—¶é—´é—´éš”ã€‚</span><br><span class="line">-l ä»¥æœåŠ¡å™¨æ–¹å¼è¿è¡Œï¼Œç›‘å¬æŒ‡å®šçš„ç«¯å£ã€‚ncå‘½ä»¤é»˜è®¤ä»¥å®¢æˆ·ç«¯æ–¹å¼è¿è¡Œã€‚</span><br><span class="line">-k é‡å¤æ¥å—å¹¶å¤„ç†æŸä¸ªç«¯å£ä¸Šçš„æ‰€æœ‰è¿æ¥ï¼Œå¿…é¡»ä¸-lé€‰é¡¹ä¸€èµ·ä½¿ç”¨ã€‚</span><br><span class="line">-n ä½¿ç”¨IPåœ°å€è¡¨ç¤ºä¸»æœºï¼Œè€Œä¸æ˜¯ä¸»æœºåï¹”ä½¿ç”¨æ•°å­—è¡¨ç¤ºç«¯å£å·ï¼Œè€Œä¸æ˜¯æœåŠ¡åç§°ã€‚</span><br><span class="line">-p å½“ncå‘½ä»¤ä»¥å®¢æˆ·ç«¯æ–¹å¼è¿è¡Œæ—¶ï¼Œå¼ºåˆ¶å…¶ä½¿ç”¨æŒ‡å®šçš„ç«¯å£å·ã€‚</span><br><span class="line">-s è®¾ç½®æœ¬åœ°ä¸»æœºå‘é€å‡ºçš„æ•°æ®åŒ…çš„IPåœ°å€ã€‚</span><br><span class="line">-C å°†CRå’ŒLFä¸¤ä¸ªå­—ç¬¦ä½œä¸ºè¡Œç»“æŸç¬¦ã€‚</span><br><span class="line">-U ä½¿ç”¨UNIXæœ¬åœ°åŸŸåè®®é€šä¿¡ã€‚</span><br><span class="line">-u ä½¿ç”¨UDPåè®®ã€‚ncå‘½ä»¤é»˜è®¤ä½¿ç”¨çš„ä¼ è¾“å±‚åè®®æ˜¯TCPåè®®ã€‚</span><br><span class="line">-w å¦‚æœncå®¢æˆ·ç«¯åœ¨æŒ‡å®šçš„æ—¶é—´å†…æœªæ£€æµ‹åˆ°ä»»ä½•è¾“å…¥ï¼Œåˆ™é€€å‡ºã€‚</span><br><span class="line">-X å½“ncå®¢æˆ·ç«¯å’Œä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶ï¼Œè¯¥é€‰é¡¹æŒ‡å®šå®ƒä»¬ä¹‹é—´ä½¿ç”¨çš„é€šä¿¡åè®®ã€‚ç›®å‰ncæ”¯æŒçš„ä»£ç†åè®®åŒ…æ‹¬â€œ4â€(SOCKS v.4)ï¼Œâ€œ5â€(SOCKs v.5ï¼‰å’Œâ€œconnectâ€(HTTPS proxy)ã€‚nc é»˜è®¤ä½¿ç”¨çš„ä»£ç†åè®®æ˜¯SOCKs v.5ã€‚</span><br><span class="line">-x æŒ‡å®šç›®æ ‡ä»£ç†æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£å·ã€‚æ¯”å¦‚ï¼Œè¦ä» Kongming20è¿æ¥åˆ°ernest-laptopä¸Šçš„ squidä»£ç†æœåŠ¡å™¨ï¼Œå¹¶é€šè¿‡å®ƒæ¥è®¿é—®www.baidu.com çš„ WebæœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤: nc -x ernest-laptopï¼š1080 -X connect www.baidu.com</span><br><span class="line">-z æ‰«æç›®æ ‡æœºå™¨ä¸Šçš„æŸä¸ªæˆ–æŸäº›æœåŠ¡æ˜¯å¦å¼€å¯ï¼ˆç«¯å£æ‰«æ)ã€‚æ¯”å¦‚ï¼Œè¦æ‰«ææœºå™¨ernest-laptopä¸Šç«¯å£å·åœ¨20 ï½ 50ä¹‹é—´çš„æœåŠ¡ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤:</span><br><span class="line">nc -z ernest-laptop 20-50</span><br></pre></td></tr></table></figure>
<h2 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h2><p>netstatæ˜¯ä¸€ä¸ªåŠŸèƒ½å¾ˆå¼ºå¤§çš„ç½‘ç»œä¿¡æ¯ç»Ÿè®¡å·¥å…·ã€‚å®ƒå¯ä»¥æ‰“å°æœ¬åœ°ç½‘å¡æ¥å£ä¸Šçš„å…¨éƒ¨è¿æ¥ã€è·¯ç”±è¡¨ä¿¡æ¯ã€ç½‘å¡æ¥å£ä¿¡æ¯ç­‰ã€‚æˆ‘ä»¬ä¸»è¦åˆ©ç”¨çš„æ˜¯ä¸Šè¿°åŠŸèƒ½ä¸­çš„ç¬¬ä¸€ä¸ªï¼Œå³æ˜¾ç¤ºTCPè¿æ¥åŠå…¶çŠ¶æ€ä¿¡æ¯ã€‚æ¯•ç«ï¼Œè¦è·å¾—è·¯ç”±è¡¨ä¿¡æ¯å’Œç½‘å¡æ¥å£ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¾“å‡ºå†…å®¹æ›´ä¸°å¯Œçš„routeå’Œ ifconfigå‘½ä»¤ã€‚</p>
<p>nctstatå‘½ä»¤å¸¸ç”¨çš„é€‰é¡¹åŒ…æ‹¬:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">-n ä½¿ç”¨IPåœ°å€è¡¨ç¤ºä¸»æœºï¼Œè€Œä¸æ˜¯ä¸»æœºå;ä½¿ç”¨æ•°å­—è¡¨ç¤ºç«¯å£å·ï¼Œè€Œä¸æ˜¯æœåŠ¡åç§°ã€‚</span><br><span class="line">-a æ˜¾ç¤ºç»“æœä¸­ä¹ŸåŒ…å«ç›‘å¬socketã€‚</span><br><span class="line">-t ä»…æ˜¾ç¤ºTCPè¿æ¥ã€‚</span><br><span class="line">-r æ˜¾ç¤ºè·¯ç”±ä¿¡æ¯ã€‚</span><br><span class="line">-i æ˜¾ç¤ºç½‘å¡æ¥å£çš„æ•°æ®æµé‡</span><br><span class="line">-c æ¯éš”1sè¾“å‡ºä¸€æ¬¡</span><br><span class="line">-o æ˜¾ç¤ºsocketå®šæ—¶å™¨ï¼ˆæ¯”å¦‚ä¿æ´»å®šæ—¶å™¨ï¼‰çš„ä¿¡æ¯</span><br><span class="line">-p æ˜¾ç¤ºsocketæ‰€å±çš„è¿›ç¨‹çš„PIDå’Œåå­—</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Nextä¸»é¢˜ç¾åŒ–</title>
    <url>/2021/05/22/%E5%85%B6%E4%BB%96/next%E7%BE%8E%E5%8C%96/</url>
    <content><![CDATA[<h1 id="Nextä¸»é¢˜ç¾åŒ–"><a href="#Nextä¸»é¢˜ç¾åŒ–" class="headerlink" title="Nextä¸»é¢˜ç¾åŒ–"></a>Nextä¸»é¢˜ç¾åŒ–</h1><p>æœ€è¿‘ä½¿ç”¨hexoçš„nextä¸»é¢˜åœ¨githubä¸Šæ­å»ºäº†ä¸€ä¸ªåšå®¢ï¼Œä½†æ˜¯å‘ç°è¿™ä¸ªnextä¸»é¢˜å¹¶ä¸å®Œå…¨æ˜¯è‡ªå·±æƒ³è¦çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦ç¾(zhe)åŒ–ï¼ˆtenï¼‰ä¸€ä¸‹ã€‚ä¸»è¦æŠ˜è…¾äº†ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ</li>
<li>ä¸ªæ€§åŒ–å›åˆ°é¡¶éƒ¨</li>
<li>æ‰“å­—ç‰¹æ•ˆ</li>
<li>ä¸Šä¼ æ–‡ä»¶ä¸­å¸¦æœ‰READ.md</li>
</ul>
<span id="more"></span>
<h2 id="é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ"><a href="#é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ" class="headerlink" title="é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ"></a>é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ</h2><p>æ·»åŠ é¼ æ ‡ç‚¹å‡»ç¤¼èŠ±ç‰¹æ•ˆğŸ‰ï¼Œæ•ˆæœå¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/é¼ æ ‡ç‚¹å‡»ç¤¼èŠ±ç‰¹æ•ˆ.gif" alt="é¼ æ ‡ç‚¹å‡»ç¤¼èŠ±ç‰¹æ•ˆ"></p>
<p>åœ¨<code>themes\next\source\js\cursor\</code>ç›®å½•ä¸‹ åˆ›å»º<strong>fireworks.js</strong>ï¼Œå…·ä½“<strong>fireworks.js</strong>çš„å†…å®¹å¯ä»¥ç‚¹å‡»ğŸ‘‰<a href="https://github.com/bugcat9/hexo-theme-next/blob/master/source/js/cursor/fireworks.js">fireworks.js</a>è¿›è¡ŒæŸ¥çœ‹(ä¸å±•ç¤ºå› ä¸ºå®åœ¨æ˜¯å¤ªé•¿äº†)</p>
<p>ç„¶ååœ¨ä¸»é¢˜è‡ªå®šä¹‰å¸ƒå±€æ–‡ä»¶<code>themes\next\layout\_custom\custom.swig</code>ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;# é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ #&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> theme.<span class="property">cursor_effect</span> == <span class="string">&quot;fireworks&quot;</span> %&#125;</span><br><span class="line">  &lt;script <span class="keyword">async</span> src=<span class="string">&quot;/js/cursor/fireworks.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ <strong>custom.swig</strong> æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨<code>themes\next\layout\_custom</code>ä¸‹åˆ›å»ºå¹¶åœ¨<code>themes\next\layout\_layout.swig</code>å¸ƒå±€é¡µé¢ä¸­ <strong>body</strong> æœ«å°¾å¼•å…¥ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"> ...</span><br><span class="line"> &#123;%- if theme.pjax %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;pjax&quot;</span>&gt;</span></span><br><span class="line">  &#123;%- endif %&#125;</span><br><span class="line">  &#123;% include &#x27;_third-party/math/index.swig&#x27; %&#125;</span><br><span class="line">  &#123;% include &#x27;_third-party/quicklink.swig&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">  &#123;&#123;- next_inject(&#x27;bodyEnd&#x27;) &#125;&#125;</span><br><span class="line">  &#123;%- if theme.pjax %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  &#123;%- endif %&#125;</span><br><span class="line">  &#123;% include &#x27;_custom/custom.swig&#x27; %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è®°ä½æ˜¯åœ¨<strong>layout</strong>æ–‡ä»¶å¤¹ä¸‹åˆ›å»ºå¯¹åº”çš„<strong>custom.swig</strong> æ–‡ä»¶ï¼Œåˆ«åˆ›å»ºé”™äº†ã€‚</p>
<p>æœ€ååœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶<code>themes\next\_config.yml</code>ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mouse click effect: fireworks | explosion | love | text</span></span><br><span class="line"><span class="attr">cursor_effect:</span> <span class="string">fireworks</span></span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ç‚¹å‡»ç‰¹æ•ˆè¿˜æœ‰å…¶ä»–çš„ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="http://yearito.cn/posts/hexo-theme-beautify.html">http://yearito.cn/posts/hexo-theme-beautify.html</a></p>
<h2 id="ä¸ªæ€§åŒ–å›åˆ°é¡¶éƒ¨"><a href="#ä¸ªæ€§åŒ–å›åˆ°é¡¶éƒ¨" class="headerlink" title="ä¸ªæ€§åŒ–å›åˆ°é¡¶éƒ¨"></a>ä¸ªæ€§åŒ–å›åˆ°é¡¶éƒ¨</h2><p>ä¸ªæ€§åŒ–å›åˆ°é¡¶ç«¯æ˜¯æˆ‘è‡ªå·±æ¯”è¾ƒå–œæ¬¢çš„ï¼Œä¹Ÿæ˜¯ä»ä¸Šé¢é‚£ä¸ªå‚è€ƒé‚£é‡Œå€Ÿé‰´çš„ï¼ˆè¯»ä¹¦äººçš„äº‹ï¼Œæ€ä¹ˆèƒ½å’³å’³ï¼Œæ‰¯è¿œäº†ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå°çŒ«ç„¶åç‚¹å‡»å¯ä»¥å›åˆ°é¡¶ç«¯ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/ä¸ªæ€§åŒ–back2top.gif" alt="ä¸ªæ€§åŒ–back2top"></p>
<p>é¦–å…ˆï¼Œä¸‹è½½è¯¥å›¾ç‰‡ï¼Œç‚¹å‡»ğŸ‘‰<a href="https://github.com/bugcat9/hexo-theme-next/blob/master/source/images/scroll.png">å°çŒ«å›¾ç‰‡</a></p>
<p>ç„¶ååœ¨<code>themes\next\source\css\_common\components\back-to-top.styl</code>é‡Œé¢<strong>æ·»åŠ </strong>(ä¸æ˜¯è¦†ç›–)</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">//è‡ªå®šä¹‰å›åˆ°é¡¶éƒ¨æ ·å¼</span><br><span class="line"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width</span>: <span class="number">900px</span>) &#123;</span><br><span class="line"><span class="selector-class">.back-to-top</span> &#123;</span><br><span class="line">  <span class="attribute">right</span>: <span class="number">60px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">70px</span>;  //å›¾ç‰‡ç´ æå®½åº¦</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">900px</span>;  //å›¾ç‰‡ç´ æé«˜åº¦</span><br><span class="line">  <span class="attribute">top</span>: -<span class="number">900px</span>;</span><br><span class="line">  <span class="attribute">bottom</span>: unset;</span><br><span class="line">  <span class="attribute">transition</span>: all .<span class="number">5s</span> ease-in-out;</span><br><span class="line">  <span class="attribute">background</span>: <span class="built_in">url</span>(<span class="string">&quot;/images/scroll.png&quot;</span>);</span><br><span class="line">  <span class="attribute">position</span>: fixed</span><br><span class="line">  //éšè—ç®­å¤´å›¾æ ‡</span><br><span class="line">  &gt; i &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &amp;<span class="selector-class">.back-to-top-on</span> &#123;</span><br><span class="line">    <span class="attribute">bottom</span>: unset;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">100vh</span> &lt; (<span class="number">900px</span> + <span class="number">200px</span>) ? <span class="built_in">calc</span>( <span class="number">100vh</span> - <span class="number">900px</span> - <span class="number">200px</span> ) : <span class="number">0px</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶<code>themes\next\_config.yml</code>ä¸­æ‰“å¼€<strong>back2top</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">back2top:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Back to top in sidebar.</span></span><br><span class="line">  <span class="attr">sidebar:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Scroll percent label in b2t button.</span></span><br><span class="line">  <span class="attr">scrollpercent:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="æ‰“å­—ç‰¹æ•ˆ"><a href="#æ‰“å­—ç‰¹æ•ˆ" class="headerlink" title="æ‰“å­—ç‰¹æ•ˆ"></a>æ‰“å­—ç‰¹æ•ˆ</h2><p>å¦‚æœä½ å¼€è¯„è®ºçš„è¯ï¼Œå¯ä»¥è€ƒè™‘åŠ å…¥è¿™ä¸ªç‰¹æ•ˆï¼Œæ„Ÿè§‰è¿˜æŒºç‚«é…·ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/æ‰“å­—ç‰¹æ•ˆ.gif" alt="æ‰“å­—ç‰¹æ•ˆ"></p>
<p>é¦–å…ˆï¼Œç‚¹å‡»<a href="https://github.com/bugcat9/hexo-theme-next/blob/master/source/js/activate-power-mode.min.js">activate-power-mode.min.js</a>ä¸‹è½½ç›¸åº”çš„è„šæœ¬ï¼Œå¹¶ç½®äº <code>themes\next\source\js\</code> ç›®å½•ä¸‹ã€‚</p>
<p>åœ¨ä¸»é¢˜è‡ªå®šä¹‰å¸ƒå±€æ–‡ä»¶<code>themes\next\layout\_custom\custom.swig</code>ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;# æ‰“å­—ç‰¹æ•ˆ #&#125;</span><br><span class="line">&#123;% if theme.typing_effect %&#125;</span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/activate-power-mode.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    POWERMODE.colorful = </span><span class="template-variable">&#123;&#123; <span class="name">theme.typing_effect.colorful</span> &#125;&#125;</span><span class="language-xml">;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    POWERMODE.shake = </span><span class="template-variable">&#123;&#123; <span class="name">theme.typing_effect.shake</span> &#125;&#125;</span><span class="language-xml">;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    document.body.addEventListener(&#x27;input&#x27;, POWERMODE);</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœ custom.swig æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨æ–°å»ºå¹¶åœ¨å¸ƒå±€é¡µé¢ä¸­ body æœ«å°¾å¼•å…¥,è¿™ä¸ªä¸Šé¢è¯´è¿‡äº†ï¼Œå°±ä¸å¤šè¯´äº†ã€‚</p>
<p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶<code>themes\next\_config.yml</code>ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># typing effect</span></span><br><span class="line"><span class="attr">typing_effect:</span></span><br><span class="line">  <span class="attr">colorful:</span> <span class="literal">true</span>  <span class="comment"># ç¤¼èŠ±ç‰¹æ•ˆ</span></span><br><span class="line">  <span class="attr">shake:</span> <span class="literal">false</span>  <span class="comment"># éœ‡åŠ¨ç‰¹æ•ˆ</span></span><br></pre></td></tr></table></figure>
<h2 id="ä¸Šä¼ æ–‡ä»¶ä¸­å¸¦æœ‰README-md"><a href="#ä¸Šä¼ æ–‡ä»¶ä¸­å¸¦æœ‰README-md" class="headerlink" title="ä¸Šä¼ æ–‡ä»¶ä¸­å¸¦æœ‰README.md"></a>ä¸Šä¼ æ–‡ä»¶ä¸­å¸¦æœ‰README.md</h2><p>æˆ‘ä»¬çŸ¥é“hexoä¸Šä¼ çš„æ–‡ä»¶å½“ä¸­åªæœ‰cssã€jsã€htmlç­‰æ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ ¹ç›®å½•çš„sourceæ–‡ä»¶å¤¹ä¸‹æ·»åŠ README.mdï¼Œåˆä¼šå˜æˆhtmlã€‚è¿™å¯¹äºæˆ‘è¿™æ ·çš„å¼ºè¿«ç—‡å¤ªéš¾å—ã€‚</p>
<p>è§£å†³æ–¹æ³•æ˜¯åœ¨æ ¹ç›®å½•ä¸‹(æ³¨æ„æ˜¯æ ¹ç›®å½•ä¸‹ï¼Œä¸æ˜¯ä¸»é¢˜nextç›®å½•ä¸‹)çš„<strong>_config.yml</strong>çš„<code>skip_render</code>å‰é¢åŠ ä¸Š<code>README.md</code>ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">skip_render:</span> <span class="string">README.md</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åå†ä½¿ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">hexo g</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆå¯ä»¥çœ‹åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210522214004389.png" alt="å±•ç¤º"></p>
<h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>nextä¸»é¢˜çš„ä¼˜åŒ–å°±å‘Šè¾æ®µè½ï¼Œç›®å‰æˆ‘çš„éœ€æ±‚åŸºæœ¬æ»¡è¶³äº†ï¼Œå¦‚æœæœ‰å¤§ä½¬æƒ³äº†è§£æ›´å¤šæ›´æ·±åº¦çš„ï¼Œå¯ä»¥å‚è€ƒï¼š<a href="http://yearito.cn/posts/hexo-theme-beautify.html">http://yearito.cn/posts/hexo-theme-beautify.html</a></p>
<p>ä¸è¿‡ä»–çš„è¿™ä¸ªæœ‰ç‚¹ä¸­æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯custom.stylä¸å­˜åœ¨äº†ï¼Œè¿™ä¸ªå¯ä»¥å‚è€ƒè¿™ä¸ªissueï¼š</p>
<p><a href="https://github.com/theme-next/hexo-theme-next/issues/982">https://github.com/theme-next/hexo-theme-next/issues/982</a></p>
<p>ç›®å‰æ„Ÿè§‰è‡ªå·±æŠ˜è…¾äº†ä¸€å¹´çš„åšå®¢ï¼Œä»hexoåˆ°ç›´æ¥å­˜åœ¨githubä¸Šå†åˆ°jekyllï¼Œæœ€ååˆå›åˆ°hexoï¼ŒçœŸå®ç”Ÿå‘½ä¸æ¯æŠ˜è…¾ä¸æ­¢ï¼Œåšå®¢é€‰æ‹©å°±åˆ°æ­¤ç»“æŸå§ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="http://yearito.cn/posts/hexo-theme-beautify.html">http://yearito.cn/posts/hexo-theme-beautify.html</a></li>
<li><a href="https://github.com/theme-next/hexo-theme-next/issues/982">https://github.com/theme-next/hexo-theme-next/issues/982</a></li>
<li><a href="https://www.zhihu.com/question/23934523">https://www.zhihu.com/question/23934523</a></li>
</ul>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
      </tags>
  </entry>
  <entry>
    <title>pythonä½¿ç”¨opencvæå–å…‰æµ</title>
    <url>/2022/07/22/%E5%85%B6%E4%BB%96/python%E4%BD%BF%E7%94%A8opencv%E6%8F%90%E5%8F%96%E5%85%89%E6%B5%81/</url>
    <content><![CDATA[<h1 id="pythonä½¿ç”¨opencvæå–å…‰æµ"><a href="#pythonä½¿ç”¨opencvæå–å…‰æµ" class="headerlink" title="pythonä½¿ç”¨opencvæå–å…‰æµ"></a>pythonä½¿ç”¨opencvæå–å…‰æµ</h1><p>å…‰æµflowç‰¹å¾ä¸­åŒ…å«äº†ä¸€ä¸ªè§†é¢‘å½“ä¸­è¿åŠ¨ç›¸å…³çš„ä¿¡æ¯ï¼Œåœ¨è§†é¢‘åŠ¨ä½œå®šä½å½“ä¸­å…‰æµç‰¹å¾ä½¿ç”¨çš„æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹æå–å…‰æµç‰¹å¾çš„æ–¹æ³•ã€‚</p>
<p>ä½¿ç”¨çš„æ–¹æ³•æ˜¯TVL1æ–¹æ³•ï¼Œæœ€ç»ˆæå–çš„å…‰æµå›¾ç‰‡è¿˜å¯ä»¥é…åˆI3Dæ¨¡å‹è¿›è¡Œç‰¹å¾çš„æå–ã€‚å…‰æµçš„è®¡ç®—å…ˆéœ€è¦å°†è§†é¢‘ä¸€å¸§ä¸€å¸§æå–å‡ºæ¥ï¼Œç„¶åå†é€šè¿‡è¿ç»­ä¸¤å¸§ä¹‹é—´çš„å·®å¼‚è¿›è¡Œè®¡ç®—ã€‚</p>
<span id="more"></span>
<h2 id="æå–å¸§"><a href="#æå–å¸§" class="headerlink" title="æå–å¸§"></a>æå–å¸§</h2><p>æå–è§†é¢‘çš„å¸§çš„ç®—æ³•å¦‚ä¸‹ï¼š</p>
<p>å…¶ä¸­<code>video_list.txt</code>ä¸­å†™çš„æ˜¯è§†é¢‘çš„åå­—ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰ç¨‹åºéœ€è¦å°†é‚£äº›è§†é¢‘æå–å¸§:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220726212052926.png" alt="image-20220726212052926"></p>
<p><code>videos</code>ä¸­å­˜æ”¾è§†é¢‘ï¼Œä¸<code>video_list.txt</code>ä¸­å†™çš„è§†é¢‘åå­—å¯¹åº”</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220726212224852.png" alt="image-20220726212224852"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line">video_root = <span class="string">&#x27;video_list.txt&#x27;</span></span><br><span class="line">root = <span class="string">&#x27;videos&#x27;</span></span><br><span class="line">out_root = <span class="string">&#x27;frames&#x27;</span></span><br><span class="line">suffix = <span class="string">&#x27;.jpg&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_image</span>(<span class="params">root, vid_name, num, image</span>):</span><br><span class="line">    file_name = os.path.join(root, vid_name, <span class="built_in">str</span>(num) + suffix)</span><br><span class="line">    <span class="comment"># print(file_name)</span></span><br><span class="line">    cv2.imwrite(file_name, image)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">vid_path, preffix</span>):</span><br><span class="line">    videoCapture = cv2.VideoCapture(vid_path)</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        success, frame = videoCapture.read()</span><br><span class="line">        <span class="keyword">if</span> success:</span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">            save_image(out_root, preffix, i, frame)</span><br><span class="line">            <span class="comment"># print(&#x27;save image vid name: &#x27;, file_name, &#x27;; frame num: &#x27;, i)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(out_root):</span><br><span class="line">        os.mkdir(out_root)</span><br><span class="line">    <span class="comment"># path_list = os.listdir(root)</span></span><br><span class="line">    path_list = []</span><br><span class="line">    <span class="comment">#### è¯»å–txtä¸­è§†é¢‘ä¿¡æ¯ ####</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(video_root, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">id</span>, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f):</span><br><span class="line">            video_name = line.strip().split()</span><br><span class="line">            path_list.append(video_name[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    pool = multiprocessing.Pool(processes=<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> file_name <span class="keyword">in</span> path_list:</span><br><span class="line">        path = os.path.join(root, file_name)</span><br><span class="line">        preffix = file_name.split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">        dir_name = os.path.join(out_root, preffix)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(dir_name):</span><br><span class="line">            os.mkdir(dir_name)</span><br><span class="line"></span><br><span class="line">        pool.apply_async(process, args=(path, preffix))</span><br><span class="line">        <span class="comment"># process(path,preffix)</span></span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(root)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;finish!!!!!!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œå®Œè¿™ä¸ªç¨‹åºå°±èƒ½å°†éœ€è¦æå–çš„è§†é¢‘å¸§æ”¾åœ¨<code>frames</code>å¯¹åº”çš„ç›®å½•ä¸‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220726212537411.png" alt="image-20220726212537411"></p>
<h2 id="æå–flowå…‰æµ"><a href="#æå–flowå…‰æµ" class="headerlink" title="æå–flowå…‰æµ"></a>æå–flowå…‰æµ</h2><p>æå–å…‰æµä½¿ç”¨äº†opencvæ¨¡å—ï¼Œä¸»è¦é€šè¿‡ä¸Šé¢æå–çš„è§†é¢‘å¸§è¿›è¡Œè®¡ç®—ï¼Œå…‰æµè®¡ç®—ä½¿ç”¨cpuèµ„æºæ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä¼šè®¡ç®—å¾ˆé•¿æ—¶é—´ã€‚</p>
<p>å…‰æµæå–çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="comment">###### ä½¿ç”¨frameså¸§è¿›è¡Œ flowå…‰æµè®¡ç®—</span></span><br><span class="line">video_root = <span class="string">&#x27;video_list.txt&#x27;</span></span><br><span class="line">root = <span class="string">&#x27;frames&#x27;</span></span><br><span class="line">out_root = <span class="string">&#x27;flow&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cal_for_frames</span>(<span class="params">video_path</span>):</span><br><span class="line">    <span class="comment"># print(video_path)</span></span><br><span class="line">    frames = glob.glob(os.path.join(video_path, <span class="string">&#x27;*.jpg&#x27;</span>))</span><br><span class="line">    frames.sort()</span><br><span class="line"></span><br><span class="line">    flow = []</span><br><span class="line">    prev = cv2.imread(frames[<span class="number">0</span>])</span><br><span class="line">    prev = cv2.cvtColor(prev, cv2.COLOR_BGR2GRAY)</span><br><span class="line">    <span class="keyword">for</span> i, frame_curr <span class="keyword">in</span> <span class="built_in">enumerate</span>(frames[<span class="number">1</span>:]):</span><br><span class="line">        curr = cv2.imread(frame_curr)</span><br><span class="line">        curr = cv2.cvtColor(curr, cv2.COLOR_BGR2GRAY)</span><br><span class="line">        tmp_flow = compute_TVL1(prev, curr)</span><br><span class="line">        flow.append(tmp_flow)</span><br><span class="line">        prev = curr</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_TVL1</span>(<span class="params">prev, curr, bound=<span class="number">15</span></span>):</span><br><span class="line">    TVL1 = cv2.optflow.DualTVL1OpticalFlow_create()</span><br><span class="line">    flow = TVL1.calc(prev, curr, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> flow.dtype == np.float32</span><br><span class="line"></span><br><span class="line">    flow = (flow + bound) * (<span class="number">255.0</span> / (<span class="number">2</span> * bound))</span><br><span class="line">    flow = np.<span class="built_in">round</span>(flow).astype(<span class="built_in">int</span>)</span><br><span class="line">    flow[flow &gt;= <span class="number">255</span>] = <span class="number">255</span></span><br><span class="line">    flow[flow &lt;= <span class="number">0</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> flow</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_flow</span>(<span class="params">video_flows, flow_path</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(flow_path):</span><br><span class="line">        os.mkdir(os.path.join(flow_path))</span><br><span class="line">    <span class="keyword">for</span> i, flow <span class="keyword">in</span> <span class="built_in">enumerate</span>(video_flows):</span><br><span class="line">        cv2.imwrite(os.path.join(flow_path, <span class="built_in">str</span>(i) + <span class="string">&#x27;_x.jpg&#x27;</span>), flow[:, :, <span class="number">0</span>])</span><br><span class="line">        cv2.imwrite(os.path.join(flow_path, <span class="built_in">str</span>(i) + <span class="string">&#x27;_y.jpg&#x27;</span>), flow[:, :, <span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process</span>(<span class="params">video_path, flow_path</span>):</span><br><span class="line">    flow = cal_for_frames(video_path)</span><br><span class="line">    save_flow(flow, flow_path)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_flow</span>(<span class="params">root, out_root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(out_root):</span><br><span class="line">        os.mkdir(out_root)</span><br><span class="line">    <span class="comment"># dir_list = os.listdir(root)</span></span><br><span class="line">    dir_list = []</span><br><span class="line">    <span class="comment">### è¯»å–txtä¸­è§†é¢‘ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(video_root, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> <span class="built_in">id</span>, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f):</span><br><span class="line">            video_name = line.strip().split()</span><br><span class="line">            preffix = video_name[<span class="number">0</span>].split(<span class="string">&#x27;.&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            dir_list.append(preffix)</span><br><span class="line"></span><br><span class="line">    pool = multiprocessing.Pool(processes=<span class="number">4</span>)</span><br><span class="line">    <span class="keyword">for</span> dir_name <span class="keyword">in</span> dir_list:</span><br><span class="line">        video_path = os.path.join(root, dir_name)</span><br><span class="line">        flow_path = os.path.join(out_root, dir_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># flow = cal_for_frames(video_path)</span></span><br><span class="line">        <span class="comment"># save_flow(flow,flow_path)</span></span><br><span class="line">        <span class="comment"># print(&#x27;save flow data: &#x27;,flow_path)</span></span><br><span class="line">        <span class="comment"># process(video_path,flow_path)</span></span><br><span class="line">        pool.apply_async(process, args=(video_path, flow_path))</span><br><span class="line"></span><br><span class="line">    pool.close()</span><br><span class="line">    pool.join()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    extract_flow(root, out_root)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;finish!!!!!!!!!!!!!!!!!!&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>æå–å…‰æµæ—¶éœ€è¦ä½¿ç”¨åˆ°<code>cv2.optflow.DualTVL1OpticalFlow_create()</code>ï¼Œè¿™ç©æ„å®‰è£…æœ‰æ—¶å€™ä¼šæœ‰ç‰ˆæœ¬é—®é¢˜ï¼Œæ‰€ä»¥å®‰è£…çš„opencv-pythonå’Œpencv-contrib-pythonæœ€å¥½ç‰ˆæœ¬ç›¸åŒ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pip install opencv-python==<span class="number">4.1</span><span class="number">.2</span><span class="number">.30</span></span><br><span class="line"> </span><br><span class="line">pip install opencv-contrib-python==<span class="number">4.1</span><span class="number">.2</span><span class="number">.30</span></span><br></pre></td></tr></table></figure>
<h2 id="ç»“æœ"><a href="#ç»“æœ" class="headerlink" title="ç»“æœ"></a>ç»“æœ</h2><p>æœ€ç»ˆflowå…‰æµå›¾å’Œæå–çš„å¸§ä¹‹é—´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ä¸€äº›æ¢³å¤´å‘çš„åŠ¨ä½œå˜åŒ–ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220726213330086.png" alt="image-20220726213330086"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è®°å½•ä¸€ä¸‹å…‰æµç‰¹å¾æå–çš„ç®—æ³•ï¼Œæ–¹ä¾¿è‡ªå·±ä¹‹åè¿›è¡Œä½¿ç”¨ã€‚</p>
<p>ä»£ç ä»“åº“ï¼š<a href="https://github.com/bugcat9/pytorch-i3d">https://github.com/bugcat9/pytorch-i3d</a></p>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>hexoä½¿ç”¨github actionå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²</title>
    <url>/2021/05/30/%E5%85%B6%E4%BB%96/hexo%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<h1 id="hexoä½¿ç”¨github-actionå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²"><a href="#hexoä½¿ç”¨github-actionå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²" class="headerlink" title="hexoä½¿ç”¨github actionå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²"></a>hexoä½¿ç”¨github actionå®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²</h1><p>æœ€è¿‘å°†hexoåšå®¢è¿›è¡Œäº†ç¾åŒ–ï¼Œä¸ºäº†æ›´â€œæŠ˜è…¾â€ä¸€ç‚¹ï¼Œå†³å®šå®ç°ä¸€ä¸‹hexoå¯¹åº”çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œæ¯•ç«Ÿç½‘ä¸Šçš„èµ„æ–™å¯¹åº”çš„ä¹Ÿæœ‰ä¸å°‘ï¼Œå­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>æˆ‘è‡ªå·±çš„éœ€æ±‚æ˜¯</p>
<ul>
<li>å°†hexoã€hexoç”Ÿæˆçš„é™æ€æ–‡ä»¶ã€åšå®¢æºç éƒ½æ”¾åœ¨ä¸€èµ·ï¼ˆä¸ªäººæ„Ÿè§‰æ–¹ä¾¿ç®¡ç†ï¼Œå…å¾—åˆ›å»ºè®¸å¤šä»“åº“ï¼‰ï¼Œç„¶åhexoä¸»è¦å°±åœ¨hexoåˆ†æ”¯ä¸Š</li>
<li>åœ¨hexoåˆ†æ”¯ä¸Šè¿›è¡Œè‡ªåŠ¨åŒ–ï¼Œå®ç°ä¸Šä¼ æ–‡ä»¶åè‡ªåŠ¨éƒ¨ç½²ã€‚</li>
</ul>
<p>æŸ¥çœ‹åšå®¢ç‚¹å‡»ğŸ‘‰<a href="https://bugcat9.github.io/">https://bugcat9.github.io/</a></p>
<p>æŸ¥çœ‹åšå®¢ä»“åº“ç‚¹å‡»ğŸ‘‰<a href="https://github.com/bugcat9/bugcat9.github.io">https://github.com/bugcat9/bugcat9.github.io</a></p>
<span id="more"></span>
<p>åœ¨è¿™é‡Œå…ˆè¯´æ˜ä¸€ä¸‹æˆ‘çš„é¡¹ç›®çš„åˆ†æ”¯ç»“æ„ï¼Œæˆ‘æ˜¯å°†é¡¹ç›®æ”¾åˆ°äº†<strong><a href="https://github.com/bugcat9/bugcat9.github.io">bugcat9.github.io</a></strong>ä¸‹ï¼Œä¸‹é¢æœ‰masterã€gh-pagesã€sourceã€hexoå››ä¸ªåˆ†æ”¯</p>
<ul>
<li>masterï¼Œå•¥ä¹Ÿä¸å¹²èµ·è¯´æ˜ä½œç”¨</li>
<li>gh-pagesï¼Œæ”¾hexoç”Ÿæˆçš„é™æ€æ–‡ä»¶</li>
<li>sourceï¼Œå­˜æ”¾æºæ–‡ä»¶</li>
<li>hexoï¼Œå­˜æ”¾hexoæ–‡ä»¶ï¼Œå¹¶éƒ¨ç½²äº†è‡ªåŠ¨åŒ–</li>
</ul>
<h2 id="ä¸Šä¼ hexoé¡¹ç›®æ–‡ä»¶"><a href="#ä¸Šä¼ hexoé¡¹ç›®æ–‡ä»¶" class="headerlink" title="ä¸Šä¼ hexoé¡¹ç›®æ–‡ä»¶"></a>ä¸Šä¼ hexoé¡¹ç›®æ–‡ä»¶</h2><p>ğŸ¤—<strong>å¦‚æœä¼šå°†hexoé¡¹ç›®å®‰å…¨ä¸Šä¼ åˆ°githubä¸Šçš„å¯ä»¥ç›´æ¥è·³è¿‡è¿™æ­¥äº†ã€‚</strong>æ„Ÿè§‰è¿™æ­¥å†™çš„æœ‰ç‚¹å•°å—¦</p>
<p>ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªhexoé¡¹ç›®å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530203146315.png" alt="image-20210530203146315"></p>
<p>æœ¬äººä¸Šä¼ çš„ä¹‹å‰æ˜¯å…ˆç›´æ¥åˆ é™¤äº†ä¸‹é¢å‡ æ ·ä¸œè¥¿ï¼š</p>
<ul>
<li><code>.github</code>æ–‡ä»¶å¤¹ï¼ŒåŒ…æ‹¬æ ¹ç›®å½•å’Œ<code>themes</code>é‡Œé¢çš„</li>
<li>å› ä¸º<code>themes</code>é‡Œé¢çš„ä¸»é¢˜æœ‰çš„æ˜¯<code>git clone</code>æ¥çš„,æ‰€ä»¥æˆ‘ä¹Ÿç»™åˆ é™¤äº†<code>.git</code>æ–‡ä»¶å¤¹</li>
</ul>
<p>ç„¶åå°†å‰©ä¸‹çš„æ–‡ä»¶ï¼Œä¸Šä¼ åˆ°æ–°çš„ä»“åº“æˆ–è€…æŸä¸ªä»“åº“çš„æŸä¸ªåˆ†æ”¯ï¼Œæˆ‘æ˜¯ç»™ä¸Šä¼ åˆ°äº†<strong><a href="https://github.com/bugcat9/bugcat9.github.io">bugcat9.github.io</a></strong>ä¸‹çš„hexoåˆ†æ”¯</p>
<h2 id="ç”Ÿæˆå¯†é’¥"><a href="#ç”Ÿæˆå¯†é’¥" class="headerlink" title="ç”Ÿæˆå¯†é’¥"></a>ç”Ÿæˆå¯†é’¥</h2><p>å› ä¸ºéœ€è¦å°†hexoé¡¹ç›®ç”Ÿæˆçš„é™æ€æ–‡ä»¶ä¸Šä¼ åˆ°githubä¸Šï¼ˆè·Ÿæœ¬åœ°ä¸Šä¼ ç±»ä¼¼ï¼‰ï¼Œæ‰€ä»¥éœ€è¦ç”Ÿæˆå¯†é’¥è¿›è¡Œä¸Šä¼ ã€‚</p>
<p>ç”Ÿæˆå‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh-keygen -t rsa -b 4096 -C &quot;Hexo Deploy Key&quot; -f github-deploy-key -N &quot;&quot;</span><br></pre></td></tr></table></figure>
<p>åœ¨windowsä¸‹å¯ä»¥é€šè¿‡<code>git bash</code>ç”Ÿæˆï¼Œç›¸ä¿¡åœ¨é…ç½®gitçš„æ—¶å€™åº”è¯¥äº†è§£è¿‡</p>
<p><code>ssh-keygen</code>å‘½ä»¤è®²è§£å¯ä»¥çœ‹çš„â¡<a href="https://www.linuxcool.com/ssh-keygen">https://www.linuxcool.com/ssh-keygen</a></p>
<p>è¿™ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>github-deploy-key â€”â€” ç§é’¥</li>
<li>github-deploy-key.pub â€”â€” å…¬é’¥</li>
</ul>
<h2 id="é…ç½®ç§é’¥"><a href="#é…ç½®ç§é’¥" class="headerlink" title="é…ç½®ç§é’¥"></a>é…ç½®ç§é’¥</h2><p>æŠŠ<strong>ç§é’¥</strong>æ”¾åœ¨hexoé¡¹ç›®çš„ä»£ç ä»“åº“å½“ä¸­çš„Secretsä¸­ï¼Œè¿™æ˜¯ä¸ºäº†é…ç½®actionçš„æ—¶å€™ä½¿ç”¨ï¼Œåœ¨æˆ‘è¿™é‡Œå°±æ˜¯<strong><a href="https://github.com/bugcat9/bugcat9.github.io">bugcat9.github.io</a></strong>é¡¹ç›®(hexoåˆ†æ”¯)</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530211649771.png" alt="image-20210530211649771"></p>
<p>ä¾æ¬¡ç‚¹å‡»<code>Setting</code>ã€<code>Secrets</code>ã€<code>New repository secret</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530211935519.png" alt="image-20210530211935519"></p>
<p>è¾“å…¥åå­—HEXO_DEPLOY_KEYï¼Œä»¥åŠå¯¹åº”çš„å†…å®¹ï¼Œç„¶åå°±å¯ä»¥ç”ŸæˆRepository secretsäº†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530212045237.png" alt="image-20210530212045237"></p>
<h2 id="é…ç½®å…¬é’¥"><a href="#é…ç½®å…¬é’¥" class="headerlink" title="é…ç½®å…¬é’¥"></a>é…ç½®å…¬é’¥</h2><p>æŠŠå…¬é’¥æ”¾åœ¨éœ€è¦ä¸Šä¼ é™æ€æ–‡ä»¶çš„é¡¹ç›®ä¸­ï¼Œåœ¨æˆ‘è¿™é‡Œä¹Ÿæ˜¯<strong><a href="https://github.com/bugcat9/bugcat9.github.io">bugcat9.github.io</a></strong>é¡¹ç›®(gh-pagesåˆ†æ”¯)</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530212318098.png" alt="image-20210530212318098"></p>
<p>ä¾æ¬¡ç‚¹å‡»<code>Setting</code>ã€<code>Deploy keys</code>ã€<code>add deploy key</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530212539068.png" alt="image-20210530212539068"></p>
<p>è¾“å…¥åå­—HEXO_DEPLOY_PUB ï¼Œä»¥åŠå¯¹åº”çš„å†…å®¹ï¼Œç„¶åè®°å¾—å‹¾é€‰<code>Allow write access</code>,ç„¶åç‚¹å‡»<code>Add key</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210530212652197.png" alt="image-20210530212652197"></p>
<h2 id="é…ç½®å…¶ä»–å†…å®¹"><a href="#é…ç½®å…¶ä»–å†…å®¹" class="headerlink" title="é…ç½®å…¶ä»–å†…å®¹"></a>é…ç½®å…¶ä»–å†…å®¹</h2><p>åœ¨æˆ‘è¿™é‡Œé¢è¦é…ç½®<code>gitalk</code>çš„CLIENT_IDå’ŒCLIENT_SECRETçš„å€¼ï¼Œé…ç½®æ–¹æ³•å’Œé…ç½®ç§é’¥æ˜¯ä¸€æ ·çš„</p>
<p>CLIENT_IDï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210531230828953.png" alt="image-20210531230828953"></p>
<p>CLIENT_SECRETï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210531230912586.png" alt="image-20210531230912586"></p>
<p>æœ€ç»ˆ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210531231008588.png" alt="image-20210531231008588"></p>
<h2 id="åˆ›å»º-Workflow"><a href="#åˆ›å»º-Workflow" class="headerlink" title="åˆ›å»º Workflow"></a>åˆ›å»º Workflow</h2><p>åœ¨ Hexo çš„ä»“åº“æˆ–è€…hexoä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ï¼š<code>.github/workflows/deploy.yml</code>ï¼Œæ–‡ä»¶åå¯ä»¥è‡ªå·±å–ï¼Œä½†æ˜¯ä¸€å®šè¦æ”¾åœ¨ <code>.github/workflows</code> ç›®å½•ä¸­ï¼Œæ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Hexo</span> <span class="string">Deploy</span></span><br><span class="line"><span class="comment"># è¦è§¦å‘çš„åˆ†æ”¯</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">hexo</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">github.event.repository.owner.id</span> <span class="string">==</span> <span class="string">github.event.sender.id</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span> <span class="string">source</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">        <span class="comment"># è®¾ç½®å¯¹åº”çš„åˆ†æ”¯ï¼Œæœ¬æ–‡è¿™é‡Œæ˜¯hexoåˆ†æ”¯</span></span><br><span class="line">          <span class="attr">ref:</span> <span class="string">hexo</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node.js</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-node@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">&#x27;12&#x27;</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Hexo</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">ACTION_DEPLOY_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.HEXO_DEPLOY_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">          echo &quot;$ACTION_DEPLOY_KEY&quot; &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          chmod 700 ~/.ssh</span></span><br><span class="line"><span class="string">          chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">          ssh-keyscan github.com &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string">          ## è®¾ç½®è‡ªå·±é‚®ç®±å’Œgithubç”¨æˆ·å</span></span><br><span class="line"><span class="string">          git config --global user.email &quot;1767508581@qq.com&quot;</span></span><br><span class="line"><span class="string">          git config --global user.name &quot;bugcat9&quot;</span></span><br><span class="line"><span class="string">          npm install hexo-cli -g</span></span><br><span class="line"><span class="string">          npm install</span></span><br><span class="line"><span class="string"></span>      <span class="comment">### è®¾ç½®gitalk,ä¸éœ€è¦å¯ä»¥åˆ é™¤æ‰</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">gitalk</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">CLIENT_ID:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CLIENT_ID</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">CLIENT_SECRET:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.CLIENT_SECRET&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sed -i &#x27;639s/123/$CLIENT_ID/&#x27; ./themes/next/_config.yml</span></span><br><span class="line"><span class="string">          sed -i &#x27;640s/123/$CLIENT_SECRET/&#x27; ./themes/next/_config.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          hexo clean</span></span><br><span class="line"><span class="string">          hexo deploy</span></span><br></pre></td></tr></table></figure>
<p> ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ä¸Šä¼ æ–‡ä»¶åˆ°hexoçš„æ—¶å€™ï¼Œä»–ä¼šè§¦å‘è¿™ä¸ªWorkflowï¼Œç„¶åæ„å»ºubuntuæœ€æ–°çš„ç¯å¢ƒï¼Œæ¥ç€æ„å»ºnodejsç¯å¢ƒã€gitç¯å¢ƒã€hexoç¯å¢ƒï¼Œå†è®¾ç½®gitalkï¼Œæœ€åå†è¿è¡Œ<code>hexo clean</code>ã€<code>hexo deploy</code>è¿›è¡Œä¸Šä¼ </p>
<p>ä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜å¦‚æœæˆ‘ä»¬hexoåˆ†æ”¯ä¸åœ¨defaultåˆ†æ”¯ï¼Œé»˜è®¤æ˜¯è§¦å‘ä¸äº†çš„Workflowçš„ï¼Œéœ€è¦å°†hexoåˆ‡æ¢æˆdefaultåˆ†æ”¯æ‰èƒ½è§¦å‘ã€‚åˆ‡æ¢çš„æ–¹æ³•æ˜¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20210601104734139.png" alt="image-20210601104734139"></p>
<p>ç„¶åå°±å¯ä»¥é€šè¿‡ä¸Šä¼ è¿›è¡Œè§¦å‘äº†ã€‚</p>
<p>åç»­çš„è¯ï¼Œå°†masteråˆ‡æ¢å›defaultä¹Ÿæ˜¯å¯ä»¥è§¦å‘çš„ã€‚</p>
<h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>é…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²å…¶å®ä¸æ˜¯å¾ˆéš¾ï¼Œå°±æ˜¯åˆšåˆšæ¥è§¦github actionå•¥éƒ½ä¸æ‡‚è€½è¯¯äº†å¾ˆä¹…ï¼Œåœ¨è¿™å°ç»“ä¸€ä¸‹ï¼Œæ–¹ä¾¿è‡ªå·±æ—¥åæ¢ç”µè„‘çš„æ—¶å€™ä½¿ç”¨ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong><a href="https://zhuanlan.zhihu.com/p/170563000">https://zhuanlan.zhihu.com/p/170563000</a></p>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
        <tag>github action</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨Github Actionå®ç°Androidè‡ªåŠ¨æ‰“åŒ…</title>
    <url>/2021/09/23/%E5%85%B6%E4%BB%96/%E4%BD%BF%E7%94%A8Github%20Action%E5%AE%9E%E7%8E%B0Android%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85/</url>
    <content><![CDATA[<h1 id="ä½¿ç”¨Github-Actionå®ç°Androidè‡ªåŠ¨æ‰“åŒ…"><a href="#ä½¿ç”¨Github-Actionå®ç°Androidè‡ªåŠ¨æ‰“åŒ…" class="headerlink" title="ä½¿ç”¨Github Actionå®ç°Androidè‡ªåŠ¨æ‰“åŒ…"></a>ä½¿ç”¨Github Actionå®ç°Androidè‡ªåŠ¨æ‰“åŒ…</h1><p>Github Actionæ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œæˆ‘ä½¿ç”¨ä»–å®ç°äº†hexoè‡ªåŠ¨æ‰“åŒ…ä¸Šä¼ ï¼Œç„¶åæˆ‘å°±åœ¨æƒ³èƒ½å¦ä½¿ç”¨Github Actionæ‰“åŒ…å†™å¥½çš„Androidä»£ç ï¼Œæ‰“åŒ…å¥½Androidçš„åŒ…apkï¼Œç»è¿‡æˆ‘åœ¨ç½‘ä¸ŠæŸ¥æ‰¾èµ„æ–™å‘ç°è¿™ä¸ªåŠŸèƒ½æ˜¯å®Œå…¨å¯ä»¥å®ç°çš„</p>
<span id="more"></span>
<h2 id="Androidå‘½ä»¤è¡Œæ‰“åŒ…"><a href="#Androidå‘½ä»¤è¡Œæ‰“åŒ…" class="headerlink" title="Androidå‘½ä»¤è¡Œæ‰“åŒ…"></a>Androidå‘½ä»¤è¡Œæ‰“åŒ…</h2><p>Android å‘½ä»¤è¡Œæ‰“åŒ…å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£<a href="https://developer.android.com/studio/build/building-cmdline?hl=zh-cn#sign_cmdline">https://developer.android.com/studio/build/building-cmdline?hl=zh-cn#sign_cmdline</a></p>
<p>æƒ³åœ¨Github Actionä¸Šè¿›è¡Œæ‰“åŒ…ï¼Œé¦–å…ˆè¦æ˜ç™½å¦‚ä½•åœ¨æœ¬åœ°ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œæ‰“åŒ…ï¼Œè¿™æ ·æ‰èƒ½åœ¨åœ¨Github Actionï¼Œé…ç½®å¯¹åº”çš„ç¯å¢ƒç„¶åä½¿ç”¨å¯¹åº”çš„å‘½ä»¤è¿›è¡Œæ‰“åŒ…ã€‚</p>
<p>å› ä¸ºæˆ‘ä»¬æ˜¯æƒ³è¦æ‰“åŒ…é‚£ç§æœ‰ç­¾åçš„apkæ–‡ä»¶ï¼Œæ‰€ä»¥å¾—ä½¿ç”¨jksæ–‡ä»¶ï¼Œç°åœ¨Androidæ‰“åŒ…ç­¾åä½¿ç”¨çš„æ˜¯jksæ–‡ä»¶ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç”Ÿæˆjksæ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Android Studioè¿›è¡Œç”Ÿæˆ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927194715475.png" alt="image-20210927194715475"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210923114803611.png" alt="image-20210923114803611"></p>
<p>æ¥ç€ä¸ºäº†æ–¹ä¾¿ï¼Œåœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º <code>keystore.properties</code> çš„æ–‡ä»¶ã€‚æ­¤æ–‡ä»¶åº”å½“åŒ…å«ç­¾åä¿¡æ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">storePassword</span>=<span class="string">myStorePassword</span></span><br><span class="line"><span class="attr">keyPassword</span>=<span class="string">mykeyPassword</span></span><br><span class="line"><span class="attr">keyAlias</span>=<span class="string">myKeyAlias</span></span><br><span class="line"><span class="attr">storeFile</span>=<span class="string">myStoreFileLocation</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ¨¡å—çš„ <code>build.gradle</code> æ–‡ä»¶ä¸­ï¼Œåœ¨ <code>android &#123;&#125;</code> å—çš„å‰é¢æ·»åŠ ç”¨äºåŠ è½½ <code>keystore.properties</code> æ–‡ä»¶çš„ä»£ç ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create a variable called keystorePropertiesFile, and initialize it to your</span></span><br><span class="line"><span class="comment">// keystore.properties file, in the rootProject folder.</span></span><br><span class="line"><span class="keyword">def</span> keystorePropertiesFile = rootProject.file(<span class="string">&quot;keystore.properties&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Initialize a new Properties() object called keystoreProperties.</span></span><br><span class="line"><span class="keyword">def</span> keystoreProperties = <span class="keyword">new</span> Properties()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Load your keystore.properties file into the keystoreProperties object.</span></span><br><span class="line">keystoreProperties.load(<span class="keyword">new</span> FileInputStream(keystorePropertiesFile))</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹æ¨¡å—çš„ <code>build.gradle</code> æ–‡ä»¶çš„ <code>signingConfigs</code> å—ï¼Œä»¥ä¾¿ä½¿ç”¨æ­¤è¯­æ³•å¼•ç”¨å­˜å‚¨åœ¨ <code>keystoreProperties</code> ä¸­çš„ç­¾åä¿¡æ¯ã€‚</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        config &#123;</span><br><span class="line">            keyAlias keystoreProperties[<span class="string">&#x27;keyAlias&#x27;</span>]</span><br><span class="line">            keyPassword keystoreProperties[<span class="string">&#x27;keyPassword&#x27;</span>]</span><br><span class="line">            storeFile file(keystoreProperties[<span class="string">&#x27;storeFile&#x27;</span>])</span><br><span class="line">            storePassword keystoreProperties[<span class="string">&#x27;storePassword&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            signingConfig signingConfigs.config <span class="comment">//é…ç½®ç­¾åæ–‡ä»¶</span></span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android-optimize.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥å‘½ä»¤</p>
<figure class="highlight cmd"><table><tr><td class="code"><pre><span class="line">gradlew assembleRelease</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927203126908.png" alt="image-20210927203126908"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927203156145.png" alt="image-20210927203156145"></p>
<p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆç”Ÿæˆçš„releaseç‰ˆçš„apkæ–‡ä»¶ï¼Œè¯´æ˜Androidå‘½ä»¤è¡Œæ‰“åŒ…æˆåŠŸ</p>
<h2 id="ä½¿ç”¨GitHub-Actionæ‰“åŒ…"><a href="#ä½¿ç”¨GitHub-Actionæ‰“åŒ…" class="headerlink" title="ä½¿ç”¨GitHub Actionæ‰“åŒ…"></a>ä½¿ç”¨GitHub Actionæ‰“åŒ…</h2><p>æˆ‘ä»¬åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º.github/workflows/build_apk.ymlè¿™æ ·çš„æ–‡ä»¶ï¼Œå®ƒæ˜¯GitHub Actionçš„é…ç½®æ–‡ä»¶</p>
<p>éœ€è¦åœ¨GitHub Actionä¸Šé…ç½®ç¯å¢ƒï¼Œå¯ä»¥çœ‹ä¸‹é¢çš„é…ç½®è¿™æ ·å¯ä»¥æ‰“åŒ…å‡ºapk</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># è®¾ç½®jdkç¯å¢ƒä¸º1.8</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">up</span> <span class="string">JDK</span> <span class="number">1.8</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-java@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æ‰“åŒ…release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Gradle</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">bash</span> <span class="string">./gradlew</span> <span class="string">assembleRelease</span></span><br></pre></td></tr></table></figure>
<p>æ‰“åŒ…å‡ºapkåæˆ‘ä»¬éœ€è¦æŠŠapkè¿›è¡Œä¸Šä¼ ï¼Œä¸‹é¢çš„æ–¹æ³•æ˜¯è¿›è¡Œä¸Šä¼ ï¼Œä¸Šä¼ ä¹‹åå¯ä»¥åœ¨GitHub Actionä¸Šçœ‹åˆ°</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#stepï¼šä¸Šä¼ apk åˆ°actionï¼Œåœ¨å³ä¸Šè§’æŸ¥çœ‹</span></span><br><span class="line"><span class="comment"># å®˜æ–¹æ–‡æ¡£ https://help.github.com/cn/actions/automating-your-workflow-with-github-actions/persisting-workflow-data-using-artifacts#uploading-build-and-test-artifacts</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">APK</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">app/build/outputs/apk/release/app-release.apk</span></span><br></pre></td></tr></table></figure>
<p>ä¸Šä¼ çš„ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927204736195.png" alt="image-20210927204736195"></p>
<p>ä½†æ˜¯å…‰åœ¨è¿™é‡Œä¸Šä¼ å¹¶ä¸ä¼šè¿›è¡Œreleaseå‘å¸ƒï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥ç€åŠ </p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºrealease</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Release</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">create_release</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/create-release@v1</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">tag_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">release_name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">prerelease:</span> <span class="literal">false</span></span><br><span class="line"><span class="comment"># ä¸Šä¼ apkåˆ°release</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">Release</span> <span class="string">Asset</span></span><br><span class="line">  <span class="attr">id:</span> <span class="string">upload-release-asset</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/upload-release-asset@v1</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># This pulls from the CREATE RELEASE step above, referencing it&#x27;s ID to get its outputs object, which include a `upload_url`.</span></span><br><span class="line">    <span class="comment"># See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps</span></span><br><span class="line">    <span class="attr">upload_url:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.create_release.outputs.upload_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">asset_path:</span> <span class="string">app/build/outputs/apk/release/app-release.apk</span></span><br><span class="line">    <span class="attr">asset_name:</span> <span class="string">App.apk</span></span><br><span class="line">    <span class="attr">asset_content_type:</span> <span class="string">application/vnd.android.package-archiv</span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ˜¯ä¸Šä¼ åˆ°releaseä¸Šï¼Œä½†æ˜¯è¿™ä¸ªæŒ‰ç…§æ•™ç¨‹ä¼¼ä¹åªèƒ½ä½¿ç”¨tagè¿›è¡Œï¼Œå› ä¸ºè¿™æ ·<code>github.ref</code>æ‰æœ‰æ„ä¹‰</p>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ä¸Šä¼ ä¸€ä¸ªtagä¹‹åï¼Œæœ€ç»ˆæ•ˆæœæ˜¯è¿™æ ·çš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210927205713787.png" alt="image-20210927205713787"></p>
<h2 id="ä½¿ç”¨secret"><a href="#ä½¿ç”¨secret" class="headerlink" title="ä½¿ç”¨secret"></a>ä½¿ç”¨secret</h2><p>ä¸Šé¢è¿™æ ·åšåªèƒ½ä½¿ç”¨ç§äººä»“åº“ï¼Œå› ä¸ºåœ¨<code>keystore.properties</code>é‡Œé¢å†™ç€å¯†ç å’Œåˆ«åï¼Œå¦‚æœå¼€æºåˆ«äººå°±èƒ½ä¸‹è½½ç„¶åç”¨è¿™ä¸ªjksæ‰“åŒ…ï¼Œè¿™è‚¯å®šä¸å¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨secretï¼Œåœ¨é…ç½®ç¯å¢ƒçš„æ—¶å€™ä½¿ç”¨sedæ›´æ”¹å¯†ç ã€‚</p>
<p>åœ¨ä»“åº“çš„settingä¸­æˆ‘ä»¬åŠ å…¥<code>ALIAS</code>å’Œ<code>PASSWORD</code>ä¸¤ä¸ªsecretï¼Œå…¶ä¸­å°±æ˜¯jksçš„åˆ«åå’Œå¯†ç (è¿™é‡Œæˆ‘å°†storePasswordå’ŒkeyPasswordè®¾ç½®çš„ä¸€æ ·ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªå¯†ç )</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210929170814946.png" alt="image-20210929170814946"></p>
<p>æ›´æ”¹<code>keystore.properties</code>ä¸º</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><span class="line"><span class="attr">storePassword</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">keyPassword</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">keyAlias</span>=<span class="string">123</span></span><br><span class="line"><span class="attr">storeFile</span>=<span class="string">../App.jks</span></span><br></pre></td></tr></table></figure>
<p>æ›´æ”¹æ‰“åŒ…å‘½ä»¤</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># è®¾ç½®jdkç¯å¢ƒä¸º1.8</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">up</span> <span class="string">JDK</span> <span class="number">1.8</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-java@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æ‰“åŒ…release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Gradle</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">PASSWORD:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PASSWORD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">ALIAS:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ALIAS</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sed -i &quot;1s/123/$PASSWORD/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          sed -i &quot;2s/123/$PASSWORD/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          sed -i &quot;3s/123/$ALIAS/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          bash ./gradlew assembleRelease</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†sedå‘½ä»¤æ›´æ”¹äº†<code>keystore.properties</code>ä¸­çš„æ•°æ®ï¼Œè¿™æ ·å°±ä¸ä¼šæ³„éœ²ç§˜å¯†å’Œåˆ«åï¼Œä¹Ÿå°±è¾¾åˆ°äº†å®‰å…¨çš„ç›®çš„</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ€åçš„é…ç½®æ–‡ä»¶æ˜¯è¿™æ ·çš„</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Android</span> <span class="string">CI</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è§¦å‘å™¨</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">tags:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;*&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># è®¾ç½®jdkç¯å¢ƒä¸º1.8</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">up</span> <span class="string">JDK</span> <span class="number">1.8</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/setup-java@v1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">java-version:</span> <span class="number">1.8</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># æ‰“åŒ…release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">with</span> <span class="string">Gradle</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">PASSWORD:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.PASSWORD</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">ALIAS:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.ALIAS</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          sed -i &quot;1s/123/$PASSWORD/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          sed -i &quot;2s/123/$PASSWORD/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          sed -i &quot;3s/123/$ALIAS/&quot; keystore.properties</span></span><br><span class="line"><span class="string">          bash ./gradlew assembleRelease</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      <span class="comment">#stepï¼šä¸Šä¼ apk åˆ°actionï¼Œåœ¨å³ä¸Šè§’æŸ¥çœ‹</span></span><br><span class="line">      <span class="comment"># å®˜æ–¹æ–‡æ¡£ https://help.github.com/cn/actions/automating-your-workflow-with-github-actions/persisting-workflow-data-using-artifacts#uploading-build-and-test-artifacts</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">APK</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-artifact@v2</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">app/build/outputs/apk/release/app-release.apk</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># åˆ›å»ºrealease</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">Release</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">create_release</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/create-release@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">tag_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">release_name:</span> <span class="string">Release</span> <span class="string">$&#123;&#123;</span> <span class="string">github.ref</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">draft:</span> <span class="literal">false</span></span><br><span class="line">          <span class="attr">prerelease:</span> <span class="literal">false</span></span><br><span class="line">      <span class="comment"># ä¸Šä¼ apkåˆ°release</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Upload</span> <span class="string">Release</span> <span class="string">Asset</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">upload-release-asset</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/upload-release-asset@v1</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="comment"># This pulls from the CREATE RELEASE step above, referencing it&#x27;s ID to get its outputs object, which include a `upload_url`.</span></span><br><span class="line">          <span class="comment"># See this blog post for more info: https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps</span></span><br><span class="line">          <span class="attr">upload_url:</span> <span class="string">$&#123;&#123;</span> <span class="string">steps.create_release.outputs.upload_url</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">asset_path:</span> <span class="string">app/build/outputs/apk/release/app-release.apk</span></span><br><span class="line">          <span class="attr">asset_name:</span> <span class="string">App.apk</span></span><br><span class="line">          <span class="attr">asset_content_type:</span> <span class="string">application/vnd.android.package-archiv</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨github Actionè¿›è¡Œæ‰“åŒ…å‘å¸ƒå°±å†™åˆ°è¿™é‡Œã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://developer.android.google.cn/studio/build/building-cmdline?hl=ru#ReleaseMode">https://developer.android.google.cn/studio/build/building-cmdline?hl=ru#ReleaseMode</a></li>
<li><a href="https://blog.csdn.net/ZZL23333/article/details/115798615">https://blog.csdn.net/ZZL23333/article/details/115798615</a></li>
<li><a href="https://xuexuan.blog.csdn.net/article/details/103921480?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.control">https://xuexuan.blog.csdn.net/article/details/103921480?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7Edefault-5.control</a></li>
</ul>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>github action</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”µè„‘ä¸Šç©GBAæ¸¸æˆ</title>
    <url>/2022/08/26/%E5%85%B6%E4%BB%96/%E7%94%B5%E8%84%91%E4%B8%8A%E7%8E%A9GBA%E6%B8%B8%E6%88%8F/</url>
    <content><![CDATA[<h1 id="ç”µè„‘ä¸Šç©GBAæ¸¸æˆï¼ˆGBAæ¨¡æ‹Ÿå™¨ï¼‰"><a href="#ç”µè„‘ä¸Šç©GBAæ¸¸æˆï¼ˆGBAæ¨¡æ‹Ÿå™¨ï¼‰" class="headerlink" title="ç”µè„‘ä¸Šç©GBAæ¸¸æˆï¼ˆGBAæ¨¡æ‹Ÿå™¨ï¼‰"></a>ç”µè„‘ä¸Šç©GBAæ¸¸æˆï¼ˆGBAæ¨¡æ‹Ÿå™¨ï¼‰</h1><p>æœ€è¿‘é‡æ¸©äº†ç¥å¥‡å®è´ç³»åˆ—çš„åŠ¨ç”»ï¼Œæƒ³åˆ°å°æ—¶å€™åœ¨GBAä¸Šç©çš„å£è¢‹å¦–æ€ªç³»åˆ—æ¸¸æˆï¼Œæƒ³åœ¨ç”µè„‘ä¸Šé‡æ–°ç©ä¸€ä¸‹ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹å‡ ä¸ªå¼€æºçš„GBAæ¸¸æˆæ¨¡æ‹Ÿå™¨ã€‚</p>
<h2 id="visualboyadvance-m"><a href="#visualboyadvance-m" class="headerlink" title="visualboyadvance-m"></a>visualboyadvance-m</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/visualboyadvance-m/visualboyadvance-m">https://github.com/visualboyadvance-m/visualboyadvance-m</a></p>
<p>ç›´æ¥å»releaseé‡Œé¢ä¸‹è½½</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220831230708171.png" alt="image-20220831230708171"></p>
<p>visualboyadvance-m-Win-64bit.zipæ˜¯æ‰“åŒ…å¥½çš„æ¨¡æ‹Ÿå™¨ã€‚</p>
<p>translations.zipæ˜¯ç¿»è¯‘æ–‡ä»¶ï¼Œå› ä¸ºåŸç‰ˆæ˜¯è‹±æ–‡çš„ï¼Œæˆ‘ä»¬æƒ³ç”¨ä¸­æ–‡å°±å¾—ä¸‹è½½è¿™ä¸ª</p>
<span id="more"></span>
<h3 id="é…ç½®ä¸­æ–‡"><a href="#é…ç½®ä¸­æ–‡" class="headerlink" title="é…ç½®ä¸­æ–‡"></a>é…ç½®ä¸­æ–‡</h3><p>å°†visualboyadvance-m-Win-64bit.zipå’Œtranslations.zipéƒ½è§£å‹ä¸€ä¸‹åˆ°å„è‡ªçš„æ–‡ä»¶å¤¹ã€‚è§£å‹ä¹‹å<code>visualboyadvance-m-Win-64bit</code>æ–‡ä»¶å¤¹ä¸‹åªæœ‰ä¸€ä¸ªexeæ–‡ä»¶ï¼Œç›´æ¥è¿è¡Œæ˜¯ä»¥è‹±æ–‡çš„ç¯å¢ƒæ‰“å¼€ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220901224146745.png" alt="image-20220901224146745"></p>
<p>æ‰€ä»¥éœ€è¦é…ç½®ä¸€ä¸‹ä¸­æ–‡ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä½¿ç”¨ã€‚æˆ‘ä»¬ä»è§£å‹çš„<code>translations</code>æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°<code>zh_CN</code>æ–‡ä»¶å¤¹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220901224620622.png" alt="image-20220901224620622"></p>
<p>å°†<code>zh_CN</code>å¤åˆ¶åˆ°<code>visualboyadvance-m.exe</code>çš„åŒçº§ç›®å½•ï¼Œç„¶åæ‰“å¼€å°±æ˜¯ä¸­æ–‡çš„ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220901224945457.png" alt="image-20220901224945457"></p>
<h3 id="æ‰“å¼€æ¸¸æˆ"><a href="#æ‰“å¼€æ¸¸æˆ" class="headerlink" title="æ‰“å¼€æ¸¸æˆ"></a>æ‰“å¼€æ¸¸æˆ</h3><p>é€‰æ‹©â€œæ–‡ä»¶â€-&gt;â€œopenâ€</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220901231117574.png" alt="image-20220901231117574"></p>
<p>ç„¶åæ‰¾åˆ°è‡ªå·±ä¸‹è½½æ¸¸æˆèµ„æºçš„æ–‡ä»¶å¤¹æ‰“å¼€å¯¹åº”çš„æ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220901231641236.png" alt="image-20220901231641236"></p>
<p>å°±å¯ä»¥å¿«ä¹çš„ç©è€äº†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220903222532385.png" alt="image-20220903222532385"></p>
<p>vbaå¯ä»¥é€šè¿‡<code>ctrl+G</code>å¿«æ·é”®å®ç°è°ƒæ•´æ»¤é•œï¼Œè®©ä¹‹å‰åƒç´ çº§åˆ«çš„æ¸¸æˆç”»è´¨æ¸…æ™°ä¸€äº›ã€‚</p>
<h3 id="è”æœº"><a href="#è”æœº" class="headerlink" title="è”æœº"></a>è”æœº</h3><p>vbaæœ‰ä¸ªä»¤æˆ‘æ²¡æœ‰æƒ³åˆ°çš„åŠŸèƒ½é‚£å°±æ˜¯è”æœºï¼Œå¯¹ä½ æ²¡çœ‹é”™è¿™ç©æ„è¿˜å¯ä»¥å®ç°è”æœºï¼Œä¹Ÿå°±æ˜¯å°æ—¶gbaé€šè¿‡æ•°æ®çº¿è¿æ¥ï¼Œç„¶åè¿›è¡Œè”æœºçš„é‚£ç§åŠŸèƒ½ã€‚</p>
<p>ä¸è¿‡è¿™ä¸ªåŠŸèƒ½ä¼¼ä¹åªèƒ½åœ¨å±€åŸŸç½‘ä¸‹å®ç°ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åœ¨ä¸€å°ç”µè„‘ä¸Šæ¥å±•ç¤ºè¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆéœ€è¦æŠŠâ€œéæ¿€æ´»çŠ¶æ€æ—¶æš‚åœâ€è¿™ä¸ªå‹¾é€‰å»æ‰ï¼Œé˜²æ­¢é¼ æ ‡ç§»å‡ºå»å°±æš‚åœã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913183841775.png" alt="image-20220913183841775"></p>
<p>ç„¶åæˆ‘ä»¬æ‰“å¼€ä¸¤ä¸ªvbaæ¨¡æ‹Ÿå™¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913184458847.png" alt="image-20220913184458847"></p>
<p>æˆ‘ä»¬æ‰“å¼€æ¯ä¸ªæ¨¡æ‹Ÿå™¨çš„â€œé€‰é¡¹â€-&gt;â€è¿æ¥â€-&gt;â€œå¼€å§‹ç½‘ç»œè¿æ¥â€</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913184959007.png" alt="image-20220913184959007"></p>
<p>ä¼šå¼¹å‡ºå¦‚ä¸‹çš„ä¸¤ä¸ªæ¡†æ¡†ï¼Œæˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªåšæœåŠ¡å™¨ä¸€ä¸ªåšå®¢æˆ·ç«¯ï¼Œç©å®¶é€‰æ‹©2å› ä¸ºæˆ‘ä»¬æ˜¯ä¸¤ä¸ªç©å®¶ä¸€èµ·ç©ï¼Œæœ€å¤š4ä¸ªç©å®¶ä¸€èµ·ç©ã€‚</p>
<p>å®¢æˆ·ç«¯ä¸­å¡«å†™çš„æœåŠ¡å™¨:127.0.0.1ä»£è¡¨æœ¬åœ°çš„åœ°å€ï¼Œå¦‚æœä½ ä»¬æ˜¯å±€åŸŸç½‘å†…å¯ä»¥å¡«å†™æœåŠ¡å™¨æ‰€åœ¨ç”µè„‘çš„åœ°å€ã€‚</p>
<p>ç„¶åæˆ‘ä»¬ç‚¹å‡»è¿æ¥å°±å¯ä»¥å¼€å§‹è”æœºç©è€äº†ï¼Œå°¤å…¶æ˜¯æ˜Ÿä¹‹å¡æ¯”è”æœºç©æ‰æœ€å¥½ç©ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913185058478.png" alt="image-20220913185058478"></p>
<h2 id="mgba"><a href="#mgba" class="headerlink" title="mgba"></a>mgba</h2><h3 id="ä¸‹è½½-1"><a href="#ä¸‹è½½-1" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/mgba-emu/mgba">https://github.com/mgba-emu/mgba</a></p>
<p>ç›´æ¥å»releaseé‡Œé¢ä¸‹è½½</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913190538794.png" alt="image-20220913190538794"></p>
<h3 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="headerlink" title="è¿è¡Œ"></a>è¿è¡Œ</h3><p>ç›´æ¥åŒå‡»mGBA.exeå³å¯ã€‚æ‰“å¼€æ¸¸æˆçš„æ–¹å¼å’Œä¸Šé¢çš„vbaç›¸åŒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913190838019.png" alt="image-20220913190838019"></p>
<h3 id="è°ƒæ•´æ»¤é•œ"><a href="#è°ƒæ•´æ»¤é•œ" class="headerlink" title="è°ƒæ•´æ»¤é•œ"></a>è°ƒæ•´æ»¤é•œ</h3><p>ç”±äºç”»è´¨é—®é¢˜æœ‰æ—¶å€™éœ€è¦è°ƒæ•´æ»¤é•œï¼Œä½†æ˜¯mGBAä¸­æˆ‘ç›®å‰æ²¡æœ‰æ‰¾åˆ°å¿«æ·é”®ï¼Œåªèƒ½é€šè¿‡æ‰“å¼€è®¾ç½®ï¼Œç„¶åè½½å¦‚æ–°çš„ç€è‰²å™¨è¿›è¡Œå®ç°ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913191205304.png" alt="image-20220913191205304"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20220913191400752.png" alt="image-20220913191400752"></p>
]]></content>
      <categories>
        <category>GBAæ¸¸æˆ</category>
      </categories>
      <tags>
        <tag>å…¶ä»–</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¬¬15è®²ï¼šSCRUMæ•æ·è½¯ä»¶æ¨¡å‹å¼€å‘è¿‡ç¨‹</title>
    <url>/2021/05/20/%E5%85%B6%E4%BB%96/%E7%AC%AC15%E8%AE%B2%EF%BC%9ASCRUM%E6%95%8F%E6%8D%B7%E8%BD%AF%E4%BB%B6%E6%A8%A1%E5%9E%8B%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<blockquote>
<p>é‡ç‚¹ï¼š</p>
<p>ï¼ˆ1ï¼‰å›é¡¾å’Œæ€è€ƒCMMIæ¨¡å‹çš„æ ¸å¿ƒæ€æƒ³æ˜¯ä»€ä¹ˆï¼Ÿè¿™ä¸€æ¨¡å‹æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿé€‚åˆä»€ä¹ˆæ ·çš„ä¼ä¸šå’Œé¡¹ç›®ï¼Ÿ<br>ï¼ˆ2ï¼‰äº†è§£å­¦ç•Œæ‰€è¯´çš„â€œé‡â€è¿‡ç¨‹çš„â€œé‡â€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ ä¸ä¹‹ç›¸å¯¹åº”çš„â€œè½»â€è¿‡ç¨‹çš„è½»åˆæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ<br>ï¼ˆ3ï¼‰äº†è§£æ•æ·è½¯ä»¶å¼€å‘è¿‡ç¨‹çš„æŒ‡å¯¼æ€æƒ³ï¼Œäº†è§£SCRUMçš„åŸºæœ¬æ¡†æ¶ã€‚<br>ï¼ˆ4ï¼‰ç†è§£SCRUMæ•æ·å¼€å‘æ¨¡å‹çš„â€ä¸‰ä¸ªè§’è‰²â€œã€â€ä¸‰ä¸ªå·¥ä»¶â€œã€â€å››</p>
<p>ä¸ªä¼šè®®â€œçš„å†…å®¹å’Œæ–¹æ³•ã€‚</p>
</blockquote>
<span id="more"></span>
<h2 id="ä¸€ã€ç®€ä»‹ï¼š"><a href="#ä¸€ã€ç®€ä»‹ï¼š" class="headerlink" title="ä¸€ã€ç®€ä»‹ï¼š"></a>ä¸€ã€ç®€ä»‹ï¼š</h2><p>æ€æƒ³ï¼šä¸€åˆ‡ä¸ºäº†ç®€å•ã€å¿«æ·</p>
<p>ç®€ä»‹ï¼š</p>
<p>Scrumï¼šä¸€ç§è¿­ä»£å¼€å‘æ¡†æ¶ï¼Œæ˜¯ä¸€ä¸ªè½»é‡çº§çš„é¡¹ç›®ç®¡ç†çš„æ¡†æ¶ã€‚å®ƒçš„æ ¸å¿ƒåœ¨äºè¿­ä»£ã€‚</p>
<ol>
<li>ä¸‰ä¸ªè§’è‰²ï¼šäº§å“ç»ç†ã€é¡¹ç›®ç»ç†ã€å¼€å‘å›¢é˜Ÿ</li>
<li>ä¸‰ä¸ªå·¥ä»¶ï¼šäº§å“è®¢å•ã€å†²åˆºè®¢å•ã€ç‡ƒå°½å›¾</li>
<li>å››ä¸ªä¼šè®®ï¼šæ¯æ—¥ç«™ç«‹ä¼šã€å†²åˆºè®¡åˆ’ä¼šã€å†²åˆºè¯„å®¡ä¼šã€å†²åˆºå›é¡¾ä¼š</li>
</ol>
<p>ScrumåŒ…æ‹¬ï¼š1)é¢„å®šä¹‰çš„è§’è‰²ï¼›2)å®è·µæ´»åŠ¨ï¼›3) æ–‡æ¡£</p>
<p>Scrumè§’è‰²ï¼š</p>
<ul>
<li>Scrum Master</li>
<li>äº§å“è´Ÿè´£äºº</li>
<li>å¼€å‘å›¢é˜Ÿ</li>
</ul>
<p>Scrum å®è·µæ´»åŠ¨ï¼š</p>
<ul>
<li>å†²åˆºï¼š2åˆ°6å‘¨</li>
<li>å†²åˆºè®¡åˆ’ä¼šï¼šç¡®å®šåšä»€ä¹ˆ</li>
<li>ç«™ç«‹ä¼šè®®ï¼šåŠæ—¶åé¦ˆ</li>
</ul>
<h2 id="äºŒã€ç›¸å…³æ¦‚å¿µ"><a href="#äºŒã€ç›¸å…³æ¦‚å¿µ" class="headerlink" title="äºŒã€ç›¸å…³æ¦‚å¿µ"></a>äºŒã€ç›¸å…³æ¦‚å¿µ</h2><div class="table-container">
<table>
<thead>
<tr>
<th>åè¯</th>
<th>è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td>Sprint</td>
<td>å†²åˆºå‘¨æœŸï¼Œä¸€èˆ¬ä¸º2åˆ°6å‘¨æ—¶é—´</td>
</tr>
<tr>
<td>Sprint Planning Meeting</td>
<td>å†²åˆºè®¡åˆ’ä¼š</td>
</tr>
<tr>
<td>Sprint summary</td>
<td>å†²åˆºå›é¡¾ä¼š</td>
</tr>
<tr>
<td>User Story</td>
<td>ç”¨æˆ·çš„å¤–åœ¨ä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æŸ¥è¯¢ä½™é¢ã€‚ä¹Ÿå°±æ˜¯å°ç›®æ ‡</td>
</tr>
<tr>
<td>Task</td>
<td>ç”±User Storyæ‹†åˆ†æˆçš„å…·ä½“å¼€å‘ä»»åŠ¡</td>
</tr>
<tr>
<td>Backlog</td>
<td>éœ€æ±‚åˆ—è¡¨ï¼Œå¯ä»¥çœ‹æˆå°ç›®æ ‡çš„æ¸…å•ã€‚åˆ†ä¸º<strong>Sprint Backlog</strong>å’Œ<strong>Product Backlog</strong></td>
</tr>
<tr>
<td>Product Backlog</td>
<td>äº§å“ è®¢å•</td>
</tr>
<tr>
<td>Sprint Backlog</td>
<td>å†²åˆºè®¢å•</td>
</tr>
<tr>
<td>Daily meeting</td>
<td>æ¯å¤©çš„ç«™ä¼šï¼Œç”¨äºç›‘æ§é¡¹ç›®è¿›åº¦</td>
</tr>
<tr>
<td>Sprint Review meeting</td>
<td>å†²åˆºè¯„å®¡ä¼šè®®ï¼Œè®©å›¢é˜Ÿæˆå‘˜æ¼”ç¤ºæˆæœ</td>
</tr>
<tr>
<td>Sprint burn down</td>
<td>å†²åˆºç‡ƒå°½å›¾ï¼Œè¯´ç™½äº†å°±æ˜¯è®°å½•å½“å‰å‘¨æœŸçš„éœ€æ±‚å®Œæˆæƒ…å†µ</td>
</tr>
<tr>
<td>Rlease</td>
<td>å¼€å‘å‘¨æœŸå®Œæˆï¼Œé¡¹ç›®å‘å¸ƒæ–°çš„å¯ç”¨ç‰ˆæœ¬</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•æ·å¼€å‘/æ•æ·å¼€å‘1.png" alt="æ•æ·å¼€å‘1"></p>
<h2 id="ä¸‰ã€Scrum-Team"><a href="#ä¸‰ã€Scrum-Team" class="headerlink" title="ä¸‰ã€Scrum Team"></a>ä¸‰ã€Scrum Team</h2><p>Scrumå›¢é˜Ÿç”±æ‰€æœ‰å¯¹æœ€ç»ˆå‘å¸ƒçš„äº§å“åšå‡ºè´¡çŒ®çš„äººç»„æˆ</p>
<p>â€œSCRUM Masterâ€è§’è‰²ï¼šç›¸å½“äºé¡¹ç›®ç»ç†,ç»´æŠ¤è¿‡ç¨‹å’Œä»»åŠ¡</p>
<p>å›¢é˜ŸåŒ…æ‹¬ï¼š</p>
<ul>
<li>Scrumä¸»ç®¡(Scrum Master)</li>
<li>äº§å“è´Ÿè´£äºº(Product Owner)ï¼Œä»£è¡¨åˆ©ç›Šæ‰€æœ‰è€…</li>
<li>å¼€å‘äººå‘˜ (Developer)</li>
<li>æµ‹è¯•äººå‘˜(Tester)</li>
<li>æ–‡æ¡£å·¥ç¨‹å¸ˆ(Documentation Member)</li>
<li>â€¦â€¦</li>
</ul>
<p>å…¶ä¸­å¼€å‘äººå‘˜ã€æµ‹è¯•äººå‘˜ã€æ–‡æ¡£å·¥ç¨‹å¸ˆå±äºå¼€å‘å›¢é˜Ÿã€‚ç»å…¸å›¢é˜Ÿæ‹¥æœ‰5~9äººï¼Œå›¢é˜Ÿæˆå‘˜æœ‰è¾ƒå¥½çš„è‡ªæˆ‘ç»„ç»‡å’Œç®¡ç†ã€‚</p>
<h3 id="1-Scrumä¸»ç®¡"><a href="#1-Scrumä¸»ç®¡" class="headerlink" title="1.Scrumä¸»ç®¡"></a>1.Scrumä¸»ç®¡</h3><p>Scrumä¸»ç®¡åœ¨å®é™…é¡¹ç›®ä¸­ç§°ä¸ºé¡¹ç›®ç»ç†ï¼Œä¸»è¦å·¥ä½œï¼šå»é™¤é‚£äº›å½±å“å›¢é˜Ÿäº¤ä»˜å†²åˆºç›®æ ‡çš„éšœç¢ã€‚Scrumä¸»ç®¡å¹¶éå›¢é˜Ÿçš„é¢†å¯¼ï¼ˆç”±äºä»–ä»¬æ˜¯è‡ªæˆ‘ç»„ç»‡çš„ï¼‰ï¼Œè€Œæ˜¯è´Ÿè´£å±è”½å¤–ç•Œå¯¹å¼€å‘å›¢é˜Ÿçš„å¹²æ‰°ã€‚Scrumä¸»ç®¡ç¡®ä¿Scrumè¿‡ç¨‹æŒ‰ç…§åˆè¡·ä½¿ç”¨ã€‚Scrumä¸»ç®¡æ˜¯è§„åˆ™çš„æ‰§è¡Œè€…ã€‚</p>
<h3 id="2-äº§å“è´Ÿè´£äºº"><a href="#2-äº§å“è´Ÿè´£äºº" class="headerlink" title="2.äº§å“è´Ÿè´£äºº"></a>2.äº§å“è´Ÿè´£äºº</h3><p>äº§å“è´Ÿè´£äººåˆç§°äº§å“ç»ç†ï¼Œä»£è¡¨å®¢æˆ·çš„æ„æ„¿ï¼Œä¿è¯Scrumå›¢é˜Ÿåœ¨åšä»ä¸šåŠ¡è§’åº¦æ¥è¯´æ­£ç¡®çš„äº‹æƒ…ã€‚</p>
<p>äº§å“è´Ÿè´£äººçš„å·¥ä½œï¼š</p>
<ul>
<li>ç¼–å†™ç”¨æˆ·æ•…äº‹</li>
<li>æ’å‡ºä¼˜å…ˆçº§</li>
<li>å½¢æˆäº§å“è®¢å•</li>
</ul>
<h3 id="3-å¼€å‘å›¢é˜Ÿ"><a href="#3-å¼€å‘å›¢é˜Ÿ" class="headerlink" title="3.å¼€å‘å›¢é˜Ÿ"></a>3.å¼€å‘å›¢é˜Ÿ</h3><p>å¼€å‘å›¢é˜Ÿæ˜¯è´Ÿè´£å¼€å‘å¹¶äº¤ä»˜äº§å“çš„å›¢é˜Ÿã€‚å›¢é˜Ÿè§„æ¨¡è¦å°ï¼Œç»„æˆå¤§è‡´ä¸º5è‡³9åå…·æœ‰è·¨èŒèƒ½æŠ€èƒ½çš„äººï¼ˆè®¾è®¡è€…ï¼Œå¼€å‘è€…ç­‰ï¼‰,å®è·µä¸­ï¼Œ2~9äººå‡å¯ï¼Œä½†è¶…è¿‡7äººä¼šå¯¼è‡´æ²Ÿé€šæˆæœ¬ä¸Šå‡ï¼Œæœ€å¥½å›¢é˜Ÿæˆå‘˜æŠ€èƒ½æ°´å¹³å¤§è‡´ç›¸åŒã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•æ·å¼€å‘/æ•æ·å¼€å‘2.png" alt="æ•æ·å¼€å‘2"></p>
<h3 id="4-å‚ä¸è€…"><a href="#4-å‚ä¸è€…" class="headerlink" title="4.å‚ä¸è€…"></a>4.å‚ä¸è€…</h3><p>å‚ä¸è€…åŒ…æ‹¬ç”¨æˆ·å’Œåˆ©ç›Šç›¸å…³è€…ï¼Œä»–ä»¬å¹¶ä¸æ˜¯å®é™…Scrumè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œä½†æ˜¯å¿…é¡»è€ƒè™‘ä»–ä»¬ã€‚åˆ©ç›Šæ‰€æœ‰è€…ï¼ˆå®¢æˆ·ï¼Œæä¾›å•†ï¼‰æ˜¯å½±å“é¡¹ç›®æˆåŠŸçš„äººï¼Œä½†åªç›´æ¥å‚ä¸å†²åˆºè¯„å®¡è¿‡ç¨‹ã€‚</p>
<h2 id="å››ã€Scrum-æ´»åŠ¨"><a href="#å››ã€Scrum-æ´»åŠ¨" class="headerlink" title="å››ã€Scrum æ´»åŠ¨"></a>å››ã€Scrum æ´»åŠ¨</h2><h3 id="1-Sprints"><a href="#1-Sprints" class="headerlink" title="1.Sprints"></a>1.Sprints</h3><p>Scrumé¡¹ç›®å‘¨æœŸä»¥ä¸€ç»„è¿­ä»£å‘¨æœŸâ€œsprintsâ€ç»„æˆã€‚å…¸å‹çš„è¿­ä»£å‘¨æœŸä¸º2~4å‘¨æˆ–è€…æœ€å¤šä¸€ä¸ªè‡ªç„¶æœˆï¼Œäº§å“çš„è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•å…¨éƒ¨éƒ½åœ¨ä¸€ä¸ªè¿­ä»£å†…å®Œæˆã€‚</p>
<h3 id="2-Sprint-Planning-Meeting-ï¼ˆå†²åˆºè®¡åˆ’ä¼šï¼‰"><a href="#2-Sprint-Planning-Meeting-ï¼ˆå†²åˆºè®¡åˆ’ä¼šï¼‰" class="headerlink" title="2.Sprint Planning Meeting ï¼ˆå†²åˆºè®¡åˆ’ä¼šï¼‰"></a>2.Sprint Planning Meeting ï¼ˆå†²åˆºè®¡åˆ’ä¼šï¼‰</h3><p>å†²åˆºè®¡åˆ’ä¼šä¸»è¦æ˜¯ç¡®å®šå†²åˆºç›®æ ‡ï¼Œç®€å•ç¨‹æ•°è¿™ä¸ªè¿­ä»£å°†è¦å®Œæˆä»€ä¹ˆ</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•æ·å¼€å‘/æ•æ·å¼€å‘3.png" alt="æ•æ·å¼€å‘3" style="zoom:80%;" /></p>
<h3 id="3-Daily-Stand-Meeting"><a href="#3-Daily-Stand-Meeting" class="headerlink" title="3.Daily Stand Meeting"></a>3.Daily Stand Meeting</h3><p>æ¯å¤©ç«™ç«‹ä¼šè®®æ˜¯ä¸€ä¸ªæ¯å¤©éƒ½ä¼šå¼€çš„ï¼Œæ—¶é—´ä¸º15åˆ†é’Ÿå·¦å³çš„ä¼šè®®ï¼Œç‰¹ç‚¹æ˜¯æ‰€æœ‰äººéƒ½ç«™ç€å¼€ä¼šã€‚å…¶ä¸­æ‰€æœ‰ç›¸å…³çš„äººéƒ½ä¼šè¢«é‚€è¯·ï¼Œä½†æ˜¯åªæœ‰Scrum masterï¼ŒProduct Ownerï¼Œå›¢é˜Ÿæˆå‘˜èƒ½å¤Ÿåœ¨ä¼šä¸Šå‘è¨€ï¼Œè¿™æ ·é¿å…äº†æ— å…³çš„è®¨è®ºï¼Œå¯ä»¥æé«˜æ•ˆç‡ã€‚</p>
<p>å…¶ä¸­å›¢é˜Ÿæˆå‘˜éœ€è¦å›ç­”3ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>æ˜¨å¤©ä½ åšäº†ä»€ä¹ˆ</li>
<li>ä»Šå¤©ä½ å°†è¦åšä»€ä¹ˆ</li>
<li>ä½ æœ‰éœ€è¦å¸®åŠ©çš„åœ°æ–¹å—</li>
</ul>
<h3 id="4-å†²åˆºè¯„å®¡ä¼š"><a href="#4-å†²åˆºè¯„å®¡ä¼š" class="headerlink" title="4.å†²åˆºè¯„å®¡ä¼š"></a>4.å†²åˆºè¯„å®¡ä¼š</h3><p>åœ¨å†²åˆºè¯„å®¡ä¼šä¸Šï¼Œå›¢é˜Ÿéœ€è¦æ¼”ç¤ºæ‰€å®Œæˆçš„è¿­ä»£å·¥ä½œï¼Œå…¸å‹çš„åšæ³•æ˜¯ä½¿ç”¨æ¼”ç¤ºå½¢å¼å±•ç¤ºæ–°åŠŸèƒ½æˆ–è€…åº•å±‚æ¶æ„å®ç°ï¼Œæ•´ä¸ªå›¢é˜Ÿå’Œå…³æ³¨äº§å“çš„äººéƒ½è¦éœ€è¦å‚åŠ ã€‚</p>
<h3 id="5-å†²åˆºå›é¡¾ä¼š"><a href="#5-å†²åˆºå›é¡¾ä¼š" class="headerlink" title="5.å†²åˆºå›é¡¾ä¼š"></a>5.å†²åˆºå›é¡¾ä¼š</h3><p>å‘¨æœŸæ€§ å›é¡¾ï¼Œæ€»ç»“å·¥ä½œä¸­çš„ç¦è¨€å’Œæ•™è®­ï¼Œæ—¶é—´å¤§æ¦‚ä¸º15åˆ°30åˆ†é’Ÿå·¦å³ã€‚åœ¨æ¯ä¸ªè¿­ä»£ç»“æŸæ—¶å¼€å§‹åšï¼Œæ•´ä¸ªå›¢é˜Ÿéƒ½éœ€è¦å‚åŠ ï¼ŒåŒ…æ‹¬å®¢æˆ·ä¹Ÿå¯èƒ½éœ€è¦å‚åŠ ã€‚</p>
<h2 id="äº”ã€Scrum-çš„æ–‡æ¡£-å·¥ä»¶"><a href="#äº”ã€Scrum-çš„æ–‡æ¡£-å·¥ä»¶" class="headerlink" title="äº”ã€Scrum çš„æ–‡æ¡£ (å·¥ä»¶)"></a>äº”ã€<strong>Scrum</strong> <strong>çš„æ–‡æ¡£</strong> (å·¥ä»¶)</h2><h3 id="1-product-backlog-ï¼ˆäº§å“è®¢å•"><a href="#1-product-backlog-ï¼ˆäº§å“è®¢å•" class="headerlink" title="1.product backlog ï¼ˆäº§å“è®¢å•)"></a>1.product backlog ï¼ˆäº§å“è®¢å•)</h3><p>äº§å“è®¢å•å†™çš„æ˜¯é¡¹ç›®ä¸­å¾…å®Œæˆçš„å·¥ä½œåˆ—è¡¨ï¼Œç†æƒ³çš„æ˜¯æ¯ä¸€ä¸ªå¾…å®Œæˆçš„å·¥ä½œéƒ½å°†å¯¹å®¢æˆ·å’Œç”¨æˆ·äº§ç”Ÿä»·å€¼ï¼Œäº§å“æ‰€æœ‰è€…å°†å¯¹è¿™ä¸ªåˆ—è¡¨è¿›è¡Œä¼˜å…ˆçº§æ’åºï¼Œæ¯ä¸ªè¿­ä»£å¼€å§‹å‰ä¼˜å…ˆçº§çš„æ’åºå·¥ä½œè¿˜éœ€è¦å†åº¦ä¿®æ­£ã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•æ·å¼€å‘/æ•æ·å¼€å‘4.png" alt="æ•æ·å¼€å‘4" style="zoom:80%;" /></p>
<h3 id="2-Sprint-backlog-å†²åˆºè®¢å•"><a href="#2-Sprint-backlog-å†²åˆºè®¢å•" class="headerlink" title="2.Sprint backlog (å†²åˆºè®¢å•)"></a>2.Sprint backlog (å†²åˆºè®¢å•)</h3><p>Sprint Backlogæ˜¯Product Backlogçš„å­é›†ï¼ŒSprint Backlogçš„å†…å®¹ï¼Œç”±å›¢é˜Ÿæˆå‘˜é›†ä½“å†³å®šï¼Œå›¢é˜Ÿä¸­ä»»ä½•äººéƒ½å¯ä»¥æ·»åŠ ï¼Œåˆ å‡æˆ–è€…æ›´æ”¹è¿­ä»£ä¸­çš„å·¥ä½œé¡¹ç›®ï¼Œå›¢é˜Ÿä¸­çš„æ¯ä¸ªäººéƒ½ä¸ºäº†å†²åˆºç›®æ ‡ä»¥åŠå°†å‘å¸ƒçš„ç»“æœè€Œå·¥ä½œã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•æ·å¼€å‘/æ•æ·å¼€å‘5.png" alt="æ•æ·å¼€å‘5" style="zoom:80%;" /></p>
<h2 id="å…­ã€Scrumè¿‡ç¨‹"><a href="#å…­ã€Scrumè¿‡ç¨‹" class="headerlink" title="å…­ã€Scrumè¿‡ç¨‹"></a>å…­ã€Scrumè¿‡ç¨‹</h2><p>å¾…ç»­â€¦â€¦</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ•æ·çš„æœ€ä½³å®è·µä¹‹ä¸€å°±æ˜¯è¿­ä»£å¼€å‘ï¼Œæ•æ·/è¿­ä»£å¼€å‘çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šèšé›†å®¢æˆ·ä»·å€¼ï¼Œä»¥å®¢æˆ·ä¸ºä¸­å¿ƒï¼Œäº¤ä»˜åˆšåˆšå¥½çš„ç³»ç»Ÿï¼Œéšæ—¶æ„å»ºäº§å“è´¨é‡ã€‚</p>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>æ•æ·å¼€å‘</tag>
      </tags>
  </entry>
  <entry>
    <title>ç”µè„‘æ¨èè½¯ä»¶</title>
    <url>/2022/10/26/%E5%85%B6%E4%BB%96/%E7%94%B5%E8%84%91%E6%8E%A8%E8%8D%90%E8%BD%AF%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="ç”µè„‘æ¨èè½¯ä»¶"><a href="#ç”µè„‘æ¨èè½¯ä»¶" class="headerlink" title="ç”µè„‘æ¨èè½¯ä»¶"></a>ç”µè„‘æ¨èè½¯ä»¶</h1><p>è®°å½•ä¸€ä¸‹ç”µè„‘ä¸Šä½¿ç”¨çš„é¢‘ç‡æ¯”è¾ƒé«˜çš„è½¯ä»¶</p>
<h2 id="1-Snipaste"><a href="#1-Snipaste" class="headerlink" title="1.Snipaste"></a>1.Snipaste</h2><p>è¶…çº§å¥½ç”¨çš„æˆªå›¾è½¯ä»¶ï¼ŒæŒ‰ä¸‹F1å°±å¯ä»¥æˆªå›¾ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/339716.gif" alt="img"></p>
<p>ä¸‹è½½åœ°å€ï¼š<a href="https://zh.snipaste.com/">https://zh.snipaste.com/</a></p>
<span id="more"></span>
<h2 id="2-Typora"><a href="#2-Typora" class="headerlink" title="2.Typora"></a>2.Typora</h2><p>Typoraæ˜¯ä¸ªéå¸¸å¥½ç”¨çš„markdownç¼–è¾‘å™¨å’Œé˜…è¯»å™¨ï¼Œç¾ä¸­ä¸è¶³çš„æ˜¯å¼€å§‹æ”¶è´¹äº†ï¼Œä½†æ˜¯ä¸ªäººæ„Ÿè§‰å…è´¹ç‰ˆæœ¬å·²ç»è¶³å¤Ÿä½¿ç”¨äº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/others/image-20221108194746752.png" alt="image-20221108194746752"></p>
<p>ç›®å‰æœ€åä¸€ä¸ªå…è´¹ç‰ˆæœ¬åœ¨ç½‘ä¸Šéƒ½éœ€è¦æ‰¾ä¸€ä¸‹ï¼Œæˆ‘æ˜¯ä½¿ç”¨è‡ªå·±åœ¨ç™¾åº¦ç½‘ç›˜ä¿ç•™çš„ç‰ˆæœ¬</p>
<h2 id="3-FastGithub"><a href="#3-FastGithub" class="headerlink" title="3.FastGithub"></a>3.FastGithub</h2><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªgithubåŠ é€Ÿå™¨ï¼Œè§£å†³githubæ‰“ä¸å¼€ã€ç”¨æˆ·å¤´åƒæ— æ³•åŠ è½½ã€releasesæ— æ³•ä¸Šä¼ ä¸‹è½½ã€git-cloneã€git-pullã€git-pushå¤±è´¥ç­‰é—®é¢˜ã€‚</p>
<p>è™½ç„¶ç§‘å­¦ä¸Šç½‘å¯ä»¥è§£å†³ä¸Šé¢çš„githubçš„è®¿é—®é—®é¢˜ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™git pullç­‰é—®é¢˜é€šè¿‡ç§‘å­¦ä¸Šç½‘è¿˜æ˜¯æ²¡ç”¨åŠæ³•è§£å†³ã€‚è¿™ä¸ªè½¯ä»¶åˆšåˆšå¥½è§£å†³æˆ‘çš„è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ä¸‹è½½åœ°å€ï¼š<a href="https://github.com/dotnetcore/FastGithub/releases">https://github.com/dotnetcore/FastGithub/releases</a></p>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>è½¯ä»¶å®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>matplotlibç”»å›¾(äºŒ)å„ç§ç±»å‹å›¾</title>
    <url>/2021/07/23/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/matplotlib%E7%94%BB%E5%90%84%E7%A7%8D%E7%B1%BB%E5%9E%8B%E5%9B%BE/</url>
    <content><![CDATA[<h1 id="matplotlibç”»å›¾ï¼ˆäºŒï¼‰"><a href="#matplotlibç”»å›¾ï¼ˆäºŒï¼‰" class="headerlink" title="matplotlibç”»å›¾ï¼ˆäºŒï¼‰"></a>matplotlibç”»å›¾ï¼ˆäºŒï¼‰</h1><p>matplotlibæ˜¯æœ€æµè¡Œçš„Pythonåº•å±‚ç»˜å›¾åº“ï¼Œä¸»è¦åšæ•°æ®å¯è§†åŒ–å›¾è¡¨,åå­—å–æäºMATLABï¼Œæ¨¡ä»¿MATLABè¿›è¡Œæ„å»ºã€‚</p>
<p>ğŸ‘‰å®˜ç½‘åœ°å€ï¼š<a href="https://matplotlib.org/">https://matplotlib.org/</a></p>
<p>matplotlibèƒ½ç”»çš„å›¾æœ‰æŠ˜çº¿å›¾ã€æ•£ç‚¹å›¾ã€æŸ±çŠ¶å›¾ã€ç›´æ–¹å›¾ã€é¥¼çŠ¶å›¾ç­‰ï¼Œæ‰€ä»¥æœ¬æ¬¡ä¸»è¦è®²è§£è¿™å‡ å¼ å›¾ï¼Œæ³¨æ„æœ¬æ¬¡ä»£ç ä¸»è¦ä½¿ç”¨å®˜æ–¹æ–‡æ¡£ä¸Šçš„<strong>é¢å‘å¯¹è±¡</strong>é£æ ¼ï¼Œå½“ç„¶ä½¿ç”¨pyploté£æ ¼ä¹Ÿæ˜¯åŒæ ·å¯ä»¥å®ç°çš„</p>
<span id="more"></span>
<h2 id="æŠ˜çº¿å›¾"><a href="#æŠ˜çº¿å›¾" class="headerlink" title="æŠ˜çº¿å›¾"></a>æŠ˜çº¿å›¾</h2><p>æŠ˜çº¿å›¾æ˜¯é»˜è®¤çš„å›¾åƒï¼Œç›´æ¥ä½¿ç”¨plotå°±å¯ä»¥ç”»å‡º</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">x = np.linspace(<span class="number">0</span>, <span class="number">2</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Note that even in the OO-style, we use `.pyplot.figure` to create the figure.</span></span><br><span class="line">fig, ax = plt.subplots()  <span class="comment"># Create a figure and an axes.</span></span><br><span class="line">ax.plot(x, x, label=<span class="string">&#x27;linear&#x27;</span>)  <span class="comment"># Plot some data on the axes.</span></span><br><span class="line">ax.plot(x, x**<span class="number">2</span>, label=<span class="string">&#x27;quadratic&#x27;</span>)  <span class="comment"># Plot more data on the axes...</span></span><br><span class="line">ax.plot(x, x**<span class="number">3</span>, label=<span class="string">&#x27;cubic&#x27;</span>)  <span class="comment"># ... and some more.</span></span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;x label&#x27;</span>)  <span class="comment"># Add an x-label to the axes.</span></span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;y label&#x27;</span>)  <span class="comment"># Add a y-label to the axes.</span></span><br><span class="line">ax.set_title(<span class="string">&quot;Simple Plot&quot;</span>)  <span class="comment"># Add a title to the axes.</span></span><br><span class="line">ax.legend()  <span class="comment"># Add a legend.</span></span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210724091951456.png" alt="image-20210724091951456"></p>
<h2 id="æ•£ç‚¹å›¾"><a href="#æ•£ç‚¹å›¾" class="headerlink" title="æ•£ç‚¹å›¾"></a>æ•£ç‚¹å›¾</h2><p>æ•£ç‚¹å›¾ä¸»è¦ä½¿ç”¨å‡½æ•°Scatterï¼Œç„¶åè¾“å…¥ç‚¹çš„xåæ ‡åˆ—è¡¨å’Œyåæ ‡åˆ—è¡¨å³å¯</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">19680801</span>)</span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line"><span class="keyword">for</span> color <span class="keyword">in</span> [<span class="string">&#x27;tab:blue&#x27;</span>, <span class="string">&#x27;tab:orange&#x27;</span>, <span class="string">&#x27;tab:green&#x27;</span>]:</span><br><span class="line">    n = <span class="number">750</span></span><br><span class="line">    x, y = np.random.rand(<span class="number">2</span>, n)</span><br><span class="line">    scale = <span class="number">200.0</span> * np.random.rand(n)</span><br><span class="line">    ax.scatter(x, y, c=color, s=scale, label=color,</span><br><span class="line">               alpha=<span class="number">0.3</span>, edgecolors=<span class="string">&#x27;none&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ax.legend()</span><br><span class="line">ax.grid(<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210723213104165.png" alt="image-20210723213104165"></p>
<h2 id="æŸ±çŠ¶å›¾"><a href="#æŸ±çŠ¶å›¾" class="headerlink" title="æŸ±çŠ¶å›¾"></a>æŸ±çŠ¶å›¾</h2><p>æ¡å½¢å›¾ä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„æŸ±çŠ¶å›¾ï¼Œæœ‰æ¨ªç€å’Œç«–ç€çš„è¿™ä¸¤ç§ï¼Œä¸€èˆ¬ä½¿ç”¨çš„å‡½æ•°æ˜¯<code>bar</code>å’Œ<code>barh</code></p>
<p>å…ˆå±•ç¤ºç«–ç€çš„æ¡å½¢å›¾ï¼Œè¿™ç§æ¡å½¢å›¾ä½¿ç”¨è¾ƒå¤šï¼Œå±•ç¤ºæ•ˆæœä¸é”™</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">labels = [<span class="string">&#x27;G1&#x27;</span>, <span class="string">&#x27;G2&#x27;</span>, <span class="string">&#x27;G3&#x27;</span>, <span class="string">&#x27;G4&#x27;</span>, <span class="string">&#x27;G5&#x27;</span>]</span><br><span class="line">men_means = [<span class="number">20</span>, <span class="number">34</span>, <span class="number">30</span>, <span class="number">35</span>, <span class="number">27</span>]</span><br><span class="line">women_means = [<span class="number">25</span>, <span class="number">32</span>, <span class="number">34</span>, <span class="number">20</span>, <span class="number">25</span>]</span><br><span class="line"></span><br><span class="line">x = np.arange(<span class="built_in">len</span>(labels))  <span class="comment"># the label locations</span></span><br><span class="line">width = <span class="number">0.35</span>  <span class="comment"># the width of the bars</span></span><br><span class="line"></span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line">rects1 = ax.bar(x - width/<span class="number">2</span>, men_means, width, label=<span class="string">&#x27;Men&#x27;</span>)</span><br><span class="line">rects2 = ax.bar(x + width/<span class="number">2</span>, women_means, width, label=<span class="string">&#x27;Women&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add some text for labels, title and custom x-axis tick labels, etc.</span></span><br><span class="line">ax.set_ylabel(<span class="string">&#x27;Scores&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&#x27;Scores by group and gender&#x27;</span>)</span><br><span class="line">ax.set_xticks(x)</span><br><span class="line">ax.set_xticklabels(labels)</span><br><span class="line">ax.legend()</span><br><span class="line"></span><br><span class="line">ax.bar_label(rects1, padding=<span class="number">3</span>)</span><br><span class="line">ax.bar_label(rects2, padding=<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">fig.tight_layout()</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210724090632449.png" alt="image-20210724090632449"></p>
<p>ä½¿ç”¨æ¨ªç€å±•ç¤ºçš„æ¡å½¢å›¾ï¼Œç›´æ¥ä½¿ç”¨barhå°±å¯ä»¥å®ç°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fixing random state for reproducibility</span></span><br><span class="line">np.random.seed(<span class="number">19680801</span>)</span><br><span class="line"></span><br><span class="line">plt.rcdefaults()</span><br><span class="line">fig, ax = plt.subplots()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example data</span></span><br><span class="line">people = (<span class="string">&#x27;Tom&#x27;</span>, <span class="string">&#x27;Dick&#x27;</span>, <span class="string">&#x27;Harry&#x27;</span>, <span class="string">&#x27;Slim&#x27;</span>, <span class="string">&#x27;Jim&#x27;</span>)</span><br><span class="line">y_pos = np.arange(<span class="built_in">len</span>(people))</span><br><span class="line">performance = <span class="number">3</span> + <span class="number">10</span> * np.random.rand(<span class="built_in">len</span>(people))</span><br><span class="line">error = np.random.rand(<span class="built_in">len</span>(people))</span><br><span class="line"></span><br><span class="line">rects1 = ax.barh(y_pos, performance, align=<span class="string">&#x27;center&#x27;</span>)</span><br><span class="line">ax.set_yticks(y_pos)</span><br><span class="line">ax.set_yticklabels(people)</span><br><span class="line">ax.invert_yaxis()  <span class="comment"># labels read top-to-bottom</span></span><br><span class="line">ax.set_xlabel(<span class="string">&#x27;Performance&#x27;</span>)</span><br><span class="line">ax.set_title(<span class="string">&#x27;How fast do you want to go today?&#x27;</span>)</span><br><span class="line">ax.bar_label(rects1, padding=<span class="number">3</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210724092623279.png" alt="image-20210724092623279"></p>
<h2 id="ç›´æ–¹å›¾"><a href="#ç›´æ–¹å›¾" class="headerlink" title="ç›´æ–¹å›¾"></a>ç›´æ–¹å›¾</h2><p>ç›´æ–¹å›¾è·ŸæŸ±çŠ¶å›¾æœ‰ç‚¹ç±»ä¼¼ï¼Œçœ‹èµ·æ¥å¾ˆåƒæŸ±çŠ¶å›¾é“¾æ¥çš„å¾ˆç´§å¯†ï¼Œä¸è¿‡æ„Ÿè§‰è¿™ä¸ªè¯´æ³•ä¸ä¸¥è°¨ï¼Œæˆ‘æ›´è¶‹å‘äºæ˜¯ç›´æ–¹å›¾å±•ç¤ºè¿ç»­ä½†æ˜¯åˆ†æ®µçš„æ•°æ®</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fixing random state for reproducibility</span></span><br><span class="line">np.random.seed(<span class="number">19680801</span>)</span><br><span class="line"></span><br><span class="line">N_points = <span class="number">100000</span></span><br><span class="line">n_bins = <span class="number">20</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate a normal distribution, center at x=0 and y=5</span></span><br><span class="line">x = np.random.randn(N_points)</span><br><span class="line"></span><br><span class="line">fig, axs = plt.subplots(sharey=<span class="literal">True</span>, tight_layout=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># We can set the number of bins with the `bins` kwarg</span></span><br><span class="line">axs.hist(x, bins=n_bins)</span><br><span class="line">plt.show()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210724094320817.png" alt="image-20210724094320817"></p>
<p><code>hist</code>å‚æ•°ä¸­<code>bins</code>æ˜¯æŒ‡æ¡å½¢çš„ä¸ªæ•°åƒè¿™ä¸ªå›¾é‡Œé¢å°±æ˜¯20ä¸ªæ¡å½¢</p>
<h2 id="é¥¼çŠ¶å›¾"><a href="#é¥¼çŠ¶å›¾" class="headerlink" title="é¥¼çŠ¶å›¾"></a>é¥¼çŠ¶å›¾</h2><p>é¥¼çŠ¶å›¾å¯ä»¥çœ‹æ¸…ä¸€ä¸ªåˆ†å¸ƒï¼Œä¹Ÿå°±æ˜¯ä¸€å †æ•°æ®å½“ä¸­å„ç§ç±»åˆ«çš„åˆ†å¸ƒã€‚ç”»é¥¼çŠ¶å›¾ä¸»è¦ä½¿ç”¨pieå‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># Pie chart, where the slices will be ordered and plotted counter-clockwise:</span></span><br><span class="line">labels = <span class="string">&#x27;Frogs&#x27;</span>, <span class="string">&#x27;Hogs&#x27;</span>, <span class="string">&#x27;Dogs&#x27;</span>, <span class="string">&#x27;Logs&#x27;</span></span><br><span class="line">sizes = [<span class="number">15</span>, <span class="number">30</span>, <span class="number">45</span>, <span class="number">10</span>]</span><br><span class="line">explode = (<span class="number">0</span>, <span class="number">0.1</span>, <span class="number">0</span>, <span class="number">0</span>)  <span class="comment"># only &quot;explode&quot; the 2nd slice (i.e. &#x27;Hogs&#x27;)</span></span><br><span class="line"></span><br><span class="line">fig1, ax1 = plt.subplots()</span><br><span class="line">ax1.pie(sizes, explode=explode, labels=labels, autopct=<span class="string">&#x27;%1.1f%%&#x27;</span>,</span><br><span class="line">        shadow=<span class="literal">True</span>, startangle=<span class="number">90</span>)</span><br><span class="line">ax1.axis(<span class="string">&#x27;equal&#x27;</span>)  <span class="comment"># Equal aspect ratio ensures that pie is drawn as a circle.</span></span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210724095404058.png" alt="image-20210724095404058"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>pie</code>å‡½æ•°ä¸­çš„<code>autopct</code>æ˜¯ç”¨æ¥æ˜¾ç¤ºç™¾åˆ†æ¯”çš„ï¼Œ<code>shadow</code>ç”¨æ¥æ§åˆ¶é˜´å½±ï¼Œ<code>startangle</code>ç”¨æ¥æ§åˆ¶é€‰æ‹©è§’åº¦ï¼Œè€Œè¿™ä¸ªçªå‡ºæ˜¾ç¤ºåˆ™æ˜¯ä½¿ç”¨<code>explode</code>è¿›è¡Œ</p>
]]></content>
      <categories>
        <category>æ•°æ®åˆ†æ</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>matlpotlib</tag>
      </tags>
  </entry>
  <entry>
    <title>matplotlibç”»å›¾(ä¸€)åŸºæœ¬æ“ä½œ</title>
    <url>/2021/07/17/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/matplotlib%E7%94%BB%E5%9B%BE%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C/</url>
    <content><![CDATA[<h1 id="matplotlibç”»å›¾åŸºæœ¬æ“ä½œ"><a href="#matplotlibç”»å›¾åŸºæœ¬æ“ä½œ" class="headerlink" title="matplotlibç”»å›¾åŸºæœ¬æ“ä½œ"></a>matplotlibç”»å›¾åŸºæœ¬æ“ä½œ</h1><p>matplotlibæ˜¯æœ€æµè¡Œçš„Pythonåº•å±‚ç»˜å›¾åº“ï¼Œä¸»è¦åšæ•°æ®å¯è§†åŒ–å›¾è¡¨,åå­—å–æäºMATLABï¼Œæ¨¡ä»¿MATLABæ„å»ºã€‚æœ€è¿‘åšäº†å¾ˆå¤šå…³äºæ•°æ®åˆ†æçš„é¢˜ç›®ï¼Œå¯¹äºç”»å›¾æ„Ÿè§‰æŒæ¡çš„ä¸ç†Ÿç»ƒæ‰€ä»¥ç‰¹åœ°æ¥å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p>ğŸ‘‰å®˜ç½‘åœ°å€ï¼š<a href="https://matplotlib.org/">https://matplotlib.org/</a></p>
<p>ä¸‹é¢è¿™å¼ å›¾æ˜¯ Matplotlib å›¾å½¢çš„ç»„æˆéƒ¨åˆ†ã€‚ä¸»è¦æœ‰titleã€tickã€legendã€labelè¿™ç±»çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æœ¬æ¬¡ä¹Ÿä¸»è¦ä»è¿™äº›å‡ºå‘ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/anatomy.png" alt="anatomy.png"></p>
<span id="more"></span>
<h2 id="ç®€å•ä½¿ç”¨"><a href="#ç®€å•ä½¿ç”¨" class="headerlink" title="ç®€å•ä½¿ç”¨"></a>ç®€å•ä½¿ç”¨</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="comment"># åæ ‡ä¸­xçš„åˆ—è¡¨</span></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="comment"># åæ ‡ä¸­yçš„åˆ—è¡¨</span></span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;some numbers&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>å±•ç¤ºå‡ºçš„å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210719225539311.png" alt="image-20210719225539311"></p>
<p>matplotlibä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œä¼ å…¥xçš„åˆ—è¡¨å’Œyçš„åˆ—è¡¨ï¼Œç›´æ¥ä¼ å…¥å°±å¯ä»¥ç”»ã€‚</p>
<h2 id="è®¾ç½®å›¾ç‰‡å¤§å°"><a href="#è®¾ç½®å›¾ç‰‡å¤§å°" class="headerlink" title="è®¾ç½®å›¾ç‰‡å¤§å°"></a>è®¾ç½®å›¾ç‰‡å¤§å°</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"><span class="comment"># å®ä¾‹åŒ–figure</span></span><br><span class="line">fig = plt.figure(figsize=(<span class="number">20</span>, <span class="number">8</span>), dpi=<span class="number">80</span>)</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;some numbers&#x27;</span>)</span><br><span class="line">plt.savefig(<span class="string">&quot;line.png&quot;</span>)</span><br><span class="line">plt.show()</span><br><span class="line"><span class="comment"># å­˜å›¾ç‰‡</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210719230413323.png" alt="image-20210719230413323"></p>
<h2 id="è®¾ç½®xè½´å’Œyè½´ä¸Šçš„åˆ»åº¦ï¼ˆtickï¼‰"><a href="#è®¾ç½®xè½´å’Œyè½´ä¸Šçš„åˆ»åº¦ï¼ˆtickï¼‰" class="headerlink" title="è®¾ç½®xè½´å’Œyè½´ä¸Šçš„åˆ»åº¦ï¼ˆtickï¼‰"></a>è®¾ç½®xè½´å’Œyè½´ä¸Šçš„åˆ»åº¦ï¼ˆtickï¼‰</h2><p>xè½´å’Œyè½´ä¸Šé¢éƒ½æœ‰åˆ»åº¦å¦‚æœæˆ‘ä»¬ä¸åŠ ï¼Œä¼šé»˜è®¤å¸®æˆ‘ä»¬åŠ ä¸Šå»ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬æƒ³è‡ªå·±è®¾è®¡è¿™ä¸ªåˆ»åº¦ä¹Ÿæ˜¯å¯ä»¥çš„</p>
<p>æ¯”å¦‚ä¸‹å›¾æˆ‘ä»¬å¯ä»¥è®¾ç½®åˆ»åº¦åœ¨çº¿æ®µå¤–,å½“ç„¶å‘ç°å›¾å¾ˆä¸‘ï¼Œä½†æ˜¯åˆ»åº¦ç¡®å®æ˜¯æˆ‘ä»¬æ‰€è®¾ç½®çš„</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;some numbers&#x27;</span>)</span><br><span class="line"><span class="comment"># è®¾ç½®åˆ»åº¦åœ¨çº¿å¤–</span></span><br><span class="line">xticks = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">5</span>, -<span class="number">1</span>)]</span><br><span class="line">yticks = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(-<span class="number">5</span>, -<span class="number">1</span>)]</span><br><span class="line">plt.xticks(xticks)</span><br><span class="line">plt.yticks(yticks)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210720102612547.png" alt="image-20210720102612547"></p>
<p>ä¸è¿‡æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯è®¾ç½®åˆé€‚çš„åˆ»åº¦ï¼Œæ¯•ç«Ÿç”»å›¾éœ€è¦ç¾è§‚ï¼Œåˆ»æ„è®¾ç½®ä¸å¿…è¦ï¼Œä¸Šé¢åªæ˜¯ä¸ºäº†ä¸¾ä¾‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;some numbers&#x27;</span>)</span><br><span class="line"><span class="comment"># æ­£ç»è®¾ç½®</span></span><br><span class="line">xticks = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>)]</span><br><span class="line">yticks = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">5</span>)]</span><br><span class="line">plt.xticks(xticks)</span><br><span class="line">plt.yticks(yticks)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210720102944193.png" alt="image-20210720102944193"></p>
<p>ç„¶åæœ‰çš„æ—¶å€™åˆ»åº¦æ˜¯æ—¶é—´ç±»å‹æˆ–è€…å…¶ä»–çš„labelä¹‹ç±»çš„ï¼Œæ¯”å¦‚ï¼šæˆ‘æƒ³å±•ç¤ºä¸€å¤©24hçš„æ—¶é—´å˜åŒ–ï¼Œåˆ»åº¦éœ€è¦æ˜¾ç¤º1ï¼š00è¿™ç§ï¼Œåˆæˆ–è€…æ˜¯æ˜¾ç¤ºå‡ å¹´å†…æ¯ä¸ªæœˆçš„æ”¶å…¥å˜åŒ–ï¼Œåˆ»åº¦æ˜¯1998-01-01è¿™ç§ç±»å‹è¯¥å¦‚ä½•æ˜¾ç¤ºå‘¢ï¼Ÿ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>  <span class="comment"># ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·</span></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;some numbers&#x27;</span>)</span><br><span class="line">xticks = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>)]</span><br><span class="line"><span class="comment"># è®¾ç½®æ ‡ç­¾</span></span><br><span class="line">xlabel = [<span class="string">&quot;&#123;&#125;ç‚¹&quot;</span>.<span class="built_in">format</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>)]</span><br><span class="line">plt.xticks(xticks, xlabel, rotation=<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åªéœ€è¦åœ¨è°ƒç”¨xticksçš„æ—¶å€™ä¼ å…¥xlabelå°±å¯ä»¥å®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®å¯¹åº”çš„åˆ»åº¦åˆ—è¡¨å’Œåˆ»åº¦æ ‡ç­¾å³å¯</p>
<h2 id="ç»™å›¾åƒæ·»åŠ æè¿°ä¿¡æ¯"><a href="#ç»™å›¾åƒæ·»åŠ æè¿°ä¿¡æ¯" class="headerlink" title="ç»™å›¾åƒæ·»åŠ æè¿°ä¿¡æ¯"></a>ç»™å›¾åƒæ·»åŠ æè¿°ä¿¡æ¯</h2><p>å›¾åƒçš„æè¿°ä¿¡æ¯æœ‰xlabelã€ylabelã€title</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>] = [<span class="string">&#x27;SimHei&#x27;</span>]  <span class="comment"># ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>] = <span class="literal">False</span>  <span class="comment"># ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åæ ‡ä¸­xçš„åˆ—è¡¨</span></span><br><span class="line">x = [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="comment"># åæ ‡ä¸­yçš„åˆ—è¡¨</span></span><br><span class="line">y = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>]</span><br><span class="line">plt.plot(x, y)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;x çš„æ ‡ç­¾&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;y çš„æ ‡ç­¾&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&quot;æ ‡ç­¾æè¿°&quot;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210720110852460.png" alt="image-20210720110852460"></p>
<h2 id="è®¾ç½®å›¾åƒé£æ ¼"><a href="#è®¾ç½®å›¾åƒé£æ ¼" class="headerlink" title="è®¾ç½®å›¾åƒé£æ ¼"></a>è®¾ç½®å›¾åƒé£æ ¼</h2><p>ç”»å›¾æˆ‘ä»¬å¯ä»¥è®¾ç½®çº¿æ®µçš„é£æ ¼ï¼Œå¯ä»¥å†³å®šæ˜¯ç”»çº¿è¿˜æ˜¯ç”»ç‚¹ï¼Œç„¶åçº¿çš„ç²—ç»†é¢œè‰²ä¹‹ç±»çš„éƒ½å¯ä»¥è®¾ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import matplotlib.pyplot as plt</span><br><span class="line"></span><br><span class="line">plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;]  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾</span><br><span class="line">plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·</span><br><span class="line"></span><br><span class="line"># åæ ‡ä¸­xçš„åˆ—è¡¨</span><br><span class="line">x = [0, 1, 2, 3]</span><br><span class="line"># åæ ‡ä¸­yçš„åˆ—è¡¨</span><br><span class="line">y = [1, 2, 3, 5]</span><br><span class="line">plt.plot(x, y, color=&#x27;green&#x27;, marker=&#x27;o&#x27;, linestyle=&#x27;dashed&#x27;, linewidth=2, markersize=12)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210720112925627.png" alt="image-20210720112925627"></p>
<p>å…¶ä¸­coloræ˜¯è®¾ç½®é¢œè‰²ï¼Œmarkerè®¾ç½®æ ‡è®°ç‚¹ï¼Œlinestyleè®¾ç½®çº¿æ¡æ ¼å¼ï¼Œlinewidthè®¾ç½®çº¿çš„å®½åº¦ï¼Œmarkersizeè®¾ç½®çº¿çš„å¤§å°</p>
<p><strong>Colors</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>character</th>
<th>color</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#39;b&#39;</code></td>
<td>blue</td>
</tr>
<tr>
<td><code>&#39;g&#39;</code></td>
<td>green</td>
</tr>
<tr>
<td><code>&#39;r&#39;</code></td>
<td>red</td>
</tr>
<tr>
<td><code>&#39;c&#39;</code></td>
<td>cyan</td>
</tr>
<tr>
<td><code>&#39;m&#39;</code></td>
<td>magenta</td>
</tr>
<tr>
<td><code>&#39;y&#39;</code></td>
<td>yellow</td>
</tr>
<tr>
<td><code>&#39;k&#39;</code></td>
<td>black</td>
</tr>
<tr>
<td><code>&#39;w&#39;</code></td>
<td>white</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Markers</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>character</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#39;.&#39;</code></td>
<td>point marker</td>
</tr>
<tr>
<td><code>&#39;,&#39;</code></td>
<td>pixel marker</td>
</tr>
<tr>
<td><code>&#39;o&#39;</code></td>
<td>circle marker</td>
</tr>
<tr>
<td><code>&#39;v&#39;</code></td>
<td>triangle_down marker</td>
</tr>
<tr>
<td><code>&#39;^&#39;</code></td>
<td>triangle_up marker</td>
</tr>
<tr>
<td><code>&#39;&lt;&#39;</code></td>
<td>triangle_left marker</td>
</tr>
<tr>
<td><code>&#39;&gt;&#39;</code></td>
<td>triangle_right marker</td>
</tr>
<tr>
<td><code>&#39;1&#39;</code></td>
<td>tri_down marker</td>
</tr>
<tr>
<td><code>&#39;2&#39;</code></td>
<td>tri_up marker</td>
</tr>
<tr>
<td><code>&#39;3&#39;</code></td>
<td>tri_left marker</td>
</tr>
<tr>
<td><code>&#39;4&#39;</code></td>
<td>tri_right marker</td>
</tr>
<tr>
<td><code>&#39;8&#39;</code></td>
<td>octagon marker</td>
</tr>
<tr>
<td><code>&#39;s&#39;</code></td>
<td>square marker</td>
</tr>
<tr>
<td><code>&#39;p&#39;</code></td>
<td>pentagon marker</td>
</tr>
<tr>
<td><code>&#39;P&#39;</code></td>
<td>plus (filled) marker</td>
</tr>
<tr>
<td><code>&#39;*&#39;</code></td>
<td>star marker</td>
</tr>
<tr>
<td><code>&#39;h&#39;</code></td>
<td>hexagon1 marker</td>
</tr>
<tr>
<td><code>&#39;H&#39;</code></td>
<td>hexagon2 marker</td>
</tr>
<tr>
<td><code>&#39;+&#39;</code></td>
<td>plus marker</td>
</tr>
<tr>
<td><code>&#39;x&#39;</code></td>
<td>x marker</td>
</tr>
<tr>
<td><code>&#39;X&#39;</code></td>
<td>x (filled) marker</td>
</tr>
<tr>
<td><code>&#39;D&#39;</code></td>
<td>diamond marker</td>
</tr>
<tr>
<td><code>&#39;d&#39;</code></td>
<td>thin_diamond marker</td>
</tr>
<tr>
<td>`â€™</td>
<td>â€˜`</td>
<td>vline marker</td>
</tr>
<tr>
<td><code>&#39;_&#39;</code></td>
<td>hline marker</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Line Styles</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>character</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&#39;-&#39;</code></td>
<td>solid line style</td>
</tr>
<tr>
<td><code>&#39;--&#39;</code></td>
<td>dashed line style</td>
</tr>
<tr>
<td><code>&#39;-.&#39;</code></td>
<td>dash-dot line style</td>
</tr>
<tr>
<td><code>&#39;:&#39;</code></td>
<td>dotted line style</td>
</tr>
</tbody>
</table>
</div>
<p>å…·ä½“æ›´å¤šè®¾ç½®å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£</p>
<h2 id="è®¾ç½®å›¾ä¾‹"><a href="#è®¾ç½®å›¾ä¾‹" class="headerlink" title="è®¾ç½®å›¾ä¾‹"></a>è®¾ç½®å›¾ä¾‹</h2><p>æœ‰çš„æ—¶å€™æˆ‘ä»¬ä¸€å¼ å›¾æœ‰å¥½å‡ æ¡çº¿ï¼Œä¸ºäº†è¯´æ¸…æ¥šæˆ‘ä»¬æ¯æ¡çº¿æ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®å›¾ä¾‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import matplotlib.pyplot as plt</span><br><span class="line"></span><br><span class="line">plt.rcParams[&#x27;font.sans-serif&#x27;] = [&#x27;SimHei&#x27;]  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾</span><br><span class="line">plt.rcParams[&#x27;axes.unicode_minus&#x27;] = False  # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·</span><br><span class="line"></span><br><span class="line"># åæ ‡ä¸­xçš„åˆ—è¡¨</span><br><span class="line">x = [0, 1, 2, 3]</span><br><span class="line"># åæ ‡ä¸­yçš„åˆ—è¡¨</span><br><span class="line">y1 = [1, 2, 3, 5]</span><br><span class="line">y2 = [1, 3, 5, 8]</span><br><span class="line">plt.plot(x, y1, label=&quot;ç¬¬ä¸€æ¡çº¿&quot;)</span><br><span class="line">plt.plot(x, y2, label=&quot;ç¬¬äºŒæ¡çº¿&quot;)</span><br><span class="line">plt.legend(loc=&#x27;upper right&#x27;)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210720114327323.png" alt="image-20210720114327323"></p>
]]></content>
      <categories>
        <category>æ•°æ®åˆ†æ</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>matlpotlib</tag>
      </tags>
  </entry>
  <entry>
    <title>numpyåŸºç¡€å­¦ä¹ </title>
    <url>/2021/07/24/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/numpy%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="numpyåŸºç¡€å­¦ä¹ "><a href="#numpyåŸºç¡€å­¦ä¹ " class="headerlink" title="numpyåŸºç¡€å­¦ä¹ "></a>numpyåŸºç¡€å­¦ä¹ </h1><p>numpyæ¨¡å—æ˜¯å­¦ä¹ æ•°æ®åˆ†æå’Œæ·±åº¦å­¦ä¹ å¿…é¡»å­¦ä¹ çš„å†…å®¹ï¼Œä¸€ä¸ªåœ¨Pythonä¸­åšç§‘å­¦è®¡ç®—çš„åŸºç¡€åº“ï¼Œé‡åœ¨æ•°å€¼è®¡ç®—ï¼Œä¹Ÿæ˜¯å¤§éƒ¨åˆ†PYTHONç§‘å­¦è®¡ç®—åº“çš„åŸºç¡€åº“ï¼Œå¤šç”¨äºåœ¨å¤§å‹ã€å¤šç»´æ•°ç»„ä¸Šæ‰§è¡Œæ•°å€¼è¿ç®—ï¼Œæ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸»è¦è®²è§£ä¸€ä¸‹numpyçš„åŸºç¡€å†…å®¹</p>
<p>å®˜ç½‘ğŸ‘‰<a href="https://numpy.org/">https://numpy.org/</a></p>
<span id="more"></span>
<h2 id="numpyåˆ›å»ºçŸ©é˜µ"><a href="#numpyåˆ›å»ºçŸ©é˜µ" class="headerlink" title="numpyåˆ›å»ºçŸ©é˜µ"></a>numpyåˆ›å»ºçŸ©é˜µ</h2><p>ä¸€èˆ¬åˆ›å»ºçŸ©é˜µä½¿ç”¨æ¯”è¾ƒå¤šçš„å°±æ˜¯arrayã€onesç­‰å‡½æ•°ï¼Œä¸‹é¢å±•ç¤ºä¸€äº›éƒ¨åˆ†åˆ›å»ºçŸ©é˜µçš„ç”¨æ³•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line">b = np.array(<span class="built_in">range</span>(<span class="number">1</span>, <span class="number">6</span>))</span><br><span class="line">c = np.arange(<span class="number">1</span>, <span class="number">6</span>)</span><br><span class="line">d = np.asarray([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>])</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;a&#x27;</span>, a, <span class="built_in">type</span>(a), a.dtype)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;b&#x27;</span>, b, <span class="built_in">type</span>(b), b.dtype)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;c&#x27;</span>, c, <span class="built_in">type</span>(c), c.dtype)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;d&#x27;</span>, d, <span class="built_in">type</span>(d), d.dtype)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">a [1 2 3 4 5] &lt;class &#x27;numpy.ndarray&#x27;&gt; int32</span><br><span class="line">b [1 2 3 4 5] &lt;class &#x27;numpy.ndarray&#x27;&gt; int32</span><br><span class="line">c [1 2 3 4 5] &lt;class &#x27;numpy.ndarray&#x27;&gt; int32</span><br><span class="line">d [1 2 3 4 5] &lt;class &#x27;numpy.ndarray&#x27;&gt; int32</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„å±•ç¤ºç»“æœè¯´æ˜<code>aã€bã€cã€d</code>å†…å®¹çš„å±•ç¤ºï¼Œå…¶ä¸­<code>aã€bã€cã€d</code>çš„å†…å®¹éƒ½æ˜¯<code>1,2,3,4,5</code>,å…¶ä¸­<code>aã€bã€cã€d</code>çš„ç±»å‹æ˜¯<code>numpy.ndarray</code>ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ çš„ç±»å‹æ˜¯<code>int32</code></p>
<h2 id="numpyä¸­å¸¸è§çš„æ•°æ®ç±»å‹"><a href="#numpyä¸­å¸¸è§çš„æ•°æ®ç±»å‹" class="headerlink" title="numpyä¸­å¸¸è§çš„æ•°æ®ç±»å‹"></a>numpyä¸­å¸¸è§çš„æ•°æ®ç±»å‹</h2><p>numpyå¸¸è§çš„æ•°æ®ç±»å‹è¡¨å±•ç¤ºå¦‚ä¸‹</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">åç§°</th>
<th style="text-align:left">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bool_</td>
<td style="text-align:left">å¸ƒå°”å‹æ•°æ®ç±»å‹ï¼ˆTrue æˆ–è€… Falseï¼‰</td>
</tr>
<tr>
<td style="text-align:left">int_</td>
<td style="text-align:left">é»˜è®¤çš„æ•´æ•°ç±»å‹ï¼ˆç±»ä¼¼äº C è¯­è¨€ä¸­çš„ longï¼Œint32 æˆ– int64ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">intc</td>
<td style="text-align:left">ä¸ C çš„ int ç±»å‹ä¸€æ ·ï¼Œä¸€èˆ¬æ˜¯ int32 æˆ– int 64</td>
</tr>
<tr>
<td style="text-align:left">intp</td>
<td style="text-align:left">ç”¨äºç´¢å¼•çš„æ•´æ•°ç±»å‹ï¼ˆç±»ä¼¼äº C çš„ ssize_tï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä»ç„¶æ˜¯ int32 æˆ– int64ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">int8</td>
<td style="text-align:left">å­—èŠ‚ï¼ˆ-128 to 127ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">int16</td>
<td style="text-align:left">æ•´æ•°ï¼ˆ-32768 to 32767ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">int32</td>
<td style="text-align:left">æ•´æ•°ï¼ˆ-2147483648 to 2147483647ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">int64</td>
<td style="text-align:left">æ•´æ•°ï¼ˆ-9223372036854775808 to 9223372036854775807ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">uint8</td>
<td style="text-align:left">æ— ç¬¦å·æ•´æ•°ï¼ˆ0 to 255ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">uint16</td>
<td style="text-align:left">æ— ç¬¦å·æ•´æ•°ï¼ˆ0 to 65535ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">uint32</td>
<td style="text-align:left">æ— ç¬¦å·æ•´æ•°ï¼ˆ0 to 4294967295ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">uint64</td>
<td style="text-align:left">æ— ç¬¦å·æ•´æ•°ï¼ˆ0 to 18446744073709551615ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">float_</td>
<td style="text-align:left">float64 ç±»å‹çš„ç®€å†™</td>
</tr>
<tr>
<td style="text-align:left">float16</td>
<td style="text-align:left">åŠç²¾åº¦æµ®ç‚¹æ•°ï¼ŒåŒ…æ‹¬ï¼š1 ä¸ªç¬¦å·ä½ï¼Œ5 ä¸ªæŒ‡æ•°ä½ï¼Œ10 ä¸ªå°¾æ•°ä½</td>
</tr>
<tr>
<td style="text-align:left">float32</td>
<td style="text-align:left">å•ç²¾åº¦æµ®ç‚¹æ•°ï¼ŒåŒ…æ‹¬ï¼š1 ä¸ªç¬¦å·ä½ï¼Œ8 ä¸ªæŒ‡æ•°ä½ï¼Œ23 ä¸ªå°¾æ•°ä½</td>
</tr>
<tr>
<td style="text-align:left">float64</td>
<td style="text-align:left">åŒç²¾åº¦æµ®ç‚¹æ•°ï¼ŒåŒ…æ‹¬ï¼š1 ä¸ªç¬¦å·ä½ï¼Œ11 ä¸ªæŒ‡æ•°ä½ï¼Œ52 ä¸ªå°¾æ•°ä½</td>
</tr>
<tr>
<td style="text-align:left">complex_</td>
<td style="text-align:left">complex128 ç±»å‹çš„ç®€å†™ï¼Œå³ 128 ä½å¤æ•°</td>
</tr>
<tr>
<td style="text-align:left">complex64</td>
<td style="text-align:left">å¤æ•°ï¼Œè¡¨ç¤ºåŒ 32 ä½æµ®ç‚¹æ•°ï¼ˆå®æ•°éƒ¨åˆ†å’Œè™šæ•°éƒ¨åˆ†ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">complex128</td>
<td style="text-align:left">å¤æ•°ï¼Œè¡¨ç¤ºåŒ 64 ä½æµ®ç‚¹æ•°ï¼ˆå®æ•°éƒ¨åˆ†å’Œè™šæ•°éƒ¨åˆ†ï¼‰</td>
</tr>
</tbody>
</table>
</div>
<p>æ•°æ®ç±»å‹çš„ç›¸å…³æ“ä½œ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="comment"># ç”Ÿæˆboolç±»å‹çš„</span></span><br><span class="line">a = np.array([<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>], dtype=np.bool_)</span><br><span class="line"><span class="comment"># å±•ç¤ºç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;a&#x27;</span>, a, <span class="built_in">type</span>(a), a.dtype)</span><br><span class="line"><span class="comment"># è½¬åŒ–ä¸ºintç±»å‹</span></span><br><span class="line">b = a.astype(np.int8)</span><br><span class="line"><span class="comment"># å±•ç¤ºç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;b&#x27;</span>, b, <span class="built_in">type</span>(b), b.dtype)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">a [ True False  True False] &lt;class &#x27;numpy.ndarray&#x27;&gt; bool</span><br><span class="line">b [1 0 1 0] &lt;class &#x27;numpy.ndarray&#x27;&gt; int8</span><br></pre></td></tr></table></figure>
<p>æµ®ç‚¹æ•°çš„ç›¸å…³æ“ä½œ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆå‡å€¼ä¸º1.75,æ ‡å‡†å·®ä¸º1çš„æ­£æ€åˆ†å¸ƒæ•°æ®,10ä¸ª</span></span><br><span class="line">a = np.random.normal(<span class="number">1.75</span>, <span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># å±•ç¤ºç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;a&#x27;</span>, a, <span class="built_in">type</span>(a), a.dtype)</span><br><span class="line"><span class="comment"># ä¿ç•™ä¸¤ä½å°æ•°</span></span><br><span class="line">b = np.<span class="built_in">round</span>(a, <span class="number">2</span>)</span><br><span class="line"><span class="comment"># å±•ç¤ºç»“æœ</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;b&#x27;</span>, b, <span class="built_in">type</span>(b), b.dtype)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">a [ 1.13844152  1.2766936   0.99489152  2.03742641  3.27012804  0.6785755</span><br><span class="line">  0.39133123  0.44052134 -0.38859551  1.39006692] &lt;class &#x27;numpy.ndarray&#x27;&gt; float64</span><br><span class="line">b [ 1.14  1.28  0.99  2.04  3.27  0.68  0.39  0.44 -0.39  1.39] &lt;class &#x27;numpy.ndarray&#x27;&gt; float64</span><br></pre></td></tr></table></figure>
<h2 id="æ•°ç»„çš„å½¢çŠ¶"><a href="#æ•°ç»„çš„å½¢çŠ¶" class="headerlink" title="æ•°ç»„çš„å½¢çŠ¶"></a>æ•°ç»„çš„å½¢çŠ¶</h2><p>numpyæ•°ç»„æœ‰ä¸åŒçš„å½¢çŠ¶ï¼Œæœ‰æ—¶å€™ç†è§£èµ·æ¥å¯èƒ½æœ‰äº›éš¾ä»¥ç†è§£ã€‚ç‰¹åˆ«æ˜¯ç»´åº¦å¤šäº†ä¹‹åå°±æ¯”è¾ƒæ™ƒçœ¼ï¼Œä¸è¿‡ä¸€èˆ¬ç†è§£3ç»´ä»¥å†…çš„å°±å¯ä»¥äº†ã€‚</p>
<p>æ¯”å¦‚è¿™ä¸ªä¸‰ç»´æ•°ç»„(çœ‹æœ‰å‡ ä¸ªå·¦æ‹¬å·å°±æ˜¯å‡ ä¸ªç»´åº¦)ï¼Œæ€ä¹ˆçœ‹å‡ºå½¢çŠ¶å‘¢</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[[[1,2,3],[1,2,3],[1,2,3]],[[1,2,3],[1,2,3],[1,2,3]]]</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæ˜¯çœ‹æœ€é‡Œé¢é‚£ä¸ª<code>[1,2,3]</code>æœ‰ä¸‰ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥æ˜¯3</p>
<p>å…¶æ¬¡æ˜¯çœ‹è¿™ä¸ª<code>[[1,2,3],[1,2,3],[1,2,3]]</code>,æœ‰ä¸‰ä¸ª<code>[1,2,3]</code>å…ƒç´ ï¼Œæ‰€ä»¥æ˜¯3</p>
<p>æœ€ç»ˆçœ‹<code>[[[1,2,3],[1,2,3],[1,2,3]],[[1,2,3],[1,2,3],[1,2,3]]]</code>,æœ‰ä¸¤ä¸ª<code>[[1,2,3],[1,2,3],[1,2,3]]</code>ï¼Œæ‰€ä»¥æ˜¯2</p>
<p>ç»¼ä¸Šè¿™ä¸ªæ•°ç»„çš„å½¢çŠ¶æ˜¯<code>(2,3,3)</code></p>
<p>æ•°ç»„å½¢çŠ¶æ“ä½œ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="built_in">print</span>(a)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„å½¢çŠ¶&quot;</span>, a.shape)</span><br><span class="line">b = a.reshape(<span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bçš„å½¢çŠ¶&quot;</span>, b.shape)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">[[3 4 5 6 7 8]</span><br><span class="line"> [4 5 6 7 8 9]]</span><br><span class="line">(2, 6)</span><br><span class="line">[[3 4 5 6 7 8]</span><br><span class="line"> [4 5 6 7 8 9]]</span><br></pre></td></tr></table></figure>
<h2 id="æ•°ç»„çš„è½´"><a href="#æ•°ç»„çš„è½´" class="headerlink" title="æ•°ç»„çš„è½´"></a>æ•°ç»„çš„è½´</h2><p>æ•°ç»„çš„è½´åœ¨numpyä¸­å¯ä»¥ç†è§£ä¸ºæ–¹å‘,ä½¿ç”¨0,1,2â€¦æ•°å­—è¡¨ç¤º,å¯¹äºä¸€ä¸ªä¸€ç»´æ•°ç»„,åªæœ‰ä¸€ä¸ª0è½´,å¯¹äº2ç»´æ•°ç»„(shape(2,2)),æœ‰0è½´å’Œ1è½´,å¯¹äºä¸‰ç»´æ•°ç»„(shape(2,2, 3)),æœ‰0,1,2è½´ã€‚</p>
<p>æœ‰äº†è½´çš„æ¦‚å¿µä¹‹å,æˆ‘ä»¬è®¡ç®—ä¼šæ›´åŠ æ–¹ä¾¿,æ¯”å¦‚è®¡ç®—ä¸€ä¸ª2ç»´æ•°ç»„çš„å¹³å‡å€¼,å¿…é¡»æŒ‡å®šæ˜¯è®¡ç®—å“ªä¸ªæ–¹å‘ä¸Šé¢çš„æ•°å­—çš„å¹³å‡å€¼</p>
<p>å¦‚ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arr = np.random.randn(<span class="number">4</span>,<span class="number">3</span>)  <span class="comment">#shape(4,3)</span></span><br><span class="line">arr_mean = arr.mean(<span class="number">0</span>)      <span class="comment">#shape(3,)</span></span><br></pre></td></tr></table></figure>
<p>å›¾è§£ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210726115552814.png" alt="image-20210726115552814"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®åˆ†æ/image-20210726115616019.png" alt="image-20210726115616019"></p>
<h2 id="æ•°ç»„ç›¸å…³çš„è®¡ç®—æ“ä½œ"><a href="#æ•°ç»„ç›¸å…³çš„è®¡ç®—æ“ä½œ" class="headerlink" title="æ•°ç»„ç›¸å…³çš„è®¡ç®—æ“ä½œ"></a>æ•°ç»„ç›¸å…³çš„è®¡ç®—æ“ä½œ</h2><h3 id="æ•°ç»„å’Œç®—çš„è®¡ç®—ç›¸å…³æ“ä½œ"><a href="#æ•°ç»„å’Œç®—çš„è®¡ç®—ç›¸å…³æ“ä½œ" class="headerlink" title="æ•°ç»„å’Œç®—çš„è®¡ç®—ç›¸å…³æ“ä½œ"></a>æ•°ç»„å’Œç®—çš„è®¡ç®—ç›¸å…³æ“ä½œ</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„å€¼\n&quot;</span>, a)</span><br><span class="line">b = a + <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a+1çš„å€¼\n&quot;</span>, b)</span><br><span class="line">c = a * <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a*3çš„å€¼\n&quot;</span>, c)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤ºå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°éƒ½æ˜¯åœ¨æ¯ä¸ªä½ç½®ä¸Šè¿›è¡Œå¯¹åº”çš„æ“ä½œï¼Œè¿™ä¸ªå…¶å®æ˜¯numpyå½“ä¸­çš„å¹¿æ’­æœºåˆ¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">açš„å€¼</span><br><span class="line"> [[3 4 5 6 7 8]</span><br><span class="line"> [4 5 6 7 8 9]]</span><br><span class="line">a+1çš„å€¼</span><br><span class="line"> [[ 4  5  6  7  8  9]</span><br><span class="line"> [ 5  6  7  8  9 10]]</span><br><span class="line">a*3çš„å€¼</span><br><span class="line"> [[ 9 12 15 18 21 24]</span><br><span class="line"> [12 15 18 21 24 27]]</span><br></pre></td></tr></table></figure>
<h3 id="æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ç›¸åŒæ—¶"><a href="#æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ç›¸åŒæ—¶" class="headerlink" title="æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ç›¸åŒæ—¶"></a>æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ç›¸åŒæ—¶</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„å€¼\n&quot;</span>, a)</span><br><span class="line">b = a * <span class="number">3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bçš„å€¼\n&quot;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a+bçš„å€¼\n&quot;</span>, a + b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a-bçš„å€¼\n&quot;</span>, a - b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a*bçš„å€¼\n&quot;</span>, a * b)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤ºå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°æ•°ç»„ç›¸ä¹˜æ˜¯å¯¹åº”å…ƒç´ çš„ä¹˜ç§¯ï¼Œä¸çº¿æ€§ä»£æ•°å½“ä¸­çš„çŸ©é˜µç›¸ä¹˜ä¸ä¸€æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">açš„å€¼</span><br><span class="line"> [[3 4 5 6 7 8]</span><br><span class="line"> [4 5 6 7 8 9]]</span><br><span class="line">bçš„å€¼</span><br><span class="line"> [[ 9 12 15 18 21 24]</span><br><span class="line"> [12 15 18 21 24 27]]</span><br><span class="line">a+bçš„å€¼</span><br><span class="line"> [[12 16 20 24 28 32]</span><br><span class="line"> [16 20 24 28 32 36]]</span><br><span class="line">a-bçš„å€¼</span><br><span class="line"> [[ -6  -8 -10 -12 -14 -16]</span><br><span class="line"> [ -8 -10 -12 -14 -16 -18]]</span><br><span class="line">a*bçš„å€¼</span><br><span class="line"> [[ 27  48  75 108 147 192]</span><br><span class="line"> [ 48  75 108 147 192 243]]</span><br></pre></td></tr></table></figure>
<h3 id="æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ä¸åŒæ—¶"><a href="#æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ä¸åŒæ—¶" class="headerlink" title="æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ä¸åŒæ—¶"></a>æ•°ç»„å’Œæ•°ç»„çš„ç›¸å…³è®¡ç®—ï¼Œæ•°ç»„ç»´åº¦ä¸åŒæ—¶</h3><p>ä¸¤ä¸ªæ•°ç»„ç»´åº¦ä¸ç”¨æ—¶ï¼Œnumpyå½“ä¸­ä¼šæœ‰ä¸€ä¸ªè‘—åçš„å¹¿æ’­æœºåˆ¶ï¼Œå…·ä½“çš„è®²è§£å¯ä»¥æŸ¥çœ‹<a href="https://www.cnblogs.com/jiaxin359/p/9021726.html">https://www.cnblogs.com/jiaxin359/p/9021726.html</a>è¿™ç¯‡æ–‡ç« çš„è®²è§£</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;açš„å€¼\n&quot;</span>, a)</span><br><span class="line">b = np.array([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bçš„å€¼\n&quot;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a+bçš„å€¼\n&quot;</span>, a + b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a-bçš„å€¼\n&quot;</span>, a - b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a*bçš„å€¼\n&quot;</span>, a * b)</span><br><span class="line">c = np.array([[<span class="number">1</span>], [<span class="number">2</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;cçš„å€¼\n&quot;</span>, c)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a+cçš„å€¼\n&quot;</span>, a + c)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a-cçš„å€¼\n&quot;</span>, a - c)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;a*cçš„å€¼\n&quot;</span>, a * c)</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°bæ˜¯æ²¿ç€è½´0ä¸Šè¿›è¡Œå¹¿æ’­ï¼Œè€Œcæ˜¯æ²¿ç€è½´1ä¸Šè¿›è¡Œå¹¿æ’­çš„</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">açš„å€¼</span><br><span class="line"> [[3 4 5 6 7 8]</span><br><span class="line"> [4 5 6 7 8 9]]</span><br><span class="line">bçš„å€¼</span><br><span class="line"> [1 2 3 4 5 6]</span><br><span class="line">a+bçš„å€¼</span><br><span class="line"> [[ 4  6  8 10 12 14]</span><br><span class="line"> [ 5  7  9 11 13 15]]</span><br><span class="line">a-bçš„å€¼</span><br><span class="line"> [[2 2 2 2 2 2]</span><br><span class="line"> [3 3 3 3 3 3]]</span><br><span class="line">a*bçš„å€¼</span><br><span class="line"> [[ 3  8 15 24 35 48]</span><br><span class="line"> [ 4 10 18 28 40 54]]</span><br><span class="line">cçš„å€¼</span><br><span class="line"> [[1]</span><br><span class="line"> [2]]</span><br><span class="line">a+cçš„å€¼</span><br><span class="line"> [[ 4  5  6  7  8  9]</span><br><span class="line"> [ 6  7  8  9 10 11]]</span><br><span class="line">a-cçš„å€¼</span><br><span class="line"> [[2 3 4 5 6 7]</span><br><span class="line"> [2 3 4 5 6 7]]</span><br><span class="line">a*cçš„å€¼</span><br><span class="line"> [[ 3  4  5  6  7  8]</span><br><span class="line"> [ 8 10 12 14 16 18]]</span><br></pre></td></tr></table></figure>
<h2 id="æ•°ç»„çš„æ‹¼æ¥"><a href="#æ•°ç»„çš„æ‹¼æ¥" class="headerlink" title="æ•°ç»„çš„æ‹¼æ¥"></a>æ•°ç»„çš„æ‹¼æ¥</h2><p>æ‹¼æ¥ç›¸å…³çš„å‡½æ•°æœ‰è®¸å¤šï¼Œåˆ—å‡ºä¸‹é¢çš„å‡ ä¸ªå‡½æ•°</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">å‡½æ•°</th>
<th style="text-align:left">ä»‹ç»</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">concatenate</td>
<td style="text-align:left">æä¾›äº†axiså‚æ•°ï¼Œç”¨äºæŒ‡å®šæ‹¼æ¥æ–¹å‘</td>
</tr>
<tr>
<td style="text-align:left">append</td>
<td style="text-align:left">é»˜è®¤å…ˆravelå†æ‹¼æ¥æˆä¸€ç»´æ•°ç»„ï¼Œä¹Ÿå¯æŒ‡å®šaxis</td>
</tr>
<tr>
<td style="text-align:left">stack</td>
<td style="text-align:left">æä¾›äº†axiså‚æ•°ï¼Œç”¨äºç”Ÿæˆæ–°çš„ç»´åº¦</td>
</tr>
<tr>
<td style="text-align:left">vstack</td>
<td style="text-align:left">å‚ç›´æ‹¼æ¥ï¼Œæ²¿ç€åˆ—çš„æ–¹å‘ï¼Œå¯¹è¡Œè¿›è¡Œæ‹¼æ¥</td>
</tr>
<tr>
<td style="text-align:left">hstack</td>
<td style="text-align:left">æ°´å¹³æ‹¼æ¥ï¼Œæ²¿ç€è¡Œçš„æ–¹å‘ï¼Œå¯¹åˆ—è¿›è¡Œæ‹¼æ¥</td>
</tr>
<tr>
<td style="text-align:left">dstack</td>
<td style="text-align:left">æ²¿ç€ç¬¬ä¸‰ä¸ªè½´ï¼ˆæ·±åº¦æ–¹å‘ï¼‰è¿›è¡Œæ‹¼æ¥</td>
</tr>
</tbody>
</table>
</div>
<h3 id="concatenate"><a href="#concatenate" class="headerlink" title="concatenate"></a>concatenate</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„a\n&#x27;</span>, a)</span><br><span class="line">b = np.array([[<span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„b\n&#x27;</span>, b)</span><br><span class="line">c = np.array([[<span class="number">5</span>], [<span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„c\n&#x27;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;åœ¨è½´0ä¸Šæ‹¼æ¥\n&#x27;</span>, np.concatenate((a, b), axis=<span class="number">0</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;åœ¨è½´1ä¸Šæ‹¼æ¥\n&#x27;</span>, np.concatenate((a, c), axis=<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ä¸æŒ‡å®šè½´ä¸Šæ‹¼æ¥\n&#x27;</span>, np.concatenate((a, b), axis=<span class="literal">None</span>))</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å¯¹äº0è½´å’Œ1è½´ä¸Šçš„è¿æ¥æ˜¯ä¸åŒçš„ï¼Œå¹¶ä¸”å¦‚æœä¸æŒ‡å®šè½´å°±æ˜¯å˜æˆä¸€ç»´</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">æ•°ç»„a</span><br><span class="line"> [[1 2]</span><br><span class="line"> [3 4]]</span><br><span class="line">æ•°ç»„b</span><br><span class="line"> [[5 6]]</span><br><span class="line">æ•°ç»„c</span><br><span class="line"> [[5 6]]</span><br><span class="line">åœ¨è½´0ä¸Šæ‹¼æ¥</span><br><span class="line"> [[1 2]</span><br><span class="line"> [3 4]</span><br><span class="line"> [5 6]]</span><br><span class="line">åœ¨è½´1ä¸Šæ‹¼æ¥</span><br><span class="line"> [[1 2 5]</span><br><span class="line"> [3 4 6]]</span><br><span class="line">ä¸æŒ‡å®šè½´ä¸Šæ‹¼æ¥</span><br><span class="line"> [1 2 3 4 5 6]</span><br></pre></td></tr></table></figure>
<h3 id="append"><a href="#append" class="headerlink" title="append"></a>append</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„a\n&#x27;</span>, a)</span><br><span class="line">b = np.array([[<span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„b\n&#x27;</span>, b)</span><br><span class="line">c = np.array([[<span class="number">5</span>], [<span class="number">6</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„c\n&#x27;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;åœ¨è½´0ä¸Šæ‹¼æ¥\n&#x27;</span>, np.append(a, b, axis=<span class="number">0</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;åœ¨è½´1ä¸Šæ‹¼æ¥\n&#x27;</span>, np.append(a, c, axis=<span class="number">1</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ä¸æŒ‡å®šè½´ä¸Šæ‹¼æ¥\n&#x27;</span>, np.append(a, b))</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">æ•°ç»„a</span><br><span class="line"> [[1 2]</span><br><span class="line"> [3 4]]</span><br><span class="line">æ•°ç»„b</span><br><span class="line"> [[5 6]]</span><br><span class="line">æ•°ç»„c</span><br><span class="line"> [[5 6]]</span><br><span class="line">åœ¨è½´0ä¸Šæ‹¼æ¥</span><br><span class="line"> [[1 2]</span><br><span class="line"> [3 4]</span><br><span class="line"> [5 6]]</span><br><span class="line">åœ¨è½´1ä¸Šæ‹¼æ¥</span><br><span class="line"> [[1 2 5]</span><br><span class="line"> [3 4 6]]</span><br><span class="line">ä¸æŒ‡å®šè½´ä¸Šæ‹¼æ¥</span><br><span class="line"> [1 2 3 4 5 6]</span><br></pre></td></tr></table></figure>
<h3 id="stack"><a href="#stack" class="headerlink" title="stack"></a>stack</h3><p>stackå‡½æ•°æ¯”è¾ƒå¤æ‚ï¼Œä»¥åå†è¡¥ä¸Š</p>
<h3 id="vstackã€hstackå’Œdstack"><a href="#vstackã€hstackå’Œdstack" class="headerlink" title="vstackã€hstackå’Œdstack"></a>vstackã€hstackå’Œdstack</h3><p>vstackã€hstackå’Œdstackåˆ†åˆ«ä»£è¡¨å‚ç›´æ‹¼æ¥ã€æ°´å¹³æ‹¼æ¥å’Œæ·±åº¦æ‹¼æ¥</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.array((<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„a\n&#x27;</span>, a)</span><br><span class="line">b = np.array((<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ•°ç»„b\n&#x27;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å‚ç›´æ‹¼æ¥\n&#x27;</span>, np.vstack((a, b)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ°´å¹³æ‹¼æ¥\n&#x27;</span>, np.hstack((a, b)))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;æ·±åº¦æ‹¼æ¥\n&#x27;</span>, np.dstack((a, b)))</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">æ•°ç»„a</span><br><span class="line"> [1 2 3]</span><br><span class="line">æ•°ç»„b</span><br><span class="line"> [4 5 6]</span><br><span class="line">å‚ç›´æ‹¼æ¥</span><br><span class="line"> [[1 2 3]</span><br><span class="line"> [4 5 6]]</span><br><span class="line">æ°´å¹³æ‹¼æ¥</span><br><span class="line"> [1 2 3 4 5 6]</span><br><span class="line">æ·±åº¦æ‹¼æ¥</span><br><span class="line"> [[[1 4]</span><br><span class="line">  [2 5]</span><br><span class="line">  [3 6]]]</span><br></pre></td></tr></table></figure>
<p>å¯èƒ½æ°´å¹³å’Œå‚ç›´æ¯”è¾ƒå¥½ç†è§£ï¼Œé‚£ä¸ªæ·±åº¦æ‹¼æ¥ï¼ˆç¬¬ä¸‰ä¸ªç»´åº¦ï¼‰å°±æ¯”è¾ƒéš¾ä»¥ç†è§£äº†ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸Šçš„è§£é‡Šæ˜¯<code>è¿™ç­‰æ•ˆäºåœ¨å½¢çŠ¶ (M,N) çš„äºŒç»´é˜µåˆ—è¢«é‡æ–°æ•´å½¢ä¸º (M,N,1) å¹¶ä¸”å½¢çŠ¶ (N,) çš„ä¸€ç»´é˜µåˆ—è¢«é‡æ–°æ•´å½¢ä¸º (1, N,1)ã€‚é‡å»ºé™¤ä»¥ dsplit çš„æ•°ç»„</code>ã€‚ä¹Ÿå°±æ˜¯æ˜¯è¯´äºŒç»´æ•°ç»„å’Œä¸€ç»´æ•°ç»„éƒ½ä¼šè¢«é‡æ–°reshapeæˆä¸‰ç»´æ•°ç»„ã€‚æ‰€ä»¥å‡ºç°äº†ä¸Šé¢çš„ç»“æœ</p>
<h2 id="numpyç´¢å¼•å’Œåˆ‡ç‰‡"><a href="#numpyç´¢å¼•å’Œåˆ‡ç‰‡" class="headerlink" title="numpyç´¢å¼•å’Œåˆ‡ç‰‡"></a>numpyç´¢å¼•å’Œåˆ‡ç‰‡</h2><p>numpyä¸­ç´¢å¼•å’Œåˆ‡ç‰‡å’ŒpythonåŸç”Ÿçš„listæ˜¯ç›¸åŒçš„</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.arange(<span class="number">24</span>).reshape((<span class="number">4</span>, <span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å±•ç¤ºa\n&#x27;</span>, a)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å–ä¸€è¡Œ&quot;</span>, a[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å–ä¸€åˆ—&quot;</span>, a[:, <span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å–å¤šè¡Œ\n&quot;</span>, a[<span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å–å¤šåˆ—\n&quot;</span>, a[:, <span class="number">0</span>:<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å–å¤šè¡Œå¤šåˆ—\n&quot;</span>, a[<span class="number">0</span>:<span class="number">3</span>, <span class="number">0</span>:<span class="number">3</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä½¿ç”¨æ•°ç»„ç´¢å¼•\n&quot;</span>, a[[<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä½¿ç”¨æ•°ç»„ç´¢å¼•\n&quot;</span>, a[[<span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">3</span>], [<span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>]])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä½¿ç”¨æ•°ç»„ç´¢å¼•\n&quot;</span>, a[[[<span class="number">0</span>, <span class="number">0</span>], [<span class="number">3</span>, <span class="number">3</span>]], [[<span class="number">0</span>, <span class="number">2</span>], [<span class="number">0</span>, <span class="number">2</span>]]])</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤ºï¼Œå¯ä»¥å‘ç°æ•°ç»„ç´¢å¼•çš„ç»´åº¦ä¼šå¯¹è¿”å›åçš„ç»´åº¦äº§ç”Ÿå½±å“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">å±•ç¤ºa</span><br><span class="line"> [[ 0  1  2  3  4  5]</span><br><span class="line"> [ 6  7  8  9 10 11]</span><br><span class="line"> [12 13 14 15 16 17]</span><br><span class="line"> [18 19 20 21 22 23]]</span><br><span class="line">å–ä¸€è¡Œ [0 1 2 3 4 5]</span><br><span class="line">å–ä¸€åˆ— [ 2  8 14 20]</span><br><span class="line">å–å¤šè¡Œ</span><br><span class="line"> [[ 0  1  2  3  4  5]</span><br><span class="line"> [ 6  7  8  9 10 11]]</span><br><span class="line">å–å¤šåˆ—</span><br><span class="line"> [[ 0  1]</span><br><span class="line"> [ 6  7]</span><br><span class="line"> [12 13]</span><br><span class="line"> [18 19]]</span><br><span class="line">å–å¤šè¡Œå¤šåˆ—</span><br><span class="line"> [[ 0  1  2]</span><br><span class="line"> [ 6  7  8]</span><br><span class="line"> [12 13 14]]</span><br><span class="line">ä½¿ç”¨æ•°ç»„ç´¢å¼•</span><br><span class="line"> [ 0  7 12]</span><br><span class="line">ä½¿ç”¨æ•°ç»„ç´¢å¼•</span><br><span class="line"> [ 0  2 18 20]</span><br><span class="line">ä½¿ç”¨æ•°ç»„ç´¢å¼•</span><br><span class="line"> [[ 0  2]</span><br><span class="line"> [18 20]]</span><br></pre></td></tr></table></figure>
<p>numpyå½“ä¸­è¿˜å¯ä»¥ä½¿ç”¨å¸ƒå°”ç´¢å¼•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.arange(<span class="number">24</span>).reshape((<span class="number">4</span>, <span class="number">6</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å±•ç¤ºa\n&#x27;</span>, a)</span><br><span class="line">b = a &lt; <span class="number">10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;å±•ç¤ºb\n&quot;</span>, b)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ä½¿ç”¨å¸ƒå°”ç´¢å¼•\n&quot;</span>, a[b])</span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">å±•ç¤ºa</span><br><span class="line"> [[ 0  1  2  3  4  5]</span><br><span class="line"> [ 6  7  8  9 10 11]</span><br><span class="line"> [12 13 14 15 16 17]</span><br><span class="line"> [18 19 20 21 22 23]]</span><br><span class="line">å±•ç¤ºb</span><br><span class="line"> [[ True  True  True  True  True  True]</span><br><span class="line"> [ True  True  True  True False False]</span><br><span class="line"> [False False False False False False]</span><br><span class="line"> [False False False False False False]]</span><br><span class="line">ä½¿ç”¨å¸ƒå°”ç´¢å¼•</span><br><span class="line"> [0 1 2 3 4 5 6 7 8 9]</span><br></pre></td></tr></table></figure>
<h2 id="numpyä¸­çš„nanå’Œinf"><a href="#numpyä¸­çš„nanå’Œinf" class="headerlink" title="numpyä¸­çš„nanå’Œinf"></a>numpyä¸­çš„nanå’Œinf</h2><p>nan(NAN,Nan):not a numberè¡¨ç¤ºä¸æ˜¯ä¸€ä¸ªæ•°å­—</p>
<p>ä»€ä¹ˆæ—¶å€™numpyä¸­ä¼šå‡ºç°nanï¼Ÿ</p>
<p>å½“æˆ‘ä»¬è¯»å–æœ¬åœ°çš„æ–‡ä»¶ä¸ºfloatçš„æ—¶å€™ï¼Œå¦‚æœæœ‰ç¼ºå¤±ï¼Œå°±ä¼šå‡ºç°nanï¼Œæˆ–è€…å½“åšäº†ä¸€ä¸ªä¸åˆé€‚çš„è®¡ç®—çš„æ—¶å€™(æ¯”å¦‚æ— ç©·å¤§(inf)å‡å»æ— ç©·å¤§)</p>
<p>inf(-inf,inf):infinity,infè¡¨ç¤ºæ­£æ— ç©·ï¼Œ-infè¡¨ç¤ºè´Ÿæ— ç©·</p>
<p>ä»€ä¹ˆæ—¶å€™å›å‡ºç°infåŒ…æ‹¬ï¼ˆ-infï¼Œ+infï¼‰ï¼Ÿ</p>
<p>æ¯”å¦‚ä¸€ä¸ªæ•°å­—é™¤ä»¥0ï¼Œï¼ˆpythonä¸­ç›´æ¥ä¼šæŠ¥é”™ï¼Œnumpyä¸­æ˜¯ä¸€ä¸ªinfæˆ–è€…-infï¼‰</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.inf</span><br><span class="line">b = np.nan</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(a)) <span class="comment"># &lt;class &#x27;float&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(b)) <span class="comment"># &lt;class &#x27;float&#x27;&gt;</span></span><br></pre></td></tr></table></figure>
<p>nanéœ€è¦æ³¨æ„çš„ç‚¹</p>
<ol>
<li><p>ä¸¤ä¸ªnanæ˜¯ä¸ç›¸ç­‰çš„</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">np.nan==np.nan <span class="comment">#False</span></span><br><span class="line">np.nan!=np.nan <span class="comment">#True</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä»»ä½•å€¼å’Œnanè¿›è¡Œè®¡ç®—éƒ½æ˜¯nan</p>
</li>
</ol>
<p>åˆ¤æ–­æ•°ç»„ä¸­nançš„ä¸ªæ•°æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>np.count_nonzero(t!=t)</code>è¿›è¡Œ</p>
<p>æ”¹å˜æ•°ç»„ä¸­nançš„å€¼ä¹Ÿå¯ä»¥ä½¿ç”¨<code>t[np.isnan(t)] = 0</code>è¿›è¡Œ</p>
<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>numpyå½“ä¸­ä¸‰å…ƒè¿ç®—ç¬¦<code>where</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">a = np.arange(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;açš„å€¼\n&#x27;</span>, a)</span><br><span class="line"><span class="comment"># å°†a å½“ä¸­å¤§äº5çš„éƒ¨åˆ†ä¹˜ä»¥10</span></span><br><span class="line"><span class="built_in">print</span>(np.where(a &lt; <span class="number">5</span>, a, <span class="number">10</span> * a))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç»“æœå±•ç¤º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">D:\ProgramData\Anaconda3\python.exe E:/work_space/shixi/Problem/Test.py</span><br><span class="line">açš„å€¼</span><br><span class="line"> [0 1 2 3 4 5 6 7 8 9]</span><br><span class="line">[ 0  1  2  3  4 50 60 70 80 90]</span><br></pre></td></tr></table></figure>
<p>numpyå½“ä¸­ç»å¸¸ä½¿ç”¨çš„ç»Ÿè®¡å‡½æ•°æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ±‚å’Œï¼št.sum(axis=None)</span><br><span class="line"></span><br><span class="line">å‡å€¼ï¼št.mean(a,axis=None) å—ç¦»ç¾¤ç‚¹çš„å½±å“è¾ƒå¤§</span><br><span class="line"></span><br><span class="line">ä¸­å€¼ï¼šnp.median(t,axis=None)</span><br><span class="line"></span><br><span class="line">æœ€å¤§å€¼ï¼št.max(axis=None)</span><br><span class="line"></span><br><span class="line">æœ€å°å€¼ï¼št.min(axis=None)</span><br><span class="line"></span><br><span class="line">æå€¼ï¼šnp.ptp(t,axis=None) å³æœ€å¤§å€¼å’Œæœ€å°å€¼å·®</span><br><span class="line"></span><br><span class="line">æ ‡å‡†å·®ï¼št.std(axis=None)</span><br><span class="line"></span><br><span class="line">è·å–æœ€å¤§å€¼æœ€å°å€¼çš„ä½ç½® np.argmax(t,axis=0) np.argmin(t,axis=1)</span><br><span class="line"></span><br><span class="line">åˆ›å»ºä¸€ä¸ªå…¨0çš„æ•°ç»„: np.zeros((3,4))</span><br><span class="line"></span><br><span class="line">åˆ›å»ºä¸€ä¸ªå…¨1çš„æ•°ç»„:np.ones((3,4))</span><br><span class="line"></span><br><span class="line">åˆ›å»ºä¸€ä¸ªå¯¹è§’çº¿ä¸º1çš„æ­£æ–¹å½¢æ•°ç»„(æ–¹é˜µ)np.eye(3)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>æ•°æ®åˆ†æ</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>numpy</tag>
      </tags>
  </entry>
  <entry>
    <title>QTbinarytree</title>
    <url>/2021/05/20/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/QTbinarytree/</url>
    <content><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>Qtç»˜åˆ¶äºŒå‰æ ‘æ˜¯å¤§äºŒæ—¶æ•°æ®ç»“æ„çš„ä¸€ä¸ªå®ä¹ é¢˜ç›®ï¼Œå½“æ—¶çš„åŠŸèƒ½è¦æ±‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>é”®ç›˜è¾“å…¥äºŒå‰æ ‘ç»“ç‚¹åºåˆ—ï¼ˆå‰åºæˆ–å±‚æ¬¡ï¼‰ï¼Œåˆ›å»ºä¸€æ£µäºŒå‰æ ‘<ul>
<li>å®ç°<strong>SwapTree</strong>æ–¹æ³•ï¼Œä»¥æ ¹ç»“ç‚¹ä¸ºå‚æ•°ï¼Œäº¤æ¢æ¯ä¸ªç»“ç‚¹çš„å·¦å­æ ‘å’Œå³å­æ ‘ï¼ˆæç¤ºï¼šå‰åºé€’å½’ï¼‰</li>
</ul>
</li>
<li>å®ç°<strong>Find</strong>æ–¹æ³•ï¼ŒæŸ¥æ‰¾å€¼ä¸º<strong>key</strong>çš„ç»“ç‚¹ï¼Œå¹¶è¾“å‡ºè¯¥ç»“ç‚¹çš„æ‰€æœ‰ç¥–å…ˆç»“ç‚¹</li>
<li><strong>è¾“å…¥ä¸€æ£µäºŒå‰æ ‘çš„å‰åºéå†åºåˆ—å’Œä¸­åºéå†åºåˆ—ï¼Œé‡æ„è¿™æ£µäºŒå‰æ ‘ï¼ˆè¿™ä¸ªåºåˆ—é‡Œé¢æ˜¯ä¸å¸¦ç©ºç»“ç‚¹â€™#â€˜çš„ï¼‰</strong></li>
</ul>
<span id="more"></span>
<p> äºŒå‰æ ‘çš„å‰åºå’Œä¸­åºåˆ›å»ºè¦æ±‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>è¦æ±‚é”®ç›˜è¾“å…¥äºŒå‰æ ‘ç»“ç‚¹åºåˆ—<ul>
<li>ç»“ç‚¹åºåˆ—å¯ä»¥æ˜¯å‰åºï¼Œä¹Ÿå¯ä»¥æ˜¯å±‚æ¬¡</li>
</ul>
</li>
<li><p>ç©ºç»“ç‚¹ä»¥<strong>#</strong>è¡¨ç¤º</p>
<p>ç”±é¢˜ç›®å¯çŸ¥å‘¢ä¸»è¦å°±æ˜¯å¯è§†åŒ–ä¸€é¢—äºŒå‰æ ‘ï¼Œå¦å¤–éœ€è¦è¯´æ¸…çš„æ˜¯<strong>ä»…ä»…å‰åºéå†æ˜¯æ— æ³•ç¡®å®šä¸€é¢—äºŒå‰æ ‘çš„é¡ºåºçš„ï¼Œä½†æ˜¯å¦‚æœå‰åºä¸­åŠ ä¸Šç©ºèŠ‚ç‚¹â€˜#â€™ï¼Œæ˜¯å¯ä»¥ç¡®å®šçš„</strong></p>
</li>
</ul>
<p><strong>ç¤ºä¾‹1ï¼ˆå‰åºå’Œå±‚æ¬¡çš„ï¼‰ï¼š</strong></p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•°æ®ç»“æ„/QTbinarytree.png" alt="QTbinarytree.png"></p>
<p><strong>ç¤ºä¾‹2ï¼ˆå‰åº=â€œABC##DE#G##F###â€ æˆ–è€… å±‚æ¬¡=â€œAB#CD##EF#G####â€ï¼‰ï¼š</strong></p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•°æ®ç»“æ„/QTbinarytree3.png" alt="QTbinarytree3"></p>
<p><strong>ç¤ºä¾‹3ï¼ˆå‰åº=â€ABHFDECKGâ€å’Œä¸­åº=â€HBDFAEKCGâ€ï¼‰ï¼š</strong></p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•°æ®ç»“æ„/QTbinarytree4.png" alt="QTbinarytree4"></p>
<h2 id="ä¸»è¦å»ºæ ‘æ€è·¯"><a href="#ä¸»è¦å»ºæ ‘æ€è·¯" class="headerlink" title="ä¸»è¦å»ºæ ‘æ€è·¯"></a>ä¸»è¦å»ºæ ‘æ€è·¯</h2><ol>
<li>ä¸»è¦åŠŸèƒ½å°±å‰åºæ„é€ ã€å±‚æ¬¡æ„é€ ã€äº¤æ¢èŠ‚ç‚¹ã€æŸ¥æ‰¾å…³é”®å­—ã€é‡æ–°æ„å»ºè¿™å‡ ä¸ªï¼Œæ‰€ä»¥ä¸ºäº†å›¾ä¾¿æ·ï¼Œå°±ç›´æ¥åœ¨Qtæä¾›çš„uiç•Œé¢ä¸ŠåŠ ä¸Šè¿™å‡ ä¸ªèœå•é¡¹ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾</li>
</ol>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æ•°æ®ç»“æ„/QTbinarytree2.png" alt="QTbinarytree2"></p>
<ol>
<li><p>äºŒå‰æ ‘æ ¹æ®å‰åºç”Ÿæˆä¸€é¢—æ ‘ã€‚ç¼–å†™äº†ä¸€ä¸ªå‡½æ•°CreateBinTreeï¼Œåˆ©ç”¨é€’å½’è¿›è¡ŒäºŒå‰æ ‘çš„ç”Ÿæˆã€‚æ€è·¯ä¹Ÿæ¯”è¾ƒç®€å•å¯ä»¥çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‰åºåˆ›é€ èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">//iä»£è¡¨ç¬¬å‡ ä¸ªå­—æ¯</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BinaryTree::CreateBinTree</span><span class="params">(QString &amp;str, BinTreeNode *&amp;Node,<span class="type">int</span> &amp;i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//  qDebug()&lt;&lt;str;</span></span><br><span class="line"><span class="keyword">if</span>(str[i]!=<span class="string">&#x27;#&#x27;</span>)<span class="comment">//è¯´æ˜ä¸æ˜¯ç©ºç»“ç‚¹</span></span><br><span class="line">&#123;</span><br><span class="line">   Node=<span class="keyword">new</span> <span class="built_in">BinTreeNode</span>(str[i]);</span><br><span class="line">   Treesize++;</span><br><span class="line">   i++;</span><br><span class="line">   <span class="keyword">this</span>-&gt;<span class="built_in">CreateBinTree</span>(str,Node-&gt;left,i);</span><br><span class="line">   <span class="keyword">this</span>-&gt;<span class="built_in">CreateBinTree</span>(str,Node-&gt;right,i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">   i++;</span><br><span class="line">   Node=<span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>äºŒå‰æ ‘çš„å±‚æ¬¡éå†ç”Ÿæˆä¸€é¢—äºŒå‰æ ‘ã€‚è¿™ä¸ªåˆ©ç”¨é˜Ÿåˆ—æ¥å®Œæˆï¼Œåˆ©ç”¨é˜Ÿåˆ—éå†å­—ç¬¦ä¸²ï¼Œå…ˆå°†å­—ç¬¦ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦å¡è¿›é˜Ÿåˆ—ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œç„¶åæŒ‰é¡ºåºéå†å­—ç¬¦ä¸²å¹¶ä¸”åˆ›å»ºå¯¹åº”çš„å­©å­èŠ‚ç‚¹ï¼Œå…·ä½“å¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> j=<span class="number">0</span>;</span><br><span class="line">    Treesize=<span class="number">0</span>;</span><br><span class="line">    QQueue&lt;BinTreeNode *&gt;Q;</span><br><span class="line">    BinTreeNode *p=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span>(str[j]==<span class="string">&#x27;#&#x27;</span>)   <span class="comment">//å…ˆåˆ›å»ºæ ¹èŠ‚ç‚¹</span></span><br><span class="line">    &#123;</span><br><span class="line">        Treesize=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    root=<span class="keyword">new</span> <span class="built_in">BinTreeNode</span>(str[j]);</span><br><span class="line">    Treesize++;</span><br><span class="line">    Q.<span class="built_in">enqueue</span>(root);</span><br><span class="line">    j++;</span><br><span class="line"><span class="keyword">while</span>(j&lt;(str.<span class="built_in">size</span>()<span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">if</span>(Q.<span class="built_in">isEmpty</span>())</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">else</span></span><br><span class="line">            p=Q.<span class="built_in">dequeue</span>();</span><br><span class="line">			<span class="keyword">if</span>(str[j]!=<span class="string">&#x27;#&#x27;</span>)   <span class="comment">//å¦‚æœå­—ç¬¦ä¸ä¸ºâ€˜#â€™ï¼Œåˆ›å»ºå·¦ç»“ç‚¹</span></span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;left=<span class="keyword">new</span> <span class="built_in">BinTreeNode</span>(str[j]);</span><br><span class="line">            Treesize++;</span><br><span class="line">            Q.<span class="built_in">enqueue</span>(p-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">         j++;</span><br><span class="line">        <span class="keyword">if</span>(str[j]!=<span class="string">&#x27;#&#x27;</span>)   <span class="comment">//å¦‚æœå­—ç¬¦ä¸ä¸ºâ€˜#â€™ï¼Œåˆ›å»ºå³ç»“ç‚¹</span></span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;right=<span class="keyword">new</span> <span class="built_in">BinTreeNode</span>(str[j]);</span><br><span class="line">            Treesize++;</span><br><span class="line">            Q.<span class="built_in">enqueue</span>(p-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line">         j++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li>
<li>é€šè¿‡å‰åºå’Œä¸­åºå»ºæ ‘ã€‚å‰åºå’Œä¸­åºç¡®å®šæ ‘çš„é¡ºåºæ€æƒ³æ¯”è¾ƒç®€å•ï¼Œåˆ©ç”¨å‰åºçš„ç‰¹æ€§æ‰¾åˆ°çˆ¶èŠ‚ç‚¹ï¼Œç„¶ååˆ©ç”¨ä¸­åºç¡®å®šå·¦å³å­æ ‘ï¼Œç„¶åé‡å¤è¿™æ ·çš„è¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼Œå€Ÿé‰´ä¸€ä¸‹å°±è¡Œï¼Œçœ‹ä»¥å‰çš„ä»£ç è‡ªå·±éƒ½æƒ³åæ§½ã€‚<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å‰åºå’Œä¸­åºå»ºæ ‘</span></span><br><span class="line"><span class="comment">//preä»£è¡¨å‰åºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">//inä»£è¡¨ä¸­åºå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="comment">//nä»£è¡¨preå¯ä»¥åˆ°çš„ä½ç½®</span></span><br><span class="line"><span class="comment">//æµ‹è¯•ç”¨ä¾‹ï¼š å‰åºï¼š&quot;ABHFDECKG&quot;ï¼Œä¸­åºï¼š&quot;HBDFAEKCG&quot;</span></span><br><span class="line"><span class="function">BinTreeNode *<span class="title">BinaryTree::creatBinaryTree</span><span class="params">(QString pre, QString in, <span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">qDebug</span>()&lt;&lt;pre;</span><br><span class="line">  <span class="built_in">qDebug</span>()&lt;&lt;in;</span><br><span class="line">  <span class="keyword">if</span>(n==<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="type">int</span> k=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(pre[<span class="number">0</span>]!=in[k]&amp;&amp;k&lt;in.<span class="built_in">length</span>())k++;</span><br><span class="line">  <span class="keyword">if</span>(k&gt;=in.<span class="built_in">length</span>()) <span class="keyword">return</span> <span class="literal">nullptr</span>;  <span class="comment">//ç†è®ºä¸Šåº”è¯¥éœ€è¦æŠ›å‡ºå¼‚å¸¸çš„ï¼Œ</span></span><br><span class="line">  BinTreeNode *t=<span class="keyword">new</span> <span class="built_in">BinTreeNode</span>(pre[<span class="number">0</span>]);</span><br><span class="line">  <span class="comment">//ä»¥ä½ç½®kåˆ†ä¸ºå·¦å­æ ‘å’Œå³å­æ ‘</span></span><br><span class="line">  t-&gt;left=<span class="built_in">creatBinaryTree</span>(pre.<span class="built_in">mid</span>(<span class="number">1</span>),in,k);<span class="comment">//ä»0-kæ˜¯å·¦å­æ ‘ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œpreåªèƒ½éå†åˆ°k</span></span><br><span class="line">  t-&gt;right=<span class="built_in">creatBinaryTree</span>(pre.<span class="built_in">mid</span>(k<span class="number">+1</span>),in.<span class="built_in">mid</span>(k<span class="number">+1</span>),n-k<span class="number">-1</span>);</span><br><span class="line">  <span class="comment">//ç”±äºpreå’ŒinåŒæ—¶éƒ½åªä¿ç•™å³å­æ ‘éƒ¨åˆ†ï¼Œæ‰€ä»¥pre</span></span><br><span class="line">  <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ä¸Šé¢å»ºæ ‘çš„ä¾‹å­çœ‹çœ‹å°±è¡Œï¼Œå°¤å…¶æ˜¯æœ€åä¸€ä¸ªå‰ä¸­åºå»ºæ ‘ï¼Œä¹Ÿä¸çŸ¥é“è‡ªå·±å½“æ—¶æ˜¯æ€ä¹ˆå†™å‡ºè¿™ä¹ˆé­”æ€§çš„ä»£ç ã€‚ä¸‹é¢å°±ä¸“é—¨ä»‹ç»ä¸€ä¸‹ç”»äºŒå‰æ ‘çš„éƒ¨åˆ†ã€‚</p>
<h2 id="ä¸»è¦ç”»æ ‘æ€è·¯"><a href="#ä¸»è¦ç”»æ ‘æ€è·¯" class="headerlink" title="ä¸»è¦ç”»æ ‘æ€è·¯"></a>ä¸»è¦ç”»æ ‘æ€è·¯</h2><p> ç”»æ ‘æ˜¯åˆ©ç”¨äº†Qtçš„ç»˜å›¾äº‹ä»¶ï¼Œç›´æ¥è¿›è¡Œç”»å›¾ï¼Œç”»å›¾æ˜¯åœ¨å»ºæ ‘å·²ç»å®Œæˆçš„åŸºç¡€ä¹‹ä¸Šå®Œæˆçš„ã€‚<strong>æƒ³æ³•æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ç”»å‡ºæ¥çš„æ¯”è¾ƒéš¾çœ‹ï¼Œå…ˆåœ¨è¿™é‡Œè¯´æ˜ä¸€ä¸‹</strong>ã€‚</p>
<ol>
<li><p>äºŒå‰æ ‘çš„èŠ‚ç‚¹æ˜¯åœ†å½¢çš„ï¼ŒåŠå¾„ä¸º25ã€‚äºŒå‰æ ‘çš„å­èŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ä¹‹é—´xè½´ä¸Šç›¸å·®45ï¼Œyè½´ä¸Š100ã€‚ä¸¾ä¸ªä¾‹å­ï¼šçˆ¶èŠ‚ç‚¹çš„åæ ‡ä¸ºï¼ˆxï¼Œyï¼‰ï¼Œåˆ™å·¦å­©å­åæ ‡ä¸ºï¼ˆx-45ï¼Œy+100ï¼‰ï¼Œå³å­©å­åæ ‡ä¸ºï¼ˆx+45ï¼Œy+100ï¼‰ã€‚æ ¹èŠ‚ç‚¹çš„åæ ‡è®¾ç½®ä¸ºï¼ˆ500ï¼Œ75ï¼‰ï¼Œè¿™äº›æ•°æ®éƒ½å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ”¹ï¼Œä¸å®šæ­»ã€‚</p>
</li>
<li><p>æ•°æ®ç»“æ„è®¾è®¡çš„æ—¶å€™ï¼Œå¯¹äºäºŒå‰æ ‘çš„èŠ‚ç‚¹BinTreeNodeï¼Œè®¾è®¡ä¸€ä¸ªdataï¼ˆQCharç±»å‹ï¼Œç”¨äºå­˜å‚¨æ•°æ®ï¼‰ã€pointï¼ˆQPointç±»å‹ï¼Œç”¨äºå­˜å‚¨ä½ç½®ï¼‰</p>
</li>
<li><p>æ•°æ®ç»“æ„è®¾è®¡æ—¶ï¼Œå¯¹äºäºŒå‰æ ‘BinaryTreeï¼Œè®¾è®¡Mypointsï¼ˆQPoint <em>ç±»å‹ï¼Œå­˜å‚¨æ ‘å„ä¸ªç»“ç‚¹åæ ‡ï¼‰ã€My_linesï¼ˆ QLine </em>ç±»å‹ï¼Œå­˜å‚¨éœ€è¦ç”»çš„çº¿çš„æ¡æ•°ï¼‰</p>
</li>
<li><p>å†™ä¸€ä¸ªå‡½æ•°setMyPointsï¼Œé€šè¿‡å±‚æ¬¡éå†ï¼Œå®Œæˆå„ä¸ªåæ ‡çš„åŒ¹é…ã€‚å…¶ä¸­å¯¹äºMypointsç›´æ¥å­˜å‚¨èŠ‚ç‚¹çš„ä¸­å¿ƒï¼Œç„¶åç”»åœ†ï¼›å¯¹äºçº¿æ®µï¼Œä»ä¸Šé¢çš„ä¾‹å­ä¹Ÿçœ‹å¾—å‡ºæ¥æ˜¯çˆ¶èŠ‚ç‚¹çš„ä¸­å¿ƒå‘ä¸‹åŠå¾„ä¸ªä½ç½®ä½œä¸ºèµ·ç‚¹ï¼Œå­èŠ‚ç‚¹ä¸­å¿ƒå‘ä¸ŠåŠå¾„ä¸ªä½ç½®ä¸ºç»ˆç‚¹ã€‚å…·ä½“ä»£ç å¦‚ä¸‹æ‰€ç¤º</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ä¸ºåæ ‡ç»„è®¾ç½®åº”çš„åæ ‡,ä»¥åŠå¾—åˆ°ç›¸åº”çš„çº¿æ®µ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">BinaryTree::setMyPoints</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      <span class="comment">//è®¾ç½®çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹é—´æ¨ªåæ ‡ç›¸å·®çš„è·ç¦»</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//    int H=height();</span></span><br><span class="line">    Mypoints=<span class="keyword">new</span> QPoint[Treesize];  <span class="comment">//åŠ¨æ€åˆ†é…ç©ºé—´</span></span><br><span class="line">    My_lines=<span class="keyword">new</span> QLine[Treesize<span class="number">-1</span>];</span><br><span class="line"></span><br><span class="line">    QQueue&lt;BinTreeNode *&gt;Q;         <span class="comment">//è°ƒç”¨é˜Ÿåˆ—</span></span><br><span class="line">    BinTreeNode *p=root;</span><br><span class="line">    root-&gt;<span class="built_in">setpoint</span>(<span class="built_in">QPoint</span>(<span class="number">500</span>,<span class="number">75</span>));  <span class="comment">//ä¸ºæ ¹èŠ‚ç‚¹è®¾ç½®åæ ‡</span></span><br><span class="line">    Q.<span class="built_in">enqueue</span>(root);</span><br><span class="line">    Mypoints[i]=root-&gt;point;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é€šè¿‡å±‚æ¬¡éå†ï¼Œå®Œæˆå„ä¸ªåæ ‡çš„åŒ¹é…</span></span><br><span class="line">    <span class="keyword">while</span>(!Q.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        p=Q.<span class="built_in">dequeue</span>();</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;left!=<span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="type">int</span> h=<span class="built_in">height</span>(p);</span><br><span class="line">            p-&gt;left-&gt;<span class="built_in">setpoint</span>(p-&gt;point-<span class="built_in">QPoint</span>(<span class="number">45</span>*h,<span class="number">-100</span>));</span><br><span class="line">            Mypoints[i]=p-&gt;left-&gt;point;</span><br><span class="line">            My_lines[i<span class="number">-1</span>].<span class="built_in">setP1</span>(p-&gt;point+<span class="built_in">QPoint</span>(<span class="number">0</span>,<span class="number">25</span>));<span class="comment">//çº¿</span></span><br><span class="line">            My_lines[i<span class="number">-1</span>].<span class="built_in">setP2</span>(p-&gt;left-&gt;point-<span class="built_in">QPoint</span>(<span class="number">0</span>,<span class="number">25</span>));</span><br><span class="line">            Q.<span class="built_in">enqueue</span>(p-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(p-&gt;right!=<span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="type">int</span> h=<span class="built_in">height</span>(p);</span><br><span class="line">            p-&gt;right-&gt;<span class="built_in">setpoint</span>(p-&gt;point+<span class="built_in">QPoint</span>(<span class="number">45</span>*h,<span class="number">100</span>));</span><br><span class="line">            Mypoints[i]=p-&gt;right-&gt;point;</span><br><span class="line">            My_lines[i<span class="number">-1</span>].<span class="built_in">setP1</span>(p-&gt;point+<span class="built_in">QPoint</span>(<span class="number">0</span>,<span class="number">25</span>));</span><br><span class="line">            My_lines[i<span class="number">-1</span>].<span class="built_in">setP2</span>(p-&gt;right-&gt;point-<span class="built_in">QPoint</span>(<span class="number">0</span>,<span class="number">25</span>));</span><br><span class="line">            Q.<span class="built_in">enqueue</span>(p-&gt;right);</span><br><span class="line">            h--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>å¯¹äºå·¦ä¾§æ˜¾ç¤ºçš„å­—ç¬¦ï¼Œè¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥åœ¨å»ºæ ‘ä¹‹åè¿›è¡Œç›¸å¯¹åº”çš„å‰åºã€ä¸­åºã€åç»­ã€å±‚æ¬¡éå†ï¼Œç„¶åå°†å­—ç¬¦ä¸²ä¿å­˜ä¸‹æ¥å³å¯ï¼Œåœ¨è¿™é‡Œå°±ä¸å±•å¼€è¯¦ç»†è®²è§£</li>
</ol>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ç”»äºŒå‰æ ‘çš„æ€æƒ³æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥ç”»å‡ºæ¥ä¹Ÿä¸æ˜¯å¾ˆå¥½çœ‹ï¼Œä»£ç è™½ç„¶å¯ä»¥è¿è¡Œï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å°ç»†èŠ‚ä¸Šçš„é—®é¢˜ï¼Œå¦‚æœæœ‰ä»€ä¹ˆæ›´å¥½çš„æ„è§æ¬¢è¿æŒ‡æ•™ã€‚</p>
<p><a href="https://github.com/bugcat9/Qtbinarytree.git">æºç ä¼ è¾“é—¨</a></p>
]]></content>
      <categories>
        <category>æ•°æ®ç»“æ„</category>
      </categories>
      <tags>
        <tag>äºŒå‰æ ‘</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¥ç»ç½‘ç»œ</title>
    <url>/2021/05/20/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/</url>
    <content><![CDATA[<h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><blockquote>
<p>åœ¨æœºå™¨å­¦ä¹ çš„åŸºç¡€çŸ¥è¯†å­¦ä¹ è¿‡ç¨‹å½“ä¸­ï¼Œå­¦ä¹ äº†ä¸€ä¸‹ç¥ç»ç½‘ç»œï¼Œç„¶åå°±æœºå™¨å­¦ä¹ æ–¹é¢çš„ç¥ç»ç½‘ç»œå’Œå·ç§¯ç¥ç»ç½‘ç»œæ–¹é¢å†™ä¸€ä¸‹è‡ªå·±çš„ä¸ªäººç†è§£ï¼Œé¡ºä¾¿æ€»ç»“ä¸€ä¸‹ã€‚</p>
</blockquote>
<h2 id="ç¥ç»ç½‘ç»œ"><a href="#ç¥ç»ç½‘ç»œ" class="headerlink" title="ç¥ç»ç½‘ç»œ"></a>ç¥ç»ç½‘ç»œ</h2><h3 id="ä¸€ã€ç¥ç»å…ƒæ¨¡å‹"><a href="#ä¸€ã€ç¥ç»å…ƒæ¨¡å‹" class="headerlink" title="ä¸€ã€ç¥ç»å…ƒæ¨¡å‹"></a>ä¸€ã€ç¥ç»å…ƒæ¨¡å‹</h3><p>ç¥ç»å…ƒæ˜¯ç¥ç»ç½‘ç»œå½“ä¸­æœ€åŸºæœ¬çš„æ¨¡å‹ã€‚åœ¨ç”Ÿç‰©ç¥ç»ç½‘ç»œä¸­æ¯ä¸ªç¥ç»å…ƒä¸å…¶ä»–ç¥ç»å…ƒç›¸è¿ï¼Œå½“å®ƒâ€œå…´å¥‹â€æ—¶ï¼Œå°±ä¼šå‘ç›¸è¿çš„ç¥ç»å…ƒå‘é€åŒ–å­¦ç‰©è´¨ï¼Œä»è€Œæ”¹å˜å…¶ä»–ç¥ç»å…ƒå†…çš„ç”µä½;å¦‚æœè¿™äº›ç¥ç»å…ƒçš„ç”µä½è¶…è¿‡äº† ä¸ªâ€œé˜”å€¼â€ ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šè¢«æ¿€æ´» â€œå…´å¥‹â€œèµ·æ¥ï¼Œä¹ŸåŒæ ·ä¼šå‘å…¶ä»–ç¥ç»å…ƒå‘é€åŒ–å­¦ç‰©è´¨ã€‚<br><span id="more"></span><br>â€‹    åœ¨æœºå™¨å­¦ä¹ å½“ä¸­ï¼Œäººä»¬å°†è¿™ä¸ªæ¨¡å‹æŠ½è±¡å‡ºæ¥ï¼Œå°±äº§ç”Ÿäº†æœºå™¨å­¦ä¹ å½“ä¸­çš„<strong>ç¥ç»å…ƒæ¨¡å‹</strong>ï¼Œå¦‚ä¸‹å›¾ï¼Œ$x<em>i$å°±æ˜¯å…¶ä»–ç¥ç»å…ƒçš„è¾“å…¥ï¼ˆç›¸å½“äºç¥ç»ç‰©è´¨ï¼‰ï¼Œ$\omega_i$ä¸ºæƒå€¼ï¼Œç¥ç»ç½‘ç»œä¸»è¦å­¦ä¹ çš„å°±æ˜¯è¿™ä¸ªæƒå€¼ï¼Œ$ \theta $ä¸ºå¯¹åº”çš„é˜ˆå€¼ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼å°±å‘å…¶ä»–ç¥ç»å…ƒå‘é€åŒ–å­¦ç‰©è´¨ï¼Œè€Œè¿™ä¸ª$f$æ˜¯æ¿€æ´»å‡½æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å‘é€åŒ–å­¦ç‰©è´¨ï¼Œäº§ç”Ÿçš„å€¼ä¸º0æˆ–è€…1ï¼ˆ0ä¸å‘é€ï¼Œ1å°±å‘é€ï¼‰,$f$å¯ä»¥ç†è§£ä¸ºè¾“å…¥$\sum</em>{i=1}^{n}\omega_ix_i-\theta$è¾“å‡º0æˆ–è€…1çš„å‡½æ•°ã€‚</p>
<p>â€‹    æ‰€æœ‰ä¸€ä¸ªç¥ç»å…ƒçš„è¾“å…¥ä¸º$x_i$,è¾“å‡ºä¸º0æˆ–è€…1ï¼ˆä¸ªäººè®¤ä¸ºå¯ä»¥ç®€å•è¿™æ ·ç†è§£ï¼‰ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
y=f(\sum_{i=1}^{n}\omega_ix_i-\theta)</script><p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ1.png" alt="ç¥ç»ç½‘ç»œ1" style="zoom:80%;" /></p>
<p><strong>ç›¸å…³è¶£äº‹</strong>ï¼š</p>
<blockquote>
<p>1943å¹´ï¼Œå¿ƒç†å­¦å®¶McCullochå’Œæ•°å­¦å®¶Pittså‚è€ƒäº†ç”Ÿç‰©ç¥ç»å…ƒçš„ç»“æ„ï¼Œå‘è¡¨äº†æŠ½è±¡çš„ç¥ç»å…ƒæ¨¡å‹MPï¼Œ1943å¹´å‘å¸ƒçš„MPæ¨¡å‹ï¼Œè™½ç„¶ç®€å•ï¼Œä½†å·²ç»å»ºç«‹äº†ç¥ç»ç½‘ç»œå¤§å¦çš„åœ°åŸºã€‚ä½†æ˜¯ï¼ŒMPæ¨¡å‹ä¸­ï¼Œæƒé‡çš„å€¼éƒ½æ˜¯é¢„å…ˆè®¾ç½®çš„ï¼Œå› æ­¤ä¸èƒ½å­¦ä¹ ã€‚1949å¹´å¿ƒç†å­¦å®¶Hebbæå‡ºäº†Hebbå­¦ä¹ ç‡ï¼Œè®¤ä¸ºäººè„‘ç¥ç»ç»†èƒçš„çªè§¦ï¼ˆä¹Ÿå°±æ˜¯è¿æ¥ï¼‰ä¸Šçš„å¼ºåº¦ä¸Šå¯ä»¥å˜åŒ–çš„ã€‚äºæ˜¯è®¡ç®—ç§‘å­¦å®¶ä»¬å¼€å§‹è€ƒè™‘ç”¨è°ƒæ•´æƒå€¼çš„æ–¹æ³•æ¥è®©æœºå™¨å­¦ä¹ ã€‚è¿™ä¸ºåé¢çš„å­¦ä¹ ç®—æ³•å¥ å®šäº†åŸºç¡€ã€‚</p>
</blockquote>
<h3 id="äºŒã€æ¿€æ´»å‡½æ•°"><a href="#äºŒã€æ¿€æ´»å‡½æ•°" class="headerlink" title="äºŒã€æ¿€æ´»å‡½æ•°"></a>äºŒã€æ¿€æ´»å‡½æ•°</h3><pre><code>     ç¥ç»å…ƒæœ€ç»ˆæ˜¯é€šè¿‡æ¿€æ´»å‡½æ•°çš„å¤„ç†äº§ç”Ÿç¥ç»å…ƒçš„è¾“å‡º,æœ€å¼€å§‹çš„æ—¶å€™æ¿€æ´»å‡½æ•°çš„æ¨¡å‹ä¸º$sgn(x)$(å¦‚ä¸‹å›¾aï¼Œå…¶å®åœ¨æ•°å­¦è¯¾ä¸Šè§è¿‡å¾ˆå¤šæ¬¡è¿™ä¸ªå‡½æ•°)ï¼Œåˆšå¥½ç¬¦åˆæˆ‘ä»¬çš„è¦æ±‚ï¼Œå½“$(\sum_&#123;i=1&#125;^&#123;n&#125;\omega_ix_i-\theta)&gt;0$æ—¶ï¼Œè¾“å‡º1å¦åˆ™è¾“å‡º0ã€‚å¯æ˜¯è¿™ä¸ªå‡½æ•°çš„ç¼ºç‚¹æ˜¯ä¸å¯å¯¼ï¼Œè¿™åœ¨æ•°å­¦ä¸Šæ€§è´¨å°±å¾ˆä¸å¥½ï¼Œæ‰€ä»¥äººä»¬å°±ç”¨å¦å¤–ä¸€ä¸ªæ€§è´¨ä¼˜ç§€çš„å‡½æ•°ä»£æ›¿äº†å®ƒï¼Œå°±æ˜¯$sigmoid(x)$å‡½æ•°ï¼ˆå¦‚ä¸‹å›¾bï¼Œè®°ä½è¿™ä¸ªå‡½æ•°åé¢ä¼šç”¨åˆ°ï¼‰ã€‚
</code></pre><p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ2.png" alt="ç¥ç»ç½‘ç»œ2" style="zoom:80%;" /></p>
<p>â€‹        é™¤äº†è¿™ä¸¤ä¸ªå‡½æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–çš„å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œå¦‚ï¼š$tanh:f(x)=tanh(x)ã€ReLUï¼šf(x)=max(x,0)ã€softmax:f(x)=log(1+exp(x))$</p>
<h3 id="ä¸‰ã€æ„ŸçŸ¥æœº"><a href="#ä¸‰ã€æ„ŸçŸ¥æœº" class="headerlink" title="ä¸‰ã€æ„ŸçŸ¥æœº"></a>ä¸‰ã€æ„ŸçŸ¥æœº</h3><p>â€‹        ç”±äºä¸€ä¸ªç¥ç»å…ƒçš„åŠŸèƒ½å¤ªè¿‡é¸¡è‚‹ï¼Œæ‰€ä»¥åœ¨1958å¹´ï¼Œè®¡ç®—ç§‘å­¦å®¶Rosenblattæå‡ºäº†æå‡ºäº†ä¸¤å±‚ç¥ç»å…ƒç»„æˆçš„ç¥ç»ç½‘ç»œï¼Œå–åä¸ºâ€œæ„ŸçŸ¥æœºâ€ã€‚</p>
<p>â€‹        æ„ŸçŸ¥æœºç”±ä¸¤å±‚ç¥ç»å…ƒç»„æˆï¼Œè¾“å…¥å±‚æ¥æ”¶å¤–ç•Œè¾“å…¥ä¿¡æ¯åä¼ ç»™è¾“å‡ºå±‚ï¼Œè¾“å‡ºå±‚æ˜¯M-Pç¥ç»å…ƒã€‚æ„ŸçŸ¥å™¨æ˜¯å½“æ—¶é¦–ä¸ªå¯ä»¥å­¦ä¹ çš„äººå·¥ç¥ç»ç½‘ç»œï¼Œå½“æ—¶Rosenblattç°åœºæ¼”ç¤ºäº†å…¶å­¦ä¹ è¯†åˆ«ç®€å•å›¾åƒçš„è¿‡ç¨‹ï¼Œåœ¨å½“æ—¶çš„ç¤¾ä¼šå¼•èµ·äº†è½°åŠ¨ã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ3.png" alt="ç¥ç»ç½‘ç»œ3" style="zoom:80%;" /></p>
<p>â€‹        æ„ŸçŸ¥æœºå¯ä»¥è§£å†³çº¿æ€§é—®é¢˜ï¼Œå¦‚ï¼š</p>
<ol>
<li>â€œä¸â€é—®é¢˜($x_1$^$x_2$)ï¼Œä»¤å‚æ•°$\omega_1=1,\omega_2=1,\theta=2$,åˆ™æœ‰$y=f(1<em>x_1+1</em>x_2-2)$,å½“ä¸”ä»…å½“$x_1=x_2=1$æ—¶ï¼Œæ‰æœ‰$y=1$</li>
<li>â€œæˆ–â€é—®é¢˜($x_1$||$x_2$)ï¼Œä»¤å‚æ•°$\omega_1=1,\omega_2=1,\theta=0.5$,åˆ™æœ‰$y=f(1<em>x_1+1</em>x_2-0.5)$,å½“ä¸”ä»…å½“$x_1=1æˆ–è€…x_2=1$æ—¶ï¼Œæœ‰$y=1$</li>
<li>â€œéé—®é¢˜â€(~$x_1$)ï¼Œä»¤å‚æ•°$\omega_1=-0.6,\omega_2=0,\theta=-0.5$,åˆ™æœ‰$y=f(-0.6<em>x_1+0</em>x_2+0.5)$,å½“$x_1=1,y=0$;å½“$x_1=0,y=1$</li>
</ol>
<p>æ„ŸçŸ¥æœºå¯ä»¥è§£å†³çº¿æ€§é—®é¢˜ï¼Œå¯ä»¥è¿™ä¹Ÿç†è§£ï¼Œçœ‹ä¸‹å›¾</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ4.png" alt="ç¥ç»ç½‘ç»œ4" style="zoom: 80%;" /></p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ5.png" alt="ç¥ç»ç½‘ç»œ5" style="zoom:80%;" /></p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ6.png" alt="ç¥ç»ç½‘ç»œ6" style="zoom:80%;" /></p>
<p>å¯ä»¥å‘ç°$z=g(\omega_{i,j}*a_i)$,æ˜¯ä»¥çŸ©é˜µå½¢å¼å‘ˆç°çš„ï¼Œå’Œæœºå™¨å­¦ä¹ å‰é¢å­¦çš„çº¿æ€§æ¨¡å‹çš„è¡¨è¾¾å¼ä¸€æ ·ï¼Œæ‰€ä»¥æ„ŸçŸ¥æœºå…¶å®å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªçº¿æ€§æ¨¡å‹ã€‚</p>
<p><strong>ç›¸å…³å†å²è¶£äº‹</strong>ï¼š</p>
<blockquote>
<p>â€‹        1958å¹´ï¼Œè®¡ç®—ç§‘å­¦å®¶Rosenblattæå‡ºäº†ç”±ä¸¤å±‚ç¥ç»å…ƒç»„æˆçš„ç¥ç»ç½‘ç»œã€‚ä»–ç»™å®ƒèµ·äº†ä¸€ä¸ªåå­—:â€œæ„ŸçŸ¥å™¨â€ï¼ˆPerceptronï¼‰ï¼ˆæœ‰çš„æ–‡çŒ®ç¿»è¯‘æˆâ€œæ„ŸçŸ¥æœºâ€ï¼‰ã€‚</p>
<p>æ„ŸçŸ¥å™¨æ˜¯å½“æ—¶é¦–ä¸ªå¯ä»¥å­¦ä¹ çš„äººå·¥ç¥ç»ç½‘ç»œã€‚Rosenblattç°åœºæ¼”ç¤ºäº†å…¶å­¦ä¹ è¯†åˆ«ç®€å•å›¾åƒçš„è¿‡ç¨‹ï¼Œåœ¨å½“æ—¶çš„ç¤¾ä¼šå¼•èµ·äº†è½°åŠ¨ã€‚äººä»¬è®¤ä¸ºå·²ç»å‘ç°äº†æ™ºèƒ½çš„å¥¥ç§˜ï¼Œè®¸å¤šå­¦è€…å’Œç§‘ç ”æœºæ„çº·çº·æŠ•å…¥åˆ°ç¥ç»ç½‘ç»œçš„ç ”ç©¶ä¸­ã€‚ç¾å›½å†›æ–¹å¤§åŠ›èµ„åŠ©äº†ç¥ç»ç½‘ç»œçš„ç ”ç©¶ï¼Œå¹¶è®¤ä¸ºç¥ç»ç½‘ç»œæ¯”â€œåŸå­å¼¹å·¥ç¨‹â€æ›´é‡è¦ã€‚è¿™æ®µæ—¶é—´ç›´åˆ°1969å¹´æ‰ç»“æŸï¼Œè¿™ä¸ªæ—¶æœŸå¯ä»¥çœ‹ä½œç¥ç»ç½‘ç»œçš„ç¬¬ä¸€æ¬¡é«˜æ½®ã€‚</p>
<p>â€‹        ä½†æ˜¯ï¼ŒMinskyåœ¨1969å¹´å‡ºç‰ˆäº†ä¸€æœ¬å«ã€ŠPerceptronã€‹çš„ä¹¦ï¼Œé‡Œé¢ç”¨è¯¦ç»†çš„æ•°å­¦è¯æ˜äº†æ„ŸçŸ¥å™¨çš„å¼±ç‚¹ï¼Œå°¤å…¶æ˜¯æ„ŸçŸ¥å™¨å¯¹XORï¼ˆå¼‚æˆ–ï¼‰è¿™æ ·çš„ç®€å•åˆ†ç±»ä»»åŠ¡éƒ½æ— æ³•è§£å†³ã€‚ç”±äºMinskyçš„å·¨å¤§å½±å“åŠ›ä»¥åŠä¹¦ä¸­å‘ˆç°çš„æ‚²è§‚æ€åº¦ï¼Œè®©å¾ˆå¤šå­¦è€…å’Œå®éªŒå®¤çº·çº·æ”¾å¼ƒäº†ç¥ç»ç½‘ç»œçš„ç ”ç©¶ã€‚ç¥ç»ç½‘ç»œçš„ç ”ç©¶é™·å…¥äº†å†°æ²³æœŸã€‚è¿™ä¸ªæ—¶æœŸåˆè¢«ç§°ä¸ºâ€œAI winterâ€ã€‚æ¥è¿‘10å¹´ä»¥åï¼Œå¯¹äºä¸¤å±‚ç¥ç»ç½‘ç»œçš„ç ”ç©¶æ‰å¸¦æ¥ç¥ç»ç½‘ç»œçš„å¤è‹ã€‚</p>
</blockquote>
<h3 id="å››ã€å¤šå±‚ç¥ç»ç½‘ç»œå’ŒBPç®—æ³•"><a href="#å››ã€å¤šå±‚ç¥ç»ç½‘ç»œå’ŒBPç®—æ³•" class="headerlink" title="å››ã€å¤šå±‚ç¥ç»ç½‘ç»œå’ŒBPç®—æ³•"></a>å››ã€å¤šå±‚ç¥ç»ç½‘ç»œå’ŒBPç®—æ³•</h3><h4 id="1-å¤šå±‚ç¥ç»ç½‘ç»œ"><a href="#1-å¤šå±‚ç¥ç»ç½‘ç»œ" class="headerlink" title="1.å¤šå±‚ç¥ç»ç½‘ç»œ"></a>1.å¤šå±‚ç¥ç»ç½‘ç»œ</h4><p>â€‹        ç”±äºæ„ŸçŸ¥æœºå¯¹éçº¿æ€§é—®é¢˜çš„ä¹åŠ›ï¼Œä¸ºäº†è§£å†³éçº¿æ€§é—®é¢˜ï¼Œå°±æå‡ºäº†å¤šå±‚ç¥ç»ç½‘ç»œã€‚å¤šå±‚ç¥ç»ç½‘ç»œï¼šè¾“å…¥å±‚å’Œè¾“å‡ºå±‚ä¹‹é—´åŠ ä¸€å±‚ç¥ç»å…ƒï¼ˆéšå«å±‚ï¼‰ï¼Œéšå«å±‚å’Œè¾“å‡ºå±‚ç¥ç»å…ƒéƒ½æ‹¥æœ‰æ¿€æ´»å‡½æ•°çš„åŠŸèƒ½ç¥ç»å…ƒï¼Œå¹¶ä¸”æœ‰ç†è®ºè¯æ˜ï¼Œä¸¤å±‚ç¥ç»ç½‘ç»œå¯ä»¥æ— é™é€¼è¿‘ä»»æ„è¿ç»­å‡½æ•°ã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ7.png" alt="ç¥ç»ç½‘ç»œ7" style="zoom:80%;" /></p>
<p>â€‹        å‡ºç°å¤šå±‚ç¥ç»ç½‘ç»œçš„åŸå› æ˜¯è¯¯å·®é€†ä¼ æ’­ç®—æ³•çš„å‡ºç°ã€‚è¯¯å·®ä¼ æ’­ç®—æ³•ï¼ˆerror BackPropagation,ç®€ç§°BPï¼‰ç®—æ³•ï¼Œè¢«æˆä¸ºè¿„ä»Šä¸ºæ­¢æœ€æˆåŠŸçš„ç¥ç»ç½‘ç»œç®—æ³•ï¼Œåœ¨ç°å®ä»»åŠ¡ä¸­ä½¿ç”¨ç¥ç»ç½‘ç»œæ—¶ï¼Œå¤§å¤šæ•°æ—¶åœ¨ä½¿ç”¨BPç®—æ³•è¿›è¡Œè®­ç»ƒã€‚</p>
<h4 id="2-BPç®—æ³•"><a href="#2-BPç®—æ³•" class="headerlink" title="2.BPç®—æ³•"></a>2.BPç®—æ³•</h4><p>ç»™å®šè®­ç»ƒé›†$D=\left{(x_1,y_1),(x_2,y_2),â€¦,(x_m,y_m)\right},x_i\in R^d,y_i\in R^d$</p>
<p>å‡è®¾ä¸€ä¸ªç¥ç»ç½‘ç»œæœ‰$d$ä¸ªè¾“å…¥ç¥ç»å…ƒã€$l$ä¸ªè¾“å‡ºç¥ç»å…ƒï¼Œ$q$ä¸ªéšå«ç¥ç»å…ƒ(å¯ä»¥å‚è€ƒä¸‹å›¾)</p>
<p>è®¾è¾“å‡ºå±‚ç¬¬$j$ä¸ªç¥ç»å…ƒçš„é˜ˆå€¼ç”¨$\theta_i$è¡¨ç¤ºï¼Œéšå«å±‚ç¬¬$h$ä¸ªç¥ç»å…ƒé˜ˆå€¼ç”¨$\gamma_h$è¡¨ç¤º</p>
<p>è¾“å…¥å±‚ç¬¬$i$ä¸ªç¥ç»å…ƒå’Œéšå«å±‚ç¬¬$h$ä¸ªç¥ç»å…ƒä¹‹é—´æƒé‡ä¸º$\upsilon<em>{ih}$;éšå«å±‚ç¬¬$h$ä¸ªç¥ç»å…ƒå’Œè¾“å‡ºå±‚ç¬¬$j$ä¸ªç¥ç»å…ƒä¹‹é—´æƒé‡ä¸º$\omega</em>{hj}$</p>
<p>è®°éšå«å±‚ç¬¬$h$ä¸ªç¥ç»å…ƒçš„è¾“å…¥ä¸º$\alpha<em>h=\sum</em>{i=1}^{d}{\upsilon<em>{ih}x_i}$;è¾“å‡ºå±‚ç¬¬$j$ä¸ªç¥ç»å…ƒæ¥æ”¶çš„è¾“å…¥ä¸º$\beta_j=\sum</em>{h=1}^{q}{\omega_{hj}b_h}$ï¼ˆå…¶ä¸­$b_h$ä¸ºéšå«å±‚ç¬¬$h$ä¸ªç¥ç»å…ƒçš„è¾“å‡ºï¼‰</p>
<p>ç„¶åå‡è®¾éšè—å±‚å’Œè¾“å‡ºå±‚éƒ½ä½¿ç”¨$sigmoid(x)$å‡½æ•°ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œå› ä¸ºè¯¥å‡½æ•°æœ‰å¯å¯¼çš„æ€§è´¨ï¼Œè¯¥å‡½æ•°çš„å¯¼æ•°ä¸º$f\prime(x)=f(x)(1-f(x))$</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ8.png" alt="ç¥ç»ç½‘ç»œ8" style="zoom:80%;" /></p>
<p>å¯¹äºå…¶ä¸­çš„è®­ç»ƒä¾‹å­$(x_k,y_k)$,å‡è®¾ç¥ç»ç½‘ç»œçš„è¾“å‡ºä¸º$\hat y_k=(\hat y_1^k,\hat y_2^k,â€¦,\hat y_l^k)$,å³$\hat y_l^k=f(\beta_j-\theta_j)$</p>
<p>å¯ä»¥å¾—åˆ°å‡æ–¹è¯¯å·®$E_k=\frac{1}{2}(\hat y^k_j-y^k_j)^2$,å¹¶ä¸”æœ‰$(d+l+1)*q+l$ä¸ªå‚æ•°éœ€è¦ç¡®å®šã€‚</p>
<p>ä»¥å…¶ä¸­æƒé‡å‚æ•°$\omega<em>{hj}$ä¸ºä¾‹ï¼Œå®ƒçš„æ›´æ–°ä¼°è®¡å¼ï¼š$\omega\leftarrow\omega+\Delta\omega$,å…¶ä¸­$\Delta\omega=-\eta\frac{ \partial E_k}{\partial \omega</em>{hj}}$ï¼ˆå°±æ˜¯æ±‚åå¯¼ï¼Œå…¶ä¸­$\eta$ä¸ºå­¦ä¹ ç‡ï¼‰</p>
<p>å¼å­ï¼š$\frac{ \partial E<em>k}{\partial \omega</em>{hj}}=\frac{\partial E<em>k}{\partial \hat y^k_j}\cdot\frac{\partial \hat y^k_j}{\partial \beta_j}\cdot\frac{\partial \beta_j}{\partial \omega</em>{hj}}$</p>
<p>å¯ä»¥çŸ¥é“$\frac{\partial \beta<em>j}{\partial  \omega</em>{hj}}=b_h$,ç„¶åè®¾</p>
<script type="math/tex; mode=display">
g_i=\frac{\partial E_k}{\partial  \hat y^k_j}\cdot\frac{\partial  \hat y^k_j}{\partial  \beta_j}</script><p>ç”±äº$E_k=\frac{1}{2}(\hat y^k_j-y^k_j)^2$ä»¥åŠ$\hat y_l^k=f(\beta_j-\theta_j)$ï¼Œæ‰€ä»¥æœ‰</p>
<script type="math/tex; mode=display">
g_i=(\hat y^k_j-y^k_j)\cdot f\prime(\beta_j-\theta_j)</script><p>å†ç”±æ¿€æ´»å‡½æ•°$f(x)$ä¸º$sigmoid(x)$å‡½æ•°ï¼Œæ‰€ä»¥å¯¼æ•°$f\prime(x)=f(x)(1-f(x))$ï¼Œåˆ™ï¼š</p>
<script type="math/tex; mode=display">
g_i=\hat y^k_j(1-\hat y^k_j)(y^k_j-\hat y^k_j)</script><p>è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†</p>
<script type="math/tex; mode=display">
\Delta\omega=\eta g_ib_h</script><p>åŒç†æˆ‘ä»¬å¯ä»¥å¾—åˆ°å…¶ä»–çš„å‚æ•°å€¼ï¼Œå¦‚ï¼š$\Delta \theta<em>j=-\eta g_i$ã€$\Delta \upsilon</em>{ih}=\eta e<em>h x_i$ã€$\Delta \gamma_h=-\eta e_h$,å…¶ä¸­$e_h=b_h(1-b_h)\sum</em>{j=1}^{l}{\omega_{hj}gi}$</p>
<p>ä¸Šé¢åªæ˜¯ç®€å•çš„è¯´æ˜äº†ä¸€ä¸‹åœ¨ç¥ç»ç½‘ç»œè¿‡ç¨‹ä¸­ï¼Œå‚æ•°å¤§æ¦‚æ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ï¼Œåœ¨æ­£çœŸçš„ç¼–ç¨‹çš„æ—¶å€™å…¶å®è¿™äº›è¿‡ç¨‹éƒ½ä¸éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œä¸€èˆ¬çš„æ·±åº¦å­¦ä¹ æ¡†æ¶éƒ½å¸®æˆ‘ä»¬å®ç°äº†ã€‚</p>
<h4 id="3-è¿‡æ‹Ÿåˆé—®é¢˜"><a href="#3-è¿‡æ‹Ÿåˆé—®é¢˜" class="headerlink" title="3.è¿‡æ‹Ÿåˆé—®é¢˜"></a>3.è¿‡æ‹Ÿåˆé—®é¢˜</h4><p>ç”±äºç¥ç»ç½‘ç»œå¼ºå¤§çš„è¡¨ç¤ºèƒ½åŠ›ï¼Œç»å¸¸ä¼šå‡ºç°è¿‡æ‹Ÿåˆé—®é¢˜ï¼Œä¸€èˆ¬è§£å†³æ–¹æ³•ç”±ä¸¤ç§ï¼š</p>
<ul>
<li><p>â€œæ—©åœâ€ï¼šå°†æ•°æ®åˆ†ä¸ºè®­ç»ƒé›†å’ŒéªŒè¯é›†ï¼Œè®­ç»ƒé›†è®¡ç®—æ¢¯åº¦ã€æ›´æ–°æƒå€¼å’Œé˜ˆå€¼ï¼ŒéªŒè¯é›†ç”¨æ¥ä¼°è®¡è¯¯å·®</p>
</li>
<li><p>â€œæ­£åˆ™åŒ–â€ï¼šå…¶æ€æƒ³æ˜¯åœ¨è¯¯å·®ç›®æ ‡å‡½æ•°ä¸­å¢åŠ ä¸€ä¸ªç”¨äºæè¿°ç½‘è·¯å¤ç‚¸ç¨‹åº¦çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚è¿æ¥æƒå€¼å’Œé˜ˆå€¼çš„å¹³æ–¹å’Œï¼Œå¦‚ä¸‹å›¾ï¼Œå…¶ä¸­Î»Ïµï¼ˆ0ï¼Œ1ï¼‰ï¼Œç”¨äºå¯¹ç»éªŒè¯¯å·®ä¸ç½‘ç»œå¤æ‚åº¦è¿›è¡ŒæŠ˜ä¸­ã€‚</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ9.png" alt="ç¥ç»ç½‘ç»œ9" style="zoom: 50%;" /></p>
</li>
</ul>
<p><strong>ç›¸å…³å†å²è¶£äº‹ï¼š</strong></p>
<blockquote>
<p>â€‹        1986å¹´ï¼ŒRumelharå’ŒHintonç­‰äººæå‡ºäº†åå‘ä¼ æ’­ï¼ˆBackpropagationï¼ŒBPï¼‰ç®—æ³•ï¼Œè§£å†³äº†ä¸¤å±‚ç¥ç»ç½‘ç»œæ‰€éœ€è¦çš„å¤æ‚è®¡ç®—é‡é—®é¢˜ï¼Œä»è€Œå¸¦åŠ¨äº†ä¸šç•Œä½¿ç”¨ä¸¤å±‚ç¥ç»ç½‘ç»œç ”ç©¶çš„çƒ­æ½®ã€‚ä½†æ˜¯ä¸å¹¸çš„æ˜¯ï¼Œå½“æ—¶çš„ç¥ç»ç½‘ç»œä»»ç„¶å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚è®­ç»ƒæ—¶é—´é•¿ã€ä¼˜åŒ–å›°éš¾ç­‰ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªæ—¶å€™çš„Hintonè¿˜æ¯”è¾ƒå¹´è½»ï¼Œ30å¹´ä»¥åï¼Œæ­£æ˜¯ä»–é‡æ–°å®šä¹‰äº†ç¥ç»ç½‘ç»œï¼Œå¸¦æ¥äº†ç¥ç»ç½‘ç»œå¤è‹çš„åˆä¸€æ˜¥ã€‚</p>
<p>â€‹        90å¹´ä»£ä¸­æœŸï¼Œç”±Vapnikç­‰äººå‘æ˜çš„SVMï¼ˆSupport Vector Machinesï¼Œæ”¯æŒå‘é‡æœºï¼‰ç®—æ³•è¯ç”Ÿï¼Œå¾ˆå¿«å°±åœ¨è‹¥å¹²ä¸ªæ–¹é¢ä½“ç°å‡ºäº†å¯¹æ¯”ç¥ç»ç½‘ç»œçš„ä¼˜åŠ¿ï¼šæ— éœ€è°ƒå‚ï¼›é«˜æ•ˆï¼›å…¨å±€æœ€ä¼˜è§£ã€‚åŸºäºä»¥ä¸Šç§ç§ç†ç”±ï¼ŒSVMè¿…é€Ÿæ‰“è´¥äº†ç¥ç»ç½‘ç»œç®—æ³•æˆä¸ºä¸»æµï¼Œç¥ç»ç½‘ç»œçš„ç ”ç©¶å†æ¬¡é™·å…¥äº†å†°æ²³æœŸã€‚</p>
<p>â€‹        ç›´åˆ°2006å¹´ï¼ŒHintonåœ¨ã€ŠScienceã€‹å’Œç›¸å…³æœŸåˆŠä¸Šå‘è¡¨äº†è®ºæ–‡ï¼Œé¦–æ¬¡æå‡ºäº†â€œæ·±åº¦ä¿¡å¿µç½‘ç»œâ€çš„æ¦‚å¿µï¼ŒåŒæ—¶ä»–ç»™å¤šå±‚ç¥ç»ç½‘ç»œç›¸å…³çš„å­¦ä¹ æ–¹æ³•èµ‹äºˆäº†ä¸€ä¸ªæ–°åè¯â€”â€œ<strong>æ·±åº¦å­¦ä¹ </strong>â€ï¼Œå°±åœ¨è¿™ä¹‹åï¼Œå…³äºæ·±åº¦ç¥ç»ç½‘ç»œçš„ç ”ç©¶ä¸åº”ç”¨ä¸æ–­æ¶Œç°ã€‚</p>
<p>â€‹        2019å¹´3æœˆ27æ—¥ â€”â€”ACMå®£å¸ƒï¼Œæ·±åº¦å­¦ä¹ çš„ä¸‰ä½åˆ›é€ è€…Yoshua Bengioï¼Œ Yann LeCunï¼Œ ä»¥åŠGeoffrey Hintonè·å¾—äº†2019å¹´çš„å›¾çµå¥–ã€‚</p>
</blockquote>
<p>Hintonè€çˆ·å­çš„ç…§ç‰‡ï¼š</p>
<p><img src="https://gitee.com/bugcat9/BlogImage/raw/master/æœºå™¨å­¦ä¹ /ç¥ç»ç½‘ç»œ10.png" alt="ç¥ç»ç½‘ç»œ10"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç®€å•çš„è®²è§£äº†ä¸€ä¸‹ç¥ç»ç½‘ç»œçš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶æ²¡æœ‰æ¶‰åŠCNNã€RNNç­‰ç›¸å…³çš„ä¸œè¥¿ã€‚ç„¶åè‡ªå·±ç”¨pytorchå†™äº†ä¸€ä¸‹è¿™ä¸ªç¥ç»ç½‘ç»œè¯†åˆ«æ‰‹å†™æ•°æ®é›†ï¼š<a href="https://github.com/Zhounning/MachineLearning/blob/master/arithmetic/MNISTæ‰‹å†™æ•°å­—æ•°æ®é›†MLP.ipynb">ç‚¹è¿™é‡Œ</a></p>
<p><strong>å‚è€ƒ</strong>ï¼š</p>
<p>ã€Šæœºå™¨å­¦ä¹ ã€‹â€”å‘¨å¿—å</p>
<p><a href="https://www.cnblogs.com/subconscious/p/5058741.html">https://www.cnblogs.com/subconscious/p/5058741.html</a></p>
<p><a href="https://www.zhihu.com/question/22553761">https://www.zhihu.com/question/22553761</a></p>
]]></content>
      <categories>
        <category>æœºå™¨å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ·±åº¦å­¦ä¹ </tag>
        <tag>ç¥ç»ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title>VScode-Introduction</title>
    <url>/2021/05/20/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85/VScode-Introduction/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><blockquote>
<p>VSCodeæ˜¯å¾®è½¯æ¨å‡ºçš„ä¸€æ¬¾ç¼–è¯‘å™¨ï¼Œåœ¨Macã€Linuxã€Windowsä¸‹éƒ½å¯ä»¥ä½¿ç”¨ï¼Œå¬åˆ«äººè¯´æŒºå¥½ç”¨ï¼Œä½†æ˜¯è‡ªå·±å¹¶æ²¡æœ‰å°è¯•ï¼Œç°åœ¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œç”¨å®ƒæ¥å†™c++ã€‚<br>æœ¬ç¯‡åšå®¢ä¸»è¦æ˜¯è®²è§£ä¸€ä¸‹VSCodeå†™C++çš„é…ç½®</p>
<span id="more"></span>
<h2 id="ä¸€ã€VSCodeä¸‹è½½å®‰è£…"><a href="#ä¸€ã€VSCodeä¸‹è½½å®‰è£…" class="headerlink" title="ä¸€ã€VSCodeä¸‹è½½å®‰è£…"></a>ä¸€ã€VSCodeä¸‹è½½å®‰è£…</h2><p>VSCodeä¸‹è½½å’Œå®‰è£…æ¯”è¾ƒç®€å•ï¼Œç›´æ¥ç™¾åº¦vscodeç„¶åè¿›å…¥å®˜ç½‘å°±èƒ½å¤Ÿä¸‹è½½(<a href="https://code.visualstudio.com/">å®˜ç½‘ä¼ é€é—¨</a>),å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download1.png" alt=""><br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download2.png" alt=""><br>VSCodeå®‰è£…æ¯”è¾ƒç®€å•ï¼Œå°±ä¸å¤šè§£é‡Šäº†</p>
</blockquote>
<h2 id="äºŒã€ä¸‹è½½C-ç¼–è¯‘å™¨"><a href="#äºŒã€ä¸‹è½½C-ç¼–è¯‘å™¨" class="headerlink" title="äºŒã€ä¸‹è½½C++ç¼–è¯‘å™¨"></a>äºŒã€ä¸‹è½½C++ç¼–è¯‘å™¨</h2><p>vscodeåªæ˜¯ä¸€ä¸ªç®€å•çš„IDEï¼Œè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªå†™txtçš„åœ°æ–¹ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸‹è½½ä¸€ä¸ªç¼–è¯‘å™¨ã€‚æˆ‘é€‰æ‹©çš„ç¼–è¯‘å™¨æ˜¯MinGW(<a href="https://sourceforge.net/projects/mingw-w64/">ä¸‹è½½ä¼ é€é—¨</a>)ï¼Œä¸‹è½½åè¿›è¡Œå®‰è£…ï¼Œå®‰è£…ä¹‹åç›´æ¥æ‰“å¼€ä¼šè¿›å…¥MinGW Installation Manaagerç•Œé¢ï¼Œåœ¨å·¦ä¾§æ é€‰æ‹©Basic Setupï¼Œç„¶åå³ä¾§ä¼šå‡ºç°7ä¸ªåŒ…ï¼Œæˆ‘ä»¬åªéœ€è¦é€‰ä¸­è¿™ä¸ƒä¸ªåŒ…è¿›è¡Œä¸‹è½½å³å¯ï¼ˆå¦‚æœæœ‰å…¶ä»–éœ€æ±‚å¯ä»¥é€‰æ‹©å·¦ä¾§çš„All Packagesè‡ªè¡Œé€‰æ‹©ï¼‰ã€‚ä¸‹è½½çš„æ–¹æ³•æ˜¯é€‰ä¸­ç›¸å¯¹åº”çš„åŒ…ç„¶åæŒ‰ä¸‹é¼ æ ‡å³é”®é€‰æ‹©â€œMark For Installtionâ€ï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download3.png" alt=""><br>å°†æƒ³ä¸‹è½½çš„åŒ…éƒ½é€‰ä¸­ä¹‹åï¼Œç„¶ç‚¹å‡»èœå•æ ä¸Šçš„Installationé€‰æ‹©Apply Changesï¼Œå¯ä»¥å‚è€ƒä¸‹å›¾ï¼š<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download4.png" alt=""><br>ä¸‹è½½å®Œæˆä¹‹åï¼ŒC++ç¼–è¯‘å™¨ä¹Ÿç®—æ˜¯å®Œæˆäº†ï¼Œæœ€åå°†å¯¹åº”çš„MinGWçš„ç¯å¢ƒé…ç½®ä¸€ä¸‹å°±è¡Œï¼Œç®€å•æ¥è¯´å°±æ˜¯å°†å®‰è£…ä¸‹è½½MinGWç›®å½•ä¸‹çš„binç›®å½•åŠ åˆ°ç¯å¢ƒpathå½“ä¸­ï¼Œæ¯”å¦‚æˆ‘MinGWå®‰è£…çš„ä½ç½®æ˜¯ï¼šâ€œD:\MinGW\binâ€ï¼Œå°±å°†â€œD:\MinGW\binâ€åŠ å…¥åˆ°pathå½“ä¸­å°±è¡Œï¼Œå¦‚æœæƒ³æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸï¼Œå¯ä»¥åœ¨cmdå½“ä¸­è¯•ä¸‹â€œg++ â€”versionâ€ã€â€œgdb â€”versionâ€æ˜¯å¦éƒ½æœ‰ç»“æœå¦‚æœéƒ½æœ‰åˆ™å®‰è£…æˆåŠŸã€‚</p>
<h2 id="ä¸‰ã€åœ¨VSCodeå½“ä¸­é…ç½®C-C-ç¯å¢ƒ"><a href="#ä¸‰ã€åœ¨VSCodeå½“ä¸­é…ç½®C-C-ç¯å¢ƒ" class="headerlink" title="ä¸‰ã€åœ¨VSCodeå½“ä¸­é…ç½®C/C++ç¯å¢ƒ"></a>ä¸‰ã€åœ¨VSCodeå½“ä¸­é…ç½®C/C++ç¯å¢ƒ</h2><p>é…ç½®çš„å¤§éƒ¨åˆ†éƒ½æ˜¯å‚è€ƒäº†VSCodeçš„å®˜æ–¹æ–‡æ¡£ï¼Œç¿»äº†è®¸å¤šåˆ«äººå†™çš„åšå®¢ï¼Œè®¸å¤šå› ä¸ºç‰ˆæœ¬é—®é¢˜å…¶å®åœ¨ç°åœ¨å¹¶ä¸æ˜¯å¾ˆé€‚ç”¨ï¼Œåæ¥çœ‹äº†å®˜æ–¹æä¾›çš„æ–‡æ¡£ï¼Œæ‰è§‰å¾—è±ç„¶å¼€æœ—ã€‚åœ¨vscodeå½“ä¸­æœ‰ä¸ªæ–‡ä»¶å¤¹.vscodeæ¯”è¾ƒé‡è¦ï¼Œé‡Œé¢ä¼šå­˜æ”¾vscodeçš„é…ç½®æ–‡ä»¶ï¼Œå¯¹äºæœ¬æ¬¡æ¯”è¾ƒé‡è¦çš„é…ç½®æ–‡ä»¶æœ‰ä¸‰ä¸ªï¼Œåˆ†åˆ«ä¸ºï¼štasks.jsonï¼ˆæ„å»ºæŒ‡ä»¤é…ç½®ï¼‰ã€launch.jsonï¼ˆè°ƒè¯•è®¾ç½®ï¼‰ã€c_cpp_properties.jsonï¼ˆç¼–è¯‘è·¯å¾„è·¯å¾„é…ç½®ï¼‰</p>
<h3 id="1-å®‰è£…VSCodeä¸­çš„C-C-æ’ä»¶"><a href="#1-å®‰è£…VSCodeä¸­çš„C-C-æ’ä»¶" class="headerlink" title="1.å®‰è£…VSCodeä¸­çš„C/C++æ’ä»¶"></a>1.å®‰è£…VSCodeä¸­çš„C/C++æ’ä»¶</h3><p>åœ¨Extensionsï¼ˆCtrl+Shift+Xï¼‰å½“ä¸­æœç´¢C++è¿›è¡Œå®‰è£…,å¦‚ä¸‹å›¾ï¼š<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download5.png" alt=""></p>
<h3 id="2-åˆ›å»ºhello-cppæ–‡ä»¶"><a href="#2-åˆ›å»ºhello-cppæ–‡ä»¶" class="headerlink" title="2.åˆ›å»ºhello.cppæ–‡ä»¶"></a>2.åˆ›å»ºhello.cppæ–‡ä»¶</h3><p>æ‰¾ä¸€ä¸ªç©ºçš„ç›®å½•ï¼ˆå½“ä½œå·¥ä½œç©ºé—´ï¼‰åœ¨é‡Œé¢åˆ›å»ºhello.cppæ–‡ä»¶ï¼Œç„¶åç”¨VSCodeæ‰“å¼€,åœ¨é‡Œé¢å†™ä¸‹å¦‚ä¸‹çš„ä»£ç ï¼š<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   vector&lt;string&gt; msg &#123;<span class="string">&quot;Hello&quot;</span>, <span class="string">&quot;C++&quot;</span>, <span class="string">&quot;World&quot;</span>, <span class="string">&quot;from&quot;</span>, <span class="string">&quot;VS Code&quot;</span>, <span class="string">&quot;and the C++ extension!&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">for</span> (<span class="type">const</span> string&amp; word : msg)</span><br><span class="line">   &#123;</span><br><span class="line">      cout &lt;&lt; word &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>å‚è€ƒå›¾å¦‚ä¸‹ï¼š<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download6.png" alt=""></p>
<h3 id="3-åˆ›å»ºtasks-jsonæ–‡ä»¶"><a href="#3-åˆ›å»ºtasks-jsonæ–‡ä»¶" class="headerlink" title="3.åˆ›å»ºtasks.jsonæ–‡ä»¶"></a>3.åˆ›å»ºtasks.jsonæ–‡ä»¶</h3><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªtasks.jsonæ–‡ä»¶æ¥å‘Šè¯‰VS Codeå¦‚ä½•æ„å»ºï¼ˆç¼–è¯‘ï¼‰ç¨‹åºã€‚ä½†æ˜¯è¿™ä¸ªæ–‡ä»¶ä¸è¦æˆ‘ä»¬æ‰‹åŠ¨åˆ›å»ºï¼Œå…·ä½“å¯ä»¥çœ‹ä¸‹é¢ã€‚<br>æˆ‘ä»¬åœ¨ä¸»èœå•ä¸­é€‰æ‹©<strong>ç»ˆç«¯ï¼ˆTerminal ï¼‰&gt;é…ç½®é»˜è®¤ç”Ÿæˆä»»åŠ¡ï¼ˆConfigure Default Build Taskï¼‰</strong>ã€‚åœ¨å¼¹å‡ºæ¥çš„ä¸‹æ‹‰åˆ—è¡¨ä¸­ï¼Œé€‰æ‹©<strong>g++.exe build active file</strong>ï¼Œç‚¹å‡»ä¹‹åä»–ä¼šè‡ªåŠ¨ç”Ÿæˆ.vscodæ–‡ä»¶å¤¹,å¹¶ä¸”é‡Œé¢ä¼šè‡ªåŠ¨ç”Ÿæˆtasks.jsonæ–‡ä»¶ã€‚<br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download7.png" alt=""><br>ç„¶åæˆ‘ä»¬éœ€è¦åœ¨tasks.jsoné‡Œé¢å†™ä¸‹</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"><span class="comment">// æœ‰å…³ tasks.json æ ¼å¼çš„æ–‡æ¡£ï¼Œè¯·å‚è§</span></span><br><span class="line">    <span class="comment">// https://go.microsoft.com/fwlink/?LinkId=733558</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tasks&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;shell&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;g++.exe build active file&quot;</span><span class="punctuation">,</span>   </span><br><span class="line">            <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\MinGW\\bin\\g++.exe&quot;</span><span class="punctuation">,</span>   <span class="comment">//å¯¹åº”è‡ªå·±ä¸‹è½½çš„ç›®å½•,æ¢ä¸€ä¸‹å®‰è£…ä½ç½®</span></span><br><span class="line">            <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;-g&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;file&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;-o&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;$&#123;fileDirname&#125;\\$&#123;fileBasenameNoExtension&#125;.exe&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;options&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\MinGW\\bin&quot;</span>  <span class="comment">//å¯¹åº”è‡ªå·±ä¸‹è½½çš„ç›®å½•,æ¢ä¸€ä¸‹å®‰è£…ä½ç½®</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;problemMatcher&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$gcc&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;group&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;build&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;isDefault&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å®Œæˆä¸Šè¯‰æ­¥éª¤ä¹‹åä½ å°±å¯ä»¥ç›´æ¥è¿è¡Œç¨‹åº,ä¼šç”Ÿæˆå¯¹åº”çš„exeåº”è¯¥å¯ä»¥çœ‹è§ï¼ˆæŒ‰ä¸‹ctrl+shit+Bå¯ä»¥è¿è¡Œï¼‰ã€‚</p>
<h3 id="4-åˆ›å»ºlaunch-jsonæ–‡ä»¶"><a href="#4-åˆ›å»ºlaunch-jsonæ–‡ä»¶" class="headerlink" title="4.åˆ›å»ºlaunch.jsonæ–‡ä»¶"></a>4.åˆ›å»ºlaunch.jsonæ–‡ä»¶</h3><p>ç›®å‰æˆ‘ä»¬å¹¶ä¸èƒ½å¯¹ä»£ç è¿›è¡Œè°ƒè¯•ï¼Œè¦æƒ³è¿›è¡Œè°ƒè¯•éœ€è¦åˆ›å»ºaunch.jsonæ–‡ä»¶ï¼ŒåŒç†ä¹Ÿä¸éœ€è¦æˆ‘ä»¬è‡ªå·±åˆ›å»º,å¯ä»¥é€‰æ‹©åœ¨è°ƒè¯•ç•Œé¢é€‰æ‹©â€œåˆ›å»ºlaunch.jsonæ–‡ä»¶â€ï¼Œæˆ–è€…åœ¨èœå•æ ä¸­é€‰æ‹©<strong>è°ƒè¯• &gt; æ·»åŠ é…ç½®.</strong>ï¼Œç„¶åé€‰æ‹©<strong>C ++ï¼ˆGDB / LLDBï¼‰</strong>ï¼Œç„¶åé€‰æ‹©<strong>g++.exe build and debug active file.</strong><br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download9.png" alt=""><br>ç„¶ååœ¨launch.jsonæ–‡ä»¶ä¸­å†™ä¸‹å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    </span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;g++.exe build and debug active file&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cppdbg&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;request&quot;</span><span class="punctuation">:</span> <span class="string">&quot;launch&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;program&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;fileDirname&#125;\\$&#123;fileBasenameNoExtension&#125;.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;stopAtEntry&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;cwd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;environment&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;externalConsole&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;MIMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;miDebuggerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\MinGW\\bin\\gdb.exe&quot;</span><span class="punctuation">,</span>      <span class="comment">//æ›´æ”¹åˆ°è‡ªå·±çš„ç›®å½•ä¸‹</span></span><br><span class="line">      <span class="attr">&quot;setupCommands&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Enable pretty-printing for gdb&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;-enable-pretty-printing&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ignoreFailures&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;preLaunchTask&quot;</span><span class="punctuation">:</span> <span class="string">&quot;g++.exe build active file&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å®Œæˆä¸Šè¿°äº‹æƒ…ä¹‹åå°±å¯ä»¥è®¾ç½®æ–­ç‚¹è¿›è¡Œç›¸å¯¹åº”çš„è°ƒè¯•äº†</p>
<h3 id="5-è®¾ç½®C-C-é…ç½®"><a href="#5-è®¾ç½®C-C-é…ç½®" class="headerlink" title="5.è®¾ç½®C/C++é…ç½®"></a>5.è®¾ç½®C/C++é…ç½®</h3><p>æŒ‰ä¸‹<strong>Ctrl+Shift+P</strong> æ‰“å¼€æœç´¢ç•Œé¢ç„¶åé€‰æ‹©<strong>C/C++: Edit Configurations (UI)</strong><br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download10.png" alt=""><br>é€‰æ‹©å·¦ä¸‹è§’çš„<strong>c_cpp_properties.json æ–‡ä»¶</strong><br><img src="https://gitee.com/bugcat9/BlogImage/raw/master/å…¶ä»–/download11.png" alt=""><br>ç¼–å†™c_cpp_properties.jsonå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Win32&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;includePath&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;$&#123;workspaceFolder&#125;/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;defines&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="string">&quot;_DEBUG&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;UNICODE&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="string">&quot;_UNICODE&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;compilerPath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;D:\\MinGW\\bin\\gcc.exe&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c11&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;cppStandard&quot;</span><span class="punctuation">:</span> <span class="string">&quot;c++17&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;intelliSenseMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;clang-x86&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">4</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>å¯ä»¥æ ¹æ®è‡ªå·±å®‰è£…è·¯å¾„å°†compilerPathçš„å¯¹åº”ç›®å½•è¿›è¡Œæ›´æ¢</strong></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å®Œæˆä¸Šè¿°æ­¥éª¤ä¹‹åï¼Œå°±èƒ½ä½¿ç”¨vscodeè¿›è¡Œç›¸å¯¹åº”çš„C++ç¼–å†™äº†ï¼Œä¸å¾—ä¸è¯´vscodeè¿˜æ˜¯æŒºé¦™çš„</p>
]]></content>
      <categories>
        <category>ç¯å¢ƒé…ç½®å®‰è£…</category>
      </categories>
      <tags>
        <tag>è½¯ä»¶å®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>android studioå®‰è£…</title>
    <url>/2021/05/20/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85/android%20studio%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h1 id="Android-studio-ä¸‹è½½å®‰è£…"><a href="#Android-studio-ä¸‹è½½å®‰è£…" class="headerlink" title="Android studio ä¸‹è½½å®‰è£…"></a>Android studio ä¸‹è½½å®‰è£…</h1><h2 id="javaç¯å¢ƒé…ç½®"><a href="#javaç¯å¢ƒé…ç½®" class="headerlink" title="javaç¯å¢ƒé…ç½®"></a>javaç¯å¢ƒé…ç½®</h2><h3 id="javaä¸‹è½½"><a href="#javaä¸‹è½½" class="headerlink" title="javaä¸‹è½½"></a>javaä¸‹è½½</h3><p>å»<a href="https://www.oracle.com/java/technologies/javase-downloads.html">Oracleå®˜ç½‘</a>ä¸‹è½½è‡ªå·±éœ€è¦çš„javaç‰ˆæœ¬</p>
<span id="more"></span>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16104173834716.png" alt="å›¾ç‰‡"></p>
<p>æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯windowsçš„jdk8</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16104172348073.png" alt="å›¾ç‰‡"></p>
<p>ps:ä¸‹è½½éœ€è¦ç™»å½•è‡ªå·±Oracleè´¦å·ï¼Œæ³¨å†Œç™»å½•ä¸€ä¸‹å°±è¡Œ</p>
<p>ä¸‹è½½ä¹‹åçš„exeæ–‡ä»¶åŒå‡»å¼€ï¼Œå®‰è£…åˆ°ä½ éœ€è¦å®‰è£…çš„ä½ç½®å³å¯ï¼Œæˆ‘è¿™é‡Œå®‰è£…ä½ç½®æ˜¯</p>
<p><code>D:\Program Files\Java\jdk1.8.0_271</code></p>
<h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>åœ¨ç³»ç»Ÿå˜é‡é‡Œé¢åŠ å…¥äº†å˜é‡<code>JAVA_HOME</code>ï¼Œå€¼ä¸ºå®‰è£…çš„ä½ç½®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210113195035403.png" alt=""></p>
<p>ç„¶ååœ¨Pathé‡Œé¢åŠ å…¥äº†<code>%JAVA_HOME%\bin</code>å’Œ<code>%JAVA_HOME%\jre\bin</code>(è¿™ä¸ªæœ‰å¾…å•†é‡)</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210113195354124.png" alt=""></p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨cmdå½“ä¸­è¾“å…¥<code>java -version</code>å’Œ<code>javac -version</code>æŸ¥çœ‹è¾“å‡ºï¼Œå¦‚æœæœ‰å¦‚ä¸‹çš„è¾“å‡ºè¯´æ˜é…ç½®æ­£ç¡®</p>
<p><code>java -version</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java version &quot;1.8.0_271&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_271-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)</span><br></pre></td></tr></table></figure>
<p><code>javac -version</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javac 1.8.0_271</span><br></pre></td></tr></table></figure>
<h2 id="Android-studioä¸‹è½½å’Œå®‰è£…"><a href="#Android-studioä¸‹è½½å’Œå®‰è£…" class="headerlink" title="Android studioä¸‹è½½å’Œå®‰è£…"></a>Android studioä¸‹è½½å’Œå®‰è£…</h2><h3 id="android-studioä¸‹è½½"><a href="#android-studioä¸‹è½½" class="headerlink" title="android studioä¸‹è½½"></a>android studioä¸‹è½½</h3><p>ç›´æ¥å»<a href="https://developer.android.com/studio?hl=zh-cn">å®˜ç½‘</a>,ä¸‹è½½<code>installer.exe</code>æˆ–è€…zipéƒ½å¯ä»¥ï¼Œæˆ‘è¿™é‡Œæ˜¯ä¸‹è½½çš„zipã€‚</p>
<p>ç„¶åæ‰¾ä¸ªåˆé€‚çš„ä½ç½®è§£å‹ï¼Œè§£å‹å®Œä¹‹åæ˜¯è¿™ä¸ªæ ·å­</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210114095707274.png" alt=""></p>
<p>æˆ‘ä»¬è¿›å…¥binæ–‡ä»¶ç‚¹å‡»<code>studio64.exe</code>å°±å¯ä»¥è¿è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210114095925560.png" alt=""></p>
<h3 id="ç¬¬ä¸€æ¬¡è¿è¡Œ"><a href="#ç¬¬ä¸€æ¬¡è¿è¡Œ" class="headerlink" title="ç¬¬ä¸€æ¬¡è¿è¡Œ"></a>ç¬¬ä¸€æ¬¡è¿è¡Œ</h3><p>ç¬¬ä¸€æ¬¡è¿è¡Œå¯èƒ½ä¼šä¸‹è½½ä¸€äº›sdkç­‰ä¸œè¥¿ï¼Œè¿™é‡Œçš„è¯åªéœ€è¦è®°å¾—æ›´æ”¹sdkä¸‹è½½ä½ç½®ï¼Œåˆ«ä¸‹è½½åˆ°cç›˜å°±è¡Œã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16105903698073.png" alt=""></p>
<p>ps:ç½‘ç»œå¯èƒ½ä¼šå¯¼è‡´å¾ˆéš¾ä¸‹è½½ä¸‹æ¥ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡è®¾ç½®é•œåƒç­‰æ–¹æ³•è§£å†³</p>
<h2 id="Androidç¯å¢ƒé…ç½®"><a href="#Androidç¯å¢ƒé…ç½®" class="headerlink" title="Androidç¯å¢ƒé…ç½®"></a>Androidç¯å¢ƒé…ç½®</h2><p>Android ç¯å¢ƒé…ç½®ä¸»è¦é…ç½®sdkçš„ç¯å¢ƒå˜é‡ï¼Œè·Ÿä¸Šé¢javaç¯å¢ƒé…ç½®ç±»ä¼¼ï¼Œåœ¨ç³»ç»Ÿå˜é‡ä¸­åŠ å…¥<code>ANDROID_HOME</code>å¯¹åº”ç€sdkå®‰è£…ä½ç½®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16106158683453.png" alt=""></p>
<p>ç„¶ååœ¨pathå½“ä¸­åŠ å…¥<code>%ANDROID_HOME%\platform-tools</code>å’Œ<code>%ANDROID_HOME%\tools</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210114172309012.png" alt=""></p>
<h3 id="æµ‹è¯•-1"><a href="#æµ‹è¯•-1" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨cmdå½“ä¸­è¾“å…¥adbï¼Œç„¶åè¾“å‡ºç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Android Debug Bridge version 1.0.41</span><br><span class="line">Version 30.0.5-6877874</span><br><span class="line">Installed as D:\Users\ningzzhou\AppData\Local\Android\SDK\platform-tools\adb.exe</span><br><span class="line"></span><br><span class="line">global options:</span><br><span class="line"> -a         listen on all network interfaces, not just localhost</span><br><span class="line"> -d         use USB device (error if multiple devices connected)</span><br></pre></td></tr></table></figure>
<p>æ›´å¤šç¯å¢ƒå˜é‡é…ç½®å¯ä»¥å‚è€ƒå®˜ç½‘ï¼š<a href="https://developer.android.com/studio/command-line/variables?hl=zh-cn">https://developer.android.com/studio/command-line/variables?hl=zh-cn</a></p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>Android studioå› ä¸ºç»å¸¸éœ€è¦å®‰è£…,æ‰€ä»¥è®°å½•ä¸€ä¸‹</p>
]]></content>
      <categories>
        <category>ç¯å¢ƒé…ç½®å®‰è£…</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>è½¯ä»¶å®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>eclipseä¸­androidç¯å¢ƒé…ç½®</title>
    <url>/2021/05/20/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85/eclipse%E4%B8%ADandroid%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="eclipseä¸­androidç¯å¢ƒé…ç½®"><a href="#eclipseä¸­androidç¯å¢ƒé…ç½®" class="headerlink" title="eclipseä¸­androidç¯å¢ƒé…ç½®"></a>eclipseä¸­androidç¯å¢ƒé…ç½®</h1><h2 id="javaç¯å¢ƒé…ç½®"><a href="#javaç¯å¢ƒé…ç½®" class="headerlink" title="javaç¯å¢ƒé…ç½®"></a>javaç¯å¢ƒé…ç½®</h2><h3 id="javaä¸‹è½½"><a href="#javaä¸‹è½½" class="headerlink" title="javaä¸‹è½½"></a>javaä¸‹è½½</h3><p>å»<a href="https://www.oracle.com/java/technologies/javase-downloads.html">Oracleå®˜ç½‘</a>ä¸‹è½½è‡ªå·±éœ€è¦çš„javaç‰ˆæœ¬</p>
<span id="more"></span>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16104173834716.png" alt="å›¾ç‰‡"></p>
<p>æˆ‘è¿™é‡Œé€‰æ‹©çš„æ˜¯windowsçš„jdk8</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16104172348073.png" alt="å›¾ç‰‡"></p>
<p>ps:ä¸‹è½½éœ€è¦ç™»å½•è‡ªå·±Oracleè´¦å·ï¼Œæ³¨å†Œç™»å½•ä¸€ä¸‹å°±è¡Œ</p>
<p>ä¸‹è½½ä¹‹åçš„exeæ–‡ä»¶åŒå‡»å¼€ï¼Œå®‰è£…åˆ°ä½ éœ€è¦å®‰è£…çš„ä½ç½®å³å¯ï¼Œæˆ‘è¿™é‡Œå®‰è£…ä½ç½®æ˜¯</p>
<p><code>D:\Program Files\Java\jdk1.8.0_271</code></p>
<h3 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h3><p>åœ¨ç³»ç»Ÿå˜é‡é‡Œé¢åŠ å…¥äº†å˜é‡<code>JAVA_HOME</code>ï¼Œå€¼ä¸ºå®‰è£…çš„ä½ç½®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210113195035403.png" alt=""></p>
<p>ç„¶ååœ¨Pathé‡Œé¢åŠ å…¥äº†<code>%JAVA_HOME%\bin</code>å’Œ<code>%JAVA_HOME%\jre\bin</code>(è¿™ä¸ªæœ‰å¾…å•†é‡)</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210113195354124.png" alt=""></p>
<h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><p>åœ¨cmdå½“ä¸­è¾“å…¥<code>java -version</code>å’Œ<code>javac -version</code>æŸ¥çœ‹è¾“å‡ºï¼Œå¦‚æœæœ‰å¦‚ä¸‹çš„è¾“å‡ºè¯´æ˜é…ç½®æ­£ç¡®</p>
<p><code>java -version</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java version &quot;1.8.0_271&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_271-b09)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.271-b09, mixed mode)</span><br></pre></td></tr></table></figure>
<p><code>javac -version</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">javac 1.8.0_271</span><br></pre></td></tr></table></figure>
<h2 id="eclipseä¸‹è½½å’Œé…ç½®"><a href="#eclipseä¸‹è½½å’Œé…ç½®" class="headerlink" title="eclipseä¸‹è½½å’Œé…ç½®"></a>eclipseä¸‹è½½å’Œé…ç½®</h2><h3 id="eclipseä¸‹è½½"><a href="#eclipseä¸‹è½½" class="headerlink" title="eclipseä¸‹è½½"></a>eclipseä¸‹è½½</h3><p>å»<a href="https://www.eclipse.org/downloads/packages/">å®˜ç½‘</a>ä¸‹è½½Eclipse IDE for Enterprise Java Developers</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16107116328073-1610711653956.png" alt=""></p>
<p>ps:ä¸‹è½½çš„æ—¶å€™å¯èƒ½è¦ä½ ææ¬¾ä»€ä¹ˆçš„ï¼Œè·³è¿‡å³å¯</p>
<p>è§£å‹å®Œä¹‹åæ˜¯è¿™æ ·çš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16111073888073.png" alt=""></p>
<p>ç‚¹å‡»eclipse.exeå°±èƒ½å¤Ÿè¿è¡Œ</p>
<h3 id="ä¸‹è½½adt"><a href="#ä¸‹è½½adt" class="headerlink" title="ä¸‹è½½adt"></a>ä¸‹è½½adt</h3><p>adtæ˜¯eclipseé‡Œé¢çš„Androidæ’ä»¶ï¼Œæœ‰è¿™ä¸ªæ‰èƒ½åœ¨eclipseé‡Œé¢å¼€å‘Android</p>
<p>ç‚¹å‡»<code>Help-&gt;Install New Software</code>,è¿›å…¥å®‰è£…æ’ä»¶çš„ç•Œé¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120095351409.png" alt=""></p>
<p>ç‚¹å‡»<code>Add</code>æ·»åŠ æ’ä»¶åœ°å€</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16111078194716.png" alt=""></p>
<p>æ’ä»¶æˆ‘è®¾ç½®åå­—ä¸º<code>ADT</code>,åœ°å€ä¸º<code>http://dl-ssl.google.com/android/eclipse</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120095943961.png" alt=""></p>
<p>ä¹‹ååªéœ€è¦æŒ‰ç…§å®‰è£…æ­£å¸¸æ’ä»¶çš„è¿‡ç¨‹ä¸€æ ·å®‰è£…ä¸€ä¸‹å°±è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120100225418.png" alt=""></p>
<p>psï¼šæˆ‘å·²ç»å®‰è£…äº†ï¼Œæ‰€ä»¥æ˜¾ç¤ºéƒ½å®‰è£…äº†</p>
<p>å®‰è£…åå¯ä»¥åœ¨<code>About Eclipse IDE</code>ä¸Šçœ‹åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120163100705.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120163135222.png" alt=""></p>
<h2 id="SDKä»¥åŠå·¥å…·ä¸‹è½½"><a href="#SDKä»¥åŠå·¥å…·ä¸‹è½½" class="headerlink" title="SDKä»¥åŠå·¥å…·ä¸‹è½½"></a>SDKä»¥åŠå·¥å…·ä¸‹è½½</h2><h3 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h3><p>æˆ‘ä»¬éœ€è¦å…ˆä¸‹è½½SDK Managerç­‰å·¥å…·ä¸‹è½½sdkï¼Œå·¥å…·ä¸‹è½½åœ°å€ï¼š<a href="https://dl.google.com/android/android-sdk_r24.4.1-windows.zip?utm_source=androiddevtools&amp;utm_medium=websiteã€‚">https://dl.google.com/android/android-sdk_r24.4.1-windows.zip?utm_source=androiddevtools&amp;utm_medium=websiteã€‚</a></p>
<p>ä¸‹è½½è§£å‹ä¹‹åæ˜¯è¿™æ ·çš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120164312559.png" alt=""></p>
<p>åŒå‡»SDK Manager.exeï¼Œå¯¹sdkä»¥åŠç›¸å¯¹åº”çš„å·¥å…·è¿›è¡Œä¸‹è½½ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120164715178.png" alt=""></p>
<p>ä¸‹è½½å®Œæˆåæˆ‘è¿™è¾¹å¤šäº†è®¸å¤šä¸œè¥¿</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/image-20210120164747825.png" alt=""></p>
<p>psï¼šç½‘ç»œå¯èƒ½ä¸å¥½ï¼Œéœ€è¦æ¢æº</p>
<p>éœ€è¦æ³¨æ„åœ¨SDK managerä¸­ä¸‹è½½çš„android SDK Build-toolså·¥å…·ï¼Œå› ä¸ºadtä¸å†å‡çº§ï¼Œæ‰€ä»¥android SDK Build-toolsç‰ˆæœ¬ä¸èƒ½å¤ªé«˜ï¼Œæ¨èä¸º24</p>
<h3 id="eclipseä¸Šé…ç½®"><a href="#eclipseä¸Šé…ç½®" class="headerlink" title="eclipseä¸Šé…ç½®"></a>eclipseä¸Šé…ç½®</h3><p>åœ¨Preferences-&gt;Androidå½“ä¸­é…ç½®ä¸€ä¸‹SDKçš„ä½ç½®ï¼Œæµè§ˆé€‰æ‹©åˆ°æˆ‘ä»¬è§£å‹zipçš„ä½ç½®å°±è¡Œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/eclipse/ä¼ä¸šå¾®ä¿¡æˆªå›¾_16111325677086.png" alt=""></p>
<p>psï¼šSDKç”¨Android Studioå…¶å®ä¹Ÿå¯ä»¥è¿›è¡Œä¸‹è½½ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºå•¥eclipseä½¿ç”¨ä¸äº†ï¼Œå¯èƒ½æ˜¯ä¸å¤ªå…¼å®¹å§ï¼Œæ¯•ç«Ÿadtéƒ½ä¸ç»´æŠ¤äº†</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>ä½¿ç”¨eclipseæ¥ç¼–å†™Androidå·²ç»è¿‡æ—¶äº†ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç»´æŠ¤ä»¥å‰ç”¨eclipseå†™çš„ä»£ç ï¼Œæ‰€ä»¥è¿«äºæ— å¥ˆè¿˜æ˜¯å¾—ä½¿ç”¨eclipseã€‚æ‰€ä»¥è®°ä¸€ä¸‹ç¯å¢ƒé…ç½®ï¼Œæ–¹ä¾¿åç»­çš„ç»´æŠ¤</p>
]]></content>
      <categories>
        <category>ç¯å¢ƒé…ç½®å®‰è£…</category>
      </categories>
      <tags>
        <tag>è½¯ä»¶å®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼–ç¨‹æ›´æ”¹é•œåƒæ€»ç»“</title>
    <url>/2021/05/22/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85/%E6%9B%B4%E6%94%B9%E9%95%9C%E5%83%8F/</url>
    <content><![CDATA[<h1 id="ç¼–ç¨‹æ›´æ”¹é•œåƒæ€»ç»“"><a href="#ç¼–ç¨‹æ›´æ”¹é•œåƒæ€»ç»“" class="headerlink" title="ç¼–ç¨‹æ›´æ”¹é•œåƒæ€»ç»“"></a>ç¼–ç¨‹æ›´æ”¹é•œåƒæ€»ç»“</h1><p>åœ¨å­¦ä¹ ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæ€»æ˜¯ä¼šé‡åˆ°å„ç§å„æ ·çš„ç½‘ç»œé—®é¢˜ï¼ˆæŒ‡åŒ…ä¸‹è½½çš„ç½‘ç»œé—®é¢˜ï¼‰ï¼Œæ‰€ä»¥æ€»ç»“ä¸€ä¸‹è¿™äº›é•œåƒæºçš„æ›´æ”¹ï¼Œæ–¹ä¾¿è‡ªå·±æ›´å¿«çš„ä¸‹è½½è¿™äº›åŒ…ã€‚å› ä¸ºæœ¬äººç”µè„‘æ˜¯windowsç³»ç»Ÿçš„ï¼Œæ‰€ä»¥æ³¨æ„æ€»ç»“windowsç³»ç»Ÿä¸‹çš„é•œåƒæ›´æ”¹ã€‚</p>
<span id="more"></span>
<h2 id="pythonä¸­pipæ›´æ”¹é•œåƒæº"><a href="#pythonä¸­pipæ›´æ”¹é•œåƒæº" class="headerlink" title="pythonä¸­pipæ›´æ”¹é•œåƒæº"></a>pythonä¸­pipæ›´æ”¹é•œåƒæº</h2><p>pipå®‰è£…åŒ…çš„æ—¶å€™é»˜è®¤éƒ½æ˜¯ä»å›½å¤–å®‰è£…ï¼Œç½‘é€Ÿå ªå¿§ï¼Œæ‰€ä»¥ä¸€èˆ¬å®‰è£…å®Œpythonï¼Œéƒ½éœ€è¦å°†è‡ªå·±ä½¿ç”¨çš„pipæºè¿›è¡Œæ›´æ¢ã€‚</p>
<p>windowsä¸‹ï¼Œç›´æ¥åœ¨userç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªpipç›®å½•ï¼Œå¦‚ï¼šC:\Users\xx\pipï¼Œæ–°å»ºæ–‡ä»¶pip.iniï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­è¿™ä¸ª<strong>index-url</strong>çš„è§£é‡Šæ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Pythonè½¯ä»¶åŒ…ç´¢å¼•çš„åŸºæœ¬URLï¼ˆé»˜è®¤ä¸ºhttps://pypi.org/simpleï¼‰ã€‚è¿™åº”è¯¥æŒ‡å‘ç¬¦åˆPEP 503ï¼ˆç®€å•å­˜å‚¨åº“APIï¼‰çš„å­˜å‚¨åº“æˆ–ä»¥ç›¸åŒæ ¼å¼å¸ƒç½®çš„æœ¬åœ°ç›®å½•ã€‚</span><br></pre></td></tr></table></figure>
<p>æˆ‘çœ‹æœ‰çš„åšå®¢ä¹Ÿä¼šå«å†åŠ ä¸€ä¸ª<strong>extra-index-url</strong>å‚æ•°ï¼Œä½†æ˜¯ç›®å‰ä½¿ç”¨æ¥çœ‹ä¼¼ä¹ä¸å¤ªéœ€è¦ã€‚</p>
<p>å…³äº<strong>index-urlã€extra-index-url</strong>çš„è®²è§£å¯ä»¥å‚è€ƒ<a href="https://pip.pypa.io/en/stable/cli/pip_install/#install-index-url">https://pip.pypa.io/en/stable/cli/pip_install/#install-index-url</a></p>
<p>å½“ç„¶å…¶å®ä¹Ÿå¯ä»¥ä¸åˆ›å»ºè¯¥æ–‡ä»¶ï¼Œä½†æ˜¯éœ€è¦æˆ‘ä»¬å®‰è£…çš„æ—¶å€™åŠ ä¸Šå‚æ•°<code>-i</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install -i åŒ…å https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/lambert310/article/details/52412059">https://blog.csdn.net/lambert310/article/details/52412059</a></p>
<h2 id="condaæ›´æ”¹é•œåƒæº"><a href="#condaæ›´æ”¹é•œåƒæº" class="headerlink" title="condaæ›´æ”¹é•œåƒæº"></a>condaæ›´æ”¹é•œåƒæº</h2><p>å‚è€ƒï¼š<a href="https://blog.csdn.net/weixin_40871455/article/details/90071122">https://blog.csdn.net/weixin_40871455/article/details/90071122</a></p>
<h2 id="mavenæ¢æº"><a href="#mavenæ¢æº" class="headerlink" title="mavenæ¢æº"></a>mavenæ¢æº</h2><p>mavenæ›´æ”¹æºæ¯”è¾ƒç®€å•ã€‚</p>
<ol>
<li><p>æ‰¾åˆ°mavenå®‰è£…ç›®å½•ä¸­çš„settings.xml</p>
</li>
<li><p>æ‰¾åˆ° \<mirrors>  &lt;/ mirrors&gt;æ ‡ç­¾ï¼Œæ ‡ç­¾ä¸­æ·»åŠ mirrorå­èŠ‚ç‚¹ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyunmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>é˜¿é‡Œäº‘å…¬å…±ä»“åº“<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸€èˆ¬æ¥è¯´ä¹Ÿä¹Ÿéœ€è¦æ›´æ”¹mavenä¸‹è½½åŒ…çš„ç›®å½•ï¼Œä¸ç„¶ä»–é»˜è®¤ä¸‹è½½åœ¨cç›˜å½“ä¸­(æˆ‘çš„cç›˜å¤ªå°äº†ï¼Œè¿˜æ˜¯æ”¹æ”¹)</p>
<p>æ‰¾åˆ° \<localRepository> \</localRepository>,å°†å…¶å˜æˆ</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>D:\Program Files\MavenRepository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="nodejsä¸­npmæ¢æº"><a href="#nodejsä¸­npmæ¢æº" class="headerlink" title="nodejsä¸­npmæ¢æº"></a>nodejsä¸­npmæ¢æº</h2><p>ä¸€èˆ¬æ˜¯æ›´æ¢æ·˜å®çš„æº</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">npm config set registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>
<p>é…ç½®åå¯é€šè¿‡ä¸‹é¢æ–¹å¼æ¥éªŒè¯æ˜¯å¦æˆåŠŸ</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">npm config get registry </span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç¯å¢ƒé…ç½®å®‰è£…</category>
      </categories>
  </entry>
  <entry>
    <title>æ’åº</title>
    <url>/2023/07/01/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/1.%E6%8E%92%E5%BA%8F/</url>
    <content><![CDATA[<h1 id="æ’åº"><a href="#æ’åº" class="headerlink" title="æ’åº"></a>æ’åº</h1><span id="more"></span>
<h2 id="å¿«é€Ÿæ’åº"><a href="#å¿«é€Ÿæ’åº" class="headerlink" title="å¿«é€Ÿæ’åº"></a>å¿«é€Ÿæ’åº</h2><ol>
<li>ç¡®å®šåˆ†ç•Œç‚¹ï¼ˆéšæœºå–ä»»æ„ä¸€ä¸ªæ•°ä¸ºåˆ†ç•Œç‚¹ï¼Œä¸€èˆ¬å–ä¸­ç‚¹ï¼‰ï¼›</li>
<li>è°ƒæ•´åŒºé—´ï¼ŒæŠŠå°äº<code>x</code>çš„æ•°ç§»åˆ°å·¦è¾¹ï¼ŒæŠŠå¤§äº<code>x</code>çš„æ•°ç§»åˆ°å³è¾¹ï¼ŒæŠŠåŒºé—´åˆ†ä¸º<code>[l, j]</code>ã€<code>[j + 1, r]</code>ï¼›</li>
<li>é€’å½’å·¦å³ã€‚</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å¿«é€Ÿæ’åº</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">QuickSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l &gt;= r)<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> i = l - <span class="number">1</span>, j = r + <span class="number">1</span>, x = nums[l + (r - l) &gt;&gt; <span class="number">1</span>];</span><br><span class="line">	<span class="keyword">while</span> (i &lt; j)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">do</span> i++; <span class="keyword">while</span> (nums[i] &lt; x);</span><br><span class="line">		<span class="keyword">do</span> j--; <span class="keyword">while</span> (nums[j] &gt; x);</span><br><span class="line">		<span class="keyword">if</span> (i &lt; j) <span class="built_in">swap</span>(nums[i], nums[j]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">QuickSort</span>(nums, l, j);</span><br><span class="line">	<span class="built_in">QuickSort</span>(nums, j + <span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å½’å¹¶æ’åº"><a href="#å½’å¹¶æ’åº" class="headerlink" title="å½’å¹¶æ’åº"></a>å½’å¹¶æ’åº</h2><ol>
<li>å–æ•°ç»„çš„ä¸­é—´æ•°ä½œä¸ºåˆ†ç•Œç‚¹ï¼›</li>
<li>å°†åˆ†ç•Œç‚¹å·¦å³ä¸¤è¾¹åˆ†åˆ«æ’å¥½åºï¼›</li>
<li>å°†å·¦å³ä¸¤è¾¹è¿›è¡Œåˆå¹¶ã€‚</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å½’å¹¶æ’åº</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MergeSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (l &gt;= r) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> mid = l + (r - l) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">MergeSort</span>(nums, l, mid);</span><br><span class="line">	<span class="built_in">MergeSort</span>(nums, mid + <span class="number">1</span>, r);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> k = <span class="number">0</span>, i = l, j = mid + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;= r) &#123;</span><br><span class="line">		<span class="keyword">if</span> (nums[i] &lt;= nums[j])</span><br><span class="line">			tmp[k++] = nums[i++];</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			tmp[k++] = nums[j++];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (i &lt;= mid) tmp[k++] = nums[i++];</span><br><span class="line">	<span class="keyword">while</span> (j &lt;= r) tmp[k++] = nums[j++];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = l, j = <span class="number">0</span>; i &lt;= r; i++, j++) nums[i] = tmp[j];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å¯¹åº”çš„é¢˜ç›®"><a href="#å¯¹åº”çš„é¢˜ç›®" class="headerlink" title="å¯¹åº”çš„é¢˜ç›®"></a>å¯¹åº”çš„é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/sort-an-array/submissions/">æ’åºæ•°ç»„</a></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ’åº</tag>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>å®ç”¨å°è½¯ä»¶</title>
    <url>/2021/08/22/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%AE%89%E8%A3%85/%E5%AE%9E%E7%94%A8%E5%B0%8F%E8%BD%AF%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="å®ç”¨å°è½¯ä»¶"><a href="#å®ç”¨å°è½¯ä»¶" class="headerlink" title="å®ç”¨å°è½¯ä»¶"></a>å®ç”¨å°è½¯ä»¶</h1><p>è‡ªå·±å¼€å‘æˆ–è€…å†™æ–‡æ¡£çš„æ—¶å€™ç»å¸¸éœ€è¦ä½¿ç”¨ä¸€äº›å·¥å…·è½¯ä»¶ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸€ä¸‹</p>
<span id="more"></span>
<h2 id="SSR"><a href="#SSR" class="headerlink" title="SSR"></a>SSR</h2><p>ç§‘å­¦ä¸Šç½‘å°å·¥å…·ï¼Œäººç§°å°é£æœºåŸºæœ¬ä¸Šæ˜¯ç§‘å­¦ä¸Šç½‘å¿…é¡»çš„ï¼Œä¸‹è½½ä¹‹åè§£å‹ç›´æ¥ä½¿ç”¨æ— éœ€å®‰è£…ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>
<p>ä¸‹è½½åœ°å€ï¼š</p>
<p><a href="https://github.com/shadowsocksr-rm/shadowsocksr-csharp/releases">https://github.com/shadowsocksr-rm/shadowsocksr-csharp/releases</a></p>
<h2 id="Snipaste"><a href="#Snipaste" class="headerlink" title="Snipaste"></a>Snipaste</h2><p>æˆªå›¾å°å·¥å…·ï¼Œåœ¨å†™æ–‡æ¡£éœ€è¦æˆªå›¾çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¸œè¥¿ï¼ŒåŠŸèƒ½æ„Ÿè§‰å’Œqqä¸Šæˆªå›¾åŠŸèƒ½å·®ä¸å¤šï¼Œä½†æ˜¯qqæˆªå›¾æ²¡æœ‰å¿«æ·é”®ï¼Œå¹¶ä¸”å¤åˆ¶åˆ°å‰ªåˆ‡æ¿æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥å¤šæ•°æ—¶å€™æˆ‘ä½¿ç”¨çš„æ˜¯è¿™ä¸ªæˆªå›¾ï¼Œè¿è¡Œä¹‹åF1å¿«æ·æˆªå›¾ï¼Œä¹Ÿæ˜¯ä¸‹è½½è§£å‹ç›´æ¥ä½¿ç”¨æ— éœ€å®‰è£…ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>
<p>ä¸‹è½½åœ°å€ï¼š</p>
<p><a href="https://zh.snipaste.com/index.html">https://zh.snipaste.com/index.html</a></p>
<h2 id="ScreenToGif"><a href="#ScreenToGif" class="headerlink" title="ScreenToGif"></a>ScreenToGif</h2><p>å½•åˆ¶å±å¹•çš„GIFä¸“ç”¨å·¥å…·ï¼Œæœ‰çš„æ—¶å€™æˆªå›¾å¹¶ä¸èƒ½å¾ˆå¥½çš„è¡¨è¾¾å‡ºæ“ä½œè¿™ä¸ªæ—¶å€™ä½¿ç”¨GIFå°±å¾ˆé‡è¦äº†ï¼ŒScreenToGifæ˜¯æˆ‘ä½¿ç”¨çš„gifå½•åˆ¶å°å·¥å…·ï¼Œæ“ä½œç®€å•ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯è§£å‹ç›´æ¥ä½¿ç”¨æ— éœ€å®‰è£…ï¼ˆå½“ç„¶éœ€è¦ä¸‹è½½portableç‰ˆæœ¬ï¼‰ã€‚</p>
<p>ä¸‹è½½åœ°å€ï¼š</p>
<p><a href="https://www.screentogif.com/">https://www.screentogif.com/</a></p>
<h2 id="OBS-Studio"><a href="#OBS-Studio" class="headerlink" title="OBS Studio"></a>OBS Studio</h2><p>å±å¹•å½•åˆ¶è½¯ä»¶ï¼Œç›®å‰æ²¡æœ‰æ‰¾åˆ°æ¯”è¾ƒå¥½ç”¨çš„å±å¹•å½•åˆ¶è½¯ä»¶ï¼Œè¿™ä¸ªä¹Ÿç®—æˆ‘ä½¿ç”¨æ¯”è¾ƒä¹ æƒ¯çš„ä¸€æ¬¾å§</p>
<p>è¿™ä¸ªä¹Ÿæœ‰æ— éœ€è¦å®‰è£…çš„ç‰ˆæœ¬ï¼Œä¸‹è½½zipä¹‹åå¼€ç®±å³ç”¨</p>
<p>ä¸‹è½½åœ°å€ï¼š</p>
<p><a href="https://obsproject.com/zh-tw">https://obsproject.com/zh-tw</a></p>
<h2 id="v2rayn"><a href="#v2rayn" class="headerlink" title="v2rayn"></a>v2rayn</h2><p>ä¹Ÿæ˜¯ç§‘å­¦ä¸Šç½‘å°å·¥å…·ï¼Œæ®è¯´éšè”½æ€§æ¯”ssrå¥½ï¼Œå› ä¸ºåè®®ä¸ä¸€æ ·</p>
<p>å®˜ç½‘åœ°å€ï¼š</p>
<p><a href="https://v2ray.com/">https://v2ray.com/</a></p>
<p>æœ€ç»ˆéœ€è¦åˆ°githubä¸Šä¸‹è½½</p>
<h2 id="Clash"><a href="#Clash" class="headerlink" title="Clash"></a>Clash</h2><p>ç§‘å­¦ä¸Šç½‘å°å·¥å…·ï¼Œæœ‰äººè¯´æ˜¯æœ€å¥½çš„ä¸Šç½‘å·¥å…·</p>
<p>è®²è§£åœ°å€ï¼š</p>
<p><a href="https://docs.cfw.lbyczf.com/">https://docs.cfw.lbyczf.com/</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç›®å‰å°±å†™è¿™ä¹ˆå¤šå§ï¼Œå¦‚æœåé¢æœ‰å†åŠ ä¸Šï¼Œæˆ‘å®‰è£…è½¯ä»¶çš„ç‰¹ç‚¹æ˜¯èƒ½ç›´æ¥ä½¿ç”¨å°±ä¸å®‰è£…ï¼Œæ‰€ä»¥åŸºæœ¬éƒ½æè®®å®‰è£…ä¾¿æºç‰ˆæœ¬</p>
]]></content>
      <categories>
        <category>ç¯å¢ƒé…ç½®å®‰è£…</category>
      </categories>
      <tags>
        <tag>è½¯ä»¶å®‰è£…</tag>
      </tags>
  </entry>
  <entry>
    <title>æ•´æ•°äºŒåˆ†</title>
    <url>/2023/07/01/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/2.%E6%95%B4%E6%95%B0%E4%BA%8C%E5%88%86/</url>
    <content><![CDATA[<h1 id="æ•´æ•°äºŒåˆ†"><a href="#æ•´æ•°äºŒåˆ†" class="headerlink" title="æ•´æ•°äºŒåˆ†"></a>æ•´æ•°äºŒåˆ†</h1><p>å¯ä»¥åˆ’åˆ†ä¸ºæ»¡è¶³æŸç§æ€§è´¨ä¸ä¸æ»¡è¶³æŸç§æ€§è´¨çš„ä¸¤ä¸ªåŒºé—´ï¼Œç”¨äºŒåˆ†æ³•å¯ä»¥æ‰¾åˆ°ä¸¤åŒºé—´è¾¹ç•Œçš„å·¦å³ä¸¤ä¸ªç‚¹ã€‚å¦‚å›¾ä¸­çº¢è‰²å’Œç»¿è‰²åŒºé—´ï¼Œå¯ä»¥é€šè¿‡äºŒåˆ†æ‰¾åˆ°è¿™ä¸ªåŒºé—´è¾¹ç•Œã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯åˆ©ç”¨å•è°ƒæ€§äºŒåˆ†åªæ˜¯å…¶ä¸­ä¸€ç§ï¼Œå…¶ä»–æ€§è´¨å…¶å®ä¹Ÿå¯ä»¥äºŒåˆ†ï¼Œä¸è¿‡æˆ‘ä»¬æŒæ¡å•è°ƒæ€§è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾å°±è¡Œã€‚<br><span id="more"></span><br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/ç®—æ³•å­¦ä¹ /äºŒåˆ†-ç¬¬ 3 é¡µ.drawio.png" alt="äºŒåˆ†-ç¬¬ 3 é¡µ.drawio"></p>
<ol>
<li>å¯»æ‰¾çº¢è‰²åŒºåŸŸçš„è¾¹ç•Œã€‚<ul>
<li>mid = (l+r+1)/2</li>
<li>å¦‚æœmidåœ¨çº¢è‰²åŒºåŸŸï¼Œ[l,r]-&gt;[mid,r]</li>
<li>å¦‚æœmidä¸åœ¨çº¢è‰²åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯çº¢è‰²å³ä¾§çš„åŒºåŸŸï¼Œ[l,r]-&gt;[l,mid-1]</li>
</ul>
</li>
<li>å¯»æ‰¾ç»¿è‰²åŒºåŸŸçš„è¾¹ç•Œã€‚<ul>
<li>mid = (l+r)/2 </li>
<li>å¦‚æœmidåœ¨ç»¿è‰²åŒºåŸŸï¼Œ[l,r]-&gt;[l,mid] </li>
<li>å¦‚æœmidä¸åœ¨ç»¿è‰²åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯ç»¿è‰²å·¦ä¾§çš„åŒºåŸŸï¼Œ[l,r]-&gt;[mid+1,r]</li>
</ul>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">check</span><span class="params">(<span class="type">int</span> x)</span> </span>&#123;<span class="comment">/* ... */</span>&#125; <span class="comment">// æ£€æŸ¥xæ˜¯å¦æ»¡è¶³æŸç§æ€§è´¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid]å’Œ[mid + 1, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_1</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) r = mid;    <span class="comment">// check()åˆ¤æ–­midæ˜¯å¦æ»¡è¶³æ€§è´¨</span></span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åŒºé—´[l, r]è¢«åˆ’åˆ†æˆ[l, mid - 1]å’Œ[mid, r]æ—¶ä½¿ç”¨ï¼š</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">bsearch_2</span><span class="params">(<span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r + <span class="number">1</span> &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">check</span>(mid)) l = mid;</span><br><span class="line">        <span class="keyword">else</span> r = mid - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾3çš„èµ·å§‹ä½ç½®å’Œç»ˆæ­¢ä½ç½®ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•è¿›è¡ŒæŸ¥æ‰¾</p>
<p>å¯ä»¥ä½¿ç”¨bsearch_2æŸ¥æ‰¾3çš„ç»ˆæ­¢ä½ç½®ï¼Œæ¡ä»¶æ˜¯<code>x&lt;=3</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/ç®—æ³•å­¦ä¹ /äºŒåˆ†.drawio.png" alt="äºŒåˆ†.drawio"></p>
<p>å¯ä»¥ä½¿ç”¨bsearch_1æŸ¥æ‰¾3çš„ç»ˆæ­¢ä½ç½®ï¼Œæ¡ä»¶æ˜¯<code>x&gt;=3</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/ç®—æ³•å­¦ä¹ /äºŒåˆ†-ç¬¬ 2 é¡µ.drawio.png" alt="äºŒåˆ†-ç¬¬ 2 é¡µ.drawio"></p>
<h2 id="å¯¹åº”é¢˜ç›®"><a href="#å¯¹åº”é¢˜ç›®" class="headerlink" title="å¯¹åº”é¢˜ç›®"></a>å¯¹åº”é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/description/">åœ¨æ’åºæ•°ç»„ä¸­æŸ¥æ‰¾å…ƒç´ çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®
</a><br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">searchRange</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(nums.<span class="built_in">empty</span>())<span class="keyword">return</span> &#123;<span class="number">-1</span>,<span class="number">-1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> l = <span class="built_in">LeftBound</span>(nums,target);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(nums[l]!=target)&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="number">-1</span>,<span class="number">-1</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> r = <span class="built_in">RightBound</span>(nums,target);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;l,r&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹åº”bsearch_1</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">LeftBound</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> target)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> l = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> r = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> mid = (l + r) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &gt;= target)</span><br><span class="line">            &#123;</span><br><span class="line">                r = mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                l = mid + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯¹åº”bsearch_2</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">RightBound</span><span class="params">(vector&lt;<span class="type">int</span>&gt;&amp; nums, <span class="type">int</span> target)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">int</span> l = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> r = nums.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> mid = (l + r + <span class="number">1</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (nums[mid] &lt;= target)</span><br><span class="line">            &#123;</span><br><span class="line">                l = mid;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                r = mid - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> l;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>äºŒåˆ†</tag>
      </tags>
  </entry>
  <entry>
    <title>é«˜ç²¾åº¦è®¡ç®—</title>
    <url>/2023/07/03/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/3.%E9%AB%98%E7%B2%BE%E5%BA%A6%E8%AE%A1%E7%AE%97/</url>
    <content><![CDATA[<h1 id="é«˜ç²¾åº¦è®¡ç®—"><a href="#é«˜ç²¾åº¦è®¡ç®—" class="headerlink" title="é«˜ç²¾åº¦è®¡ç®—"></a>é«˜ç²¾åº¦è®¡ç®—</h1><span id="more"></span>
<h2 id="é«˜ç²¾åº¦åŠ æ³•"><a href="#é«˜ç²¾åº¦åŠ æ³•" class="headerlink" title="é«˜ç²¾åº¦åŠ æ³•"></a>é«˜ç²¾åº¦åŠ æ³•</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">/ C = A + B, A &gt;= <span class="number">0</span>, B &gt;= <span class="number">0</span></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; <span class="built_in">add</span>(vector&lt;<span class="type">int</span>&gt; &amp;A, vector&lt;<span class="type">int</span>&gt; &amp;B)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (A.<span class="built_in">size</span>() &lt; B.<span class="built_in">size</span>()) <span class="keyword">return</span> <span class="built_in">add</span>(B, A);</span><br><span class="line"></span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; C;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; A.<span class="built_in">size</span>(); i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        t += A[i];</span><br><span class="line">        <span class="keyword">if</span> (i &lt; B.<span class="built_in">size</span>()) t += B[i];</span><br><span class="line">        C.<span class="built_in">push_back</span>(t % <span class="number">10</span>);</span><br><span class="line">        t /= <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (t) C.<span class="built_in">push_back</span>(t);</span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="é«˜ç²¾åº¦å‡æ³•"><a href="#é«˜ç²¾åº¦å‡æ³•" class="headerlink" title="é«˜ç²¾åº¦å‡æ³•"></a>é«˜ç²¾åº¦å‡æ³•</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// C = A - B, æ»¡è¶³A &gt;= B, A &gt;= 0, B &gt;= 0</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">sub</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;A, vector&lt;<span class="type">int</span>&gt; &amp;B)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; C;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, t = <span class="number">0</span>; i &lt; A.<span class="built_in">size</span>(); i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        t = A[i] - t;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; B.<span class="built_in">size</span>()) t -= B[i];</span><br><span class="line">        C.<span class="built_in">push_back</span>((t + <span class="number">10</span>) % <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (t &lt; <span class="number">0</span>) t = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> t = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (C.<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; C.<span class="built_in">back</span>() == <span class="number">0</span>) C.<span class="built_in">pop_back</span>();</span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é«˜ç²¾åº¦ä¹˜æ³•"><a href="#é«˜ç²¾åº¦ä¹˜æ³•" class="headerlink" title="é«˜ç²¾åº¦ä¹˜æ³•"></a>é«˜ç²¾åº¦ä¹˜æ³•</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// C = A * b, A &gt;= 0, b &gt;= 0</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">mul</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;A, <span class="type">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; C;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; A.<span class="built_in">size</span>() || t; i ++ )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i &lt; A.<span class="built_in">size</span>()) t += A[i] * b;</span><br><span class="line">        C.<span class="built_in">push_back</span>(t % <span class="number">10</span>);</span><br><span class="line">        t /= <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (C.<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; C.<span class="built_in">back</span>() == <span class="number">0</span>) C.<span class="built_in">pop_back</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é«˜ç²¾åº¦é™¤æ³•"><a href="#é«˜ç²¾åº¦é™¤æ³•" class="headerlink" title="é«˜ç²¾åº¦é™¤æ³•"></a>é«˜ç²¾åº¦é™¤æ³•</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// A / b = C ... r, A &gt;= 0, b &gt; 0</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">div</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;A, <span class="type">int</span> b, <span class="type">int</span> &amp;r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; C;</span><br><span class="line">    r = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = A.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i -- )</span><br><span class="line">    &#123;</span><br><span class="line">        r = r * <span class="number">10</span> + A[i];</span><br><span class="line">        C.<span class="built_in">push_back</span>(r / b);</span><br><span class="line">        r %= b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">reverse</span>(C.<span class="built_in">begin</span>(), C.<span class="built_in">end</span>());</span><br><span class="line">    <span class="keyword">while</span> (C.<span class="built_in">size</span>() &gt; <span class="number">1</span> &amp;&amp; C.<span class="built_in">back</span>() == <span class="number">0</span>) C.<span class="built_in">pop_back</span>();</span><br><span class="line">    <span class="keyword">return</span> C;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/add-strings/description/">å­—ç¬¦ä¸²ç›¸åŠ </a></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>é«˜ç²¾åº¦åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ã€é™¤æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>å‰ç¼€å’Œä¸å·®åˆ†</title>
    <url>/2023/07/03/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/4.%E5%89%8D%E7%BC%80%E5%92%8C%E4%B8%8E%E5%B7%AE%E5%88%86/</url>
    <content><![CDATA[<h1 id="å‰ç¼€å’Œä¸å·®åˆ†"><a href="#å‰ç¼€å’Œä¸å·®åˆ†" class="headerlink" title="å‰ç¼€å’Œä¸å·®åˆ†"></a>å‰ç¼€å’Œä¸å·®åˆ†</h1><span id="more"></span>
<h2 id="ä¸€ç»´å‰ç¼€å’Œ"><a href="#ä¸€ç»´å‰ç¼€å’Œ" class="headerlink" title="ä¸€ç»´å‰ç¼€å’Œ"></a>ä¸€ç»´å‰ç¼€å’Œ</h2><p><code>a[i]</code> è¡¨ç¤ºæ•°ç»„ä¸­ç¬¬iä¸ªæ•°ã€<code>s[i]</code>è¡¨ç¤ºä¸ºå‰iä¸ªæ•°ä¹‹å’Œ</p>
<ol>
<li><code>s[i] = a[1] + a[2] + â€¦â€¦+ a[i] = s[i-1] + a[i]</code></li>
<li><code>[l, r]</code>åŒºé—´å†…æ•°çš„å’Œï¼š<code>s[r] - s[l-1]</code>ï¼ˆä¸ºäº†å½“l=1æ—¶ä¸éœ€è¦è¿›è¡Œç‰¹åˆ¤ã€‚è§„å®šs[0]è®°ä¸º0ï¼Œä¸”è¯»å…¥æ•°ç»„çš„æ—¶å€™ä»ä¸‹æ ‡1å¼€å§‹è®°å½•ï¼‰</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">S[i] = a[1] + a[2] + ... a[i]</span><br><span class="line">a[l] + ... + a[r] = S[r] - S[l - 1]</span><br></pre></td></tr></table></figure>
<p>å°è£…ä¸€ä¸‹<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸€ç»´å‰ç¼€å’Œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PreSum</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">PreSum</span>(vector&lt;<span class="type">int</span>&gt;&amp; nums);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* æŸ¥è¯¢é—­åŒºé—´ [left, right] çš„ç´¯åŠ å’Œ */</span></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">query</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> right)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; m_preSum;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PreSum::<span class="built_in">PreSum</span>(vector&lt;<span class="type">int</span>&gt;&amp; nums)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> n = nums.<span class="built_in">size</span>();</span><br><span class="line">	m_preSum.<span class="built_in">resize</span>(n + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; n + <span class="number">1</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		m_preSum[i] = m_preSum[i - <span class="number">1</span>] + nums[i - <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">PreSum::query</span><span class="params">(<span class="type">int</span> left, <span class="type">int</span> right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m_preSum[right + <span class="number">1</span>] - m_preSum[left];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="ä¸€ç»´å·®åˆ†"><a href="#ä¸€ç»´å·®åˆ†" class="headerlink" title="ä¸€ç»´å·®åˆ†"></a>ä¸€ç»´å·®åˆ†</h2><p>å·®åˆ†æ˜¯å‰ç¼€å’Œçš„é€†è¿ç®—ï¼Œç®€å•å°è£…<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Difference</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Difference</span>(vector&lt;<span class="type">int</span>&gt; nums);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">increment</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">int</span> val)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">result</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	vector&lt;<span class="type">int</span>&gt; m_diff;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Difference::<span class="built_in">Difference</span>(vector&lt;<span class="type">int</span>&gt; nums)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> size = nums.<span class="built_in">size</span>();</span><br><span class="line">	m_diff.<span class="built_in">resize</span>(size);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; size; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		m_diff[i] = nums[i] - nums[i - <span class="number">1</span>];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Difference::increment</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> j, <span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	m_diff[i] += val;</span><br><span class="line">	<span class="keyword">if</span> (j + <span class="number">1</span> &lt; m_diff.<span class="built_in">size</span>()) &#123;</span><br><span class="line">		m_diff[j + <span class="number">1</span>] -= val;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">Difference::result</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">res</span><span class="params">(m_diff.size())</span></span>;</span><br><span class="line">	res[<span class="number">0</span>] = m_diff[<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; m_diff.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">		res[i] = res[i - <span class="number">1</span>] + m_diff[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/range-sum-query-immutable/">å‰ç¼€å’Œ</a></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>å‰ç¼€å’Œä¸å·®åˆ†</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½è¿ç®—</title>
    <url>/2023/08/06/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/5.%E4%BD%8D%E8%BF%90%E7%AE%97/</url>
    <content><![CDATA[<h1 id="ä½è¿ç®—"><a href="#ä½è¿ç®—" class="headerlink" title="ä½è¿ç®—"></a>ä½è¿ç®—</h1><p>è¿™é‡Œä¸»è¦è®°å½•ä¸€ä¸‹å­¦ä¹ åˆ°çš„ä½è¿ç®—ç®—æ³•<br><span id="more"></span></p>
<h2 id="æ±‚ç¬¬kä½æ•°å­—"><a href="#æ±‚ç¬¬kä½æ•°å­—" class="headerlink" title="æ±‚ç¬¬kä½æ•°å­—"></a>æ±‚ç¬¬kä½æ•°å­—</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">æ±‚nçš„ç¬¬kä½æ•°å­—: n &gt;&gt; k &amp; <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="è¿”å›nçš„æœ€åä¸€ä½1"><a href="#è¿”å›nçš„æœ€åä¸€ä½1" class="headerlink" title="è¿”å›nçš„æœ€åä¸€ä½1"></a>è¿”å›nçš„æœ€åä¸€ä½1</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lowbit(n) = n &amp; -nï¼Œï¼Œå¦‚101000å¾—1000</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå¯èƒ½å’‹çœ‹ä¸€ä¸‹ä¸å¥½ç†è§£ï¼Œä½†æ˜¯å¯ä»¥æ¨ç†å‡ºæ¥:</p>
<ol>
<li>å‡è®¾<code>x = 1010...10000</code></li>
<li><code>-x = ~x+1</code></li>
<li><code>~x = 0101...01111</code></li>
<li><code>~x + 1 = 0101...10000</code></li>
<li><code>x &amp; (~x+1) = (1010...10000) &amp; (0101...10000) = 0000...10000</code><br>å¯ä»¥é€šè¿‡ä¸Šé¢æ­¥éª¤å‘ç°<code>lowbit(n)</code>ç®—æ³•æœ€ç»ˆå–åˆ°æœ€åä¸€ä½1å’Œåé¢çš„äºŒè¿›åˆ¶</li>
</ol>
<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/number-of-1-bits/description/">ä½1çš„ä¸ªæ•°</a></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>ä½è¿ç®—</tag>
      </tags>
  </entry>
  <entry>
    <title>åŒºé—´å’Œ</title>
    <url>/2023/08/06/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/7.%E5%8C%BA%E9%97%B4%E5%92%8C/</url>
    <content><![CDATA[<h1 id="åŒºé—´å’Œ"><a href="#åŒºé—´å’Œ" class="headerlink" title="åŒºé—´å’Œ"></a>åŒºé—´å’Œ</h1><p>è¿™ä¸ªåŒºé—´å’Œæ€æƒ³å’Œä¹‹å‰çš„å‰ç¼€å’Œæ€æƒ³æœ‰ç›¸åŒä¹‹å¤„ï¼ŒåŒºåˆ«åœ¨äºè¿™ä¸ªåŒºé—´å’Œæ˜¯ç¦»æ•£åŒ–çš„ï¼Œåœ¨ä¸€ä¸ªè¾ƒå¤§çš„åŒºé—´ä¸­ï¼Œå¤šæ•°å…ƒç´ ä¸º0ï¼Œå°‘éƒ¨åˆ†æœ‰æ•°æ®ï¼Œæ±‚è¿™éƒ¨åˆ†åŒºé—´å’Œã€‚<br><span id="more"></span></p>
<ol>
<li>é¦–å…ˆå–æ“ä½œæ¶‰åŠçš„ä¸‹æ ‡ï¼Œå³å°†è¦å­˜æ•°å­—çš„ä¸‹æ ‡ä¸æ±‚å’ŒèŒƒå›´ä¸¤ç«¯çš„ä¸‹æ ‡ï¼Œå­˜å…¥å°æ•°ç»„qä¸­;</li>
<li>å¯¹æ•°ç»„qæ’åº;</li>
<li>é‡æ–°åˆ›å»ºä¸€ä¸ªå¤§å°ä¸qç›¸åŒçš„æ•°ç»„sï¼Œä»æ•°ç»„qä¸­æ‰¾åˆ°å¯¹åº”å¤§æ•°ç»„è¦å­˜å…¥æ•°æ®çš„ä½ç½®æ˜ å°„ï¼Œåœ¨sç›¸åŒä½ç½®å­˜å…¥æ•°æ®ï¼ˆqä¸­æ‰¾æ˜ å°„å¯ä»¥ç”¨äºŒåˆ†æ³•ï¼‰;</li>
<li>æ‰¾å¤§æ•°ç»„æ±‚å’ŒèŒƒå›´ä¸¤ç«¯ç‚¹åœ¨qä¸­çš„æ˜ å°„ä½ç½®ï¼Œåœ¨æ•°ç»„så¯¹åº”æ˜ å°„ä½ç½®æ±‚å’Œå³å¯ï¼Œå¯ç”¨å‰ç¼€å’Œ.<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt; alls; <span class="comment">// å­˜å‚¨æ‰€æœ‰å¾…ç¦»æ•£åŒ–çš„å€¼</span></span><br><span class="line"><span class="built_in">sort</span>(alls.<span class="built_in">begin</span>(), alls.<span class="built_in">end</span>()); <span class="comment">// å°†æ‰€æœ‰å€¼æ’åº</span></span><br><span class="line">alls.<span class="built_in">erase</span>(<span class="built_in">unique</span>(alls.<span class="built_in">begin</span>(), alls.<span class="built_in">end</span>()), alls.<span class="built_in">end</span>());   <span class="comment">// å»æ‰é‡å¤å…ƒç´ </span></span><br><span class="line"></span><br><span class="line"><span class="comment">// äºŒåˆ†æ±‚å‡ºxå¯¹åº”çš„ç¦»æ•£åŒ–çš„å€¼</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">find</span><span class="params">(<span class="type">int</span> x)</span> <span class="comment">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºxçš„ä½ç½®</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> l = <span class="number">0</span>, r = alls.<span class="built_in">size</span>() - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> mid = l + r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (alls[mid] &gt;= x) r = mid;</span><br><span class="line">        <span class="keyword">else</span> l = mid + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r + <span class="number">1</span>; <span class="comment">// æ˜ å°„åˆ°1, 2, ...n</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>åŒºé—´å’Œ</tag>
      </tags>
  </entry>
  <entry>
    <title>åŒæŒ‡é’ˆ</title>
    <url>/2023/08/06/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/6.%E5%8F%8C%E6%8C%87%E9%92%88/</url>
    <content><![CDATA[<h1 id="åŒæŒ‡é’ˆ"><a href="#åŒæŒ‡é’ˆ" class="headerlink" title="åŒæŒ‡é’ˆ"></a>åŒæŒ‡é’ˆ</h1><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; n; i ++ )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (j &lt; i &amp;&amp; <span class="built_in">check</span>(i, j)) j ++ ;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…·ä½“é—®é¢˜çš„é€»è¾‘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¸¸è§é—®é¢˜åˆ†ç±»ï¼š</p>
<ol>
<li>å¯¹äºä¸€ä¸ªåºåˆ—ï¼Œç”¨ä¸¤ä¸ªæŒ‡é’ˆç»´æŠ¤ä¸€æ®µåŒºé—´</li>
<li>å¯¹äºä¸¤ä¸ªåºåˆ—ï¼Œç»´æŠ¤æŸç§æ¬¡åºï¼Œæ¯”å¦‚å½’å¹¶æ’åºä¸­åˆå¹¶ä¸¤ä¸ªæœ‰åºåºåˆ—çš„æ“ä½œ</li>
</ol>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>åŒæŒ‡é’ˆ</tag>
      </tags>
  </entry>
  <entry>
    <title>èƒŒåŒ…é—®é¢˜</title>
    <url>/2023/09/03/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/9.%E8%83%8C%E5%8C%85%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="èƒŒåŒ…é—®é¢˜"><a href="#èƒŒåŒ…é—®é¢˜" class="headerlink" title="èƒŒåŒ…é—®é¢˜"></a>èƒŒåŒ…é—®é¢˜</h1><span id="more"></span>
<h2 id="01èƒŒåŒ…"><a href="#01èƒŒåŒ…" class="headerlink" title="01èƒŒåŒ…"></a>01èƒŒåŒ…</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/ç®—æ³•å­¦ä¹ /01èƒŒåŒ….png" alt="01èƒŒåŒ…"></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> n;              <span class="comment">// ç‰©å“æ€»æ•°</span></span><br><span class="line"><span class="type">int</span> m;              <span class="comment">// èƒŒåŒ…å®¹é‡</span></span><br><span class="line"><span class="type">int</span> W[n<span class="number">+1</span>];           <span class="comment">// é‡é‡ </span></span><br><span class="line"><span class="type">int</span> V[n<span class="number">+1</span>];           <span class="comment">// ä»·å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------äºŒç»´å½¢å¼---------------</span></span><br><span class="line"><span class="type">int</span> f[n<span class="number">+1</span>][m<span class="number">+1</span>];    <span class="comment">// f[i][j]è¡¨ç¤ºåœ¨è€ƒè™‘å‰iä¸ªç‰©å“åï¼ŒèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= m; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(j &lt; W[i]) </span><br><span class="line">        <span class="comment">//  å½“å‰é‡é‡è£…ä¸è¿›ï¼Œä»·å€¼ç­‰äºå‰i-1ä¸ªç‰©å“</span></span><br><span class="line">            f[i][j] = f[i<span class="number">-1</span>][j];      </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        <span class="comment">// èƒ½è£…ï¼Œéœ€åˆ¤æ–­  </span></span><br><span class="line">            f[i][j] = <span class="built_in">max</span>(f[i<span class="number">-1</span>][j], f[i<span class="number">-1</span>][j-W[i]] + V[i]); </span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">cout &lt;&lt; f[n][m];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------ä¸€ç»´å½¢å¼---------------</span></span><br><span class="line"><span class="type">int</span> f[m<span class="number">+1</span>];   <span class="comment">// f[j]è¡¨ç¤ºèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = M; j &gt;= W[i]; --j)</span><br><span class="line">        f[j] = <span class="built_in">max</span>(f[j], f[j - W[i]] + V[i]);           <span class="comment">// æ³¨æ„æ˜¯å€’åºï¼Œå¦åˆ™å‡ºç°å†™åè¯»é”™è¯¯</span></span><br><span class="line">cout &lt;&lt; f[m];           <span class="comment">// æ³¨æ„æ˜¯mä¸æ˜¯n</span></span><br></pre></td></tr></table></figure>
<p><a href="https://www.nowcoder.com/questionTerminal/708f0442863a46279cce582c4f508658">ç‰›å®¢01èƒŒåŒ…</a></p>
<h2 id="å®Œå…¨èƒŒåŒ…"><a href="#å®Œå…¨èƒŒåŒ…" class="headerlink" title="å®Œå…¨èƒŒåŒ…"></a>å®Œå…¨èƒŒåŒ…</h2><script type="math/tex; mode=display">
f(i,j)=max{f(iâˆ’1,j),f(iâˆ’1,jâˆ’vi)+wi,f(iâˆ’1,jâˆ’2vi)+2wi,â‹¯,f(iâˆ’1,jâˆ’kvi)+kwi}</script><script type="math/tex; mode=display">
f(i,jâˆ’vi)=max{f(iâˆ’1,jâˆ’vi),f(iâˆ’1,jâˆ’2vi)+wi,f(iâˆ’1,jâˆ’3vi)+2wi,â‹¯,f(iâˆ’1,jâˆ’kvi)+(kâˆ’1)wi}</script><script type="math/tex; mode=display">
f(i,jâˆ’vi)+wi=max{f(iâˆ’1,jâˆ’vi)+w,f(iâˆ’1,jâˆ’2vi)+2wi,f(iâˆ’1,jâˆ’3vi)+3wi,â‹¯,f(iâˆ’1,jâˆ’kvi)+kwi}</script><p>æ‰€ä»¥</p>
<script type="math/tex; mode=display">
f(i,j)=max{f(iâˆ’1,j),f(i,jâˆ’vi)+wi}</script><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/ç®—æ³•å­¦ä¹ /å®Œå…¨èƒŒåŒ….png" alt="å®Œå…¨èƒŒåŒ…"><br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> n;              <span class="comment">// ç‰©å“æ€»æ•°</span></span><br><span class="line"><span class="type">int</span> m;              <span class="comment">// èƒŒåŒ…å®¹é‡</span></span><br><span class="line"><span class="type">int</span> W[n<span class="number">+1</span>];           <span class="comment">// é‡é‡ </span></span><br><span class="line"><span class="type">int</span> V[m<span class="number">+1</span>];           <span class="comment">// ä»·å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------äºŒç»´å½¢å¼---------------</span></span><br><span class="line"><span class="comment">// æœªä¼˜åŒ–</span></span><br><span class="line"><span class="type">int</span> f[n<span class="number">+1</span>][m<span class="number">+1</span>];    <span class="comment">// f[i][j]è¡¨ç¤ºåœ¨è€ƒè™‘å‰iä¸ªç‰©å“åï¼ŒèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= m; j++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k * W[i] &lt;= j; k++)</span><br><span class="line">            f[i][j] = <span class="built_in">max</span>(f[i][j], f[i - <span class="number">1</span>][j - k * W[i]] + k * V[i]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// å·²ä¼˜åŒ–</span></span><br><span class="line"><span class="type">int</span> f[n<span class="number">+1</span>][m<span class="number">+1</span>];    <span class="comment">// f[i][j]è¡¨ç¤ºåœ¨è€ƒè™‘å‰iä¸ªç‰©å“åï¼ŒèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">1</span>; j &lt;= m; ++j)</span><br><span class="line">        <span class="keyword">if</span>(j &lt; W[i]) f[i][j] = f[i<span class="number">-1</span>][j];   <span class="comment">//  å½“å‰é‡é‡è£…ä¸è¿›ï¼Œä»·å€¼ç­‰äºå‰i-1ä¸ªç‰©å“   </span></span><br><span class="line">        <span class="keyword">else</span> f[i][j] = <span class="built_in">max</span>(f[i<span class="number">-1</span>][j], f[i][j-W[i]] + V[i]); <span class="comment">// èƒ½è£…ï¼Œéœ€åˆ¤æ–­  </span></span><br><span class="line">cout &lt;&lt; f[n][m];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------------ä¸€ç»´å½¢å¼---------------</span></span><br><span class="line"><span class="type">int</span> f[m<span class="number">+1</span>];   <span class="comment">// f[j]è¡¨ç¤ºèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; ++i) </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j = W[i]; j &lt;= m; ++j)</span><br><span class="line">        f[j] = <span class="built_in">max</span>(f[j], f[j - W[i]] + V[i]);           <span class="comment">// æ³¨æ„æ˜¯å€’åºï¼Œå¦åˆ™å‡ºç°å†™åè¯»é”™è¯¯</span></span><br><span class="line">cout &lt;&lt; f[m<span class="number">+1</span>];           <span class="comment">// æ³¨æ„æ˜¯mä¸æ˜¯n</span></span><br></pre></td></tr></table></figure><br><a href="https://www.acwing.com/problem/content/description/3/">å®Œå…¨èƒŒåŒ…é¢˜ç›®</a></p>
<h2 id="å¤šé‡èƒŒåŒ…"><a href="#å¤šé‡èƒŒåŒ…" class="headerlink" title="å¤šé‡èƒŒåŒ…"></a>å¤šé‡èƒŒåŒ…</h2><p>å¤šé‡èƒŒåŒ…å¯ä»¥è½¬åŒ–ä¸º01èƒŒåŒ…ç„¶åä½¿ç”¨äºŒè¿›åˆ¶ä¼˜åŒ–è¿›è¡Œä¼˜åŒ–ã€‚<br>æœ´ç´ åšæ³•<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> n;              <span class="comment">// ç‰©å“æ€»æ•°</span></span><br><span class="line"><span class="type">int</span> m;              <span class="comment">// èƒŒåŒ…å®¹é‡</span></span><br><span class="line"><span class="type">int</span> W[n<span class="number">+1</span>];           <span class="comment">// é‡é‡ </span></span><br><span class="line"><span class="type">int</span> V[n<span class="number">+1</span>];           <span class="comment">// ä»·å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------æœªä¼˜åŒ–ï¼ˆå®Œå…¨èƒŒåŒ…æ¨¡æ¿ï¼‰----------------------</span></span><br><span class="line"><span class="type">int</span> f[n<span class="number">+1</span>][m+!];    <span class="comment">// f[i][j]è¡¨ç¤ºåœ¨è€ƒè™‘å‰iä¸ªç‰©å“åï¼ŒèƒŒåŒ…å®¹é‡ä¸ºjæ¡ä»¶ä¸‹çš„æœ€å¤§ä»·å€¼</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i++)</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= m; j++)</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt;= S[i] &amp;&amp; k * W[i] &lt;= j; k++)</span><br><span class="line">            f[i][j] = <span class="built_in">max</span>(f[i][j], f[i - <span class="number">1</span>][j - k * W[i]] + k * V[i]);</span><br></pre></td></tr></table></figure><br>äºŒè¿›åˆ¶ä¼˜åŒ–åŸç†<br>æˆ‘ä»¬ç”¨$A_{i,j}$ ä»£è¡¨ç¬¬ $i$ ç§ç‰©å“æ‹†åˆ†å‡ºçš„ç¬¬ $j$ ä¸ªç‰©å“ã€‚</p>
<p>åœ¨æœ´ç´ çš„åšæ³•ä¸­ï¼Œ$\forall j\le k<em>iï¼ŒA</em>{i,j}$ å‡è¡¨ç¤ºç›¸åŒç‰©å“ã€‚é‚£ä¹ˆæˆ‘ä»¬æ•ˆç‡ä½çš„åŸå› ä¸»è¦åœ¨äºæˆ‘ä»¬è¿›è¡Œäº†å¤§é‡é‡å¤æ€§çš„å·¥ä½œã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œæˆ‘ä»¬è€ƒè™‘äº†ã€ŒåŒæ—¶é€‰ $A<em>{i,1},A</em>{i,2}$ã€ä¸ã€ŒåŒæ—¶é€‰ $A<em>{i,2},A</em>{i,3}$ã€è¿™ä¸¤ä¸ªå®Œå…¨ç­‰æ•ˆçš„æƒ…å†µã€‚è¿™æ ·çš„é‡å¤æ€§å·¥ä½œæˆ‘ä»¬è¿›è¡Œäº†è®¸å¤šæ¬¡ã€‚é‚£ä¹ˆä¼˜åŒ–æ‹†åˆ†æ–¹å¼å°±æˆä¸ºäº†è§£å†³é—®é¢˜çš„çªç ´å£ã€‚<br>å…·ä½“åœ°è¯´å°±æ˜¯ä»¤ $A_{i,j}\left(j\in\left[0,\lfloor \log_2(k_i+1)\rfloor-1\right]\right)$ åˆ†åˆ«è¡¨ç¤ºç”± $2^{j}$ ä¸ªå•ä¸ªç‰©å“ã€Œæ†ç»‘ã€è€Œæˆçš„å¤§ç‰©å“ã€‚ç‰¹æ®Šåœ°ï¼Œè‹¥ $k_i+1$ ä¸æ˜¯ 2 çš„æ•´æ•°æ¬¡å¹‚ï¼Œåˆ™éœ€è¦åœ¨æœ€åæ·»åŠ ä¸€ä¸ªç”± $k_i-2^{\lfloor \log_2(k_i+1)\rfloor-1}$ ä¸ªå•ä¸ªç‰©å“ã€Œæ†ç»‘ã€è€Œæˆçš„å¤§ç‰©å“ç”¨äºè¡¥è¶³ã€‚<br>ä¸¾å‡ ä¸ªä¾‹å­ï¼š<br>6=1+2+3<br>8=1+2+4+1<br>18=1+2+4+8+3<br>31=1+2+4+8+16<br>æ˜¾ç„¶ï¼Œé€šè¿‡ä¸Šè¿°æ‹†åˆ†æ–¹å¼ï¼Œå¯ä»¥è¡¨ç¤ºä»»æ„ $\le k_i$ ä¸ªç‰©å“çš„ç­‰æ•ˆé€‰æ‹©æ–¹å¼ã€‚å°†æ¯ç§ç‰©å“æŒ‰ç…§ä¸Šè¿°æ–¹å¼æ‹†åˆ†åï¼Œä½¿ç”¨ 0-1 èƒŒåŒ…çš„æ–¹æ³•è§£å†³å³å¯ã€‚<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// è¯»å…¥ç‰©å“ä¸ªæ•°æ—¶é¡ºä¾¿æ‰“åŒ…</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è¾“å…¥ ä»·å€¼ã€ä½“ç§¯ã€æ•°é‡</span></span><br><span class="line">    cin&gt;&gt;a&gt;&gt;b&gt;&gt;s;</span><br><span class="line">    <span class="type">int</span> k = <span class="number">1</span>;      <span class="comment">// å½“å‰åŒ…è£¹å¤§å°</span></span><br><span class="line">    <span class="keyword">while</span> (k &lt;= s)</span><br><span class="line">    &#123;</span><br><span class="line">        cnt ++ ;            <span class="comment">// å®é™…ç‰©å“ç§æ•°</span></span><br><span class="line">        W[cnt] = a * k;</span><br><span class="line">        V[cnt] = b * k;</span><br><span class="line">        s -= k;</span><br><span class="line">        k *= <span class="number">2</span>;             <span class="comment">// å€å¢åŒ…è£¹å¤§å°</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ä¸è¶³çš„å•ç‹¬æ”¾ä¸€ä¸ªï¼Œå³C</span></span><br><span class="line">        cnt ++ ;</span><br><span class="line">        W[cnt] = a * s;</span><br><span class="line">        V[cnt] = b * s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">n = cnt;        <span class="comment">// æ›´æ–°ç‰©å“ç§æ•°</span></span><br><span class="line"><span class="comment">// è½¬æ¢æˆ01èƒŒåŒ…é—®é¢˜</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i ++ )</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = m; j &gt;= W[i]; j -- )</span><br><span class="line">        f[j] = <span class="built_in">max</span>(f[j], f[j - W[i]] + V[i]);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; f[m] &lt;&lt; endl;</span><br></pre></td></tr></table></figure></p>
<h2 id="åˆ†ç»„èƒŒåŒ…"><a href="#åˆ†ç»„èƒŒåŒ…" class="headerlink" title="åˆ†ç»„èƒŒåŒ…"></a>åˆ†ç»„èƒŒåŒ…</h2><p>èµ·å§‹å°±æ˜¯å¯¹æ¯ä¸ªç»„è¿›è¡Œ01èƒŒåŒ…<br>$f(i,j)=max{f(iâˆ’1,j),f(iâˆ’1,jâˆ’v(i,k))+w(i,k)}$<br><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> n;              <span class="comment">// ç‰©å“æ€»æ•°</span></span><br><span class="line"><span class="type">int</span> m;              <span class="comment">// èƒŒåŒ…å®¹é‡</span></span><br><span class="line"><span class="type">int</span> W[n<span class="number">+1</span>][s<span class="number">+1</span>];         <span class="comment">// é‡é‡ </span></span><br><span class="line"><span class="type">int</span> V[n<span class="number">+1</span>][s<span class="number">+1</span>];         <span class="comment">// ä»·å€¼</span></span><br><span class="line"><span class="type">int</span> S[n<span class="number">+1</span>];           <span class="comment">// å„ç»„ç‰©å“ç§æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å…¥æ•°æ®</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i ++ )</span><br><span class="line"> &#123;</span><br><span class="line">     cin &gt;&gt; S[i];</span><br><span class="line">     <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">1</span>; j &lt;= S[i]; j ++ )</span><br><span class="line">         cin &gt;&gt; W[i][j] &gt;&gt; V[i][j];</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= n; i ++ )</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> j = m; j &gt;= <span class="number">1</span>; j -- )</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">1</span>; k &lt;= S[i]; k ++ )</span><br><span class="line">            <span class="keyword">if</span> (W[i][k] &lt;= j)</span><br><span class="line">                f[j] = <span class="built_in">max</span>(f[j], f[j - W[i][k]] + V[i][k]);</span><br><span class="line"></span><br><span class="line">cout &lt;&lt; f[m] &lt;&lt; endl;</span><br></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>èƒŒåŒ…é—®é¢˜</tag>
      </tags>
  </entry>
  <entry>
    <title>åŒºé—´åˆå¹¶</title>
    <url>/2023/08/06/%E7%AE%97%E6%B3%95%E5%AD%A6%E4%B9%A0/8.%E5%8C%BA%E9%97%B4%E5%90%88%E5%B9%B6/</url>
    <content><![CDATA[<h1 id="åŒºé—´åˆå¹¶"><a href="#åŒºé—´åˆå¹¶" class="headerlink" title="åŒºé—´åˆå¹¶"></a>åŒºé—´åˆå¹¶</h1><p>ç»™å®šå¤šä¸ªåŒºé—´ï¼Œå°†æœ‰é‡å çš„åˆå¹¶åˆ°ä¸€èµ·<br><span id="more"></span></p>
<ol>
<li>æŒ‰åŒºé—´çš„å·¦ç«¯ç‚¹æ’åºï¼›</li>
<li>ä»å·¦åˆ°å³æ‰«æï¼Œç»´æŠ¤ä¸€ä¸ªå½“å‰åŒºé—´ï¼ˆéšç€éå†ï¼Œè‹¥ç›¸äº¤åˆ™åŒºé—´å˜é•¿ï¼‰</li>
<li>æ¯æ¬¡éå†çš„åŒºé—´å’Œå½“å‰åŒºé—´æœ‰ä¸‰ç§æƒ…å†µåˆ†ç±»è®¨è®ºï¼š<ul>
<li>å³ç«¯ç‚¹å°äºå½“å‰åŒºé—´å³ç«¯ç‚¹ï¼Œå½“å‰åŒºé—´ä¸å˜ï¼›</li>
<li>å³ç«¯ç‚¹å¤§äºå½“å‰åŒºé—´å³ç«¯ç‚¹ï¼Œå½“å‰åŒºé—´å˜é•¿ï¼›</li>
<li>å·¦ç«¯ç‚¹å¤§äºå½“å‰åŒºé—´å³ç«¯ç‚¹ï¼Œå°†è¯¥åŒºé—´ç½®ä¸ºå½“å‰åŒºé—´ï¼›</li>
</ul>
</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å°†æ‰€æœ‰å­˜åœ¨äº¤é›†çš„åŒºé—´åˆå¹¶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">merge</span><span class="params">(vector&lt;PII&gt; &amp;segs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    vector&lt;PII&gt; res;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sort</span>(segs.<span class="built_in">begin</span>(), segs.<span class="built_in">end</span>());</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> st = <span class="number">-2e9</span>, ed = <span class="number">-2e9</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> seg : segs)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (ed &lt; seg.first)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (st != <span class="number">-2e9</span>) res.<span class="built_in">push_back</span>(&#123;st, ed&#125;);</span><br><span class="line">            st = seg.first, ed = seg.second;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> ed = <span class="built_in">max</span>(ed, seg.second);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (st != <span class="number">-2e9</span>) res.<span class="built_in">push_back</span>(&#123;st, ed&#125;);</span><br><span class="line">    segs = res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h2><p><a href="https://leetcode.cn/problems/merge-intervals/description/">åˆå¹¶åŒºé—´</a></p>
]]></content>
      <categories>
        <category>ç®—æ³•å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>acwingç®—æ³•å­¦ä¹ </tag>
        <tag>åŒºé—´åˆå¹¶</tag>
      </tags>
  </entry>
  <entry>
    <title>Background Suppression Network for Weakly-supervised Temporal Action Localization</title>
    <url>/2021/06/15/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Background%20Suppression%20Network/</url>
    <content><![CDATA[<h1 id="Background-Suppression-Network-for-Weakly-supervised-Temporal-Action-Localization"><a href="#Background-Suppression-Network-for-Weakly-supervised-Temporal-Action-Localization" class="headerlink" title="Background Suppression Network for Weakly-supervised Temporal Action Localization"></a>Background Suppression Network for Weakly-supervised Temporal Action Localization</h1><h2 id="æå‡ºé—®é¢˜ï¼š"><a href="#æå‡ºé—®é¢˜ï¼š" class="headerlink" title="æå‡ºé—®é¢˜ï¼š"></a>æå‡ºé—®é¢˜ï¼š</h2><p>å¼±ç›‘ç£è§†é¢‘åŠ¨ä½œå®šä½ä¸­ï¼Œå…ˆå‰çš„æ–¹æ³•èšåˆå¸§çº§åˆ«çš„ç±»åˆ†æ•°ï¼Œä»¥äº§ç”Ÿè§†é¢‘çº§åˆ«çš„é¢„æµ‹å¹¶ä»è§†é¢‘çº§åˆ«çš„åŠ¨ä½œä¸­å­¦ä¹ ã€‚æ­¤æ–¹æ³•æ— æ³•å®Œå…¨æ¨¡æ‹Ÿé—®é¢˜ï¼Œå› ä¸ºèƒŒæ™¯å¸§è¢«è¿«é”™è¯¯åœ°åˆ†ç±»ä¸ºè¡ŒåŠ¨ç±»åˆ«ï¼Œæ— æ³•å‡†ç¡®é¢„æµ‹è§†é¢‘çº§æ ‡ç­¾ã€‚</p>
<h2 id="åšäº†ä»€ä¹ˆï¼š"><a href="#åšäº†ä»€ä¹ˆï¼š" class="headerlink" title="åšäº†ä»€ä¹ˆï¼š"></a>åšäº†ä»€ä¹ˆï¼š</h2><p>è®¾è®¡äº†èƒŒæ™¯æŠ‘åˆ¶ç½‘ç»œï¼ˆBaSNetï¼‰ï¼Œè¯¥ç½‘ç»œå¼•å…¥äº†èƒŒæ™¯çš„è¾…åŠ©ç±»ï¼Œå¹¶å…·æœ‰å¸¦æœ‰éå¯¹ç§°åº¦é‡è®­ç»ƒç­–ç•¥çš„ä¸¤åˆ†æ”¯æƒé‡å…±äº«ä½“ç³»ç»“æ„ã€‚è¿™ä½¿BaSNetå¯ä»¥æŠ‘åˆ¶æ¥è‡ªèƒŒæ™¯å¸§çš„æ¿€æ´»ï¼Œä»è€Œæé«˜å®šä½æ€§èƒ½ã€‚å¹¿æ³›çš„å®éªŒè¯æ˜äº†BaSNetçš„æ•ˆç‡åŠå…¶åœ¨æœ€æµè¡Œçš„åŸºå‡†THUMOS14å’ŒActivityNetä¸Šä¼˜äºæœ€æ–°æ–¹æ³•çš„ä¼˜è¶Šæ€§</p>
<p>BaSNetï¼šæœ‰ä¸¤æ¡åˆ†æ”¯Base branch and Suppression branch<br><span id="more"></span></p>
<h2 id="æ€ä¹ˆåšçš„ï¼š"><a href="#æ€ä¹ˆåšçš„ï¼š" class="headerlink" title="æ€ä¹ˆåšçš„ï¼š"></a>æ€ä¹ˆåšçš„ï¼š</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411104708142.png" alt="image-20210411104708142"></p>
<ol>
<li>Suppressionåˆ†æ”¯åŒ…å«ä¸€ä¸ªè¿‡æ»¤æ¨¡å—ï¼Œè¯¥æ¨¡å—å­¦ä¹ è¿‡æ»¤å‡ºèƒŒæ™¯å¸§ä»¥æœ€ç»ˆæŠ‘åˆ¶CASä¸­æ¥è‡ªå®ƒä»¬çš„æ¿€æ´»</li>
<li>ä»–ä»¬çš„åŸ¹è®­ç›®æ ‡æ˜¯ä¸åŒçš„ã€‚ Baseåˆ†æ”¯çš„ç›®çš„æ˜¯å°†æ’å…¥è§†é¢‘åˆ†ç±»ä¸ºå…¶åŸå§‹åŠ¨ä½œç±»å’ŒèƒŒæ™¯ç±»çš„æ ·æœ¬ã€‚å¦ä¸€æ–¹é¢ï¼Œè®­ç»ƒå¸¦æœ‰è¿‡æ»¤æ¨¡å—çš„Suppressionåˆ†æ”¯ä»¥æœ€å°åŒ–èƒŒæ™¯ç±»å¾—åˆ†ï¼Œè€ŒèƒŒæ™¯ç±»å¾—åˆ†ä¸åŸå§‹åŠ¨ä½œç±»çš„ç›®æ ‡ç›¸åŒã€‚æƒé‡å…±äº«ç­–ç•¥å¯ä»¥é˜²æ­¢åˆ†æ”¯åœ¨ç»™å‡ºç›¸åŒè¾“å…¥æ—¶åŒæ—¶æ»¡è¶³å…¶ä¸¤ä¸ªç›®æ ‡ã€‚å› æ­¤ï¼Œè¿‡æ»¤æ¨¡å—æ˜¯è§£å†³èƒŒæ™¯çš„å”¯ä¸€å…³é”®ï¼Œå¹¶ä¸”ç»è¿‡åŸ¹è®­å¯ä»¥æŠ‘åˆ¶æ¥è‡ªèƒŒæ™¯æ¡†æ¶çš„æ¿€æ´»ï¼Œä»è€ŒåŒæ—¶å®ç°ä¸¤ä¸ªç›®æ ‡ã€‚è¿™å‡å°‘äº†èƒŒæ™¯å¸§çš„å¹²æ‰°å¹¶æé«˜äº†åŠ¨ä½œå®šä½æ€§èƒ½</li>
</ol>
<h3 id="ç‰¹å¾æå–ï¼š"><a href="#ç‰¹å¾æå–ï¼š" class="headerlink" title="ç‰¹å¾æå–ï¼š"></a>ç‰¹å¾æå–ï¼š</h3><p>ç”±äºå­˜å‚¨å™¨é™åˆ¶ï¼Œæˆ‘ä»¬é¦–å…ˆå°†æ¯ä¸ªè¾“å…¥è§†é¢‘$v<em>n$åˆ†æˆ16å¸§ä¸é‡å çš„$L_n$æ®µï¼Œå³$v_n = {S</em>{n,l} }^{Ln}<em>{l = 1}$ã€‚ä¸ºäº†åº”å¯¹è§†é¢‘é•¿åº¦çš„è¾ƒå¤§å˜åŒ–ï¼Œæˆ‘ä»¬ä»æ¯ä¸ªè§†é¢‘ä¸­é‡‡æ ·äº†å›ºå®šæ•°é‡çš„Tæ®µã€‚ç„¶åï¼Œæˆ‘ä»¬å°†é‡‡æ ·çš„RGBå’Œflowåˆ†æ®µè¾“å…¥åˆ°é¢„è®­ç»ƒçš„ç‰¹å¾æå–å™¨ä¸­ï¼Œä»¥åˆ†åˆ«ç”Ÿæˆ$F$ç»´çš„ç‰¹å¾å‘é‡$x</em>{n,t}^{RGB}$å’Œ$x<em>{n,t}^{flow}$ã€‚ç„¶åï¼Œå°†RGBå’Œflowç‰¹å¾è¿æ¥èµ·æ¥ä»¥æ„å»ºå®Œæ•´çš„ç‰¹å¾$x</em>{n,t}$ï¼Œç„¶åå°†å®ƒä»¬æ²¿ç€æ—¶é—´ç»´åº¦å †å ä»¥å½¢æˆé•¿åº¦ä¸ºTçš„ç‰¹å¾å›¾,å³$X<em>n=[x</em>{n,1},â€¦,x_{n,T}]$</p>
<p><strong>å°ç»“ï¼š</strong>è¿™ä¸€æ­¥å°±æ˜¯æ™®é€šçš„ç‰¹å¾æå–ï¼Œæå–RGBå’Œflowå…‰æµç‰¹å¾ï¼Œç„¶åå°†å®ƒä»¬è¿æ¥ä¸€ä¸‹æ¯”è¾ƒç®€å•ã€‚</p>
<h3 id="Base-branch"><a href="#Base-branch" class="headerlink" title="Base branch"></a>Base branch</h3><p>ä¸ºäº†é¢„æµ‹çº¿æ®µçº§åˆ«çš„ç±»åˆ«å¾—åˆ†ï¼Œæˆ‘ä»¬é€šè¿‡å°†ç‰¹å¾å›¾é¦ˆé€åˆ°æ—¶é—´ä¸€ç»´å·ç§¯å±‚ä¸­æ¥ç”ŸæˆCAS ï¼ˆç±»æ¿€æ´»åºåˆ—ï¼‰ï¼Œå…¶ä¸­æ¯ä¸ªçº¿æ®µéƒ½æœ‰å…¶ç±»åˆ«å¾—åˆ†ï¼Œååº”äº†å¯¹åº”ç±»åˆ«çš„æ¦‚ç‡ã€‚å¯¹äºè§†é¢‘$v_n$ï¼Œå¯ä»¥å°†å…¶å½¢å¼åŒ–å¦‚ä¸‹:</p>
<script type="math/tex; mode=display">
A_n=f_{conv}(X_n,\phi)</script><p>å…¶ä¸­$\phi$è¡¨ç¤ºå·ç§¯å±‚ä¸­çš„å¯è®­ç»ƒå‚æ•°ï¼Œ$A_n\in R^{(C+1)\times T}$ã€‚ä¸€ä¸ª$C+1$å°ºå¯¸æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨CåŠ¨ä½œç±»å’Œä¸€ä¸ªè¾…åŠ©ç±»ä½œä¸ºèƒŒæ™¯ã€‚</p>
<p>æ¥ç€ä½¿ç”¨top-kå‡å€¼æŠ€æœ¯ï¼Œå¯ä»¥å¦‚ä¸‹å¾—å‡ºè§†é¢‘vnçš„cç±»çš„è§†é¢‘çº§ç±»è¯„åˆ†ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411151544441.png" alt="image-20210411151544441"></p>
<p>ç„¶åï¼Œé€šè¿‡æ²¿ç±»åˆ«ç»´åº¦åº”ç”¨softmaxå‡½æ•°ï¼Œå°†è§†é¢‘çº§åˆ«çš„ç±»åˆ«å¾—åˆ†ç”¨äºé¢„æµ‹æ¯ä¸ªç±»åˆ«çš„æ ·æœ¬çš„æ¦‚ç‡ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411151640191.png" alt="image-20210411151640191"></p>
<p>ä¸ºäº†è®­ç»ƒç½‘ç»œï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªç±»åˆ«å®šä¹‰ä¸€ä¸ªå…·æœ‰äºŒè¿›åˆ¶äº¤å‰ç†µæŸå¤±çš„æŸå¤±å‡½æ•°$L_{base}$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411151931573.png" alt="image-20210411151931573"></p>
<p>å…¶ä¸­$y^{base}<em>n=[y</em>{n;1},â€¦,y_{n;C},1]^T\in \mathbb R^{C+1}$,å…¶ä¸­æœ€åä¸€ä¸ª1æ˜¯èƒŒæ™¯ç±»ï¼Œå› ä¸ºåŸºç¡€åˆ†æ”¯æ²¡æœ‰å»é™¤èƒŒæ™¯æ‰€ä»¥è®¾ç½®ä¸º1è¿™å’Œåé¢çš„æŠ‘åˆ¶åˆ†æ”¯æƒ³å¯¹åº”ã€‚</p>
<p><strong>å°ç»“ï¼š</strong>å¯ä»¥çŸ¥é“Base branchåªæ˜¯ç®€å•çš„è¿›è¡Œè®­ç»ƒï¼Œé»˜è®¤æ˜¯æœ‰èƒŒæ™¯ç±»çš„ã€‚</p>
<h3 id="Suppression-branch"><a href="#Suppression-branch" class="headerlink" title="Suppression branch"></a>Suppression branch</h3><p>ä¸Baseåˆ†æ”¯ä¸åŒï¼ŒSuppressionåˆ†æ”¯åœ¨å…¶å‰é¢åŒ…å«ä¸€ä¸ªè¿‡æ»¤æ¨¡å—ï¼Œè¯¥æ¨¡å—è¢«é’ˆå¯¹èƒŒæ™¯ç±»çš„ç›¸åçš„è®­ç»ƒç›®æ ‡è®­ç»ƒä¸ºæŠ‘åˆ¶èƒŒæ™¯å¸§ã€‚è¿‡æ»¤æ¨¡å—ç”±ä¸¤ä¸ªæ—¶é—´ä¸€ç»´å·ç§¯å±‚å’Œéšåçš„Så‹å‡½æ•°ç»„æˆã€‚è¿‡æ»¤æ¨¡å—çš„è¾“å‡ºæ˜¯å‰æ™¯æƒé‡$W_nâˆˆR^T$ï¼ŒèŒƒå›´ä»0åˆ°1ã€‚æ¥è‡ªè¿‡æ»¤æ¨¡å—çš„å‰æ™¯æƒé‡åœ¨æ—¶é—´ç»´åº¦ä¸Šä¸ç‰¹å¾å›¾ç›¸ä¹˜ä»¥è¿‡æ»¤å‡ºèƒŒæ™¯å¸§ã€‚æ­¤æ­¥éª¤å¯ä»¥è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411153148668.png" alt="image-20210411153148668"></p>
<p>æ¥ç€çš„è¯å’Œå‰é¢Base åˆ†æ”¯çš„è®­ç»ƒç±»ä¼¼ï¼Œåªæ˜¯å°†$\acute{X}_n$ ä»£æ›¿$X_n$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210413103100493.png" alt="image-20210413103100493"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210413103610515.png" alt="image-20210413103610515"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210413103127374.png" alt="image-20210413103127374"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210413103139512.png" alt="image-20210413103139512"></p>
<p>å…¶ä¸­$y^{supp}<em>n=[y</em>{n;1},â€¦,y_{n;C},0]^T\in \mathbb R^{C+1}$,å…¶ä¸­æœ€åä¸€ä¸ª1æ˜¯èƒŒæ™¯ç±»ï¼Œå› ä¸ºåŸºç¡€åˆ†æ”¯æ²¡æœ‰å»é™¤èƒŒæ™¯æ‰€ä»¥è®¾ç½®ä¸º0ï¼Œå› ä¸ºæŠ‘åˆ¶åˆ†æ”¯ç»è¿‡äº†å‰é¢çš„è¿‡æ»¤æ¨¡å—ï¼Œé»˜è®¤æ˜¯è¿‡æ»¤æ‰èƒŒæ™¯ã€‚</p>
<p><strong>å°ç»“ï¼š</strong>æŠ‘åˆ¶åˆ†æ”¯è®¾ç½®èƒŒæ™¯ç±»ä¸º0ï¼Œç›®çš„å°±æ˜¯è®­ç»ƒè¿‡æ»¤æ¨¡å—ï¼Œä»–ä»¬ä¿©å…±äº«äº†å‰é¢çš„ä¸€ç»´æƒé‡ï¼Œä½†æ˜¯æœ€ç»ˆä¸€ä¸ªæœ‰èƒŒæ™¯ä¸€ä¸ªæ²¡æœ‰èƒŒæ™¯ï¼Œä¸¤ä¸ªåˆ†æ”¯çš„åŒºåˆ«å°±åœ¨äºè¿‡æ»¤æ¨¡å—ï¼Œè¿™ä¹Ÿæ˜¯æ‰€è°“çš„éå¯¹ç§°å…±äº«æƒé‡è®­ç»ƒã€‚</p>
<h3 id="Joint-training"><a href="#Joint-training" class="headerlink" title="Joint training"></a>Joint training</h3><p>æˆ‘ä»¬è”åˆè®­ç»ƒbaseåˆ†æ”¯å’ŒSuppression åˆ†æ”¯ã€‚æˆ‘ä»¬éœ€è¦ä¼˜åŒ–çš„æ€»ä½“æŸå¤±å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Background Suppression Network for Weakly-supervised Temporal Action Localization/image-20210411154052601.png" alt="image-20210411154052601"></p>
<p>å‰ä¸¤ä¸ªåœ¨ä¸Šé¢å·²ç»ä»‹ç»äº†ï¼Œè€Œ$L_{norm}$:</p>
<script type="math/tex; mode=display">
L_{norm}=\frac{1}{N}\sum_{n=1}^N|w_n|</script><p>è¿™ä¸ªå…¶å®å¯¹è®­ç»ƒçš„è¿‡æ»¤æ¨¡å—æƒé‡è¿›è¡Œ$L_1$æ­£åˆ™ï¼Œç›®çš„æ˜¯ä½¿å¾—æƒé‡æ›´åŠ åå‘0æˆ–è€…1ï¼Œç®€å•ç†è§£å°±æ˜¯èƒŒæ™¯å¸§å°±æ˜¯0è¿›è¡ŒæŠ‘åˆ¶ï¼ŒåŠ¨ä½œå¸§å°±æ˜¯1ä¸å—å½±å“ã€‚æœ¯è¯­å°±æ˜¯æ›´å¥½çš„è¯†åˆ«å…³é”®å¸§</p>
<p><strong>å°ç»“ï¼š</strong>è¿™ä¸ª$L_{norm}$çš„è®¾è®¡è¿˜æ˜¯æ¯”è¾ƒå·§å¦™ï¼Œå¯èƒ½ä¹Ÿæ˜¯æˆ‘æ¥è§¦æ¯”è¾ƒå°‘</p>
<h3 id="Classification-and-Localization"><a href="#Classification-and-Localization" class="headerlink" title="Classification and Localization"></a>Classification and Localization</h3><p>åœ¨æè¿°äº†æˆ‘ä»¬çš„æ¨¡å‹æ˜¯å¦‚ä½•é…ç½®å’Œè®­ç»ƒçš„ä¹‹åï¼Œæˆ‘ä»¬è½¬å‘è®¨è®ºå®ƒåœ¨æµ‹è¯•æ—¶å¦‚ä½•å·¥ä½œã€‚ç”±äºæˆ‘ä»¬ä½¿ç”¨è¿‡æ»¤æ¨¡å—é˜»æ­¢æ¥è‡ªèƒŒæ™¯æ¡†æ¶çš„æ¿€æ´»ï¼Œå› æ­¤ä½¿ç”¨Suppressionåˆ†æ”¯çš„è¾“å‡ºè¿›è¡Œæ¨ç†æ˜¯åˆç†çš„ã€‚å¯¹äºåˆ†ç±»ï¼Œæˆ‘ä»¬ä¸¢å¼ƒåœ¨æ¦‚ç‡ä½äºé˜ˆå€¼$\theta<em>{class}$çš„ç±»ã€‚ç„¶åï¼Œå¯¹äºå…¶ä½™ç±»åˆ«ï¼Œæˆ‘ä»¬ä½¿ç”¨é˜ˆå€¼$\theta</em>{act}$å¯¹CASè¿›è¡Œé˜ˆå€¼é€‰æ‹©å€™é€‰ç‰‡æ®µã€‚ç„¶åï¼Œæ¯ç»„è¿ç»­çš„å€™é€‰æ®µå°†æˆä¸ºä¸€ä¸ªå»ºè®®ã€‚æˆ‘ä»¬æ ¹æ®æœ€è¿‘çš„å·¥ä½œï¼Œä½¿ç”¨å†…éƒ¨å’Œå¤–éƒ¨åŒºåŸŸä¹‹é—´çš„å¯¹æ¯”æ¥è®¡ç®—æ¯ä¸ªå»ºè®®çš„ç½®ä¿¡åº¦å¾—åˆ†ã€‚</p>
<p><strong>å°ç»“ï¼š</strong>è¿™ä¸ªåˆ†ç±»å’Œå®šä½æ¯”è¾ƒå¹³å¸¸ ï¼Œä¸å¤šä»‹ç»</p>
<h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>è¿™ç¯‡<code>Background Suppression Network for Weakly-supervised Temporal Action Localization</code>è¿˜çœŸçš„åœ¨è®¾è®¡ä¸Šå°±ååˆ†å·§å¦™ï¼Œä¸¤ä¸ªåˆ†æ”¯ä¸€ä¸ªè®­ç»ƒæœ‰èƒŒæ™¯ï¼Œä¸€ä¸ªè®­ç»ƒå´æ²¡æœ‰èƒŒæ™¯ï¼Œä¸¤ä¸ªåˆ†æ”¯çš„ä¸åŒä¹‹å¤„å°±åªæœ‰è¿‡æ»¤æ¨¡å—ï¼Œæ‰€ä»¥è¯´æ˜äº†è¿‡æ»¤æ¨¡å—çš„ä½œç”¨ã€‚æœ€ç»ˆçš„è¯ä½¿ç”¨è¿‡æ»¤åˆ†æ”¯è¾“å‡ºçš„æ¦‚ç‡å’ŒCASæ¥è¿›è¡Œå®šä½ä¹Ÿæ˜¯æ¯”è¾ƒåˆç†ã€‚</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>Background-Click Supervision for Temporal Action Localization</title>
    <url>/2022/04/29/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Background-Click%20Supervision%20for%20Temporal%20Action%20Localization/</url>
    <content><![CDATA[<h1 id="Background-Click-Supervision-for-Temporal-Action-Localization"><a href="#Background-Click-Supervision-for-Temporal-Action-Localization" class="headerlink" title="Background-Click Supervision for Temporal Action Localization"></a>Background-Click Supervision for Temporal Action Localization</h1><h2 id="è®ºæ–‡ç®€ä»‹"><a href="#è®ºæ–‡ç®€ä»‹" class="headerlink" title="è®ºæ–‡ç®€ä»‹"></a>è®ºæ–‡ç®€ä»‹</h2><p>BackTALæ˜¯2021å¹´å‘è¡¨åœ¨IEEEä¸Šä¸€ç¯‡å…³äºå¼±ç›‘ç£æ—¶åºå®šä½çš„æ–‡ç« ã€‚è®ºæ–‡çš„ä½œè€…å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429192856464.png" alt="image-20220429192856464"></p>
<p>è®ºæ–‡åœ°å€ï¼š<a href="https://github.com/VividLe/BackTAL">https://github.com/VividLe/BackTAL</a></p>
<p>Bç«™è§‚çœ‹ç½‘ç«™ï¼š<a href="https://www.bilibili.com/video/BV1oL4y1T7eL/">https://www.bilibili.com/video/BV1oL4y1T7eL/</a></p>
<span id="more"></span>
<h2 id="è®ºæ–‡åŠ¨æœº"><a href="#è®ºæ–‡åŠ¨æœº" class="headerlink" title="è®ºæ–‡åŠ¨æœº"></a>è®ºæ–‡åŠ¨æœº</h2><p>ç›®å‰<strong>å¼±ç›‘ç£</strong>æ—¶é—´åŠ¨ä½œå®šä½éµå¾ªç€ä¸€ä¸ªæ½œåœ¨çš„å‡è®¾ï¼Œè§†é¢‘ç‰‡æ®µèƒ½å¤Ÿä¸ºvideo-levelçº§åˆ«åˆ†ç±»æä¾›æ›´å¤šè¯æ®ï¼Œå°¤å…¶æ˜¯åŠ¨ä½œï¼Œä¸ºvideo-levelåˆ†ç±»è´¡çŒ®æ›´å¤šã€‚ä½†æ˜¯ï¼Œæœ‰è®ºæ–‡æŒ‡å‡ºå½“èƒŒæ™¯ç‰‡æ®µä¸video-levelæ›´ç›¸å…³æ—¶ï¼Œåœ¨æ­¤å‡è®¾ä¸‹å¼€å‘çš„ç®—æ³•ä¼šé™·å…¥åŠ¨ä½œ-ä¸Šä¸‹æ–‡æ··æ·†å›°å¢ƒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429193155150.png" alt="image-20220429193155150"></p>
<p>è®ºæ–‡è¿˜åˆ†æäº†ä¸€ä¸‹</p>
<p>1.å®šä½é”™è¯¯çš„åŸå› ï¼Œä¸»è¦çš„é”™è¯¯æ¥è‡ªèƒŒæ™¯çš„è¯¯å·®ã€‚</p>
<p>2.ç»™å®šç‰¹å®šçš„CASï¼Œtop-kå¸§ä¸­å¤§éƒ¨åˆ†ä¸ºåŠ¨ä½œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429193303489.png" alt="image-20220429193303489"></p>
<h2 id="è®ºæ–‡æ¡†æ¶"><a href="#è®ºæ–‡æ¡†æ¶" class="headerlink" title="è®ºæ–‡æ¡†æ¶"></a>è®ºæ–‡æ¡†æ¶</h2><p>æ¨¡å‹æ€»ä½“æ¡†æ¶å¦‚ä¸‹ï¼Œæ¡†æ¶é‡è¦çš„éƒ¨åˆ†åˆ†åˆ«ä¸ºAffinity Moduleå’ŒScore Separation Module</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429193353467.png" alt="image-20220429193353467"></p>
<p>BackTALä½¿ç”¨ä¸‰ä¸ªæ—¶é—´å·ç§¯å±‚æ¥å¤„ç†è§†é¢‘ç‰¹å¾åºåˆ—ã€‚è¾“å…¥è§†é¢‘ç‰¹å¾$X$ï¼Œè·å¾—ç±»æ¿€æ´»åºåˆ—$S\in \mathbb R^{(C+1)\times T}$ï¼Œæ¥ç€ä½¿ç”¨top-kå‡å€¼çš„æ–¹æ³•è·å¾—è§†é¢‘çº§åˆ†ç±»å¾—åˆ†$s_v^c$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429194200422.png" alt="image-20220429194200422"></p>
<p>å› ä¸ºæœ‰èƒŒæ™¯click-levelçš„ä¿¡æ¯ï¼Œæ‰€ä»¥æ‹¥æœ‰å¸§çº§åˆ«çš„ç›‘ç£ä¿¡æ¯ï¼Œå¯ä»¥å¯¹å¸¦æ³¨é‡Šçš„èƒŒæ™¯å¸§è¿›è¡Œç›‘ç£åˆ†ç±»ï¼Œä»¥æé«˜ç±»æ¿€æ´»åºåˆ—Sçš„è´¨é‡ã€‚</p>
<p>è€ƒè™‘èƒŒæ™¯æ ‡ç­¾$b_t=1$çš„å¸§ï¼Œè¿™ä¸ªå¸§çš„åˆ†ç±»åˆ†æ•°$S[:,t]âˆˆR^{(C+1)Ã—1}$,ä½¿ç”¨softmaxå¾—åˆ°$\hat{S}_t=[\hat{s}_t^0,\hat{s}_t^1,â€¦,\hat{s}_t^c]$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429194825636.png" alt="image-20220429194825636"></p>
<h3 id="Score-Separation-Module"><a href="#Score-Separation-Module" class="headerlink" title="Score Separation Module"></a><strong>Score Separation Module</strong></h3><p>åœ¨ä½¿ç”¨top-kå‡å€¼æ–¹æ³•ä¸­ï¼Œè®­ç»ƒåæœŸçš„æ¨¡å‹æ€»æ˜¯è¶‹å‘äºé€‰æ‹©ç›¸ä¼¼çš„top-kçš„ä½ç½®ã€‚å¹¶ä¸”å¯¹äºåŠ¨ä½œå’ŒèƒŒæ™¯æ··æ·†çš„éƒ¨åˆ†ï¼Œåˆ†æ•°ä¹Ÿä¼šåé«˜ï¼Œä¸èƒ½å¾ˆå¥½çš„å°†èƒŒæ™¯å’Œå‰æ™¯è¿›è¡Œåˆ†ç¦»ã€‚åƒä¸‹å›¾å›¾bä¸­çº¢è‰²ç®­å¤´å’Œé»„è‰²ç®­å¤´æ‰€å±•ç¤ºçš„ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429194858571.png" alt="image-20220429194858571"></p>
<p>ç»™å®šä¸€ä¸ªåŒ…å«$c^{th}$ ç±»åˆ«åŠ¨ä½œçš„è§†é¢‘ï¼Œå°†top-kåˆ†æ•°ä½œä¸ºæ½œåœ¨åŠ¨ä½œï¼Œå¹¶è®¡ç®—å¹³å‡åˆ†æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429203658216.png" alt="image-20220429203658216"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220509163603985.png" alt="image-20220509163603985"></p>
<p>åŒæ ·çš„ï¼Œå¯¹äºè¯¥è§†é¢‘ä¸­N_frame æ³¨é‡Šçš„èƒŒæ™¯å¸§ï¼Œè®¡ç®—å¹³å‡åˆ†æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429203725159.png" alt="image-20220429203725159"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429203737728.png" alt="image-20220429203737728"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204251346.png" alt="image-20220429204251346"></p>
<h3 id="Affinity-Module"><a href="#Affinity-Module" class="headerlink" title="Affinity Module"></a><strong>Affinity Module</strong></h3><p>Affinity Moduleä¸»è¦åŸºäºå¸¦æ³¨é‡Šçš„èƒŒæ™¯å¸§å’Œæ½œåœ¨çš„åŠ¨ä½œå¸§ï¼Œå……åˆ†æŒ–æ˜å…¶ä¸­çš„ç‰¹å¾ä¿¡æ¯ã€‚åœ¨Affinity Moduleè€ƒè™‘åˆ°ç‰¹å®šçš„ä¸€å¸§ï¼Œå¯ä»¥åº¦é‡å®ƒå’Œç›¸é‚»å¸§çš„äº²å’Œåº¦ï¼Œå¾—åˆ°ä¸€å¸§ç‰¹å®šçš„æ³¨æ„åŠ›æƒé‡ï¼Œå½¢æˆå±€éƒ¨æ³¨æ„åŠ›æ©ç ï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ°å·ç§¯è®¡ç®—è¿‡ç¨‹ä¸­ã€‚ç‰¹å®šå¸§çš„å…³æ³¨æƒå€¼å¯ä»¥å¼•å¯¼å·ç§¯è¿‡ç¨‹åŠ¨æ€å…³æ³¨ç›¸å…³çš„é‚»å±…ï¼Œä»è€Œäº§ç”Ÿæ›´ç²¾ç¡®çš„å“åº”ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204310948.png" alt="image-20220429204310948"></p>
<p>åœ¨affinityæ¨¡å—ä¸­ï¼Œé¦–å…ˆå­¦ä¹ äº†ä¸€ä¸ªåµŒå…¥ç©ºé—´ï¼Œä»¥ä»èƒŒæ™¯ä¸­åŒºåˆ†ä¸ç±»æ— å…³çš„åŠ¨ä½œã€‚$E=[e<em>1,e_2,â€¦,e_T]$ï¼Œå…¶ä¸­$e_tâˆˆR^{D</em>{emb}}$ ï¼Œå…¶ä¸­æ¯ä¸ªå‘é‡$e_t$éƒ½ç»è¿‡L2æ­£åˆ™å¯¹äºä»»æ„ä¸¤ä¸ªåµŒå…¥å‘é‡ï¼Œå¯ä»¥è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼åº¦</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204322516.png" alt="image-20220429204322516"></p>
<p>åŸºäºæ ‡æ³¨çš„èƒŒæ™¯å¸§å’Œæ½œåœ¨çš„åŠ¨ä½œå¸§ï¼Œå¯ä»¥è®¡ç®—ä¸¤ä¸ªèƒŒæ™¯å¸§ä¹‹é—´ã€ä¸¤ä¸ªåŠ¨ä½œå¸§ä¹‹é—´ã€åŠ¨ä½œå’ŒèƒŒæ™¯ä¹‹é—´ä¸‰ä¸ªé¡¹çš„äº²å’ŒåŠ›æŸå¤±</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204415269.png" alt="image-20220429204415269"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204428626.png" alt="image-20220429204428626"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204436799.png" alt="image-20220429204436799"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204445755.png" alt="image-20220429204445755"></p>
<p>åº¦é‡ä¸€å¸§ä¸å®ƒçš„å±€éƒ¨é‚»å±…ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦ï¼ŒåµŒå…¥å‘é‡å¯ä»¥åŒºåˆ†åŠ¨ä½œå¸§å’ŒèƒŒæ™¯å¸§ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429204546840.png" alt="image-20220429204546840"></p>
<p>è€ƒè™‘ä¸€ä¸ªè§†é¢‘ç‰¹å¾$X\in\mathbb R^{D<em>{in}\times T}$å¯ä»¥ä½¿ç”¨å·ç§¯æ ¸$HâˆˆR^{hÃ—D</em>{in}Ã—D_{out}}$ è¿›è¡Œå¤„ç†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429205955081.png" alt="image-20220429205955081"></p>
<p>ç»™å®šä¸€ä¸ªè§†é¢‘ï¼Œæˆ‘ä»¬è®¡ç®—æ¯ä¸ªæ—¶é—´ä½ç½®çš„å±€éƒ¨ç›¸ä¼¼åº¦ï¼Œå¾—åˆ°äº²å’ŒåŠ›çŸ©é˜µ$aâˆˆR^{hÃ—T}$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429210028440.png" alt="image-20220429210028440"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429210037452.png" alt="image-20220429210037452"></p>
<h3 id="total-loss"><a href="#total-loss" class="headerlink" title="total loss"></a>total loss</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220429210124173.png" alt="image-20220429210124173"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è®ºæ–‡å¯¹äºclick-levelï¼Œå°†ä¹‹å‰å…³æ³¨äºaction-clickèšé›†åˆ°äº†backgroud-clickä¸Šï¼Œå¹¶æå‡ºäº†å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½çš„BackTALæ–¹æ³•ã€‚å¹¶ä¸”æå‡ºäº†è‡ªå·±çš„æŒ–æ˜ä½ç½®ä¿¡æ¯å’Œç‰¹å¾ä¿¡æ¯çš„æ–¹æ³•ï¼Œå¾ˆå¥½çš„ç¼“è§£äº†åŠ¨ä½œè¾¹ç•Œæ··æ·†çš„é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>CoLA Weakly-Supervised Temporal Action Localization with Snippet Contrastive Learning</title>
    <url>/2021/09/11/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/CoLA%20Weakly-Supervised%20Temporal%20Action%20Localization%20with%20Snippet%20Contrastive%20Learning/</url>
    <content><![CDATA[<h1 id="CoLA-Weakly-Supervised-Temporal-Action-Localization-with-Snippet-Contrastive-Learning"><a href="#CoLA-Weakly-Supervised-Temporal-Action-Localization-with-Snippet-Contrastive-Learning" class="headerlink" title="CoLA Weakly-Supervised Temporal Action Localization with Snippet Contrastive Learning"></a>CoLA Weakly-Supervised Temporal Action Localization with Snippet Contrastive Learning</h1><h2 id="æå‡ºé—®é¢˜ï¼š"><a href="#æå‡ºé—®é¢˜ï¼š" class="headerlink" title="æå‡ºé—®é¢˜ï¼š"></a>æå‡ºé—®é¢˜ï¼š</h2><p>å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½ï¼ˆWSTALï¼‰çš„ç›®çš„æ˜¯åªé€šè¿‡è§†é¢‘çº§åˆ«çš„æ ‡ç­¾ï¼Œå¯¹æœªè£å‰ªçš„è§†é¢‘è¿›è¡ŒåŠ¨ä½œå®šä½ã€‚ç›®å‰å­˜åœ¨çš„æ¨¡å‹å¤§éƒ½æ˜¯éµå¾ªâ€œlocalization by classificationâ€çš„è¿‡ç¨‹ï¼Œå®šä½å¯¹è§†é¢‘çº§åˆ«åˆ†ç±»è´¡çŒ®æœ€å¤§çš„æ—¶é—´åŒºåŸŸï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå®ƒä»¬å•ç‹¬å¤„ç†æ¯ä¸ªç‰‡æ®µ(æˆ–å¸§)ï¼Œå› æ­¤å¿½ç•¥äº†æœ‰æ•ˆçš„æ—¶é—´ä¸Šä¸‹æ–‡å…³ç³»</p>
<h2 id="åšäº†ä»€ä¹ˆ"><a href="#åšäº†ä»€ä¹ˆ" class="headerlink" title="åšäº†ä»€ä¹ˆ"></a>åšäº†ä»€ä¹ˆ</h2><ul>
<li>æå‡ºåˆ©ç”¨è§†é¢‘ç‰‡æ®µå¯¹æ¯”å­¦ä¹ æ¥å®ç°åŠ¨ä½œå®šä½</li>
<li>æå‡ºäº†ä¸€ä¸ªSnippet Contrast (SniCo) Lossæ¥ä»ç‰¹å¾ç©ºé—´ä¸­hard snippetçš„è¡¨ç¤ºï¼Œå®ƒæŒ‡å¯¼ç½‘ç»œæ„ŸçŸ¥ç²¾ç¡®çš„æ—¶é—´è¾¹ç•Œï¼Œé¿å…æ—¶é—´é—´éš”ä¸­æ–­ã€‚</li>
<li>ç”±äºæ²¡æœ‰åŠæ³•è®¿é—®å¸§çº§åˆ«çš„æ³¨é‡Šï¼Œå¼•å…¥äº†ä¸€ç§hard snippetæŒ–æ˜ç®—æ³•ï¼Œæ¥å®šä½æ½œåœ¨çš„hard snippetï¼ˆè¿™é‡Œçš„hard snippetå¯ä»¥ç†è§£ä¸ºåœ¨èƒŒæ™¯å’ŒåŠ¨ä½œè¿‡æ¸¡åŒºåŸŸçš„snippetï¼Œå…·æœ‰æ¯”è¾ƒå¼ºçš„æ¬ºéª—æ€§ï¼‰ã€‚</li>
</ul>
<span id="more"></span>
<h2 id="æ€ä¹ˆåš"><a href="#æ€ä¹ˆåš" class="headerlink" title="æ€ä¹ˆåš"></a>æ€ä¹ˆåš</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220414193438015.png" alt="image-20220414193438015"></p>
<p>è®ºæ–‡çš„åŠ¨æœºå¯ä»¥ä»å›¾ä¸­çœ‹å‡ºï¼Œç”±äºç¼ºä¹å¸§çº§åˆ«çš„æ ‡ç­¾ï¼Œä¸Šå›¾ä¸­<strong>#2</strong>å’Œ<strong>#3</strong>è¿™ä¸¤ä¸ªç‰‡æ®µå¾ˆéš¾è¿›è¡Œåˆ†ç±»ï¼Œå¦‚æœåªæ˜¯ä½¿ç”¨baselineï¼Œæˆ‘ä»¬ä¼šå‘ç°<strong>#2</strong>è¢«è¯†åˆ«ä¸ºèƒŒæ™¯ï¼Œè€Œ<strong>#3</strong>è¢«è¯†åˆ«ä¸ºåŠ¨ä½œï¼Œè¿™å’ŒGTæ˜¯ç›¸è¿èƒŒã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°åœ¨è¿™äº›ç‰‡æ®µä¸­<strong>#1</strong>æ˜¯å¾ˆå®¹æ˜“åˆ†ç±»æˆåŠ¨ä½œï¼ˆè®ºæ–‡ç§°è¿™å¾ˆå®¹æ˜“è¯†åˆ«çš„åŠ¨ä½œç‰‡æ®µä¸ºeasy actionï¼‰ï¼Œè€Œ<strong>#4</strong>å¾ˆå®¹æ˜“åˆ†ç±»èƒŒæ™¯ï¼ˆè®ºæ–‡é‡Œé¢ç§°ä¸ºeasy bkgï¼‰ï¼Œæˆ‘ä»¬å°†<strong>#2</strong>å’Œ<strong>#1</strong>è¿›è¡Œå¯¹æ¯”å¾ˆå®¹æ˜“å‘ç°<strong>#2</strong>æ˜¯ä¸ªåŠ¨ä½œï¼Œ<strong>#3</strong>å’Œ<strong>#4</strong>å¯¹æ¯”å¾ˆå®¹æ˜“å‘ç°æ˜¯èƒŒæ™¯ï¼Œé€šè¿‡è¿™ç§å¯¹æ¯”çš„æ€æƒ³å°±æå‡ºäº†è¿™ç¯‡è®ºæ–‡çš„æ¨¡å‹ã€‚è®ºæ–‡ä¸­å°†ç±»å‹<strong>#2</strong>å’Œ<strong>#3</strong>çš„ç‰‡æ®µæˆä¸ºhard snippetsï¼Œå› ä¸ºä»–ä»¬éƒ½æ˜¯â€œcheatingâ€çš„</p>
<p>è®ºæ–‡çš„æ¨¡å‹å¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912195346687.png" alt="image-20210912195346687"></p>
<h3 id="Feature-Extraction-and-Embedding"><a href="#Feature-Extraction-and-Embedding" class="headerlink" title="Feature Extraction and Embedding"></a>Feature Extraction and Embedding</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913192458877.png" alt="image-20210913192458877"></p>
<p>ç»™å®š$N$ä¸ªæœªè£å‰ªçš„è§†é¢‘$\lbrace{V<em>n}\rbrace^N</em>{n=1}$å’Œå®ƒä»¬è§†é¢‘çº§åˆ«çš„æ ‡ç­¾ $\lbrace y<em>n\rbrace^N</em>{n=1}$ ï¼Œå…¶ä¸­ $y_n\in \mathbb R^C $ ï¼Œ$C$æ˜¯åŠ¨ä½œç±»åˆ«çš„æ•°é‡</p>
<p>å¯¹äºæ¯ä¸ªè§†é¢‘$V<em>n$ï¼Œæˆ‘ä»¬æŠŠå®ƒåˆ†æˆå¤šå¸§ä¸é‡å çš„$L_n$ç‰‡æ®µï¼Œå…¶ä¸­$V_n=\lbrace S</em>{n,l}\rbrace^{L<em>n}</em>{l=1}$ï¼Œç”±äºè§†é¢‘é•¿åº¦çš„å˜åŒ–ï¼Œåˆ©ç”¨é‡‡æ ·ï¼Œå›ºå®šè§†é¢‘ä¸ºæ•°é‡$T$çš„ç‰‡æ®µ$\lbrace S<em>{n,t}\rbrace^T</em>{t=1}$ï¼ˆé‡‡æ ·çš„æ–¹æ³•å¾ˆå¸¸è§ï¼Œä¹Ÿæ˜¯æ­£å¸¸çš„æ–¹æ³•ï¼‰ã€‚</p>
<p>æ¥ç€æå–RGBç‰¹å¾$X<em>n^R=\lbrace x_t^R \rbrace^T</em>{t=1}$å’Œflowç‰¹å¾$X<em>n^O=\lbrace x_t^O \rbrace^T</em>{t=1}$ï¼Œå…¶ä¸­$x^R_t \in \mathbb R^d$å’Œ$x^O_t \in \mathbb R^d$,$d$æ˜¯æ¯ä¸ªç‰‡æ®µçš„ç‰¹æ€§ç»´åº¦ã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨å‡½æ•°$f_{embed}$ï¼Œå°†$X_n^R$å’Œ$X_n^O$è¿æ¥èµ·æ¥ï¼Œè·å–æˆ‘ä»¬æ‰€æå–çš„ç‰¹å¾$X_n^E \in \mathbb R^{T \times 2d}$</p>
<p>$f_{embed}$é€šè¿‡æ—¶é—´å·ç§¯å’ŒReLUæ¿€æ´»å‡½æ•°å®ç°ã€‚</p>
<h3 id="Actionness-Modeling"><a href="#Actionness-Modeling" class="headerlink" title="Actionness Modeling"></a>Actionness Modeling</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913192542486.png" alt="image-20210913192542486"></p>
<p>ç»™å®šç‰¹å¾$X<em>n^E$  ,åˆ©ç”¨   $f</em>{cls}$è·å¾—ç±»æ¿€æ´»åºåˆ—å³CASï¼ˆåœ¨è®ºæ–‡å½“ä¸­å«T-CASï¼Œå…¶å®æ¦‚å¿µæ˜¯ç›¸åŒçš„ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913192823389.png" alt="image-20210913192823389"></p>
<p>æˆ‘ä»¬ç®€å•åœ°æ²¿ç€é€šé“ç»´åº¦(fsum)åŠ ä¸ŠSigmoidå‡½æ•°å¯¹CASè¿›è¡Œæ±‚å’Œï¼Œä»¥è·å¾—ä¸€ä¸ªç±»ä¸å¯çŸ¥çš„èšåˆï¼Œå¹¶ä½¿ç”¨å®ƒæ¥è¡¨ç¤ºåŠ¨ä½œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913193042814.png" alt="image-20210913193042814"></p>
<p>å…¶ä¸­$A_n^{ness}\in\mathbb R^T$</p>
<h3 id="Hard-amp-Easy-Snippet-Mining"><a href="#Hard-amp-Easy-Snippet-Mining" class="headerlink" title="Hard &amp; Easy Snippet Mining"></a>Hard &amp; Easy Snippet Mining</h3><p>è¿™ä¸€å—æ˜¯è®ºæ–‡çš„åˆ›æ–°ç‚¹ï¼Œä¸»è¦æŒ–æ˜è®ºæ–‡å½“ä¸­Hardå’ŒEasyç‰‡æ®µ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913193628164.png" alt="image-20210913193628164"></p>
<h4 id="Hard-Snippet-Mining"><a href="#Hard-Snippet-Mining" class="headerlink" title="Hard Snippet Mining"></a>Hard Snippet Mining</h4><p>hard Snippet æŒ‡é‚£ç§è¾¹ç•Œç›¸é‚»çš„ç‰‡æ®µï¼Œç”±äºå®ƒä»¬ä½äºåŠ¨ä½œå’ŒèƒŒæ™¯ä¹‹é—´çš„è¿‡æ¸¡åŒºåŸŸï¼Œå› æ­¤å¯é æ€§è¾ƒå·®ï¼Œä»è€Œå¯¼è‡´æ£€æµ‹æ¨¡ç³Šã€‚æ‰€ä»¥hard snippetæ˜¯å¯ä»¥è¿›è¡ŒæŒ–æ˜ï¼Œä»¥å¾—åˆ°æ›´å¥½çš„åˆ¤å†³ã€‚åœ¨è®ºæ–‡ä¸­æ„å»ºäº†ä¸€ç§æ–°çš„ç¡¬ç‰‡æ®µæŒ–æ˜ç®—æ³•æ¥æŒ–æ˜è¾¹ç•ŒåŒºåŸŸçš„ç¡¬ç‰‡æ®µã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å¯¹åŠ¨ä½œè¯„åˆ†è¿›è¡Œé˜ˆå€¼ï¼Œä»¥ç”Ÿæˆä¸€ä¸ªäºŒè¿›åˆ¶åºåˆ—(1æˆ–0åˆ†åˆ«è¡¨ç¤ºåŠ¨ä½œæˆ–èƒŒæ™¯ä½ç½®):</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913194552618.png" alt="image-20210913194552618"></p>
<p>å…¶ä¸­$\epsilon(\cdot )$æ˜¯ä¸€ä¸ªheavisideè·ƒé˜¶å‡½æ•°ï¼Œå…¶ä¸­$\theta_b$æ˜¯é˜ˆå€¼ï¼Œå¦‚æœ$A_n^{ness}\geq\theta_b$ï¼Œåˆ™$A_n^{bin}=1$,åä¹‹åˆ™ä¸º0</p>
<p>æ¥ç€æˆ‘ä»¬é‡‡å–ä¸¤ç§çº§è”çš„æ‰©å¼ æˆ–è€…å˜çª„æ“ä½œï¼ˆè¿™ä¸ªæ“ä½œåœ¨è¯­ä¹‰åˆ†å‰²åŠ¨ä½œæœ‰æ‰€ä½¿ç”¨ï¼‰ï¼Œæ¥æ‰©å¤§æˆ–ç¼©å°åŠ¨ä½œé—´éš”çš„æ—¶é—´èŒƒå›´ï¼Œå°†æ‰©å¼ å’Œå˜çª„ç¨‹åº¦ä¸åŒçš„ä¸åŒåŒºåŸŸå®šä¹‰ä¸ºç¡¬èƒŒæ™¯ï¼ˆhard backgroundï¼‰æˆ–è€…ç¡¬åŠ¨ä½œï¼ˆhard actionï¼‰åŒºåŸŸã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913195927059.png" alt="image-20210913195927059"></p>
<p>å…¶ä¸­(Â·;âˆ—)+å’Œ(Â·;âˆ—)âˆ’åˆ†åˆ«è¡¨ç¤ºmaskâˆ—ä¸‹çš„äºŒå…ƒæ‰©å¼ å’Œå˜çª„æ“ä½œã€‚è¿™ä¸ªäº›ä¸ªæ“ä½œç±»ä¼¼å·ç§¯ï¼Œä½œç”¨æ˜¯æŒ–æ˜å‡ºhardçš„ç‰‡æ®µã€‚</p>
<p>å†…éƒ¨åŒºåŸŸ$R_n^{inner}$å®šä¹‰ä¸ºmaskè¾ƒå°må’Œmaskè¾ƒå¤§çš„Må˜çª„åºåˆ—ä¹‹é—´çš„ä¸åŒç‰‡æ®µçš„å·®å€¼ï¼Œå¦‚å›¾3å·¦è¾¹éƒ¨åˆ†(ç»¿è‰²éƒ¨åˆ†)æ‰€ç¤ºã€‚</p>
<p>åŒæ ·ï¼Œå¤–éƒ¨çš„$R_n^{outer}$è®¡ç®—ä¸ºmaskå¤§æ©ç Må’Œå°æ©ç mä¹‹é—´çš„å·®å€¼ï¼Œå¦‚å›¾3å³ä¾§éƒ¨åˆ†(ç²‰çº¢è‰²)æ‰€ç¤ºã€‚</p>
<p>ç»éªŒä¸Šï¼Œæˆ‘ä»¬è€ƒè™‘å†…éƒ¨åŒºåŸŸç¡¬åŠ¨ä½œç‰‡æ®µé›†ï¼Œå› ä¸ºè¿™äº›åŒºåŸŸæ˜¯$A_n^{bin}$= 1ã€‚åŒç†å¤–éƒ¨åŒºåŸŸè¢«è®¤ä¸ºæ˜¯ç¡¬èƒŒæ™¯ä»£ç ç‰‡æ®µé›†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210913201417966.png" alt="image-20210913201417966"></p>
<p>æ¥ç€å®šä¹‰hard action snippetsï¼Œ$X_n^{HA}\in \mathbb R^{k^{hard}\times 2d}$ï¼Œä»$R_n^{inner}$ä¸­æŒ‘é€‰å‡ºæ¥</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210914204708488.png" alt="image-20210914204708488"></p>
<p>å…¶ä¸­$I_n^{inner}$æ˜¯$R_n^{inner}$å†…çš„ä»£ç ç‰‡æ®µçš„ç´¢å¼•é›†ï¼Œ$I_n^{act}$æ˜¯$I_n^{inner}$ä¸­å¤§å°ä¸º$k^{hard}$çš„å­é›†ï¼Œå³$\lvert I_n^{act} \rvert=k^{hard}$ã€‚å…¶ä¸­$k^{hard}$æ˜¯ä¸€ä¸ªè¶…å‚ï¼Œç®€å•ç†è§£å°±æ˜¯æ‰¾äº†$k^{hard}$ä¸ªhard actionç‰‡æ®µ</p>
<p>åŒç†å¯ä»¥å¾—åˆ° hard background snippets</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210914205334459.png" alt="image-20210914205334459"></p>
<p>æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£å›¾3ï¼Œå¯¹äºå·¦ä¾§çš„å›¾ï¼Œæˆ‘ä»¬å…ˆæ‹¿å·ç§¯æ ¸ä¸º3çš„ç¥ç»å…ƒå»ç§»åŠ¨ï¼Œå½“3ä¸ªä½ç½®éƒ½ä¸º1æ—¶ï¼ˆéƒ½ä¸ºåŠ¨ä½œæ—¶ï¼‰ï¼Œæ‰æŠŠä¸­å¿ƒä½ç½®æ ‡ä¸º1ï¼Œç„¶åå·ç§¯æ ¸ä¸º6çš„ç¥ç»å…ƒå»ç§»åŠ¨ï¼Œå½“6ä¸ªä½ç½®éƒ½ä¸º1æ—¶æ‰æŠŠä¸­å¿ƒä½ç½®æ ‡ä¸º1ï¼Œæ˜¾ç„¶å·ç§¯æ ¸ä¸º6çš„ç¥ç»å…ƒæ¯”è¾ƒä¸¥æ ¼çœ‹çš„æ›´è¿œï¼Œä»–å‡å»å·ç§¯ä¸º3ç§»åŠ¨å®Œçš„æ•°æ®å‰©ä¸‹çš„å°±æ˜¯ä¸æ˜¯é‚£ä¹ˆä¸¥æ ¼çš„ä½ç½®ï¼Œæ‰€ä»¥æŠŠè¿™äº›ä½ç½®ä½œä¸ºhard snippetã€‚</p>
<h4 id="Easy-Snippet-Mining"><a href="#Easy-Snippet-Mining" class="headerlink" title="Easy Snippet Mining"></a>Easy Snippet Mining</h4><p>ä¸ºäº†å½¢æˆå¯¹æ¯”å¯¹ï¼Œæˆ‘ä»¬ä»ç„¶éœ€è¦æŒ–æ˜å…·æœ‰åŒºåˆ«æ€§çš„ç®€å•ç‰‡æ®µ</p>
<p>æˆ‘ä»¬å‡è®¾åŠ¨ä½œåº¦å¾—åˆ†ä¸ºtop-kå’Œbottom-kçš„è§†é¢‘ç‰‡æ®µæ°å¥½æ˜¯easy action ç‰‡æ®µ($X_n^{EA}\in \mathbb R^{k^{easy}\times 2d}$)å’Œeasy background  ç‰‡æ®µ ($X_n^{EB}\in \mathbb R^{k^{easy}\times 2d}$)ï¼Œå¯ä»¥ç†è§£ä¸ºé€‰å–äº†kä¸ªå®¹æ˜“åŒºåˆ†çš„ç‰‡æ®µ</p>
<p>æˆ‘ä»¬åŸºäºå‰é¢è®¡ç®—çš„åŠ¨ä½œè¯„åˆ†$A_n^{ness}$è¿›è¡Œç®€å•çš„ä»£ç ç‰‡æ®µæŒ–æ˜ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210914210005061.png" alt="image-20210914210005061"></p>
<p>å…¶ä¸­$S_n^{DESC}$å’Œ$S_n^{ASC}$åˆ†åˆ«ä¸º$A_n^{ness}$æŒ‰ç…§é™åºå’Œå‡åºæ’åˆ—çš„ç´¢å¼•ã€‚åŸºæœ¬ç†è§£å’Œå‰é¢ä¸€æ ·ã€‚</p>
<h3 id="Network-Training"><a href="#Network-Training" class="headerlink" title="Network Training"></a>Network Training</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915151007435.png" alt="image-20210915151007435"></p>
<p>åœ¨æŒ–æ˜hardå’Œeasyç‰‡æ®µçš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬çš„CoLAå¼•å…¥äº†é¢å¤–çš„ç‰‡æ®µå¯¹æ¯”(SniCo)æŸå¤±($L_s$)ï¼Œä¸åŸºçº¿æ¨¡å‹ç›¸æ¯”å–å¾—äº†ç›¸å½“å¤§çš„æ”¹è¿›ã€‚å…¨æŸå¯ä»¥è¡¨ç¤ºä¸º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915111910708.png" alt="image-20210915111910708"></p>
<p>å…¶ä¸­$L_a$å’Œ$L_s$åˆ†åˆ«è¡¨ç¤ºåŠ¨ä½œæŸå¤±å’ŒSniCoæŸå¤±ã€‚$\lambda$æ˜¯å¹³è¡¡å› å­ã€‚æˆ‘ä»¬å°†å¯¹è¿™ä¸¤ä¸ªæœ¯è¯­ä½œå¦‚ä¸‹é˜è¿°ã€‚</p>
<h4 id="Action-Loss"><a href="#Action-Loss" class="headerlink" title="Action Loss"></a>Action Loss</h4><p>Action Lossï¼ˆ$L_a$ï¼‰é¢„æµ‹çš„è§†é¢‘ç±»åˆ«ä¸çœŸå®å€¼ä¹‹é—´çš„åˆ†ç±»æŸå¤±ã€‚ä¸ºäº†è·å¾—è§†é¢‘çº§é¢„æµ‹ï¼Œæˆ‘ä»¬èšåˆç‰‡æ®µçº§åˆ«çš„ç±»åˆ«åˆ†æ•°(CAS)ï¼Œå³$A_n$</p>
<p>ç„¶åé‡‡å–top-kå‡å€¼æ–¹æ³•ï¼Œå¯¹äºæ¯ä¸ªç±»åˆ«$c$ï¼Œæˆ‘ä»¬å–å…·æœ‰æœ€å¤§çš„ç±»ç‰¹å®šCASå€¼çš„$K^{easy}$é¡¹ï¼Œå¹¶è®¡ç®—å®ƒä»¬çš„å¹³å‡å€¼$a<em>{n;c}$ï¼Œå³video $V_n$çš„class $c$çš„è§†é¢‘çº§ç±»å¾—åˆ†ã€‚åœ¨è·å¾—æ‰€æœ‰ç±»çš„$a</em>{n;c}$ä¹‹åï¼Œæˆ‘ä»¬åœ¨ç±»ç»´ä¸Šåº”ç”¨Softmaxå‡½æ•°å¾—åˆ°è§†é¢‘çº§ç±»çš„æ¦‚ç‡$p_n \in \mathbb R^C$</p>
<p>Action Lossï¼ˆ$L_a$ï¼‰ä½¿ç”¨äº¤å‰ç†µæŸå¤±</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915113148418.png" alt="image-20210915113148418"></p>
<h4 id="Snippet-Contrast-SniCo-Loss"><a href="#Snippet-Contrast-SniCo-Loss" class="headerlink" title="Snippet Contrast (SniCo) Loss"></a>Snippet Contrast (SniCo) Loss</h4><p>å¯¹æ¯”å­¦ä¹ å·²ç»è¢«ç”¨äºå›¾åƒæˆ–è€…è¡¥ä¸çº§åˆ«ã€‚å¯¹äºæœ¬æ¬¡è®ºæ–‡ï¼Œç»™å®šç‰¹å¾$X_n^E$ï¼Œå¯¹æ¯”å­¦ä¹ åº”ç”¨äºä»£ç ç‰‡æ®µçº§åˆ«ã€‚åœ¨è®ºæ–‡ä¸­å°†è¿™ç§å‘½åä¸ºsnippet Contrast (SniCo)Loss ($L_s$)ï¼Œç›®çš„æ˜¯ç»†åŒ–hard ç‰‡æ®µï¼Œå› ä¸ºæœ‰hard actionå’Œhard backgroundä¸¤ä¸ªå¯¹æ¯”ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†ä¸ºâ€œHA refinementâ€ and â€œHB refinementâ€</p>
<p>æŸ¥è¯¢$x\in \mathbb R^{1\times2d}$ï¼Œpositive $x^+ \in \mathbb R^{1\times 2d}$å’Œ$S$æ¶ˆæ$x^-\in \mathbb R^{S\times 2d}$å‡ä»é¢„æŒ–æ˜ç‰‡æ®µä¸­é€‰å–</p>
<p>å¯¹äºâ€œHA refinementâ€</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915161615227.png" alt="image-20210915161615227"></p>
<p>å¯¹äºâ€œHB refinementâ€</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915161743980.png" alt="image-20210915161743980"></p>
<p>æˆ‘ä»¬å°†å®ƒä»¬æŠ•å°„åˆ°ä¸€ä¸ªæ ‡å‡†åŒ–çš„å•ä½çƒä½“ä¸Šï¼Œä»¥é˜²æ­¢ç©ºé—´åå¡Œæˆ–è†¨èƒ€(æ²¡æ€ä¹ˆçœ‹æ‡‚)ï¼Œä¸è¿‡è¿™å…¶å®æ˜¯ä¸€ä¸ªç®€å•å¯¹æ¯”å­¦ä¹ ã€‚</p>
<p>å»ºç«‹äº†ä¸€ä¸ª(S+ 1)åˆ†ç±»é—®é¢˜ï¼Œåˆ©ç”¨äº¤å‰ç†µæŸå¤±æ¥è¡¨ç¤ºæ­£ä¾‹æ¯”è´Ÿä¾‹è¢«é€‰æ‹©çš„æ¦‚ç‡</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915162133500.png" alt="image-20210915162133500"></p>
<p>å…¶ä¸­$\tau$æ˜¯ä¸€ä¸ªè¶…å‚ï¼Œè€Œ$x^T$ä¸º$x$çš„è½¬ç½®ï¼Œå»ºè®®SniCoæŸå¤±å¦‚ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210915162339793.png" alt="image-20210915162339793"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡æ€è·¯ä¸é”™ï¼Œç›´æ¥ä»ä»¥å‰WTALä¸­ä½¿ç”¨æ¯”è¾ƒå¤šçš„åº¦é‡å­¦ä¹ ç›´æ¥è¿›å…¥åˆ°å¯¹æ¯”å­¦ä¹ ï¼Œç®—æ˜¯ä¸€ç§è¿›æ­¥ã€‚</p>
<p>å›¾åƒçš„ erodedå’Œdilatedæ“ä½œå¯ä»¥çœ‹ï¼š</p>
<p><a href="https://segmentfault.com/a/1190000004048075">https://segmentfault.com/a/1190000004048075</a></p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¯¹æ¯”å­¦ä¹ </tag>
      </tags>
  </entry>
  <entry>
    <title>CvT:Introducing Convolutions to Vision Transformers</title>
    <url>/2021/11/05/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/CvT%20Introducing%20Convolutions%20to%20Vision%20Transformers/</url>
    <content><![CDATA[<h1 id="CvT-Introducing-Convolutions-to-Vision-Transformers"><a href="#CvT-Introducing-Convolutions-to-Vision-Transformers" class="headerlink" title="CvT:Introducing Convolutions to Vision Transformers"></a>CvT:Introducing Convolutions to Vision Transformers</h1><h2 id="è®ºæ–‡ç®€ä»‹"><a href="#è®ºæ–‡ç®€ä»‹" class="headerlink" title="è®ºæ–‡ç®€ä»‹"></a>è®ºæ–‡ç®€ä»‹</h2><p>CvTæ˜¯å‘è¡¨åœ¨ICCVä¸Šçš„ä¸€ç¯‡æ–‡ç« ï¼Œä¸»è¦å›¢é˜Ÿæ˜¯æ¥è‡ªéº¦å‰å°”å¤§å­¦, å¾®è½¯äº‘+AIã€‚è®ºæ–‡çš„ä¸»è¦å·¥ä½œæ˜¯å°†å·ç§¯<strong>CNN</strong>æ¨¡å‹å¼•å…¥<strong>Transformeræ¨¡å‹</strong>ä¸­æ¥äº§ç”Ÿä¸¤ç§è®¾è®¡çš„æœ€ä½³æ•ˆæœï¼Œä»è€Œæé«˜äº†è§†è§‰Transformerï¼ˆViTï¼‰çš„æ€§èƒ½å’Œæ•ˆç‡</p>
<p>ä¸‹é¢å›¾å±•ç¤ºçš„æ˜¯å›¢é˜Ÿæˆå‘˜ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211121210127584.png" alt="image-20211121210127584"></p>
<span id="more"></span>
<h2 id="æ€è·¯å’Œç ”ç©¶æ–¹æ³•"><a href="#æ€è·¯å’Œç ”ç©¶æ–¹æ³•" class="headerlink" title="æ€è·¯å’Œç ”ç©¶æ–¹æ³•"></a>æ€è·¯å’Œç ”ç©¶æ–¹æ³•</h2><h3 id="ViTæ¨¡å‹"><a href="#ViTæ¨¡å‹" class="headerlink" title="ViTæ¨¡å‹"></a>ViTæ¨¡å‹</h3><p>ViTæ¨¡å‹é€šè¿‡å°†å›¾ç‰‡è¿›è¡Œåˆ†å—å’Œé™ç»´ï¼Œç„¶åå†é€å…¥åˆ°transformerä¸­ï¼Œå®ç°äº†å¯¹å›¾åƒè¿›è¡Œåˆ†ç±»ã€‚</p>
<p><strong>ç¼ºç‚¹ï¼š</strong>ViTåœ¨å°æ ·æœ¬ä¸Šï¼Œæ€§èƒ½ä½äºç±»ä¼¼è§„æ¨¡çš„CNNç½‘ç»œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121210228422.png" alt="image-20211121210228422"></p>
<h3 id="Convolutional-vision-Transformer"><a href="#Convolutional-vision-Transformer" class="headerlink" title="Convolutional vision Transformer"></a>Convolutional vision Transformer</h3><p>æœ¬æ–‡æå‡ºäº†å·ç§¯è§†è§‰Transformerï¼ˆCvTï¼‰ï¼Œè®¾è®¡äº†ä¸¤ä¸ªæ“ä½œï¼š<strong>Convolutional Token Embedding</strong>å’Œ<strong>Convolutional Projection</strong>ï¼Œä½¿å¾—æ•´ä¸ªç½‘ç»œç»“æ„åŒæ—¶å…·å¤‡äº†å·ç§¯å’ŒTransformerçš„ç‰¹ç‚¹ï¼Œå»é™¤äº†ä½ç½®ç¼–ç embeddingï¼Œç®€åŒ–äº†ç½‘ç»œè®¾è®¡ã€‚</p>
<p>è®ºæ–‡æ¯”è¾ƒäº†ä¸€ä¸‹CvTã€ViTã€BiTçš„å‚æ•°ï¼Œç›¸åŒå‚æ•°é‡ä¸‹CvTæ¨¡å‹å‡†ç¡®åº¦æœ€é«˜ï¼Œå¦‚ä¸‹å›¾å±•ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121210310100.png" alt="image-20211121210310100"></p>
<p>æœ¬æ–‡çš„ç½‘ç»œæ¨¡å‹å¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121210447006.png" alt="image-20211121210447006"></p>
<h3 id="Convolutional-Token-Embedding"><a href="#Convolutional-Token-Embedding" class="headerlink" title="Convolutional Token Embedding"></a>Convolutional Token Embedding</h3><p>ç»™å®šä¸€ä¸ª2Dçš„imageæˆ–è€…ä¸€ä¸ªæ¥è‡ªä¸Šä¸€å±‚çš„2D-reshapedè¾“å‡º$x<em>i\in \mathbb R^{H</em>{i-1}\times W<em>{i_1}\times C</em>{i-1}}$ä½œä¸ºè¾“å…¥ï¼Œå­¦ä¹ ä¸€ä¸ªå‡½æ•°$f(*)$ï¼ŒæŠŠè¾“å…¥$x<em>{i-1}$æ˜ å°„åˆ°ä¸€ä¸ªæ–°çš„token$f(x</em>{i-1}\in \mathbb R^{H_i\times W_i \times C_i})$ï¼Œå®ƒçš„é«˜å’Œå®½å¦‚ä¸‹ï¼ˆå…¶ä¸­å·ç§¯æ ¸å¤§å¤§å°ä¸º$s\times s$ï¼Œæ­¥é•¿ä¸º$s-o$ï¼Œpaddingä¸º$p$ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211053382.png" alt="image-20211121211053382"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211100484.png" alt="image-20211121211100484"></p>
<p>ä¹‹åå¾—åˆ°çš„$f(x_{i-1} )$ä¼šè¢«<strong>flatten</strong>åˆ°$H_i W_iÃ—C_i$ ï¼Œå¹¶è¿›è¡ŒLayer Normalizationæ“ä½œï¼Œå¾—åˆ°çš„ç»“æœä¼šè¿›å…¥ä¸‹é¢çš„çš„ç¬¬iä¸ªstageçš„Transformer Blockçš„æ“ä½œã€‚</p>
<p>Convolutional Token Embeddingå…è®¸æˆ‘ä»¬é€šè¿‡ä½¿ç”¨ä¸åŒçš„å·ç§¯å‚æ•°ï¼Œè°ƒæ•´token feature dimension å’Œæ¯ä¸€é˜¶æ®µçš„tokenæ•°é‡ã€‚ä»¥è¯¥æ–¹å¼ï¼Œæˆ‘ä»¬æ¸æ¸å‡å°‘token sequence lengthï¼ŒåŒæ—¶å¢åŠ token feature dimensionã€‚è¿™ä½¿å¾—tokenèƒ½å¤Ÿä»¥å¢åŠ æ›´å¤§çš„ç©ºé—´ï¼Œå»è¡¨å¾å¢åŠ çš„å¤æ‚è§†è§‰æ¨¡å¼ã€‚</p>
<h3 id="Convolutional-Projection-for-Attention"><a href="#Convolutional-Projection-for-Attention" class="headerlink" title="Convolutional Projection for Attention"></a><strong>Convolutional Projection for Attention</strong></h3><p>Convolutional Projection å±‚ä¸»è¦ç›®æ ‡æ˜¯å®ç°é¢å¤–çš„å±€éƒ¨ä¸Šä¸‹æ–‡å»ºæ¨¡ï¼Œå’Œæä¾›é«˜æ•ˆçš„Kï¼ŒVçŸ©é˜µé‡‡æ ·æ–¹å¼ã€‚</p>
<p>ä»æ ¹æœ¬ä¸Šæ¥è¯´ï¼Œæœ¬æ–‡æå‡ºçš„å¸¦æœ‰Convolutional Projection çš„Transformer blockæ˜¯åŸå§‹Transformer blockçš„ä¸€èˆ¬åŒ–è¡¨ç¤ºã€‚å› ä¸ºå…ˆå‰çš„å·¥ä½œéƒ½æ˜¯å°è¯•åœ¨Transformer block ä¸Šæ·»åŠ é¢å¤–çš„å·ç§¯æ¨¡å—ï¼Œè¿™å¢åŠ äº†é¢å¤–çš„è®¡ç®—ä»£ä»·ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211243532.png" alt="image-20211121211243532"></p>
<p>ç®€å•ç†è§£å°±æ˜¯æŠŠæ™®é€šTransformerçš„Blockä¸­çš„Linear Projectionæ“ä½œæ¢æˆäº†Convolutional Projectionæ“ä½œï¼Œæˆ‘ä»¬æå‡ºç”¨æ·±åº¦å¯åˆ†å·ç§¯ä»£æ›¿å¤šå¤´è‡ªæ³¨æ„(MHSA)çš„ä½ç½®çº¿æ€§æŠ•å½±ï¼Œå½¢æˆå·ç§¯æŠ•å½±å±‚ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºViTä¸­ä½¿ç”¨çš„Linear projectionæ“ä½œï¼Œé‡‡ç”¨çš„æ˜¯çº¿æ€§çš„æ˜ å°„</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211357005.png" alt="image-20211121211357005"></p>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºä¸ºCvTä¸­ä½¿ç”¨çš„Convolutional Projectionæ“ä½œï¼Œé‡‡ç”¨çš„æ˜¯å·ç§¯å˜æ¢ã€‚</p>
<p>å…·ä½“æ¥è®²ï¼Œtokené¦–å…ˆreshapeæˆ2Dçš„token mapï¼Œå†åˆ†åˆ«é€šè¿‡3ä¸ªDepthwise-separable Convolution(kernel=sÃ—s)å˜æˆqueryï¼Œkeyå’Œvalueå€¼ã€‚æœ€åå†æŠŠè¿™äº›queryï¼Œkeyå’Œvalueå€¼é€šè¿‡flattenæ“ä½œå¾—åˆ°çœŸæ­£çš„queryï¼Œkeyå’Œvalueå€¼ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211426548.png" alt="image-20211121211426548"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211432397.png" alt="image-20211121211432397"></p>
<p>å…¶ä¸­çš„<strong>Conv2d</strong>æ˜¯ä¸ªDepthwise-separable Convolutionçš„å¤åˆæ“ä½œ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211452115.png" alt="image-20211121211452115"></p>
<h4 id="Depthwise-Separable-Convolution"><a href="#Depthwise-Separable-Convolution" class="headerlink" title="Depthwise Separable Convolution"></a><strong>Depthwise</strong> <strong>Separable Convolution</strong></h4><p><strong>å¸¸è§„å·ç§¯è¿ç®—ï¼š</strong>å‡è®¾è¾“å…¥å±‚ä¸ºä¸€ä¸ªå¤§å°ä¸º64Ã—64åƒç´ ã€ä¸‰é€šé“å½©è‰²å›¾ç‰‡ã€‚ç»è¿‡ä¸€ä¸ªåŒ…å«4ä¸ªFilterçš„å·ç§¯å±‚ï¼Œæœ€ç»ˆè¾“å‡º4ä¸ªFeature Mapï¼Œä¸”å°ºå¯¸ä¸è¾“å…¥å±‚ç›¸åŒã€‚æ•´ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä¸‹å›¾æ¥æ¦‚æ‹¬ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211524088.png" alt="image-20211121211524088"></p>
<p><strong>Depthwise</strong> <strong>Convolution</strong>ï¼šä¸€ä¸ªå¤§å°ä¸º64Ã—64åƒç´ ã€ä¸‰é€šé“å½©è‰²å›¾ç‰‡é¦–å…ˆç»è¿‡ç¬¬ä¸€æ¬¡å·ç§¯è¿ç®—ï¼Œä¸åŒä¹‹å¤„åœ¨äºæ­¤æ¬¡çš„å·ç§¯å®Œå…¨æ˜¯åœ¨äºŒç»´å¹³é¢å†…è¿›è¡Œï¼Œä¸”Filterçš„æ•°é‡ä¸ä¸Šä¸€å±‚çš„Depthç›¸åŒã€‚</p>
<p><strong>ç¼ºç‚¹ï¼š</strong>è¿ç®—å¯¹è¾“å…¥å±‚çš„æ¯ä¸ªchannelç‹¬ç«‹è¿›è¡Œå·ç§¯è¿ç®—åå°±ç»“æŸï¼Œæ²¡æœ‰æœ‰æ•ˆçš„åˆ©ç”¨ä¸åŒmapåœ¨ç›¸åŒç©ºé—´ä½ç½®ä¸Šçš„ä¿¡æ¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211540006.png" alt="image-20211121211540006"></p>
<p><strong>Pointwise Convolution</strong>ï¼šPointwise Convolutionçš„è¿ç®—ä¸å¸¸è§„å·ç§¯è¿ç®—éå¸¸ç›¸ä¼¼ï¼Œä¸åŒä¹‹å¤„åœ¨äºå·ç§¯æ ¸çš„å°ºå¯¸ä¸º 1Ã—1Ã—Mï¼ŒMä¸ºä¸Šä¸€å±‚çš„depthã€‚æ‰€ä»¥è¿™é‡Œçš„å·ç§¯è¿ç®—ä¼šå°†ä¸Šä¸€æ­¥çš„mapåœ¨æ·±åº¦æ–¹å‘ä¸Šè¿›è¡ŒåŠ æƒç»„åˆï¼Œç”Ÿæˆæ–°çš„Feature mapã€‚æœ‰å‡ ä¸ªFilterå°±æœ‰å‡ ä¸ªFeature mapã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211606550.png" alt="image-20211121211606550"></p>
<p><strong>å‚æ•°å¯¹æ¯”ï¼š</strong></p>
<p>å¸¸è§„å·ç§¯çš„å‚æ•°ä¸ªæ•°ä¸ºï¼š</p>
<script type="math/tex; mode=display">
N_{std} = 4 Ã— 3 Ã— 3 Ã— 3 = 108</script><p>Separable Convolutionçš„å‚æ•°ç”±ä¸¤éƒ¨åˆ†ç›¸åŠ å¾—åˆ°ï¼š</p>
<script type="math/tex; mode=display">
N_{depthwise}=3Ã—3Ã—3=27</script><script type="math/tex; mode=display">
N_{pointwise}=1Ã—1Ã—3Ã—4=12</script><script type="math/tex; mode=display">
N_{separable}=N_{depthwise}+N_{pointwise}=39</script><p>ç›¸åŒçš„è¾“å…¥ï¼ŒåŒæ ·æ˜¯å¾—åˆ°4å¼ Feature mapï¼ŒSeparable Convolutionçš„å‚æ•°ä¸ªæ•°æ˜¯å¸¸è§„å·ç§¯çš„çº¦1/3ã€‚å› æ­¤ï¼Œåœ¨å‚æ•°é‡ç›¸åŒçš„å‰æä¸‹ï¼Œé‡‡ç”¨Separable Convolutionçš„ç¥ç»ç½‘ç»œå±‚æ•°å¯ä»¥åšçš„æ›´æ·±ã€‚</p>
<h3 id="Efficiency-Considerations"><a href="#Efficiency-Considerations" class="headerlink" title="Efficiency Considerations"></a><strong>Efficiency Considerations</strong></h3><p>å¯¹äºå¸¸è§„çš„Convolutionæ‰€éœ€çš„å‚æ•°é‡å’Œè®¡ç®—é‡åˆ†åˆ«æ˜¯ $s^2 C^2$å’Œ$o(s^2 C^2 T)$ï¼Œ</p>
<p>å¦‚æœæ˜¯Depthwise-separable Convolutionæ‰€éœ€çš„å‚æ•°é‡å’Œè®¡ç®—é‡åˆ†åˆ«æ˜¯$s^2 C$å’Œ$o(s^2 CT)$</p>
<p>å…¶ä¸­Cæ˜¯tokençš„channel dimensionï¼ŒTæ˜¯tokençš„æ•°é‡ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†ä½¿å¾—æ¨¡å‹è¿›ä¸€æ­¥ç®€åŒ–ï¼Œä½œè€…åˆæå‡ºäº†å¦‚å›¾æ‰€ç¤ºçš„Squeezed convolutional projectionæ“ä½œã€‚</p>
<p>ä½œè€…åœ¨è®¡ç®—queryæ—¶ï¼Œé‡‡ç”¨çš„Depthwise-separable Convolutionçš„strideå€¼ä¸º1ã€‚åœ¨è®¡ç®—keyå’Œvalueæ—¶ï¼Œé‡‡ç”¨çš„Depthwise-separable Convolutionçš„strideå€¼ä¸º2ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚æŒ‰ç…§è¿™ç§æ–¹å¼ï¼Œtokençš„æ•°é‡å¯¹äºkeyå’Œvalueæ¥è¯´å¯ä»¥å‡å°‘4å€ï¼Œæ€§èƒ½åªæœ‰å¾ˆå°‘çš„ä¸‹é™ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121211952118.png" alt="image-20211121211952118"></p>
<h2 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h2><p><strong>æ•°æ®é›†ï¼š</strong>ImageNet-1k (1.3M images)ï¼ŒImageNet (14M imagesï¼Œ22kç±»)ï¼ŒCIFAR-10/100ï¼ŒOxford-IIIT-Petï¼ŒOxford-IIIT-Flowerã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212018071.png" alt="image-20211121212018071"></p>
<p>CvTæ¨¡å‹å¯ä»¥ä»¥è¾ƒä½çš„å‚æ•°é‡å’Œè®¡ç®—é‡è¾¾åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œæ¯”å¦‚21å±‚çš„CvTåœ¨ImageNetä¸Šå¯ä»¥è¾¾åˆ°82.5%çš„é«˜æ€§èƒ½ï¼Œæ¯”DeiT-Bçš„æ€§èƒ½è¿˜è¦å¥½ï¼Œè€Œå‚æ•°é‡å’Œè®¡ç®—é‡éƒ½æœ‰å¤§å¹…åœ°ä¸‹é™ã€‚</p>
<p>CvTç³»åˆ—æœ€å¤§çš„æ¨¡å‹ï¼šCvT-W24å¯ä»¥åœ¨ImageNetä¸Šè¾¾åˆ°87.7%çš„æ€§èƒ½ï¼Œä¸éœ€è¦JFT-300é¢„è®­ç»ƒï¼Œè¶…è¿‡äº†ViT-Læ¨¡å‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212042974.png" alt="image-20211121212042974"></p>
<h3 id="è¿ç§»å­¦ä¹ æ€§èƒ½"><a href="#è¿ç§»å­¦ä¹ æ€§èƒ½" class="headerlink" title="è¿ç§»å­¦ä¹ æ€§èƒ½"></a><strong>è¿ç§»å­¦ä¹ æ€§èƒ½</strong></h3><p>CvTåœ¨å°æ•°æ®é›†ä¸Šçš„ç»“æœå¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212108045.png" alt="image-20211121212108045"></p>
<h3 id="å¯¹æ¯”å®éªŒ1ï¼šä½ç½®ç¼–ç çš„å½±å“"><a href="#å¯¹æ¯”å®éªŒ1ï¼šä½ç½®ç¼–ç çš„å½±å“" class="headerlink" title="å¯¹æ¯”å®éªŒ1ï¼šä½ç½®ç¼–ç çš„å½±å“"></a><strong>å¯¹æ¯”å®éªŒ</strong>1ï¼šä½ç½®ç¼–ç çš„å½±å“</h3><p>ä½œè€…åœ¨CvTä¸­æ²¡æœ‰ä½¿ç”¨ä½ç½®ç¼–ç ï¼Œä¸ºäº†æ¢ç©¶è¿™ä¹ˆåšåˆ°åº•ä¼šä¸ä¼šå½±å“æ€§èƒ½ï¼Œä½œè€…è®¾è®¡äº†ä»¥ä¸‹6ä¸ªå®éªŒï¼Œå‘ç°DeiTåœ¨ä¸ä½¿ç”¨ä½ç½®ç¼–ç æ—¶ä¼šæ‰ç‚¹ï¼Œä½†æ˜¯CvTä¸ä½¿ç”¨ä½ç½®ç¼–ç åˆ™ä¸ä¼šå½±å“æ€§èƒ½ã€‚æ ¹æœ¬åŸå› è¿˜æ˜¯CvTä¸­çš„å·ç§¯æ“ä½œè‡ªå¸¦äº†æš—ä½ç½®ä¿¡æ¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212140269.png" alt="image-20211121212140269"></p>
<h3 id="å¯¹æ¯”å®éªŒ2ï¼šConvolutional-Token-Embeddingçš„å½±å“"><a href="#å¯¹æ¯”å®éªŒ2ï¼šConvolutional-Token-Embeddingçš„å½±å“" class="headerlink" title="å¯¹æ¯”å®éªŒ2ï¼šConvolutional Token Embeddingçš„å½±å“"></a><strong>å¯¹æ¯”å®éªŒ</strong>2ï¼šConvolutional Token Embeddingçš„å½±å“</h3><p>ä¸ºäº†è¯´æ˜Convolutional Token Embeddingçš„ä½œç”¨ï¼Œä½œè€…æŠŠå®ƒæ›¿æ¢æˆäº†Patch embeddingå¹¶åšäº†å¦‚ä¸‹4ç»„å®éªŒã€‚ç»“æœè¡¨æ˜ï¼Œå½“ä½¿ç”¨Convolutional Token Embeddingå¹¶ä¸ä½¿ç”¨ä½ç½®ç¼–ç æ—¶æ•ˆæœæœ€ä½³ï¼Œå½“ä½¿ç”¨Patch embeddingå¹¶åŒæ—¶ä½¿ç”¨ä½ç½®ç¼–ç æ—¶æ•ˆæœæ¬¡ä¹‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212219380.png" alt="image-20211121212219380"></p>
<h3 id="å¯¹æ¯”å®éªŒ3ï¼šConvolutional-Projectionå¯¹æ¯”å®éªŒ"><a href="#å¯¹æ¯”å®éªŒ3ï¼šConvolutional-Projectionå¯¹æ¯”å®éªŒ" class="headerlink" title="å¯¹æ¯”å®éªŒ3ï¼šConvolutional Projectionå¯¹æ¯”å®éªŒ"></a><strong>å¯¹æ¯”å®éªŒ</strong>3ï¼šConvolutional Projectionå¯¹æ¯”å®éªŒ</h3><p>ä½œè€…é¦–å…ˆå¯¹æ¯”äº†Convolutional Projectionçš„strideçš„å½±å“ï¼Œå½“æŠŠstride=1æ¢æˆstride=2ä¹‹åï¼Œè®¡ç®—é‡ä¼šæœ‰ä¸‹é™ï¼Œä½†æ˜¯ç²¾åº¦ä¹Ÿæœ‰ç›¸åº”çš„ä¸‹é™ã€‚</p>
<p>ä½œè€…å¯¹æ¯”äº†æŠŠ Convolutional Projection æ›¿æ¢æˆä¼ ç»Ÿçš„Position-wise çš„ Linear Projectionä¹‹åçš„æ€§èƒ½å˜åŒ–ã€‚ç»“æœå‘ç°åœ¨3ä¸ªstageä¸­éƒ½ä½¿ç”¨ Convolutional Projection æ—¶çš„æ€§èƒ½æ˜¯æœ€ä¼˜çš„ï¼Œè¯æ˜ Convolutional Projection æ˜¯ä¸€ç§å¾ˆæœ‰æ•ˆçš„å»ºæ¨¡ç­–ç•¥ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper//image-20211121212257789.png" alt="image-20211121212257789"></p>
<p><img src="æ–°å»ºæ–‡ä»¶å¤¹/image-20211121212305909.png" alt="image-20211121212305909"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é¦–å…ˆembeddingçš„æ–¹å¼å˜æˆäº†å·ç§¯æ“ä½œï¼Œåœ¨æ¯ä¸ªMulti-head self-attentionä¹‹å‰éƒ½è¿›è¡ŒConvolutional Token Embeddingã€‚</p>
<p>å…¶æ¬¡åœ¨ Self-attentionçš„Projectionæ“ä½œä¸å†ä½¿ç”¨ä¼ ç»Ÿçš„Linear Projectionï¼Œè€Œæ˜¯ä½¿ç”¨Convolutional Projectionã€‚</p>
<p>æœ€åå–æ¶ˆä½ç½®ç¼–ç ï¼Œå› ä¸ºå·ç§¯æ“ä½œåŒ…å«äº†æš—ä½ç½®ä¿¡æ¯ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="http://ishero.net/CvT%20%20Introducing%20Convolutions%20to%20Vision%20Transformers.html">http://ishero.net/CvT%20%20Introducing%20Convolutions%20to%20Vision%20Transformers.html</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/361112935">https://zhuanlan.zhihu.com/p/361112935</a></li>
<li><a href="https://yinguobing.com/separable-convolution/">https://yinguobing.com/separable-convolution/</a></li>
</ul>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>transformer</tag>
      </tags>
  </entry>
  <entry>
    <title>End-to-End Object Detection with Transformers</title>
    <url>/2021/09/29/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/End-to-End%20Object%20Detection%20with%20Transformers/</url>
    <content><![CDATA[<h1 id="End-to-End-Object-Detection-with-Transformers"><a href="#End-to-End-Object-Detection-with-Transformers" class="headerlink" title="End-to-End Object Detection with Transformers"></a>End-to-End Object Detection with Transformers</h1><h2 id="æå‡ºé—®é¢˜"><a href="#æå‡ºé—®é¢˜" class="headerlink" title="æå‡ºé—®é¢˜"></a>æå‡ºé—®é¢˜</h2><p>ç›®æ ‡æ£€æµ‹çš„ç›®æ ‡æ˜¯é¢„æµ‹ä¸€ä¸ªbboxçš„é›†åˆå’Œå„ä¸ªbboxçš„æ ‡ç­¾ã€‚ç›®å‰çš„æ£€æµ‹å™¨ä¸æ˜¯ç›´æ¥é¢„æµ‹ä¸€ä¸ªç›®æ ‡çš„é›†åˆï¼Œè€Œæ˜¯ä½¿ç”¨æ›¿ä»£çš„å›å½’å’Œåˆ†ç±»å»å¤„ç†å¤§é‡çš„propoaslsã€anchorsæˆ–è€…window centersã€‚æ¨¡å‹çš„æ•ˆæœä¼šå—åˆ°ä¸€ç³»åˆ—é—®é¢˜çš„å½±å“ï¼šåå¤„ç†å»æ¶ˆé™¤å¤§é‡é‡å çš„é¢„æµ‹ã€anchorsçš„è®¾è®¡ã€æ€ä¹ˆæŠŠtarget boxä¸anchorå…³è”èµ·æ¥ã€‚æ€ä¹ˆèƒ½å¤Ÿç®€åŒ–è¿™ä¸ªæµç¨‹ï¼Œä½¿å¾—ç›®æ ‡æ£€æµ‹ç®€å•èµ·æ¥</p>
<h2 id="åšäº†ä»€ä¹ˆ"><a href="#åšäº†ä»€ä¹ˆ" class="headerlink" title="åšäº†ä»€ä¹ˆ"></a>åšäº†ä»€ä¹ˆ</h2><p>æŠŠç›®æ ‡æ£€æµ‹çœ‹åšæ˜¯ä¸€ç§set predictionçš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„æ–¹æ³•ä¹Ÿç›´æ¥ç§»é™¤äº†ä¸€äº›äººå·¥è®¾è®¡çš„ç»„ä»¶ï¼Œä¾‹å¦‚NMSå’Œanchorçš„ç”Ÿæˆã€‚ä½¿ç”¨transformeræ¥å®Œæˆè¿™ä¸€ä»»åŠ¡ï¼Œåœ¨cocoæ•°æ®é›†ä¸Šæœ‰ç€å¯ä»¥å’Œfaster-rcnnåª²ç¾çš„å‡†ç¡®ç‡ä¸æ•ˆç‡ã€‚</p>
<span id="more"></span>
<h2 id="æ€ä¹ˆåš"><a href="#æ€ä¹ˆåš" class="headerlink" title="æ€ä¹ˆåš"></a>æ€ä¹ˆåš</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211003170232176.png" alt="image-20211003170232176"></p>
<h3 id="é›†åˆé¢„æµ‹"><a href="#é›†åˆé¢„æµ‹" class="headerlink" title="é›†åˆé¢„æµ‹"></a>é›†åˆé¢„æµ‹</h3><p>é›†åˆé¢„æµ‹æ˜¯æŒ‡ç½‘ç»œç›´æ¥è¾“å‡ºæœ€ç»ˆçš„é¢„æµ‹é›†åˆï¼ˆè¿™ä¸ªé›†åˆä¸éœ€è¦åšä»»ä½•åå¤„ç†ï¼‰ï¼Œè¿™ä¸ªé›†åˆåŒ…æ‹¬é¢„æµ‹æ¡†çš„ä½ç½®å’Œç±»åˆ«ï¼Œæ‰€ä»¥èƒ½å¤Ÿç›´æ¥å¾—åˆ°é¢„æµ‹çš„é›†åˆå°±å¯ä»¥è¾¾åˆ°ç›®æ ‡æ£€æµ‹çš„ç›®çš„ã€‚</p>
<p>æ¯”å¦‚ï¼šåœ¨Deträ¸­ï¼Œtransformerçš„åé¢çš„è¾“å‡ºå°±æ˜¯æœ€ç»ˆé¢„æµ‹çš„ç»“æœï¼Œå›ºå®šä¸º100ä¸ªé¢„æµ‹ç»“æœä¹Ÿå°±è¯´ç½‘ç»œè¾“å‡ºå°±æ˜¯$ 100\times 4$å’Œ$100\times (C+1)$çš„ä¸¤ä¸ªtensorï¼Œåˆ†åˆ«å¯¹åº”æ¡†çš„é¢„æµ‹å’Œç±»åˆ«çš„é¢„æµ‹ï¼ŒCè¡¨ç¤ºæ€»å…±çš„ç±»åˆ«æ•°,+1æ˜¯èƒŒæ™¯ç±»ã€‚</p>
<h3 id="DETR-æ¨¡å‹"><a href="#DETR-æ¨¡å‹" class="headerlink" title="DETR æ¨¡å‹"></a>DETR æ¨¡å‹</h3><p>ç›®æ ‡æ£€æµ‹ä¸­ä½¿ç”¨ç›´æ¥é›†åˆé¢„æµ‹æœ€å…³é”®çš„ä¸¤ä¸ªç‚¹æ˜¯ï¼š</p>
<p>1ï¼‰ä¿è¯çœŸå®å€¼ä¸é¢„æµ‹å€¼ä¹‹é—´å”¯ä¸€åŒ¹é…çš„é›†åˆé¢„æµ‹æŸå¤±ã€‚</p>
<p>2ï¼‰ä¸€ä¸ªå¯ä»¥é¢„æµ‹ï¼ˆä¸€æ¬¡æ€§ï¼‰ç›®æ ‡é›†åˆå’Œå¯¹ä»–ä»¬å…³ç³»å»ºæ¨¡çš„æ¶æ„ã€‚</p>
<h4 id="ç›®æ ‡æ£€æµ‹é›†åˆé¢„æµ‹æŸå¤±"><a href="#ç›®æ ‡æ£€æµ‹é›†åˆé¢„æµ‹æŸå¤±" class="headerlink" title="ç›®æ ‡æ£€æµ‹é›†åˆé¢„æµ‹æŸå¤±"></a>ç›®æ ‡æ£€æµ‹é›†åˆé¢„æµ‹æŸå¤±</h4><p>DETRè¾“å‡ºå›ºå®šå¤§å°ä¸ºNçš„é¢„æµ‹ï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡è§£ç å™¨ï¼ŒNæ¯”å¸¸è§„å›¾ç‰‡ä¸­å¾…æ£€æµ‹ç›®æ ‡å¤§å¾—å¤šã€‚è®­ç»ƒä¸­æœ€éš¾çš„åœ°æ–¹å°±æ˜¯æ ¹æ®çœŸå®å€¼è¯„ä»·é¢„æµ‹ç›®æ ‡(ç±»åˆ«ã€ä½ç½®ã€å¤§å°)ã€‚æˆ‘ä»¬çš„æŸå¤±æ„é€ äº†ä¸€ä¸ªæœ€ä¼˜çš„äºŒåˆ†åŒ¹é…è€Œä¸”æ¥ç€ä¼˜åŒ–ç›®æ ‡å‘ï¼ˆbounding boxï¼‰çš„æŸå¤±ã€‚</p>
<p>ç”¨$y$è¡¨ç¤ºçœŸå®å€¼ï¼Œ$\widehat{y}=\lbrace \widehat{y}<em>i\rbrace</em>{i=1}^N$æŒ‡ç¤ºNä¸ªé¢„æµ‹å€¼ã€‚å‡è®¾Nè¿œå¤§äºå›¾åƒä¸­çš„ç›®æ ‡ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºyçš„å¤§å°ä¹Ÿæ˜¯Nï¼Œç”¨$\phi$å¡«å……ç©ºå…ƒç´ ã€‚ç›®æ ‡å°±æ˜¯æ‰¾åˆ°è¿™ä¸¤ä¸ªé›†åˆçš„äºŒåˆ†åŒ¹é…ï¼Œä¸­çš„ä¸€ç§æ’åˆ—$\sigma$æœ‰ç€æœ€ä½çš„æŸå¤±ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211003192428870.png" alt="image-20211003192428870"></p>
<p>åŒ¹é…æŸå¤±åŒæ—¶è€ƒè™‘åˆ°ç±»åˆ«ä¸çœŸå®å€¼ä¸é¢„æµ‹å€¼ä¹‹é—´çš„ç›¸ä¼¼åº¦ï¼Œä½¿ç”¨çš„æ–¹æ³•æ˜¯åŒˆç‰™åˆ©ç®—æ³•</p>
<p>çœŸå®å€¼æ¯ä¸ªå…ƒç´ éƒ½å¯ä»¥çœ‹ä½œ$y_i=(c_i,b_i)$ï¼Œå…¶ä¸­$c_i$æ˜¯ç›®æ ‡ç±»åˆ«ï¼ˆå¯èƒ½æ˜¯$\phi$ï¼‰ï¼Œè€Œ$b_i \in [0,1]^4$å¯ä»¥ç†è§£ä¸ºbæ˜¯å€¼åŸŸåœ¨[0ï¼Œ1]çš„å››ç»´å‘é‡ï¼Œbboxçš„ä¸­å¿ƒåæ ‡ä¸å®½é«˜ã€‚</p>
<p>å¯¹äº$\sigma(i)$çš„é¢„æµ‹ï¼Œæˆ‘ä»¬å®šä¹‰ç±»åˆ«$c<em>i$çš„æ¦‚ç‡ä¸º$\widehat{p}</em>{\sigma(i)}(c<em>i)$é¢„æµ‹æ¡†ä¸º$\widehat{b}</em>{\sigma(i)}$ã€‚æˆ‘ä»¬å®šä¹‰$L<em>{match}(y_i,\widehat{y}</em>{\sigma(i)})$ä¸º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211003195822297.png" alt="image-20211003195822297"></p>
<p>ç¬¬äºŒæ­¥å°±æ˜¯è®¡ç®—æŸå¤±å‡½æ•°ï¼Œä¹‹å‰çš„æ­¥éª¤å°±æ˜¯ä½¿ç”¨åŒˆç‰™åˆ©ç®—æ³•è®¡ç®—æ‰€æœ‰çš„åŒ¹é…ã€‚æˆ‘ä»¬å®šä¹‰çš„lossä¸å¸¸è§çš„æ£€æµ‹æ¨¡å‹å¾ˆç›¸ä¼¼ï¼Œå°±æ˜¯è´Ÿå¯¹æ•°ä¼¼ç„¶ä¸boxæŸå¤±çš„çº¿æ€§ç»„åˆã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211003200122762.png" alt="image-20211003200122762"></p>
<h4 id="è¾¹ç•Œæ¡†æŸå¤±"><a href="#è¾¹ç•Œæ¡†æŸå¤±" class="headerlink" title="è¾¹ç•Œæ¡†æŸå¤±"></a>è¾¹ç•Œæ¡†æŸå¤±</h4><p>ä¸Šé¢æåˆ°äº†$L<em>{box}(b_i,\widehat{b}</em>{\sigma(i)})$,$L<em>{box}(b_i,\widehat{b}</em>{\sigma(i)})$æˆ‘ä»¬å®šä¹‰å¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211004100109331.png" alt="image-20211004100109331"></p>
<p>æˆ‘ä»¬ç›´æ¥é¢„æµ‹boxåœ¨å›¾åƒä¸­çš„ä½ç½®ï¼Œç›´æ¥ä½¿ç”¨L1lossçš„è¯ï¼Œå¯¹å°ç›®æ ‡å°±ä¸å…¬å¹³ï¼Œå› æ­¤æˆ‘ä»¬ä½¿ç”¨äº†L1 loss ä¸IOU lossçš„ç»„åˆï¼Œè®©losså¯¹ç›®æ ‡çš„å¤§å°ä¸æ•æ„Ÿã€‚</p>
<h4 id="éª¨æ¶"><a href="#éª¨æ¶" class="headerlink" title="éª¨æ¶"></a>éª¨æ¶</h4><p>å¼€å§‹è¾“å…¥åŸå§‹å›¾ç‰‡å¤§å°ä¸º$x_{img} \in \mathbb R^{3\times H_0 \times W_0}$ï¼ˆä¸‰é€šé“ï¼‰ï¼Œä½¿ç”¨CNNè¿›è¡Œç‰¹å¾æå–ï¼Œæœ€ç»ˆå¾—åˆ°ç‰¹å¾å›¾$f\in \mathbb R^{C\times H\times W}$ï¼Œå…¶ä¸­$C=2048$ å’Œ$H,W=\frac{H_0}{32},\frac{W_0}{32}$</p>
<h4 id="Transfomer-encoder"><a href="#Transfomer-encoder" class="headerlink" title="Transfomer encoder"></a>Transfomer encoder</h4><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/v2-c6a17e20665898daf3507fb8b805dfcf_720w.jpg" alt="img"></p>
<p>é¦–å…ˆä½¿ç”¨$1\times1$çš„å·ç§¯å°†åŸæ¥çš„$C=2048$é™ç»´åˆ°$d$ç»´ï¼Œå¾—åˆ°$z_0\in \mathbb R^{d\times H\times W}$çš„ç‰¹å¾å›¾ï¼Œå› ä¸ºç¼–ç å™¨éœ€è¦ä¸€ä¸ªåºåˆ—ä½œä¸ºè¾“å…¥å› æ­¤æˆ‘ä»¬å°†$z_0$å‹ç¼©åˆ°ä¸€ç»´ï¼Œå¾—åˆ°$d\times HW$çš„ç‰¹å¾æ˜ å°„ã€‚æ¯ä¸ªencoderå±‚ç”±multi-head self-attentionæ¨¡å—å’ŒFFNç»„æˆã€‚ç”±äºtransformerå¯¹æ’åˆ—é¡ºåºä¸æ•æ„Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬åŠ å…¥äº†ä½ç½®çš„ç¼–ç ï¼Œå¹¶æ·»åŠ åˆ°æ‰€æœ‰attentionå±‚çš„è¾“å…¥ã€‚</p>
<h4 id="Transfomer-decoder"><a href="#Transfomer-decoder" class="headerlink" title="Transfomer decoder"></a>Transfomer decoder</h4><p>ä¸å¸¸è§„transformerçš„åŒºåˆ«å°±æ˜¯ï¼Œæœ¬æ–‡å¯ä»¥å¹¶è¡Œçš„è§£ç ï¼Œè€Œä¹‹å‰çš„transformeréƒ½æ˜¯è‡ªå›å½’çš„ä¾æ¬¡è§£ç ã€‚ç”±äºdecoderä¹Ÿæ˜¯å¯¹æ’åˆ—é¡ºåºä¸æ•æ„Ÿï¼Œè¿™Nä¸ªåµŒå…¥å¿…é¡»ä¸ä¸€æ ·ï¼Œæ‰èƒ½é¢„æµ‹ä¸åŒçš„ç»“æœã€‚è¿™äº›è¾“å…¥çš„åµŒå…¥æ˜¯å­¦åˆ°çš„ä½ç½®ç¼–ç ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºobject queriesï¼Œç±»ä¼¼äºencoderï¼Œæˆ‘ä»¬æŠŠå®ƒä»¬åŠ åˆ°æ¯ä¸ªdecoderçš„è¾“å…¥ã€‚ç”±äºç”¨äº†transformerï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ å…¨å±€çš„ä¿¡æ¯ã€‚</p>
<h4 id="Prediction-feed-forward-networks-FFNs-ï¼ˆé¢„æµ‹å‰é¦ˆç½‘ç»œï¼‰"><a href="#Prediction-feed-forward-networks-FFNs-ï¼ˆé¢„æµ‹å‰é¦ˆç½‘ç»œï¼‰" class="headerlink" title="Prediction feed-forward networks(FFNs)ï¼ˆé¢„æµ‹å‰é¦ˆç½‘ç»œï¼‰"></a>Prediction feed-forward networks(FFNs)ï¼ˆé¢„æµ‹å‰é¦ˆç½‘ç»œï¼‰</h4><p>ç”±ä¸‰å±‚çš„æ„ŸçŸ¥å™¨è®¡ç®—ï¼Œä½¿ç”¨reluï¼Œéšå±‚çš„sizeä¸ºdï¼Œçº¿æ€§çš„æ˜ å°„å±‚ã€‚ä½¿ç”¨softmaxè¾“å‡ºç±»åˆ«æ¦‚ç‡ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/337649487">https://zhuanlan.zhihu.com/p/337649487</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/149252931">https://zhuanlan.zhihu.com/p/149252931</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/127774251">https://zhuanlan.zhihu.com/p/127774251</a></li>
<li><a href="https://blog.csdn.net/wd18508423052/article/details/111686666">https://blog.csdn.net/wd18508423052/article/details/111686666</a></li>
<li><a href="https://blog.csdn.net/donkey_1993/article/details/106939936">https://blog.csdn.net/donkey_1993/article/details/106939936</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/266069794">https://zhuanlan.zhihu.com/p/266069794</a></li>
</ul>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>transformer</tag>
        <tag>ç›®æ ‡æ£€æµ‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Learning Temporal Co-Attention Models for Unsupervised Video Action Localization</title>
    <url>/2021/06/15/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Learning%20Temporal%20Co-Attention%20Models%20for%20Unsupervised%20Video%20Action/</url>
    <content><![CDATA[<h1 id="Learning-Temporal-Co-Attention-Models-for-Unsupervised-Video-Action-Localization"><a href="#Learning-Temporal-Co-Attention-Models-for-Unsupervised-Video-Action-Localization" class="headerlink" title="Learning Temporal Co-Attention Models for Unsupervised Video Action Localization"></a>Learning Temporal Co-Attention Models for Unsupervised Video Action Localization</h1><h2 id="æå‡ºé—®é¢˜"><a href="#æå‡ºé—®é¢˜" class="headerlink" title="æå‡ºé—®é¢˜"></a>æå‡ºé—®é¢˜</h2><p>æœªä¿®å‰ªè§†é¢‘ä¸­çš„æ—¶é—´åŠ¨ä½œå®šä½ï¼ˆTemporal action localizationï¼ŒTALï¼‰ æœ€è¿‘è·å¾—äº†å·¨å¤§çš„ç ”ç©¶çƒ­æƒ…ï¼Œä½†æ˜¯TALç›®å‰å¹¶æ²¡æœ‰æ— ç›‘ç£çš„çš„æ–¹æ³•å‡ºç°ï¼Œæ‰€ä»¥æœ¬è®ºæ–‡æå‡ºäº†ç¬¬ä¸€ç§æ— ç›‘ç£çš„TALæ–¹æ³•ã€‚</p>
<h2 id="åšäº†ä»€ä¹ˆ"><a href="#åšäº†ä»€ä¹ˆ" class="headerlink" title="åšäº†ä»€ä¹ˆ"></a>åšäº†ä»€ä¹ˆ</h2><p>ä¸ºäº†è§£å†³åŠ¨ä½œå®šä½ï¼Œä¸¤æ­¥è¿›è¡Œ â€œèšç±»+å®šä½â€è¿­ä»£è¿‡ç¨‹ã€‚</p>
<p>èšç±»æ­¥éª¤ä¸ºå®šä½æ­¥éª¤æä¾›äº†noisyçš„ä¼ªæ ‡è®°ï¼Œè€Œå®šä½æ­¥éª¤æä¾›äº†æ—¶é—´å…±å…³æ³¨æ¨¡å‹ï¼Œä»è€Œæé«˜äº†èšç±»æ€§èƒ½ï¼Œè¿™ä¸¤ä¸ªè¿‡ç¨‹ç›¸è¾…ç›¸æˆã€‚</p>
<p>åœ¨å¼±ç›‘ç£ä¸‹ TALå¯è¢«è§†ä¸ºæˆ‘ä»¬ACLçš„ç›´æ¥æ‰©å±•æ¨¡å‹ã€‚</p>
<p>ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬çš„è´¡çŒ®æœ‰ä¸¤ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li><p>ä»è§†é¢‘çº§æ ‡ç­¾æˆ–ä¼ªæ ‡ç­¾ä¸­å­¦ä¹ çš„æ—¶é—´å…±åŒæ³¨æ„æ¨¡å‹ï¼Œæ— è®ºæ˜¯é’ˆå¯¹ç‰¹å®šç±»åˆ«è¿˜æ˜¯ä¸å¯çŸ¥ç±»åˆ«çš„ ä»¥åå¤å¼ºåŒ–çš„æ–¹å¼ï¼› </p>
</li>
<li><p>ä¸ºACLè®¾è®¡äº†æ–°çš„lossï¼ŒåŒ…æ‹¬<code>action-background separation loss</code>å’Œ<code>cluster-based triplet loss</code>ã€‚ </p>
</li>
</ul>
<p>æœ€ç»ˆçš„æˆç»©ï¼š</p>
<p>é’ˆå¯¹20ç§åŠ¨ä½œTHUMOS14å’Œ100ç§ è¡ŒåŠ¨ActivityNet-1.2ã€‚ åœ¨ä¸¤ä¸ªåŸºå‡†ä¸Šï¼Œå»ºè®® ACLçš„æ¨¡å‹å…·æœ‰å¼ºå¤§çš„æ€§èƒ½ï¼Œç”šè‡³å¯ä»¥ä¸æœ€æ–°çš„å¼±ç›‘ç£æ–¹æ³•ç›¸æ¯”ã€‚ ä¾‹å¦‚ï¼Œä»¥å‰æœ€å¥½çš„å¼±ç›‘ç£ åœ¨THUMOS14ä¸Šçš„mAP@0.5ä¸‹ï¼Œæ¨¡å‹è¾¾åˆ°äº†26.8ï¼…ï¼Œ æˆ‘ä»¬çš„æ–°è®°å½•åˆ†åˆ«ä¸º30.1ï¼…ï¼ˆå¼±ç›‘ç£ï¼‰å’Œ25.0ï¼… ï¼ˆæ— ç›‘ç£ï¼‰ã€‚</p>
<span id="more"></span>
<h2 id="æ€ä¹ˆåš"><a href="#æ€ä¹ˆåš" class="headerlink" title="æ€ä¹ˆåš"></a>æ€ä¹ˆåš</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415103823407.png" alt="image-20210415103823407"></p>
<h3 id="Video-Feature-Extraction"><a href="#Video-Feature-Extraction" class="headerlink" title="Video Feature Extraction"></a>Video Feature Extraction</h3><p>ç»™å®šä¸€ä¸ªæœªä¿®å‰ªçš„è§†é¢‘ï¼Œæˆ‘ ä»¤$X^R,X^F\in \mathbb{R}^{T \times D}$åˆ†åˆ«ä»£è¡¨ç‰‡æ®µå¼RGBå’Œflowç‰¹å¾åºåˆ—ï¼Œå…¶ä¸­$T$ä»£è¡¨ç‰‡æ®µçš„æ•°é‡ï¼Œ$D$ä»£è¡¨ç‰¹å¾å°ºå¯¸ã€‚</p>
<h3 id="Clustering"><a href="#Clustering" class="headerlink" title="Clustering"></a>Clustering</h3><p>ç›®å‰æˆ‘ä»¬çŸ¥é“è®­ç»ƒé›†çš„åŠ¨ä½œç±»åˆ«<code>C</code>çš„æ•°é‡ã€‚ä¸ºäº†è·å¾—æ¯ä¸ªè§†é¢‘çš„è§†é¢‘çº§ä¼ªæ ‡ç­¾ï¼Œæˆ‘ä»¬åœ¨è®­ç»ƒé›†ä¸Šåˆ©ç”¨é¢‘è°±èšç±»ç®—æ³•æ¥è·å¾—<code>C</code>ä¸ªèšç±»ï¼Œä»¥ä¾¿å¯ä»¥æ ¹æ®è§†é¢‘çš„åˆ†é…ç»™æ¯ä¸ªè§†é¢‘ä¸€ä¸ªä¼ªæ ‡ç­¾ã€‚</p>
<p>å¯¹äºæ¯ä¸ªè§†é¢‘$v$,æˆ‘ä»¬åŒæ ·å¾—åˆ°è§†é¢‘çš„RGBå’Œflowç‰¹å¾$X^R,X^F\in \mathbb{R}^{T \times D}$ï¼Œä»¤$S^R<em>{v,i},S^F</em>{v,i} \in R ^{T_vÃ—1}$ä¸ºç¬¬iæ¬¡è¿­ä»£ä¸­çš„class-agnostic attention weightsæƒé‡ã€‚å› ä¸ºè¿™ä¸ªæ˜¯è®­ç»ƒçš„æ—¶å€™æ‰èƒ½å¾—åˆ°æ‰€ä»¥æœ€å¼€å§‹å¯ä»¥éƒ½è®¾ä¸º<code>1/T</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action//image-20210415160529774.png" alt="image-20210415160529774"></p>
<p>å¯¹äºè§†é¢‘$v$åœ¨è¿­ä»£iäº§ç”Ÿçš„RGBç‰¹å¾å’Œå…‰æµç‰¹å¾å°±èƒ½å¾—åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415161152468.png" alt="image-20210415161152468"></p>
<p>å°†æ¯ä¸ªè§†é¢‘$v$çš„RGBç‰¹å¾$f^R$å’Œå…‰æµç‰¹å¾$f^F$  concatenateæˆæœ€åçš„æ€»ç‰¹å¾$f_i$ï¼ˆè¿™ä¸ªç›®çš„æ˜¯å»é™¤æ‰èƒŒæ™¯ï¼‰ï¼Œè¿™æ ·å°±å¾—åˆ°äº†æ¯ä¸ªè§†é¢‘$v$çš„ç‰¹å¾ï¼Œå°±å¯ä»¥æ„å»ºå›¾ç»“æ„äº†ã€‚</p>
<p>å¯¹äºå›¾G = {V, E}ï¼Œå…¶ä¸­Vè¡¨ç¤ºé¡¶ç‚¹çš„é›†åˆï¼Œå³è®­ç»ƒé›†è§†é¢‘ï¼ŒEè¡¨ç¤ºè¾¹ç¼˜çš„é›†åˆã€‚å…¶ä¸­$v<em>i,v_j$çš„æƒé‡$w</em>{i,j}$ç”±</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415161728852.png" alt="image-20210415161728852"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415161738706.png" alt="image-20210415161738706"></p>
<p>è®¡ç®—å¾—æ¥ã€‚åŸºäºæ„é€ çš„å›¾ï¼Œä½¿ç”¨é¢‘è°±èšç±»ç®—æ³•å°†æœªä¿®å‰ªçš„è§†é¢‘åˆ†ç»„ä¸ºCä¸ªç°‡ï¼Œæ¯ä¸ªç°‡éƒ½å®šä¹‰äº†ä¸€ä¸ªä¼ªåŠ¨ä½œã€‚ç„¶åï¼Œå°†è¿™äº›è§†é¢‘çº§ä¼ªæ ‡ç­¾ç”¨äºè®­ç»ƒåŠ¨ä½œå®šä½æ¨¡å‹ã€‚å¯¹äºå¼±ç›‘ç£æ‰©å±•ï¼Œæ¯ä¸ªè§†é¢‘å‡å…·æœ‰è§†é¢‘çº§åˆ«æ ‡ç­¾ï¼Œå› æ­¤è·³è¿‡äº†èšç±»ã€‚</p>
<h3 id="Local-Global-Feature-Aggregation-Block"><a href="#Local-Global-Feature-Aggregation-Block" class="headerlink" title="Local-Global Feature Aggregation Block"></a>Local-Global Feature Aggregation Block</h3><p>ç”±äºæ¯ä¸ªæ®µçš„ç‰¹å¾ä»…åŒ…å«å½“å‰ä»£ç æ®µçš„ä¿¡æ¯ï¼Œå› æ­¤ç¼ºå°‘æ—¶é—´ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚ä¸ºäº†æé«˜æ¯ä¸ªä»£ç æ®µç‰¹å¾çš„å¯åˆ†è¾¨æ€§ï¼Œæå‡ºäº†å±€éƒ¨å…¨å±€ç‰¹å¾èšåˆå—ï¼ˆLocal-Global Feature Aggregation Blockï¼ŒFABï¼‰ä»¥æå–å±€éƒ¨å’Œå…¨å±€ä¸Šä¸‹æ–‡ä¿¡æ¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415162119941.png" alt="image-20210415162119941"></p>
<p>FABä¸»è¦æ˜¯ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>a 1D temporal convolution branch</li>
<li>a dilated temporal pyramid branch</li>
<li>a global context branch</li>
</ul>
<p>dilated temporal pyramid branchç”±2ä¸ªå¹¶è¡Œçš„å·ç§¯ç»„æˆï¼Œå®ƒä»¬å…·æœ‰ä¸åŒçš„æ‰©å¼ ç‡ï¼Œä»¥èšé›†å±€éƒ¨æ—¶é—´ä¸Šä¸‹æ–‡ã€‚</p>
<p>global context branchä½¿ç”¨non-localç½‘ç»œæ•è·æ‰€æœ‰å¸§ä¹‹é—´çš„æ—¶é—´ç›¸å…³æ€§ã€‚åœ¨å…¨å±€ä¸Šä¸‹æ–‡åˆ†æ”¯ä¹‹å‰æ·»åŠ äº†å†…æ ¸å¤§å°ä¸º1çš„ä¸€ç»´æ—¶é—´å·ç§¯ä»¥é™ä½è®¡ç®—æˆæœ¬ã€‚</p>
<p>æ‰€æœ‰åˆ†æ”¯çš„è¾“å‡ºé€šè¿‡ä¸€ç»´æ—¶é—´å·ç§¯è¿›è¡Œçº§è”å’Œèåˆã€‚è¿™æ­¥å¯ä»¥ç†è§£ä¸ºå°†ç‰¹å¾å¯Œå«ä¸Šäº†ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå³è§†é¢‘çš„æ—¶åºä¿¡æ¯ï¼Œç»è¿‡äº†è¿™ä¸ªmoduleåä¾¿å¾—åˆ°äº†ç‰¹å¾ä¿¡æ¯$X_e$</p>
<h3 id="Class-Specific-Temporal-Attention-Module"><a href="#Class-Specific-Temporal-Attention-Module" class="headerlink" title="Class-Specific Temporal Attention Module"></a>Class-Specific Temporal Attention Module</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415173239749.png" alt="image-20210415173239749"></p>
<p>è¿™ä¸ªæ¨¡å—çš„åŠŸèƒ½ä¸»è¦æ˜¯è·å¾—åœ¨ä¸åŒæ—¶é—´å‡ºç°çš„ä¸åŒåŠ¨ä½œç±»åˆ«çš„æ¦‚ç‡ã€‚</p>
<p>ä»¥$X_{cs}$ä¸­é—´å±‚ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡ºç±»ç‰¹å®šåˆ†æ•°$A \in R^{T \times C}$,å…¶ä¸­Tæ˜¯åˆ†æ®µæ•°ï¼ŒCæ˜¯åˆ†ç±»æ€»æ•°ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºåˆ†æ•°Aè¡¨ç¤ºäº†æ¯æ®µæ˜¯æŸä¸€ç±»åŠ¨ä½œçš„æ¦‚ç‡ã€‚æœ€ç»ˆè¿˜æ˜¯åŠ ä¸Šäº†softmaxæ¥å½’ä¸€åŒ–</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415172547677.png" alt="image-20210415172547677"></p>
<p>è¿™ä¸ªæ¨¡å—é™¤äº†è®¡ç®—åˆ†æ•°Aä¹‹å¤–ï¼Œè¿˜ä¼šè®¡ç®—åŠ¨ä½œèƒŒæ™¯åˆ†ç¦»æŸå¤±(action-background separation loss)ã€‚</p>
<p>å¯¹äºä¸€æ‰¹è®­ç»ƒè§†é¢‘ï¼Œæˆ‘ä»¬ä»éšæœºè®­ç»ƒé›†çš„$C$ç°‡ä¸­ï¼ŒæŠ½å–å‡º$Z$ç°‡ï¼Œå†ä»$Z$ç°‡ä¸­å„è‡ªæŠ½å–å‡º$K$ä¸ªè§†é¢‘ï¼Œå®šä¹‰$V_z$ä¸ºå±äºæŸä»¥ç°‡çš„$K$ä¸ªè§†é¢‘çš„é›†åˆ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415193402240.png" alt="image-20210415193402240"></p>
<p>å¯¹äºæ¯ä¸ªè§†é¢‘$v_k$ï¼Œæˆ‘ä»¬è®¡ç®—åŠ¨ä½œç‰¹å¾å’ŒèƒŒæ™¯ç‰¹å¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415193715643.png" alt="image-20210415193715643"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415193703592.png" alt="image-20210415193703592"></p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜è¦åŠ ä¸Šè¿™ä¸‰æ¡é™åˆ¶ï¼š</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€å¯¹å±äº$V_z$çš„è§†é¢‘$v_m$å’Œ$v_n$ã€‚ä»¤dè¡¨ç¤ºä½™å¼¦è·ç¦»å‡½æ•°ï¼ŒÏ„1å’ŒÏ„2åˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªcosä½™å¼¦è·ç¦»ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿è§†é¢‘é—´åŠ¨ä½œçš„é«˜åº¦ç›¸ä¼¼æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹ç­‰å¼æ¥å¼ºåˆ¶æ‰§è¡Œæ­¤è¦æ±‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415194047630.png" alt="image-20210415194047630"></p>
<p>ä¸ºäº†æ»¡è¶³è¾ƒé«˜çš„è§†é¢‘å†…åŠ¨ä½œ-èƒŒæ™¯æ¸…æ™°åº¦ï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹æ–¹ç¨‹å¼:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415194318008.png" alt="image-20210415194318008"></p>
<p>ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°æŸå¤±å‡½æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415194718815.png" alt="image-20210415194718815"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415194728168.png" alt="image-20210415194728168"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415194739349.png" alt="image-20210415194739349"></p>
<p>è¿™ä¸ªlossçš„ä½œç”¨ä¸»è¦æ˜¯åŠ å¼ºåŒç°‡ä¸­è§†é¢‘çš„åŠ¨ä½œç›¸ä¼¼æ€§å’ŒåŠ¨ä½œèƒŒæ™¯çš„åˆ†ç¦»æ€§</p>
<h3 id="Class-Agnostic-Temporal-Attention-Module"><a href="#Class-Agnostic-Temporal-Attention-Module" class="headerlink" title="Class-Agnostic Temporal Attention Module"></a>Class-Agnostic Temporal Attention Module</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415173213102.png" alt="image-20210415173213102"></p>
<p>è¿™ä¸ªæ¨¡å—çš„åŠŸèƒ½æ˜¯ä¸ºäº†å­¦ä¹ å’ŒåŠ¨ä½œç±»åˆ«æ— å…³çš„éƒ¨åˆ†å³èƒŒæ™¯éƒ¨åˆ†å‡ºç°çš„æ¦‚ç‡</p>
<p>ä»¥$X_{ca}$ä½œä¸ºè¾“å…¥ï¼Œè¾“å‡ºç±»æ— å…³åˆ†æ•°$S \in R^{T \times 1}$ï¼Œè¿™ä¸ªåˆ†æ•°å’Œä¸Šé¢çš„$A$æœ‰ç›¸åŒçš„ä½œç”¨</p>
<p>é™¤äº†è®¡ç®—$S$ä¹‹å¤–ï¼Œè¿™ä¸ªæ¨¡å—ä¹Ÿè®¡ç®—äº†cluster-based triplet lossï¼Œè®¡ç®—æ–¹å¼å’Œä¸Šé¢æœ‰äº›ç±»ä¼¼</p>
<p>å…ˆè®¡ç®—class-agnostic video feature representation H</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415195736514.png" alt="image-20210415195736514"></p>
<p>æŠ½å–å‡ºæŸä¸€ç°‡å†…çš„ä¸€ä¸ªè§†é¢‘$v_a$ï¼Œå‡è®¾$v_n$æ˜¯ä¸åœ¨ç¾¤é›†zä¸­å¹¶ä¸”ä¸$v_a$çš„è·ç¦»æœ€å°çš„è§†é¢‘ï¼Œ$v_p$æ˜¯ç¾¤é›†zä¸­çš„è§†é¢‘å¹¶ä¸”ä¸$v_a$çš„è·ç¦»æœ€å¤§ï¼Œæœ‰è¿™æ ·çš„é™åˆ¶ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415200547254.png" alt="image-20210415200547254"></p>
<p>æ¥ç€å°±å¯ä»¥è®¡ç®—cluster-based triplet loss</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415200747883.png" alt="image-20210415200747883"></p>
<p>è¿™ä¸ªLOSSçš„æ„ä¹‰å¾ˆæ˜ç¡®ï¼Œä¸ºäº†å°†åŒä¸€èšç±»çš„è§†é¢‘ç‰¹å¾è¡¨ç¤ºæ‹‰è¿‘ï¼Œå¹¶å°†ä¸åŒèšç±»çš„è§†é¢‘ç‰¹å¾è¡¨ç¤ºåœ¨ç‰¹å¾ç©ºé—´ä¸­æ¨å¾—æ›´è¿œ</p>
<h3 id="æœ€ç»ˆlossè®¡ç®—"><a href="#æœ€ç»ˆlossè®¡ç®—" class="headerlink" title="æœ€ç»ˆlossè®¡ç®—"></a>æœ€ç»ˆlossè®¡ç®—</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415202421538.png" alt="image-20210415202421538"></p>
<p>å…¶ä¸­$L_{cls}$æ˜¯ç»å…¸çš„äº¤å‰ç†µæŸå¤±</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/image-20210415202705033.png" alt="image-20210415202705033"></p>
<p>å…¶ä¸­$y_n$è¡¨ç¤ºè§†é¢‘$v_n$çš„æ ‡ç­¾ï¼Œ${p}^n$è¡¨ç¤ºè§†é¢‘$v_n$çš„é¢„æµ‹æ ‡ç­¾ã€‚</p>
<p>è‡³äº$p$çš„æ˜¯è®¡ç®—æ–¹æ³•åˆ™æ˜¯<br><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/Learning Temporal Co-Attention Models for Unsupervised Video Action/202009101218470.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p>
<p>é€šè¿‡æ²¿pä¸Šçš„ç±»åˆ«ç»´æ‰§è¡Œsoftmaxï¼Œå¯ä»¥å¾—åˆ°åŠ¨ä½œç±»$\hat {p}^n$ä¸Šçš„æ¦‚ç‡åˆ†å¸ƒ</p>
<p>å‚è€ƒï¼š<a href="https://blog.csdn.net/qq_43310834/article/details/108502214">https://blog.csdn.net/qq_43310834/article/details/108502214</a></p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>åŠ¨ä½œæ£€æµ‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Fine-grained Temporal Contrastive Learning for Weakly-supervised Temporal Action Localization</title>
    <url>/2022/07/22/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Fine-grained%20Temporal%20Contrastive%20Learning%20for%20Weakly-supervised%20Temporal%20Action%20Localization/</url>
    <content><![CDATA[<h1 id="Fine-grained-Temporal-Contrastive-Learning-for-Weakly-supervised-Temporal-Action-Localization"><a href="#Fine-grained-Temporal-Contrastive-Learning-for-Weakly-supervised-Temporal-Action-Localization" class="headerlink" title="Fine-grained Temporal Contrastive Learning for Weakly-supervised Temporal Action Localization"></a>Fine-grained Temporal Contrastive Learning for Weakly-supervised Temporal Action Localization</h1><h2 id="æ–‡ç« ç®€ä»‹"><a href="#æ–‡ç« ç®€ä»‹" class="headerlink" title="æ–‡ç« ç®€ä»‹"></a>æ–‡ç« ç®€ä»‹</h2><p>æ–‡ç« å‘è¡¨åœ¨<strong>CVPR2022</strong>ä¸Šï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œä½œè€…å‘ç°ç›®å‰å¼±ç›‘ç£åŠ¨ä½œå®šä½ï¼ˆWSALï¼‰çš„ä»»åŠ¡ï¼Œä¸»è¦é‡‡ç”¨æŒ‰åˆ†ç±»å®šä½çš„èŒƒå¼ï¼Œè¿™ç§èŒƒå¼å¿½ç•¥äº†è§†é¢‘åºåˆ—ä¹‹é—´å¯Œæœ‰æˆæ•ˆçš„ç»†ç²’åº¦æ—¶é—´å·®å¼‚ï¼Œåœ¨åˆ†ç±»å­¦ä¹ å’Œåˆ†ç±»åˆ°å®šä½çš„é€‚åº”ä¸­å­˜åœ¨ä¸¥é‡çš„æ­§ä¹‰ã€‚ä¸ºæ­¤ä½œè€…æå‡º<strong>ç»†ç²’åº¦åºåˆ—è·ç¦»ï¼ˆFSDï¼‰å¯¹æ¯”</strong>å’Œ<strong>æœ€é•¿å…¬å…±å­åºåˆ—ï¼ˆLCSï¼‰å¯¹æ¯”</strong>ï¼Œç¼“è§£åˆ†ç±»å’Œå®šä½ä¹‹é—´çš„ä»»åŠ¡å·®è·ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728221208824.png" alt="image-20220728221208824"></p>
<span id="more"></span>
<h2 id="è®ºæ–‡åŠ¨æœº"><a href="#è®ºæ–‡åŠ¨æœº" class="headerlink" title="è®ºæ–‡åŠ¨æœº"></a>è®ºæ–‡åŠ¨æœº</h2><p>ç›®å‰WSALå¤šé‡‡ç”¨æŒ‰åˆ†ç±»å®šä½ï¼ˆlocalization-by-classificationï¼‰çš„èŒƒå¼ã€‚ä»–æ—¨åœ¨ç”Ÿæˆæ—¶é—´ç±»æ¿€æ´»åºåˆ—ï¼ˆCASï¼‰ã€‚å¤§å¤šæ•°æ–¹æ³•é‡‡ç”¨çš„æ˜¯ä½¿ç”¨<strong>å¤šå®ä¾‹å­¦ä¹ MIL</strong>å’Œ<strong>attention</strong>æœºåˆ¶æ¥è®­ç»ƒæ¨¡å‹ï¼Œä»¥è·å¾—å…·æœ‰ä¸åŒç±»æ¿€æ´»çš„ç‰‡æ®µï¼Œå†é€šè¿‡é˜ˆå€¼åŒ–å’Œåˆå¹¶è¿™äº›æ¿€æ´»æ¥æ¨æ–­æœ€ç»ˆåŠ¨ä½œå®šä½ç»“æœã€‚</p>
<p>å­˜åœ¨é—®é¢˜ï¼š</p>
<p>ï¼ˆ1ï¼‰åœ¨å¼±ç›‘ç£ä¸­ç¼ºä¹<strong>è¶³å¤Ÿçš„æ³¨é‡Š</strong>ï¼Œå­¦ä¹ çš„åˆ†ç±»å™¨æ²¡æœ‰è¶³å¤Ÿçš„åŒºåˆ†æ€§å’Œé²æ£’æ€§ï¼Œå¯¼è‡´<strong>åŠ¨ä½œèƒŒæ™¯åˆ†ç¦»å›°éš¾</strong>ã€‚ </p>
<p>ï¼ˆ2ï¼‰åˆ†ç±»å’Œå®šä½ä¹‹é—´å­˜åœ¨ä»»åŠ¡å·®è·ï¼Œå­¦ä¹ çš„åˆ†ç±»å™¨é€šå¸¸å…³æ³¨<strong>æ˜“äºåŒºåˆ†çš„ç‰‡æ®µ</strong>ï¼Œè€Œå¿½ç•¥å®šä½ä¸­<strong>ä¸çªå‡ºçš„ç‰‡æ®µ</strong>ã€‚å› æ­¤ï¼Œå±€éƒ¨æ—¶é—´åºåˆ—é€šå¸¸æ˜¯ä¸å®Œæ•´å’Œä¸ç²¾ç¡®çš„ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728221303202.png" alt="image-20220728221303202"></p>
<p>ä¸ºäº†è§£å†³ä¸Šè¯‰é—®é¢˜æå‡ºäº†Fine-grained Temporal Contrastive Learning (FTCL)ã€‚</p>
<p>ï¼ˆ1ï¼‰è®¡ç®—<strong>ç»†ç²’åº¦åºåˆ—è·ç¦»</strong>(FSD)ï¼Œè¿™ä¸ªè®¡ç®—å¯ä»¥é€šè¿‡è®¡ç®—å°†ä¸€ä¸ªåºåˆ—è½¬æ¢ä¸ºå¦ä¸€ä¸ªåºåˆ—æ‰€éœ€çš„æœ€å°æˆæœ¬æ¥è¯„ä¼°ä¸¤ä¸ªåºåˆ—åœ¨ç»“æ„ä¸Šæ˜¯å¦ç›¸ä¼¼ ã€‚æ¯”å¦‚ä¸‹å›¾é€šè¿‡Action instance1å’ŒAction instance2ä»¥åŠAction instance1å’ŒBackground instanceå¯¹æ¯”ï¼Œä»è€Œå®ç°åŠ¨ä½œå’ŒèƒŒæ™¯åˆ†ç¦»ã€‚</p>
<p>ï¼ˆ2ï¼‰æŒ–æ˜ä¸¤ä¸ªåŒ…å«ç›¸åŒåŠ¨ä½œè§†é¢‘ä¹‹é—´çš„<strong>æœ€é•¿å…¬å…±å­åºåˆ—</strong>(LCS)ï¼ŒåŒä¸€ç±»åˆ«çš„ä¸åŒè§†é¢‘åºåˆ—å¯ä»¥é€šè¿‡ä¼˜åŒ–LCSä¸ºæ¢ç´¢å®Œæ•´çš„åŠ¨ä½œå®ä¾‹æä¾›è¡¥å……çº¿ç´¢ï¼Œæ¯”å¦‚è®©Action instance1å’ŒAction instance2è®¡ç®—LCSï¼Œå¯ä»¥è®©æ¨¡å‹å­¦ä¹ åˆ°åŠ¨ä½œçš„å®Œæ•´æ€§ï¼Œæ¯”å¦‚å¯¹äºè¿™ä¸ªAction instance1ä¸¾é‡æœ€åä¸€ä¸ªå¸§å’ŒAction instance2å¯¹åº”è¿™æ ·å°±ä¸ä¼šå­¦ä¸¢äº†å¸§ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728221451595.png" alt="image-20220728221451595"></p>
<p>æ¨¡å‹çš„æ€»ä½“ç»“æ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728234726191.png" alt="image-20220728234726191"></p>
<h2 id="Notations-and-Preliminaries"><a href="#Notations-and-Preliminaries" class="headerlink" title="Notations and Preliminaries"></a>Notations and Preliminaries</h2><p>ç»™å®šè§†é¢‘Xå’Œä»–çš„æ ‡ç­¾$y \in \mathbb R^c$ ã€‚ä½œè€…å°†è§†é¢‘åˆ’åˆ†ä¼ªä¸é‡å çš„Tæ®µï¼Œå¹¶ä½¿ç”¨ç‰¹å¾æå–å™¨è·å¾—ç‰¹å¾$X=[x_1,â€¦,x_T]\in \mathbb R^{D\times T}$ï¼Œæœ€åè¾“å…¥åˆ°ä¸€ä¸ªåµŒå…¥æ¨¡å—ï¼Œç”¨äºç”Ÿæˆ$T$ã€‚</p>
<p>ç›®å‰ï¼Œç°æœ‰çš„ä¸»æµæ–¹æ³•ä¸»è¦é‡‡ç”¨æŒ‰åˆ†ç±»å®šä½çš„æ¡†æ¶ï¼Œæ”¹æ¡†æ¶æœå…ˆå­¦ä¹ å°†ç‰‡æ®µçº§åˆ«ç‰¹å¾èšåˆåˆ°è§†é¢‘åµŒå…¥çš„é‡è¦æ€§åˆ†æ•°ï¼Œç„¶åä½¿ç”¨è§†é¢‘çº§åˆ«æ ‡ç­¾è¿›è¡ŒåŠ¨ä½œåˆ†ç±»ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728234904130.png" alt="image-20220728234904130"></p>
<p>å…¶ä¸­$\alpha<em>t=f</em>{\alpha}(x<em>t)$ä¸ºå­¦ä¹ åˆ°çš„é‡è¦æ€§åˆ†æ•°ï¼Œå°†ç”Ÿæˆçš„è§†é¢‘ç‰¹å¾è¿›ä¸€æ­¥é€å…¥åˆ°åˆ†ç±»å™¨ä»¥è·å¾—é¢„æµ‹ç»“æœ$\tilde{y}=f</em>{cls}(\bar{x})$ã€‚ç»è¿‡æ¨¡å‹è®­ç»ƒåã€‚ä½¿ç”¨$f<em>\alpha(\cdot)$å’Œ$f</em>{cls}(\cdot)$æ¥æ¨æ–­æµ‹è¯•è§†é¢‘çš„ç‰‡æ®µçº§åˆ«æ¿€æ´»åºåˆ—CASã€‚</p>
<h2 id="Discriminative-Aciton-Background-Separation-via-FSD-Contrasting"><a href="#Discriminative-Aciton-Background-Separation-via-FSD-Contrasting" class="headerlink" title="Discriminative Aciton-Background Separation via FSD Contrasting"></a>Discriminative Aciton-Background Separation via FSD Contrasting</h2><p>åœ¨ä¸Šè¿°åˆ†ç±»å®šä½æ¡†æ¶ä¸­ï¼Œä¸ºäº†å­¦ä¹ åˆ¤åˆ«è¿åŠ¨èƒŒæ™¯åˆ†ç±»ï¼Œç°æœ‰çš„ä¸€äº›æ–¹æ³•åŸºæœ¬ä½¿ç”¨å…¨å±€ç‰¹å¾è¿›è¡Œå­¦ä¹ ï¼Œè¿™äº›æ–¹æ³•å¿½ç•¥äº†è§†é¢‘ä¹‹é—´<strong>ç»†ç²’åº¦</strong>æ—¶é—´å·®å¼‚ï¼Œå¯¼è‡´è¾¨åˆ«èƒ½åŠ›ä¸å¤Ÿã€‚</p>
<p>ç°æœ‰çš„æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡æµ‹é‡ä¸¤ä¸ªåºåˆ—çš„å…¨å±€ç‰¹å¾è¡¨ç¤ºä¹‹é—´çš„å‘é‡è·ç¦»æ¥è®¡ç®—å…¶ç›¸ä¼¼æ€§ã€‚è€Œä½œè€…å¸Œæœ›é€šè¿‡è¯„ä¼°ä¸€ä¸ªåºåˆ—è½¬æ¢ä¸ºå¦ä¸€ä¸ªåºåˆ—æ‰€éœ€çš„æœ€å°ä»£ä»·æ¥ç¡®å®šä¸¤ä¸ªåºåˆ—åœ¨ç»“æ„ä¸Šæ˜¯å¦ç›¸ä¼¼ï¼ˆå¦‚æœè¶Šç›¸ä¼¼ï¼Œè½¬æ¢çš„ä»£ä»·è¶Šå°ï¼‰ã€‚</p>
<p>æœ¬æ¥è¿™ä¸ªé—®é¢˜æ˜¯ä¸ªnpé—®é¢˜ï¼Œä½†æ˜¯ä½œè€…ä½¿ç”¨äº†åŠ¨æ€è§„åˆ’ç®—æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸ºæ­¤ä½œè€…è®¾è®¡äº†å¯ä»¥å¾®åˆ†çš„åŒ¹é…ã€æ’å…¥å’Œåˆ é™¤åŠ¨ä½œç¬¦ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œé€šè¿‡å­¦ä¹ åˆ°çš„CASï¼Œä½œè€…ç§‘å¯ä»¥ç”Ÿæˆå„ç§åŠ¨ä½œ/èƒŒæ™¯proposalsï¼Œå…¶ä¸­åŠ¨ä½œproposals $U$åŒ…å«é«˜åŠ¨ä½œæ¿€æ´»ç‰‡æ®µï¼Œè€ŒèƒŒæ™¯proposals $V$åˆ™ç›¸åã€‚å¯¹äºé•¿åº¦åˆ†åˆ«ä¸ºMå’ŒNçš„ä¸¤ä¸ªåºåˆ—ï¼Œ $U=[u_1,â€¦,u_m]\in \mathbb R^{D\times M}$å’Œ $V=[v_1,â€¦,v_m]\in \mathbb R^{D\times N}$ï¼Œå®ƒä»¬çš„ç›¸ä¼¼åº¦æŒ‰ç…§å¦‚ä¸‹çš„é€’å½’è¿›è®¡ç®—ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235011250.png" alt="image-20220728235011250"></p>
<p>å…¶ä¸­å­åºåˆ—ç›¸ä¼¼åº¦è¯„åˆ†$S(i,j)$åœ¨ç¬¬ä¸€ä¸ªåºåˆ—$U$çš„$i$ä½ç½®å’Œç¬¬äºŒä¸ªåºåˆ—$V$çš„$j$ä½ç½®æ±‚å€¼ã€‚$S(0,:)$å’Œ$S(:,0)$åˆå§‹åŒ–ä¸º$0$ã€‚ç›´è§‚ä¸Šï¼Œåœ¨ä½ç½®$(i,j)$ï¼Œå¦‚æœ$u<em>i$å’Œ$v_j$åŒ¹é…ï¼Œåº”è¯¥æé«˜åºåˆ—ç›¸ä¼¼åº¦å¾—åˆ†ã€‚å¦‚æœæ‰§è¡Œæ’å…¥æˆ–è€…åˆ é™¤åŠ¨ä½œç›¸ä¼¼æ€§å¾—åˆ†åº”è¯¥é™ä½ã€‚ä½œè€…å­¦ä¹ äº†ä¸‰ç§ç±»å‹çš„æ®‹å€¼(æ ‡é‡):$\mu</em>{i,j},g<em>{i,j}$å’Œ$h</em>{i,j}$ã€‚</p>
<p>è¿™é‡Œä»¥$\mu<em>{i,j}$å’Œ$g</em>{i,j}$ä¸ºä¾‹ï¼Œè®¡ç®—å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235041653.png" alt="image-20220728235041653"></p>
<p>å…¶ä¸­$\Delta^\mu<em>{i,j}=[f</em>\mu(u<em>i),f</em>\mu(v<em>j)],\Delta^g</em>{i,j}$ç±»ä¼¼ã€‚$f<em>\mu(\cdot),f_g(\cdot),f_h(\cdot)$æ˜¯ä¸‰å±‚å…¨è¿æ¥å±‚ã€‚ä½œè€…ä½¿ç”¨è¿™äº›å‡½æ•°æ¥æ¨¡æ‹Ÿä¸åŒçš„åŠ¨ä½œï¼ŒåŒ…æ‹¬åŒ¹é…ã€æ’å…¥å’Œåˆ é™¤ã€‚$\sigma</em>\mu$å’Œ$\sigma_g$æ˜¯æ±‚å¾—æ®‹å·®å€¼çš„æ¿€æ´»å‡½æ•°ã€‚</p>
<p>ç»è¿‡ä¸Šè¿°é€’å½’è®¡ç®—ï¼Œä¿è¯$S(i,j)$ä¸ºä¸¤ä¸ªåºåˆ—ä¹‹é—´çš„æœ€ä¼˜ç›¸ä¼¼åº¦å¾—åˆ†ã€‚æ˜¾ç„¶æ¥è‡ªåŒä¸€ç±»åˆ«çš„ä¸¤é¡¹åŠ¨ä½œproposalsä¹‹é—´çš„ç›¸ä¼¼æ€§åº”å¤§äºä¸€é¡¹åŠ¨ä½œproposalsä¸ä¸€é¡¹èƒŒæ™¯proposalsä¹‹é—´çš„ç›¸ä¼¼æ€§ã€‚é€šè¿‡åˆ©ç”¨è¿™ä¸€å…³ç³»ï¼Œä½œè€…è®¾è®¡FSDå¯¹æ¯”æŸå¤±å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235100324.png" alt="image-20220728235100324"></p>
<p>å…¶ä¸­$l(x)$æ˜¯rank lossã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235112789.png" alt="image-20220728235112789"></p>
<h2 id="Robust-Classification-to-Localization-Adaption-via-LCS-Contrastingsting"><a href="#Robust-Classification-to-Localization-Adaption-via-LCS-Contrastingsting" class="headerlink" title="Robust Classification-to-Localization Adaption via LCS Contrastingsting"></a><strong>Robust Classification-to-Localization Adaption via LCS</strong> <strong>Contrastingsting</strong></h2><p>WSALçš„ä½¿ç”¨è§†é¢‘æ ‡ç­¾è¿›è¡Œæ—¶é—´ä¸Šçš„å®šä½ï¼Œè¿™ä¼šå¯¼è‡´<strong>åˆ†ç±»å’Œå®šä½ä¹‹é—´å­˜åœ¨å¾ˆå¤§çš„ä»»åŠ¡å·®è·</strong>ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸€ä»»åŠ¡å·®è·ï¼Œä½œè€…è¯•å›¾æŒ–æ˜ä¸¤ä¸ªè§†é¢‘Xå’ŒZä¹‹é—´çš„<strong>æœ€é•¿å…¬å…±å­åºåˆ—(LCS)</strong>ï¼Œä»è€Œæé«˜å­¦ä¹ åˆ°çš„åŠ¨ä½œproposalsçš„ä¸€è‡´æ€§ã€‚</p>
<p>ç›´è§‰ä¸Šæ¥è¯´ï¼š</p>
<p>ï¼ˆ1ï¼‰å¦‚æœä¸¤ä¸ªè§†é¢‘åŠ¨ä½œä¸åŒï¼Œåˆ™Xå’ŒZä¹‹é—´çš„LCSé•¿åº¦åº”è¾ƒå°ã€‚æ˜¾ç„¶ï¼Œç”±äºä¸¤ç§ç±»å‹çš„åŠ¨ä½œçš„èƒŒæ™¯ä¸åŒä¸”å­˜åœ¨å®è´¨æ€§å·®å¼‚ï¼Œä¸¤ä¸ªå•ç‹¬è§†é¢‘ä¸­çš„ç‰‡æ®µå¯èƒ½é«˜åº¦ä¸ä¸€è‡´ï¼Œå¯¼è‡´LCSè¾ƒçŸ­ã€‚</p>
<p>ï¼ˆ2ï¼‰ ç±»ä¼¼åœ°ï¼Œå¦‚æœä¸¤ä¸ªè§†é¢‘åŠ¨ä½œç›¸åŒï¼Œåˆ™å®ƒä»¬çš„LCSå¾ˆå¯èƒ½å¾ˆé•¿ï¼Œå› ä¸ºæ¥è‡ªåŒä¸€ç±»åˆ«çš„åŠ¨ä½œå®ä¾‹ç”±ç›¸ä¼¼çš„æ—¶é—´åŠ¨ä½œç‰‡æ®µç»„æˆã€‚</p>
<p>åŸºäºä¸Šè¿°è§‚å¯Ÿ ã€‚ä½œè€…ä¹Ÿè®¾è®¡äº†ä¸€ä¸ªåŠ¨æ€è§„åˆ’çš„ç¼–ç¨‹ç­–ç•¥æ¥è®¡ç®—Xå’ŒZä¹‹é—´çš„LCSã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œä½œè€…ç»´æŠ¤äº†ä¸€ä¸ªé€’å½’çŸ©é˜µ$R\in\mathbb R^{(T+1)\times(T+1)}$ï¼Œå…ƒç´ $R(i,j)$å­˜å‚¨å‰ç¼€$X_i$å’Œ$Z_j$çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„é•¿åº¦ã€‚</p>
<p>ä¸ºäº†æ‰¾åˆ°å‰ç¼€$X_i$å’Œ$Z_j$çš„LCSï¼Œé¦–å…ˆæ¯”è¾ƒ$X_i$å’Œ$Z_j$ ã€‚</p>
<p>ï¼ˆ1ï¼‰å¦‚æœå®ƒä»¬ç›¸ç­‰ï¼Œåˆ™è®¡ç®—çš„å…¬å…±å­åºåˆ—ç”±è¯¥å…ƒç´ æ‰©å±•ï¼Œå› æ­¤$R(i,j)=R(i-1,j-1)+1$ã€‚</p>
<p>ï¼ˆ2ï¼‰å¦‚æœå®ƒä»¬ä¸ç›¸ç­‰ï¼Œåˆ™ä¿ç•™ä¹‹å‰è®¡ç®—çš„$R(i,j)$çš„æœ€å¤§é•¿åº¦ã€‚</p>
<p>åœ¨WSALä»»åŠ¡ä¸­ï¼Œç”±äºä¸€å¯¹ç‰‡æ®µä¸å¯èƒ½å®Œå…¨ç›¸åŒï¼Œå³ä½¿æ˜¯ç›¸åŒçš„åŠ¨ä½œç±»å‹ï¼Œå› æ­¤ä½œè€…é‡‡ç”¨å®ƒä»¬çš„ç›¸ä¼¼æ€§æ¥è®¡ç®—ä¸¤ä¸ªåºåˆ—çš„ç´¯ç§¯è½¯é•¿åº¦(accumulated soft length )ã€‚å› æ­¤ï¼Œæˆ‘ä»¬è®¾è®¡äº†LCSå»ºæ¨¡çš„é€’å½’å…¬å¼ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235211878.png" alt="image-20220728235211878"></p>
<p>å…¶ä¸­Ï„æ˜¯ä¸ªé˜ˆå€¼ï¼Œå†³å®šè§†é¢‘Xçš„ç¬¬iæ®µå’Œè§†é¢‘Zçš„ç¬¬jæ®µæ˜¯å¦åŒ¹é…ã€‚$c_(i,j)=cosâ¡(X_i,Z_j)$æ˜¯$X_i$å’Œ$Z_j$çš„ä½™å¼¦ç›¸ä¼¼æ€§ã€‚ä½œè€…æœ€ç»ˆä½¿ç”¨äº¤å‰ç†µæŸå¤±ä½œä¸ºLCSçš„çº¦æŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235223980.png" alt="image-20220728235223980"></p>
<p>å…¶ä¸­$r=R(T,T)$è¡¨ç¤ºä¸¤ä¸ªè§†é¢‘ä¹‹é—´çš„æœ€é•¿å…¬å…±å­åºåˆ—çš„è½¯é•¿åº¦ã€‚$\delta_{xz}$ ä¸ºground truthï¼Œä»£è¡¨Xå’ŒZä¹‹é—´æ˜¯å¦å…·æœ‰ç›¸åŒåŠ¨ä½œç±»åˆ«ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235311479.png" alt="image-20220728235311479"></p>
<h2 id="Train"><a href="#Train" class="headerlink" title="Train"></a><strong>Train</strong></h2><p>ä¸Šè¿°ä¸¤ä¸ªç›®æ ‡å¯ä»¥æ— ç¼é›†æˆåˆ°ç°æœ‰çš„WSALæ¡†æ¶ä¸­ï¼Œå¹¶ç›¸äº’åä½œã€‚ä¸ºäº†ä¼˜åŒ–æ•´ä¸ªæ¨¡å‹ï¼Œä½œè€…å°†åˆ†ç±»æŸå¤±å’Œä¸¤ä¸ªå¯¹æ¯”æŸå¤±ç»„æˆï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220728235254199.png" alt="image-20220728235254199"></p>
<p>ç”±äºä½œè€…æå‡ºçš„æ–¹æ³•æ˜¯æ¨¡å‹ä¸å¯çŸ¥å’Œéä¾µå…¥æ€§çš„ï¼Œé€šè¿‡ç”¨ä¸åŒç±»å‹çš„æŸå¤±å‡½æ•°å’Œä¸»å¹²æ›¿æ¢$L_cls$ï¼Œè¿™ä¸¤ç§å¯¹æ¯”æŸå¤±å¯ä»¥å¾ˆå¥½åœ°ä¸ä»»ä½•å…¶ä»–å¼±ç›‘ç£åŠ¨ä½œå®šä½ç›®æ ‡åä½œã€‚</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>OadTR Online Action Detection with Transformers</title>
    <url>/2021/10/24/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/OadTR%20Online%20Action%20Detection%20with%20Transformers/</url>
    <content><![CDATA[<h1 id="OadTR-Online-Action-Detection-with-Transformers"><a href="#OadTR-Online-Action-Detection-with-Transformers" class="headerlink" title="OadTR: Online Action Detection with Transformers"></a>OadTR: Online Action Detection with Transformers</h1><h2 id="è§£å†³ä»€ä¹ˆé—®é¢˜"><a href="#è§£å†³ä»€ä¹ˆé—®é¢˜" class="headerlink" title="è§£å†³ä»€ä¹ˆé—®é¢˜"></a>è§£å†³ä»€ä¹ˆé—®é¢˜</h2><p>è¯¥è®ºæ–‡æ˜¯è§£å†³çš„é—®é¢˜æ˜¯åœ¨çº¿åŠ¨ä½œæ£€æµ‹ã€‚</p>
<p>åœ¨çº¿åŠ¨ä½œæ£€æµ‹çš„ä»»åŠ¡æ˜¯åœ¨å®æ—¶è§†é¢‘æµå½“ä¸­ï¼Œå½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œæ£€æµ‹äº‹ä»¶å¼€å§‹çš„å¸§ï¼Œä»¥åŠäº‹ä»¶çš„ç±»å‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024213242335.png" alt="image-20211024213242335"></p>
<span id="more"></span>
<h2 id="æ€ä¹ˆåš"><a href="#æ€ä¹ˆåš" class="headerlink" title="æ€ä¹ˆåš"></a>æ€ä¹ˆåš</h2><p>è®ºæ–‡æ¨¡å‹å¦‚ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024213410882.png" alt="image-20211024213410882"></p>
<h3 id="Encoder"><a href="#Encoder" class="headerlink" title="Encoder"></a>Encoder</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214014119.png" alt="image-20211024214014119"></p>
<p>ç»™å®šè§†é¢‘$V={f<em>t}</em>{t=-T}^0$ï¼Œä½¿ç”¨ç‰¹å¾æå–å™¨é€šè¿‡å‹ç¼©ç©ºé—´ç»´åº¦æå–åˆ°ä¸€ç»´ç‰¹å¾åºåˆ—ï¼Œç„¶åå†ä½¿ç”¨çº¿æ€§æŠ•å½±å±‚ï¼Œå¾—åˆ°$F={token<em>t }</em>{t=-T}^0âˆˆR^{ (T+1)Ã—D}$</p>
<p>åœ¨encoderé‡Œé¢ï¼Œå°†å¯å­¦ä¹ çš„$token_classâˆˆR^D$æ‰©å±•åˆ°åµŒå…¥çš„ç‰¹å¾åºåˆ—</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214048739.png" alt="image-20211024214048739"></p>
<p>ç›´è§‚ä¸Šï¼Œå¦‚æœä¸å­˜åœ¨token_class ï¼Œé‚£ä¹ˆå…¶ä»–tokenè·å¾—çš„æœ€ç»ˆç‰¹å¾è¡¨ç¤ºå°†ä¸å¯é¿å…åœ°åå‘äºè¯¥æŒ‡å®šçš„tokenä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œå› æ­¤ä¸èƒ½ç”¨æ¥è¡¨ç¤ºè¯¥å­¦ä¹ ä»»åŠ¡(å³å›¾3ä¸­æ— ä»»åŠ¡token)ã€‚å¦‚ä¸‹å›¾ï¼Œé»„è‰²éƒ¨åˆ†å°±æ˜¯æœ‰task tokenï¼Œç»¿è‰²éƒ¨åˆ†å°±æ˜¯æ²¡æœ‰task token</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214123237.png" alt="image-20211024214123237"></p>
<p>ç”±äºencoderä¸­æ²¡æœ‰å¸§é¡ºåºä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦å¦å¤–åµŒå…¥ä½ç½®ç¼–ç ã€‚ä½ç½®ç¼–ç æœ‰ä¸¤ç§å½¢å¼:æ­£å¼¦è¾“å…¥å’Œå¯è®­ç»ƒåµŒå…¥ã€‚æˆ‘ä»¬æ·»åŠ äº†ä½ç½®ç¼–ç $E_{pos}âˆˆR^{(T+2)Ã—D)}$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214248786.png" alt="image-20211024214248786"></p>
<p>å¤šå¤´è‡ªæ³¨æ„(MSA)æ˜¯å˜å‹å™¨çš„æ ¸å¿ƒéƒ¨ä»¶ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214335863.png" alt="image-20211024214335863"></p>
<p>å…¶ä¸­</p>
<p><img src="æ–°å»ºæ–‡ä»¶å¤¹/image-20211024214352649.png" alt="image-20211024214352649"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214406093.png" alt="image-20211024214406093"></p>
<p>éšåï¼Œå¤´çš„è¾“å‡º$H_1,H_2,â€¦$è¢«è¿æ¥å¹¶é¦ˆå…¥ä¸€ä¸ªçº¿æ€§å±‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214431145.png" alt="image-20211024214431145"></p>
<p>å…¶ä¸­$W_d$æ˜¯ä¸€ä¸ªçº¿æ€§æ˜ å°„</p>
<p>æ¥ç€ï¼Œä½¿ç”¨å‰é¦ˆç½‘ç»œ(FFN)ä¸GELU[19]æ¿€æ´»ã€‚æœ€åçš„å…¬å¼å¯ä»¥è¡¨ç¤ºä¸º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214457660.png" alt="image-20211024214457660"></p>
<h3 id="Decoder"><a href="#Decoder" class="headerlink" title="Decoder"></a>Decoder</h3><p>OadTRçš„decoderåˆ©ç”¨å¯¹è¿‡å»ä¿¡æ¯çš„è§‚å¯Ÿæ¥é¢„æµ‹åœ¨ä¸ä¹…çš„å°†æ¥å°†è¦å‘ç”Ÿçš„åŠ¨ä½œï¼Œä»è€Œæ›´å¥½åœ°å­¦ä¹ æ›´å…·ç”„åˆ«æ€§çš„ç‰¹å¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214531988.png" alt="image-20211024214531988"></p>
<p>é¢„æµ‹æŸ¥è¯¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214729945.png" alt="image-20211024214729945"></p>
<p>ä¹Ÿæ˜¯å¯å­¦ä¹ çš„ï¼Œå…¶ä¸­$\acute{D}$æ˜¯æŸ¥è¯¢é¢‘é“æ•°é‡,æœ€ç»ˆå¾—åˆ°è¾“å‡º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214738930.png" alt="image-20211024214738930"></p>
<h3 id="Training"><a href="#Training" class="headerlink" title="Training"></a>Training</h3><p>å¯¹äºå½“å‰å¸§å—çš„åˆ†ç±»ä»»åŠ¡ï¼Œå…ˆå°†ç¼–ç å™¨ä¸­ä¸ä»»åŠ¡ç›¸å…³çš„ç‰¹å¾ä¸è§£ç å™¨ä¸­æ± åŒ–çš„é¢„æµ‹ç‰¹å¾è¿æ¥èµ·æ¥ã€‚ç„¶åç”Ÿæˆçš„ç‰¹å¾é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„è¿æ¥å±‚å’Œä¸€ä¸ªsoftmaxæ“ä½œè¿›è¡ŒåŠ¨ä½œåˆ†ç±»:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214822475.png" alt="image-20211024214822475"></p>
<p>å…¶ä¸­$W_c$è¡¨ç¤ºç”¨äºåˆ†ç±»çš„å…¨è¿æ¥å±‚å‚æ•°ï¼Œ$p_0âˆˆR^{c+1}$ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214904213.png" alt="image-20211024214904213"></p>
<p>é™¤äº†ä¼°è®¡å½“å‰åŠ¨ä½œå¤–ï¼ŒOadTRè¿˜ä¸ºä¸‹ä¸€æ­¥timeæ­¥éª¤è¾“å‡ºé¢„æµ‹åŠŸèƒ½ã€‚ç”±äºç¦»çº¿è®­ç»ƒæ—¶å¯ä»¥è·å¾—æœªæ¥çš„ä¿¡æ¯ï¼Œä¸ºäº†ä¿è¯å­¦ä¹ åˆ°å¥½çš„ç‰¹å¾è¡¨è¾¾å¼ï¼Œæˆ‘ä»¬è¿˜å¯¹æœªæ¥é¢„æµ‹ç‰¹å¾è¿›è¡Œäº†æœ‰ç›‘ç£çš„è®­ç»ƒ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214917897.png" alt="image-20211024214917897"></p>
<p>å› æ­¤ï¼Œæœ€åçš„è®­ç»ƒæŸå¤±ä¸º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211024214935836.png" alt="image-20211024214935836"></p>
<p>å…¶ä¸­CEæ˜¯äº¤å‰ç†µæŸå¤±,ä¸‹ä¸€æ­¥çš„å®é™…è¡ŒåŠ¨ç±»åˆ«æ˜¯ä»€ä¹ˆ$\tilde{y_i}$</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>transformer</tag>
        <tag>åœ¨çº¿åŠ¨ä½œæ£€æµ‹</tag>
      </tags>
  </entry>
  <entry>
    <title>RefineLoc Iterative Refinement for Weakly-Supervised Action Localization</title>
    <url>/2021/09/11/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/RefineLoc%20Iterative%20Refinement%20for%20Weakly-Supervised%20Action%20Localization/</url>
    <content><![CDATA[<h1 id="RefineLoc-Iterative-Refinement-for-Weakly-Supervised-Action-Localization"><a href="#RefineLoc-Iterative-Refinement-for-Weakly-Supervised-Action-Localization" class="headerlink" title="RefineLoc Iterative Refinement for Weakly-Supervised Action Localization"></a>RefineLoc Iterative Refinement for Weakly-Supervised Action Localization</h1><h2 id="æå‡ºé—®é¢˜"><a href="#æå‡ºé—®é¢˜" class="headerlink" title="æå‡ºé—®é¢˜"></a>æå‡ºé—®é¢˜</h2><p>åœ¨ç›®æ ‡æ£€æµ‹é¢†åŸŸï¼Œä½¿ç”¨pseudo ground truthï¼ˆç±»ä¼¼äºä¼ªæ ‡ç­¾ï¼‰è¿›è¡Œç»†åŒ–å¤§å¤§å‡å°‘äº†å®Œå…¨ç›‘ç£å’Œå¼±ç›‘ç£å¯¹è±¡æ£€æµ‹ä¹‹é—´çš„æ€§èƒ½å·®è·ï¼Œå› ä¸ºæ—¶é—´åŠ¨ä½œå®šä½å¾ˆå¤šå†…å®¹æ˜¯ä»ç›®æ ‡æ£€æµ‹å½“ä¸­å¼•ç”¨è¿‡æ¥çš„ï¼Œé‚£ä¹ˆæ˜¯å¦èƒ½æŠŠä½¿ç”¨pseudo ground truthè¿™ä¸ªæ–¹æ³•å¼•ç”¨åˆ°æ—¶é—´åŠ¨ä½œå®šä½å½“ä¸­å‘¢ã€‚</p>
<p>pseudo ground truthçš„æ¦‚å¿µæ˜¯æŒ‡æ¥è‡ªå¼±ç›‘ç£æ¨¡å‹çš„ä¸€ç»„é‡‡æ ·å¯¹è±¡é¢„æµ‹ï¼Œåœ¨ä¸‹ä¸€æ¬¡ç»†åŒ–è¿­ä»£ä¸­å°†å…¶å‡å®šä¸ºå®é™…å¯¹è±¡ä½ç½®ã€‚</p>
<h2 id="åšäº†ä»€ä¹ˆ"><a href="#åšäº†ä»€ä¹ˆ" class="headerlink" title="åšäº†ä»€ä¹ˆ"></a>åšäº†ä»€ä¹ˆ</h2><p>æå‡ºRefineLocæ¨¡å‹ï¼Œä¸€ç§å¼±ç›‘ç£çš„æ—¶é—´å®šä½æ–¹æ³•ï¼Œå®ƒé€šè¿‡åˆ©ç”¨pseudo ground truthå®å†µæ¥è¯„ä¼°è¿­ä»£ç»†åŒ–ç­–ç•¥</p>
<span id="more"></span>
<h2 id="æ€ä¹ˆåšçš„"><a href="#æ€ä¹ˆåšçš„" class="headerlink" title="æ€ä¹ˆåšçš„"></a>æ€ä¹ˆåšçš„</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210911184214062.png" alt="image-20210911184214062"></p>
<h3 id="Snippet-Level-Classification-Module"><a href="#Snippet-Level-Classification-Module" class="headerlink" title="Snippet-Level Classification Module"></a>Snippet-Level Classification Module</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912211014735.png" alt="image-20210912211014735"></p>
<p>è¿™ä¸ªæ¨¡å—æ¥å—ç‰¹å¾å›¾Fï¼Œç„¶åäº§ç”ŸTÃ—Nçš„ç±»åˆ«æ¿€æ´»å›¾Cï¼ˆç±»æ¿€æ´»åºåˆ—çš„æ¦‚å¿µï¼Œåœ¨æ—¶é—´åŠ¨ä½œå®šä½å½“ä¸­å¾ˆå¸¸è§ï¼Œè‡ªè¡Œè¿›è¡Œäº†è§£ï¼‰</p>
<p>å®ƒç”±ä¸€ä¸ªå¤šå±‚æ„ŸçŸ¥å™¨ (MLP) ç»„æˆï¼Œå…¶ä¸­ L ä¸ªå…¨è¿æ¥ (FC) å±‚ä¸ ReLU æ¿€æ´»å‡½æ•°äº¤é”™</p>
<h3 id="Background-Foreground-Attention-Module"><a href="#Background-Foreground-Attention-Module" class="headerlink" title="Background-Foreground Attention Module"></a>Background-Foreground Attention Module</h3><p>è¯¥æ¨¡å—çš„ç›®æ ‡æ˜¯å­¦ä¹ æ¯ä¸ªç‰‡æ®µçš„æ³¨æ„åŠ›æƒé‡ï¼Œä»è€Œè¾¾åˆ°æŠ‘åˆ¶èƒŒæ™¯çš„ä½œç”¨ã€‚</p>
<p>è¿™ä¸ªæ¨¡å—æ¥å—ç‰¹å¾å›¾Fï¼Œç„¶åäº§ç”ŸTÃ—2çš„ç±»åˆ«æ¿€æ´»å›¾Aï¼ˆå› ä¸ºæ˜¯èƒŒæ™¯ï¼Œæ‰€ä»¥ç»´åº¦æ˜¯$T\times 2$,å’Œå‰é¢æ¨¡å—çš„çš„$T\times N$å¯¹æ¯”ä¸€ä¸‹ï¼‰</p>
<p>å®ƒç”±ä¸€ä¸ªå¤šå±‚æ„ŸçŸ¥å™¨ (MLP) ç»„æˆï¼Œå…¶ä¸­ L ä¸ªå…¨è¿æ¥ (FC) å±‚ä¸ ReLU æ¿€æ´»å‡½æ•°äº¤é”™</p>
<p>åˆ«äººçš„æ³¨æ„åŠ›æ¨¡å—ä»…å—è§†é¢‘çº§åˆ«æ ‡ç­¾çš„ç›‘ç£ï¼Œä»¥æ”¹å–„è§†é¢‘åˆ†ç±»ï¼Œè€Œæœ¬è®ºæ–‡çš„æ³¨æ„åŠ›åˆ™ç”±è§†é¢‘çº§æ ‡ç­¾å’Œä¸€ç»„ä¼ªèƒŒæ™¯-å‰æ™¯æ ‡ç­¾ï¼Œç›®çš„æ˜¯æé«˜åŠ¨ä½œç‰‡æ®µçš„å®šä½æˆ‘ä»¬é€‰æ‹©è¿™æ ·åšæ˜¯å› ä¸ºæˆ‘ä»¬çš„æ–¹æ³•ç›´æ¥å¯¹æ³¨æ„åŠ›å€¼ä½¿ç”¨ç›‘ç£ã€‚å› æ­¤ï¼Œè®ºæ–‡ä¸æ˜¯é€šè¿‡é€»è¾‘å›å½’æŸå¤±æ¥å­¦ä¹ æ³¨æ„åŠ›ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºäºŒå…ƒåˆ†ç±»é—®é¢˜æ¥å­¦ä¹ ã€‚æˆ‘ä»¬å°†é€šè¿‡é€»è¾‘å›å½’å­¦ä¹ æ ‡é‡æ³¨æ„åŠ›ä¸æˆ‘ä»¬åœ¨è¡¥å……ææ–™ä¸­æå‡ºçš„äºŒç»´æ³¨æ„åŠ›è¿›è¡Œæ¯”è¾ƒ</p>
<h3 id="Video-Label-Prediction-Module"><a href="#Video-Label-Prediction-Module" class="headerlink" title="Video Label Prediction Module"></a>Video Label Prediction Module</h3><p>è¯¥æ¨¡å—ç»“åˆ C å’Œ A ä¸ºè§†é¢‘æ ‡ç­¾ç”Ÿæˆ N ç»´æ¦‚ç‡å‘é‡ $\hat{y}$</p>
<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬å°† C é€šè¿‡ä¸€ä¸ª softmax å±‚ä»¥è·å¾—$\bar{C}$,å¹¶å°†Aé€šè¿‡ä¸¤ä¸ª softmax å±‚ã€‚ç¬¬ä¸€ä¸ªsoftmax å±‚åœ¨background-foregroundç»´åº¦ç”Ÿæˆ$\bar{A}^{bf}$,è€Œç¬¬äºŒä¸ªsoftmax å±‚æ˜¯åœ¨$\bar{A}^{bf}$æ—¶é—´ç»´åº¦ç”Ÿæˆ$\bar{A}^{time}$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912212420180.png" alt="image-20210912212420180"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912212428662.png" alt="image-20210912212428662"></p>
<p>åˆ«äººçš„æ³¨æ„åŠ›æ¨¡å—ä»…å—è§†é¢‘çº§åˆ«æ ‡ç­¾çš„ç›‘ç£ï¼Œä»¥æ”¹å–„è§†é¢‘åˆ†ç±»ï¼Œè€Œæˆ‘ä»¬çš„æ³¨æ„åŠ›åˆ™ç”±è§†é¢‘çº§æ ‡ç­¾å’Œä¸€ç»„ä¼ªèƒŒæ™¯-å‰æ™¯æ ‡ç­¾ï¼Œç›®çš„æ˜¯æé«˜åŠ¨ä½œç‰‡æ®µçš„å®šä½</p>
<p>æˆ‘ä»¬é€‰æ‹©è¿™æ ·åšæ˜¯å› ä¸ºæˆ‘ä»¬çš„æ–¹æ³•ç›´æ¥å¯¹æ³¨æ„åŠ›å€¼ä½¿ç”¨ç›‘ç£ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸æ˜¯é€šè¿‡é€»è¾‘å›å½’æŸå¤±æ¥å­¦ä¹ æ³¨æ„åŠ›ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºäºŒå…ƒåˆ†ç±»é—®é¢˜æ¥å­¦ä¹ ã€‚æˆ‘ä»¬å°†é€šè¿‡é€»è¾‘å›å½’å­¦ä¹ æ ‡é‡æ³¨æ„åŠ›ä¸æˆ‘ä»¬åœ¨è¡¥å……ææ–™ä¸­æå‡ºçš„äºŒç»´æ³¨æ„åŠ›è¿›è¡Œæ¯”è¾ƒi = 1 æŒ‡çš„æ˜¯èƒŒæ™¯ï¼Œè€Œ i = 2 æŒ‡çš„æ˜¯å‰æ™¯</p>
<h3 id="Action-Segment-Prediction-Module"><a href="#Action-Segment-Prediction-Module" class="headerlink" title="Action Segment Prediction Module."></a>Action Segment Prediction Module.</h3><p>è¯¥æ¨¡å—åå¤„ç†$\bar{A}^{bf}$å’Œ$\bar{C}$ä»¥äº§ç”Ÿä¸€ç»„åŠ¨ä½œç‰‡æ®µé¢„æµ‹P</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è¿‡æ»¤æ‰èƒŒæ™¯æ³¨æ„åŠ›å€¼å¤§äºé˜ˆå€¼$\alpha_A$çš„ç‰‡æ®µã€‚ç„¶åï¼Œæˆ‘ä»¬åªè€ƒè™‘$\hat{y}$ä¸­çš„ top-k ç±»ã€‚å¯¹äºæ¯ä¸ªç±»åˆ«nï¼Œæˆ‘ä»¬è¿‡æ»¤æ‰ç‰‡æ®µåˆ†ç±»åˆ†æ•°ä½äº$\alpha_c$</p>
<p>å¯¹äºç‰‡æ®µ$(t_1,t_2)$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912213225224.png" alt="image-20210912213225224"></p>
<h3 id="Iterative-Refinement-Process"><a href="#Iterative-Refinement-Process" class="headerlink" title="Iterative Refinement Process"></a>Iterative Refinement Process</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912212825938.png" alt="image-20210912212825938"></p>
<p>è®©$g^(M<em>Î· )$ä½œä¸ºpseudo ground truthç”Ÿæˆå‡½æ•°ï¼Œä½¿ç”¨æ¥è‡ª$M</em>Î·$çš„ä¿¡æ¯(Î·è¿­ä»£åè®­ç»ƒçš„WSTALåŸºæ¨¡å‹)å°†æ¯ä¸ªç‰‡æ®µæ˜ å°„åˆ°ä¼ªèƒŒæ™¯-å‰æ™¯æ ‡ç­¾ã€‚åœ¨Î·+1è¿­ä»£æ—¶ï¼Œæˆ‘ä»¬è®­ç»ƒäº†ä¸€ä¸ªæ–°çš„WSTALåŸºæ¨¡å‹MÎ·+1ï¼Œç”¨äºè®¡ç®—è§†é¢‘çº§æ ‡ç­¾å’Œç‰‡æ®µçº§ä¼ªåœ°é¢çœŸæ ‡ç­¾çš„è”åˆæŸå¤±ã€‚å…·ä½“åœ°è¯´ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢çš„æ–¹æ³•è®¡ç®—ç»™å®šè§†é¢‘ä¸Šçš„MÎ·+1çš„æŸå¤±</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210912213355698.png" alt="image-20210912213355698"></p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>Two-Stream Consensus Network for Weakly-Supervised Temporal</title>
    <url>/2022/07/19/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Two-Stream%20Consensus%20Network%20for%20Weakly-Supervised%20Temporal/</url>
    <content><![CDATA[<h1 id="Two-Stream-Consensus-Network-for-Weakly-Supervised-Temporal"><a href="#Two-Stream-Consensus-Network-for-Weakly-Supervised-Temporal" class="headerlink" title="Two-Stream Consensus Network for Weakly-Supervised Temporal"></a>Two-Stream Consensus Network for Weakly-Supervised Temporal</h1><h2 id="æ–‡ç« ç®€ä»‹"><a href="#æ–‡ç« ç®€ä»‹" class="headerlink" title="æ–‡ç« ç®€ä»‹"></a>æ–‡ç« ç®€ä»‹</h2><p>æ–‡ç« å‘è¡¨åœ¨<strong>ECCV2020</strong>ä¸Šï¼Œæ–‡ç« æå‡ºäº†ä¸€ä¸ªåŒæµå…±è¯†ç½‘ç»œ(TSCN)ï¼Œé‡‡ç”¨è¿­ä»£ç»†åŒ–è®­ç»ƒæ–¹æ³•ï¼Œè¿­ä»£æ›´æ–°å¸§çº§çš„<strong>ä¼ªçœŸå®å€¼</strong>ï¼Œå¹¶ç”¨äºæä¾›å¸§çº§ç›‘ç£ï¼Œä»¥æ”¹è¿›æ¨¡å‹è®­ç»ƒå’Œæ¶ˆé™¤å‡ç§¯æåŠ¨ä½œå»ºè®®ã€‚æ­¤å¤–ï¼Œæ–‡ç« æå‡ºäº†ä¸€ç§æ–°çš„<strong>æ³¨æ„å½’ä¸€åŒ–æŸå¤±</strong>ï¼Œä»¥é¼“åŠ±é¢„æµ‹çš„æ³¨æ„å……å½“äºŒè¿›åˆ¶é€‰æ‹©ï¼Œå¹¶ä¿ƒè¿›åŠ¨ä½œå®ä¾‹è¾¹ç•Œçš„ç²¾ç¡®å®šä½ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719122157159.png" alt="image-20220719122157159"></p>
<span id="more"></span>
<h2 id="è®ºæ–‡åŠ¨æœº"><a href="#è®ºæ–‡åŠ¨æœº" class="headerlink" title="è®ºæ–‡åŠ¨æœº"></a>è®ºæ–‡åŠ¨æœº</h2><p>1.å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½(W-TAL)çš„ç›®æ ‡æ˜¯åœ¨è§†é¢‘çº§åˆ«ç›‘ç£ä¸‹å¯¹æœªè£å‰ªè§†é¢‘ä¸­æ‰€ä»¥åŠ¨ä½œå®ä¾‹è¿›è¡Œåˆ†ç±»å’Œå®šä½ã€‚ç„¶è€Œç”±äºæ²¡æœ‰å¸§çº§åˆ«çš„æ³¨é‡Šï¼ŒW-TALæ–¹æ³•å¾ˆéš¾è¯†åˆ«<strong>false positive</strong> action proposalsã€‚æ¯”å¦‚ï¼šæ¨¡å‹å¯èƒ½ä»…é€šè¿‡æ£€æŸ¥åœºæ™¯ä¸­æ˜¯å¦å­˜åœ¨æ°´æ¥é”™è¯¯å®šä½åŠ¨ä½œâ€œæ¸¸æ³³â€ã€‚å› æ­¤ï¼Œ<strong>æœ‰å¿…è¦åˆ©ç”¨æ›´ç»†ç²’åº¦çš„ç›‘ç£æ¥æŒ‡å¯¼å­¦ä¹ è¿‡ç¨‹</strong>ã€‚</p>
<p>2.å¦ä¸€ä¸ªé—®é¢˜åœ¨äºaction proposalsçš„ç”Ÿæˆï¼Œä¹‹å‰éƒ½æ˜¯ä½¿ç”¨ç»éªŒé¢„è®¾çš„<strong>å›ºå®šé˜ˆå€¼</strong>å¯¹æ¿€æ´»åºåˆ—è¿›è¡Œé˜ˆå€¼åŒ–æ¥ç”Ÿæˆçš„ã€‚æ¯”å¦‚ï¼š<strong>é«˜é˜ˆå€¼</strong>å¯èƒ½å¯¼è‡´è¡ŒåŠ¨å»ºè®®ä¸å®Œæ•´ï¼Œè€Œ<strong>ä½é˜ˆå€¼</strong>å¯èƒ½å¸¦æ¥æ›´å¤šè¯¯æŠ¥ã€‚</p>
<p>é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œä½œè€…æå‡ºä¸€ä¸ªåŒæµå…±è¯†ç½‘ç»œ(TSCN)ã€‚TSCNé‡‡ç”¨è¿­ä»£ç²¾ç»†åŒ–è®­ç»ƒçš„æ–¹æ³•ï¼Œè¿­ä»£æ›´æ–°å¸§çº§åˆ«çš„æ ‡ç­¾ï¼Œå¹¶ç”¨äºæä¾›å¸§çº§åˆ«ç›‘ç£æ”¹è¿›çš„æ¨¡å‹è®­ç»ƒå’Œ<strong>false positive</strong> <strong>proposals</strong>æ¶ˆé™¤ã€‚æ­¤å¤–ï¼Œä½œè€…æå‡ºäº†ä¸€ç§æ–°çš„æ³¨æ„åŠ›å½’ä¸€åŒ–æŸå¤±ï¼Œä»¥é¼“åŠ±é¢„æµ‹çš„æ³¨æ„å‘äºŒè¿›åˆ¶é€‰æ‹©ä¸€æ ·è¡Œä¸ºï¼Œå¹¶ä¿ƒè¿›åŠ¨ä½œå®ä¾‹è¾¹ç•Œçš„ç²¾ç¡®å®šä½</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719122314776.png" alt="image-20220719122314776"></p>
<h2 id="æ€è·¯å’Œç ”ç©¶æ–¹æ³•"><a href="#æ€è·¯å’Œç ”ç©¶æ–¹æ³•" class="headerlink" title="æ€è·¯å’Œç ”ç©¶æ–¹æ³•"></a>æ€è·¯å’Œç ”ç©¶æ–¹æ³•</h2><p>æå‡ºçš„åŒæµä¸€è‡´æ€§ç½‘ç»œï¼ŒåŒ…æ‹¬ä¸‰éƒ¨åˆ†ï¼šï¼ˆ1ï¼‰åˆ©ç”¨é¢„è®­ç»ƒæ¨¡å‹æå–RGBå’Œå…‰æµç‰‡æ®µçº§ç‰¹å¾ï¼›ï¼ˆ2ï¼‰ä½¿ç”¨è¿™äº›RGBå’Œå…‰æµç‰¹å¾åˆ†åˆ«è®­ç»ƒä¸¤ä¸ªæµåŸºæ¨¡å‹ï¼›ï¼ˆ3ï¼‰ä»ä¸¤æµå»¶è¿Ÿèåˆæ³¨æ„åºåˆ—ç”Ÿæˆå¸§çº§ä¼ªground truthï¼Œè¿›è€Œä¸ºä¸¤ä¸ªæµåŸºæ¨¡å‹æä¾›å¸§çº§ç›‘ç£ </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719122543177.png" alt="image-20220719122543177"></p>
<h3 id="Feature-Extraction"><a href="#Feature-Extraction" class="headerlink" title="Feature Extraction"></a>Feature Extraction</h3><p>ä½¿ç”¨é¢„è®­ç»ƒå·çš„ç½‘ç»œåˆ†åˆ«ä»ä¸é‡å çš„å›ºå®šé•¿åº¦çš„RGBå¸§ç‰‡æ®µå’Œå…‰æµç‰‡æ®µä¸­æå–RGBã€å…‰æµç‰¹å¾ã€‚å®ƒä»¬æä¾›äº†ç›¸åº”ç‰‡æ®µçš„é«˜çº§å¤–è§‚å’Œè¿åŠ¨ä¿¡æ¯ã€‚å½¢å¼ä¸Šï¼Œç»™å®šä¸€ä¸ªå…·æœ‰Tä¸ªä¸é‡å ç‰‡æ®µçš„è§†é¢‘ï¼Œä½œè€…åˆ†åˆ«è¡¨ç¤ºRGBç‰¹å¾ä¸ªå…‰æµç‰¹å¾ä¸º${f<em>{RGB}}</em>{i=1}^T$å’Œ${f<em>{flow} }</em>{i=1}^T$ï¼Œå…¶ä¸­$f<em>{RGB,i},f</em>{flow,i}\in R^D$åˆ†åˆ«ä»£è¡¨ç¬¬$i$å¸§RGBå’Œå…‰æµç‰¹å¾è¡¨ç¤ºï¼Œ$D$è¡¨ç¤ºé€šé“ç»´æ•°ã€‚</p>
<h3 id="Two-Stream-Base-Models"><a href="#Two-Stream-Base-Models" class="headerlink" title="Two-Stream Base Models"></a>Two-Stream Base Models</h3><p>åœ¨è·å¾—RGBå’Œå…‰æµç‰¹å¾åï¼Œä½œè€…é¦–å…ˆä½¿ç”¨åŒæµåŸºç¡€æ¨¡å‹è¿›è¡Œè§†é¢‘çº§çš„åŠ¨ä½œåˆ†ç±»ï¼Œç„¶åç”¨å¸§çº§åˆ«çš„ä¼ªæ ‡ç­¾å¯¹åŸºç¡€æ¨¡å‹è¿›è¡Œè¿­ä»£ç»†åŒ–ã€‚</p>
<p>ä¸¤ç§æ¨¡å¼ç‰¹å¾åˆ†åˆ«è¾“å…¥åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„åŸºæœ¬æ¨¡å‹ä¸­ï¼Œä¸¤ä¸ªåŸºæœ¬æ¨¡å‹ä½¿ç”¨ç›¸åŒçš„æ¶æ„ï¼Œä½†ä¸å…±äº«å‚æ•°ï¼ˆåé¢çœç•¥RGBã€flowï¼‰ã€‚</p>
<p>ä½œè€…å°†è¾“å…¥ç‰¹å¾${f<em>i}</em>{i=1}^T$ è¿æ¥èµ·æ¥ï¼Œå¹¶ä½¿ç”¨ä¸€ç»„æ—¶é—´å·ç§¯ç”Ÿæˆæ–°ç‰¹å¾${x<em>i }</em>{i=1}^T$ï¼Œå…¶ä¸­$x_i\in R^D$ï¼Œ$D$è¡¨ç¤ºè¾“å‡ºç‰¹å¾ç»´åº¦ã€‚</p>
<p>ç”±äºè§†é¢‘å¯èƒ½åŒ…å«èƒŒæ™¯ç‰‡æ®µï¼Œä¸ºäº†æ‰§è¡Œè§†é¢‘çº§åˆ«åˆ†ç±»ï¼Œä½œè€…éœ€è¦é€‰æ‹©å¯èƒ½åŒ…å«åŠ¨ä½œå®ä¾‹ç‰‡æ®µï¼ŒåŒæ—¶è¿‡æ»¤æ‰å¯èƒ½åŒ…å«èƒŒæ™¯çš„ç‰‡æ®µã€‚ä¸ºæ­¤ï¼Œå…¨è¿æ¥(FC)å±‚ç»™å‡ºä¸€ä¸ªç”¨äºè¡¡é‡ç¬¬iä¸ªåŒ…å«åŠ¨ä½œçš„ç‰‡æ®µçš„å¯èƒ½æ€§çš„æ³¨æ„å€¼$A_i \in (0,1):$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124205244.png" alt="image-20220719124205244"></p>
<p>å…¬å¼ä¸­$\sigma(),W_A,b_A$åˆ†åˆ«ä¸ºsigmoidå‡½æ•°ã€æƒé‡å‘é‡å’Œåå·®ã€‚ç„¶åï¼Œä½œè€…å¯¹ç‰¹å¾åºåˆ—è¿›è¡Œæ³¨æ„åŠ›åŠ æƒæ± åŒ–ï¼Œç”Ÿæˆå•ä¸ªå‰æ™¯ç‰¹å¾ï¼Œå¹¶å°†å…¶è¾“å…¥FCã€softmaxå±‚ï¼Œè·å¾—è§†é¢‘çº§åˆ«é¢„æµ‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124409241.png" alt="image-20220719124409241"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124422377.png" alt="image-20220719124422377"></p>
<p>å…¶ä¸­$\hat{y}_c$ä¸ºè§†é¢‘åŒ…å«ç¬¬cä¸ªåŠ¨ä½œæ¦‚ç‡ã€‚</p>
<p>æœ‰äº†$\hat{y}<em>c$åå¯ä»¥å®šä¹‰åˆ†ç±»æŸå¤±å‡½æ•°$L</em>{cls}$ ä¸ºæ ‡å‡†äº¤å‰ç†µæŸå¤±ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124547523.png" alt="image-20220719124547523"></p>
<p>ç†æƒ³æƒ…å†µä¸‹ï¼Œæ³¨æ„åŠ›å€¼åº”ä¸ºäºŒè¿›åˆ¶ï¼Œå…¶ä¸­1è¡¨ç¤ºå­˜åœ¨åŠ¨ä½œï¼Œ0è¡¨ç¤ºèƒŒæ™¯ã€‚åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œä½œè€…æ²¡æœ‰ä½¿ç”¨èƒŒæ™¯åˆ†ç±»ï¼Œè€Œæ˜¯å¼•å…¥äº†æ³¨æ„åŠ›å½’ä¸€åŒ–é¡¹ï¼Œä»¥è¿«ä½¿æ³¨æ„åŠ›æ¥è¿‘æç«¯å€¼ï¼š </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124601551.png" alt="image-20220719124601551"></p>
<p>è¿™ç§å½’ä¸€åŒ–æŸå¤±æ—¨åœ¨æœ€å¤§åŒ–å¹³å‡top-læ³¨æ„åŠ›å€¼å’Œå¹³å‡bottom-læ³¨æ„åŠ›å€¼ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶å¼ºåˆ¶å‰æ™¯æ³¨æ„åŠ›ä¸º1ï¼ŒèƒŒæ™¯æ³¨æ„åŠ›ä¸º0ã€‚</p>
<p>å› æ­¤ï¼ŒåŸºæœ¬æ¨¡å‹è®­ç»ƒçš„æ€»æŸå¤±æ˜¯åˆ†ç±»æŸå¤±å’Œæ³¨æ„åŠ›å½’ä¸€åŒ–é¡¹çš„åŠ æƒå’Œï¼š </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124627631.png" alt="image-20220719124627631"></p>
<p>æ­¤å¤–ï¼Œé€šè¿‡åœ¨æ‰€æœ‰ç‰‡æ®µä¸Šæ»‘åŠ¨åˆ†ç±»FC softmaxå±‚æ¥ç”Ÿæˆï¼ˆå…¶å®å°±æ˜¯ä½¿ç”¨${x<em>i }</em>{i=1}^T$åœ¨FCå±‚ä¸Šæ»‘åŠ¨ç”Ÿæˆçš„ï¼‰ï¼Œæ—¶é—´ç±»æ¿€æ´»å›¾ï¼ˆT-CAMï¼‰${s<em>i }</em>{i=}^T,s_i\in R^c$ ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124730731.png" alt="image-20220719124730731"></p>
<h3 id="Pseudo-Ground-Truth-Generation"><a href="#Pseudo-Ground-Truth-Generation" class="headerlink" title="Pseudo Ground Truth Generation"></a>Pseudo Ground Truth Generation</h3><p>ä½œè€…ä½¿ç”¨å¸§çº§<strong>pseudo ground truth</strong>å¯¹ä¸¤ä¸ªæµåŸºæ¨¡å‹è¿›è¡Œè¿­ä»£ä¼˜åŒ–ã€‚ç”±äºæ²¡æœ‰çœŸæ­£çš„æ³¨é‡Šï¼Œæ—¢ä¸èƒ½è¡¡é‡<strong>pseudo ground truth</strong>çš„è´¨é‡ï¼Œä¹Ÿä¸èƒ½ä¿<strong>pseudo ground truth</strong>å¯ä»¥å¸®åŠ©åŸºç¡€æ¨¡å‹å®ç°æ›´é«˜çš„æ€§èƒ½ã€‚</p>
<p>å—åŒæµåæœŸèåˆçš„å¯å‘ï¼Œä½œè€…å¼•å…¥äº†ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•æ¥ç”Ÿæˆä¼ªåœ°é¢çœŸå€¼ã€‚ç›´è§‰ä¸Šï¼Œä¸¤ä¸ªæµå…·æœ‰<strong>é«˜æ¿€æ´»</strong>çš„ä½ç½®å¯èƒ½åŒ…å«ground truthåŠ¨ä½œå®ä¾‹ï¼›åªæœ‰ä¸€ä¸ªæµå…·æœ‰é«˜æ¿€æ´»ç‡çš„ä½ç½®å¾ˆå¯èƒ½æ˜¯åªæœ‰ä¸€ä¸ªæµå¯ä»¥æ£€æµ‹åˆ°çš„false positive action proposalsæˆ–çœŸå®åŠ¨ä½œå®ä¾‹ï¼›ä¸¤ä¸ªæµéƒ½å…·æœ‰<strong>ä½æ¿€æ´»</strong>çš„ä½ç½®å¯èƒ½æ˜¯èƒŒæ™¯ã€‚</p>
<p>æ ¹æ®ä¸Šè¯‰çš„ç›´è§‰ï¼Œä½œè€…åœ¨ç»†åŒ–è¿­ä»£næ—¶ä½¿ç”¨ä½¿ç”¨èåˆæ³¨æ„åŠ›åºåˆ—${A<em>{fuse}^{(n)} )}</em>{i=1}^T$æ¥ç”Ÿæˆpseudo ground truth${G<em>i^{(n+1)} )}</em>{i=1}^T$ç”¨äºç»†åŒ–è¿­ä»£n+1ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719125259220.png" alt="image-20220719125259220"></p>
<p><strong>Soft Pseudo Ground Truth</strong>ã€‚ç›´æ¥ä½¿ç”¨èåˆæ³¨æ„åŠ›å€¼ä½œä¸ºä¼ªæ ‡ç­¾çš„æ–¹æ³•ï¼š$G<em>i^{(n+1)}=A</em>{fuse}^{(n)}$ <strong>ã€‚</strong>è½¯ä¼ªæ ‡ç­¾åŒ…å«ç‰‡æ®µä½œä¸ºå‰æ™¯åŠ¨ä½œçš„æ¦‚ç‡ï¼Œä½†ä¹Ÿç»™æ¨¡å‹å¢åŠ äº†ä¸ç¡®å®šæ€§ã€‚</p>
<p><strong>Hard Pseudo Ground Truth</strong>ã€‚é˜ˆå€¼æ³¨æ„åŠ›åºåˆ—ä»¥ç”ŸæˆäºŒè¿›åˆ¶åºåˆ—ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719125437953.png" alt="image-20220719125437953"></p>
<p>ç¡¬ä¼ªæ ‡ç­¾æ¶ˆé™¤äº†ä¸ç¡®å®šæ€§ï¼Œæä¾›äº†æ›´å¼ºçš„ç›‘ç£ï¼Œä½†å¼•å…¥äº†è¶…å‚æ•°ã€‚</p>
<p>åœ¨ç”Ÿæˆå¸§çº§ä¼ªåœ°é¢çœŸå€¼åï¼Œä½œè€…å¼ºåˆ¶æ¯ä¸ªæµç”Ÿæˆçš„æ³¨æ„åŠ›åºåˆ—ä¸ä¼ªåœ°é¢çœŸå€¼ç›¸ä¼¼ï¼Œå…·æœ‰å‡æ–¹è¯¯å·®ï¼ˆMSEï¼‰æŸå¤±ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719125458866.png" alt="image-20220719125458866"></p>
<p>åœ¨ç»†åŒ–è¿­ä»£n+1æ—¶ï¼Œæ¯ä¸ªæµçš„æ€»æŸå¤±ä¸º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719125559579.png" alt="image-20220719125559579"></p>
<p>å®éªŒä¸­æœ€å¥½çš„ç»“æœæ˜¯ä½¿ç”¨Hard Pseudo Ground Truth</p>
<h2 id="å®éªŒç»“æœ"><a href="#å®éªŒç»“æœ" class="headerlink" title="å®éªŒç»“æœ"></a>å®éªŒç»“æœ</h2><p>åœ¨THUMOSâ€™14å’ŒActivityNet-1.2ã€ActivityNet-1.3ä¸Šè¿›è¡Œäº†å®éªŒ</p>
<p>è¿™é‡Œå°±å±•ç¤ºäº†THUMOSâ€™14çš„ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719125802125.png" alt="image-20220719125802125"></p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>Self-Supervised Learning for Semi-Supervised Temporal Action Proposal</title>
    <url>/2021/10/24/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Self-Supervised%20Learning%20for%20Semi-Supervised%20Temporal%20Action%20Proposal/</url>
    <content><![CDATA[<h1 id="Self-Supervised-Learning-for-Semi-Supervised-Temporal-Action-Proposal"><a href="#Self-Supervised-Learning-for-Semi-Supervised-Temporal-Action-Proposal" class="headerlink" title="Self-Supervised Learning for Semi-Supervised Temporal Action Proposal"></a>Self-Supervised Learning for Semi-Supervised Temporal Action Proposal</h1><p>è®ºæ–‡ä½¿ç”¨è‡ªç›‘ç£çš„æ–¹æ³•æ¥æ”¹é€ åŠç›‘ç£è¡Œä¸ºå»ºè®®åŒºåŸŸç”Ÿæˆã€‚</p>
<p>ä½œè€…ä¸“é—¨è®¾è®¡äº†ä¸€ä¸ªSelf-supervised Semi-supervised Temporal Action Proposal (SSTAP) ç½‘ç»œç»“æ„ï¼Œåé¢ç®€ç§°SSTAPã€‚SSTAPåŒ…å«ä¸¤ä¸ªåˆ†æ”¯temporal-aware semi-supervised branch å’Œrelation-aware self-supervised branchï¼Œç®€å•ç†è§£å°±æ˜¯ä¸€ä¸ªåŠç›‘ç£åˆ†æ”¯å’Œä¸€ä¸ªè‡ªç›‘ç£åˆ†æ”¯ã€‚åŠç›‘ç£åˆ†æ”¯æ˜¯åŠ å…¥ç‰¹å¾åç§»å’Œç‰¹å¾ç¿»è½¬åœ¨the mean teacher frame-workä¸Šï¼Œè‡ªç›‘ç£åˆ†æ”¯åˆ™æ˜¯å®šä¹‰äº†ä¸¤ä¸ªä»»åŠ¡masked feature reconstruction å’Œ clip-order prediction</p>
<span id="more"></span>
<h2 id="å¦‚ä½•å®ç°"><a href="#å¦‚ä½•å®ç°" class="headerlink" title="å¦‚ä½•å®ç°"></a>å¦‚ä½•å®ç°</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210624205135966.png" alt="image-20210624205135966"></p>
<h3 id="1-Problem-Description"><a href="#1-Problem-Description" class="headerlink" title="1.Problem Description"></a>1.Problem Description</h3><p>é—®é¢˜çš„å®šä¹‰æ˜¯ï¼Œç»™ä¸€æ®µæœªè£å‰ª$S={s<em>n}^{ls}</em>{n=1}$ï¼Œå‡è®¾å®ƒçš„é•¿åº¦ä¸º$l<em>s$ï¼Œè®ºæ–‡çš„æ–¹æ³•çš„ç›®æ ‡æ˜¯åœ¨è§†é¢‘ç¤ºä¾‹ç‰‡æ®µ$\varphi_p={\xi_n=[t</em>{s,n},t<em>{e,n}]}^{M_n}</em>{n=1}$æ£€æµ‹å‡ºåŠ¨ä½œï¼Œå…¶ä¸­ $M<em>s$æ˜¯åŠ¨ä½œå®ä¾‹çš„æ€»æ•°ï¼Œ$[t</em>{s,n},t_{e,n}]$ åˆ†åˆ«è¡¨ç¤ºåŠ¨ä½œå®ä¾‹$\xi_n$çš„èµ·ç‚¹å’Œç»ˆç‚¹</p>
<h3 id="2-Feature-Encoding"><a href="#2-Feature-Encoding" class="headerlink" title="2.Feature Encoding"></a>2.Feature Encoding</h3><p>ç‰¹å¾æå–éƒ¨åˆ†ã€‚ç»™ä¸€æ®µæœªè£å‰ª$S={s<em>n}^{ls}</em>{n=1}$ï¼Œå‡è®¾å®ƒçš„é•¿åº¦ä¸º$l<em>s$ï¼Œæˆ‘ä»¬é¦–å…ˆå°†å…¶åˆ’åˆ†ä¸ºä¸é‡å çš„çŸ­ç‰‡æ®µï¼Œæ¯ä¸ªç‰‡æ®µåŒ…å« $\sigma$å¸§ï¼Œç„¶åé‡‡ç”¨åŒæµç½‘ç»œ(RGBæˆ–è€…Flow)æå–è§†è§‰ç‰¹å¾åºåˆ—$\phi={\phi</em>{t<em>n}}^T</em>{n=1}\in\mathbb R^{T\times C}$ï¼Œå…¶ä¸­$C$æ˜¯ç‰¹å¾çš„ç»´åº¦,è€Œ$T=l_s/\sigma$ã€‚</p>
<p>å…¶å®å°±æ˜¯ä¸€ä¸ªç›‘ç£çš„ç‰¹å¾æå–ã€‚</p>
<h3 id="3-Temporal-aware-Semi-Supervised-Branch"><a href="#3-Temporal-aware-Semi-Supervised-Branch" class="headerlink" title="3.Temporal-aware Semi-Supervised Branch"></a>3.Temporal-aware Semi-Supervised Branch</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210625120746578.png" alt="image-20210625120746578"></p>
<p>åŠç›‘ç£åˆ†æ”¯å½“ä¸­ä¸»è¦æœ‰ä¸¤ä¸ªç‚¹ï¼Œmean teacher frameworkå’Œæ‰°åŠ¨ï¼Œè¿™éƒ¨åˆ†æ˜¯åœ¨BMNç½‘ç»œä¸Šè¿›è¡Œä¿®æ”¹</p>
<h3 id="4-Relation-aware-Self-Supervised-Branch"><a href="#4-Relation-aware-Self-Supervised-Branch" class="headerlink" title="4.Relation-aware Self-Supervised Branch"></a>4.Relation-aware Self-Supervised Branch</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20210625121709195.png" alt="image-20210625121709195"></p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>è‡ªç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>Weakly Supervised Temporal Action Localization via Representative Snippet Knowledge Propagation</title>
    <url>/2022/07/30/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Weakly%20Supervised%20Temporal%20Action%20Localization%20via%20Representative%20Snippet%20Knowledge%20Propagation/</url>
    <content><![CDATA[<h1 id="Weakly-Supervised-Temporal-Action-Localization-via-Representative-Snippet-Knowledge-Propagation"><a href="#Weakly-Supervised-Temporal-Action-Localization-via-Representative-Snippet-Knowledge-Propagation" class="headerlink" title="Weakly Supervised Temporal Action Localization via Representative Snippet Knowledge Propagation"></a>Weakly Supervised Temporal Action Localization via Representative Snippet Knowledge Propagation</h1><h2 id="æ–‡ç« ç®€ä»‹"><a href="#æ–‡ç« ç®€ä»‹" class="headerlink" title="æ–‡ç« ç®€ä»‹"></a>æ–‡ç« ç®€ä»‹</h2><p>æ–‡ç« å‘è¡¨åœ¨<strong>CVPR2022</strong>ä¸Šï¼Œä½œè€…å‘ç°è®¸å¤šç°æœ‰å¼±ç›‘ç£æ—¶åºåŠ¨ä½œå®šä½æ–¹æ³•è¯•å›¾ç”Ÿæˆä¼ªæ ‡ç­¾ä»¥å¼¥è¡¥åˆ†ç±»å’Œå®šä½ä¹‹é—´çš„å·®å¼‚ï¼Œä½†ç›®å‰æ–¹æ³•é€šå¸¸ä»…åˆ©ç”¨<strong>æœ‰é™</strong>çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ç”Ÿæˆä¼ªæ ‡ç­¾ã€‚ä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œä½œè€…æå‡ºäº†ä¸€ä¸ª<strong>å…·æœ‰ä»£è¡¨æ€§çš„ç‰‡æ®µæ±‡æ€»å’Œä¼ æ’­</strong>æ¡†æ¶ã€‚ä½œè€…çš„æ–¹æ³•è¯•å›¾æŒ–æ˜æ¯ä¸ªè§†é¢‘ä¸­çš„ä»£è¡¨æ€§ç‰‡æ®µï¼Œä»¥ä¾¿åœ¨è§†é¢‘ç‰‡æ®µä¹‹é—´ä¼ æ’­ä¿¡æ¯ï¼Œä»è€Œç”Ÿæˆæ›´å¥½çš„ä¼ªæ ‡ç­¾ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210425343.png" alt="image-20220730210425343"></p>
<span id="more"></span>
<h2 id="è®ºæ–‡åŠ¨æœº"><a href="#è®ºæ–‡åŠ¨æœº" class="headerlink" title="è®ºæ–‡åŠ¨æœº"></a>è®ºæ–‡åŠ¨æœº</h2><p>ç”±äºåœ¨å¼±ç›‘ç£ä¸­ç¼ºä¹<strong>ç»†ç²’åº¦æ³¨é‡Š</strong>ï¼Œç°æœ‰å·¥ä½œä¸»è¦é‡‡ç”¨localization-by-classificationçš„æ–¹å¼è¿›è¡Œè®­ç»ƒï¼Œä½¿ç”¨åŠ¨ä½œç±»åˆ«çš„<strong>è§†é¢‘çº§æ³¨é‡Š</strong>è®­ç»ƒåˆ†ç±»å™¨ï¼Œå¹¶ç”¨äºè·å¾—<strong>æ—¶é—´ç±»æ¿€æ´»å›¾ï¼ˆTCAMï¼‰</strong>ã€‚å†é€šè¿‡é˜ˆå€¼æˆ–å®šä½åˆ†æ”¯ç­‰æ–¹å¼ä»TCAMè·å¾—æ£€æµ‹ç»“æœã€‚å› æ­¤ï¼ŒTCAMçš„è´¨é‡å†³å®šäº†æ¨¡å‹çš„ä¸Šé™ã€‚ä½†æ˜¯ï¼Œåˆ†ç±»å’Œå®šä½ä¹‹é—´é€šå¸¸å­˜åœ¨å·®å¼‚ï¼Œä½¿å¾—æ¨¡å‹å¾ˆå®¹æ˜“å°†é‡ç‚¹æ”¾åœ¨å¯¹è§†é¢‘çº§åˆ†ç±»è´¡çŒ®æœ€å¤§çš„<strong>ä¸Šä¸‹æ–‡èƒŒæ™¯</strong>æˆ–<strong>åŒºåˆ†æ€§ç‰‡æ®µä¸Š</strong>ï¼Œé˜»ç¢ç”Ÿæˆé«˜è´¨é‡TCAMã€‚</p>
<p>å› æ­¤æœ‰äººæå‡ºäº†<strong>åŸºäºä¼ªæ ‡ç­¾</strong>çš„æ–¹æ³•æ¥ç”Ÿæˆ<strong>ç‰‡æ®µä¼ªæ ‡ç­¾</strong>ï¼Œä»¥å¼¥åˆåˆ†ç±»å’Œå®šä½ä¹‹é—´çš„å·®è·ã€‚ç„¶è€Œï¼Œç°æœ‰æ–¹æ³•éƒ½æ˜¯ä½¿ç”¨æ¯ä¸ªç‰‡æ®µä¸­çš„ä¿¡æ¯æ¥ç”Ÿæˆä¼ªæ ‡ç­¾ï¼Œè¿™å¾ˆéš¾ç”Ÿæˆé«˜</p>
<p>è´¨é‡çš„ä¼ªæ ‡ç­¾ã€‚</p>
<p>åœ¨å›¾1ä¸­ï¼Œä½œè€…æ˜¾ç¤ºäº†ä¸¤ç§æ–¹æ³•çš„æ£€æµ‹ç»“æœã€‚ç¬¬ä¸€ç§æ–¹æ³•TSCNæ˜¯ä¸€ç§åŸºäºä¼ªæ ‡ç­¾çš„æ–¹æ³•ï¼Œè€Œç¬¬äºŒç§æ–¹æ³•STPNæ˜¯ä¸€ç§ä¸ä½¿ç”¨ä¼ªæ ‡ç­¾çš„ç®€å•åŸºçº¿æ¨¡å‹ã€‚æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå³ä½¿TSCNå’ŒSTPNç›¸æ¯”è·å¾—äº†å¾ˆå¤§çš„å¢ç›Šï¼Œä½†è¿™ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰æˆåŠŸåœ°æ£€æµ‹åˆ°æ©™è‰²æ¡†ä¸­çš„å›°éš¾åŠ¨ä½œå®ä¾‹ï¼Œè¯¥æ¡†ä»…æ˜¾ç¤ºè¿åŠ¨å‘˜çš„éƒ¨åˆ†èº«ä½“ã€‚æ˜¾ç„¶ï¼Œç”±ä¸å‡†ç¡®çš„TCAMç”Ÿæˆçš„ä¼ªæ ‡ç­¾ä¹Ÿä¸å‡†ç¡®ã€‚ç›¸åï¼Œå¯¹äºç®€å•çš„ä¾‹å­ï¼Œä¾‹å¦‚è“è‰²æ¡†ä¸­çš„ä¸€ä¸ªï¼Œè¿™ä¸¤ç§æ–¹æ³•éƒ½èƒ½å‡†ç¡®åœ°æ£€æµ‹åˆ°å®ƒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210529001.png" alt="image-20220730210529001"></p>
<p>ä¸ºæ­¤ä½œè€…å¼•å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯æ¥ç”Ÿæˆ<strong>ä¼ªæ ‡ç­¾</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œä½œè€…ä»¥è§†é¢‘å†…å’Œè§†é¢‘é—´çš„æ–¹å¼ä¼ æ’­è¿™äº›ä»£è¡¨æ€§ç‰‡æ®µï¼ˆå›¾ä¸­çš„é»‘è‰²å’Œè“è‰²æ–¹æ¡†ï¼‰çš„çŸ¥è¯†ï¼Œä»¥ä¿ƒè¿›ä¼ªæ ‡ç­¾çš„ç”Ÿæˆï¼Œç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›å›°éš¾çš„ç‰‡æ®µï¼ˆå›¾ä¸­çš„æ©™è‰²æ–¹æ¡†ï¼‰ã€‚</p>
<p>ä½œè€…æå‡ºäº†ä¸€ä¸ª<strong>å…·æœ‰ä»£è¡¨æ€§çš„ç‰‡æ®µæ±‡æ€»å’Œä¼ æ’­æ¡†æ¶</strong>ã€‚ä½œè€…çš„æ–¹æ³•è¯•å›¾æŒ–æ˜æ¯ä¸ªè§†é¢‘ä¸­çš„ä»£è¡¨æ€§ç‰‡æ®µï¼Œä»¥ä¾¿åœ¨è§†é¢‘ç‰‡æ®µä¹‹é—´ä¼ æ’­ä¿¡æ¯ï¼Œä»è€Œ<strong>ç”Ÿæˆæ›´å¥½çš„ä¼ªæ ‡ç­¾</strong>ã€‚å¯¹äºæ¯ä¸ªè§†é¢‘ï¼Œä»¥è§†é¢‘å†…å’Œè§†é¢‘é—´çš„æ–¹å¼ä¼ æ’­å…¶è‡ªèº«çš„ä»£è¡¨ç‰‡æ®µå’Œæ¥è‡ªå­˜å‚¨åº“çš„ä»£è¡¨ç‰‡æ®µä»¥æ›´æ–°è¾“å…¥ç‰¹å¾ã€‚ä¼ªæ ‡ç­¾æ˜¯ç”±æ›´æ–°ç‰¹å¾çš„æ—¶é—´ç±»æ¿€æ´»æ˜ å°„ç”Ÿæˆï¼Œä»¥çº æ­£ä¸»åˆ†æ”¯çš„é¢„æµ‹</p>
<p>ä½œè€…çš„æ–¹æ³•æ¦‚è¿° å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210725403.png" alt="image-20220730210725403"></p>
<h2 id="Feature-extraction"><a href="#Feature-extraction" class="headerlink" title="Feature extraction"></a>Feature extraction</h2><p>ç»™å®šä¸€æ®µè§†é¢‘ï¼Œä½œè€…é¦–å…ˆæŠŠå®ƒåˆ†ä¸ºä¸€äº›åˆ—ä¸é‡å ç‰‡æ®µã€‚æ¥ä¸‹æ¥ï¼Œä½œè€…åˆ©ç”¨å›ºå®šæƒé‡çš„backboneç½‘ç»œï¼Œåœ¨Kinetics-400æ•°æ®é›†ä¸Šé¢„è®­ç»ƒI3Dæ¨¡å‹ï¼Œå°†å¤–è§‚ï¼ˆRGBï¼‰å’Œè¿åŠ¨ï¼ˆå…‰æµï¼‰ä¿¡æ¯ç¼–ç ä¸ºd=2048ç»´ç‰¹å¾ã€‚I3Dç‰¹å¾é€šè¿‡å·ç§¯å±‚ç¼–ç åˆ°æ½œåœ¨åµŒå…¥FâˆˆR^(lÃ—d)ä¸­ï¼Œå…¶ä¸­læ˜¯è§†é¢‘çš„ç‰‡æ®µæ•°ã€‚ä½œè€…å–Fä½œä¸ºæ¨¡å‹çš„è¾“å…¥ã€‚ </p>
<h2 id="Classification-head"><a href="#Classification-head" class="headerlink" title="Classification head"></a>Classification head</h2><p>åˆ†ç±»å¤´ç”¨äºç”ŸæˆTCAMï¼Œå®ƒå¯ä»¥æ˜¯ä»»ä½•ç°æœ‰çš„WSTALæ–¹æ³•ã€‚ä¸ºäº†ç”Ÿæˆé«˜è´¨é‡çš„TCAMå¹¶æ”¹è¿›ä½œè€…æ–¹æ³•çš„ä¸‹é™ï¼Œä½œè€…ä½¿ç”¨äº†æœ€æ–°çš„FAC-Netä½œä¸ºåˆ†ç±»å¤´ï¼ˆä½œè€…ç»è¿‡ä¸€å®šçš„ä¿®æ”¹ï¼‰ï¼Œå› ä¸ºå®ƒå…·æœ‰ç®€å•çš„ç®¡é“å’Œè‰¯å¥½çš„æ€§èƒ½ã€‚</p>
<h2 id="Representative-Snippet-Summarization"><a href="#Representative-Snippet-Summarization" class="headerlink" title="Representative Snippet Summarization"></a>Representative Snippet Summarization</h2><p>è·å¾—ä»£è¡¨æ€§ç‰‡æ®µçš„ç®€å•æ–¹æ³•æ˜¯é€‰æ‹©<strong>é¢„æµ‹å¾—åˆ†é«˜</strong>çš„ç‰‡æ®µï¼Œå³<strong>è¾¨åˆ«æ€§ç‰‡æ®µ</strong>ã€‚ç„¶è€Œï¼Œå¦‚å›¾æ‰€ç¤ºï¼Œå³ä½¿ç»è¿‡å¤§è§„æ¨¡çš„é¢„è®­ç»ƒï¼Œ<strong>è¾¨åˆ«æ€§ç‰‡æ®µ</strong>å’ŒåŒç±»åˆ«çš„å…¶ä»–ç‰‡æ®µä¹‹é—´çš„ç›¸ä¼¼åº¦é€šå¸¸è¾ƒä½ã€‚ç›´è§‚åœ°è¯´ï¼Œä»£è¡¨æ€§ç‰‡æ®µåº”è¯¥èƒ½å¤Ÿæè¿°åŒä¸€ç±»çš„å¤§å¤šæ•°ç‰‡æ®µï¼Œä»è€Œèµ·åˆ°è”ç³»åŒä¸€ç±»ç‰‡æ®µè¿›è¡ŒçŸ¥è¯†ä¼ æ’­çš„æ¡¥æ¢çš„ä½œç”¨ã€‚å› æ­¤ï¼Œå°†<strong>è¾¨åˆ«æ€§ç‰‡æ®µ</strong>çš„ä¿¡æ¯ç›´æ¥ä¼ æ’­åˆ°å…¶ä»–ç‰‡æ®µæ˜¯æ— æ•ˆçš„ã€‚</p>
<p>ä½œè€…æå‡ºå¯¹è§†é¢‘ç‰‡æ®µçš„è¡¨ç¤ºæ–¹å¼è¿›è¡Œæ€»ç»“ï¼Œå¾—åˆ°æ¯ä¸ªè§†é¢‘çš„<strong>è¾¨åˆ«æ€§ç‰‡æ®µ</strong>ã€‚åœ¨å›¾ä¸­ï¼Œé€šè¿‡<strong>èšç±»</strong>è§†é¢‘ç‰‡æ®µç‰¹å¾ï¼ˆä¾‹å¦‚ï¼Œkå‡å€¼ã€è°±èšç±»å’Œå‡èšèšç±»ï¼‰ï¼Œä½¿ç”¨èšç±»ä¸­å¿ƒä½œä¸ºä»£è¡¨ç‰‡æ®µï¼Œå–å¾—äº†æ›´å¥½çš„æ€§èƒ½ã€‚å®éªŒè¡¨æ˜ï¼Œä½¿ç”¨èšç±»æ–¹æ³•æ€»ç»“ä»£è¡¨æ€§ç‰‡æ®µå¯¹äºæé«˜é«˜æ£€æµ‹æ€§èƒ½æœ‰é‡è¦æ„ä¹‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210858240.png" alt="image-20220730210858240"></p>
<p>åœ¨è¿™é¡¹å·¥ä½œä¸­ï¼Œä½œè€…ä½¿ç”¨<strong>æœŸæœ›æœ€å¤§åŒ–ï¼ˆEMï¼‰æ³¨æ„åŠ›</strong>æ¥ç”Ÿæˆæ¯ä¸ªè§†é¢‘çš„ä»£è¡¨æ€§ç‰‡æ®µã€‚EMæ³¨æ„åŠ›ä½¿ç”¨åŸºäºé«˜æ–¯æ··åˆæ¨¡å‹ï¼ˆGMMï¼‰çš„ç‰¹æ®ŠEMç®—æ³•ã€‚å…·ä½“æ¥è¯´ï¼Œé‡‡ç”¨åˆ†ç¦»çš„GMMæ¥æ•è·æ¯ä¸ªè§†é¢‘çš„ç‰¹å¾ç»Ÿè®¡ä¿¡æ¯ï¼Œå¹¶å°†$f_i\in \mathbb R^d$($F$çš„ç¬¬$i$ä¸ªç‰‡æ®µç‰¹å¾)çš„åˆ†å¸ƒå»ºæ¨¡ä¸ºä¸€ä¸ªé«˜æ–¯çº¿æ€§ç»„åˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210940462.png" alt="image-20220730210940462"></p>
<p>å…¶ä¸­$n$ä¸ºé«˜æ–¯å‡½æ•°çš„ä¸ªæ•°ï¼Œ$\mu<em>k\in\mathbb R^d,\sum_k\in\mathbb R^{d\times d},Z</em>{ik}$åˆ†åˆ«è¡¨ç¤ºç¬¬$k$ä¸ªé«˜æ–¯å‡½æ•°çš„å‡å€¼ã€åæ–¹å·®çŸ©é˜µå’Œæƒé‡ã€‚ä½œè€…ç”¨å•ä½çŸ©é˜µ<strong>I</strong>æ›¿æ¢äº†åæ–¹å·®ï¼Œåœ¨åç»­çš„æ–¹ç¨‹ä¸­å»æ‰å®ƒã€‚(å…¶å®è¿™é‡Œçš„$\mu$æ˜¯é«˜æ–¯å‡½æ•°çš„å¹³å‡å€¼ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ç†è§£ä¸º)</p>
<p>å¦‚å›¾ï¼ˆé¡¶éƒ¨ï¼‰æ‰€ç¤ºï¼ŒEMæ³¨æ„åŠ›ä»éšæœºåˆå§‹åŒ–çš„å‡å€¼$\mu^{(0)}\in\mathbb R^{n\times d}$å¼€å§‹ã€‚åœ¨ç¬¬$t$æ¬¡è¿­ä»£ä¸­ï¼Œé¦–å…ˆæ‰§è¡ŒEæ­¥éª¤ï¼Œè®¡ç®—é«˜æ–¯çš„æ–°æƒé‡$Z^{(t)}\in\mathbb R^{t\times n}$ä¸ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211006038.png" alt="image-20220730211006038"></p>
<p>å…¶ä¸­$\lambda$è¡¨ç¤ºä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºæ§åˆ¶åˆ†å¸ƒçš„å¹³æ»‘åº¦ã€‚$Norm<em>2 (F)$æ²¿Fçš„æ¯ä¸€è¡Œçš„$l2-norm$ã€‚softmaxæ“ä½œæ²¿$Z$çš„æ¯ä¸€è¡Œéƒ½æ‰§è¡Œã€‚å› æ­¤ï¼Œ$Z^{(t)}</em>{ik}$è¡¨ç¤ºç‰‡æ®µç‰¹å¾$f_i$ç”±ç¬¬kä¸ªé«˜æ–¯å‡½æ•°ç”Ÿæˆçš„æ¦‚ç‡ã€‚</p>
<p>åœ¨Eæ­¥éª¤ä¹‹åï¼ŒMæ­¥éª¤å°†å¹³å‡å€¼Î¼è¿›è¡Œæ›´æ–°ä¸ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211054457.png" alt="image-20220730211054457"></p>
<p>å…¶ä¸­$Norm_1(Z^{(t)})$è¡¨ç¤º$Z^t $æŒ‰ç…§åˆ—è¿›è¡Œ$l_1$ å½’ä¸€åŒ–ã€‚å¯ä»¥çœ‹åˆ°å…¬å¼æ›´æ–°å‡å€¼å®éªŒç‰¹å¾Fçš„åŠ æƒæ±‚å’Œã€‚å½’ä¸€åŒ–ç¡®ä¿æ›´æ–°åçš„$\mu$ä¸$F$ä½äºç›¸åŒçš„åµŒå…¥ç©ºé—´ä¸­ã€‚å› æ­¤ï¼Œäº¤æ›¿æ‰§è¡Œä¸Šè¿°ä¸¤ä¸ªç­‰å¼ä»¥éå±€éƒ¨ä½†æ›´æœ‰æ•ˆçš„æ–¹å¼æ•è·è§†é¢‘çš„å…¨å±€ä¸Šä¸‹æ–‡ï¼Œè¿™æ˜¯å› ä¸ºå‡å€¼$\mu^{(t)}\in\mathbb R^{n\times d}$ çš„å°ºå¯¸æ¯”è§†é¢‘ç‰¹å¾$F\in\mathbb R^{l\times d}(l&gt;&gt;n)$å°çš„å¤šã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211023456.png" alt="image-20220730211023456"></p>
<p>ä½œè€…åœ¨ç½‘ç»œä¸­é›†æˆäº†ä¸¤ä¸ªEMè¿­ä»£ï¼Œä»¥è·å¾—æœ‰å¸Œæœ›çš„ä»£è¡¨æ€§ç‰‡æ®µï¼ˆå³$\mu^{(2)}$ ï¼‰ã€‚ä½œè€…é€šè¿‡æ ‡å‡†åå‘ä¼ æ’­æ›´æ–°åˆå§‹åŒ–å‡å€¼ã€‚æ­¤å¤–ï¼Œå½“ä½œè€…ç”¨ä¸€ä¸ªï¼ˆåŠï¼‰æ­£äº¤çŸ©é˜µåˆå§‹åŒ–$\mu^{0}$æ—¶ï¼Œå³ä½¿<strong>å›ºå®šäº†åˆå§‹åŒ–çš„å‡å€¼</strong>ï¼ˆå³å›¾ä¸­çš„EM-Att w/o BPï¼‰ï¼Œè·å¾—çš„ä»£è¡¨æ€§ç‰‡æ®µä¹Ÿæ¯”å…¶ä»–èšç±»æ–¹æ³•çš„èšç±»ä¸­å¿ƒæ›´å…·ä»£è¡¨æ€§ã€‚å½“ä½œè€…é€šè¿‡<strong>æ ‡å‡†åå‘ä¼ æ’­</strong>ï¼ˆå³å›¾ä¸­çš„EM-Attï¼‰æ›´æ–°åˆå§‹å‡å€¼$\mu^{0}$æ—¶ï¼Œå®ƒä»¬å¯ä»¥æ•è·æ•°æ®é›†çš„ç‰¹å¾åˆ†å¸ƒå¹¶å®ç°æœ€ä½³æ€§èƒ½ã€‚ä¸ºäº†ä½¿æ–¹ç¨‹æ¸…æ™°å¹¶é¿å…æ··æ·†ï¼Œæˆ‘ä»¬å°†åœ¨çº¿è®¡ç®—çš„ä»£è¡¨æ€§ç‰‡æ®µè¡¨ç¤ºä¸º$\mu^{(a)}$ ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210858240.png" alt="image-20220730210858240"></p>
<h2 id="Representative-Snippet-Memory-Bank"><a href="#Representative-Snippet-Memory-Bank" class="headerlink" title="Representative Snippet Memory Bank"></a>Representative Snippet Memory Bank</h2><p>åœ¨è·å¾—æ¯ä¸ªè§†é¢‘çš„ä»£è¡¨æ€§ç‰‡æ®µåï¼Œä½œè€…ä½¿ç”¨ä¸€ä¸ª<strong>å­˜å‚¨åº“</strong>æ¥å­˜å‚¨æ¯ä¸ªç±»çš„æ‰€æœ‰<strong>é«˜ç½®ä¿¡åº¦è§†é¢‘çš„ä»£è¡¨ç‰‡æ®µ</strong>ã€‚ä½œè€…è®¤ä¸ºä¸åŒçš„è§†é¢‘å¯èƒ½åŒ…å«ç›¸åŒçš„åŠ¨ä½œå®ä¾‹ï¼Œä½†æ˜¯å…·æœ‰ä¸åŒçš„å¤–è§‚ã€‚å› æ­¤ï¼Œé€šè¿‡å­˜å‚¨åº“ä»¥è§†é¢‘é—´çš„æ–¹å¼ä¼ æ’­ä»£è¡¨æ€§ç‰‡æ®µï¼Œå¯ä»¥åˆ©ç”¨æ¯ä¸ªç±»çš„è®¸å¤šè§†é¢‘çš„å·¨å¤§å˜åŒ–ï¼Œå¸®åŠ©ç½‘ç»œè¯†åˆ«é‚£äº›å›°éš¾çš„åŠ¨ä½œå®ä¾‹ã€‚ </p>
<p>å…·ä½“æ¥è¯´ï¼Œä½œè€…ç»´æŠ¤äº†ä¸¤ä¸ªè®°å¿†è¡¨ï¼Œåˆ†åˆ«å­˜å‚¨ä»£è¡¨æ€§ç‰‡æ®µçš„<strong>ç‰¹å¾</strong>åŠå…¶<strong>åˆ†æ•°</strong>ã€‚æˆ‘ä»¬å°†ä»£è¡¨æ€§ç‰‡æ®µçš„å†…å­˜è¡¨è¡¨ç¤ºä¸º$M\in\mathbb R^{c\times s\times d}$ï¼Œå…¶ä¸­cæ˜¯ç±»çš„æ•°é‡ï¼Œsè¡¨ç¤ºæ¯ä¸ªç±»çš„å†…å­˜æ’æ§½ï¼ˆä»£è¡¨æ€§ç‰‡æ®µï¼‰çš„æ•°é‡ã€‚ç»™å®šè§†é¢‘çš„ä»£è¡¨æ€§ç‰‡æ®µï¼Œä½œè€…åˆ©ç”¨åˆ†ç±»å¤´ä¸­çš„åŠ¨ä½œåˆ†ç±»å™¨æ¥è·å¾—å®ƒä»¬çš„ç±»é¢„æµ‹ã€‚ç„¶åï¼Œå°†å®ƒä»¬çœŸå®ç±»çš„é¢„æµ‹åˆ†æ•°ä¸å­˜å‚¨è¡¨Mä¸­çš„ä»£è¡¨æ€§ç‰‡æ®µè¿›è¡Œæ¯”è¾ƒï¼Œé¢„æµ‹åˆ†æ•°è¾ƒé«˜çš„ç‰‡æ®µè¢«å½’æ¡£åˆ°å­˜å‚¨è¡¨Mã€‚åŒæ—¶ï¼Œåˆ†æ•°å­˜å‚¨è¡¨ä¸­çš„ç›¸åº”åˆ†æ•°ä¹Ÿè¢«æ›´æ–°ã€‚æ€»ä¹‹ï¼Œä½œè€…åªå°†åˆ†æ•°é«˜çš„ä»£è¡¨æ€§ç‰‡æ®µä¿ç•™åœ¨å†…å­˜è¡¨ä¸­ã€‚ä¸ºäº†åŒºåˆ«äº<strong>åœ¨çº¿</strong>ä»£è¡¨æ€§ç‰‡æ®µ$\mu^{(a)}$ ï¼Œå°†<strong>ç¦»çº¿</strong>ä»£è¡¨æ€§ç‰‡æ®µè¡¨ç¤ºä¸º$\mu^{(e)}$ ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730210725403.png" alt="image-20220730210725403"></p>
<h2 id="Representative-Snippet-Propagation"><a href="#Representative-Snippet-Propagation" class="headerlink" title="Representative Snippet Propagation"></a>Representative Snippet Propagation</h2><p>ç»™å®šåœ¨çº¿å’Œç¦»çº¿ä»£è¡¨æ€§ç‰‡æ®µ$\mu^{(a)}$å’Œ$\mu^{(e)}$ ï¼Œä¸€ä¸ªæŒ‘æˆ˜æ˜¯å¦‚ä½•å°†<strong>ä»£è¡¨æ€§ç‰‡æ®µ</strong>ä¼ æ’­åˆ°å½“å‰è§†é¢‘çš„ç‰‡æ®µç‰¹å¾Fã€‚ç›´è§‚åœ°è¯´ï¼Œä¸€ç§ç›´æ¥çš„æ–¹æ³•æ˜¯ä½¿ç”¨äº²å’ŒåŠ›$Z^âˆ—$(âˆ— æ˜¯aæˆ–eï¼‰ï¼Œè¿›è¡Œéšæœºæ¸¸åŠ¨æ“ä½œä½œä¸º$Z^âˆ— Î¼^âˆ—$ ã€‚ å®é™…ä¸Šï¼Œä½œè€…å¸Œæœ›æ›´æ–°åçš„ç‰¹å¾ä¸ä¼šåç¦»è§†é¢‘ç‰¹å¾Få¤ªè¿œã€‚å› æ­¤ï¼Œä¼ æ’­è¿‡ç¨‹å¯ä»¥å…¬å¼åŒ–ä¸º$F^âˆ—=\omegaâ‹…Z^âˆ— Î¼^âˆ—+(1-\omega)â‹…F$ï¼Œå…¶ä¸­$\omega$è¡¨ç¤ºæ§åˆ¶ç‰¹å¾ä¼ æ’­å’ŒåŸå§‹ç‰¹å¾ä¹‹é—´æƒè¡¡çš„å‚æ•°ã€‚</p>
<p>ç„¶è€Œï¼Œå³ä½¿ä»£è¡¨æ€§ç‰‡æ®µä¸åŒä¸€ç±»çš„å¤§å¤šæ•°ç‰‡æ®µå…·æœ‰é«˜åº¦ç›¸ä¼¼æ€§ï¼Œé€šè¿‡ä¸€æ¬¡ä¼ æ’­æ¥å®Œå…¨ä¼ æ’­ä»£è¡¨æ€§ç‰‡æ®µçš„çŸ¥è¯†ä¹Ÿæ˜¯ä¸åˆ‡å®é™…çš„ã€‚ä½œè€…å‘ç°ï¼Œå…·æœ‰ä»£è¡¨æ€§çš„ç‰‡æ®µ$\mu^<em>$å’Œè§†é¢‘ç‰¹å¾Få®é™…ä¸Šæ„æˆäº†ä¸€ä¸ªå®Œæ•´çš„<strong>äºŒéƒ¨å›¾</strong>ï¼Œå…¶äº²å’ŒåŠ›ç”±$Z^âˆ—$è¡¨ç¤ºã€‚å› æ­¤ï¼Œä½œè€…æå‡ºäº†ä¸€ä¸ª<em>*äºŒéƒ¨éšæœºæ¸¸èµ°ï¼ˆBiRWï¼‰æ¨¡å—</em></em>ï¼Œä»¥å®ç°å¤šæ¬¡ä¼ æ’­ï¼Œå°†ä»£è¡¨æ€§ç‰‡æ®µçš„çŸ¥è¯†å®Œå…¨èåˆåˆ°è§†é¢‘ç‰‡æ®µç‰¹å¾ä¸­ã€‚ </p>
<p>BiRWä¸­æœ‰å¤šæ¬¡è¿­ä»£ã€‚åœ¨ç¬¬$t$æ¬¡è¿­ä»£ä¸­ï¼Œä¼ æ’­è¿‡ç¨‹å…¬å¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211322392.png" alt="image-20220730211322392"></p>
<p>å…¶ä¸­å…¶ä¸­$F^{(0)}$å’Œ$\mu^{(0)}$åˆ†åˆ«æ˜¯è§†é¢‘ç‰‡æ®µç‰¹å¾$F$å’Œä»£è¡¨ç‰‡æ®µ  ã€‚$\mu^{(a)}$å’Œ$\mu^{(e)}$å¦‚å›¾ï¼ˆåº•éƒ¨ï¼‰æ‰€ç¤ºï¼Œä¸Šè¿°å…¬å¼ä¹Ÿå¯ä»¥è¢«è§†ä¸ºEMè¿‡ç¨‹ï¼Œå®ƒå›ºå®šäº†äº²å’ŒåŠ›$Z^*$äº¤æ›¿æ›´æ–°$F$å’Œ$\mu^âˆ—$  ã€‚å› æ­¤ï¼Œä»£è¡¨æ€§ç‰‡æ®µä¸ä»…ç”¨äºä¼ æ’­ä»£è¡¨æ€§çŸ¥è¯†ï¼Œè€Œä¸”è¿˜ä½œä¸ºæ¡¥æ¢åœ¨Fçš„ç‰¹å¾ä¹‹é—´ä¼ æ’­çŸ¥è¯†ã€‚ç”±äºå…¶ä»£è¡¨æ€§ï¼Œå®ƒä»¬å¯ä»¥æ›´å¥½åœ°åœ¨åŒä¸€ç±»çš„ç‰¹å¾ä¹‹é—´ä¼ æ’­ä¿¡æ¯ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å¤šæ¬¡è¿›è¡Œï¼Œä»¥å……åˆ†èåˆä»£è¡¨æ€§ç‰‡æ®µçš„çŸ¥è¯†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211023456.png" alt="image-20220730211023456"></p>
<p>ä¸ºäº†é¿å…å±•å¼€è®¡ç®—å›¾å¼•èµ·çš„æ¢¯åº¦æ¶ˆå¤±æˆ–çˆ†ç‚¸ï¼Œä½œè€…ä½¿ç”¨è¿‘ä¼¼æ¨ç†å…¬å¼</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211354223.png" alt="image-20220730211354223"></p>
<p>æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­‰å¼ï¼ˆ6ï¼‰åˆ†åˆ«ä¼ æ’­å…³äº$\mu^{(a)}$å’Œ$\mu^{(e)}$çš„çŸ¥è¯†ï¼Œè€Œä¸æ˜¯è¿æ¥$\mu^{(a)}$å’Œ$\mu^{(e)}$æ¥ä¼ æ’­ä»£è¡¨æ€§ç‰‡æ®µã€‚è¯¥è®¾è®¡ç›®çš„æ˜¯é˜²æ­¢ä»Fçš„åŒä¸€è§†é¢‘ä¸­æå–çš„åœ¨$\mu^{(a)}$ä¼ æ’­ä¸­å ä¸»å¯¼åœ°ä½ã€‚å› æ­¤ï¼Œåœ¨ä»£è¡¨æ€§ç‰‡æ®µä¼ æ’­åï¼Œæˆ‘ä»¬åˆ†åˆ«è·å¾—æ›´æ–°çš„è§†é¢‘å†…ç‰¹å¾$F^a$å’Œæ›´æ–°çš„è§†é¢‘é—´ç‰¹å¾$F^e$ã€‚ </p>
<h2 id="Training-Objectives"><a href="#Training-Objectives" class="headerlink" title="Training Objectives"></a>Training Objectives</h2><p>ç»™å®šåŸå§‹è§†é¢‘ç‰‡æ®µç‰¹å¾$F$å’Œæ›´æ–°åçš„ç‰¹å¾$F^a,F^e$ï¼Œæˆ‘ä»¬å°†å…¶è¾“å…¥ä¸‰ä¸ªå…·æœ‰å…±äº«å‚æ•°çš„å¹¶è¡Œåˆ†ç±»å¤´ï¼Œåˆ†åˆ«è¾“å‡ºå…¶TCAM $T$ã€$T^a$å’Œ$T^e$ã€‚å¯¹TCAMsè¿›è¡ŒåŠ æƒæ±‚$T^a$å’Œ$T^e$å’Œï¼Œè·å¾—åŒ…å«è§†é¢‘å†…å’Œè§†é¢‘é—´ä»£è¡¨æ€§ç‰‡æ®µçŸ¥è¯†çš„TCAM $T^f$ã€‚ä½œè€…å°†$T^f$ä½œä¸ºåœ¨çº¿ä¼ªæ ‡ç­¾æ¥ç›‘æ§TCAM $T$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211430094.png" alt="image-20220730211430094"></p>
<p>å…¶ä¸­tæ˜¯ç‰‡æ®µæ•°ã€‚æ€»æŸå¤±æ˜¯æŸå¤±$L<em>{kd}$ã€ä¸‰ä¸ªåˆ†ç±»å¤´çš„è§†é¢‘åˆ†ç±»æŸå¤±$L</em>{cls}$å’Œåªåº”ç”¨äºä¸»åˆ†æ”¯çš„æ³¨æ„åŠ›å½’ä¸€åŒ–æŸå¤±$L_{att}$çš„æ€»å’Œã€‚ </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220730211441366.png" alt="image-20220730211441366"></p>
<p>å…¶ä¸­Î±å’ŒÎ²æ˜¯å¹³è¡¡å‚æ•°ã€‚ </p>
<p>æ³¨æ„åŠ›å½’ä¸€åŒ–æŸå¤±$L_{att}$åœ¨<a href="https://bugcat9.github.io/2022/07/19/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Two-Stream%20Consensus%20Network%20for%20Weakly-Supervised%20Temporal/">TSCN</a>ä¸­æåˆ°è¿‡</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20220719124601551.png" alt="image-20220719124601551"></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/78311644">https://zhuanlan.zhihu.com/p/78311644</a></li>
</ul>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>Weakly-supervised Temporal Action Localization by Uncertainty Modeling</title>
    <url>/2021/12/02/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/Weakly-supervised%20Temporal%20Action%20Localization%20by%20Uncertainty%20Modeling/</url>
    <content><![CDATA[<h1 id="Weakly-supervised-Temporal-Action-Localization-by-Uncertainty-Modeling"><a href="#Weakly-supervised-Temporal-Action-Localization-by-Uncertainty-Modeling" class="headerlink" title="Weakly-supervised Temporal Action Localization by Uncertainty Modeling"></a>Weakly-supervised Temporal Action Localization by Uncertainty Modeling</h1><h2 id="æå‡ºé—®é¢˜"><a href="#æå‡ºé—®é¢˜" class="headerlink" title="æå‡ºé—®é¢˜"></a>æå‡ºé—®é¢˜</h2><p>ç°æœ‰çš„Weakly-supervised Temporal Action Localizationå¤„ç†èƒŒæ™¯çš„æ–¹æ³•å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œè¦ä¸å°†é™æ€å¸§åˆå¹¶åˆæˆä¼ªèƒŒæ™¯è§†é¢‘ï¼Œä½†å¿½ç•¥äº†åŠ¨æ€èƒŒæ™¯å¸§ï¼Œè¦ä¸å°†èƒŒæ™¯æ¡†æ¶åˆ’åˆ†ä¸ºä¸€ä¸ªå•ç‹¬çš„ç±»åˆ«ã€‚ç„¶è€Œï¼Œå¼ºåˆ¶æ‰€æœ‰çš„èƒŒæ™¯å¸§å±äºä¸€ä¸ªç‰¹å®šçš„ç±»ï¼ˆèƒŒæ™¯ç±»åˆ«å…¶å®ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå› ä¸ºå®ƒä»¬ä¸å…±äº«ä»»ä½•å…±åŒçš„è¯­ä¹‰ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202113108293.png" alt="image-20211202113108293"></p>
<p>å¦‚å›¾aä¸­èƒŒæ™¯å…¶å®æ˜¯éå¸¸åŠ¨æ€çš„ï¼ˆç†è§£ä¸ºæ‘„åƒæœºåœ¨åŠ¨ï¼Œå…¶ä¸­çš„äººä¹Ÿæ˜¯åœ¨åŠ¨çš„ï¼‰ï¼Œå›¾bä¸­å±•ç°å‡ºæ¥çš„ä¸€ä¸ªè§†é¢‘ä¸­çš„èƒŒæ™¯æ˜¯ä¸ç›¸åŒçš„ã€‚</p>
<span id="more"></span>
<h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>è®ºæ–‡çš„ä½œè€…æ¥å—èƒŒæ™¯å¸§ä¸ä¸€è‡´çš„è§‚å¯Ÿã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒåŠ¨ä½œå¸§çš„ç‰¹å¾æ¯”èƒŒæ™¯å¸§çš„ç‰¹å¾æœ‰æ›´å¤§çš„å¹…åº¦ï¼Œå¦‚å›¾aæ‰€ç¤ºã€‚è¿™æ˜¯å› ä¸ºåŠ¨ä½œå¸§éœ€è¦ä¸ºåŸºæœ¬äº‹å®çš„åŠ¨ä½œç±»ç”Ÿæˆé«˜å¯¹æ•°ã€‚è™½ç„¶ç‰¹å¾é‡æ˜¾ç¤ºäº†èƒŒæ™¯å’ŒåŠ¨ä½œå¸§ä¹‹é—´çš„è¯†åˆ«ç›¸å…³æ€§ï¼Œä½†ç”±äºåŠ¨ä½œå’ŒèƒŒæ™¯çš„åˆ†å¸ƒæ¯”è¾ƒæ¥è¿‘ï¼Œç›´æ¥ä½¿ç”¨ç‰¹å¾é‡è¿›è¡Œè¯†åˆ«æ˜¯ä¸å¤Ÿçš„ã€‚å› æ­¤ï¼Œä¸ºäº†è¿›ä¸€æ­¥é¼“åŠ±ç‰¹å¾å¹…åº¦ä¸Šçš„å·®å¼‚ï¼Œä½œè€…å»ºè®®é€šè¿‡å¢å¤§åŠ¨ä½œç‰¹å¾çš„å¹…åº¦å’Œå‡å°æ¥è¿‘äºé›¶çš„èƒŒæ™¯ç‰¹å¾çš„å¹…åº¦æ¥åˆ†ç¦»åˆ†å¸ƒ(å›¾b)ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202113647997.png" alt="image-20211202113647997"></p>
<p>åŸºäºä¸Šé¢æå‡ºçš„æ€æƒ³æå‡ºäº†ä¸€ä¸ªä¸ç¡®å®šæ€§å»ºæ¨¡çš„æ–¹æ³•ã€‚</p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202113830606.png" alt="image-20211202113830606"></p>
<h3 id="Main-pipeline"><a href="#Main-pipeline" class="headerlink" title="Main pipeline"></a>Main pipeline</h3><h4 id="Feature-extraction"><a href="#Feature-extraction" class="headerlink" title="Feature extraction"></a>Feature extraction</h4><p>å°†è§†é¢‘åˆ†å‰²æˆå¤šä¸ªæ®µï¼Œ$v<em>n=\lbrace s</em>{n,l}\rbrace^{L<em>n}</em>{l=1}$ï¼Œç„¶åè¿›è¡Œé‡‡æ ·ä½¿å¾—$v<em>n=\lbrace \tilde{s}</em>{n,t} \rbrace^T<em>{t=1}$ã€‚ç„¶åæå–RGBç‰¹å¾$x^{RGB}</em>{n,t}\in \mathbb R^D$å’Œflowå…‰æµç‰¹å¾$x^{flow}<em>{n,t}\in \mathbb R^D$,å†æ‹¼æ¥åœ¨ä¸€èµ·$X_n=[x</em>{n,1},â€¦,x_{n,T}]\in \mathbb R^{2d\times T}$</p>
<p>ç‰¹å¾æå–è¿™ä¸€æ­¥å¾ˆç®€å•å’Œå¤§å¤šæ•°çš„WTALçš„æ–¹æ³•ç›¸åŒ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202151403440.png" alt="image-20211202151403440"></p>
<h4 id="Feature-embedding"><a href="#Feature-embedding" class="headerlink" title="Feature embedding"></a>Feature embedding</h4><p>ä¸ºäº†å°†æå–çš„ç‰¹å¾åµŒå…¥åˆ°ç‰¹å®šäºä»»åŠ¡çš„ç©ºé—´ä¸­ï¼Œä½œè€…ä½¿ç”¨ä¸€ä¸ªä¸€ç»´å·ç§¯å±‚ï¼Œç„¶åä½¿ç”¨ä¸€ä¸ªReLUå‡½æ•°ã€‚</p>
<script type="math/tex; mode=display">
F_n=g_{embed}(X_n;\phi_{embed})</script><p>æœ€ç»ˆå¾—åˆ°çš„$F<em>n=[f</em>{n,1},â€¦,f_{n,T}]\in\mathbb R^{2D\times T}$</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202151949445.png" alt="image-20211202151949445"></p>
<h4 id="Segment-level-classification"><a href="#Segment-level-classification" class="headerlink" title="Segment-level classification"></a>Segment-level classification</h4><p>è¿™ä¸€æ­¥éœ€è¦å¾—åˆ°ç±»æ¿€æ´»åºåˆ—ï¼Œä½¿ç”¨ä¸€ä¸ªåˆ†ç±»å™¨</p>
<script type="math/tex; mode=display">
A_n=g_{cls}(F_n;\phi_{cls})</script><p>å…¶ä¸­$g_{cls}$è¡¨ç¤ºçº¿æ€§åˆ†ç±»å™¨ï¼Œæœ€ç»ˆå¾—åˆ°çš„$A_n\in\mathbb R^{C\times T}$</p>
<h4 id="Action-score-aggregation"><a href="#Action-score-aggregation" class="headerlink" title="Action score aggregation"></a>Action score aggregation</h4><p>éµå¾ªä¹‹å‰çš„æ–¹æ³•ï¼Œé‡‡å–topkå‡å€¼çš„æ–¹æ³•ï¼Œä»è€Œè·å¾—è¯¥ç±»åˆ«çš„åˆ†æ•°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202152829191.png" alt="image-20211202152829191"></p>
<p>å†ä½¿ç”¨softmaxï¼Œå¯ä»¥å¾—åˆ°å¯¹åº”åŠ¨ä½œcçš„æ¦‚ç‡</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202153204454.png" alt="image-20211202153204454"></p>
<p>è¿™ä¸ªå’Œä¹‹å‰çš„å·¥ä½œç±»ä¼¼</p>
<h3 id="Uncertainty-modeling"><a href="#Uncertainty-modeling" class="headerlink" title="Uncertainty modeling"></a>Uncertainty modeling</h3><p>ä¸Šé¢éƒ¨åˆ†ï¼Œæ˜¯åŸºæœ¬çš„WTALæ­¥éª¤ï¼Œé‡Œé¢å¹¶æ²¡æœ‰è€ƒè™‘èƒŒæ™¯ã€‚è€ƒè™‘åˆ°èƒŒæ™¯å¸§çš„ä¸çº¦æŸå’Œä¸ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å°†èƒŒæ™¯ä½œä¸ºWTALçš„out-<br>of-distributionå’Œuncertainty</p>
<p>è€ƒè™‘åˆ°è§†é¢‘ç‰‡æ®µ$\tilde{s}_{n,t}$å±äºç¬¬cä¸ªåŠ¨ä½œçš„æ¦‚ç‡ï¼Œå¯ä»¥ç”¨é“¾å¼æ³•åˆ™ï¼ˆæ¡ä»¶æ¦‚ç‡å…¬å¼ï¼‰å°†å…¶åˆ†è§£ä¸ºä¸¤éƒ¨åˆ†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202155527868.png" alt="image-20211202155527868"></p>
<p>å›æƒ³èµ·æ¡ä»¶æ¦‚ç‡å…¬å¼æ”¯é…çš„ææƒ§äº†</p>
<script type="math/tex; mode=display">
P(A|B)=P(A,B)/P(B)</script><p>æ‰€ä»¥æœ‰</p>
<script type="math/tex; mode=display">
P(A,B)=P(A|B)P(B)</script><p>å½“ç„¶å†æ¨ä¸‹å»å°±æ˜¯è´å¶æ–¯äº†ï¼Œè¿™ä¸ªå°±ä¸ç»†è¯´ã€‚</p>
<h4 id="Uncertainty-formulation"><a href="#Uncertainty-formulation" class="headerlink" title="Uncertainty formulation"></a>Uncertainty formulation</h4><p>å…¬å¼å½“ä¸­$P(y<em>{n,t}=c|d=1, \tilde{s}</em>{n,t})$ï¼Œä¸ä¸€èˆ¬åˆ†ç±»ä»»åŠ¡ä¸€æ ·ï¼Œé‡‡ç”¨softmaxå‡½æ•°è¿›è¡Œä¼°è®¡ã€‚æ­¤å¤–ï¼Œæœ‰å¿…è¦å»ºæ¨¡ä¸€ä¸ªç‰‡æ®µå±äºä»»ä½•åŠ¨ä½œç±»çš„æ¦‚ç‡ï¼Œä¹Ÿå°±æ˜¯$P(d=1| \tilde{s}_{n,t})$çš„æ¦‚ç‡ã€‚</p>
<p>ä¸ºäº†è§£å†³èƒŒæ™¯è¾¨åˆ«é—®é¢˜ã€‚è§‚å¯Ÿåˆ°åŠ¨ä½œå¸§çš„ç‰¹å¾é€šå¸¸æ¯”èƒŒæ™¯å¸§çš„ç‰¹å¾æœ‰æ›´å¤§çš„å¹…åº¦(å›¾2)ï¼Œæˆ‘ä»¬é€šè¿‡ä½¿ç”¨ç‰¹å¾å‘é‡çš„å¹…åº¦æ¥è¡¨è¾¾ä¸ç¡®å®šæ€§ã€‚å…·ä½“æ¥è¯´ï¼ŒèƒŒæ™¯ç‰¹å¾çš„å¹…åº¦è¾ƒå°ï¼Œæ¥è¿‘äº0ï¼Œè€ŒåŠ¨ä½œç‰¹å¾çš„å¹…åº¦è¾ƒå¤§ã€‚</p>
<p>ç„¶ååœ¨nä¸ªè§†é¢‘$( \tilde{s}_{n,t})$ä¸­çš„t-thæ®µæ˜¯ä¸€ä¸ªåŠ¨ä½œæ®µçš„æ¦‚ç‡ç”±:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202161510271.png" alt="image-20211202161510271"></p>
<p>å…¶ä¸­$f<em>{n,t}$è¡¨ç¤ºè§†é¢‘$\tilde{s}</em>{n,t}$çš„ç‰¹å¾ï¼Œè€Œ$\lVert \cdot \rVert$æ˜¯ä¸€ä¸ªèŒƒæ•°å‡½æ•°(è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨L-2èŒƒæ•°)ï¼Œmæ˜¯é¢„å®šä¹‰çš„ä¸€ä¸ªç‰¹å¾å€¼ï¼Œä»å…¬å¼æˆ‘ä»¬å¯ä»¥å¾—åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202161833408.png" alt="image-20211202161833408"></p>
<h4 id="Uncertainty-learning-via-multiple-instance-learning"><a href="#Uncertainty-learning-via-multiple-instance-learning" class="headerlink" title="Uncertainty learning via multiple instance learning"></a>Uncertainty learning via multiple instance learning</h4><p>ä¸ºäº†åªé€šè¿‡è§†é¢‘çº§åˆ«çš„æ ‡ç­¾æ¥å­¦ä¹ ä¸ç¡®å®šæ€§ï¼Œæˆ‘ä»¬å€Ÿç”¨äº†å¤šå®ä¾‹å­¦ä¹ çš„æ¦‚å¿µ(Maronå’ŒLozanoPÃ©rez1998)ï¼Œå³ä½¿ç”¨ä¸€ä¸ªåŒ…(è§†é¢‘)è€Œä¸æ˜¯å®ä¾‹(ç‰‡æ®µ)æ¥è®­ç»ƒæ¨¡å‹ã€‚åœ¨è¿™ä¸ªè®¾ç½®ä¸­ï¼Œè€ƒè™‘åˆ°æ¯ä¸ªæœªä¿®å‰ªçš„è§†é¢‘éƒ½åŒ…å«åŠ¨ä½œå¸§å’ŒèƒŒæ™¯å¸§ï¼Œæˆ‘ä»¬é€‰æ‹©ä¼ªåŠ¨ä½œ/èƒŒæ™¯æ®µæ¥è¡¨ç¤ºè§†é¢‘ã€‚ç®€å•æ¥è¯´å°±æ˜¯é€‰æ‹©$k^{act}$ä¸ªç‰¹å¾å¹…åº¦æœ€å¤§çš„kä¸ªç‰‡æ®µä½œä¸ºä¼ªåŠ¨ä½œç‰‡æ®µ$\lbrace \tilde{s}<em>{n,t} |i\in S^{act} \rbrace$ï¼Œé€‰æ‹©$k^{bkg}$ä¸ªç‰‡æ®µä½œä¸ºä¼ªèƒŒæ™¯ç‰‡æ®µ$\lbrace \tilde{s}</em>{n,t} |j\in S^{bkg} \rbrace$ã€‚</p>
<h3 id="Training-objectives"><a href="#Training-objectives" class="headerlink" title="Training objectives"></a>Training objectives</h3><p>è®­ç»ƒçš„æŸå¤±æ€»å…±æœ‰ä¸‰ä¸ª</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202163725110.png" alt="image-20211202163725110"></p>
<h4 id="Video-level-classification-loss"><a href="#Video-level-classification-loss" class="headerlink" title="Video-level classification loss"></a>Video-level classification loss</h4><p>å¯¹äºå¤šæ ‡ç­¾åŠ¨ä½œåˆ†ç±»ï¼Œæˆ‘ä»¬ä½¿ç”¨äºŒå‰ç†µæŸå¤±ä¸æ ‡å‡†åŒ–è§†é¢‘çº§æ ‡ç­¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202163806830.png" alt="image-20211202163806830"></p>
<p>å¾ˆç®€å•çš„ä¸€ä¸ªæŸå¤±æ¯”è¾ƒå¸¸è§</p>
<h4 id="Uncertainty-modeling-loss"><a href="#Uncertainty-modeling-loss" class="headerlink" title="Uncertainty modeling loss"></a>Uncertainty modeling loss</h4><p>ä¸ºäº†å­¦ä¹ ä¸ç¡®å®šæ€§ï¼Œæˆ‘ä»¬è®­ç»ƒæ¨¡å‹ç”Ÿæˆå¤§ç‰¹å¾é‡çš„ä¼ªåŠ¨ä½œç‰‡æ®µï¼Œè€Œç”Ÿæˆå°ç‰¹å¾é‡çš„ä¼ªèƒŒæ™¯ç‰‡æ®µï¼Œå¦‚å›¾3(a)æ‰€ç¤ºã€‚å½¢å¼ä¸Šï¼Œä¸ç¡®å®šæ€§å»ºæ¨¡æŸå¤±çš„å½¢å¼ä¸º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164237878.png" alt="image-20211202164237878"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164312359.png" alt="image-20211202164312359"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164646695.png" alt="image-20211202164646695"></p>
<p>è¿™ä¸ªæŸå¤±çš„å«ä¹‰æ˜¯å°†åŠ¨ä½œç‰¹å¾æ‹‰çš„æ›´è¿œèƒŒæ™¯ç‰¹å¾æ‹‰çš„æ›´è¿‘ï¼Œå¯ä»¥çœ‹è¿™ä¸ªmä¸ºç‰¹å¾è·ç¦»ï¼Œè“è‰²éƒ¨åˆ†å‘mä¹‹å¤–ç§»åŠ¨ï¼Œçº¢è‰²éƒ¨åˆ†å‘mä¹‹å†…ç§»åŠ¨ã€‚</p>
<h4 id="Background-entropy-loss"><a href="#Background-entropy-loss" class="headerlink" title="Background entropy loss"></a>Background entropy loss</h4><p>è™½ç„¶ä¸ç¡®å®šæ€§å»ºæ¨¡æŸå¤±é¼“åŠ±èƒŒæ™¯éƒ¨åˆ†ä¸ºæ‰€æœ‰åŠ¨ä½œç”Ÿæˆä½å¯¹æ•°ï¼Œä½†ç”±äºsoftmaxåŠŸèƒ½çš„ç›¸å¯¹æ€§ï¼ŒæŸäº›åŠ¨ä½œç±»çš„softmaxå¾—åˆ†å¯èƒ½è¾ƒé«˜ã€‚ä¸ºäº†é˜²æ­¢èƒŒæ™¯ç‰‡æ®µå¯¹ä»»ä½•åŠ¨ä½œç±»éƒ½æœ‰è¾ƒé«˜çš„softmaxå¾—åˆ†ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªæŸå¤±å‡½æ•°ï¼Œä½¿èƒŒæ™¯ç‰‡æ®µçš„åŠ¨ä½œæ¦‚ç‡ç†µæœ€å¤§åŒ–ï¼Œå³ï¼ŒèƒŒæ™¯æ®µå¯¹åŠ¨ä½œç±»å¼ºåˆ¶å…·æœ‰å‡åŒ€æ¦‚ç‡åˆ†å¸ƒï¼Œå¦‚å›¾3(b)æ‰€ç¤ºã€‚æŸå¤±è®¡ç®—æ–¹æ³•å¦‚ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164356143.png" alt="image-20211202164356143"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164432247.png" alt="image-20211202164432247"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20211202164712103.png" alt="image-20211202164712103"></p>
<p>è¿™ä¸ªæŸå¤±æ˜¯ä¸ºäº†é˜²æ­¢èƒŒæ™¯åœ¨æŸä¸ªåŠ¨ä½œç±»ä¸Šçš„softmaxå¾—åˆ†å¯èƒ½è¾ƒé«˜ï¼Œä¸ºäº†å°†èƒŒæ™¯åˆ†æ•°æ‹‰å¹³è€Œè®¾è®¡çš„ä¸€ä¸ªå‡½æ•°ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« åœ¨å‰äººæå‡ºèƒŒæ™¯çš„åŸºç¡€ä¸Šå†æ¬¡åŠ æ·±äº†ä¸€æ­¥ç ”ç©¶ï¼Œæ€æƒ³æ€§å¾ˆå¼ºä¸äºæ˜¯å¾®è½¯äºšæ´²ç ”ç©¶é™¢å‡ºå“çš„ï¼Œæˆ‘åªèƒ½ç§°ä¹‹ä¸ºç¥ä»™ã€‚</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>å¼±ç›‘ç£</tag>
      </tags>
  </entry>
  <entry>
    <title>selectå°ä¾‹å­</title>
    <url>/2022/07/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/select%E5%B0%8F%E4%BE%8B%E5%AD%90/</url>
    <content><![CDATA[<h1 id="selectå°ä¾‹å­"><a href="#selectå°ä¾‹å­" class="headerlink" title="selectå°ä¾‹å­"></a>selectå°ä¾‹å­</h1><p>ç¼–å†™äº†ä¸€ä¸ªå®¢æˆ·ç«¯å‘å­—æ¯è¿‡æ¥ï¼Œç„¶åæœåŠ¡å™¨æŠŠå­—æ¯è½¬æˆå¤§å†™å‘é€å›å»çš„ä¾‹å­ï¼Œå…¶ä¸­ä½¿ç”¨äº†selectã€‚</p>
<span id="more"></span>
<h2 id="å®¢æˆ·ç«¯ä»£ç "><a href="#å®¢æˆ·ç«¯ä»£ç " class="headerlink" title="å®¢æˆ·ç«¯ä»£ç "></a>å®¢æˆ·ç«¯ä»£ç </h2><p>å®¢æˆ·ç«¯ä»£ç æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯è¿æ¥æœåŠ¡å™¨ï¼Œç„¶åå‘é€åˆ°æœåŠ¡å™¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid port,please check out port&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> client_sockfd;</span><br><span class="line">    <span class="type">int</span> len,n;    </span><br><span class="line">    <span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span> <span class="comment">//æœåŠ¡å™¨ç«¯ç½‘ç»œåœ°å€ç»“æ„ä½“</span></span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    client_sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//å»ºç«‹å®¢æˆ·ç«¯socket</span></span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    address.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    len = <span class="keyword">sizeof</span>(address);</span><br><span class="line">    <span class="comment">//è¿›è¡Œé“¾æ¥</span></span><br><span class="line">    result = connect(client_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;address, len);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error_handling(<span class="string">&quot;connect error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;------------connect ok----------------\n&quot;</span>);</span><br><span class="line">    <span class="comment">//ä»å±å¹•ï¼ˆæ ‡å‡†è¾“å…¥ï¼‰å¾—åˆ°è¾“å…¥å­—æ¯</span></span><br><span class="line">    <span class="keyword">while</span> (fgets(buf, BUF_SIZE, <span class="built_in">stdin</span>) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        write(client_sockfd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">        n = read(client_sockfd, buf, BUF_SIZE);</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;the other side has been closed.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            write(STDOUT_FILENO, buf, n);</span><br><span class="line">    &#125;</span><br><span class="line">    close(client_sockfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">&#x27;\n&#x27;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æœåŠ¡å™¨ä»£ç "><a href="#æœåŠ¡å™¨ä»£ç " class="headerlink" title="æœåŠ¡å™¨ä»£ç "></a>æœåŠ¡å™¨ä»£ç </h2><p>æœåŠ¡å™¨ç«¯ä»£ç ç•¥å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯åªè¦å¼„æ¸…selectå‡½æ•°çš„å‚æ•°ä»¥åŠç›¸å…³çš„å‚æ•°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> maxfdp, fd_set *readset, fd_set *writeset, fd_set *exceptset,<span class="keyword">struct</span> timeval *timeout)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å‚æ•°è¯´æ˜ï¼š</p>
<p>maxfdpï¼šè¢«ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦çš„æ€»æ•°ï¼Œå®ƒæ¯”æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­çš„æ–‡ä»¶æè¿°ç¬¦çš„æœ€å¤§å€¼å¤§1ï¼Œå› ä¸ºæ–‡ä»¶æè¿°ç¬¦æ˜¯ä»0å¼€å§‹è®¡æ•°çš„ã€‚</p>
<p>readfdsã€writefdsã€exceptsetï¼šåˆ†åˆ«æŒ‡å‘å¯è¯»ã€å¯å†™å’Œå¼‚å¸¸ç­‰äº‹ä»¶å¯¹åº”çš„æè¿°ç¬¦é›†åˆï¼Œè¿™ä¸‰ä¸ªå‚æ•°éƒ½æ˜¯ä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œéƒ½ä¼šä½œä¸ºç»“æœä¼ å‡ºã€‚</p>
<p>timeout:ç”¨äºè®¾ç½®selectå‡½æ•°çš„è¶…æ—¶æ—¶é—´ï¼Œå³å‘Šè¯‰å†…æ ¸selectç­‰å¾…å¤šé•¿æ—¶é—´ä¹‹åå°±æ”¾å¼ƒç­‰å¾…ã€‚timeout == NULL è¡¨ç¤ºç­‰å¾…æ— é™é•¿çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯é˜»å¡ã€‚</p>
<p>timevalç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span></span></span><br><span class="line"><span class="class">&#123;</span>      </span><br><span class="line">    <span class="type">long</span> tv_sec;   <span class="comment">/*ç§’ */</span></span><br><span class="line">    <span class="type">long</span> tv_usec;  <span class="comment">/*å¾®ç§’ */</span>   </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿”å›å€¼ï¼šè¶…æ—¶è¿”å›0;å¤±è´¥è¿”å›-1ï¼›æˆåŠŸè¿”å›å¤§äº0çš„æ•´æ•°ï¼Œè¿™ä¸ªæ•´æ•°è¡¨ç¤ºå°±ç»ªæè¿°ç¬¦çš„æ•°ç›®ã€‚</p>
<p>ä»¥ä¸‹ä»‹ç»ä¸selectå‡½æ•°ç›¸å…³çš„å¸¸è§çš„å‡ ä¸ªå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span>   </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_ZERO</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>;   <span class="comment">//ä¸€ä¸ª fd_setç±»å‹å˜é‡çš„æ‰€æœ‰ä½éƒ½è®¾ä¸º 0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>;  <span class="comment">//æ¸…é™¤æŸä¸ªä½æ—¶å¯ä»¥ä½¿ç”¨</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *fd_set)</span>;   <span class="comment">//è®¾ç½®å˜é‡çš„æŸä¸ªä½ç½®ä½</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *fdset)</span>; <span class="comment">//æµ‹è¯•æŸä¸ªä½æ˜¯å¦è¢«ç½®ä½</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æœåŠ¡å™¨ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid port,please check out port&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> server_sockfd, client_sockfd;</span><br><span class="line">    <span class="type">int</span> server_len, client_len;</span><br><span class="line">    <span class="type">int</span> fd_max, n;</span><br><span class="line">    <span class="type">char</span> buf[BUF_SIZE], str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="comment">// cä¸­ç»“æ„ä½“ä½¿ç”¨ï¼Œå¿…é¡»åŠ struct</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_address</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_address</span>;</span></span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    fd_set readfds, tempfds;</span><br><span class="line">    <span class="comment">//åˆ›å»º æœåŠ¡å™¨ç«¯ socket</span></span><br><span class="line">    server_sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">//å‡†å¤‡åœ°å€</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;server_address, <span class="number">0</span>, <span class="keyword">sizeof</span>(server_address));</span><br><span class="line">    server_address.sin_family = AF_INET;</span><br><span class="line">    server_address.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    server_address.sin_port = htons(atoi(argv[<span class="number">1</span>]));</span><br><span class="line">    server_len = <span class="keyword">sizeof</span>(server_address);</span><br><span class="line">    <span class="comment">//è®¾ç½®ç»‘å®šå’Œç›‘å¬</span></span><br><span class="line">    <span class="keyword">if</span> (bind(server_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_address, server_len) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error_handling(<span class="string">&quot;bind error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (listen(server_sockfd, <span class="number">128</span>) == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        error_handling(<span class="string">&quot;listen error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;server waiting\n&quot;</span>);</span><br><span class="line">    FD_ZERO(&amp;readfds);</span><br><span class="line">    FD_SET(server_sockfd, &amp;readfds); <span class="comment">//å°†æœåŠ¡å™¨ç«¯socket ç›‘å¬æè¿°ç¬¦åŠ å…¥åˆ°é›†åˆä¸­</span></span><br><span class="line">    fd_max = server_sockfd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>;</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//å°†éœ€è¦ç›‘å¬çš„æè¿°ç¬¦å¤åˆ¶ç»™ tempfds</span></span><br><span class="line">        tempfds = readfds;</span><br><span class="line">        <span class="comment">// selectç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œæ‰€ä»¥å¼€å§‹æ‰éœ€è¦å¤åˆ¶</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æƒ…å†µ1.è®¾ç½®timeoutçš„ç­‰å¾…æ—¶é—´</span></span><br><span class="line">        timeout.tv_sec = <span class="number">3</span>;</span><br><span class="line">        timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// (fd_set)*0 å’Œ NULL ç”¨æ³•ç›¸åŒ</span></span><br><span class="line">        <span class="comment">// result = select(fd_max + 1, &amp;tempfds, NULL, NULL, &amp;timeout);</span></span><br><span class="line">        <span class="comment">// result = select(fd_max + 1, &amp;tempfds, (fd_set *)0, (fd_set *)0, &amp;timeout);</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//æƒ…å†µ2.è®¾ç½®select é˜»å¡çš„æƒ…å†µ</span></span><br><span class="line">        result = select(fd_max + <span class="number">1</span>, &amp;tempfds, (fd_set *)<span class="number">0</span>, (fd_set *)<span class="number">0</span>, (<span class="keyword">struct</span> timeval *)<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-------next--------\n&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            error_handling(<span class="string">&quot;select error&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> fd = <span class="number">0</span>; fd &lt; fd_max + <span class="number">1</span>; fd++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//å¯»æ‰¾åˆ°ç›¸å…³æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(fd, &amp;tempfds))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯ç›‘å¬æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">                <span class="keyword">if</span> (fd == server_sockfd)</span><br><span class="line">                &#123;</span><br><span class="line">                    client_len = <span class="keyword">sizeof</span>(client_address);</span><br><span class="line">                    client_sockfd = accept(server_sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;client_address, &amp;client_len);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;received from %s at PORT %d on fd %d\n&quot;</span>, inet_ntop(AF_INET, &amp;client_address.sin_addr, str, <span class="keyword">sizeof</span>(str)),</span><br><span class="line">                           ntohs(client_address.sin_port), client_sockfd);</span><br><span class="line">                    <span class="comment">//æ–°çš„æ–‡ä»¶æè¿°ç¬¦åŠ å…¥è¯»ä¸­</span></span><br><span class="line">                    FD_SET(client_sockfd, &amp;readfds);</span><br><span class="line">                    <span class="keyword">if</span> (fd_max &lt; client_sockfd)</span><br><span class="line">                        fd_max = client_sockfd;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//è¯´æ˜æ˜¯è¯»æè¿°æ•°</span></span><br><span class="line">                    <span class="keyword">if</span> ((n = read(fd, buf, <span class="keyword">sizeof</span>(buf))) == <span class="number">0</span>)</span><br><span class="line">                    &#123; <span class="comment">/* å½“clientå…³é—­é“¾æ¥æ—¶,æœåŠ¡å™¨ç«¯ä¹Ÿå…³é—­å¯¹åº”é“¾æ¥ */</span></span><br><span class="line">                        close(fd);</span><br><span class="line">                        FD_CLR(fd, &amp;readfds); <span class="comment">/* è§£é™¤selectå¯¹æ­¤æ–‡ä»¶æè¿°ç¬¦çš„ç›‘æ§ */</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; n; j++)</span><br><span class="line">                            buf[j] = <span class="built_in">toupper</span>(buf[j]);</span><br><span class="line">                        write(fd, buf, n);</span><br><span class="line">                        write(STDOUT_FILENO, buf, n);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    close(server_sockfd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------server finish!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_handling</span><span class="params">(<span class="type">char</span> *message)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fputs</span>(message, <span class="built_in">stderr</span>);</span><br><span class="line">    fputc(<span class="string">&#x27;\n&#x27;</span>, <span class="built_in">stderr</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h2><h3 id="æƒ…å†µ1"><a href="#æƒ…å†µ1" class="headerlink" title="æƒ…å†µ1"></a>æƒ…å†µ1</h3><p>æˆ‘ä»¬å…ˆè¿è¡Œæƒ…å†µ1ï¼Œè®¾ç½®ç­‰å¾…æ—¶é—´ä¸º3ç§’ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// æƒ…å†µ1.è®¾ç½®timeoutçš„ç­‰å¾…æ—¶é—´</span></span><br><span class="line">timeout.tv_sec = <span class="number">3</span>;</span><br><span class="line">timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// (fd_set)*0 å’Œ NULL ç”¨æ³•ç›¸åŒ</span></span><br><span class="line">result = select(fd_max + <span class="number">1</span>, &amp;tempfds, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout);</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä»–ç­‰å¾…3ç§’åå°±å‘ä¸‹ç»§ç»­è¿è¡Œäº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/selectæƒ…å†µ1.gif" alt="selectæƒ…å†µ1"></p>
<p>è¿è¡Œç»“æœæ˜¾ç¤ºæ¯3ç§’è¿›è¡Œä¸€æ¬¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220715110925008.png" alt="image-20220715110925008"></p>
<h3 id="æƒ…å†µ2"><a href="#æƒ…å†µ2" class="headerlink" title="æƒ…å†µ2"></a>æƒ…å†µ2</h3><p>æˆ‘ä»¬è®¾ç½®é˜»å¡ç­‰å¾…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">result = select(fd_max + <span class="number">1</span>, &amp;tempfds, (fd_set *)<span class="number">0</span>, (fd_set *)<span class="number">0</span>, (<span class="keyword">struct</span> timeval *)<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœæ˜¾ç¤ºï¼Œæ¯æ¬¡éƒ½æ˜¯é˜»å¡åœ¨é‚£é‡Œï¼ŒçŸ¥é“æœ‰å†™æè¿°ç¬¦é›†çš„ä½¿ç”¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220715111515047.png" alt="image-20220715111515047"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>selectçš„ä½¿ç”¨çš„å°ä¾‹å­æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ·±å…¥åŸç†ç›®å‰æˆ‘è¿˜æœªäº†è§£ï¼Œå…ˆå†™ä¸ªå°ä¾‹å­è®°å½•ä¸€ä¸‹ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://blog.csdn.net/hyman_c/article/details/52801947">https://blog.csdn.net/hyman_c/article/details/52801947</a></li>
<li><a href="https://blog.csdn.net/hyman_c/article/details/53991111">https://blog.csdn.net/hyman_c/article/details/53991111</a></li>
<li><a href="https://docs.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-select">https://docs.microsoft.com/zh-cn/windows/win32/api/winsock2/nf-winsock2-select</a></li>
<li><a href="https://www.cnblogs.com/alantu2018/p/8612722.html">https://www.cnblogs.com/alantu2018/p/8612722.html</a></li>
<li><a href="https://www.cnblogs.com/skyfsm/p/7079458.html">https://www.cnblogs.com/skyfsm/p/7079458.html</a></li>
</ul>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
        <tag>select</tag>
      </tags>
  </entry>
  <entry>
    <title>socketåœ°å€ä¿¡æ¯å‡½æ•°</title>
    <url>/2022/08/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/socket%E5%9C%B0%E5%9D%80%E4%BF%A1%E6%81%AF%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="socketåœ°å€ä¿¡æ¯å‡½æ•°"><a href="#socketåœ°å€ä¿¡æ¯å‡½æ•°" class="headerlink" title="socketåœ°å€ä¿¡æ¯å‡½æ•°"></a>socketåœ°å€ä¿¡æ¯å‡½æ•°</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­socketåœ°å€ä¿¡æ¯å‡½æ•°ã€‚</p>
<span id="more"></span>
<p>å¦‚æœæˆ‘ä»¬è¦æŸ¥è¯¢ä¸€ä¸ªè¿æ¥socketçš„æœ¬ç«¯socketåœ°å€ï¼Œä»¥åŠè¿œç«¯çš„socketåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getsockname</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">getpeername</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>getsockname</code>è·å¾—<code>sockfd</code>å¯¹åº”çš„æœ¬ç«¯åœ°å€ï¼ˆæœ¬åœ°è‡ªå·±çš„åœ°å€ï¼‰ï¼Œ<code>getpeername</code>è·å¾—<code>sockfd</code>å¯¹åº”çš„è¿œç«¯åœ°å€ï¼ˆè¿œç«¯è¿æ¥çš„åœ°å€ï¼‰ã€‚ä¸¤ä¸ªå‡½æ•°éƒ½æŠŠåœ°å€å­˜å‚¨åœ¨<code>addr</code>å‚æ•°æŒ‡å®šçš„å†…å­˜ä¸­ï¼Œå°†è¯¥åœ°å€çš„é•¿åº¦å­˜æ”¾åœ¨<code>addrlen</code>å½“ä¸­ã€‚</p>
<p>å¦‚æœå®é™…socketåœ°å€çš„é•¿åº¦å¤§äº<code>addr</code>æ‰€æŒ‡å†…å­˜åŒºçš„å¤§å°ï¼Œé‚£ä¹ˆè¯¥socketåœ°å€å°†è¢«æˆªæ–­ã€‚ä¸¤ä¸ªå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æˆ‘å†™äº†ä»£ç æµ‹è¯•äº†ä¸€ä¸‹ï¼Œä½¿ç”¨telnetè¿›è¡Œè¿æ¥</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 256</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾—æœ¬ç«¯åœ°å€</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">        ret = getsockname(connfd, (sockaddr *)&amp;addr, &amp;addrlen);</span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getsockname info ip: %s and port: %d , addrlen is %d \n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;addr.sin_addr, remote, INET_ADDRSTRLEN), ntohs(addr.sin_port), addrlen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾—è¿œç«¯åœ°å€</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr2</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen2 = <span class="keyword">sizeof</span>(addr2);</span><br><span class="line">        ret = getpeername(connfd, (sockaddr *)&amp;addr2, &amp;addrlen2);</span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getpeername info ip: %s and port: %d , addrlen is %d \n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;addr2.sin_addr, remote, INET_ADDRSTRLEN), ntohs(addr2.sin_port), addrlen2);</span><br><span class="line"></span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813163338463.png" alt="image-20220813163338463"></p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>socketæ•°æ®è¯»å†™</title>
    <url>/2022/08/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/socket%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99/</url>
    <content><![CDATA[<h1 id="socketæ•°æ®è¯»å†™"><a href="#socketæ•°æ®è¯»å†™" class="headerlink" title="socketæ•°æ®è¯»å†™"></a>socketæ•°æ®è¯»å†™</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­socketæ•°æ®è¯»å†™çš„éƒ¨åˆ†ï¼ŒåŒ…æ‹¬TCPæ•°æ®è¯»å†™ã€UDPæ•°æ®è¯»å†™å’Œé€šç”¨æ•°æ®è¯»å†™ã€‚</p>
<span id="more"></span>
<h2 id="TCPæ•°æ®è¯»å†™"><a href="#TCPæ•°æ®è¯»å†™" class="headerlink" title="TCPæ•°æ®è¯»å†™"></a>TCPæ•°æ®è¯»å†™</h2><p>å¯¹æ–‡ä»¶çš„è¯»å†™æ“ä½œ<code>read</code>å’Œ<code>write</code>åŒæ ·é€‚ç”¨äºsocketã€‚ä½†æ˜¯socketç¼–ç¨‹æ¥å£æä¾›äº†å‡ ä¸ªä¸“é—¨ç”¨äºsocketæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬å¢åŠ äº†å¯¹æ•°æ®çš„è¯»å†™çš„æ§åˆ¶ã€‚åœ¨TCPä¸­æµæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recv</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">send</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>recv</code>è¯»å–<code>sockfd</code>ä¸Šçš„æ•°æ®ï¼Œ<code>buf</code>å’Œ<code>len</code>å‚æ•°åˆ†åˆ«æŒ‡å®šè¯»ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚</p>
<p><code>recv</code>æˆåŠŸè¯»å–æ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®é•¿åº¦ï¼Œå®ƒå¯èƒ½å°äºæˆ‘ä»¬æœŸæœ›çš„é•¿åº¦<code>len</code>ã€‚å› æ­¤éœ€è¦å¤šæ¬¡è°ƒç”¨<code>recv</code>æ‰èƒ½è¯»å–åˆ°å®Œæ•´çš„æ•°æ®ã€‚<code>recv</code>è¿”å›0ï¼Œæ„å‘³ç€å¯¹æ–¹å·²ç»å…³é—­è¿æ¥ã€‚<code>recv</code>å‡ºé”™æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>send</code>å‘é€<code>sockfd</code>ä¸Šçš„æ•°æ®ã€‚<code>buf</code>å’Œ<code>len</code>å‚æ•°åˆ†åˆ«æŒ‡å®šå†™ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚</p>
<p><code>send</code>æˆåŠŸè¯»å–æ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®é•¿åº¦ï¼Œå‡ºé”™æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>flags</code>ç”¨äºæ§åˆ¶æ•°æ®çš„æ¥æ”¶å’Œå‘é€ï¼Œä¸€èˆ¬æ¥è¯´è®¾ç½®ä¸º0ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè®¾ç½®ï¼Œä»è€Œè¿›è¡Œæ§åˆ¶ã€‚</p>
<p>æ§åˆ¶å‚æ•°å¯ä»¥é€šè¿‡manæ‰‹å†Œè¿›è¡ŒæŸ¥çœ‹ï¼Œè¿™é‡Œç›´æ¥æˆªå–ä¹¦ä¸Šçš„è¡¨æ ¼</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812171929139.png" alt="image-20220812171929139"></p>
<h2 id="UDPæ•°æ®è¯»å†™"><a href="#UDPæ•°æ®è¯»å†™" class="headerlink" title="UDPæ•°æ®è¯»å†™"></a>UDPæ•°æ®è¯»å†™</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr *src_addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendto</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *dest_addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹UDPç³»ç»Ÿæä¾›çš„æ˜¯è¯»å†™å‡½æ•°æ˜¯<code>recvfrom</code>å’Œ<code>sendto</code>ï¼Œå…¶ä¸­å‡½æ•°<code>recvfrom</code>å’Œ<code>sendto</code>å‰4ä¸ªå‚æ•°å’Œ<code>recv</code>ã€<code>send</code>æ„ä¹‰ç›¸åŒï¼Œæœ€åä¸¤ä¸ªæ˜¯å‘é€ç«¯/æ¥æ”¶ç«¯çš„åœ°å€ã€‚å› ä¸ºUDPæ˜¯æ²¡æœ‰è¿æ¥çš„æ¦‚å¿µï¼Œæ‰€ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æ—¶å€™éƒ½è¦æŒ‡å®šåœ°å€ã€‚<code>recvfrom</code>å’Œ<code>sendto</code>çš„è¿”å›å€¼å’Œ<code>recv</code>ã€<code>send</code>ä¹Ÿç›¸åŒï¼Œæ‰€ä»¥ä¸ç”¨è¿‡å¤šä»‹ç»ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>recvfrom</code>å’Œ<code>sendto</code>ä¹Ÿå¯ä»¥ç”¨äºTCPä½¿ç”¨ï¼Œåªéœ€è¦æŠŠæœ€åä¸¤ä¸ªå‚æ•°è®¾ç½®ä¸ºNULLå³å¯ã€‚</p>
<h2 id="é€šç”¨æ•°æ®è¯»å†™å‡½æ•°"><a href="#é€šç”¨æ•°æ®è¯»å†™å‡½æ•°" class="headerlink" title="é€šç”¨æ•°æ®è¯»å†™å‡½æ•°"></a>é€šç”¨æ•°æ®è¯»å†™å‡½æ•°</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvmsg</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> msghdr *msg, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendmsg</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> msghdr *msg, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>recvmsg</code>å’Œ<code>sendmsg</code>çš„å‚æ•°ä¸­<code>sockfd</code>å’Œ<code>flags</code>æ¯”è¾ƒç®€å•ï¼Œå¤æ‚ä¸€äº›çš„å‚æ•°å°±æ˜¯<code>msg</code>ã€‚<code>msg</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> &#123;</span>                    <span class="comment">/* Scatter/gather array items */</span></span><br><span class="line">   <span class="type">void</span>  *iov_base;              <span class="comment">/* Starting address */</span></span><br><span class="line">   <span class="type">size_t</span> iov_len;               <span class="comment">/* Number of bytes to transfer */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> &#123;</span></span><br><span class="line">   <span class="type">void</span>         *msg_name;       <span class="comment">/* Optional address */</span></span><br><span class="line">   <span class="type">socklen_t</span>     msg_namelen;    <span class="comment">/* Size of address */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>        <span class="comment">/* Scatter/gather array */</span></span><br><span class="line">   <span class="type">size_t</span>        msg_iovlen;     <span class="comment">/* # elements in msg_iov */</span></span><br><span class="line">   <span class="type">void</span>         *msg_control;    <span class="comment">/* Ancillary data, see below */</span></span><br><span class="line">   <span class="type">size_t</span>        msg_controllen; <span class="comment">/* Ancillary data buffer len */</span></span><br><span class="line">   <span class="type">int</span>           msg_flags;      <span class="comment">/* Flags on received message */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>msg_name</code>æŒ‡å‘socketåœ°å€ï¼Œå¯¹äºTCPåè®®æ— æ„ä¹‰ï¼Œæ‰€ä»¥åœ¨TCPåè®®ä¸­è®¾ç½®ä¸ºNULLï¼Œè€Œå¯¹äºUDPç­‰å…¶ä»–åè®®å°±è¯´æ˜äº†å‘é€æˆ–è€…æ¥æ”¶çš„åœ°å€ã€‚<code>msg_namelen</code>æŒ‡å®šsocketåœ°å€çš„é•¿åº¦ã€‚</p>
<p><code>msg_iov</code>æ˜¯<code>iovec</code>ç±»å‹çš„æŒ‡é’ˆï¼Œæ ¹æ®æ³¨é‡Šæ¥åˆ¤æ–­åº”è¯¥æ˜¯ä¸ªæ•°ç»„ã€‚<code>iovec</code>ç»“æ„ä½“å°è£…äº†ä¸€å—å†…å­˜çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚<code>msg_iovlen</code>æŒ‡å®šè¿™æ ·çš„<code>iovec</code>ç»“æ„å¯¹è±¡æœ‰å¤šå°‘ä¸ªã€‚</p>
<p>å¯¹äº<code>recvmsg</code>è€Œè¨€ï¼Œæ•°æ®å°†è¢«è¯»å–å¹¶å­˜æ”¾åœ¨<code>msg_iovlen</code>å—åˆ†æ•£çš„å†…å­˜ä¸­ï¼Œè¿™äº›å†…å­˜çš„ä½ç½®å’Œé•¿åº¦åˆ™ç”±<code>msg_iov</code>æŒ‡å‘çš„æ•°ç»„æŒ‡å®šï¼Œè¿™ç§°ä¸ºåˆ†æ•£è¯»( scatter read);å¯¹äº<code>sendmsg</code>è€Œè¨€ï¼Œ<code>msg_iovlen</code>å—åˆ†æ•£å†…å­˜ä¸­çš„æ•°æ®å°†è¢«ä¸€å¹¶å‘é€ï¼Œè¿™ç§°ä¸ºé›†ä¸­å†™( gather write)ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦æœ‰åˆ†æ•£è¯»å’Œé›†ä¸­å†™å‘¢ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ä½¿ç”¨ï¼Œæ–¹ä¾¿ä¼ è¾“ç»“æ„ä¸åŒçš„æ•°æ®ã€‚æ¯”å¦‚ï¼šå‘é€httpåº”ç­”æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‰é¢çš„<strong>è¯·æ±‚å¤´</strong>å’Œ<strong>è¯·æ±‚çš„æ–‡ä»¶</strong>åˆ†ä¸ºä¸¤ä¸ªbufferï¼Œä½†æ˜¯æœ€ç»ˆä¸€èµ·è¿›è¡Œå†™å…¥ï¼Œå‡å°‘äº†æ‹¼æ¥å¸¦æ¥çš„éº»çƒ¦ã€‚åŒç†æˆ‘æ¥æ”¶çš„æ—¶å€™ä¹Ÿæ˜¯æƒ³<strong>è¯·æ±‚å¤´</strong>å’Œ<strong>è¯·æ±‚çš„æ–‡ä»¶</strong>åˆ†å¼€ï¼Œæ‰€ä»¥ä½¿ç”¨åˆ†æ•£è¯»ã€‚</p>
<p><code>msg_flags</code>æˆå‘˜æ— é¡»è®¾å®šï¼Œå®ƒä¼šå¤åˆ¶<code>recvmsg/sendmsg</code>çš„<code>flags</code>å‚æ•°çš„å†…å®¹ä»¥å½±å“æ•°æ®è¯»å†™è¿‡ç¨‹ã€‚<code>recvmsg</code>è¿˜ä¼šåœ¨è°ƒç”¨ç»“æŸå‰ï¼Œå°†æŸäº›æ›´æ–°åçš„æ ‡å¿—è®¾ç½®åˆ°<code>msg_flags</code>ä¸­ã€‚</p>
<p><code>recvmsg/sendmsg</code>çš„ <code>flags</code>å‚æ•°ä»¥åŠè¿”å›å€¼çš„å«ä¹‰å‡ä¸<code>sendrecv</code>çš„ <code>flags</code>å‚æ•°åŠè¿”å›å€¼ç›¸åŒã€‚</p>
<p><code>msg_control</code>å’Œ <code>msg_controllen</code>æˆå‘˜ç”¨äºè¾…åŠ©æ•°æ®çš„ä¼ é€ã€‚ç›®å‰ä¹¦ä¸­å¹¶æœªè¿›è¡Œè®²è§£ï¼Œåç»­å†è¡¥å……ã€‚</p>
<p><code>recvmsg</code>å’Œ<code>sendmsg</code>çš„ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 256</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line">		</span><br><span class="line">        <span class="type">char</span> buffer1[<span class="number">6</span>];</span><br><span class="line">        <span class="type">char</span> buffer2[BUFFER_SIZE];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">        bzero(&amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="comment">//è®¾ç½®é›†ä¸­å†™</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_arry</span>[2];</span></span><br><span class="line">        iovec_arry[<span class="number">0</span>].iov_base = (<span class="type">void</span> *)buffer1;</span><br><span class="line">        iovec_arry[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(buffer1);</span><br><span class="line">        iovec_arry[<span class="number">1</span>].iov_base = (<span class="type">void</span> *)buffer2;</span><br><span class="line">        iovec_arry[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span>(buffer2);</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = iovec_arry;</span><br><span class="line">        msg.msg_iovlen = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> n = recvmsg(connfd, &amp;msg, <span class="number">0</span>);</span><br><span class="line">        assert(n != <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; have recv %d byte msg1 %s and msg2 %s \n&quot;</span>, n, buffer1, buffer2);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sendmsg</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = connect(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer1[] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buffer2[] = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    bzero(&amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯é’ˆå¯¹TCPï¼Œæ‰€ä»¥msg_nameæ— æ„ä¹‰</span></span><br><span class="line">    msg.msg_name = <span class="literal">NULL</span>;</span><br><span class="line">    msg.msg_namelen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®é›†ä¸­å†™</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_arry</span>[2];</span></span><br><span class="line">    iovec_arry[<span class="number">0</span>].iov_base = (<span class="type">void</span> *)buffer1;</span><br><span class="line">    iovec_arry[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(buffer1);</span><br><span class="line">    iovec_arry[<span class="number">1</span>].iov_base = (<span class="type">void</span> *)buffer2;</span><br><span class="line">    iovec_arry[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span>(buffer2);</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = iovec_arry;</span><br><span class="line">    msg.msg_iovlen = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n = sendmsg(sock, &amp;msg, <span class="number">0</span>);</span><br><span class="line">    assert(n != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; have send %d byte msg1 %s and msg2 %s \n&quot;</span>, n, buffer1, buffer2);</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813123219330.png" alt="image-20220813123219330"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>recvmsg</code>åªæœ‰åœ¨å‰é¢çš„bufferä½¿ç”¨å®Œä¹‹åï¼Œæ‰ä¼šä½¿ç”¨åé¢çš„bufferã€‚è¿™ä¹Ÿæ˜¯ä¸ºå•¥æŠŠ<code>buffer1</code>çš„å¤§å°è®¾ç½®ä¸º6</p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>socketç›¸å…³å‘½ä»¤</title>
    <url>/2022/08/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/socket%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<h1 id="socketç›¸å…³å‘½ä»¤"><a href="#socketç›¸å…³å‘½ä»¤" class="headerlink" title="socketç›¸å…³å‘½ä»¤"></a>socketç›¸å…³å‘½ä»¤</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­socketç›¸å…³çš„å‘½ä»¤ï¼ŒåŒ…æ‹¬åˆ›å»ºsocketã€å‘½åsocketã€ç›‘å¬socketã€æ¥å—è¿æ¥ã€å‘èµ·è¿æ¥å’Œå…³é—­è¿æ¥ã€‚</p>
<span id="more"></span>
<h2 id="åˆ›å»ºsocket"><a href="#åˆ›å»ºsocket" class="headerlink" title="åˆ›å»ºsocket"></a>åˆ›å»ºsocket</h2><p>socketä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å¯ä»¥åˆ›å»ºä¸€ä¸ªsocket</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br></pre></td></tr></table></figure>
<p><code>domain</code>å‚æ•°æ˜¯å‘Šè¯‰ç³»ç»Ÿä½¿ç”¨çš„æ˜¯é‚£ä¸ªåº•å±‚åè®®æ—ï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨IPv4ï¼Œæ‰€ä»¥ä½¿ç”¨<code>AF_INET</code>å³å¯ã€‚å…³äº<code>socket</code>ç³»ç»Ÿè°ƒç”¨æ”¯æŒçš„æ‰€æœ‰åè®®æ—ï¼Œå¯ä»¥æŸ¥çœ‹manæ‰‹å†Œï¼ˆè™½ç„¶å‚æ•°åä¸ä¸€æ ·ï¼Œä½†æ˜¯å¹¶æ— å¤§ç¢ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812095854483.png" alt="image-20220812095854483"></p>
<p><code>type</code>å‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ã€‚æœåŠ¡ç±»å‹ä¸»è¦æœ‰<code>SOCK_STREAM</code>æœåŠ¡ï¼ˆæµæœåŠ¡ï¼‰å’Œ<code>SOCK_UGRAM</code>ï¼ˆæ•°æ®æŠ¥ï¼‰æœåŠ¡ã€‚å¯¹TCP/IPåè®®æ—è€Œè¨€ï¼Œå…¶å€¼å–<code>SOCK_STREAM</code>è¡¨ç¤ºä¼ è¾“å±‚ä½¿ç”¨TCPåè®®ï¼Œå–<code>SOCK_DGRAM</code>è¡¨ç¤ºä¼ è¾“å±‚ä½¿ç”¨UDPåè®®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812101617247.png" alt="image-20220812101617247"></p>
<p>å¹¶ä¸”ä»Linuxå†…æ ¸2.6.17èµ·ï¼Œå¢åŠ äº†<code>SOCK_NONBLOCK</code>å’Œ<code>SOCK_CLOEXEC</code>è¿™ä¸¤ä¸ªæ ‡å¿—å€¼ï¼Œè¡¨ç¤ºå°†æ–°åˆ›å»ºçš„socketè®¾ä¸ºéé˜»å¡ï¼Œä»¥åŠforkè°ƒç”¨åˆ›å»ºå­è¿›ç¨‹æ—¶åœ¨å­è¿›ç¨‹ä¸­å…³é—­è¯¥socketã€‚åœ¨Linuxå†…æ ¸2.6.17å‰ï¼Œéœ€è¦è°ƒç”¨<code>fcntl</code>è¿›è¡Œè®¾ç½®ã€‚</p>
<p><code>protocol</code>å‚æ•°è®¾ç½®å…·ä½“çš„åè®®ã€‚ä½†æ˜¯åœ¨å‰ä¸¤ä¸ªå‚æ•°ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‚æ•°çš„å€¼åŸºæœ¬ä¸Šå”¯ä¸€çš„ï¼Œæ‰€æœ‰å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®ã€‚</p>
<p>socketç³»ç»Ÿè°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> lfd = <span class="number">0</span>;</span><br><span class="line">    lfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//åˆ›å»ºä¸€ä¸ª socket</span></span><br><span class="line">    close(lfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‘½åsocket"><a href="#å‘½åsocket" class="headerlink" title="å‘½åsocket"></a>å‘½åsocket</h2><p>åˆ›å»ºsocketæ—¶ï¼Œæˆ‘ä»¬æŒ‡å®šäº†åœ°å€æ—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç»™å®šå…·ä½“çš„åœ°å€ï¼Œè¿™æ ·ä½œä¸ºæœåŠ¡å™¨åˆ«äººæ˜¯è®¿é—®ä¸åˆ°æˆ‘ä»¬çš„ã€‚å°†ä¸€ä¸ªsocket ä¸socketåœ°å€ç»‘å®šç§°ä¸ºç»™socketå‘½åã€‚å‘½åsocketçš„ç³»ç»Ÿè°ƒç”¨æ˜¯bindã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>bind</code>å°†<code>addr</code>æ‰€æŒ‡çš„socketåœ°å€åˆ†é…ç»™æœªå‘½åçš„<code>sockfd</code>æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>addrlen</code>å‚æ•°æŒ‡å‡ºè¯¥socketåœ°å€çš„é•¿åº¦ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812104757237.png" alt="image-20220812104757237"></p>
<p><code>bind</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å…¶ä¸­ä¸¤ç§å¸¸è§çš„<code>errno</code>æ˜¯<code>EACCES</code>å’Œ<code>EADDRINUSE</code>ï¼Œå®ƒä»¬çš„å«ä¹‰åˆ†åˆ«æ˜¯:</p>
<ul>
<li><code>EACCES</code>ï¼Œè¢«ç»‘å®šçš„åœ°å€æ˜¯å—ä¿æŠ¤çš„åœ°å€ï¼Œä»…è¶…çº§ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ã€‚æ¯”å¦‚æ™®é€šç”¨æˆ·å°†socketç»‘å®šåˆ°çŸ¥åæœåŠ¡ç«¯å£ï¼ˆç«¯å£å·ä¸º0~1023ï¼‰ä¸Šæ—¶ï¼Œ<code>bind</code>å°†è¿”å›<code>EACCES</code>é”™è¯¯ã€‚</li>
<li><code>EADDRINUSE</code>ï¼Œè¢«ç»‘å®šçš„åœ°å€æ­£åœ¨ä½¿ç”¨ä¸­ã€‚æ¯”å¦‚å°†socketç»‘å®šåˆ°ä¸€ä¸ªå¤„äº<code>TIME_WAIT</code>çŠ¶æ€çš„socketåœ°å€ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812105430276.png" alt="image-20220812105430276"></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERV_PORT 8080</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> lfd = <span class="number">0</span>, cfd = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv_addr, clit_addr; <span class="comment">// å®šä¹‰æœåŠ¡å™¨åœ°å€ç»“æ„ å’Œ å®¢æˆ·ç«¯åœ°å€ç»“æ„</span></span><br><span class="line">    <span class="type">socklen_t</span> clit_addr_len;                 <span class="comment">// å®¢æˆ·ç«¯åœ°å€ç»“æ„å¤§å°</span></span><br><span class="line"></span><br><span class="line">    serv_addr.sin_family = AF_INET;                <span class="comment">// IPv4</span></span><br><span class="line">    serv_addr.sin_port = <span class="built_in">htons</span>(SERV_PORT);         <span class="comment">// è½¬ä¸ºç½‘ç»œå­—èŠ‚åºçš„ ç«¯å£å·</span></span><br><span class="line">    serv_addr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY); <span class="comment">// è·å–æœ¬æœºä»»æ„æœ‰æ•ˆIP</span></span><br><span class="line"></span><br><span class="line">    lfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//åˆ›å»ºä¸€ä¸ª socket</span></span><br><span class="line">    <span class="keyword">if</span> (lfd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(lfd, (<span class="keyword">struct</span> sockaddr *)&amp;serv_addr, <span class="built_in">sizeof</span>(serv_addr)); <span class="comment">//ç»™æœåŠ¡å™¨socketç»‘å®šåœ°å€ç»“æ„ï¼ˆIP+port)</span></span><br><span class="line">    <span class="built_in">close</span>(lfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›‘å¬socket"><a href="#ç›‘å¬socket" class="headerlink" title="ç›‘å¬socket"></a>ç›‘å¬socket</h2><p>socketè¢«å‘½ååï¼Œè¿˜éœ€è¦è°ƒç”¨<code>listen</code>åˆ›å»ºä¸€ä¸ªç›‘å¬é˜Ÿåˆ—æ¥å­˜æ”¾å¤„ç†çš„å®¢æˆ·è¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812112118847.png" alt="image-20220812112118847"></p>
<p><code>sockfd</code>å‚æ•°æŒ‡å®šè¢«ç›‘å¬çš„socketã€‚<code>backlog</code>å‚æ•°æç¤ºå†…æ ¸ç›‘å¬é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦å¦‚æœè¶…è¿‡<code>backlog</code>ï¼ŒæœåŠ¡å™¨å°†ä¸å—ç†æ–°çš„å®¢æˆ·è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°†æ”¶åˆ°<code>ECONNREFUSED</code>é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>åœ¨å†…æ ¸ç‰ˆæœ¬2.2ä¹‹å‰çš„Linuxä¸­ï¼Œ<code>backlog</code>å‚æ•°æ˜¯æŒ‡æ‰€æœ‰å¤„äºåŠè¿æ¥çŠ¶æ€ï¼ˆ<code>SYN_RCVD</code>ï¼‰å’Œå®Œå…¨è¿æ¥çŠ¶æ€ï¼ˆ<code>ESTABLISHED</code>)çš„socket çš„ä¸Šé™ã€‚ä½†è‡ªå†…æ ¸ç‰ˆæœ¬2.2ä¹‹åï¼Œå®ƒåªè¡¨ç¤ºå¤„äºå®Œå…¨è¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™ï¼Œå¤„äºåŠè¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™åˆ™ç”±<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>å†…æ ¸å‚æ•°å®šä¹‰ã€‚<code>backlog</code>å‚æ•°çš„å…¸å‹å€¼æ˜¯5ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812113608890.png" alt="image-20220812113608890"></p>
<p><code>listen</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>erron</code>ã€‚</p>
<p>æœ¬æ¥æƒ³æµ‹è¯•<code>backlog</code>è¿™ä¸ªå‚æ•°çš„æ•ˆæœï¼Œä½†æ˜¯æ€ä¹ˆä¹ŸæˆåŠŸä¸äº†ï¼Œä¸çŸ¥é“åŸå› ï¼Œä»¥åæœ‰æœºä¼šå†è¿›è¡Œå°è¯•å§ã€‚</p>
<h2 id="æ¥å—è¿æ¥"><a href="#æ¥å—è¿æ¥" class="headerlink" title="æ¥å—è¿æ¥"></a>æ¥å—è¿æ¥</h2><p>æ¥å—è¿æ¥é€šè¿‡<code>accept</code>è¿›è¡Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812143816774.png" alt="image-20220812143816774"></p>
<p><code>sockfd</code>æŒ‡æ‰§è¡Œè¿‡<code>listen</code>çš„ç›‘å¬å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>addr</code>æ˜¯ä¼ å‡ºå‚æ•°ï¼Œç”¨æ¥è·å–æ¥å—è¿æ¥çš„è¿œç«¯socketåœ°å€ï¼Œåœ°å€çš„é•¿åº¦ç”±<code>addrlen</code>å‚æ•°æŒ‡å‡ºã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812151534158.png" alt="image-20220812151534158"></p>
<p>å¹¶ä¸”<strong>ä¹¦ä¸Šé¢çš„å®éªŒ</strong>è¯´æ˜äº†<code>accept</code>ç›´æ¥ä»ç›‘å¬é˜Ÿåˆ—ä¸­å–å‡ºè¿æ¥ï¼Œè€Œä¸è®ºè¿æ¥å¤„äºä½•ç§çŠ¶æ€ï¼Œæ›´ä¸å…³å¿ƒä»»ä½•ç½‘ç»œçŠ¶å†µçš„å˜åŒ–ã€‚æ¯”å¦‚ï¼šå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨<code>accept</code>ä¹‹å‰å°±æ–­ç½‘äº†ï¼Œ<code>accept</code>è¿˜æ˜¯å¯ä»¥æ­£å¸¸è¿›è¡Œï¼Œå®ƒå¹¶ä¸ä¼šè¿”å›é”™è¯¯ã€‚</p>
<h2 id="å‘èµ·è¿æ¥"><a href="#å‘èµ·è¿æ¥" class="headerlink" title="å‘èµ·è¿æ¥"></a>å‘èµ·è¿æ¥</h2><p>å‘åŠ¨è¿æ¥ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯è¿›è¡Œçš„ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>connect</code>ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812154447716.png" alt="image-20220812154447716"></p>
<p><code>sockfd</code>å‚æ•°ç”±socketç³»ç»Ÿè°ƒç”¨è¿”å›ä¸€ä¸ª<code>socket</code>ã€‚<code>addr</code>å‚æ•°æ˜¯æœåŠ¡å™¨ç›‘å¬çš„<code>socket</code>åœ°å€ã€‚<code>addrlen</code>å‚æ•°æŒ‡è¿™ä¸ªåœ°å€é•¿åº¦ã€‚</p>
<p><code>connect</code>æˆåŠŸæ—¶è¿”å›0ã€‚ä¸€æ—¦æˆåŠŸå»ºç«‹è¿æ¥ï¼Œ<code>sockfd</code>å°±å”¯ä¸€åœ°æ ‡è¯†äº†è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡è¯»å†™sockfdæ¥ä¸æœåŠ¡å™¨é€šä¿¡ã€‚<code>connect</code>å¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å…¶ä¸­ä¸¤ç§å¸¸è§çš„<code>errno</code>æ˜¯<code>ECONNREFUSED</code>å’Œ<code>ETIMEDOUT</code>ï¼Œå®ƒä»¬çš„å«ä¹‰å¦‚ä¸‹:</p>
<ul>
<li><code>ECONNREFUSED</code>è¡¨ç¤ºç›®æ ‡ç«¯å£ä¸å­˜åœ¨ï¼Œè¿æ¥è¢«æ‹’ç»ã€‚</li>
<li><code>ETIMEDOUT</code>è¡¨ç¤ºè¿æ¥è¶…æ—¶ã€‚</li>
</ul>
<h2 id="å…³é—­è¿æ¥"><a href="#å…³é—­è¿æ¥" class="headerlink" title="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥</h2><p>å…³é—­è¿æ¥ä¸€èˆ¬æ¥è¯´ä½¿ç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>å‚æ•°æ˜¯å¾…å…³é—­çš„socketã€‚ä¸è¿‡ï¼Œ<code>close</code>å¹¶ä¸ä¼šç«‹å³å…³é—­è¿™ä¸ªè¿æ¥ï¼Œè€Œæ˜¯å°†<code>fd</code>çš„å¼•ç”¨æ•°é‡å‡1ï¼Œç›´åˆ°<code>fd</code>å¼•ç”¨æ•°é‡ä¸º0ï¼Œæ‰çœŸæ­£å…³é—­è¿æ¥ã€‚åœ¨å¤šè¿›ç¨‹ç¨‹åºä¸­ï¼Œä¸€æ¬¡<code>fork</code>ç³»ç»Ÿè°ƒç”¨é»˜è®¤å°†çˆ¶è¿›ç¨‹ä¸­<code>socket</code>çš„å¼•ç”¨è®¡ç®—åŠ 1ï¼Œå› æ­¤å¿…é¡»åœ¨å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹éƒ½å¯¹è¯¥<code>socket</code>è¿›è¡Œ<code>close</code>è°ƒç”¨æ‰èƒ½å°†è¿æ¥å…³é—­ã€‚</p>
<p>å¦‚æœæƒ³ç«‹åˆ»ç»ˆæ­¢è¿æ¥ï¼Œç›´æ¥è°ƒç”¨<code>shutdown</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shutdown</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> how)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812160846669.png" alt="image-20220812160846669"></p>
<p><code>sockfd</code>å‚æ•°æ˜¯å¾…å…³é—­çš„socketï¼Œ<code>howto</code>å‚æ•°å†³å®šäº†<code>shutdown</code>çš„è¡Œä¸ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">å¯é€‰å€¼</th>
<th style="text-align:left">å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SHUT_RD</td>
<td style="text-align:left">å…³é—­sockfdä¸Šè¯»çš„è¿™ä¸€åŠã€‚åº”ç”¨ç¨‹åºä¸èƒ½å†é’ˆå¯¹socketæ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œè¯»æ“ä½œï¼Œå¹¶ä¸”è¯¥sockctæ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½è¢«ä¸¢å¼ƒã€‚</td>
</tr>
<tr>
<td style="text-align:center">SHUT_WR</td>
<td style="text-align:left">å…³é—­sockfdä¸Šå†™çš„è¿™ä¸€åŠã€‚sockfd çš„å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®ä¼šåœ¨çœŸæ­£å…³é—­è¿æ¥ä¹‹å‰å…¨éƒ¨å‘é€å‡ºå»ï¼Œåº”ç”¨ç¨‹åºä¸å¯å†å¯¹è¯¥socketæ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œå†™æ“ä½œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€ã€‚</td>
</tr>
<tr>
<td style="text-align:center">SHUT_RDWR</td>
<td style="text-align:left">åŒæ—¶å…³é—­sockfdä¸Šçš„è¯»å’Œå†™ã€‚</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡º<code>shutdown</code>å¯ä»¥çµæ´»çš„å…³é—­socketä¸Šçš„è¯»æˆ–å†™ã€‚è€Œ<code>close</code>åœ¨å…³é—­è¿æ¥æ—¶åªèƒ½å°†<code>socket</code>ä¸Šçš„è¯»å’Œå†™åŒæ—¶å…³é—­ã€‚</p>
<p><code>shutdown</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>socketé€‰é¡¹</title>
    <url>/2022/08/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/socket%E9%80%89%E9%A1%B9/</url>
    <content><![CDATA[<h1 id="socketé€‰é¡¹"><a href="#socketé€‰é¡¹" class="headerlink" title="socketé€‰é¡¹"></a>socketé€‰é¡¹</h1><p>è¯»å–å’Œè®¾ç½®socketæ–‡ä»¶æè¿°çš„æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">void</span> *optval, <span class="type">socklen_t</span> *optlen)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">const</span> <span class="type">void</span> *optval, <span class="type">socklen_t</span> optlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>sockfd</code>å‚æ•°æŒ‡å®šè¢«æ“çºµçš„ç›®æ ‡socketï¼Œ<code>level</code>å‚æ•°æŒ‡å®šè¦æ“ä½œçš„åè®®é€‰é¡¹ï¼Œ<code>optname</code>å‚æ•°åˆ™æŒ‡å®šé€‰é¡¹çš„åå­—ï¼Œ<code>optval</code>å’Œ<code>optlen</code>å‚æ•°åˆ†åˆ«æ˜¯æ“ä½œé€‰é¡¹çš„å€¼å’Œé•¿åº¦ã€‚æˆªå›¾äº†ä¸€ä¸‹ä¹¦ä¸­çš„è¡¨æ ¼ã€‚</p>
<span id="more"></span>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/socketé€‰é¡¹.png" alt="socketé€‰é¡¹"></p>
<p><code>getsockopt</code>å’Œ<code>setsockopt</code>è¿™ä¸¤ä¸ªå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœåŠ¡å™¨ç«¯<code>setsockopt</code>æœ€å¥½åœ¨<code>listen</code>ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼ˆå› ä¸ºè¿æ¥socketåªèƒ½ç”±acceptè°ƒç”¨è¿”å›ï¼Œè€Œaccept ä» listen ç›‘å¬é˜Ÿåˆ—ä¸­æ¥å—çš„è¿æ¥è‡³å°‘å·²ç»å®Œæˆäº†TCPä¸‰æ¬¡æ¡æ‰‹çš„å‰ä¸¤ä¸ªæ­¥éª¤ï¼‰ã€‚åŒç†ï¼Œå¯¹å®¢æˆ·ç«¯è€Œè¨€ï¼Œè¿™äº›socketé€‰é¡¹åˆ™åº”è¯¥åœ¨è°ƒç”¨connect å‡½æ•°ä¹‹å‰è®¾ç½®ï¼Œå› ä¸ºconnectè°ƒç”¨æˆåŠŸè¿”å›ä¹‹åï¼ŒTCä¸‰æ¬¡æ¡æ‰‹å·²å®Œæˆã€‚</p>
<h3 id="SO-REUSEADDR"><a href="#SO-REUSEADDR" class="headerlink" title="SO_REUSEADDR"></a>SO_REUSEADDR</h3><p>è®¾ç½®æœåŠ¡å™¨å¯ä»¥ç«‹å³é‡å¯ï¼Œä¸éœ€è¦ç­‰å¾…<code>TIME_WAIT</code>çŠ¶æ€è¿‡å»ï¼Œå¯ä»¥ä½¿ç”¨<code>SO_REUSEADDR</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> sock = socket( PF_INET, SOCK_STREAM, <span class="number">0</span> );</span><br><span class="line">assert( sock &gt;= <span class="number">0</span> );</span><br><span class="line"><span class="type">int</span> reuse = <span class="number">1</span>;</span><br><span class="line">setsockopt( sock, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span class="keyword">sizeof</span>( reuse ) );</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡setsockoptçš„è®¾ç½®ä¹‹åï¼Œå³ä½¿sockå¤„äºTIME_WAITçŠ¶æ€ï¼Œä¸ä¹‹ç»‘å®šçš„socketåœ°å€ä¹Ÿå¯ä»¥ç«‹å³è¢«é‡ç”¨ã€‚</p>
<h3 id="SO-RCVBUFå’ŒSO-SNDBUF"><a href="#SO-RCVBUFå’ŒSO-SNDBUF" class="headerlink" title="SO_RCVBUFå’ŒSO_SNDBUF"></a>SO_RCVBUFå’ŒSO_SNDBUF</h3><p><code>SO_RCVBUF</code>å’Œ<code>SO_SNDBUF</code>åˆ†åˆ«è®¾ç½®TCPæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>setsockopt</code>è®¾ç½®TCPç¼“å†²åŒºå¤§å°æ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šå°†å…¶å€¼è¿›è¡ŒåŠ å€ï¼Œå¹¶ä¸”ä¸ä¼šå°äºæŸä¸ªå€¼ã€‚TCPæ¥æ”¶ç¼“å†²åŒºæœ€å°å€¼æ˜¯256å­—èŠ‚ï¼Œå‘é€ç¼“å†²åŒºæœ€å°æ˜¯2048å­—èŠ‚ã€‚å°å€¼æ˜¯2048å­—èŠ‚(ä¸è¿‡ï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½æœ‰ä¸åŒçš„é»˜è®¤æœ€å°å€¼)ã€‚ç³»ç»Ÿè¿™æ ·åšçš„ç›®çš„ï¼Œä¸»è¦æ˜¯ç¡®ä¿ä¸€ä¸ªTCPè¿æ¥æ‹¥æœ‰è¶³å¤Ÿçš„ç©ºé—²ç¼“å†²åŒºæ¥å¤„ç†æ‹¥å¡ï¼ˆæ¯”å¦‚å¿«é€Ÿé‡ä¼ ç®—æ³•å°±æœŸæœ›TCPæ¥æ”¶ç¼“å†²åŒºèƒ½è‡³å°‘å®¹çº³4ä¸ªå¤§å°ä¸ºSMSSçš„TCPæŠ¥æ–‡æ®µ)ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number receive_buffer_size\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> recvbuf = atoi(argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="type">int</span> len = <span class="keyword">sizeof</span>(recvbuf);</span><br><span class="line">    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &amp;recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &amp;recvbuf, (<span class="type">socklen_t</span> *)&amp;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the receive buffer size after settting is %d\n&quot;</span>, recvbuf);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sendbuf = atoi(argv[<span class="number">4</span>]);</span><br><span class="line">    len = <span class="keyword">sizeof</span>(sendbuf);</span><br><span class="line">    setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &amp;sendbuf, <span class="keyword">sizeof</span>(sendbuf));</span><br><span class="line">    getsockopt(sock, SOL_SOCKET, SO_SNDBUF, &amp;sendbuf, (<span class="type">socklen_t</span> *)&amp;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the tcp send buffer size after setting is %d\n&quot;</span>, sendbuf);</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813180440008.png" alt="image-20220813180440008"></p>
<p>emmmä¸çŸ¥é“ä¸ºå•¥å¤§å°æ˜¯è¿™æ ·ï¼Œåç»­å†çœ‹çœ‹ã€‚</p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢API</title>
    <url>/2022/08/14/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/socket%E7%BD%91%E7%BB%9C%E4%BF%A1%E6%81%AF%E6%9F%A5%E8%AF%A2API/</url>
    <content><![CDATA[<h1 id="socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢API"><a href="#socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢API" class="headerlink" title="socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢API"></a>socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢API</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­socketç½‘ç»œä¿¡æ¯æŸ¥è¯¢APIï¼ŒåŒ…æ‹¬gethostbynameå’Œgethostbyaddrã€getservbynameå’Œgetservbyportã€getaddrinfoã€getnameinfoã€‚</p>
<p>socketå½“ä¸­ä¸¤è¦ç´ ï¼šIPå’Œç«¯å£å·ï¼Œéƒ½æ˜¯ç”¨æ•°å€¼è¡¨ç¤ºçš„ã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸»æœºåä»£æ›¿IPï¼Œä½¿ç”¨æœåŠ¡åä»£æ›¿ç«¯å£å·ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">telnet 127.0.0.1 80</span><br><span class="line">telnet localhost www</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªåŠŸèƒ½å°±æ˜¯ä½¿ç”¨ç½‘ç»œä¿¡æ¯APIå®ç°çš„ã€‚</p>
<span id="more"></span>
<h2 id="gethostbynameå’Œgethostbyaddr"><a href="#gethostbynameå’Œgethostbyaddr" class="headerlink" title="gethostbynameå’Œgethostbyaddr"></a>gethostbynameå’Œgethostbyaddr</h2><p><code>gethostbyname</code>å‡½æ•°æ ¹æ®ä¸»æœºåç§°è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ï¼Œ<code>gethostbyaddr</code>å‡½æ•°æ ¹æ®IPåœ°å€è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ã€‚<code>gethostbyname</code>å‡½æ•°é€šå¸¸å…ˆåœ¨æœ¬åœ°çš„<code>/etc/hosts</code>é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾ä¸»æœºï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†å»è®¿é—®DNSæœåŠ¡å™¨ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> h_errno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> hostent *<span class="title function_">gethostbyname</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>       <span class="comment">/* for AF_INET */</span></span></span><br><span class="line"><span class="keyword">struct</span> hostent *<span class="title function_">gethostbyaddr</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *addr, <span class="type">socklen_t</span> len, <span class="type">int</span> type)</span>;</span><br></pre></td></tr></table></figure>
<p><code>name</code>å‚æ•°è¡¨ç¤ºç›®æ ‡ä¸»æœºçš„ä¸»æœºåã€‚</p>
<p><code>addr</code>å‚æ•°æŒ‡å®šç›®æ ‡ä¸»æœºçš„IPåœ°å€ï¼Œ<code>len</code>å‚æ•°æŒ‡å®š<code>addr</code>çš„æ‰€æŒ‡å®šIPçš„é•¿åº¦</p>
<p><code>type</code>å‚æ•°æŒ‡å®šIPåœ°å€çš„ç±»å‹ï¼Œæ¯”å¦‚<code>AF_INET</code>ç­‰</p>
<p>å…¶ä¸­<code>hostent</code>å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> &#123;</span></span><br><span class="line">   <span class="type">char</span>  *h_name;            <span class="comment">/* official name of host */</span></span><br><span class="line">   <span class="type">char</span> **h_aliases;         <span class="comment">/* alias list */</span></span><br><span class="line">   <span class="type">int</span>    h_addrtype;        <span class="comment">/* host address type */</span></span><br><span class="line">   <span class="type">int</span>    h_length;          <span class="comment">/* length of address */</span></span><br><span class="line">   <span class="type">char</span> **h_addr_list;       <span class="comment">/* list of addresses */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°ä»‹ç»</p>
<p><code>h_name</code>:ä¸»æœºå<br><code>h_aliases</code>:ä¸»æœºåˆ«ååˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ª<br><code>h_addrtype</code>:åœ°å€ç±»å‹ï¼ˆåœ°å€æ—ï¼‰<br><code>h_length</code>:åœ°å€é•¿åº¦<br><code>h_addr_list</code>:æŒ‰ç½‘ç»œå­—èŠ‚åºåˆ—å‡ºçš„ä¸»æœºIPåœ°å€åˆ—è¡¨</p>
<p>ä»ç½‘ä¸Šæ‰¾äº†ä¸ªå›¾æ˜¾ç¤ºäº†ä¸€ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/Center.png" alt="img"></p>
<p><code>gethostbyname</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s www.baidu.com\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *name = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hptr</span>;</span></span><br><span class="line"></span><br><span class="line">    hptr = gethostbyname(name);</span><br><span class="line">    <span class="keyword">if</span> (hptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;gethostbyname error for host: %s: %s\n&quot;</span>, name, hstrerror(h_errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºå</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\tofficial: %s\n&quot;</span>, hptr-&gt;h_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºçš„åˆ«å</span></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="type">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">for</span> (pptr = hptr-&gt;h_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\talias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºipåœ°å€</span></span><br><span class="line">    <span class="keyword">switch</span> (hptr-&gt;h_addrtype)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> AF_INET:</span><br><span class="line">        pptr = hptr-&gt;h_addr_list;</span><br><span class="line">        <span class="keyword">for</span> (; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\taddress: %s\n&quot;</span>,</span><br><span class="line">                   inet_ntop(hptr-&gt;h_addrtype, *pptr, str, <span class="keyword">sizeof</span>(str)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;unknown address type\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814105118617.png" alt="image-20220814105118617"></p>
<p><code>gethostbyaddr</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 127.0.0.1\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    inet_pton(AF_INET, ip, &amp;addr);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hptr</span>;</span></span><br><span class="line"></span><br><span class="line">    hptr = gethostbyaddr(&amp;addr, <span class="keyword">sizeof</span>(addr), AF_INET);</span><br><span class="line">    <span class="keyword">if</span> (hptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;gethostbyaddr error for host: %s: %s\n&quot;</span>, ip, hstrerror(h_errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºå</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\tofficial: %s\n&quot;</span>, hptr-&gt;h_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºçš„åˆ«å</span></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="type">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">for</span> (pptr = hptr-&gt;h_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\talias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºipåœ°å€</span></span><br><span class="line">    <span class="keyword">switch</span> (hptr-&gt;h_addrtype)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> AF_INET:</span><br><span class="line">        pptr = hptr-&gt;h_addr_list;</span><br><span class="line">        <span class="keyword">for</span> (; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\taddress: %s\n&quot;</span>,</span><br><span class="line">                   inet_ntop(hptr-&gt;h_addrtype, *pptr, str, <span class="keyword">sizeof</span>(str)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;unknown address type\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814105222471.png" alt="image-20220814105222471"></p>
<h2 id="getservbynameå’Œgetservbyport"><a href="#getservbynameå’Œgetservbyport" class="headerlink" title="getservbynameå’Œgetservbyport"></a>getservbynameå’Œgetservbyport</h2><p><code>getservbyname</code>å‡½æ•°æ ¹æ®åç§°è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ï¼Œ<code>getservbyport</code>å‡½æ•°æ ¹æ®ç«¯å£å·è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ã€‚å®ƒä»¬å®é™…ä¸Šéƒ½æ˜¯é€šè¿‡è¯»å–<code>/etc/services</code>æ–‡ä»¶æ¥è·å–æœåŠ¡çš„ä¿¡æ¯çš„ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> servent *<span class="title function_">getservbyname</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *proto)</span>;</span><br><span class="line"><span class="keyword">struct</span> servent *<span class="title function_">getservbyport</span><span class="params">(<span class="type">int</span> port, <span class="type">const</span> <span class="type">char</span> *proto)</span>;</span><br></pre></td></tr></table></figure>
<p><code>name</code>å‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡çš„åå­—ã€‚</p>
<p><code>port</code>å‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡å¯¹åº”çš„ç«¯å£å·ã€‚</p>
<p><code>proto</code>å‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ï¼Œç»™å®ƒä¼ é€’â€œtcpâ€è¡¨ç¤ºè·å–æµæœåŠ¡ï¼Œç»™å®ƒä¼ é€’â€œudpâ€è¡¨ç¤ºè·å–æ•°æ®æŠ¥æœåŠ¡ï¼Œç»™å®ƒä¼ é€’NULLåˆ™è¡¨ç¤ºè·å–æ‰€æœ‰ç±»å‹çš„æœåŠ¡ã€‚</p>
<p>å‡½æ•°è¿”å›çš„<code>servent</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">servent</span> &#123;</span></span><br><span class="line">   <span class="type">char</span>  *s_name;       <span class="comment">/* official service name */</span></span><br><span class="line">   <span class="type">char</span> **s_aliases;    <span class="comment">/* alias list */</span></span><br><span class="line">   <span class="type">int</span>    s_port;       <span class="comment">/* port number */</span></span><br><span class="line">   <span class="type">char</span>  *s_proto;      <span class="comment">/* protocol to use */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>s_name</code>ï¼šæœåŠ¡åç§°</p>
<p><code>s_aliases</code>ï¼šæœåŠ¡åˆ«ååˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ª</p>
<p><code>s_port</code>ï¼šç«¯å£å·</p>
<p><code>s_proto</code>ï¼šæœåŠ¡ç±»å‹ï¼Œé€šå¸¸æ˜¯tcpæˆ–è€…udp</p>
<p><code>getservbyname</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">servent</span> *<span class="title">servinfo</span> =</span> getservbyname(<span class="string">&quot;ssh&quot;</span>, <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line">    assert(servinfo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name is %s\n&quot;</span>, servinfo-&gt;s_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="keyword">for</span> (pptr = servinfo-&gt;s_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %d\n&quot;</span>, ntohs(servinfo-&gt;s_port));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;protocol is %s\n&quot;</span>, servinfo-&gt;s_proto);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814141312451.png" alt="image-20220814141312451"></p>
<p><code>getservbyport</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> port = <span class="number">80</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">servent</span> *<span class="title">servinfo</span> =</span> getservbyport(htons(port), <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line">    assert(servinfo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name is %s\n&quot;</span>, servinfo-&gt;s_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="keyword">for</span> (pptr = servinfo-&gt;s_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %d\n&quot;</span>, ntohs(servinfo-&gt;s_port));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;protocol is %s\n&quot;</span>, servinfo-&gt;s_proto);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814142922859.png" alt="image-20220814142922859"></p>
<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢è®¨è®ºçš„4ä¸ªå‡½æ•°éƒ½æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå³éçº¿ç¨‹å®‰å…¨çš„ã€‚ä¸è¿‡<code>netdb.h</code>å¤´æ–‡ä»¶ç»™å‡ºäº†å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚æ­£å¦‚Linuxä¸‹æ‰€æœ‰å…¶ä»–å‡½æ•°çš„å¯é‡å…¥ç‰ˆæœ¬çš„å‘½åè§„åˆ™é‚£æ ·ï¼Œè¿™äº›å‡½æ•°çš„å‡½æ•°åæ˜¯åœ¨åŸå‡½æ•°åå°¾éƒ¨åŠ ä¸Š_<code>r (re-entrant)</code>ã€‚</p>
<h2 id="getaddrinfo"><a href="#getaddrinfo" class="headerlink" title="getaddrinfo"></a>getaddrinfo</h2><p><code>getaddrinfo</code>å‡½æ•°æ—¢èƒ½é€šè¿‡ä¸»æœºåè·å¾—IPåœ°å€ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>gethostbyname</code>å‡½æ•°),ä¹Ÿèƒ½é€šè¿‡æœåŠ¡åè·å¾—ç«¯å£å·ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>getservbyname</code>å‡½æ•°)ã€‚å®ƒæ˜¯å¦å¯é‡äººå–å†³äºå…¶å†…éƒ¨è°ƒç”¨çš„<code>gethostbyname</code>å’Œ<code>getservbyname</code>å‡½æ•°æ˜¯å¦æ˜¯å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚è¯¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getaddrinfo</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *node, <span class="type">const</span> <span class="type">char</span> *service, <span class="type">const</span> <span class="keyword">struct</span> addrinfo *hints, <span class="keyword">struct</span> addrinfo **res)</span>;</span><br></pre></td></tr></table></figure>
<p><code>node</code>å‚æ•°å¯ä»¥æ¥æ”¶ä¸»æœºåï¼Œä¹Ÿå¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPåœ°å€ï¼Œç”¨ç‚¹åˆ†ååˆ†åˆ¶ã€‚</p>
<p><code>service</code>å‚æ•°å¯ä»¥æ¥æ”¶æœåŠ¡åï¼Œä¹Ÿå¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„åè¿›åˆ¶ç«¯å£ã€‚</p>
<p><code>hints</code>å‚æ•°æ˜¯ç»™<code>getaddrinfo</code>çš„ä¸€ä¸ªæç¤ºï¼Œä»¥å¯¹<code>getaddrinfo</code>çš„è¾“å‡ºè¿›è¡Œæ›´ç²¾ç¡®çš„æ§åˆ¶ã€‚<code>hints</code>å‚æ•°å¯ä»¥è®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºå…è®¸<code>getaddrinfo</code>åé¦ˆä»»ä½•å¯ç”¨çš„ç»“æœã€‚</p>
<p><code>res</code>å‚æ•°è¿”å›ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ç”¨äºå­˜å‚¨<code>getaddrinfo</code>åé¦ˆçš„ç»“æœã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨å®Œ<code>getaddrinfo</code>ä¹‹åï¼Œéœ€è¦ä½¿ç”¨<code>freeaddrinfo</code>å¯¹resè¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">freeaddrinfo</span><span class="params">(<span class="keyword">struct</span> addrinfo *res)</span>;</span><br></pre></td></tr></table></figure>
<p><code>addrinfo</code>çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> &#123;</span></span><br><span class="line">   <span class="type">int</span>              ai_flags;</span><br><span class="line">   <span class="type">int</span>              ai_family;</span><br><span class="line">   <span class="type">int</span>              ai_socktype;</span><br><span class="line">   <span class="type">int</span>              ai_protocol;</span><br><span class="line">   <span class="type">socklen_t</span>        ai_addrlen;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *<span class="title">ai_addr</span>;</span></span><br><span class="line">   <span class="type">char</span>            *ai_canonname;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">ai_next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>ai_family</code>ï¼šåœ°å€æ—ï¼Œæ¯”å¦‚ï¼š<code>AF_INET</code></p>
<p><code>ai_socktype</code>ï¼šæœåŠ¡ç±»å‹ï¼Œæ¯”å¦‚ï¼š<code>SOCK_STREAM</code></p>
<p><code>ai_protocol</code>ï¼šæŒ‡å…·ä½“çš„ç½‘ç»œåè®®</p>
<p><code>ai_addrlen</code>ï¼šåœ°å€<code>ai_addr</code>çš„é•¿åº¦</p>
<p><code>ai_addr</code>ï¼šæŒ‡å‘socketçš„åœ°å€</p>
<p><code>ai_canonname</code>ï¼šä¸»æœºçš„åˆ«å</p>
<p><code>ai_next</code>ï¼šé“¾è¡¨çš„ä¸‹ä¸€ä¸ªå¯¹è±¡</p>
<p><code>ai_flags</code>å¯ä»¥å–ä¸‹è¡¨ä¸­æ ‡å¿—</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814160248251.png" alt="image-20220814160248251"></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨hintså‚æ•°çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®å…¶<code>ai_flags</code>ï¼Œ<code>ai_family</code>ï¼Œ<code>ai_socktype</code>å’Œ<code>ai_protocol</code>å››ä¸ªå­—æ®µï¼Œå…¶ä»–å­—æ®µåˆ™å¿…é¡»è¢«è®¾ç½®ä¸ºNULLã€‚</p>
<p><strong>æ ¹æ®ä¸»æœºåè·å–IPåœ°å€ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s www.baidu.com\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *name = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">res</span>, *<span class="title">cur</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">char</span> ipbuf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</span><br><span class="line">    hints.ai_family = AF_INET;   <span class="comment">/* Allow IPv4 */</span></span><br><span class="line">    hints.ai_flags = AI_PASSIVE; <span class="comment">/* For wildcard IP address */</span></span><br><span class="line">    hints.ai_protocol = <span class="number">0</span>;       <span class="comment">/* Any protocol */</span></span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line"></span><br><span class="line">    ret = getaddrinfo(name, <span class="literal">NULL</span>, &amp;hints, &amp;res);</span><br><span class="line">    assert(ret &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (cur = res; cur != <span class="literal">NULL</span>; cur = cur-&gt;ai_next)</span><br><span class="line">    &#123;</span><br><span class="line">        addr = (<span class="keyword">struct</span> sockaddr_in *)cur-&gt;ai_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip: %s\n&quot;</span>, inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, ipbuf, cur-&gt;ai_addrlen));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, cur-&gt;ai_canonname);</span><br><span class="line">    &#125;</span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814165923059.png" alt="image-20220814165923059"></p>
<p>ä¸è¿‡ä¸çŸ¥é“ä¸ºå•¥åˆ«åä¸ºnull</p>
<p><strong>æ ¹æ®ä¸»æœºåå’Œç«¯å£å·è·å–åœ°å€ä¿¡æ¯ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 80\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *port = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> *hostname = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">res</span>, *<span class="title">cur</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">char</span> ipbuf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</span><br><span class="line">    hints.ai_family = AF_UNSPEC; <span class="comment">/* Allow IPv4 */</span></span><br><span class="line">    hints.ai_flags = AI_PASSIVE; <span class="comment">/* For wildcard IP address */</span></span><br><span class="line">    hints.ai_protocol = <span class="number">0</span>;       <span class="comment">/* Any protocol */</span></span><br><span class="line">    hints.ai_socktype = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = getaddrinfo(hostname, port, &amp;hints, &amp;res);</span><br><span class="line"></span><br><span class="line">    assert(ret &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (cur = res; cur != <span class="literal">NULL</span>; cur = cur-&gt;ai_next)</span><br><span class="line">    &#123;</span><br><span class="line">        addr = (<span class="keyword">struct</span> sockaddr_in *)cur-&gt;ai_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip: %s\n&quot;</span>, inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, ipbuf, cur-&gt;ai_addrlen));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;port: %d\n&quot;</span>, ntohs(addr-&gt;sin_port));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, cur-&gt;ai_canonname);</span><br><span class="line">    &#125;</span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814170106763.png" alt="image-20220814170106763"></p>
<p>ä¸è¿‡ä¸çŸ¥é“ä¸ºå•¥åˆ«åä¸ºnull</p>
<h2 id="getnameinfo"><a href="#getnameinfo" class="headerlink" title="getnameinfo"></a>getnameinfo</h2><p><code>getnameinfo</code>å‡½æ•°èƒ½é€šè¿‡socketåœ°å€åŒæ—¶è·å¾—ä»¥å­—ç¬¦ä¸²è¡¨ç¤ºçš„<strong>ä¸»æœºå</strong>ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>gethostbyaddr</code>å‡½æ•°ï¼‰å’Œ<strong>æœåŠ¡å</strong>ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>getservbyport</code>å‡½æ•°)ã€‚å®ƒæ˜¯å¦å¯é‡å…¥å–å†³äºå…¶å†…éƒ¨è°ƒç”¨çš„gethostbyaddrå’Œ getservbyportå‡½æ•°æ˜¯å¦æ˜¯å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚è¯¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getnameinfo</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen,<span class="type">char</span> *host, <span class="type">socklen_t</span> hostlen,</span></span><br><span class="line"><span class="params">                <span class="type">char</span> *serv, <span class="type">socklen_t</span> servlen, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>getnameinfo</code>å°†è¿”å›çš„ä¸»æœºåå­˜å‚¨åœ¨hostå‚æ•°æŒ‡å‘çš„ç¼“å­˜ä¸­ï¼Œå°†æœåŠ¡åå­˜å‚¨åœ¨servå‚æ•°æŒ‡å‘çš„ç¼“å­˜ä¸­ï¼Œ<code>hostlen</code>å’Œ <code>servlen</code>å‚æ•°åˆ†åˆ«æŒ‡å®šè¿™ä¸¤å—ç¼“å­˜çš„é•¿åº¦ã€‚flagså‚æ•°æ§åˆ¶<code>getnameinfo</code>çš„è¡Œä¸ºï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸‹è¡¨ä¸­çš„é€‰é¡¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814171842523.png" alt="image-20220814171842523"></p>
<p><code>getaddrinfo</code>å’Œ <code>getnameinfo</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 127.0.0.1 80\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">char</span> hostname[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> servername[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr_dst</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr_dst, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr_dst));</span><br><span class="line">    addr_dst.sin_family = AF_INET;</span><br><span class="line">    addr_dst.sin_addr.s_addr = inet_addr(ip);</span><br><span class="line">    addr_dst.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;addr_dst, <span class="keyword">sizeof</span>(addr_dst), hostname, <span class="keyword">sizeof</span>(hostname), servername, <span class="keyword">sizeof</span>(servername), <span class="number">0</span>);</span><br><span class="line">    assert(ret == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hostname IP: %s \n&quot;</span>, hostname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;servername : %s \n&quot;</span>, servername);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814181037933.png" alt="image-20220814181037933"></p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸€ï¼‰</title>
    <url>/2023/01/03/Linux/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h1 id="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸€ï¼‰"><a href="#ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸€ï¼‰" class="headerlink" title="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸€ï¼‰"></a>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸€ï¼‰</h1><p>å­¦ä¹ äº†é™ˆç¡•è€å¸ˆçš„ã€ŠLinux å¤šçº¿ç¨‹æœåŠ¡ç«¯ç¼–ç¨‹ï¼šä½¿ç”¨ muduo C++ ç½‘ç»œåº“ã€‹ï¼Œæƒ³è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªç©å…·ï¼Œæ¨¡ä»¿é™ˆç¡•è€å¸ˆçš„muduoåº“ã€‚muduoåº“å¤§æ¦‚10000è¡Œï¼Œæœ¬äººè‡ªå·±å†™çš„è‚¯å®šç®€ç•¥å¾ˆå¤šï¼ˆæ¯•ç«Ÿåªæ˜¯ç©å…·ï¼‰ï¼Œåªæ˜¯ä¸ºäº†è‡ªå·±ç†Ÿæ‚‰è¿™ä¸ªç½‘ç»œåº“çš„å®ç°ã€‚</p>
<span id="more"></span>
<h2 id="ä½¿ç”¨epoll"><a href="#ä½¿ç”¨epoll" class="headerlink" title="ä½¿ç”¨epoll"></a>ä½¿ç”¨epoll</h2><p>ä½¿ç”¨epollæ„å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ˜¯ä¸ªechoæœåŠ¡å™¨ã€‚</p>
<p>ä»£ç åªæœ‰ä¸€ä¸ª<code>main.cpp</code>ï¼Œå¤§æ¦‚æœ‰100å¤šè¡Œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡å®šä¹‰epoll_event æ•°ç»„</span></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;epoll_event&gt; EventList;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_EXIT(m)     \</span></span><br><span class="line"><span class="meta">  do                    \</span></span><br><span class="line"><span class="meta">  &#123;                     \</span></span><br><span class="line"><span class="meta">    perror(m);          \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 8080</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * å±è”½ SIGPIPE SIGCHLD ä¿¡å·</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">signal</span>(SIGPIPE, SIG_IGN);</span><br><span class="line">  <span class="built_in">signal</span>(SIGCHLD, SIG_IGN);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè§£å†³EMFILEé”™è¯¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> idlefd = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> listenfd;</span><br><span class="line">  <span class="keyword">if</span> ((listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">  servaddr.sin_family = AF_INET;</span><br><span class="line">  servaddr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">  servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * è®¾ç½®ç«¯å£é‡ç”¨ï¼Œæ— éœ€ TIME_WAIT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="type">int</span>&gt; clients;</span><br><span class="line">  <span class="type">int</span> epollfd;</span><br><span class="line">  epollfd = <span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;</span><br><span class="line">  event.data.fd = listenfd;</span><br><span class="line">  event.events = EPOLLIN <span class="comment">/* | EPOLLET*/</span>;</span><br><span class="line">  <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;event);</span><br><span class="line"></span><br><span class="line">  <span class="function">EventList <span class="title">events</span><span class="params">(<span class="number">16</span>)</span></span>;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peeraddr;</span><br><span class="line">  <span class="type">socklen_t</span> peerlen;</span><br><span class="line">  <span class="type">int</span> connfd;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> nready;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    nready = <span class="built_in">epoll_wait</span>(epollfd, &amp;*events.<span class="built_in">begin</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(events.<span class="built_in">size</span>()), <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;epoll_wait&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">0</span>) <span class="comment">// ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿ</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * å½“nreadyè¾¾åˆ°eventsçš„å¤§å°ï¼Œè¯´æ˜å¯èƒ½æœ‰æ›´å¤šçš„äº‹ä»¶è§¦å‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">size_t</span>)nready == events.<span class="built_in">size</span>())</span><br><span class="line">      events.<span class="built_in">resize</span>(events.<span class="built_in">size</span>() * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nready; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (events[i].data.fd == listenfd)</span><br><span class="line">      &#123;</span><br><span class="line">        peerlen = <span class="built_in">sizeof</span>(peeraddr);</span><br><span class="line">        connfd = <span class="built_in">accept4</span>(listenfd, (<span class="keyword">struct</span> sockaddr *)&amp;peeraddr,</span><br><span class="line">                         &amp;peerlen, SOCK_NONBLOCK | SOCK_CLOEXEC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connfd == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (errno == EMFILE)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * å‘ç”ŸEMFILEæ—¶çš„å¤„ç†æ–¹æ³•</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">close</span>(idlefd);</span><br><span class="line">            idlefd = <span class="built_in">accept</span>(listenfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">close</span>(idlefd);</span><br><span class="line">            idlefd = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept4&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;ip=&quot;</span> &lt;&lt; <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr) &lt;&lt; <span class="string">&quot; port=&quot;</span> &lt;&lt; <span class="built_in">ntohs</span>(peeraddr.sin_port) &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">        clients.<span class="built_in">push_back</span>(connfd);</span><br><span class="line"></span><br><span class="line">        event.data.fd = connfd;</span><br><span class="line">        event.events = EPOLLIN <span class="comment">/* | EPOLLET*/</span>;</span><br><span class="line">        <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, connfd, &amp;event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)</span><br><span class="line">      &#123;</span><br><span class="line">        connfd = events[i].data.fd;</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">read</span>(connfd, buf, <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">          <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/***</span></span><br><span class="line"><span class="comment">           * è¯´æ˜å¯¹æ–¹æ–­å¼€äº†è¿æ¥</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">          std::cout &lt;&lt; <span class="string">&quot;client close&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">          <span class="built_in">close</span>(connfd);</span><br><span class="line">          event = events[i];</span><br><span class="line">          <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, connfd, &amp;event);</span><br><span class="line">          clients.<span class="built_in">erase</span>(std::<span class="built_in">remove</span>(clients.<span class="built_in">begin</span>(), clients.<span class="built_in">end</span>(), connfd), clients.<span class="built_in">end</span>());</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        std::cout &lt;&lt; buf;</span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * å†™å›å¯¹åº”çš„ å†…å®¹ï¼Œæˆä¸ºechoæœåŠ¡å™¨</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="built_in">write</span>(connfd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CMakeLists.txt</code>é‡Œé¢çš„é…ç½®</p>
<figure class="highlight cmake"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(tinyMuduo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CXX_FLAGS -g -Wall)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER <span class="string">&quot;g++&quot;</span>)</span><br><span class="line"><span class="keyword">string</span>(REPLACE <span class="string">&quot;;&quot;</span> <span class="string">&quot; &quot;</span> CMAKE_CXX_FLAGS <span class="string">&quot;$&#123;CXX_FLAGS&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(main main.cpp) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>build.sh</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line"></span><br><span class="line">SOURCE_DIR=`<span class="built_in">pwd</span>`</span><br><span class="line">BUILD_DIR=<span class="variable">$&#123;BUILD_DIR:-build&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$BUILD_DIR</span> \</span><br><span class="line">  &amp;&amp; <span class="built_in">cd</span> <span class="variable">$BUILD_DIR</span> \</span><br><span class="line">  &amp;&amp; cmake <span class="variable">$SOURCE_DIR</span> \</span><br><span class="line">  &amp;&amp; make $*</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä»£ç è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230103221627821.png" alt="image-20230103221627821"></p>
<h2 id="ç¨‹åºéœ€è¦æ³¨æ„çš„ç‚¹"><a href="#ç¨‹åºéœ€è¦æ³¨æ„çš„ç‚¹" class="headerlink" title="ç¨‹åºéœ€è¦æ³¨æ„çš„ç‚¹"></a>ç¨‹åºéœ€è¦æ³¨æ„çš„ç‚¹</h2><h3 id="å±è”½ä¿¡æ¯"><a href="#å±è”½ä¿¡æ¯" class="headerlink" title="å±è”½ä¿¡æ¯"></a>å±è”½ä¿¡æ¯</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * å±è”½ SIGPIPE SIGCHLD ä¿¡å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="built_in">signal</span>(SIGPIPE, SIG_IGN);</span><br><span class="line"><span class="built_in">signal</span>(SIGCHLD, SIG_IGN);</span><br></pre></td></tr></table></figure>
<p>å±è”½äº†<code>SIGPIPE</code>å’Œ<code>SIGCHLD</code>è¿™ä¸¤ä¸ªä¿¡å·ã€‚<code>SIGPIPE</code>ä¿¡å·æ˜¯å¾€è¯»ç«¯è¢«å…³é—­çš„ç®¡é“æˆ–è€… socket è¿æ¥ä¸­å†™æ•°æ®ï¼Œé»˜è®¤æ˜¯ä¼šç»ˆæ­¢è¿›ç¨‹ï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢è¿™ç§äº‹æƒ…å‡ºç°æˆ‘ä»¬éœ€è¦å±è”½è¿™ä¸ªä¿¡æ¯ã€‚</p>
<h3 id="è§£å†³EMFILEé”™è¯¯"><a href="#è§£å†³EMFILEé”™è¯¯" class="headerlink" title="è§£å†³EMFILEé”™è¯¯"></a>è§£å†³EMFILEé”™è¯¯</h3><p>EMFILEé”™è¯¯æ˜¯è¿›ç¨‹æè¿°ç¬¦ç”¨å®Œçš„é”™è¯¯ï¼Œåœ¨é™ˆç¡•è€å¸ˆçš„è§†é¢‘ä¸­æœ‰ä¸“é—¨è®²è§£è¿™ä¸ªé—®é¢˜ã€‚ç›®å‰çš„è§£å†³æ–¹æ³•ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.è°ƒé«˜è¿›ç¨‹æ–‡ä»¶æè¿°ç¬¦æ•°ç›®</span><br><span class="line">2.æ­»ç­‰</span><br><span class="line">3.é€€å‡ºç¨‹åº</span><br><span class="line">4.å…³é—­ç›‘å¬å¥—æ¥å­—ã€‚é‚£ä»€ä¹ˆæ—¶å€™é‡æ–°æ‰“å¼€å‘¢ï¼Ÿ</span><br><span class="line">5.å¦‚æœæ˜¯epollæ¨¡å‹ï¼Œå¯ä»¥æ”¹ç”¨edge triggerã€‚é—®é¢˜æ˜¯å¦‚æœæ¼æ‰äº†ä¸€æ¬¡accept(2)ï¼Œç¨‹åºå†ä¹Ÿä¸ä¼šæ”¶åˆ°æ–°è¿æ¥ã€‚</span><br><span class="line">6.å‡†å¤‡ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦ã€‚é‡åˆ°è¿™ç§æƒ…å†µï¼Œå…ˆå…³é—­è¿™ä¸ªç©ºé—²æ–‡ä»¶ï¼Œè·å¾—ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åé¢;å†accept(2)æ‹¿åˆ°socketè¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦ï¼›éšåç«‹åˆ»close(2)ï¼Œè¿™æ ·å°±ä¼˜é›…åœ°æ–­å¼€äº†ä¸å®¢æˆ·ç«¯çš„è¿æ¥ï¼›æœ€åé‡æ–°æ‰“å¼€ç©ºé—²æ–‡ä»¶ï¼ŒæŠŠâ€œå‘â€å¡«ä¸Šï¼Œä»¥å¤‡å†æ¬¡å‡ºç°è¿™ç§æƒ…å†µæ—¶ä½¿ç”¨ã€‚</span><br></pre></td></tr></table></figure>
<p>å¾ˆæ˜¾ç„¶æ¨èçš„æ–¹æ³•æ˜¯6ï¼Œä»£ç ä¸­ä½¿ç”¨çš„ä¹Ÿæ˜¯è¿™ç§æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (errno == EMFILE)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * å‘ç”ŸEMFILEæ—¶çš„å¤„ç†æ–¹æ³•</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">close</span>(idlefd);</span><br><span class="line">  idlefd = <span class="built_in">accept</span>(listenfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="built_in">close</span>(idlefd);</span><br><span class="line">  idlefd = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept4&quot;</span>);</span><br></pre></td></tr></table></figure>
<h3 id="é‡‡å–LTæ¨¡å¼"><a href="#é‡‡å–LTæ¨¡å¼" class="headerlink" title="é‡‡å–LTæ¨¡å¼"></a>é‡‡å–LTæ¨¡å¼</h3><p>epolléœ€è¦é‡‡å–LTæ¨¡å‹ï¼Œå¹¶ä¸”ä»¥<strong>éé˜»å¡</strong>çŠ¶æ€è¿›è¡Œã€‚ä¸ºä»€ä¹ˆä¸é‡‡å–ETæ¨¡å¼å‘¢ï¼ŒETæ¨¡å¼ä¸‹EMFILEé”™è¯¯å¤„ç†è¦å¤æ‚ä¸€äº›ï¼Œä¸ºäº†ç®€åŒ–ä»£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡‡å–è¿™ç§LTæ¨¡å¼ã€‚</p>
<p>æ¨¡å¼çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230103221058350.png" alt="image-20230103221058350"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äºEPOLLOUTäº‹ä»¶æˆ‘ä»¬è¿™é‡Œå¹¶æ²¡æœ‰å¤„ç†ï¼Œåªæ˜¯ç®€å•çš„ç›´æ¥å†™å›ï¼Œç†è®ºä¸Šåº”è¯¥åŠ ä¸€å±‚åº”ç”¨å±‚ç¼“å†²åŒºï¼Œè¿™æ˜¯åç»­éœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚</p>
<p>ä»£ç ä»“åº“ï¼š<a href="https://github.com/bugcat9/tinyMuduo/tree/v0.01">https://github.com/bugcat9/tinyMuduo/tree/v0.01</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>muduo</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸‰ï¼‰</title>
    <url>/2023/02/03/Linux/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h1 id="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸‰ï¼‰"><a href="#ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸‰ï¼‰" class="headerlink" title="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸‰ï¼‰"></a>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆä¸‰ï¼‰</h1><p>åŠ å…¥netæ¨¡å—ç›¸å…³ä»£ç ï¼Œnetæ¨¡å—ç›¸å…³ä»£ç æ˜¯muduoåº“çš„ç²¾é«“ï¼Œåé¢çœ‹äº†ä¸€ä¸‹å…¶å®ä¹Ÿæ¯”è¾ƒç®€æ´ï¼Œå®¹æ˜“çœ‹æ‡‚ã€‚</p>
<p>é¦–å…ˆæ˜¯å°†ä¹‹å‰mainä¸­å¤§å¤§çš„whileå¾ªç¯è¿›è¡Œå°è£…ï¼Œç¼–ç¨‹EventLoop</p>
<span id="more"></span>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">assert</span>(!looping_);</span><br><span class="line">    <span class="built_in">assertInLoopThread</span>();</span><br><span class="line">    looping_ = <span class="literal">true</span>;</span><br><span class="line">    quit_ = <span class="literal">false</span>; <span class="comment">// <span class="doctag">FIXME:</span> what if someone calls quit() before loop() ?</span></span><br><span class="line">    LOG_TRACE &lt;&lt; <span class="string">&quot;EventLoop &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; start looping&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!quit_)</span><br><span class="line">    &#123;</span><br><span class="line">        activeChannels_.<span class="built_in">clear</span>();</span><br><span class="line">        pollReturnTime_ = poller_-&gt;<span class="built_in">poll</span>(kPollTimeMs, &amp;activeChannels_);</span><br><span class="line">        ++iteration_;</span><br><span class="line">        <span class="keyword">if</span> (Logger::<span class="built_in">logLevel</span>() &lt;= Logger::TRACE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printActiveChannels</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// TODO sort channel by priority</span></span><br><span class="line">        eventHandling_ = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">for</span> (Channel *channel : activeChannels_)</span><br><span class="line">        &#123;</span><br><span class="line">            currentActiveChannel_ = channel;</span><br><span class="line">            currentActiveChannel_-&gt;<span class="built_in">handleEvent</span>(pollReturnTime_);</span><br><span class="line">        &#125;</span><br><span class="line">        currentActiveChannel_ = <span class="literal">NULL</span>;</span><br><span class="line">        eventHandling_ = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">doPendingFunctors</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG_TRACE &lt;&lt; <span class="string">&quot;EventLoop &quot;</span> &lt;&lt; <span class="keyword">this</span> &lt;&lt; <span class="string">&quot; stop looping&quot;</span>;</span><br><span class="line">    looping_ = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°†é‚£äº›æ–‡ä»¶æè¿°ç¬¦å°è£…æˆ<code>Channel</code>ç±»ï¼Œæ•´ä¸ªç»“æ„å°±æ¯”è¾ƒç®€å•æ˜äº†ã€‚</p>
<p>å¯¹äº<strong>Reactor</strong>æ¨¡å‹å°è£…äº†EventLoopThreadã€EventLoopThreadPool ä¸“é—¨å¤„ç†ioçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯é‚£äº›è¿æ¥ä»¥åŠè¯»å†™ç›¸å…³çš„çº¿ç¨‹ã€‚</p>
<p>å¯¹äºåº”ç”¨å±‚çš„å‘é€å’Œæ¥æ”¶å°è£…äº†bufferç±»ã€‚</p>
<p>æœ€åå°†è¿™ä¸€åˆ‡å°è£…åœ¨TcpServerç±»ä¸­ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å®ç°echoä¹Ÿæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œé¢ç›´æ¥ä½¿ç”¨muduoè‡ªå¸¦çš„å†…å®¹</p>
<p>echo.h:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _ECHO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _ECHO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/TcpServer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// RFC 862</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoServer</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EchoServer</span>(tinyMuduo::net::EventLoop *loop,</span><br><span class="line">               <span class="type">const</span> tinyMuduo::net::InetAddress &amp;listenAddr);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>; <span class="comment">// calls server_.start();</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> tinyMuduo::net::TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> tinyMuduo::net::TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                   tinyMuduo::net::Buffer *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                   tinyMuduo::Timestamp time)</span></span>;</span><br><span class="line"></span><br><span class="line">    tinyMuduo::net::TcpServer server_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _ECHO_H</span></span></span><br></pre></td></tr></table></figure>
<p>echo.cpp</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;echo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/EventLoop.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// using namespace tinyMuduo;</span></span><br><span class="line"><span class="comment">// using namespace tinyMuduo::net;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; <span class="string">&quot;pid = &quot;</span> &lt;&lt; <span class="built_in">getpid</span>();</span><br><span class="line">  tinyMuduo::net::EventLoop loop;</span><br><span class="line">  tinyMuduo::<span class="function">net::InetAddress <span class="title">listenAddr</span><span class="params">(<span class="number">2007</span>)</span></span>;</span><br><span class="line">  <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, listenAddr)</span></span>;</span><br><span class="line">  server.<span class="built_in">start</span>();</span><br><span class="line">  loop.<span class="built_in">loop</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>main.cpp</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;echo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/EventLoop.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// using namespace tinyMuduo;</span></span><br><span class="line"><span class="comment">// using namespace tinyMuduo::net;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; <span class="string">&quot;pid = &quot;</span> &lt;&lt; <span class="built_in">getpid</span>();</span><br><span class="line">  tinyMuduo::net::EventLoop loop;</span><br><span class="line">  tinyMuduo::<span class="function">net::InetAddress <span class="title">listenAddr</span><span class="params">(<span class="number">2007</span>)</span></span>;</span><br><span class="line">  <span class="function">EchoServer <span class="title">server</span><span class="params">(&amp;loop, listenAddr)</span></span>;</span><br><span class="line">  server.<span class="built_in">start</span>();</span><br><span class="line">  loop.<span class="built_in">loop</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ•´ä½“å·®ä¸å¤šå°±æ˜¯è¿™æ ·ï¼Œæ„Ÿè§‰muduoä¹¦å’Œè§†é¢‘è®²çš„å¤ªå¥½äº†ï¼Œæ„Ÿè§‰ä¹Ÿæ²¡ä»€ä¹ˆå¥½å¤šè¯´ï¼Œæ²¡æœ‰è®©äººå†™çš„æ¬²æœ›ã€‚åé¢å¯ä»¥åŠ ä¸€ä¸‹æ•°æ®åº“å’ŒhttpæœåŠ¡ï¼Œæ”¹æˆwebæœåŠ¡å™¨ç®—äº†ã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>muduo</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆäºŒï¼‰</title>
    <url>/2023/02/03/Linux/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h1 id="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆäºŒï¼‰"><a href="#ä»0å¼€å§‹æ„å»ºmuduoï¼ˆäºŒï¼‰" class="headerlink" title="ä»0å¼€å§‹æ„å»ºmuduoï¼ˆäºŒï¼‰"></a>ä»0å¼€å§‹æ„å»ºmuduoï¼ˆäºŒï¼‰</h1><p>åŠ å…¥baseæ¨¡å—ä¸‹ç›¸å…³çš„ä»£ç ï¼Œä¸»è¦æ˜¯å’Œè¿›ç¨‹çº¿ç¨‹ç›¸å…³çš„æ“ä½œå°è£…ï¼ŒåŒ…æ‹¬ï¼šåŸå­ç±»æ“ä½œã€çº¿ç¨‹æ“ä½œã€äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€æ—¥å¿—ç±»ã€‚è¿™äº›åŸç‰ˆéƒ½æ˜¯æ˜¯ä½¿ç”¨pthreadç›¸å…³å®ç°çš„ï¼Œè‡ªå·±å®ç°çš„è¯å¯ä»¥é€šè¿‡C++11è¿›è¡Œå®ç°ä¸€ä¸‹ã€‚</p>
<p>åŠ å…¥baseæ¨¡å—ä¹‹åï¼Œå¯ä»¥å°†echoçš„å¤„ç†æ”¹æˆå¤šçº¿ç¨‹(ä½¿ç”¨çº¿ç¨‹æ± )ã€‚</p>
<p>æˆ‘è¿™é‡Œå®ç°æ˜¯å°†æ¥æ”¶åˆ°çš„æ¶ˆæ¯è¿›è¡Œäº†ä¸€ä¸ªç®€å•çš„ç¿»è½¬ã€‚</p>
<span id="more"></span>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unordered_map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/ThreadPool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/CurrentThread.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/LogFile.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡å®šä¹‰epoll_event æ•°ç»„</span></span><br><span class="line"><span class="keyword">typedef</span> std::vector&lt;epoll_event&gt; EventList;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ERR_EXIT(m)     \</span></span><br><span class="line"><span class="meta">  do                    \</span></span><br><span class="line"><span class="meta">  &#123;                     \</span></span><br><span class="line"><span class="meta">    perror(m);          \</span></span><br><span class="line"><span class="meta">    exit(EXIT_FAILURE); \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PORT 8080</span></span><br><span class="line"></span><br><span class="line">std::unique_ptr&lt;tinyMuduo::LogFile&gt; g_logFile;</span><br><span class="line">std::unordered_map&lt;<span class="type">int</span>, std::string&gt; buf_map;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">outputFunc</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *msg, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  g_logFile-&gt;<span class="built_in">append</span>(msg, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">flushFunc</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  g_logFile-&gt;<span class="built_in">flush</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief Set the Logger object</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setLogger</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  g_logFile.<span class="built_in">reset</span>(<span class="keyword">new</span> tinyMuduo::<span class="built_in">LogFile</span>(<span class="string">&quot;epoll&quot;</span>, <span class="number">500</span> * <span class="number">1000</span> * <span class="number">1000</span>, <span class="literal">false</span>));</span><br><span class="line">  tinyMuduo::Logger::<span class="built_in">setOutput</span>(outputFunc);</span><br><span class="line">  tinyMuduo::Logger::<span class="built_in">setFlush</span>(flushFunc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">strFunc</span><span class="params">(std::string s, <span class="type">const</span> <span class="type">int</span> epollfd, <span class="type">const</span> <span class="type">int</span> connfd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LOG_INFO &lt;&lt; <span class="string">&quot;tid=&quot;</span> &lt;&lt; tinyMuduo::CurrentThread::<span class="built_in">tid</span>() &lt;&lt; s;</span><br><span class="line">  <span class="comment">// å­—ç¬¦ä¸²ç¿»è½¬ï¼Œç›¸å½“äºæ˜¯å¤„ç†è®¡ç®—ä»»åŠ¡</span></span><br><span class="line">  <span class="built_in">reverse</span>(s.<span class="built_in">begin</span>(), s.<span class="built_in">end</span>());</span><br><span class="line">  buf_map[connfd] = s;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ·»åŠ è¯»å–äº‹ä»¶</span></span><br><span class="line">  epoll_event event;</span><br><span class="line">  event.data.fd = connfd;</span><br><span class="line">  event.events = EPOLLOUT;</span><br><span class="line">  <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_MOD, connfd, &amp;event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®æ—¥å¿—</span></span><br><span class="line">  <span class="built_in">setLogger</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * å±è”½ SIGPIPE SIGCHLD ä¿¡å·</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="built_in">signal</span>(SIGPIPE, SIG_IGN);</span><br><span class="line">  <span class="built_in">signal</span>(SIGCHLD, SIG_IGN);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè§£å†³EMFILEé”™è¯¯</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> idlefd = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> listenfd;</span><br><span class="line">  <span class="keyword">if</span> ((listenfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM | SOCK_NONBLOCK | SOCK_CLOEXEC, IPPROTO_TCP)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> servaddr;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;servaddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(servaddr));</span><br><span class="line">  servaddr.sin_family = AF_INET;</span><br><span class="line">  servaddr.sin_port = <span class="built_in">htons</span>(PORT);</span><br><span class="line">  servaddr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***</span></span><br><span class="line"><span class="comment">   * è®¾ç½®ç«¯å£é‡ç”¨ï¼Œæ— éœ€ TIME_WAIT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> on = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEADDR, &amp;on, <span class="built_in">sizeof</span>(on)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr *)&amp;servaddr, <span class="built_in">sizeof</span>(servaddr)) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">listen</span>(listenfd, SOMAXCONN) &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line"></span><br><span class="line">  std::vector&lt;<span class="type">int</span>&gt; clients;</span><br><span class="line">  <span class="type">int</span> epollfd;</span><br><span class="line">  epollfd = <span class="built_in">epoll_create1</span>(EPOLL_CLOEXEC);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">epoll_event</span> event;</span><br><span class="line">  event.data.fd = listenfd;</span><br><span class="line">  event.events = EPOLLIN <span class="comment">/* | EPOLLET*/</span>;</span><br><span class="line">  <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, listenfd, &amp;event);</span><br><span class="line"></span><br><span class="line">  <span class="function">EventList <span class="title">events</span><span class="params">(<span class="number">16</span>)</span></span>;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> peeraddr;</span><br><span class="line">  <span class="type">socklen_t</span> peerlen;</span><br><span class="line">  <span class="type">int</span> connfd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// çº¿ç¨‹æ± ç›¸å…³è®¾ç½®</span></span><br><span class="line">  <span class="function">tinyMuduo::ThreadPool <span class="title">pool</span><span class="params">(<span class="string">&quot;pool&quot;</span>)</span></span>;</span><br><span class="line">  pool.<span class="built_in">start</span>(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> nready;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    nready = <span class="built_in">epoll_wait</span>(epollfd, &amp;*events.<span class="built_in">begin</span>(), <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(events.<span class="built_in">size</span>()), <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (errno == EINTR)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">      <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;epoll_wait&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (nready == <span class="number">0</span>) <span class="comment">// ä»€ä¹ˆéƒ½æ²¡æœ‰å‘ç”Ÿ</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * å½“nreadyè¾¾åˆ°eventsçš„å¤§å°ï¼Œè¯´æ˜å¯èƒ½æœ‰æ›´å¤šçš„äº‹ä»¶è§¦å‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">size_t</span>)nready == events.<span class="built_in">size</span>())</span><br><span class="line">      events.<span class="built_in">resize</span>(events.<span class="built_in">size</span>() * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nready; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (events[i].data.fd == listenfd)</span><br><span class="line">      &#123;</span><br><span class="line">        peerlen = <span class="built_in">sizeof</span>(peeraddr);</span><br><span class="line">        connfd = <span class="built_in">accept4</span>(listenfd, (<span class="keyword">struct</span> sockaddr *)&amp;peeraddr,</span><br><span class="line">                         &amp;peerlen, SOCK_NONBLOCK | SOCK_CLOEXEC);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connfd == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (errno == EMFILE)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="comment">/***</span></span><br><span class="line"><span class="comment">             * å‘ç”ŸEMFILEæ—¶çš„å¤„ç†æ–¹æ³•</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">close</span>(idlefd);</span><br><span class="line">            idlefd = <span class="built_in">accept</span>(listenfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">close</span>(idlefd);</span><br><span class="line">            idlefd = <span class="built_in">open</span>(<span class="string">&quot;/dev/null&quot;</span>, O_RDONLY | O_CLOEXEC);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;accept4&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨æ—¥å¿—</span></span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;ip=&quot;</span> &lt;&lt; <span class="built_in">inet_ntoa</span>(peeraddr.sin_addr) &lt;&lt; <span class="string">&quot; port=&quot;</span> &lt;&lt; <span class="built_in">ntohs</span>(peeraddr.sin_port);</span><br><span class="line"></span><br><span class="line">        clients.<span class="built_in">push_back</span>(connfd);</span><br><span class="line"></span><br><span class="line">        event.data.fd = connfd;</span><br><span class="line">        event.events = EPOLLIN <span class="comment">/* | EPOLLET*/</span>;</span><br><span class="line">        <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_ADD, connfd, &amp;event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)</span><br><span class="line">      &#123;</span><br><span class="line">        connfd = events[i].data.fd;</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">read</span>(connfd, buf, <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">          <span class="built_in">ERR_EXIT</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (ret == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/***</span></span><br><span class="line"><span class="comment">           * è¯´æ˜å¯¹æ–¹æ–­å¼€äº†è¿æ¥</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          LOG_INFO &lt;&lt; <span class="string">&quot;client close&quot;</span>;</span><br><span class="line">          <span class="built_in">close</span>(connfd);</span><br><span class="line">          event = events[i];</span><br><span class="line">          <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_DEL, connfd, &amp;event);</span><br><span class="line">          clients.<span class="built_in">erase</span>(std::<span class="built_in">remove</span>(clients.<span class="built_in">begin</span>(), clients.<span class="built_in">end</span>(), connfd), clients.<span class="built_in">end</span>());</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        LOG_INFO &lt;&lt; buf;</span><br><span class="line">        <span class="comment">// æ”¾å…¥çº¿ç¨‹æ± ä¸­è¿è¡Œ</span></span><br><span class="line">        <span class="comment">// strFunc(std::string(buf), epollfd, connfd);</span></span><br><span class="line">        pool.<span class="built_in">run</span>(std::<span class="built_in">bind</span>(strFunc, std::<span class="built_in">string</span>(buf), epollfd, connfd));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLOUT)</span><br><span class="line">      &#123;</span><br><span class="line">        connfd = events[i].data.fd;</span><br><span class="line">        <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buf_map.<span class="built_in">count</span>(connfd))</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">// è¯»å–å¤„ç†å¥½çš„ç¼“å­˜</span></span><br><span class="line">          std::string s = buf_map[connfd];</span><br><span class="line">          <span class="type">const</span> <span class="type">char</span> *buf = s.<span class="built_in">c_str</span>();</span><br><span class="line">          <span class="built_in">write</span>(connfd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">          <span class="comment">// åˆ é™¤ç¼“å­˜</span></span><br><span class="line">          buf_map.<span class="built_in">erase</span>(connfd);</span><br><span class="line">          <span class="comment">// å†™å®Œåå°†äº‹ä»¶æ”¹ä¸ºç›‘å¬</span></span><br><span class="line">          event = events[i];</span><br><span class="line">          event.events = EPOLLIN;</span><br><span class="line">          <span class="built_in">epoll_ctl</span>(epollfd, EPOLL_CTL_MOD, connfd, &amp;event);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          LOG_ERROR &lt;&lt; <span class="string">&quot;connfd &quot;</span> &lt;&lt; connfd &lt;&lt; <span class="string">&quot;dont have buf&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>muduo</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLiteå­¦ä¹ </title>
    <url>/2021/08/23/Android%E5%AD%A6%E4%B9%A0/SQLite%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="SQLiteå­¦ä¹ "><a href="#SQLiteå­¦ä¹ " class="headerlink" title="SQLiteå­¦ä¹ "></a>SQLiteå­¦ä¹ </h1><p>SQLiteæ˜¯Androidè‡ªå¸¦çš„æ•°æ®åº“ï¼Œæ˜¯å­¦ä¹ <code>Android</code>æ‰€å¿…é¡»äº†è§£çš„å†…å®¹ä¹‹ä¸€ã€‚</p>
<p>ç”±äºJDBCï¼ˆJava DataBase Connectivity,javaæ•°æ®åº“è¿æ¥ï¼‰æ˜¯ä¸€ç§ç”¨äºæ‰§è¡ŒSQLè¯­å¥çš„Java APIï¼Œä¼šæ¶ˆè€—å¤ªå¤šçš„ç³»ç»Ÿèµ„æºï¼Œå¯¹äºæ‰‹æœºè¿™ç§å†…å­˜å—é™è®¾å¤‡æ¥è¯´å¹¶ä¸åˆé€‚ã€‚å› æ­¤Android æä¾›äº†ä¸€äº›æ–°çš„ API æ¥ä½¿ç”¨ SQLite æ•°æ®åº“ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">æ•°æ®åº“å­˜å‚¨åœ¨ data/data/&lt; é¡¹ç›®æ–‡ä»¶å¤¹ &gt;/databases/ ä¸‹ã€‚</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ¯”è¾ƒå¥½çš„å­¦ä¹ è¯¥éƒ¨åˆ†å†…å®¹æˆ‘ä»¬éœ€è¦ä¸¾ä¸ªä¾‹å­ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥å­¦ç”Ÿè¡¨æ ¼(å­¦ç”Ÿè¡¨æ ¼å¹³æ—¶ï¼Œå¹³æ—¶å­¦ä¹ æœ€å¤š)ä¸ºä¾‹æ¥å­¦ä¹ è¯¥å†…å®¹ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>_id</th>
<th>uuid</th>
<th>name</th>
<th>birth_date</th>
<th>gender</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>12154453131</td>
<td>zhangsan</td>
<td>1309564646</td>
<td>0</td>
</tr>
<tr>
<td>2</td>
<td>87478478994</td>
<td>lisi</td>
<td>1235465487</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<span id="more"></span>
<h2 id="å®šä¹‰è¡¨æ ¼æ¶æ„"><a href="#å®šä¹‰è¡¨æ ¼æ¶æ„" class="headerlink" title="å®šä¹‰è¡¨æ ¼æ¶æ„"></a>å®šä¹‰è¡¨æ ¼æ¶æ„</h2><p>å®šä¹‰è¡¨æ ¼çš„è¯æˆ‘ä»¬å…ˆåˆ›å»ºå­¦ç”Ÿç±»ï¼Œå­¦ç”Ÿç±»å½“ä¸­æœ‰å¯¹åº”çš„<code>get</code>å’Œ<code>set</code>å‡½æ•°ï¼Œæ•´ä¸ªç±»æ¯”è¾ƒç®€å•ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> UUID mUUID;</span><br><span class="line">    <span class="keyword">private</span> String mName;</span><br><span class="line">    <span class="keyword">private</span> Date mBirthDate;</span><br><span class="line">    <span class="keyword">private</span> Boolean mGender;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> UUID <span class="title function_">getUUID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mUUID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUUID</span><span class="params">(UUID UUID)</span> &#123;</span><br><span class="line">        mUUID = UUID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        mName = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">getBirthDate</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mBirthDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBirthDate</span><span class="params">(Date birthDate)</span> &#123;</span><br><span class="line">        mBirthDate = birthDate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Boolean <span class="title function_">getGender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mGender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGender</span><span class="params">(Boolean mgender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mGender = mgender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºæ•°æ®åº“æˆ‘ä»¬åˆ›å»º<code>StudentSchema</code>ç±»ï¼Œå°†éœ€è¦çš„è¡¨åå’Œè¡¨å­—æ®µæ”¾åœ¨ä¸€èµ·</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.sqlitelearn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentSchema</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StudentTable</span> &#123;</span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         * æ•°æ®åº“è¡¨å</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TABLE_NAME</span> <span class="operator">=</span> <span class="string">&quot;Student&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">         *å®šä¹‰æ•°æ®è¡¨å­—æ®µ</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cols</span> &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UUID</span> <span class="operator">=</span> <span class="string">&quot;uuid&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NAME</span> <span class="operator">=</span> <span class="string">&quot;name&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BIRTH_DATE</span> <span class="operator">=</span> <span class="string">&quot;birth_date&quot;</span>;</span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GENDER</span> <span class="operator">=</span> <span class="string">&quot;gender&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸ºå•¥è¿™æ ·æ”¾å‘¢ï¼Œæˆ‘çœ‹å®˜æ–¹çš„ä¾‹å­å’Œã€ŠAndroidæƒå¨ç¼–ç¨‹æŒ‡å—ã€‹ä¸Šä½¿ç”¨çš„ç±»éƒ½æ˜¯è¿™æ ·ï¼Œä¸Šé¢çš„è§£é‡Šæ˜¯è¯´æœ‰äº†è¿™äº›æ•°æ®è¡¨å…ƒç´ ï¼Œå°±å¯ä»¥åœ¨Javaä»£ç ä¸­å®‰å…¨åœ°å¼•ç”¨ï¼Œæ¯”å¦‚ï¼š<code>StudentTable.Cols.NAME</code>å°±æ˜¯æŒ‡å‘<code>student</code>çš„<code>name</code>å­—æ®µï¼Œå¹¶ä¸”è¿™è¿˜ç»™ä¿®æ”¹å­—æ®µåç§°æˆ–æ–°å¢è¡¨å…ƒç´ å¸¦æ¥äº†æ–¹ä¾¿ã€‚</p>
<h2 id="åˆ›å»ºæ•°æ®åº“"><a href="#åˆ›å»ºæ•°æ®åº“" class="headerlink" title="åˆ›å»ºæ•°æ®åº“"></a>åˆ›å»ºæ•°æ®åº“</h2><h3 id="ç¼–å†™å»ºè¡¨è¯­å¥"><a href="#ç¼–å†™å»ºè¡¨è¯­å¥" class="headerlink" title="ç¼–å†™å»ºè¡¨è¯­å¥"></a>ç¼–å†™å»ºè¡¨è¯­å¥</h3><p>åˆ›å»ºæ•°æ®åº“éœ€è¦å…ˆå†™å¯¹åº”çš„è¯­å¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * åˆ›å»ºæ•°æ®è¡¨è¯­å¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_CREATE_ENTRIES</span> <span class="operator">=</span></span><br><span class="line">        <span class="string">&quot;CREATE TABLE &quot;</span> + StudentTable.TABLE_NAME + <span class="string">&quot; (&quot;</span> +</span><br><span class="line">                <span class="string">&quot;_id integer primary key autoincrement,&quot;</span> +</span><br><span class="line">                StudentTable.Cols.UUID + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                StudentTable.Cols.NAME + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                StudentTable.Cols.BIRTH_DATE + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                StudentTable.Cols.GENDER + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***</span></span><br><span class="line"><span class="comment"> * åˆ é™¤æ•°æ®è¡¨è¯­å¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_DELETE_ENTRIES</span> <span class="operator">=</span></span><br><span class="line">        <span class="string">&quot;DROP TABLE IF EXISTS &quot;</span> + StudentTable.TABLE_NAME;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="ç»§æ‰¿SQLiteDatabase"><a href="#ç»§æ‰¿SQLiteDatabase" class="headerlink" title="ç»§æ‰¿SQLiteDatabase"></a>ç»§æ‰¿<code>SQLiteDatabase</code></h3><p>ç¼–å†™æ•°æ®åº“è¯­å¥ä¹‹åæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª<code>SQLiteDatabase</code>å®ä¾‹ï¼Œç„¶åæ‰èƒ½è¿›è¡Œæ•°æ®åº“ç›¸å…³å¾—åˆ›å»ºå’Œæ“ä½œï¼Œè¿™ä¸ªå¯ä»¥ä½¿ç”¨<code>Android</code>æä¾›çš„<code>Context</code>åº•å±‚æ–¹æ³•<code>openOrCreateDatabase(...)</code>å’Œ<code>databaseList()</code>ï¼Œæ‰“å¼€æ•°æ®åº“æ–‡ä»¶å¹¶å°†å…¶è½¬åŒ–ä¸º<code>SQLiteDatabase</code>å®ä¾‹ï¼Œä½†æ˜¯æ¨èçš„åšæ³•æ˜¯ä½¿ç”¨<code>SQLiteOpenHelper</code>æ¥è¾…åŠ©æˆ‘ä»¬å®Œæˆæ•°æ®åº“è¡¨çš„åˆ›å»ºå’Œåˆ é™¤ã€‚</p>
<p><code>SQLiteOpenHelper</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæˆ‘ä»¬åˆ›å»º<code>StudentBaseHelper</code>æ¥ç»§æ‰¿å®ƒã€‚ç»§æ‰¿ä¹‹åå¿…é¡»å®Œæˆæ„é€ å‡½æ•° ã€<code>onCreate</code>å’Œ<code>onUpgrade</code></p>
<p>å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentBaseHelper</span> <span class="keyword">extends</span> <span class="title class_">SQLiteOpenHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERSION</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DATABASE_NAME</span> <span class="operator">=</span> <span class="string">&quot;studentBase.db&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºæ•°æ®è¡¨è¯­å¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_CREATE_ENTRIES</span> <span class="operator">=</span></span><br><span class="line">            <span class="string">&quot;CREATE TABLE &quot;</span> + StudentTable.TABLE_NAME + <span class="string">&quot; (&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;_id integer primary key autoincrement,&quot;</span> +</span><br><span class="line">                    StudentTable.Cols.UUID + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                    StudentTable.Cols.NAME + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                    StudentTable.Cols.BIRTH_DATE + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                    StudentTable.Cols.GENDER + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/***</span></span><br><span class="line"><span class="comment">     * åˆ é™¤æ•°æ®è¡¨è¯­å¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SQL_DELETE_ENTRIES</span> <span class="operator">=</span></span><br><span class="line">            <span class="string">&quot;DROP TABLE IF EXISTS &quot;</span> + StudentTable.TABLE_NAME;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StudentBaseHelper</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, DATABASE_NAME, <span class="literal">null</span>, VERSION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(SQLiteDatabase db)</span> &#123;</span><br><span class="line">        db.execSQL(SQL_CREATE_ENTRIES);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="type">int</span> oldVersion, <span class="type">int</span> newVersion)</span> &#123;</span><br><span class="line">        <span class="comment">//å…ˆåˆ é™¤å†åˆ›å»º</span></span><br><span class="line">        <span class="keyword">if</span> (oldVersion &lt; newVersion) &#123;</span><br><span class="line">            db.execSQL(SQL_DELETE_ENTRIES);</span><br><span class="line">            onCreate(db);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onCreate(SQLiteDatabase)</code>æ–¹æ³•è´Ÿè´£åˆ›å»ºåˆå§‹æ•°æ®åº“,ä»£ç æ¯”è¾ƒç®€å•ã€‚</p>
<p><code>onUpgrade(SQLiteDatabase, int, int)</code>æ–¹æ³•è´Ÿè´£ä¸å‡çº§ç›¸å…³çš„å·¥ä½œï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬åç»­å¦‚æœåç»­å¦‚æœå‡çº§äº†è½¯ä»¶çš„ç‰ˆæœ¬ï¼Œå°±éœ€è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬é‡‡å–çš„æ–¹æ³•æ˜¯å…ˆåˆ é™¤å†åˆ›å»ºï¼Œè¿™æ ·ä¼šæŠŠåŸæ¥çš„è¡¨åˆ é™¤å†åˆ›å»ºä¸€ä¸ªï¼Œè¿™æ ·çš„è¯ä¼šä½¿ç”¨åŸæ¥çš„æ•°æ®æ¶ˆå¤±ï¼Œä¸è¿‡åœ¨è¿™é‡Œæ˜¯ç»™å®šä¸€ä¸ªä¾‹å­æ‰€ä»¥ä¸ç”¨è€ƒè™‘è¿™ä¹ˆå¤šï¼Œç°å®ä¸­å¼€å‘çš„è¯ï¼Œæ•°æ®ä¹Ÿä¼šåœ¨åç«¯ä¿å­˜åœ¨æ•°æ®åº“ä¸Šï¼Œåœ¨<code>Android</code>éƒ¨åˆ†ä¹Ÿåªèµ·åˆ°ä¸€ä¸ªç¼“å­˜ä½œç”¨æ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒã€‚</p>
<p>ç›®å‰æˆ‘æƒ³å®éªŒè°ƒç”¨<code>onUpgrade</code>æ–¹æ³•ï¼Œä½†æ˜¯æ”¹å˜ç‰ˆæœ¬å·ä¹‹åè¯¥æ–¹æ³•ä¹Ÿæ²¡æœ‰è¢«è°ƒç”¨ä¸çŸ¥é“æ˜¯ä¸ºå•¥ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒç”¨</p>
<p>æ¥ç€æˆ‘ä»¬åœ¨<code>MainActivity</code>ä¸­å®ä¾‹åŒ–<code>SQLiteOpenHelper</code>ï¼Œç„¶ååˆ›å»º<code>SQLiteDatabase</code>å®ä¾‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">AppCompatActivity</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> SQLiteDatabase mDatabase;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">//åˆ›å»ºSQLiteDatabaseå®ä¾‹</span></span><br><span class="line">        mDatabase = <span class="keyword">new</span> <span class="title class_">StudentBaseHelper</span>(<span class="built_in">this</span>).getWritableDatabase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p>è¿è¡Œç¨‹åºä¹‹å</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210824165234403.png" alt="image-20210824165234403"></p>
<p>å¯ä»¥æŸ¥çœ‹åˆ°<code>studentBase.db</code>ç”Ÿæˆäº†</p>
<h2 id="æ’å…¥æ•°æ®åº“"><a href="#æ’å…¥æ•°æ®åº“" class="headerlink" title="æ’å…¥æ•°æ®åº“"></a>æ’å…¥æ•°æ®åº“</h2><p>æ•°æ®çš„å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œå…ˆè®²è§£æ’å…¥æ“ä½œ</p>
<h3 id="ä½¿ç”¨-ContentValues"><a href="#ä½¿ç”¨-ContentValues" class="headerlink" title="ä½¿ç”¨ ContentValues"></a>ä½¿ç”¨ <code>ContentValues</code></h3><p>è´Ÿè´£å¤„ç†æ•°æ®åº“å†™å…¥å’Œæ›´æ–°æ“ä½œçš„è¾…åŠ©ç±»æ˜¯<code>ContentValues</code>ã€‚å®ƒæ˜¯ä¸€ä¸ªé”®å€¼å­˜å‚¨ç±»ï¼Œç±»ä¼¼äº <code>Java</code>çš„<code>HashMap</code>å’Œå‰é¢ç”¨è¿‡çš„<code>Bundle</code>ã€‚ä¸åŒçš„æ˜¯ï¼Œ<code>ContentValues</code>åªèƒ½ç”¨äºå¤„ç†<code>SQLite</code>æ•°æ®ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ContentValues <span class="title function_">getContentValues</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">    <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContentValues</span>();</span><br><span class="line">    values.put(StudentTable.Cols.UUID, student.getUUID().toString());</span><br><span class="line">    values.put(StudentTable.Cols.NAME, student.getName());</span><br><span class="line">    values.put(StudentTable.Cols.BIRTH_DATE, student.getBirthDate().getTime());</span><br><span class="line">    values.put(StudentTable.Cols.GENDER, student.getGender() ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> values;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™æ’å…¥ä»£ç "><a href="#ç¼–å†™æ’å…¥ä»£ç " class="headerlink" title="ç¼–å†™æ’å…¥ä»£ç "></a>ç¼–å†™æ’å…¥ä»£ç </h3><p>æ’å…¥è°ƒç”¨<code>insert(String, String, ContentValues)</code>æ–¹æ³•å°±è¡Œï¼Œæ–¹æ³•çš„ç¬¬ä¸€å’Œç¬¬ä¸‰ä¸ªå‚æ•°å¾ˆé‡è¦ï¼Œç¬¬äºŒä¸ªå¾ˆå°‘ç”¨åˆ°ã€‚ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•°æ®è¡¨åï¼ˆStudentTable.TABLE_NAMEï¼‰ï¼Œç¬¬ä¸‰ä¸ªæ˜¯è¦å†™å…¥çš„æ•°æ®ã€‚ç¬¬äºŒä¸ªå‚æ•°ä½¿ç”¨å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ğŸ‘‰<a href="https://developer.android.com/reference/android/database/sqlite/SQLiteDatabase#insert(java.lang.String,%20java.lang.String,%20android.content.ContentValues">https://developer.android.com/reference/android/database/sqlite/SQLiteDatabase#insert(java.lang.String,%20java.lang.String,%20android.content.ContentValues</a>)</p>
<p><code>insert(String, String, ContentValues)</code>æ–¹æ³•çš„è¿”å›å€¼æ˜¯longç±»å‹ï¼Œä»£è¡¨æ–°æ’å…¥è¡Œçš„è¡Œ IDï¼Œå¹¶ä¸”å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œåˆ™è¿”å›-1</p>
<p>æˆ‘ä»¬å¯ä»¥å†™å‡ºè¯¥æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">addStudent</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">    <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> getContentValues(student);</span><br><span class="line">    <span class="type">long</span> <span class="variable">newRowId</span> <span class="operator">=</span> mDatabase.insert(StudentTable.TABLE_NAME, <span class="literal">null</span>, values);</span><br><span class="line">    <span class="keyword">return</span> newRowId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨<code>onCreate</code>ä¸­è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">      <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">      setContentView(R.layout.activity_main);</span><br><span class="line">      <span class="comment">//åˆ›å»ºSQLiteDatabaseå®ä¾‹</span></span><br><span class="line">      mDatabase = <span class="keyword">new</span> <span class="title class_">StudentBaseHelper</span>(<span class="built_in">this</span>).getWritableDatabase();</span><br><span class="line"></span><br><span class="line">      <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">      student.setUUID(UUID.randomUUID());</span><br><span class="line">      student.setName(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">      student.setBirthDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">      student.setGender(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//æ·»åŠ å­¦ç”Ÿ</span></span><br><span class="line">      <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> addStudent(student);</span><br><span class="line">      <span class="keyword">if</span> (id == -<span class="number">1</span>) &#123;</span><br><span class="line">          Log.d(TAG, <span class="string">&quot;add student fail&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          Log.d(TAG, <span class="string">&quot;add student success and id=&quot;</span> + id);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œç»“æœ-1"><a href="#è¿è¡Œç»“æœ-1" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210824224153789.png" alt="image-20210824224153789"></p>
<p>ä½¿ç”¨<code>SQLiteStudio</code>è¿›è¡ŒæŸ¥çœ‹ç”Ÿæˆçš„dbæ–‡ä»¶</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210824225156765.png" alt="image-20210824225156765"></p>
<h2 id="ä»æ•°æ®åº“ä¸­è¯»å–ä¿¡æ¯"><a href="#ä»æ•°æ®åº“ä¸­è¯»å–ä¿¡æ¯" class="headerlink" title="ä»æ•°æ®åº“ä¸­è¯»å–ä¿¡æ¯"></a>ä»æ•°æ®åº“ä¸­è¯»å–ä¿¡æ¯</h2><h3 id="queryå‡½æ•°"><a href="#queryå‡½æ•°" class="headerlink" title="queryå‡½æ•°"></a><code>query</code>å‡½æ•°</h3><p>è¯»å–æ•°æ®éœ€è¦ç”¨åˆ°<code>SQLiteDatabase.query(...)</code>æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•æœ‰å¥½å‡ ä¸ªé‡è½½ç‰ˆæœ¬ï¼Œå…·ä½“çš„éœ€è¦æŸ¥è¯¢å®˜æ–¹æä¾›çš„æ–‡æ¡£ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª<code>Cursor</code>ç±»å‹ã€‚æˆ‘ä»¬æœ¬æ¬¡ä½¿ç”¨çš„ä½¿ç”¨çš„<code>query</code>æ˜¯ä¸‹é¢é‚£ä¸ªç‰ˆæœ¬</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Cursor <span class="title function_">query</span><span class="params">( </span></span><br><span class="line"><span class="params"> String table, //æ•°æ®åº“è¡¨å</span></span><br><span class="line"><span class="params"> String[] columns, //æŸ¥è¯¢çš„åˆ—åï¼Œå¦‚æœä¸º<span class="literal">null</span>ï¼Œåˆ™è¿”å›æ‰€ä»¥åˆ—</span></span><br><span class="line"><span class="params"> String where, //whereæ¡ä»¶è¯­å¥ï¼Œå…¶ä¸­æœ‰?ä½œä¸ºå ä½ç¬¦</span></span><br><span class="line"><span class="params"> String[] whereArgs, //å¯¹åº”å ä½ç¬¦ç›¸åº”çš„å†…å®¹</span></span><br><span class="line"><span class="params"> String groupBy, //åˆ†ç»„</span></span><br><span class="line"><span class="params"> String having, </span></span><br><span class="line"><span class="params"> String orderBy, //æ’åº</span></span><br><span class="line"><span class="params"> String limit)</span> </span><br></pre></td></tr></table></figure>
<p>å¦‚æœå­¦è¿‡æ•°æ®åº“ï¼Œåº”è¯¥å¯¹ä¸Šé¢è¿™äº›å‚æ•°éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œå…·ä½“éœ€è¦å‘æ•°æ®åº“æ–¹é¢ç»†è®²ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p>
<h3 id="ç¼–å†™å¯¹åº”çš„å‡½æ•°"><a href="#ç¼–å†™å¯¹åº”çš„å‡½æ•°" class="headerlink" title="ç¼–å†™å¯¹åº”çš„å‡½æ•°"></a>ç¼–å†™å¯¹åº”çš„å‡½æ•°</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Cursor <span class="title function_">queryStudents</span><span class="params">(String whereClause, String[] whereArgs)</span> &#123;</span><br><span class="line">    <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> mDatabase.query(</span><br><span class="line">            StudentTable.TABLE_NAME,</span><br><span class="line">            <span class="literal">null</span>, <span class="comment">// Columns - null selects all columns</span></span><br><span class="line">            whereClause,</span><br><span class="line">            whereArgs,</span><br><span class="line">            <span class="literal">null</span>, <span class="comment">// groupBy</span></span><br><span class="line">            <span class="literal">null</span>, <span class="comment">// having</span></span><br><span class="line">            <span class="literal">null</span> <span class="comment">// orderBy</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> cursor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çš„æ—¶å€™éœ€è¦è¿™æ ·ä½¿ç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> queryStudents(StudentTable.Cols.NAME + <span class="string">&quot;=?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;zhangsan&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨CursorWrapper"><a href="#ä½¿ç”¨CursorWrapper" class="headerlink" title="ä½¿ç”¨CursorWrapper"></a>ä½¿ç”¨<code>CursorWrapper</code></h3><p><code>Cursor</code>åœ¨æˆ‘ç†è§£çœ‹æ¥æœ‰ç‚¹ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„æ¸¸æ ‡ï¼Œç”±äºä»<code>Curor</code>ä¸­æå–çš„ä»£ç éƒ½ç±»ä¼¼åŸºæœ¬ä¸Šéƒ½æ˜¯è°ƒç”¨<code>cursor.getColumnIndex</code>æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘ä½¿ç”¨<code>CursorWrapper</code>é‡Œé¢æä¾›ä¸€äº›å°è£…å¥½äº†å‡½æ•°ï¼Œæ–¹ä¾¿æˆ‘ä»¬ä½¿ç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentCursorWrapper</span> <span class="keyword">extends</span> <span class="title class_">CursorWrapper</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a cursor wrapper.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cursor The underlying cursor to wrap.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">StudentCursorWrapper</span><span class="params">(Cursor cursor)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(cursor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">getStudent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">uuidString</span> <span class="operator">=</span> getString(getColumnIndex(StudentTable.Cols.UUID));</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getString(getColumnIndex(StudentTable.Cols.NAME));</span><br><span class="line">        <span class="type">long</span> <span class="variable">date</span> <span class="operator">=</span> getLong(getColumnIndex(StudentTable.Cols.BIRTH_DATE));</span><br><span class="line">        <span class="type">int</span> <span class="variable">gender</span> <span class="operator">=</span> getInt(getColumnIndex(StudentTable.Cols.GENDER));</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        student.setUUID(UUID.fromString(uuidString));</span><br><span class="line">        student.setName(name);</span><br><span class="line">        student.setBirthDate(<span class="keyword">new</span> <span class="title class_">Date</span>(date));</span><br><span class="line">        student.setGender(gender != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> student;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œç»“æœ-2"><a href="#è¿è¡Œç»“æœ-2" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p>æˆ‘ä»¬åœ¨<code>onCreate</code>ä¸­è°ƒç”¨è¿™ä¸ªä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">//åˆ›å»ºSQLiteDatabaseå®ä¾‹</span></span><br><span class="line">        mDatabase = <span class="keyword">new</span> <span class="title class_">StudentBaseHelper</span>(<span class="built_in">this</span>).getWritableDatabase();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Student student = new Student();</span></span><br><span class="line"><span class="comment">//        student.setUUID(UUID.randomUUID());</span></span><br><span class="line"><span class="comment">//        student.setName(&quot;zhangsan&quot;);</span></span><br><span class="line"><span class="comment">//        student.setBirthDate(new Date());</span></span><br><span class="line"><span class="comment">//        student.setGender(true);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        long id = addStudent(student);</span></span><br><span class="line"><span class="comment">//        if (id == -1) &#123;</span></span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;add student fail&quot;);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;add student success and id=&quot; + id);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> queryStudents(StudentTable.Cols.NAME + <span class="string">&quot;=?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;zhangsan&quot;</span>&#125;);</span><br><span class="line">        <span class="type">StudentCursorWrapper</span> <span class="variable">cursorWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentCursorWrapper</span>(cursor);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;æŸ¥æ— æ­¤äºº&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cursorWrapper.moveToFirst();</span><br><span class="line">                <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> cursorWrapper.getStudent();</span><br><span class="line">                <span class="comment">//æ‰“å°uuid</span></span><br><span class="line">                Log.d(TAG, student.getUUID().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cursorWrapper.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŸ¥è¯¢<code>zhangsan</code>å¹¶æ‰“å°ä»–çš„<code>uuid</code>ï¼Œç»“åˆå‰é¢ä½¿ç”¨<code>SQLiteStudio</code>æŸ¥çœ‹çš„ä¿¡æ¯ï¼Œå‘ç°æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿè¯´æ˜äº†æˆ‘ä»¬è®¿é—®åˆ°äº†æ•°æ®åº“ä¸­çš„ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦è®¿é—®ä¸è¦ä¿¡æ¯ï¼Œåªéœ€è¦å†™ä¸åŒçš„whereè¯­å¥å°±è¡Œï¼Œè¿™éƒ¨åˆ†è‡ªè¡ŒæŸ¥é˜…æ•°æ®åº“çŸ¥è¯†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210825155657523.png" alt="image-20210825155657523"></p>
<h2 id="æ›´æ–°æ•°æ®åº“"><a href="#æ›´æ–°æ•°æ®åº“" class="headerlink" title="æ›´æ–°æ•°æ®åº“"></a>æ›´æ–°æ•°æ®åº“</h2><h3 id="updateå‡½æ•°"><a href="#updateå‡½æ•°" class="headerlink" title="updateå‡½æ•°"></a><code>update</code>å‡½æ•°</h3><p>æ›´æ–°æ•°æ®åº“ä¿¡æ¯ä½¿ç”¨çš„æ˜¯<code>update</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ‰ç‚¹ç±»ä¼¼äº<code>insert()</code>å‡½æ•°ï¼Œä½†æ˜¯å…¶ä¸­çš„<code>whereClause</code>å’Œ<code>whereArgs</code>æœ‰ç‚¹ç±»ä¼¼äº<code>query()</code>å‡½æ•°ï¼Œç®€å•ç†è§£å°±æ˜¯é€šè¿‡<code>whereClause</code>å’Œ<code>whereArgs</code>æŸ¥è¯¢å¯¹åº”çš„æ•°æ®ï¼Œå¹¶æŠŠä»–ä»¬æ›´æ”¹ä¸º<code>values</code>ï¼Œè¿™ä¸ª<code>int</code>ç±»å‹çš„è¿”å›å€¼ä»£è¡¨å½±å“äº†å¤šå°‘è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">update</span> <span class="params">(String table, </span></span><br><span class="line"><span class="params">                ContentValues values, </span></span><br><span class="line"><span class="params">                String whereClause, </span></span><br><span class="line"><span class="params">                String[] whereArgs)</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™æ›´æ–°ä»£ç "><a href="#ç¼–å†™æ›´æ–°ä»£ç " class="headerlink" title="ç¼–å†™æ›´æ–°ä»£ç "></a>ç¼–å†™æ›´æ–°ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">updateStudent</span><span class="params">(Student student)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">uuidString</span> <span class="operator">=</span> student.getUUID().toString();</span><br><span class="line">    <span class="type">ContentValues</span> <span class="variable">values</span> <span class="operator">=</span> getContentValues(student);</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> mDatabase.update(StudentTable.TABLE_NAME, values,</span><br><span class="line">            StudentTable.Cols.UUID + <span class="string">&quot;=?&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;uuidString&#125;);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œç»“æœ-3"><a href="#è¿è¡Œç»“æœ-3" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p>æˆ‘ä»¬æŸ¥æ‰¾zhangsanå¹¶ä¸”æŠŠä»–åå­—æ”¹ä¸ºlisi</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        <span class="comment">//åˆ›å»ºSQLiteDatabaseå®ä¾‹</span></span><br><span class="line">        mDatabase = <span class="keyword">new</span> <span class="title class_">StudentBaseHelper</span>(<span class="built_in">this</span>).getWritableDatabase();</span><br><span class="line"><span class="comment">//        Student student = new Student();</span></span><br><span class="line"><span class="comment">//        student.setUUID(UUID.randomUUID());</span></span><br><span class="line"><span class="comment">//        student.setName(&quot;zhangsan&quot;);</span></span><br><span class="line"><span class="comment">//        student.setBirthDate(new Date());</span></span><br><span class="line"><span class="comment">//        student.setGender(true);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        long id = addStudent(student);</span></span><br><span class="line"><span class="comment">//        if (id == -1) &#123;</span></span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;add student fail&quot;);</span></span><br><span class="line"><span class="comment">//        &#125; else &#123;</span></span><br><span class="line"><span class="comment">//            Log.d(TAG, &quot;add student success and id=&quot; + id);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Cursor</span> <span class="variable">cursor</span> <span class="operator">=</span> queryStudents(StudentTable.Cols.NAME + <span class="string">&quot;=?&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;zhangsan&quot;</span>&#125;);</span><br><span class="line">        <span class="type">StudentCursorWrapper</span> <span class="variable">cursorWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentCursorWrapper</span>(cursor);</span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (cursor.getCount() == <span class="number">0</span>) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;æŸ¥æ— æ­¤äºº&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                cursorWrapper.moveToFirst();</span><br><span class="line">                student = cursorWrapper.getStudent();</span><br><span class="line">                Log.d(TAG, student.getUUID().toString());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            cursorWrapper.close();</span><br><span class="line">        &#125;</span><br><span class="line">        student.setName(<span class="string">&quot;lisi&quot;</span>);</span><br><span class="line">        updateStudent(student);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ›´æ”¹æˆåŠŸ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210825164221338.png" alt="image-20210825164221338"></p>
<h2 id="åˆ é™¤æ•°æ®åº“ä¸­ç›¸å…³ä¿¡æ¯"><a href="#åˆ é™¤æ•°æ®åº“ä¸­ç›¸å…³ä¿¡æ¯" class="headerlink" title="åˆ é™¤æ•°æ®åº“ä¸­ç›¸å…³ä¿¡æ¯"></a>åˆ é™¤æ•°æ®åº“ä¸­ç›¸å…³ä¿¡æ¯</h2><p>åˆ é™¤å‡½æ•°è°ƒç”¨çš„æ˜¯<code>delete()</code>å‡½æ•°ï¼Œçœ‹äº†å‰é¢çš„æŸ¥æ‰¾å’Œæ›´æ–°ååˆ é™¤å‡½æ•°è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">delete</span> <span class="params">(String table, </span></span><br><span class="line"><span class="params">                String whereClause, </span></span><br><span class="line"><span class="params">                String[] whereArgs)</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™åˆ é™¤ä»£ç "><a href="#ç¼–å†™åˆ é™¤ä»£ç " class="headerlink" title="ç¼–å†™åˆ é™¤ä»£ç "></a>ç¼–å†™åˆ é™¤ä»£ç </h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">deleteStudent</span><span class="params">(String whereClause, String[] whereArgs)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mDatabase.delete(StudentTable.TABLE_NAME, whereClause, whereArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è¿è¡Œç»“æœ-4"><a href="#è¿è¡Œç»“æœ-4" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h3><p>æˆ‘ä»¬è¿è¡Œ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">deleteStudent(</span><br><span class="line">        StudentTable.Cols.NAME + <span class="string">&quot;=?&quot;</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;lisi&quot;</span>&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210825165546907.png" alt="image-20210825165546907"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>SQLiteæ•°æ®åº“çš„å¢åˆ æ”¹æŸ¥æ€»ç®—å¤§åŠŸå‘Šæˆï¼Œè‡ªå·±ç…§ç€ä¹¦ä¸Šå­¦çš„å†™ä¹Ÿå­¦åˆ°ä¸€äº›çŸ¥è¯†ï¼Œä¸è¿‡ç°åœ¨å®˜æ–¹å¥½åƒæ¨èä½¿ç”¨Roomè¿›è¡ŒæŒä¹…åŒ–ï¼Œç­‰æœ‰ç©ºå†ç ”ç©¶ä¸€ä¸‹è¿™ä¸ª</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://developer.android.com/training/data-storage/sqlite">https://developer.android.com/training/data-storage/sqlite</a></li>
<li>ã€ŠAndroidæƒå¨ç¼–ç¨‹æŒ‡å—ã€‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>Volleyå­¦ä¹ </title>
    <url>/2021/08/29/Android%E5%AD%A6%E4%B9%A0/Volley%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="Volleyå­¦ä¹ "><a href="#Volleyå­¦ä¹ " class="headerlink" title="Volleyå­¦ä¹ "></a>Volleyå­¦ä¹ </h1><p><code>Volley</code>æ˜¯ä¸€ä¸ªå¯è®© <code>Android</code>åº”ç”¨æ›´è½»æ¾ã€ï¼ˆæœ€é‡è¦çš„æ˜¯ï¼‰æ›´å¿«æ·åœ°è”ç½‘çš„ HTTP åº“ï¼Œæ˜¯è°·æ­Œå®˜æ–¹ä½¿ç”¨å¼‚æ­¥httpç½‘ç»œè¯·æ±‚åº“ï¼Œæ‰€ä»¥ä¸ºäº†è¿æ¥ç½‘ç»œè¿˜æ˜¯éœ€è¦å­¦ä¹ ä¸€ä¸‹è¿™ä¸ªç©æ„ã€‚æ€»æ‰€å‘¨çŸ¥Androidä¸»çº¿ç¨‹æ˜¯ä¸èƒ½è®¿é—®ç½‘ç»œçš„ï¼Œä½†æ˜¯Volleyæ˜¯å¯ä»¥ç›´æ¥åœ¨ä¸»çº¿ç¨‹ä¸Šä½¿ç”¨ï¼Œå› ä¸ºä»–åº•å±‚å¸®æˆ‘ä»¬å®ç°äº†å¼€çº¿ç¨‹è¿™äº›äº‹æƒ…ã€‚</p>
<p>ç›®å‰æŸ¥çœ‹äº†ä¸€ä¸‹<code>Volley</code>å’Œç›¸å…³çš„èµ„æ–™ï¼Œå‘ç°å…¶å®ä»‹ç»çš„éƒ½æŒºå¥½çš„ï¼Œè¿™é‡Œçš„è¯å°±ä»‹ç»ä¸€ä¸‹ç®€å•çš„ä½¿ç”¨å§ï¼Œå¦‚æœæƒ³äº†è§£æ›´å¤šä¸€äº›å¯ä»¥æŸ¥çœ‹å®˜æ–¹æ•™ç¨‹å’Œéƒ­éœ–çš„æ•™ç¨‹ï¼š</p>
<p><a href="https://developer.android.com/training/volley">https://developer.android.com/training/volley</a></p>
<p><a href="https://blog.csdn.net/guolin_blog/article/details/17482095">https://blog.csdn.net/guolin_blog/article/details/17482095</a></p>
<p>é¦–å…ˆéœ€è¦è®¿é—®ç½‘ç»œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>AndroidManifest</code>ä¸­åŠ å…¥æƒé™</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;android.permission.INTERNET&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h2 id="StringRequestã€JsonObjectRequestã€ImageRequestä½¿ç”¨"><a href="#StringRequestã€JsonObjectRequestã€ImageRequestä½¿ç”¨" class="headerlink" title="StringRequestã€JsonObjectRequestã€ImageRequestä½¿ç”¨"></a>StringRequestã€JsonObjectRequestã€ImageRequestä½¿ç”¨</h2><h3 id="è®¾ç½®ç•Œé¢"><a href="#è®¾ç½®ç•Œé¢" class="headerlink" title="è®¾ç½®ç•Œé¢"></a>è®¾ç½®ç•Œé¢</h3><p>åˆ›å»ºä¸€ä¸ªç®€å•é¡¹ç›®åœ¨ä¸»ç•Œé¢çš„<code>xml</code>é‡Œé¢æ”¾ä¸€ä¸ª<code>TextView</code>å’Œä¸€ä¸ª<code>ImageView</code>,<code>TextView</code>ç”¨æ¥æ¥æ”¶æ”¶åˆ°çš„æ–‡å­—ï¼Œ<code>imageview</code>ç”¨æ¥æ¥æ”¶å›¾ç‰‡ã€‚</p>
<p>å¸ƒå±€ä½¿ç”¨<code>ConstraintLayout</code>ï¼Œç®€å•å¸ƒå±€ä¸€ä¸‹</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;Hello World!&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/imageView&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">&quot;@+id/text&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:srcCompat</span>=<span class="string">&quot;@tools:sample/avatars&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="StringRequestä»‹ç»"><a href="#StringRequestä»‹ç»" class="headerlink" title="StringRequestä»‹ç»"></a>StringRequestä»‹ç»</h3><p><code>StringRequest</code>æ˜¯å‘é€ä¸€ä¸ª<code>http</code>è¯·æ±‚åå°†æ”¶åˆ°çš„å†…å®¹ï¼Œå…¨éƒ½è½¬åŒ–ä¸ºStringè¿›è¡Œæ˜¾ç¤º</p>
<p><code>StringRequest</code>çš„æ„é€ å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StringRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">int</span> method,//è¯·æ±‚æ–¹æ³•ï¼Œå¦‚getã€post</span></span><br><span class="line"><span class="params">        String url,//è¯·æ±‚çš„åœ°å€</span></span><br><span class="line"><span class="params">        Listener&lt;String&gt; listener,//è¯·æ±‚æˆåŠŸçš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> ErrorListener errorListener//è¯·æ±‚å¤±è´¥çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªä»£ç å‘ç™¾åº¦è¿›è¡Œè¯·æ±‚ï¼Œç„¶åå°†å†…å®¹æ˜¾ç¤ºå‡ºæ¥</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> StringRequest <span class="title function_">getStringRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://www.baidu.com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Request a string response from the provided URL.</span></span><br><span class="line">    <span class="type">StringRequest</span> <span class="variable">stringRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRequest</span>(Request.Method.GET, url,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;String&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(String response)</span> &#123;</span><br><span class="line">                    <span class="comment">// Display the first 500 characters of the response string.</span></span><br><span class="line">                    Log.d(TAG, response);</span><br><span class="line">                    <span class="comment">// å¯¹åº”ç•Œé¢ä¸Šçš„TextView</span></span><br><span class="line">                    mTextView.setText(<span class="string">&quot;Response is: &quot;</span> + response.substring(<span class="number">0</span>, <span class="number">500</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">            Log.e(TAG, error.getMessage(), error);</span><br><span class="line">              <span class="comment">// å¯¹åº”ç•Œé¢ä¸Šçš„TextView</span></span><br><span class="line">            mTextView.setText(<span class="string">&quot;That didn&#x27;t work!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> stringRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹çš„å‡º<code>StringRequest</code>ä½¿ç”¨èµ·æ¥æ¯”è¾ƒç®€å•ï¼Œè®¾ç½®ä¸¤ä¸ªç›‘å¬å™¨ï¼Œåˆ†åˆ«æ˜¯ç›‘å¬è¯·æ±‚æˆåŠŸå’Œè¯·æ±‚å¤±è´¥ï¼Œå†å¯¹å…¶ä¸­çš„å†…å®¹è¿›è¡Œå…·ä½“çš„æ“ä½œå°±è¡Œã€‚</p>
<p>æˆ‘ä»¬åœ¨<code>MainActivity</code>ä¸­å†™ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">       <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">       mTextView = findViewById(R.id.text);</span><br><span class="line">       mImageView = findViewById(R.id.imageView);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Instantiate the RequestQueue.</span></span><br><span class="line">       <span class="type">RequestQueue</span> <span class="variable">queue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br><span class="line">       <span class="type">StringRequest</span> <span class="variable">request</span> <span class="operator">=</span> getStringRequest();</span><br><span class="line">       <span class="comment">// Add the request to the RequestQueue.</span></span><br><span class="line">       queue.add(request);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œä¹‹åï¼Œç­‰å¾…ä¸€ä¼šï¼Œç»“æœå¦‚å›¾æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¾—åˆ°äº†ç™¾åº¦è¿”å›çš„è¯·æ±‚ï¼Œå¹¶ä¸”æŠŠè¯·æ±‚æ˜¾ç¤ºåœ¨äº†TextViewä¹‹ä¸Šã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210906202925419.png" alt="image-20210906202925419"></p>
<h3 id="JsonObjectRequestä»‹ç»"><a href="#JsonObjectRequestä»‹ç»" class="headerlink" title="JsonObjectRequestä»‹ç»"></a>JsonObjectRequestä»‹ç»</h3><p>ç½‘ç»œå½“ä¸­ä½¿ç”¨jsonä¼ è¾“æ•°æ®æ˜¯å¾ˆæ™®éçš„äº‹æƒ…ï¼ŒVolleyå½“ä¸­ä¹Ÿæœ‰æ¥æ”¶jsonå›å¤çš„å«åš<code>JsonObjectRequest</code>,ä½¿ç”¨èµ·æ¥å’Œ<code>StringRequest</code>ä¸€æ ·æ¯”è¾ƒç®€å•ã€‚</p>
<p><code>JsonObjectRequest</code>çš„ä¸»è¦æ„é€ å‡½æ•°æ˜¯ï¼Œå…¶ä»–çš„æ„é€ å‡½æ•°éƒ½å’Œè¿™ä¸ªç±»ä¼¼</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JsonObjectRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">int</span> method,// è¯·æ±‚çš„æ–¹æ³•ï¼Œæ˜¯ä¸ªå¯é€‰å‚æ•°æœ‰è®¸å¤šé‡è½½çš„æ„é€ å‡½æ•°</span></span><br><span class="line"><span class="params">        String url,//è¯·æ±‚çš„ç½‘å€</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> JSONObject jsonRequest,//postè¯·æ±‚æ—¶å¸¦çš„jsonå¯¹è±¡ï¼Œå¦‚æœä¸º<span class="literal">null</span>ä»£è¡¨æ²¡æœ‰</span></span><br><span class="line"><span class="params">        Listener&lt;JSONObject&gt; listener,//æˆåŠŸçš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> ErrorListener errorListener//å¤±è´¥çš„ç›‘å¬å™¨</span></span><br><span class="line"><span class="params">)</span></span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åœ¨è¿™é‡Œè°ƒç”¨çš„æ˜¯ä¸Šé¢è®²è§£çš„æ„é€ å‡½æ•°çš„å…¶ä¸­ä¸€ä¸ªé‡è½½çš„æ„é€ å‡½æ•°ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> JsonObjectRequest <span class="title function_">getJsonObjectRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://www.weather.com.cn/data/sk/101010100.html&quot;</span>;</span><br><span class="line">        <span class="type">JsonObjectRequest</span> <span class="variable">jsonObjectRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JsonObjectRequest</span>(url, <span class="literal">null</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;JSONObject&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(JSONObject response)</span> &#123;</span><br><span class="line">                        Log.d(<span class="string">&quot;TAG&quot;</span>, response.toString());</span><br><span class="line">                        mTextView.setText(<span class="string">&quot;Response is: &quot;</span> + response.toString());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">                Log.e(<span class="string">&quot;TAG&quot;</span>, error.getMessage(), error);</span><br><span class="line">                mTextView.setText(<span class="string">&quot;That didn&#x27;t work!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> jsonObjectRequest;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬é‡‡å–åŒæ ·çš„æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ª<code>JsonObjectRequest</code>å¯¹è±¡ç„¶åè¿›è¡Œè¿”å›ã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬çš„è¯·æ±‚æ˜¯è¯·æ±‚äº†å¤©æ°”æ•°æ®ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.cnblogs.com/Jimc/p/10250861.html">https://www.cnblogs.com/Jimc/p/10250861.html</a></p>
<p>è¿™é‡Œçš„å¤©æ°”æ•°æ®æ˜¯ä¸ªhttpè¯·æ±‚ï¼Œå› ä¸ºhttpè¯·æ±‚è¢«è§†ä¸ºä¸å®‰å…¨ï¼Œæ‰€ä»¥åœ¨é«˜ç‰ˆæœ¬çš„<code>Android</code>å½“ä¸­æˆ‘ä»¬è°ƒç”¨<code>http</code>è¯·æ±‚éœ€è¦åœ¨<code>AndroidManifest</code>ä¸­çš„<code>application</code>æ ‡ç­¾ä¸‹é¢åŠ å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">android:usesCleartextTraffic=&quot;true&quot;</span><br></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬åœ¨<code>MainActivity</code>ä»£ç ä¸­</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    mTextView = findViewById(R.id.text);</span><br><span class="line">    mImageView = findViewById(R.id.imageView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the RequestQueue.</span></span><br><span class="line">    <span class="type">RequestQueue</span> <span class="variable">queue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br><span class="line">    <span class="type">JsonObjectRequest</span> <span class="variable">request</span> <span class="operator">=</span> getJsonObjectRequest();</span><br><span class="line">    <span class="comment">// Add the request to the RequestQueue.</span></span><br><span class="line">    queue.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼Œå¯ä»¥çœ‹åˆ°æŠŠå¤©æ°”æ•°æ®è¿›è¡Œäº†æ˜¾ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210907203713536.png" alt="image-20210907203713536"></p>
<h3 id="ImageRequestä»‹ç»"><a href="#ImageRequestä»‹ç»" class="headerlink" title="ImageRequestä»‹ç»"></a>ImageRequestä»‹ç»</h3><p><code>ImageRequest</code>æ˜¯è¯·æ±‚ä¸€å¼ å›¾ç‰‡ï¼Œä»–æ¯”å‰é¢ä¸¤ä¸ªç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥å®é™…è¿˜æ˜¯æ¯”è¾ƒç®€ä¾¿çš„</p>
<p><code>ImageRequest</code>çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„<code>ImageRequest</code>ï¼Œè§£ç åˆ°æœ€å¤§æŒ‡å®šçš„å®½åº¦å’Œé«˜åº¦ã€‚å¦‚æœå®½åº¦å’Œé«˜åº¦éƒ½ä¸ºé›¶ï¼Œå›¾åƒå°†è¢«è§£ç ä¸ºå…¶è‡ªç„¶å¤§å°ã€‚å¦‚æœå…¶ä¸­ä¸€ä¸ªéé›¶ï¼Œåˆ™è¯¥å°ºå¯¸å°†è¢«å›ºå®šï¼Œè€Œå¦ä¸€ä¸ªå°†è¢«è®¾ç½®ä¸ºä¿æŒå›¾åƒçš„é•¿å®½æ¯”ã€‚å¦‚æœå®½åº¦å’Œé«˜åº¦éƒ½éé›¶ï¼Œå›¾åƒå°†è¢«è§£ç ä¸ºé€‚åˆå®½åº¦xé«˜åº¦çš„çŸ©å½¢ï¼ŒåŒæ—¶ä¿æŒå…¶é«˜å®½æ¯”ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ImageRequest</span><span class="params">(</span></span><br><span class="line"><span class="params">        String url,</span></span><br><span class="line"><span class="params">        Response.Listener&lt;Bitmap&gt; listener,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> maxWidth,</span></span><br><span class="line"><span class="params">        <span class="type">int</span> maxHeight,</span></span><br><span class="line"><span class="params">        ScaleType scaleType,//ImageViews ScaleTypeç”¨äºè®¡ç®—æ‰€éœ€çš„å›¾åƒå¤§å°</span></span><br><span class="line"><span class="params">        Config decodeConfig,//è§£ç ä½å›¾çš„æ ¼å¼</span></span><br><span class="line"><span class="params">        <span class="meta">@Nullable</span> Response.ErrorListener errorListener)</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä»¿ç…§å‰é¢çš„ä¸¤ä¸ª<code>Request</code>å†™ä¸‹ä¸‹é¢çš„ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ImageRequest <span class="title function_">getImageRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/avatar/zhouning.jpg&quot;</span>;</span><br><span class="line">    <span class="type">ImageRequest</span> <span class="variable">imageRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ImageRequest</span>(</span><br><span class="line">            url,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;Bitmap&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Bitmap response)</span> &#123;</span><br><span class="line">                    mImageView.setImageBitmap(response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">0</span>, <span class="number">0</span>, ImageView.ScaleType.CENTER_INSIDE, Bitmap.Config.RGB_565,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">                    mTextView.setText(<span class="string">&quot;That didn&#x27;t work!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">    <span class="keyword">return</span> imageRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååœ¨<code>MainActivity</code>ä¸­è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    mTextView = findViewById(R.id.text);</span><br><span class="line">    mImageView = findViewById(R.id.imageView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the RequestQueue.</span></span><br><span class="line">    <span class="type">RequestQueue</span> <span class="variable">queue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br><span class="line">    <span class="type">ImageRequest</span> <span class="variable">request</span> <span class="operator">=</span> getImageRequest();</span><br><span class="line">    <span class="comment">// Add the request to the RequestQueue.</span></span><br><span class="line">    queue.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå¯ä»¥å¾—åˆ°ï¼Œä¸‹é¢å›¾ç‰‡çš„æ˜¾ç¤ºï¼Œå…¶ä¸­çš„å›¾ç‰‡æ˜¯æˆ‘è‡ªå·±åšå®¢çš„å¤´åƒï¼Œæ˜¾ç¤ºåœ¨ä¸Šé¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210908200246145.png" alt="image-20210908200246145"></p>
<h2 id="è‡ªå®šä¹‰Request"><a href="#è‡ªå®šä¹‰Request" class="headerlink" title="è‡ªå®šä¹‰Request"></a>è‡ªå®šä¹‰Request</h2><p>å­¦ä¹ äº†ä¸Šé¢ä¸‰ä¸ªç®€å•çš„<code>Request</code>ä½¿ç”¨ä¹‹åï¼Œæˆ‘ä»¬å‘ç°å…¶å®ä»–ä»¬çš„æ„é€ æ–¹æ³•éƒ½æœ‰äº›ç±»ä¼¼ï¼Œå¹¶ä¸”ä»–ä»¬çš„å®ç°éƒ¨åˆ†å…¶å®ä¹Ÿæ˜¯ç±»ä¼¼çš„éƒ½æ˜¯ç»§æ‰¿è‡ª<code>Request</code>ç±»</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210908202151443.png" alt="image-20210908202151443"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210908202210668.png" alt="image-20210908202210668"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210908202225771.png" alt="image-20210908202225771"></p>
<p>æ‰€ä»¥åŸºäºè¿™ä¸‰ç§ç±»çš„å­¦ä¹ å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥å®ç°è‡ªå®šä¹‰ç±»åˆ«ã€‚æ ¹æ®å®˜ç½‘çš„æ•™ç¨‹ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å®ç°è‡ªå®šä¹‰è¯·æ±‚ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸‹é¢ä¸¤ç‚¹æ“ä½œï¼š</p>
<ul>
<li>æ‰©å±• <code>Request&lt;T&gt;</code> ç±»ï¼Œå…¶ä¸­ <code>&lt;T&gt;</code> è¡¨ç¤ºè¯·æ±‚æœŸæœ›çš„å·²è§£æå“åº”çš„ç±»å‹ã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœå·²è§£æçš„å“åº”æ˜¯å­—ç¬¦ä¸²ï¼Œè¯·é€šè¿‡æ‰©å±• <code>Request&lt;String&gt;</code> åˆ›å»ºè‡ªå®šä¹‰è¯·æ±‚ã€‚</li>
<li>å®ç°æŠ½è±¡æ–¹æ³• <code>parseNetworkResponse()</code> å’Œ <code>deliverResponse()</code>ï¼Œè¯¦ç»†è¯´æ˜å¦‚ä¸‹æ‰€ç¤ºã€‚</li>
</ul>
<h3 id="parseNetworkResponse"><a href="#parseNetworkResponse" class="headerlink" title="parseNetworkResponse()"></a><code>parseNetworkResponse()</code></h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Response&lt;T&gt; <span class="title function_">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span>;</span><br></pre></td></tr></table></figure>
<p><code>parseNetworkResponse</code>å¯¹æœåŠ¡å™¨å“åº”çš„æ•°æ®è¿›è¡Œè§£æï¼Œç„¶åè¿”å›ä¸€ä¸ªå¯¹åº”ç±»å‹çš„<code>Response</code>å¯¹è±¡ï¼Œ<code>parseNetworkResponse</code>å°†<code>NetworkResponse</code>ä½œä¸ºå‚æ•°ï¼Œåœ¨è¯¥å‚æ•°å½“ä¸­åŒ…å«äº†å“åº”è´Ÿè½½ä½œä¸ºå­—èŠ‚ []ã€HTTP çŠ¶æ€ä»£ç ä»¥åŠå“åº”æ ‡å¤´ã€‚é™¤æ­¤ä¹‹å¤–æˆ‘ä»¬å®ç°è¿”å›çš„Response\<T>ï¼Œå…¶ä¸­åŒ…å«æ‚¨è¾“å…¥çš„å“åº”å¯¹è±¡å’Œç¼“å­˜å…ƒæ•°æ®æˆ–é”™è¯¯ï¼Œä¾‹å¦‚è§£æå¤±è´¥æ—¶å‡ºç°çš„é”™è¯¯ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å­¦ä¹ ä¸€ä¸‹<code>StringRequest</code>ä¸­çš„ä¾‹å­ï¼Œå¯¹åº”ç€ä¸Šé¢çš„è®²è§£å¯ä»¥å¾ˆæ¸…æ¥šçš„çœ‹æ‡‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;DefaultCharset&quot;)</span></span><br><span class="line"><span class="keyword">protected</span> Response&lt;String&gt; <span class="title function_">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> &#123;</span><br><span class="line">    String parsed;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        parsed = <span class="keyword">new</span> <span class="title class_">String</span>(response.data, HttpHeaderParser.parseCharset(response.headers));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">        <span class="comment">// Since minSdkVersion = 8, we can&#x27;t call</span></span><br><span class="line">        <span class="comment">// new String(response.data, Charset.defaultCharset())</span></span><br><span class="line">        <span class="comment">// So suppress the warning instead.</span></span><br><span class="line">        parsed = <span class="keyword">new</span> <span class="title class_">String</span>(response.data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Response.success(parsed, HttpHeaderParser.parseCacheHeaders(response));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="deliverResponse"><a href="#deliverResponse" class="headerlink" title="deliverResponse()"></a><code>deliverResponse()</code></h3><p>Volleyåœ¨<code>deliverResponse</code>ä¸­è¿”å›çš„å¯¹è±¡åœ¨ä¸»çº¿ç¨‹ä¸Šè¿›è¡Œå›è°ƒã€‚ç®€å•ç†è§£å°±æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•å½“ä¸­å¤„ç†è§£æå‡ºæ¥è¿”å›çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ¥è¯´åœ¨è¿™é‡Œé¢ï¼Œç›´æ¥è°ƒç”¨å›è°ƒæ¥å£ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨ç›‘å¬å™¨å°±è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">deliverResponse</span><span class="params">(T response)</span>;</span><br></pre></td></tr></table></figure>
<p>ä¾‹å¦‚<code>StringRequest</code>ä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">deliverResponse</span><span class="params">(String response)</span> &#123;</span><br><span class="line">    Response.Listener&lt;String&gt; listener;</span><br><span class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">        listener = mListener;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">        listener.onResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è‡ªå®šä¹‰XMLRequest"><a href="#è‡ªå®šä¹‰XMLRequest" class="headerlink" title="è‡ªå®šä¹‰XMLRequest"></a>è‡ªå®šä¹‰XMLRequest</h3><p>è¿™éƒ¨åˆ†å†…å®¹å€Ÿé‰´åšå®¢ï¼š<a href="https://blog.csdn.net/guolin_blog/article/details/17612763">https://blog.csdn.net/guolin_blog/article/details/17612763</a></p>
<p><code>xml</code>ä¹Ÿæ˜¯ç½‘ä¸Šä¼ è¾“æ¯”è¾ƒå¤šçš„æ ¼å¼ä¹‹ä¸€ï¼Œæ‰€ä»¥å…ˆå®šä¹‰ä¸€ä¸ª<code>XMLRequest</code>ç»ƒç»ƒæ‰‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.volleylearn;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.volley.*;</span><br><span class="line"><span class="keyword">import</span> com.android.volley.toolbox.HttpHeaderParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParser;</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserException;</span><br><span class="line"><span class="keyword">import</span> org.xmlpull.v1.XmlPullParserFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.StringReader;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XMLRequest</span> <span class="keyword">extends</span> <span class="title class_">Request</span>&lt;XmlPullParser&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Response.Listener&lt;XmlPullParser&gt; mListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XMLRequest</span><span class="params">(<span class="type">int</span> method, String url, Response.Listener&lt;XmlPullParser&gt; listener,</span></span><br><span class="line"><span class="params">                      Response.ErrorListener errorListener)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(method, url, errorListener);</span><br><span class="line">        mListener = listener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XMLRequest</span><span class="params">(String url, Response.Listener&lt;XmlPullParser&gt; listener, Response.ErrorListener errorListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(Method.GET, url, listener, errorListener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Response&lt;XmlPullParser&gt; <span class="title function_">parseNetworkResponse</span><span class="params">(NetworkResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">xmlString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(response.data,</span><br><span class="line">                    HttpHeaderParser.parseCharset(response.headers));</span><br><span class="line">            <span class="type">XmlPullParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> XmlPullParserFactory.newInstance();</span><br><span class="line">            <span class="type">XmlPullParser</span> <span class="variable">xmlPullParser</span> <span class="operator">=</span> factory.newPullParser();</span><br><span class="line">            xmlPullParser.setInput(<span class="keyword">new</span> <span class="title class_">StringReader</span>(xmlString));</span><br><span class="line">            <span class="keyword">return</span> Response.success(xmlPullParser, HttpHeaderParser.parseCacheHeaders(response));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> <span class="title class_">ParseError</span>(e));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Response.error(<span class="keyword">new</span> <span class="title class_">ParseError</span>(e));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">deliverResponse</span><span class="params">(XmlPullParser response)</span> &#123;</span><br><span class="line">        mListener.onResponse(response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä»£ç æ¯”è¾ƒç®€å•ï¼Œå®ç°äº†<code>parseNetworkResponse</code>å’Œ<code>deliverResponse</code>æ–¹æ³•ï¼Œç„¶åæœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ª<code>XmlPullParser</code>å¯¹è±¡</p>
<p>ç„¶åæˆ‘ä»¬å¯ä»¥ä»¿ç…§å‰é¢çš„ä¾‹å­ï¼Œå†™ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> XMLRequest <span class="title function_">getXmlRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://flash.weather.com.cn/wmaps/xml/china.xml&quot;</span>;</span><br><span class="line">    <span class="type">XMLRequest</span> <span class="variable">xmlRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLRequest</span>(url, <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;XmlPullParser&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(XmlPullParser response)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">eventType</span> <span class="operator">=</span> response.getEventType();</span><br><span class="line">                <span class="keyword">while</span> (eventType != XmlPullParser.END_DOCUMENT) &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">                        <span class="keyword">case</span> XmlPullParser.START_TAG:</span><br><span class="line">                            <span class="type">String</span> <span class="variable">nodeName</span> <span class="operator">=</span> response.getName();</span><br><span class="line">                            <span class="keyword">if</span> (<span class="string">&quot;city&quot;</span>.equals(nodeName)) &#123;</span><br><span class="line">                                <span class="type">String</span> <span class="variable">pName</span> <span class="operator">=</span> response.getAttributeValue(<span class="number">0</span>);</span><br><span class="line">                                Log.d(TAG, <span class="string">&quot;pName is &quot;</span> + pName);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    eventType = response.next();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">            Log.e(TAG, error.getMessage(), error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> xmlRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ â€œ<a href="http://flash.weather.com.cn/wmaps/xml/china.xml&quot;æ˜¯ä¸€äº›å¤©æ°”æ•°æ®ï¼Œå¯ä»¥è‡ªå·±è®¿é—®ä¹‹åæŸ¥çœ‹ä¸€ä¸‹">http://flash.weather.com.cn/wmaps/xml/china.xml&quot;æ˜¯ä¸€äº›å¤©æ°”æ•°æ®ï¼Œå¯ä»¥è‡ªå·±è®¿é—®ä¹‹åæŸ¥çœ‹ä¸€ä¸‹</a></p>
<p>æ¥ç€æˆ‘ä»¬å¯ä»¥è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    mTextView = findViewById(R.id.text);</span><br><span class="line">    mImageView = findViewById(R.id.imageView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the RequestQueue.</span></span><br><span class="line">    <span class="type">RequestQueue</span> <span class="variable">queue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br><span class="line">    <span class="type">XMLRequest</span> <span class="variable">request</span> <span class="operator">=</span> getXmlRequest();</span><br><span class="line">    <span class="comment">// Add the request to the RequestQueue.</span></span><br><span class="line">    queue.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç»“æœï¼Œå…¶ä¸­ä¹±ç éƒ¨åˆ†å…¶å®æ˜¯çœä»½ï¼ˆä¸­æ–‡ï¼‰ï¼Œä½†æ˜¯ä¸çŸ¥é“ä»€ä¹ˆåŸå› ä¹±ç äº†ï¼Œè‡ªå·±ä¹Ÿé‡‡å–äº†ä¸€äº›æ–¹æ³•ä½†æ˜¯éƒ½æ²¡æœ‰ç”¨ï¼Œæ—¥åè§£å†³äº†å†å†™ä¸ªæ–‡ç« ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210909203722103.png" alt="image-20210909203722103"></p>
<h3 id="è‡ªå®šä¹‰GsonRequest"><a href="#è‡ªå®šä¹‰GsonRequest" class="headerlink" title="è‡ªå®šä¹‰GsonRequest"></a>è‡ªå®šä¹‰GsonRequest</h3><p>Gsonæ˜¯Androidå½“ä¸­å¸¸ç”¨çš„ä¸€ä¸ªç”¨æ¥è§£æjsonçš„åº“ï¼ŒVolleyä¸­é»˜è®¤å¹¶ä¸æ”¯æŒä½¿ç”¨è‡ªå®¶çš„GSONæ¥è§£ææ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªGsonRequest</p>
<p>æˆ‘ä»¬è®¿é—®çš„ç½‘å€æ˜¯<a href="http://www.weather.com.cn/data/sk/101010100.htmlè¿™ä¸ªæ¥å£ï¼Œä»–å¯ä»¥å¾—åˆ°ä¸€æ®µJSONæ ¼å¼çš„å¤©æ°”æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š">http://www.weather.com.cn/data/sk/101010100.htmlè¿™ä¸ªæ¥å£ï¼Œä»–å¯ä»¥å¾—åˆ°ä¸€æ®µJSONæ ¼å¼çš„å¤©æ°”æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</a></p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;weatherinfo&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;city&quot;</span><span class="punctuation">:</span><span class="string">&quot;åŒ—äº¬&quot;</span><span class="punctuation">,</span><span class="attr">&quot;cityid&quot;</span><span class="punctuation">:</span><span class="string">&quot;101010100&quot;</span><span class="punctuation">,</span><span class="attr">&quot;temp&quot;</span><span class="punctuation">:</span><span class="string">&quot;19&quot;</span><span class="punctuation">,</span><span class="attr">&quot;WD&quot;</span><span class="punctuation">:</span><span class="string">&quot;å—é£&quot;</span><span class="punctuation">,</span><span class="attr">&quot;WS&quot;</span><span class="punctuation">:</span><span class="string">&quot;2çº§&quot;</span><span class="punctuation">,</span><span class="attr">&quot;SD&quot;</span><span class="punctuation">:</span><span class="string">&quot;43%&quot;</span><span class="punctuation">,</span><span class="attr">&quot;WSE&quot;</span><span class="punctuation">:</span><span class="string">&quot;2&quot;</span><span class="punctuation">,</span><span class="attr">&quot;time&quot;</span><span class="punctuation">:</span><span class="string">&quot;19:45&quot;</span><span class="punctuation">,</span><span class="attr">&quot;isRadar&quot;</span><span class="punctuation">:</span><span class="string">&quot;1&quot;</span><span class="punctuation">,</span><span class="attr">&quot;Radar&quot;</span><span class="punctuation">:</span><span class="string">&quot;JC_RADAR_AZ9010_JB&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬ä½¿ç”¨å¯¹è±¡çš„æ–¹å¼å°†è¿™æ®µJSONå­—ç¬¦ä¸²è¡¨ç¤ºå‡ºæ¥ã€‚æ–°å»ºä¸€ä¸ªWeatherç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Weather</span> &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">private</span> WeatherInfo weatherinfo;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> WeatherInfo <span class="title function_">getWeatherinfo</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> weatherinfo;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setWeatherinfo</span><span class="params">(WeatherInfo weatherinfo)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.weatherinfo = weatherinfo;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Weatherç±»ä¸­åªæ˜¯å¼•ç”¨äº†WeatherInfoè¿™ä¸ªç±»ã€‚æ¥ç€æ–°å»ºWeatherInfoç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WeatherInfo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String city;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String temp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String time;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCity</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCity</span><span class="params">(String city)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.city = city;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTemp</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTemp</span><span class="params">(String temp)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.temp = temp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTime</span><span class="params">(String time)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>WeatherInfoç±»ä¸­å«æœ‰cityã€tempã€timeè¿™å‡ ä¸ªå­—æ®µã€‚</p>
<p>æ¥ç€æˆ‘ä»¬ä¾ç…§æƒ¯ä¾‹å†™ä¸‹ä»£ç </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> GsonRequest&lt;Weather&gt; <span class="title function_">getGsonRequest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://www.weather.com.cn/data/sk/101010100.html&quot;</span>;</span><br><span class="line">    GsonRequest&lt;Weather&gt; gsonRequest = <span class="keyword">new</span> <span class="title class_">GsonRequest</span>&lt;Weather&gt;(</span><br><span class="line">            url, Weather.class,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Response</span>.Listener&lt;Weather&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Weather weather)</span> &#123;</span><br><span class="line">                    <span class="type">WeatherInfo</span> <span class="variable">weatherInfo</span> <span class="operator">=</span> weather.getWeatherinfo();</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;city is &quot;</span> + weatherInfo.getCity());</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;temp is &quot;</span> + weatherInfo.getTemp());</span><br><span class="line">                    Log.d(TAG, <span class="string">&quot;time is &quot;</span> + weatherInfo.getTime());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">Response</span>.ErrorListener() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onErrorResponse</span><span class="params">(VolleyError error)</span> &#123;</span><br><span class="line">            Log.e(<span class="string">&quot;TAG&quot;</span>, error.getMessage(), error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> gsonRequest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›è¡Œè°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">    mTextView = findViewById(R.id.text);</span><br><span class="line">    mImageView = findViewById(R.id.imageView);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instantiate the RequestQueue.</span></span><br><span class="line">    <span class="type">RequestQueue</span> <span class="variable">queue</span> <span class="operator">=</span> Volley.newRequestQueue(<span class="built_in">this</span>);</span><br><span class="line">    GsonRequest&lt;Weather&gt; request = getGsonRequest();</span><br><span class="line">    <span class="comment">// Add the request to the RequestQueue.</span></span><br><span class="line">    queue.add(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/android/image-20210911204452119.png" alt="image-20210911204452119"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç¼–å†™Volleyï¼Œä½¿ç”¨äº†å¾ˆä¹…æ—¶é—´ï¼Œè¿™æœŸé—´ç»å†äº†å›å­¦æ ¡ç­‰ä¼—å¤šäº‹æƒ…ï¼Œæœ€ç»ˆç®—æ˜¯å†™å®Œäº†ï¼Œä¹Ÿå­¦ä¹ åˆ°Volleyä½¿ç”¨çš„å¾ˆå¤šçŸ¥è¯†ï¼ŒåŠ æ²¹ï¼ç”Ÿæ´»ä¼šæ›´å¥½çš„ã€‚</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Andoridç¼–ç¨‹æƒå¨æŒ‡å—</tag>
      </tags>
  </entry>
  <entry>
    <title>LinuxæœåŠ¡å™¨è§„èŒƒ</title>
    <url>/2022/08/18/Linux/Linux%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%A7%84%E8%8C%83/</url>
    <content><![CDATA[<h1 id="LinuxæœåŠ¡å™¨è§„èŒƒ"><a href="#LinuxæœåŠ¡å™¨è§„èŒƒ" class="headerlink" title="LinuxæœåŠ¡å™¨è§„èŒƒ"></a>LinuxæœåŠ¡å™¨è§„èŒƒ</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬ä¸ƒç« LinuxæœåŠ¡å™¨è§„èŒƒï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­æ—¥å¿—ã€ç”¨æˆ·ä¿¡æ¯ã€è¿›ç¨‹å…³ç³»ã€æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•ã€‚</p>
<span id="more"></span>
<h2 id="æ—¥å¿—"><a href="#æ—¥å¿—" class="headerlink" title="æ—¥å¿—"></a>æ—¥å¿—</h2><h3 id="Linuxç³»ç»Ÿæ—¥å¿—"><a href="#Linuxç³»ç»Ÿæ—¥å¿—" class="headerlink" title="Linuxç³»ç»Ÿæ—¥å¿—"></a>Linuxç³»ç»Ÿæ—¥å¿—</h3><p>Linuxä¸Šä½¿ç”¨<code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹æ¥æ”¶<strong>ç”¨æˆ·è¿›ç¨‹</strong>è¾“å‡ºçš„æ—¥å¿—å’Œæ¥æ”¶<strong>å†…æ ¸</strong>æ—¥å¿—ã€‚</p>
<p>ç”¨æˆ·è¿›ç¨‹æ˜¯é€šè¿‡<code>syslogd</code>å‡½æ•°ç”Ÿæˆç³»ç»Ÿæ—¥å¿—ã€‚è¯¥å‡½æ•°å°†æ—¥å¿—è¾“å‡ºåˆ°ä¸€ä¸ªUNIXæœ¬åœ°åŸŸsocketç±»å‹(AF_UNIXï¼‰çš„æ–‡ä»¶<code>/dev/log</code>ä¸­ï¼Œ<code>rsyslogd</code>åˆ™ç›‘å¬è¯¥æ–‡ä»¶ä»¥è·å–ç”¨æˆ·è¿›ç¨‹çš„è¾“å‡ºã€‚</p>
<p>å†…æ ¸æ—¥å¿—æ˜¯å¦‚ä½•è¿›è¡Œç®¡ç†çš„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸è¿›è¡Œå…³ç³»ã€‚</p>
<p><code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹åœ¨æ¥æ”¶åˆ°<strong>ç”¨æˆ·è¿›ç¨‹</strong>æˆ–<strong>å†…æ ¸è¾“å…¥</strong>çš„æ—¥å¿—åï¼Œä¼šæŠŠå®ƒä»¬è¾“å‡ºè‡³æŸäº›ç‰¹å®šçš„æ—¥å¿—æ–‡ä»¶ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè°ƒè¯•ä¿¡æ¯ä¼šä¿å­˜è‡³<code>/var/log/debug</code>æ–‡ä»¶ï¼Œæ™®é€šä¿¡æ¯ä¿å­˜è‡³<code>/var/log/messages</code>æ–‡ä»¶ï¼Œå†…æ ¸æ¶ˆæ¯åˆ™ä¿å­˜è‡³<code>/var/log/kern.log</code>æ–‡ä»¶ã€‚</p>
<p>ä¸è¿‡ï¼Œæ—¥å¿—ä¿¡æ¯å…·ä½“å¦‚ä½•åˆ†å‘ï¼Œå¯ä»¥åœ¨<code>rsyslogd</code>çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ã€‚<code>rsyslogd</code>çš„ä¸»é…ç½®æ–‡ä»¶æ˜¯<code>/etc/rsyslog.conf</code>ï¼Œå…¶ä¸­ä¸»è¦å¯ä»¥è®¾ç½®çš„é¡¹åŒ…æ‹¬:å†…æ ¸æ—¥å¿—è¾“å…¥è·¯å¾„ï¼Œæ˜¯å¦æ¥æ”¶UDPæ—¥å¿—åŠå…¶ç›‘å¬ç«¯å£ï¼ˆé»˜è®¤æ˜¯514ï¼Œè§<code>/etc/services</code>æ–‡ä»¶)ï¼Œæ˜¯å¦æ¥æ”¶TCPæ—¥å¿—åŠå…¶ç›‘å¬ç«¯å£ï¼Œæ—¥å¿—æ–‡ä»¶çš„æƒé™ï¼ŒåŒ…å«å“ªäº›å­é…ç½®æ–‡ä»¶(æ¯”å¦‚ <code>/etc/rsyslog.d/*.conf</code>)ã€‚<code>rsyslogd</code>çš„å­é…ç½®æ–‡ä»¶åˆ™æŒ‡å®šå„ç±»æ—¥å¿—çš„ç›®æ ‡å­˜å‚¨æ–‡ä»¶ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818105707879.png" alt="image-20220818105707879"></p>
<p><code>rsyslogd</code>ç³»ç»Ÿæ—¥å¿—åŠŸèƒ½æ¯”è¾ƒå¤æ‚ï¼Œæœ‰facilityã€priorityã€actionç­‰æ¦‚å¿µã€‚è¿˜æœ‰Inputæ¨¡å—ã€Filetræ¨¡å—ã€Outputæ¨¡å—ç­‰æ¨¡å—å†…å®¹ï¼Œç›®å‰è¿˜æœªå¼„æ¸…æ¥šç›¸å…³çš„çŸ¥è¯†ã€‚</p>
<p>æŸ¥çœ‹äº†ä¸€ä¸‹<code>/etc/rsyslog.conf</code>çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/rsyslog.conf configuration file <span class="keyword">for</span> rsyslog</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># For more information install rsyslog-doc and see</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/usr/share/doc/rsyslog-doc/html/configuration/index.html</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Default logging rules can be found in /etc/rsyslog.d/50-default.conf</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### MODULES ####</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################</span></span></span><br><span class="line"></span><br><span class="line">module(load=&quot;imuxsock&quot;) # provides support for local system logging</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;immark&quot;</span>)  <span class="comment"># provides --MARK-- message capability</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides UDP syslog reception</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;imudp&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">input(<span class="built_in">type</span>=<span class="string">&quot;imudp&quot;</span> port=<span class="string">&quot;514&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides TCP syslog reception</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">module(load=<span class="string">&quot;imtcp&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">input(<span class="built_in">type</span>=<span class="string">&quot;imtcp&quot;</span> port=<span class="string">&quot;514&quot;</span>)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">provides kernel logging support and <span class="built_in">enable</span> non-kernel klog messages</span></span><br><span class="line">module(load=&quot;imklog&quot; permitnonkernelfacility=&quot;on&quot;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### GLOBAL DIRECTIVES ####</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Use traditional timestamp format.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">To <span class="built_in">enable</span> high precision timestamps, comment out the following line.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$ActionFileDefaultTemplate</span> RSYSLOG_TraditionalFileFormat</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Filter duplicated messages</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">RepeatedMsgReduction on</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Set the default permissions for all log files.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$FileOwner</span> syslog</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">FileGroup adm</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">FileCreateMode 0640</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">DirCreateMode 0755</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">Umask 0022</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">PrivDropToUser syslog</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">PrivDropToGroup syslog</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Where to place spool and state files</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$WorkDirectory</span> /var/spool/rsyslog</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Include all config files in /etc/rsyslog.d/</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="variable">$IncludeConfig</span> /etc/rsyslog.d/*.conf</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¨¡å—<code>module(load=&quot;imuxsock&quot;)</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªè¾“å…¥æ¨¡å—</p>
<p>ç„¶åçœ‹åˆ°é»˜è®¤è§„åˆ™åœ¨<code>/etc/rsyslog.d/50-default.conf</code>ï¼ŒæŸ¥çœ‹ä¸€ä¸‹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> Default rules <span class="keyword">for</span> rsyslog.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#                       For more information see rsyslog.conf(5) and /etc/rsyslog.conf</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># First some standard log files.  Log by facility.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">auth,authpriv.*                 /var/log/auth.log</span></span><br><span class="line">*.*;auth,authpriv.none          -/var/log/syslog</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">cron.*                         /var/log/cron.log</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">daemon.*                       -/var/log/daemon.log</span></span><br><span class="line">kern.*                          -/var/log/kern.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">lpr.*                          -/var/log/lpr.log</span></span><br><span class="line">mail.*                          -/var/log/mail.log</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">user.*                         -/var/log/user.log</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Logging for the mail system.  Split it up so that</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">it is easy to write scripts to parse these files.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#mail.info                      -/var/log/mail.info</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">mail.warn                      -/var/log/mail.warn</span></span><br><span class="line">mail.err                        /var/log/mail.err</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Some &quot;catch-all&quot; log files.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*.=debug;\</span></span><br><span class="line"><span class="language-bash"><span class="comment">#       auth,authpriv.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       news.none;mail.none     -/var/log/debug</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">*.=info;*.=notice;*.=warn;\</span></span><br><span class="line"><span class="language-bash"><span class="comment">#       auth,authpriv.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       cron,daemon.none;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       mail,news.none          -/var/log/messages</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Emergencies are sent to everybody logged in.</span></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">*.emerg                         :omusrmsg:*</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># I like to have messages displayed on the console, but only on a virtual</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">console I usually leave idle.</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#daemon,mail.*;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       news.=crit;news.=err;news.=notice;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       *.=debug;*.=info;\</span></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       *.=notice;*.=warn       /dev/tty8</span></span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>auth</code>è¿™ç§å°±æ˜¯facilityï¼ˆè®¾æ–½ï¼‰ï¼Œ<code>mail.err</code>è¿™ç§å°±æ˜¯priorityï¼ˆç­‰çº§ï¼‰ï¼Œè€Œè¿™ç§è®¾ç½®æ—¥å¿—è®°å½•çš„ä½ç½®å°±æ˜¯action</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">*.*;auth,authpriv.none          -/var/log/syslog</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢è¿™ä¸€ä¸ªactionå¯ä»¥çœ‹å‡ºæ™®é€šçš„æ—¥å¿—ï¼ˆ<code>&quot;.&quot;</code>ï¼‰ï¼Œè®¾ç½®æ—¥å¿—è®°å½•ä½ç½®æ˜¯<code>/var/log/syslog</code>ï¼Œå‰é¢<code>-</code>è¡¨ç¤ºå¼‚æ­¥å†™å…¥</p>
<p>æˆ‘ä»¬ä½¿ç”¨<code>logger</code>å‘½ä»¤æµ‹è¯•ä¸€ä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">logger -i -t <span class="string">&quot;my_test&quot;</span> <span class="string">&quot;test_log&quot;</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨vimæŸ¥çœ‹<code>/var/log/syslog</code>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„<code>logger</code>çš„ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818172612033.png" alt="image-20220818172612033"></p>
<p><code>rsyslogd</code>çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œåç»­å†è¡¥ã€‚</p>
<h3 id="syslogå‡½æ•°"><a href="#syslogå‡½æ•°" class="headerlink" title="syslogå‡½æ•°"></a>syslogå‡½æ•°</h3><p>åº”ç”¨ç¨‹åºä½¿ç”¨<code>syslog</code>å‡½æ•°å’Œ<code>rsyslogd</code>å®ˆæŠ¤è¿›ç¨‹è¿›è¡Œé€šè®¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">openlog</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ident, <span class="type">int</span> option, <span class="type">int</span> facility)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">closelog</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p><code>openlog</code>ç”¨äºæ”¹å˜<code>syslog</code>é»˜è®¤çš„è¾“å‡ºæ–¹å¼ï¼Œè¿›è¡Œæ—¥å¿—ç»“æ„åŒ–</p>
<p><code>ident</code>å‚æ•°æŒ‡å®šçš„å­—ç¬¦ä¸²å°†è¢«æ·»åŠ åˆ°æ—¥å¿—æ¶ˆæ¯çš„æ—¥æœŸå’Œæ—¶é—´ä¹‹åï¼Œå®ƒé€šå¸¸è¢«è®¾ç½®ä¸ºç¨‹åºçš„åå­—ã€‚</p>
<p><code>option</code>å‚æ•°å¯¹åç»­<code>syslog</code>è°ƒç”¨çš„è¡Œä¸ºè¿›è¡Œé…ç½®ï¼Œå®ƒå¯å–ä¸‹åˆ—çš„å€¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_PID		0x01	<span class="comment">/* log the pid with each message */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CONS	0x02	<span class="comment">/* log on the console if errors in sending */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ODELAY	0x04	<span class="comment">/* delay open until first syslog() (default) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NDELAY	0x08	<span class="comment">/* don&#x27;t delay open */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NOWAIT	0x10	<span class="comment">/* don&#x27;t wait for console forks: DEPRECATED */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_PERROR	0x20	<span class="comment">/* log to stderr as well */</span></span></span><br></pre></td></tr></table></figure>
<p><code>facility</code>å‚æ•°å¯ä»¥ä¿®æ”¹<code>syslog</code>å‡½æ•°ä¸­çš„é»˜è®¤è®¾æ–½å€¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* facility codes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_KERN	(0&lt;&lt;3)	<span class="comment">/* kernel messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_USER	(1&lt;&lt;3)	<span class="comment">/* random user-level messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_MAIL	(2&lt;&lt;3)	<span class="comment">/* mail system */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_DAEMON	(3&lt;&lt;3)	<span class="comment">/* system daemons */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_AUTH	(4&lt;&lt;3)	<span class="comment">/* security/authorization messages */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_SYSLOG	(5&lt;&lt;3)	<span class="comment">/* messages generated internally by syslogd */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LPR		(6&lt;&lt;3)	<span class="comment">/* line printer subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NEWS	(7&lt;&lt;3)	<span class="comment">/* network news subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_UUCP	(8&lt;&lt;3)	<span class="comment">/* UUCP subsystem */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CRON	(9&lt;&lt;3)	<span class="comment">/* clock daemon */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_AUTHPRIV	(10&lt;&lt;3)	<span class="comment">/* security/authorization messages (private) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_FTP		(11&lt;&lt;3)	<span class="comment">/* ftp daemon */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* other codes through 15 reserved for system use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL0	(16&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL1	(17&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL2	(18&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL3	(19&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL4	(20&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL5	(21&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL6	(22&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_LOCAL7	(23&lt;&lt;3)	<span class="comment">/* reserved for local use */</span></span></span><br></pre></td></tr></table></figure>
<p><code>syslog</code>ç”¨äºè¾“å‡ºæ—¥å¿—ã€‚</p>
<p><code>priority</code>å‚æ•°æ˜¯<strong>è®¾æ–½å€¼å’Œæ—¥å¿—çº§åˆ«</strong>çš„æŒ‰ä½ä¸ï¼Œé»˜è®¤æ˜¯<code>LOG_USER</code>ã€‚æ—¥å¿—çº§åˆ«æœ‰ä¸‹é¢å‡ ä¸ª</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_EMERG	0	<span class="comment">/* system is unusable */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ALERT	1	<span class="comment">/* action must be taken immediately */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_CRIT	2	<span class="comment">/* critical conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_ERR		3	<span class="comment">/* error conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_WARNING	4	<span class="comment">/* warning conditions */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_NOTICE	5	<span class="comment">/* normal but significant condition */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_INFO	6	<span class="comment">/* informational */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	LOG_DEBUG	7	<span class="comment">/* debug-level messages */</span></span></span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒä¸ªå‚æ•°<code>message</code>å’Œç¬¬ä¸‰ä¸ªå‚æ•°<code>...</code>æ¥ç»“æ„åŒ–è¾“å‡ºã€‚</p>
<p><code>closelog</code>ç”¨äºå…³é—­æ—¥å¿—</p>
<p>å°ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    openlog(argv[<span class="number">0</span>], LOG_CONS | LOG_PID, LOG_USER);</span><br><span class="line">    syslog(LOG_DEBUG, <span class="string">&quot;This is a syslog test message generated by program &#x27;%s&#x27;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    closelog();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220818183131617.png" alt="image-20220818183131617"></p>
<h2 id="ç”¨æˆ·ä¿¡æ¯"><a href="#ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="ç”¨æˆ·ä¿¡æ¯"></a>ç”¨æˆ·ä¿¡æ¯</h2><h3 id="UIDã€EUIDã€GIDå’ŒEGID"><a href="#UIDã€EUIDã€GIDå’ŒEGID" class="headerlink" title="UIDã€EUIDã€GIDå’ŒEGID"></a>UIDã€EUIDã€GIDå’ŒEGID</h3><p>Linuxä¸­idçœŸæ˜¯å¤ªå¤šäº†è¿›ç¨‹æœ‰pidï¼Œç„¶åç”¨æˆ·è¿˜æœ‰UIDè¿™ç§ï¼ŒçœŸæ˜¯æœ‰ç‚¹ç»•ã€‚</p>
<p>åœ¨Linuxå½“ä¸­ä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰æ‹¥æœ‰å››ä¸ªID:çœŸå®ç”¨æˆ·<code>UID</code>ã€æœ‰æ•ˆç”¨æˆ·<code>EUID</code>ã€çœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>ã€‚</p>
<p>è¿™é‡Œä»¥çœŸå®ç”¨æˆ·<code>UID</code>å’Œæœ‰æ•ˆç”¨æˆ·<code>EUID</code>ä¸ºä¾‹ï¼ŒçœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>é“ç†æ˜¯ç›¸åŒçš„ã€‚</p>
<p><code>EUID</code>å­˜åœ¨çš„ç›®çš„æ˜¯<strong>æ–¹ä¾¿èµ„æºè®¿é—®</strong>:å®ƒä½¿å¾—è¿è¡Œç¨‹åºçš„ç”¨æˆ·æ‹¥æœ‰è¯¥ç¨‹åºçš„æœ‰æ•ˆç”¨æˆ·çš„æƒé™ï¼ˆå¤ªè¿‡å®˜æ–¹è¿™ç§è¯´æ³•æ„Ÿè§‰ï¼‰ã€‚<code>EUID</code>ç¡®å®šè¿›ç¨‹å¯¹æŸäº›èµ„æºå’Œæ–‡ä»¶çš„è®¿é—®æƒé™ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿›ç¨‹çš„<code>UID</code>å’Œ<code>EUID</code>æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å¯¹äºä¸€äº›ç¨‹åºå¦‚<code>su</code>ã€<code>passwd</code>è¿™ç§<code>set-user-id</code>ç¨‹åºï¼Œå®ƒä»¬æœ‰å¯èƒ½æ˜¯ä¸ç›¸åŒçš„ã€‚å¯¹äº<code>set-user-id</code>ç¨‹åºè€Œè¨€ï¼Œç¨‹åºçš„<code>EUID</code>ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>çš„<code>UID</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ç¨‹åºæ‰§è¡Œæ—¶ï¼Œæ˜¯ä»¥<strong>ç¨‹åºçš„æ‰€æœ‰è€…èº«ä»½</strong>è¿›è¡Œè¿è¡Œçš„ã€‚</p>
<p>ä»¥<code>passwd</code>ä¸ºä¾‹ã€‚<code>passwd</code>å…è®¸ç”¨æˆ·ä¿®æ”¹è‡ªå·±çš„ç™»å½•å¯†ç ï¼Œè¿™ä¸ª<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>æ˜¯<code>root</code>ï¼Œ<code>passwd</code>æƒé™ä¸­æœ‰<code>s</code>ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ª<code>set-user-id</code>ç¨‹åºã€‚<code>passwd</code>å‘½ä»¤éœ€è¦ä¿®æ”¹<code>/etc/shadow</code>æ–‡ä»¶ï¼Œå¯¹äº<code>/etc/shadow</code>æ–‡ä»¶ï¼Œæ™®é€šç”¨æˆ·æ˜¯ä¸å¯å†™ï¼ˆåªæœ‰è¯»æƒé™ï¼‰çš„ï¼Œé‚£ä¹ˆç”¨æˆ·æ€ä¹ˆèƒ½å¤Ÿé€šè¿‡<code>passwd</code>ä¿®æ”¹è‡ªå·±çš„å¯†ç å‘¢ï¼Œ<code>set-user-id</code>ç¨‹åºçš„æ ‡å¿—<code>s</code>å°±èµ·åˆ°äº†ä½œç”¨ï¼Œå®ƒåœ¨ç¨‹åºè¿è¡Œæ—¶å°†<code>EUID</code>ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>çš„<code>UID</code>ï¼Œé‚£ä¹ˆç¨‹åºæœ‰æ•ˆçš„ç”¨æˆ·å°±ä¼šå˜æˆ<strong>ç¨‹åºçš„æ‰€æœ‰è€…</strong>ï¼Œåœ¨è¿™é‡Œæ˜¯<code>root</code>ç”¨æˆ·ï¼Œç†æ‰€å½“ç„¶çš„å¯ä»¥è¿›è¡Œ<code>/etc/shadow</code>æ–‡ä»¶çš„ä¿®æ”¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819104851240.png" alt="image-20220819104851240"></p>
<p>å†æ¯”å¦‚<code>su</code>ç¨‹åºå…è®¸ä»»ä½•ç”¨æˆ·éƒ½å¯ä»¥ä½¿ç”¨å®ƒæ¥ä¿®æ”¹è‡ªå·±çš„è´¦æˆ·ä¿¡æ¯ï¼Œä½†ä¿®æ”¹è´¦æˆ·æ—¶ç¨‹åºä¸å¾—ä¸è®¿é—®æ–‡ä»¶<code>/etc/passwd</code>æ–‡ä»¶ï¼Œè€Œè®¿é—®è¯¥æ–‡ä»¶æ˜¯éœ€è¦<code>root</code>æƒé™çš„ã€‚é‚£ä¹ˆä»¥<strong>æ™®é€šç”¨æˆ·èº«ä»½</strong>å¯åŠ¨çš„<code>su</code>ç¨‹åºå¦‚ä½•èƒ½è®¿é—®<code>/etc/passwd</code>æ–‡ä»¶å‘¢ï¼Ÿ</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819130924743.png" alt="image-20220819130924743"></p>
<p><code>su</code>ç¨‹åºçš„æ‰€æœ‰è€…æ˜¯<code>root</code>ï¼Œå¹¶ä¸”å®ƒè¢«è®¾ç½®äº†<code>set-user-id</code>æ ‡å¿—ã€‚å’Œä¸Šé¢<code>passwd</code>ä¸€æ ·ï¼Œ<code>set-user-id</code>æ ‡å¿—è¡¨ç¤ºä»»ä½•æ™®é€šç”¨æˆ·è¿è¡Œ<code>su</code>ç¨‹åºæ—¶ï¼Œå…¶æœ‰æ•ˆç”¨æˆ·å°±æ˜¯è¯¥ç¨‹åºçš„<strong>æ‰€æœ‰è€…</strong><code>root</code>ã€‚</p>
<p>è·å–å’Œè®¾ç½®çœŸå®ç”¨æˆ·<code>UID</code>ã€æœ‰æ•ˆç”¨æˆ·<code>EUID</code>ã€çœŸå®ç»„<code>GID</code>å’Œæœ‰æ•ˆç»„<code>EGID</code>çš„å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">getuid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">uid_t</span> <span class="title function_">geteuid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">getgid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">gid_t</span> <span class="title function_">getegid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setuid</span><span class="params">(<span class="type">uid_t</span> uid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">seteuid</span><span class="params">(<span class="type">uid_t</span> euid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setgid</span><span class="params">(<span class="type">gid_t</span> gid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setegid</span><span class="params">(<span class="type">gid_t</span> egid)</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æµ‹è¯•ä¸Šé¢æ‰€è¯´ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·<code>bugcat</code>ï¼Œç›®å‰å·²ç»æœ‰æ™®é€šç”¨æˆ·<code>ubuntu</code>ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°<code>bugcat</code>çš„uidæ˜¯<code>1002</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819140826977.png" alt="image-20220819140826977"></p>
<p>æˆ‘ä»¬å†™ä¸‹è¯»å–ç¨‹åº<code>uid</code>å’Œ<code>euid</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uid_t</span> uid = getuid();</span><br><span class="line">    <span class="type">uid_t</span> euid = geteuid();</span><br><span class="line">    <span class="built_in">printf</span>( <span class="string">&quot;userid is %d, effective userid is: %d\n&quot;</span>, uid, euid );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†å…¶ç¼–è¯‘ä¸€ä¸‹ï¼Œç„¶åæŸ¥çœ‹æŸ¥çœ‹æ–‡ä»¶å±æ€§ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>å’Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>éƒ½æ˜¯<code>ubuntu</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141010532.png" alt="image-20220819141010532"></p>
<p>æ¥ç€å†å°†ç¨‹åºçš„æ‰€æœ‰è€…æ”¹ä¸º<code>root</code>ï¼Œå†åŠ ä¸Š<code>s</code>æƒé™ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºä¸ç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>æ˜¯<code>ubuntu</code>ï¼Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>æ˜¯<code>root</code>ï¼ˆç¬¦åˆ<code>set-user-id</code>ç¨‹åºç‰¹ç‚¹ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141209028.png" alt="image-20220819141209028"></p>
<p>ç„¶åå°†ç¨‹åºçš„æ‰€æœ‰è€…æ”¹ä¸º<code>bugcat</code>ï¼ˆsæƒé™ä¸çŸ¥é“ä¸ºå•¥è‡ªåŠ¨å–æ¶ˆäº†ï¼‰ï¼Œå†åŠ ä¸Š<code>s</code>æƒé™ï¼Œå†è¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºä¸ç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>æ˜¯<code>ubuntu</code>ï¼Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>æ˜¯<code>bugcat</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819141405860.png" alt="image-20220819141405860"></p>
<p>æœ€åæˆ‘ä»¬å»æ‰<code>s</code>æƒé™ï¼Œè¿è¡Œç¨‹åºï¼Œå¯ä»¥çœ‹åˆ°<code>uid</code>å’Œ<code>euid</code>è¾“å‡ºç›¸åŒï¼Œè¡¨ç¤º<strong>çœŸå®ç”¨æˆ·</strong>å’Œ<strong>æœ‰æ•ˆç”¨æˆ·</strong>éƒ½æ˜¯<code>ubuntu</code>ï¼Œä¹Ÿä»åé¢è¯´æ˜<code>s</code>æƒé™çš„ä½œç”¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220819142209993.png" alt="image-20220819142209993"></p>
<h2 id="è¿›ç¨‹é—´å…³ç³»"><a href="#è¿›ç¨‹é—´å…³ç³»" class="headerlink" title="è¿›ç¨‹é—´å…³ç³»"></a>è¿›ç¨‹é—´å…³ç³»</h2><h3 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h3><p>Linuxä¸‹æ¯ä¸ªè¿›ç¨‹éƒ½éš¶å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå› æ­¤å®ƒä»¬é™¤äº†PIDä¿¡æ¯å¤–ï¼Œè¿˜æœ‰è¿›ç¨‹ç»„ID(<code>PGID</code>)ã€‚æˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹å‡½æ•°æ¥è·å–æŒ‡å®šè¿›ç¨‹<code>PGID</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›è¿›ç¨‹pidæ‰€å±è¿›ç¨‹ç»„çš„<code>PGID</code>ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰ä¸€ä¸ªé¦–é¢†è¿›ç¨‹ï¼Œå…¶<code>PGID</code>å’Œ<code>PID</code>ç›¸åŒã€‚è¿›ç¨‹ç»„å°†ä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°å…¶ä¸­æ‰€æœ‰è¿›ç¨‹éƒ½é€€å‡ºï¼Œæˆ–è€…åŠ å…¥åˆ°å…¶ä»–è¿›ç¨‹ç»„ã€‚ä¸‹é¢çš„å‡½æ•°ç”¨äºè®¾ç½®<code>PGID</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">setpgid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">pid_t</span> pgid)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°å°†<code>PID</code>ä¸º<code>pid</code>çš„è¿›ç¨‹çš„<code>PGID</code>è®¾ç½®ä¸º<code>pgid</code>ã€‚</p>
<p>å¦‚æœ<code>pid</code>å’Œ <code>pgid</code>ç›¸åŒï¼Œåˆ™ç”±<code>pid</code>æŒ‡å®šçš„è¿›ç¨‹å°†è¢«è®¾ç½®ä¸ºè¿›ç¨‹ç»„é¦–é¢†ï¼›</p>
<p>å¦‚æœ<code>pid</code>ä¸º0ï¼Œåˆ™è¡¨ç¤ºè®¾ç½®å½“å‰è¿›ç¨‹çš„<code>PGID</code>ä¸º<code>pgid</code>ï¼›</p>
<p>å¦‚æœ<code>pgid</code>ä¸º0ï¼Œåˆ™ä½¿ç”¨<code>pid</code>ä½œä¸ºç›®æ ‡<code>PGID</code>ã€‚</p>
<p><code>setpgid</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>.</p>
<p>ä¸€ä¸ªè¿›ç¨‹åªèƒ½è®¾ç½®<strong>è‡ªå·±</strong>æˆ–è€…<strong>å…¶å­è¿›ç¨‹</strong>çš„<code>PGID</code>ã€‚å¹¶ä¸”ï¼Œå½“å­è¿›ç¨‹è°ƒç”¨<code>exec</code>ç³»åˆ—å‡½æ•°åï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½å†åœ¨çˆ¶è¿›ç¨‹ä¸­å¯¹å®ƒè®¾ç½®<code>PGID</code>ã€‚</p>
<h3 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h3><p>ä¸€äº›æœ‰å…³è”çš„è¿›ç¨‹ç»„å°†å½¢æˆä¸€ä¸ªä¼šè¯(session)ã€‚ä¸‹é¢çš„å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªä¼šè¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">setsid</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p>è¯¥è¿›ç¨‹ä¸èƒ½ç”±<strong>è¿›ç¨‹ç»„çš„é¦–é¢†</strong>è¿›ç¨‹è¿›è¡Œè°ƒç”¨ï¼Œä¼šæŠ¥é”™ã€‚</p>
<p>å¯¹äºéè¿›ç¨‹ç»„é¦–é¢†çš„è¿›ç¨‹ï¼Œè°ƒç”¨è¯¥å‡½æ•°ä¸ä»…åˆ›å»ºæ–°ä¼šè¯ï¼Œè¿˜ä¼šï¼š</p>
<ul>
<li>è°ƒç”¨è¿›ç¨‹æˆä¸ºä¼šè¯çš„é¦–é¢†ï¼Œæ­¤æ—¶è¯¥è¿›ç¨‹æ˜¯æ–°ä¼šè¯çš„å”¯ä¸€æˆå‘˜ã€‚</li>
<li>æ–°å»ºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå…¶<code>PGID</code>å°±æ˜¯è°ƒç”¨è¿›ç¨‹çš„<code>PID</code>ï¼Œè°ƒç”¨è¿›ç¨‹æˆä¸ºè¯¥ç»„çš„é¦–é¢†ã€‚</li>
<li>è°ƒç”¨è¿›ç¨‹å°†å¤±å»ç»ˆç«¯</li>
</ul>
<p>è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›æ–°çš„è¿›ç¨‹ç»„çš„<code>PGID</code>ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>Linuxè¿›ç¨‹å¹¶æœªæä¾›æ‰€è°“<strong>ä¼šè¯ID (SIDï¼‰</strong>çš„æ¦‚å¿µï¼Œä½†Linuxç³»ç»Ÿè®¤ä¸ºå®ƒç­‰äº<strong>ä¼šè¯é¦–é¢†</strong>æ‰€åœ¨çš„<strong>è¿›ç¨‹ç»„çš„PGID</strong>ï¼Œå¹¶æä¾›äº†å¦‚ä¸‹å‡½æ•°æ¥è¯»å–<code>SID</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getsid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br></pre></td></tr></table></figure>
<h3 id="ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»"><a href="#ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»" class="headerlink" title="ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»"></a>ä½¿ç”¨pså‘½ä»¤æŸ¥çœ‹è¿›ç¨‹ä¹‹é—´çš„å…³ç³»</h3><p>åœ¨ç»ˆç«¯è¾“å…¥</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ps -o pid,ppid,pgid,sid,comm | less</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821164503929.png" alt="image-20220821164503929"></p>
<p>å®ƒä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾</p>
<p>ä»å•ç‹¬çš„è¿›ç¨‹è§’åº¦çœ‹ï¼Œzshæ˜¯pså’Œlessçš„çˆ¶è¿›ç¨‹</p>
<p>ä»ç»„çš„è§’åº¦çœ‹ï¼Œzshæ˜¯ä¸€ä¸ªç»„ï¼ˆç»„é‡Œé¢åªæœ‰zshï¼Œæ‰€ä»¥zshæ˜¯è¿›ç¨‹ç»„é¦–é¢†ï¼‰ï¼Œpså’Œlessæ˜¯ä¸€ä¸ªç»„ï¼ˆpsæ˜¯è¿›ç¨‹ç»„é¦–é¢†ï¼‰</p>
<p>ä»ä¼šè¯çš„è§’åº¦çœ‹ï¼Œä¼šè¯é‡Œé¢æœ‰ä¸¤ä¸ªå…³è”çš„è¿›ç¨‹ç»„ï¼Œå…¶å®zshæ˜¯ä¼šè¯çš„é¦–é¢†</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821165830395.png" alt="image-20220821165830395"></p>
<h2 id="æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•"><a href="#æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•" class="headerlink" title="æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•"></a>æ”¹å˜å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•</h2><p>è¿›ç¨‹æœ‰å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•ã€‚</p>
<p>å·¥ä½œç›®å½•ï¼šè¿›ç¨‹åœ¨å“ªä¸ªè·¯å¾„ä¸‹è¢«è¿è¡Œèµ·æ¥å“ªä¸ªè·¯å¾„å°±æ˜¯è¿›ç¨‹çš„å·¥ä½œç›®å½•(Current Woring Directory, CWD)</p>
<p>æ ¹ç›®å½•ï¼šå°±æ˜¯â€/â€œ</p>
<p>å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•å¯ä»¥é€šè¿‡<code>/proc/PID/cwd</code>å’Œ<code>/proc/PID/root</code>è¿›è¡ŒæŸ¥çœ‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220821175748810.png" alt="image-20220821175748810"></p>
<p>å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•éƒ½å¯ä»¥è¿›è¡Œæ›´æ”¹ï¼Œè·å–è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•å’Œæ”¹å˜è¿›ç¨‹å·¥ä½œç›®å½•çš„å‡½æ•°åˆ†åˆ«æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">getcwd</span><span class="params">(<span class="type">char</span> *buf, <span class="type">size_t</span> size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">chdir</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br></pre></td></tr></table></figure>
<p><code>buf</code>å‚æ•°æŒ‡å‘çš„å†…å­˜ç”¨äºå­˜å‚¨è¿›ç¨‹å½“å‰å·¥ä½œç›®å½•çš„ç»å¯¹è·¯å¾„åï¼Œå…¶å¤§å°ç”±<code>size</code>å‚æ•°æŒ‡å®šã€‚</p>
<p>å¦‚æœå½“å‰å·¥ä½œç›®å½•çš„ç»å¯¹è·¯å¾„çš„é•¿åº¦ï¼ˆå†åŠ ä¸Šä¸€ä¸ªç©ºç»“æŸå­—ç¬¦â€œ\0â€)è¶…è¿‡äº†<code>size</code>ï¼Œåˆ™<code>getcwd</code>å°†è¿”å›<code>NULL</code>ï¼Œå¹¶è®¾ç½®<code>errno</code>ä¸º<code>ERANGE</code>ã€‚</p>
<p>å¦‚æœ<code>buf</code>ä¸º<code>NULL</code>å¹¶ä¸”<code>size</code>é0ï¼Œåˆ™<code>getcwd</code>å¯èƒ½åœ¨å†…éƒ¨ä½¿ç”¨<code>malloc</code>åŠ¨æ€åˆ†é…å†…å­˜ï¼Œå¹¶å°†è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•å­˜å‚¨åœ¨å…¶ä¸­ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œåˆ™æˆ‘ä»¬å¿…é¡»è‡ªå·±æ¥é‡Šæ”¾<code>getcwd</code>åœ¨å†…éƒ¨åˆ›å»ºçš„è¿™å—å†…å­˜ã€‚</p>
<p><code>getcwd</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæŒ‡å‘ç›®æ ‡å­˜å‚¨åŒºï¼ˆ<code>buf</code>æŒ‡å‘çš„ç¼“å­˜åŒºæˆ–æ˜¯<code>getcwd</code>åœ¨å†…éƒ¨åŠ¨æ€åˆ›å»ºçš„ç¼“å­˜åŒºï¼‰çš„æŒ‡é’ˆï¼Œå¤±è´¥åˆ™è¿”å›<code>NULL</code>å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>chdir</code>å‡½æ•°çš„<code>path</code>å‚æ•°æŒ‡å®šè¦åˆ‡æ¢åˆ°çš„ç›®æ ‡ç›®å½•ã€‚å®ƒæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æ”¹å˜è¿›ç¨‹æ ¹ç›®å½•å¯ä»¥ä½¿ç”¨<code>chroot</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">chroot</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path)</span>;</span><br></pre></td></tr></table></figure>
<p><code>path</code>å‚æ•°æŒ‡å®šè¦åˆ‡æ¢åˆ°çš„ç›®æ ‡æ ¹ç›®å½•ã€‚å®ƒæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>chroot</code><strong>å¹¶ä¸æ”¹å˜</strong>è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½•ã€‚</p>
<p>æ”¹å˜è¿›ç¨‹çš„æ ¹ç›®å½•ä¹‹åï¼Œç¨‹åºå¯èƒ½æ— æ³•è®¿é—®ç±»ä¼¼<code>/dev</code>çš„æ–‡ä»¶ï¼ˆå’Œç›®å½•)ï¼Œå› ä¸ºè¿™äº›æ–‡ä»¶ï¼ˆå’Œç›®å½•ã€‰å¹¶éå¤„äºæ–°çš„æ ¹ç›®å½•ä¹‹ä¸‹ã€‚ä¸è¿‡å¥½åœ¨è°ƒç”¨<code>chroot</code>ä¹‹åï¼Œè¿›ç¨‹åŸå…ˆæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¾ç„¶ç”Ÿæ•ˆï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™äº›æ—©å…ˆæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ¥è®¿é—®è°ƒç”¨<code>chroot</code>ä¹‹åä¸èƒ½ç›´æ¥è®¿é—®çš„æ–‡ä»¶ï¼ˆå’Œç›®å½•)ï¼Œå°¤å…¶æ˜¯ä¸€äº›æ—¥å¿—æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œåªæœ‰<strong>ç‰¹æƒè¿›</strong>ç¨‹æ‰èƒ½æ”¹å˜æ ¹ç›®å½•ã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šçº¿ç¨‹ç¼–ç¨‹</title>
    <url>/2022/09/18/Linux/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="å¤šçº¿ç¨‹ç¼–ç¨‹"><a href="#å¤šçº¿ç¨‹ç¼–ç¨‹" class="headerlink" title="å¤šçº¿ç¨‹ç¼–ç¨‹"></a>å¤šçº¿ç¨‹ç¼–ç¨‹</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬åå››ç« å¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œé‡Œé¢ä»‹ç»äº†å„ç§Linuxç¼–ç¨‹ä¸­å¤šçº¿ç¨‹ç¼–ç¨‹çš„å†…å®¹ï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚</p>
<p>è¿™ä¸€ç« åˆ†ä¸ºåˆ›å»ºçº¿ç¨‹å’Œç»“æŸçº¿ç¨‹ã€çº¿ç¨‹å±æ€§ã€Posixä¿¡å·é‡ã€äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€‚</p>
<span id="more"></span>
<h2 id="åˆ›å»ºçº¿ç¨‹å’Œç»“æŸçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹å’Œç»“æŸçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹å’Œç»“æŸçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹å’Œç»“æŸçº¿ç¨‹</h2><h3 id="pthread-create"><a href="#pthread-create" class="headerlink" title="pthread_create"></a>pthread_create</h3><p>åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨<code>pthread_create</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *thread, <span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> *(*start_routine) (<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>thread</code>å‚æ•°æ˜¯æ–°çº¿ç¨‹çš„æ ‡è¯†ç¬¦ï¼Œåç»­<code>pthread_*</code>å‡½æ•°é€šè¿‡å®ƒæ¥å¼•å…¥æ–°çº¿ç¨‹ã€‚</p>
<p>å…¶ç±»å‹<code>pthread_r</code>å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Thread identifiers.  The structure of the attribute type is not</span></span><br><span class="line"><span class="comment">   exposed on purpose.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">int</span> <span class="type">pthread_t</span>;</span><br></pre></td></tr></table></figure>
<p><code>pthread_t</code>æ˜¯ä¸€ä¸ªæ•´å‹ç±»å‹ã€‚å®é™…ä¸Šï¼ŒLinux ä¸Šå‡ ä¹æ‰€æœ‰çš„èµ„æºæ ‡è¯†ç¬¦éƒ½æ˜¯ä¸€ä¸ªæ•´å‹æ•°ï¼Œæ¯”å¦‚<code>socket</code>ã€å„ç§<code>System V IPC</code>æ ‡è¯†ç¬¦ç­‰ã€‚</p>
<p><code>attr</code>å‚æ•°ç”¨äºè®¾ç½®æ–°çº¿ç¨‹çš„å±æ€§ã€‚ç»™å®ƒ<code>NULL</code>è¡¨ç¤ºä½¿ç”¨é»˜è®¤çº¿ç¨‹å±æ€§ã€‚çº¿ç¨‹æ‹¥æœ‰ä¼—å¤šå±æ€§ã€‚</p>
<p><code>start_routine</code>å’Œ<code>arg</code>å‚æ•°åˆ†åˆ«æŒ‡å®šæ–°çº¿ç¨‹å°†è¿è¡Œçš„å‡½æ•°ä»¥åŠå…¶å‚æ•°ã€‚</p>
<p><code>pthread_create</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›é”™è¯¯ç ã€‚ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‰“å¼€çš„çº¿ç¨‹æ•°é‡ä¸èƒ½è¶…è¿‡<code>RLIMIT_NPROC</code>è½¯èµ„æºé™åˆ¶ã€‚æ­¤å¤–ï¼Œç³»ç»Ÿä¸Šæ‰€æœ‰ç”¨æˆ·èƒ½åˆ›å»ºçš„çº¿ç¨‹æ€»æ•°ä¹Ÿä¸å¾—è¶…è¿‡<code>/proc/sys/kernel/threads-max</code>å†…æ ¸å‚æ•°æ‰€å®šä¹‰çš„å€¼ã€‚</p>
<p>eg:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> p = *(<span class="type">int</span> *)arg; <span class="comment">//å¼ºè½¬.</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--I&#x27;m the thread: pid = %d, tid= %lu, arg is %d\n&quot;</span>, getpid(), pthread_self(), p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> p = <span class="number">12</span>;</span><br><span class="line">    ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_func, (<span class="type">void</span> *)&amp;p); <span class="comment">// i ä¼ å‚é‡‡ç”¨ å€¼ä¼ é€’. å€ŸåŠ©å¼ºè½¬.</span></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sys_err(<span class="string">&quot;pthread_create error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main: I&#x27;m Main, pid = %d, tid= %lu\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220922125439092.png" alt="image-20220922125439092"></p>
<h3 id="pthread-exit"><a href="#pthread-exit" class="headerlink" title="pthread_exit"></a>pthread_exit</h3><p>çº¿ç¨‹ä¸€æ—¦è¢«åˆ›å»ºå¥½ï¼Œå†…æ ¸å°±å¯ä»¥è°ƒåº¦å†…æ ¸çº¿ç¨‹æ¥æ‰§è¡Œ<code>start_routine</code>å‡½æ•°æŒ‡é’ˆæ‰€æŒ‡å‘çš„å‡½æ•°äº†ã€‚çº¿ç¨‹å‡½æ•°åœ¨ç»“æŸæ—¶æœ€å¥½è°ƒç”¨å¦‚ä¸‹å‡½æ•°ï¼Œä»¥ç¡®ä¿å®‰å…¨ã€å¹²å‡€åœ°é€€å‡º:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_exit</span><span class="params">(<span class="type">void</span> *retval)</span>;</span><br></pre></td></tr></table></figure>
<p><code>pthread_exit</code>å‡½æ•°é€šè¿‡<code>retval</code>å‚æ•°å‘çº¿ç¨‹çš„å›æ”¶è€…ä¼ é€’å…¶é€€å‡ºä¿¡æ¯ã€‚å®ƒæ‰§è¡Œå®Œä¹‹åä¸ä¼šè¿”å›åˆ°è°ƒç”¨è€…ï¼Œè€Œä¸”æ°¸è¿œä¸ä¼šå¤±è´¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>); <span class="comment">// å°†å½“å‰çº¿ç¨‹é€€å‡º</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> p = *(<span class="type">int</span> *)arg; <span class="comment">//å¼ºè½¬.</span></span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// exit(0);            // è¡¨ç¤ºé€€å‡ºè¿›ç¨‹.</span></span><br><span class="line">        <span class="comment">// return NULL;          // è¡¨ç¤ºè¿”å›åˆ°è°ƒç”¨è€…é‚£é‡Œå».</span></span><br><span class="line">        <span class="comment">// func();</span></span><br><span class="line">        pthread_exit(<span class="literal">NULL</span>); <span class="comment">// å°†å½“å‰çº¿ç¨‹é€€å‡º</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--I&#x27;m the thread: pid = %d, tid= %lu, arg is %d\n&quot;</span>, getpid(), pthread_self(), p);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> p = <span class="number">2</span>;</span><br><span class="line">    ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_func, (<span class="type">void</span> *)&amp;p); <span class="comment">// i ä¼ å‚é‡‡ç”¨ å€¼ä¼ é€’. å€ŸåŠ©å¼ºè½¬.</span></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sys_err(<span class="string">&quot;pthread_create error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main: I&#x27;m Main, pid = %d, tid= %lu\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220922130320204.png" alt="image-20220922130320204"></p>
<h3 id="pthread-join"><a href="#pthread-join" class="headerlink" title="pthread_join"></a>pthread_join</h3><p>ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è°ƒç”¨<code>pthread_join</code>å‡½æ•°æ¥å›æ”¶å…¶ä»–çº¿ç¨‹ï¼ˆå‰ææ˜¯ç›®æ ‡çº¿ç¨‹æ˜¯å¯å›æ”¶çš„)ï¼Œå³ç­‰å¾…å…¶ä»–çº¿ç¨‹ç»“æŸï¼Œè¿™ç±»ä¼¼äºå›æ”¶è¿›ç¨‹çš„<code>wait</code>å’Œ <code>waitpid</code>ç³»ç»Ÿè°ƒç”¨ã€‚<code>pthrcad_join</code>çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br></pre></td></tr></table></figure>
<p><code>thread</code>å‚æ•°æ˜¯ç›®æ ‡çº¿ç¨‹çš„æ ‡è¯†ç¬¦ï¼Œ<code>retval</code>å‚æ•°åˆ™æ˜¯ç›®æ ‡çº¿ç¨‹è¿”å›çš„é€€å‡ºä¿¡æ¯ã€‚è¯¥å‡½æ•°ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°è¢«å›æ”¶çš„çº¿ç¨‹ç»“æŸä¸ºæ­¢ã€‚è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚å¯èƒ½çš„é”™è¯¯ç å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220920105152473.png" alt="image-20220920105152473"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">	perror(str);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">tfn</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *)<span class="number">74</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="type">int</span> *retval;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, tfn, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;pthread_create error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = pthread_join(tid, (<span class="type">void</span> **)&amp;retval);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;pthread_join error&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;child thread exit with %d\n&quot;</span>, (<span class="type">void</span> *)retval);</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220922202736277.png" alt="image-20220922202736277"></p>
<h3 id="pthread-cancel"><a href="#pthread-cancel" class="headerlink" title="pthread_cancel"></a>pthread_cancel</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå–æ¶ˆçº¿ç¨‹ï¼Œå¯ä»¥é€šè¿‡<code>pthread_cancel</code>å‡½æ•°å®ç°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br></pre></td></tr></table></figure>
<p><code>thread</code>å‚æ•°æ˜¯ç›®æ ‡çº¿ç¨‹çš„æ ‡è¯†ç¬¦ã€‚è¯¥å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚ä¸è¿‡ï¼Œæ¥æ”¶åˆ°å–æ¶ˆè¯·æ±‚çš„<strong>ç›®æ ‡çº¿ç¨‹</strong>å¯ä»¥å†³å®šæ˜¯å¦å…è®¸è¢«å–æ¶ˆä»¥åŠå¦‚ä½•å–æ¶ˆï¼Œè¿™åˆ†åˆ«ç”±å¦‚ä¸‹ä¸¤ä¸ªå‡½æ•°å®Œæˆ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_setcancelstate</span><span class="params">(<span class="type">int</span> state, <span class="type">int</span> *oldstate)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_setcanceltype</span><span class="params">(<span class="type">int</span> type, <span class="type">int</span> *oldtype)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸¤ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°åˆ†åˆ«ç”¨äºè®¾ç½®çº¿ç¨‹çš„å–æ¶ˆçŠ¶æ€ï¼ˆæ˜¯å¦å…è®¸å–æ¶ˆï¼‰å’Œå–æ¶ˆç±»å‹(å¦‚ä½•å–æ¶ˆ)ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™åˆ†åˆ«è®°å½•çº¿ç¨‹åŸæ¥çš„å–æ¶ˆçŠ¶æ€å’Œå–æ¶ˆç±»å‹ã€‚<code>state</code>å‚æ•°æœ‰ä¸¤ä¸ªå¯é€‰å€¼:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220920110543454.png" alt="image-20220920110543454"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">tfn</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread: pid = %d, tid = %lu\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, tfn, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_create error:%s\n&quot;</span>, strerror(ret));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main: pid = %d, tid = %lu\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    ret = pthread_cancel(tid); <span class="comment">// ç»ˆæ­¢çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_cancel error:%s\n&quot;</span>, strerror(ret));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;after 5s tid = %lu is cancel\n&quot;</span>, tid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220922203738758.png" alt="image-20220922203738758"></p>
<h2 id="çº¿ç¨‹å±æ€§"><a href="#çº¿ç¨‹å±æ€§" class="headerlink" title="çº¿ç¨‹å±æ€§"></a>çº¿ç¨‹å±æ€§</h2><p><code>pthread_attr_t</code>ç»“æ„ä½“å®šä¹‰äº†ä¸€å¥—å®Œæ•´çš„çº¿ç¨‹å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">pthread_attr_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> __size[__SIZEOF_PTHREAD_ATTR_T];</span><br><span class="line">  <span class="type">long</span> <span class="type">int</span> __align;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å„ç§çº¿ç¨‹å±æ€§å…¨éƒ¨åŒ…å«åœ¨ä¸€ä¸ªå­—ç¬¦æ•°ç»„ä¸­ã€‚çº¿ç¨‹åº“å®šä¹‰äº†ä¸€ç³»åˆ—å‡½æ•°æ¥æ“ä½œ<code>pthread_attr_t</code>ç±»å‹çš„å˜é‡ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬è·å–å’Œè®¾ç½®çº¿ç¨‹å±æ€§ã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–çº¿ç¨‹å±æ€§å¯¹è±¡ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_init</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>;</span><br><span class="line"><span class="comment">/* é”€æ¯çº¿ç¨‹å±æ€§å¯¹è±¡ã€‚è¢«é”€æ¯çš„çº¿ç¨‹å±æ€§å¯¹è±¡åªæœ‰å†æ¬¡åˆå§‹åŒ–ä¹‹åæ‰èƒ½ç»§ç»­ä½¿ç”¨ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_destroy</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setdetachstate</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> detachstate)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getdetachstate</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> *detachstate)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstackaddr</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> *stackaddr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstackaddr</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">void</span> **stackaddr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstacksize</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *stacksize)</span>;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>çº¿ç¨‹å±æ€§ï¼š</p>
<ul>
<li><code>detachstate</code>ï¼Œçº¿ç¨‹çš„è„±ç¦»çŠ¶æ€ã€‚å®ƒæœ‰<code>PTHREAD_CREATE_JOINABLE</code>å’Œ<code>PTHREAD_CREATE_DETACH</code>ä¸¤ä¸ªå¯é€‰å€¼ã€‚å‰è€…æŒ‡å®šçº¿ç¨‹æ˜¯å¯ä»¥è¢«å›æ”¶çš„ï¼Œåè€…ä½¿è°ƒç”¨çº¿ç¨‹è„±ç¦»ä¸è¿›ç¨‹ä¸­å…¶ä»–çº¿ç¨‹çš„åŒæ­¥ã€‚è„±ç¦»äº†ä¸å…¶ä»–çº¿ç¨‹åŒæ­¥çš„çº¿ç¨‹ç§°ä¸ºâ€œè„±ç¦»çº¿ç¨‹â€ã€‚è„±ç¦»çº¿ç¨‹åœ¨é€€å‡ºæ—¶å°†è‡ªè¡Œé‡Šæ”¾å…¶å ç”¨çš„ç³»ç»Ÿèµ„æºã€‚çº¿ç¨‹åˆ›å»ºæ—¶è¯¥å±æ€§çš„é»˜è®¤å€¼æ˜¯<code>PTHREAD_CREATE_JOINABLE</code>ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨<code>pthread_detach</code>å‡½æ•°ç›´æ¥å°†çº¿ç¨‹è®¾ç½®ä¸ºè„±ç¦»çº¿ç¨‹ã€‚</li>
<li><code>stackaddr</code>å’Œ<code>stacksize</code>ï¼Œçº¿ç¨‹å †æ ˆçš„èµ·å§‹åœ°å€å’Œå¤§å°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±æ¥ç®¡ç†çº¿ç¨‹å †æ ˆï¼Œå› ä¸ºLinuxé»˜è®¤ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…äº†è¶³å¤Ÿçš„å †æ ˆç©ºé—´ï¼ˆä¸€èˆ¬æ˜¯8 MB)ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ulimt -så‘½ä»¤æ¥æŸ¥çœ‹æˆ–ä¿®æ”¹è¿™ä¸ªé»˜è®¤å€¼ã€‚</li>
<li><code>guardsize</code>ï¼Œä¿æŠ¤åŒºåŸŸå¤§å°ã€‚å¦‚æœ<code>guardsize</code>å¤§äº0ï¼Œåˆ™ç³»ç»Ÿåˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ä¼šåœ¨å…¶å †æ ˆçš„å°¾éƒ¨é¢å¤–åˆ†é…<code>guardsize</code>å­—èŠ‚çš„ç©ºé—´ï¼Œä½œä¸ºä¿æŠ¤å †æ ˆä¸è¢«é”™è¯¯åœ°è¦†ç›–çš„åŒºåŸŸã€‚å¦‚æœ<code>guardsize</code>ç­‰äº0ï¼Œåˆ™ç³»ç»Ÿä¸ä¸ºæ–°åˆ›å»ºçš„çº¿ç¨‹è®¾ç½®å †æ ˆä¿æŠ¤åŒºã€‚å¦‚æœä½¿ç”¨è€…é€šè¿‡<code>pthread_attr_setstackaddr</code>æˆ–<code>pthread_attr_setstack</code>å‡½æ•°æ‰‹åŠ¨è®¾ç½®çº¿ç¨‹çš„å †æ ˆï¼Œåˆ™<code>guardsize</code>å±æ€§å°†è¢«å¿½ç•¥ã€‚</li>
<li><code>schedparam</code>ï¼Œçº¿ç¨‹è°ƒåº¦å‚æ•°ã€‚å…¶ç±»å‹æ˜¯<code>sched_param</code>ç»“æ„ä½“ã€‚è¯¥ç»“æ„ä½“ç›®å‰è¿˜åªæœ‰ä¸€ä¸ªæ•´å‹ç±»å‹çš„æˆå‘˜:<code>sched_priority</code>ï¼Œè¯¥æˆå‘˜è¡¨ç¤ºçº¿ç¨‹çš„è¿è¡Œä¼˜å…ˆçº§ã€‚</li>
<li><code>schedpolicy</code>ï¼Œçº¿ç¨‹è°ƒåº¦ç­–ç•¥ã€‚è¯¥å±æ€§æœ‰<code>SCHED_FIFO</code>ã€<code>SCHED_RR</code>å’Œ<code>SCHED_OTHER</code>ä¸‰ä¸ªå¯é€‰å€¼ï¼Œå…¶ä¸­<code>SCHED_OTHER</code>æ˜¯é»˜è®¤å€¼ã€‚<code>SCHED_RR</code>è¡¨ç¤ºé‡‡ç”¨è½®è½¬ç®—æ³•(round-robinï¼‰è°ƒåº¦ï¼Œ<code>SCHED_FIFO</code>è¡¨ç¤ºä½¿ç”¨å…ˆè¿›å…ˆå‡ºçš„æ–¹æ³•è°ƒåº¦ï¼Œè¿™ä¸¤ç§è°ƒåº¦æ–¹æ³•éƒ½å…·å¤‡å®æ—¶è°ƒåº¦åŠŸèƒ½ï¼Œä½†åªèƒ½ç”¨äºä»¥è¶…çº§ç”¨æˆ·èº«ä»½è¿è¡Œçš„è¿›ç¨‹ã€‚</li>
<li><code>inheritsched</code>ï¼Œæ˜¯å¦ç»§æ‰¿è°ƒç”¨çº¿ç¨‹çš„è°ƒåº¦å±æ€§ã€‚è¯¥å±æ€§æœ‰<code>PTHREAD_INHERIT_SCHED</code> å’Œ<code>PTHREAD_EXPLICIT_SCHED</code>ä¸¤ä¸ªå¯é€‰å€¼ã€‚å‰è€…è¡¨ç¤ºæ–°çº¿ç¨‹æ²¿ç”¨å…¶åˆ›å»ºè€…çš„çº¿ç¨‹è°ƒåº¦å‚æ•°ï¼Œè¿™ç§æƒ…å†µä¸‹å†è®¾ç½®æ–°çº¿ç¨‹çš„è°ƒåº¦å‚æ•°å±æ€§å°†æ²¡æœ‰ä»»ä½•æ•ˆæœã€‚åè€…è¡¨ç¤ºè°ƒç”¨è€…è¦æ˜ç¡®åœ°æŒ‡å®šæ–°çº¿ç¨‹çš„è°ƒåº¦å‚æ•°ã€‚</li>
<li><code>scope</code>ï¼Œçº¿ç¨‹é—´ç«äº‰CPUçš„èŒƒå›´ï¼Œå³çº¿ç¨‹ä¼˜å…ˆçº§çš„æœ‰æ•ˆèŒƒå›´ã€‚POSIXæ ‡å‡†å®šä¹‰äº†è¯¥å±æ€§çš„<code>PTHREAD_SCOPE_SYSTEM</code>å’Œ<code>PTHREAD_SCOPE_PROCESS</code>ä¸¤ä¸ªå¯é€‰å€¼ï¼Œå‰è€…è¡¨ç¤ºç›®æ ‡çº¿ç¨‹ä¸ç³»ç»Ÿä¸­æ‰€æœ‰çº¿ç¨‹ä¸€èµ·ç«äº‰CPUçš„ä½¿ç”¨ï¼Œåè€…è¡¨ç¤ºç›®æ ‡çº¿ç¨‹ä»…ä¸å…¶ä»–éš¶å±äºåŒä¸€è¿›ç¨‹çš„çº¿ç¨‹ç«äº‰CPUçš„ä½¿ç”¨ã€‚ç›®å‰Linuxåªæ”¯æŒ<code>PTHREAD_SCOPE_SYSTEM</code>è¿™ä¸€ç§å–å€¼ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">tfn</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> n = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (n--)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread count %d\n&quot;</span>, n);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> ret = <span class="number">42</span>;</span><br><span class="line">    pthread_exit((<span class="type">void</span> *)&amp;ret);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="type">void</span> *tret;</span><br><span class="line">    <span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_attr_t</span> attr; <span class="comment">/*é€šè¿‡çº¿ç¨‹å±æ€§æ¥è®¾ç½®æ¸¸ç¦»æ€*/</span></span><br><span class="line"></span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line">    pthread_create(&amp;tid, &amp;attr, tfn, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        err = pthread_join(tid, &amp;tret);</span><br><span class="line">        <span class="comment">// å› ä¸ºçº¿ç¨‹æ˜¯æ¸¸ç¦»æ€ï¼Œæ‰€ä»¥joinä¸ä¼šæˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (err != <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;thread_join error: %s\n&quot;</span>, strerror(err));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;thread exit code %d\n&quot;</span>, *(<span class="type">int</span> *)tret);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220924113718288.png" alt="image-20220924113718288"></p>
<h2 id="POSIXä¿¡å·é‡"><a href="#POSIXä¿¡å·é‡" class="headerlink" title="POSIXä¿¡å·é‡"></a>POSIXä¿¡å·é‡</h2><p>å¤šçº¿ç¨‹è®¿é—®ç›¸åŒçš„èµ„æºæ—¶ï¼Œä¹Ÿå­˜åœ¨åŒæ­¥çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦åŒæ­¥æœºåˆ¶ã€‚è¿™é‡Œçš„POSIXä¿¡å·é‡å°±æ˜¯çº¿ç¨‹åŒæ­¥çš„æœºåˆ¶ä¹‹ä¸€ã€‚POSIXä¿¡å·é‡å’Œå¤šè¿›ç¨‹ç¼–ç¨‹ï¼ˆSystem V IPCï¼‰å½“ä¸­çš„ä¿¡å·é‡è¯­ä¹‰ä¸Šæ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯èƒ½å¤Ÿè¿›è¡Œæ··ç”¨ï¼Œæ‰€ä»¥åœ¨çº¿ç¨‹å½“ä¸­è¿˜æ˜¯ä½¿ç”¨POSIXæ¯”è¾ƒå¥½ã€‚</p>
<p>POSIXä¿¡å·é‡å‡½æ•°çš„åå­—éƒ½ä»¥<code>sem_</code>å¼€å¤´ï¼Œå¹¶ä¸åƒå¤§å¤šæ•°çº¿ç¨‹å‡½æ•°é‚£æ ·ä»¥<code>pthread_</code>å¼€å¤´ã€‚å¸¸ç”¨çš„POSIXä¿¡å·é‡å‡½æ•°æ˜¯ä¸‹é¢5ä¸ª:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_init</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">int</span> pshared, <span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_destroy</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_wait</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_trywait</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_post</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br></pre></td></tr></table></figure>
<p>è¿™äº›å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°semæŒ‡å‘è¢«æ“ä½œçš„ä¿¡å·é‡ã€‚</p>
<p><code>sem_init</code>å‡½æ•°ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªæœªå‘½åçš„ä¿¡å·é‡(POSIXä¿¡å·é‡APIæ”¯æŒå‘½åä¿¡å·é‡ï¼Œä¸è¿‡åœ¨ä¹¦ä¸­ä¸è®¨è®ºå®ƒ)ã€‚<code>pshared</code>å‚æ•°æŒ‡å®šä¿¡å·é‡çš„ç±»å‹ã€‚å¦‚æœå…¶å€¼ä¸º0ï¼Œå°±è¡¨ç¤ºè¿™ä¸ªä¿¡å·é‡æ˜¯å½“å‰è¿›ç¨‹çš„å±€éƒ¨ä¿¡å·é‡ï¼Œå¦åˆ™è¯¥ä¿¡å·é‡å°±å¯ä»¥åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´å…±äº«ã€‚<code>value</code>å‚æ•°æŒ‡å®šä¿¡å·é‡çš„åˆå§‹å€¼ã€‚æ­¤å¤–ï¼Œåˆå§‹åŒ–ä¸€ä¸ªå·²ç»è¢«åˆå§‹åŒ–çš„ä¿¡å·é‡å°†å¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚</p>
<p><code>sem_destroy</code>å‡½æ•°ç”¨äºé”€æ¯ä¿¡å·é‡ï¼Œä»¥é‡Šæ”¾å…¶å ç”¨çš„å†…æ ¸èµ„æºã€‚å¦‚æœé”€æ¯ä¸€ä¸ªæ­£è¢«å…¶ä»–çº¿ç¨‹ç­‰å¾…çš„ä¿¡å·é‡ï¼Œåˆ™å°†å¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚</p>
<p><code>sem_wait</code>å‡½æ•°ä»¥åŸå­æ“ä½œçš„æ–¹å¼å°†ä¿¡å·é‡çš„å€¼å‡1ã€‚å¦‚æœä¿¡å·é‡çš„å€¼ä¸º0ï¼Œåˆ™<code>sem_wait</code>å°†è¢«é˜»å¡ï¼Œç›´åˆ°è¿™ä¸ªä¿¡å·é‡å…·æœ‰é0å€¼ã€‚</p>
<p><code>sem_trywait</code>ä¸<code>sem_wait</code>å‡½æ•°ç›¸ä¼¼ï¼Œä¸è¿‡å®ƒå§‹ç»ˆç«‹å³è¿”å›ï¼Œè€Œä¸è®ºè¢«æ“ä½œçš„ä¿¡å·é‡æ˜¯å¦å…·æœ‰é0å€¼ï¼Œç›¸å½“äº<code>sem_wait</code>çš„éé˜»å¡ç‰ˆæœ¬ã€‚å½“ä¿¡å·é‡çš„å€¼é0æ—¶ï¼Œ<code>sem_trywait</code>å¯¹ä¿¡å·é‡æ‰§è¡Œå‡1æ“ä½œã€‚å½“ä¿¡å·é‡çš„å€¼ä¸º0æ—¶ï¼Œå®ƒå°†è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ä¸º<code>EAGAIN</code>ã€‚</p>
<p><code>sem_post</code>å‡½æ•°ä»¥åŸå­æ“ä½œçš„æ–¹å¼å°†ä¿¡å·é‡çš„å€¼åŠ 1ã€‚å½“ä¿¡å·é‡çš„å€¼å¤§äº0æ—¶ï¼Œå…¶ä»–æ­£åœ¨è°ƒç”¨<code>sem_wait</code>ç­‰å¾…ä¿¡å·é‡çš„çº¿ç¨‹å°†è¢«å”¤é†’ã€‚</p>
<p>ä½¿ç”¨ä¿¡å·é‡å®Œæˆçš„ç”Ÿäº§è€…æ¶ˆè´¹è€…</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*ä¿¡å·é‡å®ç° ç”Ÿäº§è€… æ¶ˆè´¹è€…é—®é¢˜*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 5</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="built_in">queue</span>[NUM];                     <span class="comment">//å…¨å±€æ•°ç»„å®ç°ç¯å½¢é˜Ÿåˆ—</span></span><br><span class="line"><span class="type">sem_t</span> blank_number, product_number; <span class="comment">//ç©ºæ ¼å­ä¿¡å·é‡, äº§å“ä¿¡å·é‡</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sem_wait(&amp;blank_number);      <span class="comment">//ç”Ÿäº§è€…å°†ç©ºæ ¼å­æ•°--,ä¸º0åˆ™é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="built_in">queue</span>[i] = rand() % <span class="number">1000</span> + <span class="number">1</span>; <span class="comment">//ç”Ÿäº§ä¸€ä¸ªäº§å“</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----Produce---%d\n&quot;</span>, <span class="built_in">queue</span>[i]);</span><br><span class="line">        sem_post(&amp;product_number); <span class="comment">//å°†äº§å“æ•°++</span></span><br><span class="line"></span><br><span class="line">        i = (i + <span class="number">1</span>) % NUM; <span class="comment">//å€ŸåŠ©ä¸‹æ ‡å®ç°ç¯å½¢</span></span><br><span class="line">        sleep(rand() % <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sem_wait(&amp;product_number); <span class="comment">//æ¶ˆè´¹è€…å°†äº§å“æ•°--,ä¸º0åˆ™é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-Consume---%d\n&quot;</span>, <span class="built_in">queue</span>[i]);</span><br><span class="line">        <span class="built_in">queue</span>[i] = <span class="number">0</span>;            <span class="comment">//æ¶ˆè´¹ä¸€ä¸ªäº§å“</span></span><br><span class="line">        sem_post(&amp;blank_number); <span class="comment">//æ¶ˆè´¹æ‰ä»¥å,å°†ç©ºæ ¼å­æ•°++</span></span><br><span class="line"></span><br><span class="line">        i = (i + <span class="number">1</span>) % NUM;</span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> pid, cid;</span><br><span class="line"></span><br><span class="line">    sem_init(&amp;blank_number, <span class="number">0</span>, NUM); <span class="comment">//åˆå§‹åŒ–ç©ºæ ¼å­ä¿¡å·é‡ä¸º5, çº¿ç¨‹é—´å…±äº« -- 0</span></span><br><span class="line">    sem_init(&amp;product_number, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">//äº§å“æ•°ä¸º0</span></span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, producer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;cid, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(pid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cid, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    sem_destroy(&amp;blank_number);</span><br><span class="line">    sem_destroy(&amp;product_number);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220927143404525.png" alt="image-20220927143404525"></p>
<h2 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h2><p>äº’æ–¥é”ï¼ˆä¹Ÿç§°äº’æ–¥é‡ï¼‰å¯ä»¥ç”¨äºä¿æŠ¤å…³é”®ä»£ç æ®µï¼Œä»¥ç¡®ä¿å…¶ç‹¬å å¼çš„è®¿é—®ï¼Œè¿™æœ‰ç‚¹åƒä¸€ä¸ªäºŒè¿›åˆ¶ä¿¡å·é‡ã€‚å½“è¿›å…¥å…³é”®ä»£ç æ®µæ—¶ï¼Œæˆ‘ä»¬éœ€è¦è·å¾—äº’æ–¥é”å¹¶å°†å…¶åŠ é”ï¼Œè¿™ç­‰ä»·äºäºŒè¿›åˆ¶ä¿¡å·é‡çš„Ğ æ“ä½œï¹”å½“ç¦»å¼€å…³é”®ä»£ç æ®µæ—¶ï¼Œæˆ‘ä»¬éœ€è¦å¯¹äº’æ–¥é”è§£é”ï¼Œä»¥å”¤é†’å…¶ä»–ç­‰å¾…è¯¥äº’æ–¥é”çš„çº¿ç¨‹ï¼Œè¿™ç­‰ä»·äºäºŒè¿›åˆ¶ä¿¡å·é‡çš„Væ“ä½œã€‚</p>
<h3 id="äº’æ–¥é”åŸºç¡€API"><a href="#äº’æ–¥é”åŸºç¡€API" class="headerlink" title="äº’æ–¥é”åŸºç¡€API"></a>äº’æ–¥é”åŸºç¡€API</h3><p>POSIXäº’æ–¥é”çš„ç›¸å…³å‡½æ•°ä¸»è¦æœ‰å¦‚ä¸‹5ä¸ª:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220927204729727.png" alt="image-20220927204729727"></p>
<p>è¿™äº›å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>mutex</code>æŒ‡å‘è¦æ“ä½œçš„ç›®æ ‡äº’æ–¥é”ï¼Œäº’æ–¥é”çš„ç±»å‹æ˜¯<code>pthread_mutex_t</code>ç»“æ„ä½“ã€‚</p>
<p><code>pthread_mutex_init</code>å‡½æ•°ç”¨äºåˆå§‹åŒ–äº’æ–¥é”ã€‚<code>mutexattr</code>å‚æ•°æŒ‡å®šäº’æ–¥é”çš„å±æ€§ã€‚å¦‚æœå°†å®ƒè®¾ç½®ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€å°èŠ‚è®¨è®ºäº’æ–¥é”çš„å±æ€§ã€‚é™¤äº†è¿™ä¸ªå‡½æ•°å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥åˆå§‹åŒ–ä¸€ä¸ªäº’æ–¥é”:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">pthread_mutex_t</span> mutex = PTHREAD_MUTEX_INITIALIZER</span><br></pre></td></tr></table></figure>
<p>å®<code>PTHREAD_MUTEX_INITIALIZER</code>å®é™…ä¸Šåªæ˜¯æŠŠäº’æ–¥é”çš„å„ä¸ªå­—æ®µéƒ½åˆå§‹åŒ–ä¸º0ã€‚<code>pthread_mutex_destroy</code>å‡½æ•°ç”¨äºé”€æ¯äº’æ–¥é”ï¼Œä»¥é‡Šæ”¾å…¶å ç”¨çš„å†…æ ¸èµ„æºã€‚é”€æ¯ä¸€ä¸ªå·²ç»åŠ é”çš„äº’æ–¥é”å°†å¯¼è‡´ä¸å¯é¢„æœŸçš„åæœã€‚<code>pthread_mutex_lock</code>å‡½æ•°ä»¥åŸå­æ“ä½œçš„æ–¹å¼ç»™ä¸€ä¸ªäº’æ–¥é”åŠ é”ã€‚å¦‚æœç›®æ ‡äº’æ–¥é”å·²ç»è¢«é”ä¸Šï¼Œ<code>pthread_mutex_lock</code>è°ƒç”¨å°†é˜»å¡ï¼Œç›´åˆ°è¯¥äº’æ–¥é”çš„å æœ‰è€…å°†å…¶è§£é”ã€‚</p>
<p><code>pthread_mutex_trylock</code>ä¸<code>pthread_mutex_lock</code>å‡½æ•°ç±»ä¼¼ï¼Œä¸è¿‡å®ƒå§‹ç»ˆç«‹å³è¿”å›ï¼Œè€Œä¸è®ºè¢«æ“ä½œçš„äº’æ–¥é”æ˜¯å¦å·²ç»è¢«åŠ é”ï¼Œç›¸å½“äº<code>pthread_mutex_lock</code>çš„éé˜»å¡ç‰ˆæœ¬ã€‚å½“ç›®æ ‡äº’æ–¥é”æœªè¢«åŠ é”æ—¶ï¼Œ<code>pthread_mutex_trylock</code>å¯¹äº’æ–¥é”æ‰§è¡ŒåŠ é”æ“ä½œã€‚å½“äº’æ–¥é”å·²ç»è¢«åŠ é”æ—¶ï¼Œ<code>pthread_mutex_trylock</code>å°†è¿”å›é”™è¯¯ç <code>EBUSY</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œè®¨è®ºçš„<code>pthread_mutex_lock</code>å’Œ<code>pthread_mutex_trylock</code>çš„è¡Œä¸ºæ˜¯é’ˆå¯¹æ™®é€šé”è€Œè¨€çš„ã€‚åé¢æˆ‘ä»¬å°†çœ‹åˆ°ï¼Œå¯¹äºå…¶ä»–ç±»å‹çš„é”è€Œè¨€ï¼Œè¿™ä¸¤ä¸ªåŠ é”å‡½æ•°ä¼šæœ‰ä¸åŒçš„è¡Œä¸ºã€‚</p>
<p><code>pthread_mutex_unlock</code>å‡½æ•°ä»¥åŸå­æ“ä½œçš„æ–¹å¼ç»™ä¸€ä¸ªäº’æ–¥é”è§£é”ã€‚å¦‚æœæ­¤æ—¶æœ‰å…¶ä»–çº¿ç¨‹æ­£åœ¨ç­‰å¾…è¿™ä¸ªäº’æ–¥é”ï¼Œåˆ™è¿™äº›çº¿ç¨‹ä¸­çš„æŸä¸€ä¸ªå°†è·å¾—å®ƒã€‚</p>
<p>ä¸Šé¢è¿™äº›å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚</p>
<h3 id="äº’æ–¥é”å±æ€§"><a href="#äº’æ–¥é”å±æ€§" class="headerlink" title="äº’æ–¥é”å±æ€§"></a>äº’æ–¥é”å±æ€§</h3><p><code>pthread_mutexattr_t</code>ç»“æ„ä½“å®šä¹‰äº†ä¸€å¥—å®Œæ•´çš„äº’æ–¥é”å±æ€§ã€‚çº¿ç¨‹åº“æä¾›äº†ä¸€ç³»åˆ—å‡½æ•°æ¥æ“ä½œ<code>pthread_mutexattr_t</code>ç±»å‹çš„å˜é‡ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬è·å–å’Œè®¾ç½®äº’æ–¥é”å±æ€§ã€‚è¿™é‡Œæˆ‘ä»¬åˆ—å‡ºå…¶ä¸­ä¸€äº›ä¸»è¦çš„å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220927211449413.png" alt="image-20220927211449413"></p>
<p>æœ¬ä¹¦åªè®¨è®ºäº’æ–¥é”çš„ä¸¤ç§å¸¸ç”¨å±æ€§:<code>pshared</code>å’Œ<code>type</code>ã€‚äº’æ–¥é”å±æ€§<code>pshared</code>æŒ‡å®šæ˜¯å¦å…è®¸è·¨è¿›ç¨‹å…±äº«äº’æ–¥é”ï¼Œå…¶å¯é€‰å€¼æœ‰ä¸¤ä¸ª:</p>
<ul>
<li><code>PTHREAD_PROCESS_SHARED</code>ã€‚äº’æ–¥é”å¯ä»¥è¢«è·¨è¿›ç¨‹å…±äº«ã€‚</li>
<li><code>PTHREAD_PROCESS_PRIVATE</code>ã€‚äº’æ–¥é”åªèƒ½è¢«å’Œé”çš„åˆå§‹åŒ–çº¿ç¨‹éš¶å±äºåŒä¸€ä¸ªè¿›ç¨‹çš„çº¿ç¨‹å…±äº«ã€‚</li>
</ul>
<p>äº’æ–¥é”å±æ€§typeæŒ‡å®šäº’æ–¥é”çš„ç±»å‹ã€‚Linuxæ”¯æŒå¦‚ä¸‹4ç§ç±»å‹çš„äº’æ–¥é”:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220928214206066.png" alt="image-20220928214206066"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*çº¿ç¨‹ä¹‹é—´å…±äº«èµ„æºstdout*/</span></span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">err_thread</span><span class="params">(<span class="type">int</span> ret, <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;%s:%s\n&quot;</span>, str, strerror(ret));</span><br><span class="line">        pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">tfn</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;mutex);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;hello &quot;</span>);</span><br><span class="line">        sleep(rand() % <span class="number">3</span>); <span class="comment">/*æ¨¡æ‹Ÿé•¿æ—¶é—´æ“ä½œå…±äº«èµ„æºï¼Œå¯¼è‡´cpuæ˜“ä¸»ï¼Œäº§ç”Ÿä¸æ—¶é—´æœ‰å…³çš„é”™è¯¯*/</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;world\n&quot;</span>);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex);</span><br><span class="line"></span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">5</span>;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;mutex, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;tid, <span class="literal">NULL</span>, tfn, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span> (flag--)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;mutex);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;HELLO &quot;</span>);</span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;WORLD\n&quot;</span>);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex);</span><br><span class="line"></span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_cancel(tid); <span class="comment">//  å°†å­çº¿ç¨‹æ€æ­»,å­çº¿ç¨‹ä¸­è‡ªå¸¦å–æ¶ˆç‚¹</span></span><br><span class="line">    pthread_join(tid, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_destroy(&amp;mutex);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// mainä¸­çš„returnå¯ä»¥å°†æ•´ä¸ªè¿›ç¨‹é€€å‡º</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220928214919210.png" alt="image-20220928214919210"></p>
<h2 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h2><p>å¦‚æœè¯´äº’æ–¥é”æ˜¯ç”¨äºåŒæ­¥çº¿ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®çš„è¯ï¼Œé‚£ä¹ˆæ¡ä»¶å˜é‡åˆ™æ˜¯ç”¨äºåœ¨çº¿ç¨‹ä¹‹é—´åŒæ­¥å…±äº«æ•°æ®çš„å€¼ã€‚æ¡ä»¶å˜é‡æä¾›äº†ä¸€ç§çº¿ç¨‹é—´çš„é€šçŸ¥æœºåˆ¶:å½“æŸä¸ªå…±äº«æ•°æ®è¾¾åˆ°æŸä¸ªå€¼çš„æ—¶å€™ï¼Œå”¤é†’ç­‰å¾…è¿™ä¸ªå…±äº«æ•°æ®çš„çº¿ç¨‹ã€‚</p>
<p>æ¡ä»¶å˜é‡çš„ç›¸å…³å‡½æ•°ä¸»è¦æœ‰å¦‚ä¸‹5ä¸ª:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220929110939180.png" alt="image-20220929110939180"></p>
<p>è¿™äº›å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°<code>cond</code>æŒ‡å‘è¦æ“ä½œçš„ç›®æ ‡æ¡ä»¶å˜é‡ï¼Œæ¡ä»¶å˜é‡çš„ç±»å‹æ˜¯<code>pthread_cond_t</code>ç»“æ„ä½“ã€‚</p>
<p><code>pthread_cond_init</code>å‡½æ•°ç”¨äºåˆå§‹åŒ–æ¡ä»¶å˜é‡ã€‚<code>cond_attr</code>å‚æ•°æŒ‡å®šæ¡ä»¶å˜é‡çš„å±æ€§ã€‚å¦‚æœå°†å®ƒè®¾ç½®ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºä½¿ç”¨é»˜è®¤å±æ€§ã€‚æ¡ä»¶å˜é‡çš„å±æ€§ä¸å¤šï¼Œè€Œå’Œäº’æ–¥é”çš„å±æ€§ç±»å‹ç›¸ä¼¼ã€‚é™¤äº†<code>pthread_cond_init</code>å‡½æ•°å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼æ¥åˆå§‹åŒ–ä¸€ä¸ªæ¡ä»¶å˜é‡:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br></pre></td></tr></table></figure>
<p>å®<code>PTHREAD_COND_INITIALIZER</code>å®é™…ä¸Šåªæ˜¯æŠŠæ¡ä»¶å˜é‡çš„å„ä¸ªå­—æ®µéƒ½åˆå§‹åŒ–ä¸º0ã€‚</p>
<p><code>pthread_cond_destroy</code>å‡½æ•°ç”¨äºé”€æ¯æ¡ä»¶å˜é‡ï¼Œä»¥é‡Šæ”¾å…¶å ç”¨çš„å†…æ ¸èµ„æºã€‚é”€æ¯ä¸€ä¸ªæ­£åœ¨è¢«ç­‰å¾…çš„æ¡ä»¶å˜é‡å°†å¤±è´¥å¹¶è¿”å›<code>EBUSY</code>ã€‚</p>
<p><code>pthread_cond_broadcast</code>å‡½æ•°ä»¥å¹¿æ’­çš„æ–¹å¼å”¤é†’æ‰€æœ‰ç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡çš„çº¿ç¨‹ã€‚</p>
<p><code>pthread_cond_signal</code>å‡½æ•°ç”¨äºå”¤é†’ä¸€ä¸ªç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡çš„çº¿ç¨‹ã€‚è‡³äºå“ªä¸ªçº¿ç¨‹å°†è¢«å”¤é†’ï¼Œåˆ™å–å†³äºçº¿ç¨‹çš„ä¼˜å…ˆçº§å’Œè°ƒåº¦ç­–ç•¥ã€‚æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½æƒ³å”¤é†’ä¸€ä¸ªæŒ‡å®šçš„çº¿ç¨‹ï¼Œä½†<code>pthread</code>æ²¡æœ‰å¯¹è¯¥éœ€æ±‚æä¾›è§£å†³æ–¹æ³•ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é—´æ¥åœ°å®ç°è¯¥éœ€æ±‚:å®šä¹‰ä¸€ä¸ªèƒ½å¤Ÿå”¯ä¸€è¡¨ç¤ºç›®æ ‡çº¿ç¨‹çš„å…¨å±€å˜é‡ï¼Œåœ¨å”¤é†’ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹å‰å…ˆè®¾ç½®è¯¥å˜é‡ä¸ºç›®æ ‡çº¿ç¨‹ï¼Œç„¶åé‡‡ç”¨å¹¿æ’­æ–¹å¼å”¤é†’æ‰€æœ‰ç­‰å¾…æ¡ä»¶å˜é‡çš„çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹è¢«å”¤é†’åéƒ½æ£€æŸ¥è¯¥å˜é‡ä»¥åˆ¤æ–­è¢«å”¤é†’çš„æ˜¯å¦æ˜¯è‡ªå·±ï¼Œå¦‚æœæ˜¯å°±å¼€å§‹æ‰§è¡Œåç»­ä»£ç ï¼Œå¦‚æœä¸æ˜¯åˆ™è¿”å›ç»§ç»­ç­‰å¾…ã€‚</p>
<p><code>pthread_cond_wait</code>å‡½æ•°ç”¨äºç­‰å¾…ç›®æ ‡æ¡ä»¶å˜é‡ã€‚<code>mutex</code>å‚æ•°æ˜¯ç”¨äºä¿æŠ¤æ¡ä»¶å˜é‡çš„äº’æ–¥é”ï¼Œä»¥ç¡®ä¿<code>pthread_cond_wait</code>æ“ä½œçš„åŸå­æ€§ã€‚åœ¨è°ƒç”¨<code>pthread_cond_wait</code>å‰ï¼Œå¿…é¡»ç¡®ä¿äº’æ–¥é”<code>mutex</code>å·²ç»åŠ é”ï¼Œå¦åˆ™å°†å¯¼è‡´ä¸å¯é¢„æœŸçš„ç»“æœã€‚<code>pthread_cond_wait</code>å‡½æ•°æ‰§è¡Œæ—¶ï¼Œé¦–å…ˆæŠŠè°ƒç”¨çº¿ç¨‹æ”¾å…¥æ¡ä»¶å˜é‡çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç„¶åå°†äº’æ–¥é”<code>mutex</code>è§£é”ã€‚å¯è§ï¼Œä»<code>pthread_cond_wait</code>å¼€å§‹æ‰§è¡Œåˆ°å…¶è°ƒç”¨çº¿ç¨‹è¢«æ”¾å…¥æ¡ä»¶å˜é‡çš„ç­‰å¾…é˜Ÿåˆ—ä¹‹é—´çš„è¿™æ®µæ—¶é—´å†…ï¼Œ<code>pthread_cond_signal</code>å’Œ<code>pthread_cond_broadcast</code>ç­‰å‡½æ•°ä¸ä¼šä¿®æ”¹æ¡ä»¶å˜é‡ã€‚æ¢è¨€ä¹‹ï¼Œ<code>pthread_cond_wait</code>å‡½æ•°ä¸ä¼šé”™è¿‡ç›®æ ‡æ¡ä»¶å˜é‡çš„ä»»ä½•å˜åŒ–ã€‚å½“<code>pthread_cond_wait</code>å‡½æ•°æˆåŠŸè¿”å›æ—¶ï¼Œäº’æ–¥é”<code>mutex</code>å°†å†æ¬¡è¢«é”ä¸Šã€‚</p>
<p>ä¸Šé¢è¿™äº›å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*å€ŸåŠ©æ¡ä»¶å˜é‡æ¨¡æ‹Ÿ ç”Ÿäº§è€…-æ¶ˆè´¹è€… é—®é¢˜*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*é“¾è¡¨ä½œä¸ºå…¬äº«æ•°æ®,éœ€è¢«äº’æ–¥é‡ä¿æŠ¤*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é™æ€åˆå§‹åŒ– ä¸€ä¸ªæ¡ä»¶å˜é‡ å’Œ ä¸€ä¸ªäº’æ–¥é‡*/</span></span><br><span class="line"><span class="type">pthread_cond_t</span> has_product = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">mp</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;lock);</span><br><span class="line">        <span class="keyword">while</span> (head == <span class="literal">NULL</span>)</span><br><span class="line">        &#123; <span class="comment">//å¤´æŒ‡é’ˆä¸ºç©º,è¯´æ˜æ²¡æœ‰èŠ‚ç‚¹    å¯ä»¥ä¸ºifå—</span></span><br><span class="line">            pthread_cond_wait(&amp;has_product, &amp;lock);</span><br><span class="line">        &#125;</span><br><span class="line">        mp = head;</span><br><span class="line">        head = mp-&gt;next; <span class="comment">//æ¨¡æ‹Ÿæ¶ˆè´¹æ‰ä¸€ä¸ªäº§å“</span></span><br><span class="line">        pthread_mutex_unlock(&amp;lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-Consume %lu---%d\n&quot;</span>, pthread_self(), mp-&gt;num);</span><br><span class="line">        <span class="built_in">free</span>(mp);</span><br><span class="line">        sleep(rand() % <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">mp</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        mp = (msg *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg));</span><br><span class="line">        mp-&gt;num = rand() % <span class="number">1000</span> + <span class="number">1</span>; <span class="comment">//æ¨¡æ‹Ÿç”Ÿäº§ä¸€ä¸ªäº§å“</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-Produce ---------------------%d\n&quot;</span>, mp-&gt;num);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;lock);</span><br><span class="line">        mp-&gt;next = head;</span><br><span class="line">        head = mp;</span><br><span class="line">        pthread_mutex_unlock(&amp;lock);</span><br><span class="line"></span><br><span class="line">        pthread_cond_signal(&amp;has_product); <span class="comment">//å°†ç­‰å¾…åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„ä¸€ä¸ªçº¿ç¨‹å”¤é†’</span></span><br><span class="line">        sleep(rand() % <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pthread_t</span> pid, cid;</span><br><span class="line">    srand(time(<span class="literal">NULL</span>));</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;pid, <span class="literal">NULL</span>, producer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;cid, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(pid, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cid, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220929193427533.png" alt="image-20220929193427533"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>é«˜çº§I/Oå‡½æ•°</title>
    <url>/2022/08/15/Linux/%E9%AB%98%E7%BA%A7IO%E5%87%BD%E6%95%B0/</url>
    <content><![CDATA[<h1 id="é«˜çº§I-Oå‡½æ•°"><a href="#é«˜çº§I-Oå‡½æ•°" class="headerlink" title="é«˜çº§I/Oå‡½æ•°"></a>é«˜çº§I/Oå‡½æ•°</h1><p>ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹åœ¨ç¬¬å…­ç« è®²è§£äº†å¾ˆå¤šLinuxæä¾›äº†å¾ˆå¤šé«˜çº§I/Oå‡½æ•°ï¼Œåœ¨è¿™é‡Œåšä¸ªç¬”è®°ã€‚è¿™ä¸€ç« ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼špipeå‡½æ•°ã€<code>dup</code>å’Œ<code>dup2</code>å‡½æ•°ã€readvå‡½æ•°å’Œwritevå‡½æ•°ã€sendfileå‡½æ•°ã€mmapå‡½æ•°å’Œmunmapå‡½æ•°ã€spliceå‡½æ•°ã€teeå‡½æ•°å’Œfcntlå‡½æ•°ã€‚</p>
<span id="more"></span>
<h2 id="ç®¡é“"><a href="#ç®¡é“" class="headerlink" title="ç®¡é“"></a>ç®¡é“</h2><h3 id="pipeå‡½æ•°"><a href="#pipeå‡½æ•°" class="headerlink" title="pipeå‡½æ•°"></a>pipeå‡½æ•°</h3><p><code>pipe</code>å‡½æ•°å¯ç”¨äºåˆ›å»ºä¸€ä¸ªç®¡é“ï¼ˆåŒ¿åï¼‰ï¼Œä»¥å®ç°è¿›ç¨‹ä¹‹é—´çš„é€šè®¯ï¼ˆä¸»è¦æ„Ÿè§‰æ˜¯çˆ¶å­è¿›ç¨‹ä¹‹é—´ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pipefd[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure>
<p><code>pipefd</code>æ˜¯ä¼ å‡ºå‚æ•°ï¼Œå®ƒåŒ…å«ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æˆ‘ä»¬å°±æ˜¯ä½¿ç”¨è¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦è¿›è¡Œè¿›ç¨‹ä¹‹é—´çš„é€šè®¯ã€‚</p>
<p><code>pipe</code>å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¦‚æœå¤±è´¥è¿”å›-1ï¼Œå¹¶ä¸”è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>pipe</code>å‡½æ•°åˆ›å»ºçš„ç®¡é“æ˜¯å•å‘é€šè®¯ï¼Œå…¶ä¸­<code>pipefd[0]</code>åªèƒ½è¯»ï¼Œ<code>pipefd[1]</code>åªèƒ½å†™ã€‚å¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸€å¯¹æ–‡ä»¶æè¿°ç¬¦éƒ½æ˜¯é˜»å¡çš„ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥è¿›è¡Œä¿®æ”¹ï¼Œå˜æˆéé˜»å¡çš„ã€‚</p>
<p><code>pipe</code>å‡½æ•°åˆ›å»ºçš„ç®¡é“å†…éƒ¨ä¼ è¾“çš„æ•°æ®æ˜¯å­—èŠ‚æµï¼Œç®¡é“æœ¬èº«æœ‰ä¸€ä¸ª<strong>å®¹é‡é™åˆ¶</strong>ï¼Œæœ€å¤šèƒ½å†™ä¸‹<code>65536</code>ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯è¿™ä¸ªå¤§å°å¯ä»¥ä½¿ç”¨<code>fcntl</code>è¿›è¡Œä¿®æ”¹ã€‚</p>
<p>å¦‚æœç®¡é“çš„å†™ç«¯æ–‡ä»¶æè¿°ç¬¦<code>pipefd[1]</code>çš„<strong>å¼•ç”¨è®¡æ•°</strong>å‡å°‘è‡³0ï¼Œå³æ²¡æœ‰ä»»ä½•è¿›ç¨‹éœ€è¦å¾€ç®¡é“ä¸­å†™äººæ•°æ®ï¼Œåˆ™é’ˆå¯¹è¯¥ç®¡é“çš„è¯»ç«¯æ–‡ä»¶æè¿°ç¬¦ <code>pipefd[0]</code>çš„<code>read</code>æ“ä½œå°†è¿”å›0ï¼Œå³è¯»å–åˆ°äº†æ–‡ä»¶ç»“æŸæ ‡è®°ï¼ˆEnd Of Fileï¼ŒEOF);åä¹‹ï¼Œå¦‚æœç®¡é“çš„è¯»ç«¯æ–‡ä»¶æè¿°ç¬¦<code>pipefd[0]</code>çš„å¼•ç”¨è®¡æ•°å‡å°‘è‡³0ï¼Œå³æ²¡æœ‰ä»»ä½•è¿›ç¨‹éœ€è¦ä»ç®¡é“è¯»å–æ•°æ®ï¼Œåˆ™é’ˆå¯¹è¯¥ç®¡é“çš„å†™ç«¯æ–‡ä»¶æè¿°ç¬¦<code>pipefd[1]</code>çš„<code>write</code>æ“ä½œå°†å¤±è´¥ï¼Œå¹¶å¼•å‘<code>SIGPIPE</code>ä¿¡å·ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> *p = <span class="string">&quot;test for pipe\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(fd) == <span class="number">-1</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;pipe&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sys_err(<span class="string">&quot;fork err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">        <span class="comment">// å…³é—­å†™ç«¯</span></span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">// ä»ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦fd[0]ä¸­å°†ä¿¡æ¯è¯»å‡º</span></span><br><span class="line">        <span class="type">int</span> len = read(fd[<span class="number">0</span>], buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="comment">// å°†è¯»çš„ä¿¡æ¯å†™åˆ°STDOUT_FILENOä¸Š</span></span><br><span class="line">        write(STDOUT_FILENO, buf, len);</span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">        <span class="comment">// å…³é—­è¯»ç«¯</span></span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">// å‘ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦fd[1]ä¸­å†™å…¥</span></span><br><span class="line">        write(fd[<span class="number">1</span>], p, <span class="built_in">strlen</span>(p));</span><br><span class="line">        <span class="comment">// å›æ”¶å­è¿›ç¨‹</span></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220905111959054.png" alt="image-20220905111959054"></p>
<h3 id="socketpairå‡½æ•°"><a href="#socketpairå‡½æ•°" class="headerlink" title="socketpairå‡½æ•°"></a>socketpairå‡½æ•°</h3><p><code>socketpair</code>å‡½æ•°èƒ½åˆ›å»ºåŒå‘ç®¡é“ï¼ˆä¸€å¯¹å¥—æ¥å­—ï¼‰ï¼Œå¹¶ä¸”ä¼¼ä¹åªèƒ½ç”¨äºæœ¬åœ°é€šè®¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socketpair</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol, <span class="type">int</span> sv[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure>
<p><code>socketpair</code>å‰ä¸‰ä¸ªå‚æ•°å’Œ<code>socket</code>ä¸€æ ·ã€‚</p>
<p><code>domain</code>æ˜¯åè®®æ—ç±»å‹ï¼Œä½†æ˜¯å› ä¸ºæ˜¯æœ¬åœ°é€šè®¯æ‰€ä»¥åªèƒ½æ˜¯<code>AF_UNIX</code></p>
<p><code>type</code>å‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ã€‚æœåŠ¡ç±»å‹ä¸»è¦æœ‰<code>SOCK_STREAM</code>æœåŠ¡ï¼ˆæµæœåŠ¡ï¼‰å’Œ<code>SOCK_UGRAM</code>ï¼ˆæ•°æ®æŠ¥ï¼‰æœåŠ¡ã€‚</p>
<p><code>protocol</code>å‚æ•°è®¾ç½®å…·ä½“çš„åè®®ã€‚ä½†æ˜¯åœ¨å‰ä¸¤ä¸ªå‚æ•°ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‚æ•°çš„å€¼åŸºæœ¬ä¸Šå”¯ä¸€çš„ï¼Œæ‰€æœ‰å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®ã€‚</p>
<p><code>sv[2]</code>åˆ™æ˜¯ä¼ å‡ºå‚æ•°ï¼Œå’Œä¸Šé¢çš„<code>pipe</code>ç›¸åŒï¼Œé‡Œé¢åŒ…å«ç€ä¸¤ä¸ªé€šè®¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåªä¸è¿‡è¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯æ—¢å¯ä»¥è¯»åˆå¯ä»¥å†™çš„ã€‚</p>
<p><code>socketpair</code>å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å›0ï¼Œå¦‚æœå¤±è´¥è¿”å›-1ï¼Œå¹¶ä¸”è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>socketpair</code>ç”¨æ³•æ¯”è¾ƒç®€å•ï¼Œå’Œä¸Šé¢<code>pipe</code>æœ‰ä¸€äº›ç±»ä¼¼</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span> <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="number">0</span>, fd))</span><br><span class="line">        sys_err(<span class="string">&quot;socketpair error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sys_err(<span class="string">&quot;fork err&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">        <span class="comment">// å…³é—­å†™ç«¯</span></span><br><span class="line">        <span class="comment">// ä»ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦fd[0]ä¸­å°†ä¿¡æ¯è¯»å‡º</span></span><br><span class="line">        <span class="type">int</span> len = read(fd[<span class="number">0</span>], buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="comment">// å°†è¯»çš„ä¿¡æ¯å†™åˆ°STDOUT_FILENOä¸Š</span></span><br><span class="line">        write(STDOUT_FILENO, buf, len);</span><br><span class="line">        <span class="type">char</span> *p = <span class="string">&quot;child test for socketpair\n&quot;</span>;</span><br><span class="line">        write(fd[<span class="number">0</span>], p, <span class="built_in">strlen</span>(p));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">        <span class="type">char</span> *p = <span class="string">&quot;parent test for socketpair\n&quot;</span>;</span><br><span class="line">        <span class="comment">// å‘ç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦fd[1]ä¸­å†™å…¥</span></span><br><span class="line">        write(fd[<span class="number">1</span>], p, <span class="built_in">strlen</span>(p));</span><br><span class="line">        <span class="type">int</span> len = read(fd[<span class="number">1</span>], buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        <span class="comment">// å°†è¯»çš„ä¿¡æ¯å†™åˆ°STDOUT_FILENOä¸Š</span></span><br><span class="line">        write(STDOUT_FILENO, buf, len);</span><br><span class="line">        <span class="comment">// å›æ”¶å­è¿›ç¨‹</span></span><br><span class="line"></span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220905204624841.png" alt="image-20220905204624841"></p>
<h3 id="mkfifoå‡½æ•°"><a href="#mkfifoå‡½æ•°" class="headerlink" title="mkfifoå‡½æ•°"></a>mkfifoå‡½æ•°</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mkfifo</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">mode_t</span> mode)</span>;</span><br></pre></td></tr></table></figure>
<p><code>mkfifo</code>ä¼šåˆ›å»ºä¸€ä¸ª<code>fifo</code>ç±»å‹çš„æ–‡ä»¶ï¼Œç„¶åä¸¤ä¸ªè¿›ç¨‹å¯ä»»æ„é€šè¿‡<code>open</code>çš„æ–¹å¼æ‰“å¼€è¿™ä¸ªæ–‡ä»¶è¿›è¡Œè¿›ç¨‹é—´çš„é€šè®¯ã€‚</p>
<p><code>pathname</code>è¡¨ç¤ºæ–‡ä»¶åï¼Œ<code>mode</code>æŒ‡å®šäº†æ–‡ä»¶çš„è¯»å†™æƒé™ã€‚</p>
<p>å‡½æ•°æˆåŠŸè°ƒç”¨è¿”å›0å¤±è´¥è¿”å›-1ï¼Œå¹¶ä¸”è®¾ç½®<code>errno</code>ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç å°±æ˜¯åˆ›å»ºä¸€ä¸ªåä¸ºmytestfifoçš„fifoæ–‡ä»¶</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> ret = mkfifo(<span class="string">&quot;mytestfifo&quot;</span>, <span class="number">0664</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;mkfifo error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–‡ä»¶ç±»å‹å‰é¢æœ‰ä¸ª<code>p</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220905211906735.png" alt="image-20220905211906735"></p>
<p>ç®¡é“æ–‡ä»¶è¯»å–æˆ–è€…å†™å…¥å’Œæ™®é€šæ–‡ä»¶ç›¸åŒï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨<code>open</code>å¯¹å…¶è¿›è¡Œæ“ä½œä½†æ˜¯éœ€è¦çš„æ˜¯æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<p>1.ç¨‹åº<strong>ä¸èƒ½ä»¥O_RDWRæ¨¡å¼æ‰“å¼€FIFOæ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œ</strong>ï¼Œè€Œå…¶è¡Œä¸ºä¹Ÿæœªæ˜ç¡®å®šä¹‰ï¼Œå› ä¸ºå¦‚ä¸€ä¸ªç®¡é“ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€ï¼Œè¿›ç¨‹å°±ä¼šè¯»å›è‡ªå·±çš„è¾“å‡ºï¼ŒåŒæ—¶æˆ‘ä»¬é€šå¸¸ä½¿ç”¨FIFOåªæ˜¯ä¸ºäº†å•å‘çš„æ•°æ®ä¼ é€’ã€‚</p>
<p>2.æ‰“å¼€FIFOæ–‡ä»¶é€šå¸¸æœ‰å››ç§æ–¹å¼ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">open(<span class="type">const</span> <span class="type">char</span> *pathname, O_RDONLY); <span class="comment">// 1</span></span><br><span class="line">open(<span class="type">const</span> <span class="type">char</span> *pathname, O_RDONLY | O_NONBLOCK); <span class="comment">// 2</span></span><br><span class="line">open(<span class="type">const</span> <span class="type">char</span> *pathname, O_WRONLY); <span class="comment">// 3</span></span><br><span class="line">open(<span class="type">const</span> <span class="type">char</span> *pathname, O_WRONLY | O_NONBLOCK); <span class="comment">// 4</span></span><br></pre></td></tr></table></figure>
<p><code>O_NONBLOCK</code>è¡¨ç¤ºé˜»å¡ã€‚æ‰€ä»¥</p>
<ul>
<li><code>O_RDONLY</code>ï¼šopenå°†ä¼šè°ƒç”¨é˜»å¡ï¼Œé™¤éæœ‰å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä»¥å†™çš„æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚</li>
<li><code>O_WRONLY</code>ï¼šopenå°†ä¼šè°ƒç”¨é˜»å¡ï¼Œé™¤éæœ‰å¦å¤–ä¸€ä¸ªè¿›ç¨‹ä»¥è¯»çš„æ–¹å¼æ‰“å¼€åŒä¸€ä¸ªFIFOï¼Œå¦åˆ™ä¸€ç›´ç­‰å¾…ã€‚</li>
<li><code>O_RDONLY|O_NONBLOCK</code>ï¼šå¦‚æœæ­¤æ—¶æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥å†™çš„æ–¹å¼æ‰“å¼€FIFOï¼Œæ­¤æ—¶openä¹Ÿä¼šæˆåŠŸè¿”å›ï¼Œæ­¤æ—¶FIFOè¢«è¯»æ‰“å¼€ï¼Œè€Œä¸ä¼šè¿”å›é”™è¯¯ã€‚</li>
<li><code>O_WRONLY|O_NONBLOCK</code>ï¼šç«‹å³è¿”å›ï¼Œå¦‚æœæ­¤æ—¶æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥è¯»çš„æ–¹å¼æ‰“å¼€ï¼Œopenä¼šå¤±è´¥æ‰“å¼€ï¼Œæ­¤æ—¶FIFOæ²¡æœ‰è¢«æ‰“å¼€ï¼Œè¿”å›-1ã€‚</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<p>fifo_w.cppï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">char</span> <span class="type">const</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Enter like this: ./a.out fifoname\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fd = open(argv[<span class="number">1</span>], O_WRONLY); <span class="comment">//æ‰“å¼€ç®¡é“æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;open fifo error\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;hello world %d\n&quot;</span>, i);</span><br><span class="line">        write(fd, buf, <span class="built_in">strlen</span>(buf)); <span class="comment">// å‘ç®¡é“å†™æ•°æ®</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>fifo_r.cpp:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sys_err</span><span class="params">(<span class="type">char</span> <span class="type">const</span> *str)</span></span><br><span class="line">&#123;</span><br><span class="line">    perror(str);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd, len;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">4096</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;./a.out fifoname\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// int fd = mkfifo(&quot;testfifo&quot;, 644);</span></span><br><span class="line">    <span class="comment">// open(fd, ...);</span></span><br><span class="line">    fd = open(argv[<span class="number">1</span>], O_RDONLY); <span class="comment">// æ‰“å¼€ç®¡é“æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">        sys_err(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        len = read(fd, buf, <span class="keyword">sizeof</span>(buf)); <span class="comment">// ä»ç®¡é“çš„è¯»ç«¯è·å–æ•°æ®</span></span><br><span class="line">        write(STDOUT_FILENO, buf, len);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220907093500990.png" alt="image-20220907093500990"></p>
<p><code>FIFO</code>æ–‡ä»¶ä¼šå­˜åœ¨è¿›ç¨‹ä¹‹é—´é€šè®¯çš„é—®é¢˜ã€‚æ¯”å¦‚å¤šä¸ªè¿›ç¨‹å¯¹<code>FIFO</code>è¿›è¡Œå†™ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ª<code>FIFO</code>è¿›è¡Œè¯»å–æ—¶å†™å…¥çš„æ•°æ®å—ä¼šä¸ä¼šå‘ç”Ÿäº¤é”™ï¼Ÿ</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œ<strong>ç³»ç»Ÿè§„å®šï¼š</strong>åœ¨ä¸€ä¸ªä»¥<code>O_WRONLY</code>ï¼ˆå³é˜»å¡æ–¹å¼ï¼‰æ‰“å¼€çš„<code>FIFO</code>ä¸­ï¼Œ å¦‚æœå†™å…¥çš„æ•°æ®é•¿åº¦å°äºç­‰å¾…<code>PIPE_BUF</code>ï¼Œé‚£ä¹ˆæˆ–è€…å†™å…¥å…¨éƒ¨å­—èŠ‚ï¼Œæˆ–è€…ä¸€ä¸ªå­—èŠ‚éƒ½ä¸å†™å…¥ã€‚</p>
<p>æ‰€ä»¥æ‰€æœ‰çš„å†™è¯·æ±‚éƒ½æ˜¯å‘å¾€ä¸€ä¸ªé˜»å¡çš„FIFOçš„ï¼Œå¹¶ä¸”æ¯ä¸ªå†™è®°è¯·æ±‚çš„æ•°æ®é•¿åº¦å°äºç­‰äº<code>PIPE_BUF</code>å­—èŠ‚ï¼Œç³»ç»Ÿå°±å¯ä»¥ç¡®ä¿æ•°æ®å†³ä¸ä¼šäº¤é”™åœ¨ä¸€èµ·ã€‚</p>
<p>å…¶ä¸­<code>PIPE_BUF</code>æ˜¯<code>FIFO</code>çš„é•¿åº¦ï¼Œå®ƒåœ¨å¤´æ–‡ä»¶<code>limits</code>.hä¸­è¢«å®šä¹‰ã€‚åœ¨linuxæˆ–å…¶ä»–ç±»UNIXç³»ç»Ÿä¸­ï¼Œå®ƒçš„å€¼é€šå¸¸æ˜¯4096å­—èŠ‚ã€‚</p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://blog.csdn.net/xiajun07061225/article/details/8471777">https://blog.csdn.net/xiajun07061225/article/details/8471777</a></li>
<li><a href="https://www.cnblogs.com/52php/p/5840229.html">https://www.cnblogs.com/52php/p/5840229.html</a></li>
</ul>
<h2 id="dupå’Œdup2å‡½æ•°"><a href="#dupå’Œdup2å‡½æ•°" class="headerlink" title="dupå’Œdup2å‡½æ•°"></a>dupå’Œdup2å‡½æ•°</h2><p><code>dup</code>å’Œ<code>dup2</code>ç”¨äºå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œé€šå¸¸ç”¨äºé‡å®šå‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br></pre></td></tr></table></figure>
<p><code>dup</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥æ–°æ–‡ä»¶æè¿°ç¬¦å’ŒåŸæœ‰æ–‡ä»¶æè¿°ç¬¦<code>oldfd</code>æŒ‡å‘ç›¸åŒçš„æ–‡ä»¶ã€ç®¡é“æˆ–è€…ç½‘ç»œè¿æ¥ã€‚å¹¶ä¸”dupè¿”å›çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ˜¯å–ç³»ç»Ÿå½“å‰å¯ç”¨çš„æœ€å°æ•´æ•°å€¼ã€‚</p>
<p><code>dup2</code>å’Œ<code>dup</code>ç±»ä¼¼ï¼Œä¸è¿‡å®ƒå°†è¿”å›ç¬¬ä¸€ä¸ªä¸å°äº<code>newfd</code>çš„æ•´æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶ä¸”<code>newfd</code>è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹Ÿå°†ä¼šæŒ‡å‘<code>oldfd</code>æŒ‡å‘çš„æ–‡ä»¶ï¼ŒåŸæ¥çš„<code>newfd</code>æŒ‡å‘çš„æ–‡ä»¶å°†ä¼šè¢«å…³é—­ï¼ˆé™¤é<code>newfd</code>å’Œ<code>oldfd</code>ç›¸åŒï¼‰ã€‚</p>
<p><code>dup</code>å’Œ<code>dup2</code>ç³»ç»Ÿè°ƒç”¨å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ï¼ŒæˆåŠŸå°±è¿”å›æ–°çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong>é€šè¿‡dupå’Œdup2åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦å¹¶<strong>ä¸ç»§æ‰¿åŸæ–‡ä»¶æè¿°ç¬¦çš„å±æ€§</strong>ï¼Œæ¯”å¦‚close-on-execå’Œnon-blocking ç­‰</p>
<p><code>dup</code>ç®€å•ï¼Œè¾“å…¥<code>oldfd</code>ç›´æ¥è¿”å›å¤åˆ¶çš„æ–‡ä»¶æè¿°ç¬¦</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;text.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    assert(fd != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd = %d\n&quot;</span>, fd);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd2 = dup(fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd2 = %d\n&quot;</span>, fd2);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    write(fd, str, <span class="keyword">sizeof</span>(str));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    write(fd2, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815171158327.png" alt="image-20220815171158327"></p>
<p><code>dup2</code>æ„Ÿè§‰å¤æ‚ä¸€äº›ï¼Œå…¶å®<code>dup2</code>å¿½ç•¥ç¬¬äºŒä¸ªå‚æ•°ï¼ŒåŠŸèƒ½æ˜¯å’Œ<code>dup</code>ä¸€æ ·çš„ï¼Œé™¤æ­¤ä¹‹å¤–<code>dup2</code>åŠ äº†ä¸€ä¸ªå°†è¿”å›ç¬¬ä¸€ä¸ªä¸å°äº<code>newfd</code>çš„æ•´æ•°å€¼çš„æ–‡ä»¶æè¿°ç¬¦çš„åŠŸèƒ½ï¼Œå¹¶ä¸”<code>newfd</code>ä¹Ÿå°†æŒ‡å‘<code>oldfd</code>æŒ‡å‘çš„æ–‡ä»¶ã€‚</p>
<p>ä¸‹é¢çš„ä»£ç è°ƒç”¨<code>dup2</code>ï¼Œæ–‡ä»¶æè¿°ç¬¦fd2åŸæ¥æŒ‡å‘â€text2.txtâ€æ–‡ä»¶çš„ï¼Œè°ƒç”¨<code>dup2</code>åï¼Œfd2æ”¹ä¸ºæŒ‡å‘â€text.txtâ€ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815173243219.png" alt="image-20220815173243219"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> fd1 = open(<span class="string">&quot;text.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line">    <span class="type">int</span> fd2 = open(<span class="string">&quot;text2.txt&quot;</span>, O_RDWR | O_CREAT, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    assert(fd1 != <span class="number">-1</span>);</span><br><span class="line">    assert(fd2 != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1 = %d, fd2 = %d\n&quot;</span>, fd1, fd2);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd3 = dup2(fd1, fd2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd1 = %d,fd2 = %d,fd3 = %d\n&quot;</span>, fd1, fd2, fd3);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> str[] = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    write(fd1, str, <span class="keyword">sizeof</span>(str));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    write(fd2, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line">    <span class="type">char</span> str2[] = <span class="string">&quot; hello world\n&quot;</span>;</span><br><span class="line">    write(fd3, str2, <span class="keyword">sizeof</span>(str2));</span><br><span class="line"></span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    close(fd3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815173321291.png" alt="image-20220815173321291"></p>
<h2 id="readvå‡½æ•°å’Œwritevå‡½æ•°"><a href="#readvå‡½æ•°å’Œwritevå‡½æ•°" class="headerlink" title="readvå‡½æ•°å’Œwritevå‡½æ•°"></a>readvå‡½æ•°å’Œwritevå‡½æ•°</h2><p><code>readv</code>å‡½æ•°å°†æ•°æ®ä»æ–‡ä»¶æè¿°ç¬¦è¯»åˆ°åˆ†æ•£çš„å†…å­˜å—ä¸­ï¼Œå³åˆ†æ•£è¯»; </p>
<p><code>writev</code>å‡½æ•°åˆ™å°†å¤šå—åˆ†æ•£çš„å†…å­˜æ•°æ®ä¸€å¹¶å†™äººæ–‡ä»¶æè¿°ç¬¦ä¸­ï¼Œå³é›†ä¸­å†™ã€‚å®ƒä»¬çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">readv</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">writev</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="keyword">struct</span> iovec *iov, <span class="type">int</span> iovcnt)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>è¢«æ“ä½œçš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>iov</code>æ˜¯<code>iovec</code>ç±»å‹çš„æ•°ç»„ï¼Œåœ¨<code>recvmsg</code>å’Œ<code>sendmsg</code>ä¸­æ¥è§¦è¿‡ã€‚</p>
<p><code>iovcnt</code>æ˜¯<code>iov</code>æ•°ç»„çš„é•¿åº¦ã€‚</p>
<p><code>iovec</code>ç»“æ„ä½“å°è£…äº†ä¸€å—å†…å­˜çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> &#123;</span>                    <span class="comment">/* Scatter/gather array items */</span></span><br><span class="line">   <span class="type">void</span>  *iov_base;              <span class="comment">/* Starting address */</span></span><br><span class="line">   <span class="type">size_t</span> iov_len;               <span class="comment">/* Number of bytes to transfer */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>readv</code>å’Œ <code>writev</code>åœ¨æˆåŠŸæ—¶è¿”å›è¯»å‡º/å†™å…¥<code>fd</code>çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p>
<p><code>readv</code>å’Œ<code>writev</code>æ˜¯ä¸ªéå¸¸æœ‰ç”¨çš„å‡½æ•°ã€‚æ¯”å¦‚ï¼šå½“WebæœåŠ¡å™¨è§£æå®Œä¸€ä¸ªHTTPè¯·æ±‚ä¹‹åï¼Œå¦‚æœç›®æ ‡æ–‡æ¡£å­˜åœ¨ä¸”å®¢æˆ·å…·æœ‰è¯»å–è¯¥æ–‡æ¡£çš„æƒé™ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦å‘é€ä¸€ä¸ªHTTPåº”ç­”æ¥ä¼ è¾“è¯¥æ–‡æ¡£ã€‚è¿™ä¸ªHTTPåº”ç­”åŒ…å«1ä¸ªçŠ¶æ€è¡Œã€å¤šä¸ªå¤´éƒ¨å­—æ®µã€1ä¸ªç©ºè¡Œå’Œæ–‡æ¡£çš„å†…å®¹ã€‚å…¶ä¸­ï¼Œå‰3éƒ¨åˆ†çš„å†…å®¹å¯èƒ½è¢«WebæœåŠ¡å™¨æ”¾ç½®åœ¨ä¸€å—å†…å­˜ä¸­ï¼Œè€Œæ–‡æ¡£çš„å†…å®¹åˆ™é€šå¸¸è¢«è¯»å…¥åˆ°å¦å¤–ä¸€å—å•ç‹¬çš„å†…å­˜ä¸­ï¼ˆé€šè¿‡readå‡½æ•°æˆ–mmapå‡½æ•°)ã€‚æˆ‘ä»¬å¹¶ä¸éœ€è¦æŠŠè¿™ä¸¤éƒ¨åˆ†å†…å®¹æ‹¼æ¥åˆ°ä¸€èµ·å†å‘é€ï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨writevå‡½æ•°å°†å®ƒä»¬åŒæ—¶å†™å‡ºã€‚</p>
<p>ä¸¾ä¸€ä¸ªmanæ‰‹å†Œä¸Š<code>writev</code>å‡½æ•°çš„ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *str0 = <span class="string">&quot;hello &quot;</span>;</span><br><span class="line">    <span class="type">char</span> *str1 = <span class="string">&quot;world\n&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iov</span>[2];</span></span><br><span class="line">    <span class="type">ssize_t</span> nwritten;</span><br><span class="line"></span><br><span class="line">    iov[<span class="number">0</span>].iov_base = str0;</span><br><span class="line">    iov[<span class="number">0</span>].iov_len = <span class="built_in">strlen</span>(str0);</span><br><span class="line">    iov[<span class="number">1</span>].iov_base = str1;</span><br><span class="line">    iov[<span class="number">1</span>].iov_len = <span class="built_in">strlen</span>(str1);</span><br><span class="line"></span><br><span class="line">    nwritten = writev(STDOUT_FILENO, iov, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815180645424.png" alt="image-20220815180645424"></p>
<h2 id="sendfileå‡½æ•°"><a href="#sendfileå‡½æ•°" class="headerlink" title="sendfileå‡½æ•°"></a>sendfileå‡½æ•°</h2><p><code>sendfile</code>å‡½æ•°åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç›´æ¥ä¼ é€’æ•°æ®ï¼ˆå®Œå…¨åœ¨å†…æ ¸ä¸­æ“ä½œ)ï¼Œä»è€Œé¿å…äº†å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´çš„æ•°æ®æ‹·è´ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œè¿™è¢«ç§°ä¸ºé›¶æ‹·è´ã€‚<code>sendfile</code>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendfile</span><span class="params">(<span class="type">int</span> out_fd, <span class="type">int</span> in_fd, <span class="type">off_t</span> *offset, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure>
<p><code>out_fd</code>å‚æ•°æ˜¯å¾…å†™å…¥å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>in_fd</code>å‚æ•°æ˜¯å¾…è¯»å–å†…å®¹çš„æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>offset</code>å‚æ•°æ˜¯æŒ‡ä»è¯»å…¥æ–‡ä»¶æµçš„å“ªä¸ªä½ç½®å¼€å§‹è¯»ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä½¿ç”¨è¯»å…¥æ–‡ä»¶æµé»˜è®¤çš„èµ·å§‹ä½ç½®</p>
<p><code>count</code>å‚æ•°æŒ‡å®šåœ¨æ–‡ä»¶æè¿°ç¬¦<code>in_fd</code>å’Œ<code>out_fd</code>ä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°</p>
<p><code>sendfile</code>æˆåŠŸæ—¶è¿”å›ä¼ è¾“çš„å­—èŠ‚æ•°ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>è¯¥å‡½æ•°çš„manæ‰‹å†Œæ˜ç¡®æŒ‡å‡ºï¼Œ<code>in_fd</code>å¿…é¡»æ˜¯ä¸€ä¸ªæ”¯æŒç±»ä¼¼<code>mmap</code>å‡½æ•°çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå³å®ƒå¿…é¡»æŒ‡å‘çœŸå®çš„æ–‡ä»¶ï¼Œä¸èƒ½æ˜¯socketå’Œç®¡é“ã€‚è€Œ<code>out_fd</code>åˆ™å¿…é¡»æ˜¯ä¸€ä¸ªsocketã€‚ç”±æ­¤å¯è§ï¼Œ<code>sendfile</code>å‡ ä¹æ˜¯ä¸“é—¨ä¸ºåœ¨ç½‘ç»œä¸Šä¼ è¾“æ–‡ä»¶è€Œè®¾è®¡çš„ã€‚</p>
<p>ç”¨äº†ä¸€ä¸ªä¹¦ä¸Šçš„ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sendfile.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number filename\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *file_name = argv[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> filefd = open(file_name, O_RDONLY);</span><br><span class="line">    assert(filefd &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat_buf</span>;</span></span><br><span class="line">    fstat(filefd, &amp;stat_buf);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sendfile(connfd, filefd, <span class="literal">NULL</span>, stat_buf.st_size);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815185556863.png" alt="image-20220815185556863"></p>
<h2 id="mmapå‡½æ•°å’Œmunmapå‡½æ•°"><a href="#mmapå‡½æ•°å’Œmunmapå‡½æ•°" class="headerlink" title="mmapå‡½æ•°å’Œmunmapå‡½æ•°"></a>mmapå‡½æ•°å’Œmunmapå‡½æ•°</h2><p><code>mmap</code>å‡½æ•°ç”¨äºç”³è¯·ä¸€æ®µå†…å­˜ç©ºé—´ã€‚å¯ä»¥å°†è¿™æ®µå†…å­˜ä½œä¸ºè¿›ç¨‹é—´é€šè®¯çš„å…±äº«å†…å­˜ï¼Œä¹Ÿå¯ä»¥å°†æ–‡ä»¶ç›´æ¥æ˜ å°„å…¶ä¸­ã€‚<code>munmap</code>å‡½æ•°ç”¨äºé‡Šæ”¾<code>mmap</code>åˆ›å»ºçš„å†…å­˜ç©ºé—´ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags,<span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length)</span>;</span><br></pre></td></tr></table></figure>
<p><code>addr</code>å‚æ•°è¿è¡Œç”¨æˆ·ä½¿ç”¨æŸä¸ªç‰¹å®šçš„åœ°å€ä½œä¸ºè¿™æ®µå†…å­˜çš„èµ·å§‹åœ°å€ã€‚å¦‚æœå®ƒè¢«è®¾ç½®ä¸ºNULLï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ†é…ä¸€ä¸ªåœ°å€ã€‚</p>
<p><code>length</code>å‚æ•°æŒ‡å®šå†…å­˜æ®µçš„é•¿åº¦</p>
<p><code>prot</code>å‚æ•°ç”¨æ¥è®¾ç½®å†…å­˜æ®µçš„è®¿é—®æƒé™ï¼Œå¯ä»¥ä¸‹é¢å‡ ä¸ªå€¼</p>
<ul>
<li><p><code>PROT_EXEC</code>ï¼Œå†…å­˜æ®µå¯æ‰§è¡Œ</p>
</li>
<li><p><code>PROT_READ</code>ï¼Œå†…å­˜æ®µå¯è¯»</p>
</li>
<li><p><code>PROT_WRITE</code>ï¼Œå†…å­˜æ®µå¯å†™</p>
</li>
<li><p><code>PROT_NONE</code>ï¼Œå†…å­˜æ®µä¸èƒ½è¢«è®¿é—®</p>
</li>
</ul>
<p><code>flags</code>å‚æ•°æ§åˆ¶å†…å­˜æ®µå†…å®¹è¢«ä¿®æ”¹åç¨‹åºçš„è¡Œä¸ºã€‚å®ƒå¸¸ç”¨çš„å–å€¼å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220815203154208.png" alt="image-20220815203154208"></p>
<p><code>fd</code>å‚æ•°æ˜¯è¢«æ˜ å°„æ–‡ä»¶å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å®ƒä¸€èˆ¬é€šè¿‡openç³»ç»Ÿè°ƒç”¨è·å¾—ã€‚</p>
<p><code>offset</code>å‚æ•°è®¾ç½®ä»æ–‡ä»¶çš„ä½•å¤„å¼€å§‹æ˜ å°„ã€‚</p>
<p><code>mmap</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›æŒ‡å‘ç›®æ ‡å†…å­˜åŒºåŸŸçš„æŒ‡é’ˆï¼Œå¤±è´¥åˆ™è¿”å›<code>MAP_FAILED((void*)-1)</code>å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>munmap</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<h2 id="spliceå‡½æ•°"><a href="#spliceå‡½æ•°" class="headerlink" title="spliceå‡½æ•°"></a>spliceå‡½æ•°</h2><p><code>splice</code>ç”¨äºåœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´ç§»åŠ¨æ•°æ®ï¼Œæ˜¯é›¶æ‹·è´æ“ä½œã€‚çœ‹äº†<code>man</code>æ‰‹å†Œï¼Œå‘ç°è¿™ä¸ª<code>splice</code>å‡½æ•°è·Ÿpipeç®¡é“å…³ç³»ä¸æµ…ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100155851.png" alt="image-20220816100155851"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">splice</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">loff_t</span> *off_in, <span class="type">int</span> fd_out, <span class="type">loff_t</span> *off_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd_in</code>å‚æ•°æ˜¯å¾…è¾“äººæ•°æ®çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¦‚æœ<code>fd_in</code>æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼Œé‚£ä¹ˆ <code>off_in</code>å‚æ•°å¿…é¡»è¢«è®¾ç½®ä¸ºNULLã€‚å¦‚æœ<code>fd_in</code>ä¸æ˜¯ä¸€ä¸ªç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ¯”å¦‚ socket)ï¼Œé‚£ä¹ˆ<code>off_in</code>è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„ä½•å¤„å¼€å§‹è¯»å–æ•°æ®ã€‚æ­¤æ—¶ï¼Œè‹¥<code>off_in</code>è¢«è®¾ç½®ä¸ºNULLï¼Œåˆ™è¡¨ç¤ºä»è¾“å…¥æ•°æ®æµçš„å½“å‰åç§»ä½ç½®è¯»å…¥ï¼›è‹¥<code>off_in</code>ä¸ä¸ºNULLï¼Œåˆ™å®ƒå°†æŒ‡å‡ºå…·ä½“çš„åç§»ä½ç½®ã€‚</p>
<p><code>fd_out/off_out</code>å‚æ•°çš„å«ä¹‰ä¸<code>fd_in/off_in</code>ç›¸åŒï¼Œä¸è¿‡ç”¨äºè¾“å‡ºæ•°æ®æµã€‚</p>
<p><code>len</code>å‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦</p>
<p><code>flags</code>å‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼Œå®ƒå¯ä»¥è¢«è®¾ç½®ä¸ºä¸‹è¡¨ä¸­çš„æŸäº›å€¼çš„æŒ‰ä½æˆ–ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100934412.png" alt="image-20220816100934412"></p>
<p>ä½¿ç”¨<code>splice</code>å‡½æ•°æ—¶ï¼Œ<code>fd_in</code>å’Œ<code>fd_out</code>å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>splice</code>å‡½æ•°è°ƒç”¨æˆåŠŸæ—¶è¿”å›ç§»åŠ¨å­—èŠ‚çš„æ•°é‡ã€‚å®ƒå¯èƒ½è¿”å›0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®éœ€è¦ç§»åŠ¨ï¼Œè¿™å‘ç”Ÿåœ¨ä»ç®¡é“ä¸­è¯»å–æ•°æ®ï¼ˆ<code>fd_in</code>æ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦ï¼‰è€Œè¯¥ç®¡é“æ²¡æœ‰è¢«å†™å…¥ä»»ä½•æ•°æ®æ—¶ã€‚<code>splice</code>å‡½æ•°å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å¸¸è§çš„<code>errno</code>å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816101918940.png" alt="image-20220816101918940"></p>
<p>ä¸‹é¢ç”¨äº†ä¸€ä¸ªä¹¦ä¸­çš„ä¾‹å­ï¼Œå®ç°ä¸€ä¸ªé›¶æ‹·è´çš„å›å°„æœåŠ¡å™¨ï¼Œå®ƒå°†å®¢æˆ·ç«¯å‘é€çš„ä¿¡æ¯é€šè¿‡<code>splice</code>ä»<code>pipefd[1]</code>å†™å…¥ç®¡é“ï¼Œå†ä½¿ç”¨<code>splice</code>ä»<code>pipefd[0]</code>å‘å®¢æˆ·ç«¯å†™ä¸œè¥¿ï¼Œä»è€Œå®ç°é›¶æ‹·è´çš„å›å°„æœåŠ¡å™¨ï¼ˆæ•´ä¸ªè¿‡ç¨‹æ²¡æœ‰ä½¿ç”¨<code>read</code>æˆ–è€…<code>write</code>æ“ä½œï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> pipefd[<span class="number">2</span>];</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        ret = pipe(pipefd);</span><br><span class="line">        ret = splice(connfd, <span class="literal">NULL</span>, pipefd[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        ret = splice(pipefd[<span class="number">0</span>], <span class="literal">NULL</span>, connfd, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">        assert(ret != <span class="number">-1</span>);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816102919876.png" alt="image-20220816102919876"></p>
<h2 id="teeå‡½æ•°"><a href="#teeå‡½æ•°" class="headerlink" title="teeå‡½æ•°"></a>teeå‡½æ•°</h2><p><code>tee</code>å‡½æ•°åœ¨ä¸¤ä¸ªç®¡é“æè¿°ç¬¦ä¹‹é—´å¤åˆ¶æ•°æ®ï¼Œä¹Ÿæ˜¯é›¶æ‹·è´æ“ä½œã€‚å®ƒä¸æ¶ˆè€—æ•°æ®ï¼Œå› æ­¤æºæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„æ•°æ®ä»ç„¶å¯ä»¥ç”¨äºåç»­æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">tee</span><span class="params">(<span class="type">int</span> fd_in, <span class="type">int</span> fd_out, <span class="type">size_t</span> len, <span class="type">unsigned</span> <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd_in</code>å’Œ<code>fd_out</code>æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯å¿…é¡»æ˜¯ç®¡é“æ–‡ä»¶æè¿°ç¬¦</p>
<p><code>len</code>å‚æ•°æŒ‡å®šç§»åŠ¨æ•°æ®çš„é•¿åº¦</p>
<p><code>flags</code>å‚æ•°åˆ™æ§åˆ¶æ•°æ®å¦‚ä½•ç§»åŠ¨ï¼Œå®ƒå¯ä»¥è¢«è®¾ç½®ä¸ºä¸‹è¡¨ä¸­çš„æŸäº›å€¼çš„æŒ‰ä½æˆ–ï¼Œå®ƒçš„å‚æ•°å…¶å®å’Œ<code>splice</code>å‡½æ•°ç›¸åŒã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816100934412.png" alt="image-20220816100934412"></p>
<p><code>tee</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›åœ¨ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´å¤åˆ¶çš„æ•°æ®æ•°é‡ï¼ˆå­—èŠ‚æ•°)ã€‚è¿”å›0è¡¨ç¤ºæ²¡æœ‰å¤åˆ¶ä»»ä½•æ•°æ®ã€‚<code>tee</code>å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>ä¹¦ä¸­ä»£ç åˆ©ç”¨<code>tee</code>å‡½æ•°å’Œ<code>splice</code>å‡½æ•°ï¼Œå®ç°äº†Linux ä¸‹<code>tee</code>ç¨‹åºï¼ˆåŒæ—¶è¾“å‡ºæ•°æ®åˆ°ç»ˆç«¯å’Œæ–‡ä»¶çš„ç¨‹åºï¼Œä¸è¦å’Œ<code>tee</code>å‡½æ•°æ··æ·†ï¼‰çš„åŸºæœ¬åŠŸèƒ½ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;usage: %s &lt;file&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> filefd = open(argv[<span class="number">1</span>], O_CREAT | O_WRONLY | O_TRUNC, <span class="number">0666</span>);</span><br><span class="line">	assert(filefd &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pipefd_stdout[<span class="number">2</span>];</span><br><span class="line">	<span class="type">int</span> ret = pipe(pipefd_stdout);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> pipefd_file[<span class="number">2</span>];</span><br><span class="line">	ret = pipe(pipefd_file);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// close( STDIN_FILENO );</span></span><br><span class="line">	<span class="comment">//  dup2( pipefd_stdout[1], STDIN_FILENO );</span></span><br><span class="line">	<span class="comment">// write( pipefd_stdout[1], &quot;abc\n&quot;, 4 );</span></span><br><span class="line">	ret = splice(STDIN_FILENO, <span class="literal">NULL</span>, pipefd_stdout[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = tee(pipefd_stdout[<span class="number">0</span>], pipefd_file[<span class="number">1</span>], <span class="number">32768</span>, SPLICE_F_NONBLOCK);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = splice(pipefd_file[<span class="number">0</span>], <span class="literal">NULL</span>, filefd, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line">	ret = splice(pipefd_stdout[<span class="number">0</span>], <span class="literal">NULL</span>, STDOUT_FILENO, <span class="literal">NULL</span>, <span class="number">32768</span>, SPLICE_F_MORE | SPLICE_F_MOVE);</span><br><span class="line">	assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">	close(filefd);</span><br><span class="line">	close(pipefd_stdout[<span class="number">0</span>]);</span><br><span class="line">	close(pipefd_stdout[<span class="number">1</span>]);</span><br><span class="line">	close(pipefd_file[<span class="number">0</span>]);</span><br><span class="line">	close(pipefd_file[<span class="number">1</span>]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816111052593.png" alt="image-20220816111052593"></p>
<h2 id="fcntlå‡½æ•°"><a href="#fcntlå‡½æ•°" class="headerlink" title="fcntlå‡½æ•°"></a>fcntlå‡½æ•°</h2><p><code>fcntl</code>å‡½æ•°æä¾›äº†å¯¹æ–‡ä»¶æè¿°ç¬¦çš„å„ç§æ§åˆ¶æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span> )</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>å‚æ•°æ˜¯è¢«æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>cmd</code>å‚æ•°æŒ‡å®šæ‰§è¡Œä½•ç§ç±»å‹çš„æ“ä½œã€‚æ ¹æ®æ“ä½œç±»å‹çš„ä¸åŒï¼Œè¯¥å‡½æ•°å¯èƒ½è¿˜éœ€è¦ç¬¬ä¸‰ä¸ªå¯é€‰å‚æ•° <code>arg</code>ã€‚<code>fcntl</code>å‡½æ•°æ”¯æŒçš„å¸¸ç”¨æ“ä½œåŠå…¶å‚æ•°å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816114524640.png" alt="image-20220816114524640"></p>
<p><code>fcntl</code>å‡½æ•°æˆåŠŸæ—¶çš„è¿”å›å€¼å¦‚è¡¨ä¸­æœ€åä¸€åˆ—æ‰€ç¤ºï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œ<code>fcntl</code>å‡½æ•°é€šå¸¸ç”¨æ¥å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è®¾ç½®ä¸ºéé˜»å¡çš„ã€‚</p>
<p>æ¯”å¦‚ï¼šç»ˆç«¯æ–‡ä»¶é»˜è®¤æ˜¯é˜»å¡è¯»çš„ï¼Œè¿™é‡Œç”¨ fcntl å°†å…¶æ›´æ”¹ä¸ºéé˜»å¡è¯»</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MSG_TRY <span class="string">&quot;try again\n&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">10</span>];</span><br><span class="line">    <span class="type">int</span> flags, n;</span><br><span class="line"></span><br><span class="line">    flags = fcntl(STDIN_FILENO, F_GETFL); <span class="comment">//è·å–stdinå±æ€§ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">if</span> (flags == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    flags |= O_NONBLOCK;</span><br><span class="line">    <span class="type">int</span> ret = fcntl(STDIN_FILENO, F_SETFL, flags);</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fcntl error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        n = read(STDIN_FILENO, buf, <span class="number">10</span>);</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != EAGAIN)</span><br><span class="line">            &#123;</span><br><span class="line">                perror(<span class="string">&quot;read /dev/tty&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            sleep(<span class="number">3</span>);</span><br><span class="line">            write(STDOUT_FILENO, MSG_TRY, <span class="built_in">strlen</span>(MSG_TRY));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        write(STDOUT_FILENO, buf, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220816115555375.png" alt="image-20220816115555375"></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>pythonèˆè¹ˆé“¾æ•°ç‹¬æ¸¸æˆ</title>
    <url>/2022/07/11/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/python%E8%88%9E%E8%B9%88%E9%93%BE%E6%95%B0%E7%8B%AC%E6%B8%B8%E6%88%8F/</url>
    <content><![CDATA[<h1 id="pythonèˆè¹ˆé“¾æ•°ç‹¬æ¸¸æˆ"><a href="#pythonèˆè¹ˆé“¾æ•°ç‹¬æ¸¸æˆ" class="headerlink" title="pythonèˆè¹ˆé“¾æ•°ç‹¬æ¸¸æˆ"></a>pythonèˆè¹ˆé“¾æ•°ç‹¬æ¸¸æˆ</h1><h2 id="æ•°ç‹¬ç®€ä»‹"><a href="#æ•°ç‹¬ç®€ä»‹" class="headerlink" title="æ•°ç‹¬ç®€ä»‹"></a>æ•°ç‹¬ç®€ä»‹</h2><p>æ•°ç‹¬æ¸¸æˆæ˜¯ä¸€æ¬¾å¤è€çš„æ™ºåŠ›æ¸¸æˆï¼Œæ®è¯´æœ€æ—©å¯ä»¥è¿½æº¯åˆ°ä¸­å›½å¤ä»£çš„â€œæ²³å›¾æ´›ä¹¦â€ï¼Œä½†æ˜¯çœŸå®å¯æŸ¥çš„æ˜¯åœ¨18ä¸–çºªæ•°å­¦å®¶æ¬§æ‹‰ç­‰äººå‘æ˜äº†â€œæ‹‰ä¸æ–¹é˜µâ€ç­‰æˆä¸ºæ•°ç‹¬çš„æœ€æ—©çš„æ ·å­ï¼Œåæ¥ç»è¿‡æ—¥æœ¬çš„æ”¹è¿›é€æ¸æˆä¸ºç°ä»£çš„æ•°ç‹¬æ¸¸æˆ[1]ã€‚</p>
<p>æ•°ç‹¬æ¸¸æˆä¸€å…±æœ‰$9 \times 9$ä¸ªå•å…ƒæ ¼å­ï¼Œåœ¨æ•°ç‹¬æ¸¸æˆå½“ä¸­ï¼Œç©å®¶éœ€è¦æ ¹æ®å·²æœ‰çš„æ•°å­—å»æ¨ç†å‡ºæ‰€æœ‰çš„å‰©ä½™ç©ºæ ¼çš„æ•°å­—ï¼Œå¹¶ä¸”è¦ä¿è¯ $9 \times 9$çš„å•ä½æ ¼å­ä¸­æ¯ä¸€è¡Œã€æ¯ä¸€åˆ—ä»¥åŠæ¯ä¸ª$3 \times 3$çš„ä¹å®«æ ¼å†…çš„æ•°å­—ä¸é‡å¤ã€‚æ•°ç‹¬æ¸¸æˆåœ¨å¼€å§‹çš„é€‚åˆå«åšåˆç›˜ï¼ˆå¦‚å›¾1(a)æ‰€å±•ç¤ºï¼‰ï¼ŒåŒ…å«æ•°å­—å’Œç©ºæ ¼ï¼Œå½“æ¸¸æˆæˆåŠŸå®Œæˆæ—¶çš„çŠ¶æ€å«ç»ˆç›˜ï¼ˆå›¾1(b)æ‰€å±•ç¤ºï¼‰ï¼Œåªæœ‰å¡«å†™å®Œæˆçš„æ•°å­—ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712105810489.png" alt="å›¾1"></p>
<span id="more"></span>
<h2 id="æ•°ç‹¬çš„è§£æ³•"><a href="#æ•°ç‹¬çš„è§£æ³•" class="headerlink" title="æ•°ç‹¬çš„è§£æ³•"></a>æ•°ç‹¬çš„è§£æ³•</h2><p>æ•°ç‹¬çš„æ±‚è§£æ–¹æ³•æœ‰å¾ˆæœ‰å¾ˆå¤šç§ï¼Œæ¯”å¦‚å›æº¯æ±‚è§£ã€åŸºäºæœ€å°å€™é€‰æ•°æ±‚è§£ç­‰ï¼Œæœ¬æ¬¡ä½œä¸šæˆ‘ä»¬é€‰æ‹©çš„æ–¹æ³•æ˜¯åŸºäºèˆè¹ˆé“¾çš„æ•°ç»„ä¸”ä»‹æ–¹æ³•ï¼Œåœ¨æœ¬å°èŠ‚ä¼šç€é‡ä»‹ç»èˆè¹ˆé“¾ä»¥åŠæ•°ç»„æ±‚è§£çš„ç†è®ºçŸ¥è¯†ã€‚</p>
<h3 id="ç²¾ç¡®è¦†ç›–é—®é¢˜"><a href="#ç²¾ç¡®è¦†ç›–é—®é¢˜" class="headerlink" title="ç²¾ç¡®è¦†ç›–é—®é¢˜"></a>ç²¾ç¡®è¦†ç›–é—®é¢˜</h3><p>åœ¨ä¸€ä¸ªå…¨é›†$X$ ä¸­ï¼Œè‹¥å¹²å­é›†çš„é›†åˆä¸º $S$ã€‚ç²¾ç¡®è¦†ç›–æ˜¯æŒ‡ï¼Œ$S$çš„å­é›†$S^<em>$æ°å¥½æ»¡è¶³$X$ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ åœ¨$S^</em>$ä¸­å‡ºç°ä¸€æ¬¡ã€‚è¿™æ ·è®²å¯èƒ½ä¸å¤ªé€šä¿—æ‰€ä»¥ä¸‹é¢é€šè¿‡ä¸€ä¸ªå°ä¾‹å­è®²è§£ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>æˆ‘ä»¬ç»™å®šä¸€ä¸ªç”±0å’Œ1ç»„æˆçš„çŸ©é˜µï¼Œå¸Œæœ›æ‰¾åˆ°ä¸€ä¸ªè¡Œçš„é›†åˆï¼Œä½¿å¾—é›†åˆä¸­æ¯ä¸€åˆ—éƒ½æ°å¥½åŒ…å«ä¸€ä¸ª1ï¼ŒçŸ©é˜µå¦‚è¡¨1æ‰€ç¤ºï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"><strong>1</strong></th>
<th style="text-align:center"><strong>2</strong></th>
<th style="text-align:center"><strong>3</strong></th>
<th style="text-align:center"><strong>4</strong></th>
<th style="text-align:center"><strong>5</strong></th>
<th style="text-align:center"><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>A</strong></td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td>1</td>
</tr>
<tr>
<td style="text-align:center"><strong>B</strong></td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center"><strong>C</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td>1</td>
</tr>
<tr>
<td style="text-align:center"><strong>D</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center"><strong>E</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td>1</td>
</tr>
<tr>
<td style="text-align:center"><strong>F</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>æˆ‘ä»¬å¯ä»¥ç®€å•çš„é€šè¿‡å›æº¯æ³•å¾—åˆ°æœ€ç»ˆçš„è§£æ˜¯$S^*={ B,D,F}$ï¼Œç»“æœå¦‚è¡¨2æ‰€ç¤º:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"><strong>1</strong></th>
<th style="text-align:center"><strong>2</strong></th>
<th style="text-align:center"><strong>3</strong></th>
<th style="text-align:center"><strong>4</strong></th>
<th style="text-align:center"><strong>5</strong></th>
<th style="text-align:center"><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>B</strong></td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center"><strong>D</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td>0</td>
</tr>
<tr>
<td style="text-align:center"><strong>F</strong></td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>ä½†æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ¶‰åŠå¤§é‡çš„çŸ©é˜µè¿›è¡Œç¼“å­˜æ›´æ”¹ä»¥åŠå›æº¯çš„é—®é¢˜ï¼Œè¿™ä¸€è¿‡ç¨‹æ˜¯éå¸¸æµªè´¹ç³»ç»Ÿèµ„æºçš„ï¼Œæ‰€ä»¥å¦‚ä½•ä¼˜é›…ä¸”é«˜æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå‡å°‘ç³»ç»Ÿå¼€é”€ï¼Œæˆä¸ºäº†ç®—æ³•å¤§å¸ˆä»¬çš„ä¸€ä¸ªé—®é¢˜ã€‚</p>
<h3 id="èˆè¹ˆé“¾"><a href="#èˆè¹ˆé“¾" class="headerlink" title="èˆè¹ˆé“¾"></a>èˆè¹ˆé“¾</h3><p>ä¸ºäº†è§£å†³ä¸Šé¢æåˆ°çš„å›æº¯å¯»æ‰¾ç²¾ç¡®è¦†ç›–é—®é¢˜ï¼Œç®—æ³•å¤§å¸ˆDonald Ervin Knuthæå‡ºäº†èˆè¹ˆé“¾ï¼ˆDancing Linksï¼‰çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”æŠŠæ±‚è§£è¿‡ç¨‹ç§°ä¸ºXç®—æ³•ã€‚èˆè¹ˆé“¾çš„æ•°æ®ç»“æ„ä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦6ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æ˜¯ï¼šLeftã€Rightã€Upã€Downã€Colã€Rowï¼Œåˆ†åˆ«ä»£è¡¨ç€å·¦ã€å³ã€ä¸Šã€ä¸‹ã€è¡Œã€åˆ—ã€‚èˆè¹ˆé“¾ä¸­æ¯ä¸€åˆ—éƒ½æœ‰ç‰¹æ®Šçš„ç»“ç‚¹ï¼Œå«åšåˆ—å¤´ï¼Œåˆ—å¤´ä¼šè®°å½•è¿™ä¸€åˆ—ä¸­çš„ç»“ç‚¹ä¸ªæ•°ï¼Œåˆ—å¤´äº’ç›¸è¿æ¥æ„æˆäº†é“¾è¡¨å¤´ï¼Œèˆè¹ˆé“¾çš„å›¾ç¤ºå¯ä»¥å‚è€ƒå›¾2ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712112439300.png" alt="å›¾2"></p>
<p>æœ‰äº†èˆè¹ˆé“¾çš„æ•°æ®ç»“æ„ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Xç®—æ³•è¿›è¡Œæ±‚è§£ã€‚Xç®—æ³•çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœçŸ©é˜µ$M$ä¸ºç©ºï¼Œæ²¡æœ‰ä»»ä½•åˆ—ï¼Œåˆ™å½“å‰çš„é€‰æ‹©ä¸ºé—®é¢˜çš„è§£ï¼Œè¿”å›æˆåŠŸï¼›å¦åˆ™è¿›å…¥2ã€‚</li>
<li>é€‰æ‹©åˆ—$c$ï¼Œå…¶ä¸­  çš„ç»“ç‚¹æ•°æœ€å°‘çš„åˆ—ï¼Œå³1çš„æ•°é‡æœ€å°‘ï¼Œå¦‚æœå…¶ä¸­æŸä¸€åˆ—æ²¡æœ‰1ï¼Œåˆ™è¿”å›å¤±è´¥ã€‚</li>
<li>é€‰æ‹©è¡Œ$r$ï¼ˆå…¶ä¸­çš„ $r$æ»¡è¶³ $M_{r,c}=1$ï¼‰ï¼Œå¹¶å°† $r$åŠ å…¥åˆ°å½“å‰çš„è§£å½“ä¸­ã€‚</li>
<li>ä»çŸ©é˜µ$M$ä¸­åˆ é™¤æ»¡è¶³ $M<em>{r,j}=1 and M</em>{i,j}=1$çš„ç¬¬ $i$è¡Œå’Œç¬¬$j$åˆ—ï¼Œå¾—åˆ°çŸ©é˜µ$\acute{M}$ </li>
<li>ä»¤$M=\acute{M}$ç»§ç»­è¿›å…¥1ã€‚</li>
</ol>
<p>è¿™æ ·è¯´å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œè®©æˆ‘ä»¬ä»¥è¡¨1ä»£è¡¨çš„çŸ©é˜µä¸ºåˆ—ï¼Œè¿›è¡Œæ¼”ç¤ºï¼š</p>
<ul>
<li>é¦–å…ˆï¼Œå› ä¸ºçŸ©é˜µ$M$ä¸ä¸ºç©ºï¼Œè¿˜å­˜åœ¨åˆ—ï¼Œç®—æ³•æ²¡æœ‰ç»“æŸã€‚</li>
<li>æˆ‘ä»¬é€‰æ‹©1æ•°é‡æœ€å°‘çš„åˆ—â€œ1â€ï¼Œå¦‚è¡¨3æ‰€å±•ç¤ºã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td><strong>1</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td><strong>1</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155430959.png" alt="image-20220712155430959"></p>
<ul>
<li>å› ä¸º$M<em>{A,1}=1$å¹¶ä¸”$M</em>{B,1}=1$æ‰€ä»¥å¯ä»¥ä¾æ¬¡é€‰å– $A,B$è¡Œã€‚</li>
<li>å…ˆé€‰å–$A$è¡Œï¼ˆå°†$A$è¡ŒåŠ å…¥åˆ°å½“å‰çš„è§£ä¸­ï¼‰ï¼Œç¬¬1ã€4ã€7åˆ—å‡ä¸º1ï¼Œå¦‚è¡¨4æ‰€å±•ç¤ºã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155512313.png" alt="image-20220712155512313"></p>
<ul>
<li>ç¬¬1åˆ—ä¸­ç¬¬$A$è¡Œå’Œç¬¬$B$è¡Œä¸º1ï¼Œç¬¬4åˆ—ä¸­ç¬¬ $A,B,C$è¡Œä¸º1ï¼Œç¬¬7åˆ—ä¸­ç¬¬$A,C,E,F$è¡Œå’Œç¬¬$1ã€4ã€7$åˆ—ï¼Œå¦‚è¡¨5æ‰€å±•ç¤ºã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155732882.png" alt="image-20220712155732882"></p>
<ul>
<li>å¾—åˆ°çŸ©é˜µ$\acute{M}$ï¼Œç»§ç»­è¿›è¡Œé€’å½’</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155807311.png" alt="image-20220712155807311"></p>
<ul>
<li>ç®—æ³•é€’å½’å‘ç°ç¬¬2åˆ—ä¸º0ï¼Œæ‰€ä»¥è¿”å›å¤±è´¥ï¼Œæ‰€ä»¥å¼€å§‹é€‰æ‹©$A$è¡Œä¸æ˜¯ç®—æ³•çš„è§£ï¼Œåˆ™ä»è§£ä¸­åˆ é™¤ $A$</li>
<li>è¿”å›æœ€å¼€å§‹çš„éƒ¨åˆ†ï¼Œå°†$B$è¡ŒåŠ å…¥åˆ°å½“å‰çš„è§£ä¸­ã€‚ç¬¬1ã€4åˆ—å‡ä¸º1ï¼Œå¦‚è¡¨7æ‰€å±•ç¤ºã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155848091.png" alt="image-20220712155848091"></p>
<ul>
<li>ç¬¬ä¸€åˆ—ä¸­$A$è¡Œå’Œ$B$è¡Œä¸º1ï¼Œç¬¬4åˆ—ä¸­ç¬¬$A,B,C$è¡Œä¸º1ã€‚æ‰€ä»¥ç§»é™¤ç¬¬$A,B,C$è¡Œå’Œç¬¬1ã€4åˆ—ï¼Œå¦‚è¡¨8æ‰€ç¤ºã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>1</strong></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>4</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td><strong>C</strong></td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712155933356.png" alt="image-20220712155933356"></p>
<ul>
<li>æœ€ç»ˆå¾—åˆ°çŸ©é˜µå¦‚è¡¨9æ‰€å±•ç¤ºï¼Œå¹¶ä¸”ç»§ç»­è¿›è¡Œé€’å½’</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712160005226.png" alt="image-20220712160005226"></p>
<ul>
<li>é€‰æ‹©1æ•°é‡æœ€å°‘çš„åˆ—â€œ5â€ã€‚</li>
<li>å°†$D$è¡ŒåŠ å…¥åˆ°å½“å‰çš„è§£ä¸­ã€‚ç¬¬3ã€5ã€6åˆ—å‡ä¸º1ã€‚</li>
<li>ç¬¬3åˆ—ä¸­ç¬¬$Dã€E$è¡Œä¸º1ï¼Œç¬¬5åˆ—ä¸­ç¬¬$D$è¡Œä¸º1ï¼Œç¬¬6åˆ—ä¸­ç¬¬$Dã€E$è¡Œä¸º1ã€‚æ‰€ä»¥ç§»é™¤ç¬¬$Dã€E$è¡Œå’Œç¬¬3ã€5ã€6åˆ—ã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th><strong>2</strong></th>
<th><strong>3</strong></th>
<th><strong>5</strong></th>
<th><strong>6</strong></th>
<th><strong>7</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>D</strong></td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td><strong>F</strong></td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712160122977.png" alt="image-20220712160122977"></p>
<ul>
<li>æœ€ç»ˆå¾—åˆ°çŸ©é˜µå¦‚è¡¨11æ‰€å±•ç¤ºï¼Œç»§ç»­é€’å½’ä¸‹å»å°±çŸ¥é“è¿™ä¸ªè§£æ˜¯æˆåŠŸçš„ã€‚</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>2</th>
<th>7</th>
</tr>
</thead>
<tbody>
<tr>
<td>F</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712160144320.png" alt="image-20220712160144320"></p>
<ul>
<li>æ‰€ä»¥æœ€ç»ˆè§£ä¸º${B,D,F}$</li>
</ul>
<p>é€šè¿‡è¿™ç§å®ä¾‹å±•ç¤ºï¼Œæˆ‘ä»¬å¤§è‡´å¯ä»¥æ˜ç™½èˆè¹ˆé“¾çš„è¿ç®—è¿‡ç¨‹äº†ã€‚è¿™ä¸€å°èŠ‚å¦‚æœçœ‹ä¸å¤ªæ˜ç™½çš„å¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„é“¾æ¥ï¼š</p>
<p><a href="https://www.cnblogs.com/grenet/p/3145800.html">https://www.cnblogs.com/grenet/p/3145800.html</a></p>
<p><a href="https://zh.m.wikipedia.org/zh-hans/X%E7%AE%97%E6%B3%95">https://zh.m.wikipedia.org/zh-hans/X%E7%AE%97%E6%B3%95</a></p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p>æ•´ä¸ªæ•°ç‹¬æ¸¸æˆæˆ‘é‡‡ç”¨pythonè¯­è¨€è¿›è¡Œå®Œæˆï¼Œç•Œé¢é‡‡ç”¨pyqtè¿›è¡Œç¼–å†™ã€‚åœ¨è¿™é‡Œå°èŠ‚ä»‹ç»å¦‚ä½•å®ç°æ•°ç»„æ¸¸æˆï¼Œåªä»‹ç»æ ¸å¿ƒä»£ç ï¼Œå…¶ä¸­å‡ ä¸ªç±»çš„å…³ç³»å¦‚å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712160424299.png" alt="image-20220712160424299"></p>
<h3 id="èˆè¹ˆé“¾å®ç°DLX"><a href="#èˆè¹ˆé“¾å®ç°DLX" class="headerlink" title="èˆè¹ˆé“¾å®ç°DLX"></a>èˆè¹ˆé“¾å®ç°DLX</h3><p>é¦–å…ˆæ˜¯èˆè¹ˆé“¾çš„ç»“ç‚¹DLXNodeï¼Œæˆ‘è®¾è®¡äº†ä¸»è¦çš„å·¦ã€å³ã€ä¸Šã€ä¸‹ã€åˆ—å¤´è¿™5ä¸ªæŒ‡é’ˆã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># èˆè¹ˆé“¾çš„ç»“ç‚¹</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DLXNode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, row=-<span class="number">1</span>, col=-<span class="number">1</span></span>):</span><br><span class="line">        <span class="variable language_">self</span>.left = <span class="variable language_">self</span></span><br><span class="line">        <span class="variable language_">self</span>.right = <span class="variable language_">self</span></span><br><span class="line">        <span class="variable language_">self</span>.up = <span class="variable language_">self</span></span><br><span class="line">        <span class="variable language_">self</span>.down = <span class="variable language_">self</span></span><br><span class="line">        <span class="variable language_">self</span>.colHead = <span class="variable language_">self</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># ç”¨äºåˆ—å¤´ï¼Œè®°å½•ç»“ç‚¹æ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.count = <span class="number">0</span></span><br><span class="line">        <span class="comment"># å•çº¯çš„æ ‡è®°ï¼Œæ–¹ä¾¿è°ƒè¯•</span></span><br><span class="line">        <span class="variable language_">self</span>.colId = col</span><br><span class="line">        <span class="variable language_">self</span>.rowId = row</span><br></pre></td></tr></table></figure>
<p>æ¥ç€æˆ‘å¼€å§‹å®ç°DLXï¼ŒDLXçš„æ•°æ®åˆå§‹æ—¶ä¸»è¦ä¸ºä¸€ä¸ªheadå¤´èŠ‚ç‚¹ä»¥åŠä¸€ä¸ªcolçš„æ•°ç»„ï¼Œcolæ•°ç»„ç”¨æ¥å­˜å‚¨é“¾è¡¨å¤´ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™æˆ‘ä»¬éœ€è¦å°†æ•´ä¸ªheadå’Œcolæ•°ç»„è¿›è¡Œåˆå§‹åŒ–ï¼Œéœ€è¦ç†æ¸…ä»–ä»¬ä¹‹é—´çš„æŒ‡é’ˆè¿æ¥ï¼Œåˆå§‹åŒ–è¾“å…¥æ˜¯ä¸€ä¸ªcolnumï¼Œè¡¨ç¤ºé“¾è¡¨å¤´çš„ä¸ªæ•°ï¼Œå³åˆ—çš„ä¸ªæ•°ï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„ä»£ç ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DLX</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, colnum</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;èˆè¹ˆé“¾åˆå§‹åŒ–</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">            colnum:é“¾è¡¨å¤´ä¸ªæ•°</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="comment"># self.count = 0</span></span><br><span class="line">        <span class="comment"># è¡Œæ•°</span></span><br><span class="line">        <span class="variable language_">self</span>.rownum = <span class="number">0</span></span><br><span class="line">        <span class="comment"># è®°å½•è¡Œå­—å…¸</span></span><br><span class="line">        <span class="variable language_">self</span>.rowdict = &#123;&#125;</span><br><span class="line">        <span class="variable language_">self</span>.ans = []</span><br><span class="line">        <span class="variable language_">self</span>.head = DLXNode()</span><br><span class="line">        <span class="variable language_">self</span>.col = [DLXNode(-<span class="number">1</span>, i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(colnum)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># å°†é“¾è¡¨å¤´å’Œheadè¿æ¥èµ·æ¥</span></span><br><span class="line">        <span class="variable language_">self</span>.head.left = <span class="variable language_">self</span>.col[-<span class="number">1</span>]</span><br><span class="line">        <span class="variable language_">self</span>.head.right = <span class="variable language_">self</span>.col[<span class="number">0</span>]</span><br><span class="line">        <span class="variable language_">self</span>.col[<span class="number">0</span>].left = <span class="variable language_">self</span>.head</span><br><span class="line">        <span class="variable language_">self</span>.col[<span class="number">0</span>].right = <span class="variable language_">self</span>.col[<span class="number">1</span>]</span><br><span class="line">        <span class="variable language_">self</span>.col[-<span class="number">1</span>].left = <span class="variable language_">self</span>.col[-<span class="number">2</span>]</span><br><span class="line">        <span class="variable language_">self</span>.col[-<span class="number">1</span>].right = <span class="variable language_">self</span>.head</span><br><span class="line">        <span class="comment"># å°†é“¾è¡¨å¤´ä¹‹é—´è¿æ¥èµ·æ¥</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, colnum-<span class="number">1</span>):</span><br><span class="line">            <span class="variable language_">self</span>.col[i].left = <span class="variable language_">self</span>.col[i-<span class="number">1</span>]</span><br><span class="line">            <span class="variable language_">self</span>.col[i].right = <span class="variable language_">self</span>.col[i+<span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<p>DLXè¿›è¡Œåˆå§‹åŒ–ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œæ•°æ®çš„æ’å…¥ï¼Œåœ¨è¿™é‡Œé‡‡å–çš„æ˜¯ä¸€è¡Œä¸€è¡Œçš„æ’å…¥ï¼Œå³å…ˆæ’å…¥ç¬¬ä¸€è¡Œå†æ’å…¥ç¬¬äºŒè¡Œï¼Œæ‰€ä»¥æ’å…¥çš„æ•°æ®ç»“ç‚¹å…¶å®éƒ½æ˜¯è¿™ä¸€åˆ—æœ€åä¸€ä¸ªç»“ç‚¹ï¼Œæ ¹æ®è¿™ä¸€ç‰¹ç‚¹ï¼Œæˆ‘ä»¬è¿›è¡Œç»“ç‚¹ä¸Šã€ä¸‹ã€å·¦ã€å³å››ä¸ªæ–¹å‘æŒ‡é’ˆçš„è®¾ç½®ï¼Œè¿™ä¸ªå‡½æ•°çš„è¾“å…¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå…¶ä¸­å…ƒç´ æ˜¯æ’å…¥çš„åˆ—å¤´idã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pushRow</span>(<span class="params">self, colList</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;æ’å…¥ä¸€è¡Œæ•°æ®ï¼ŒæŒ‰ç…§ä¸€è¡Œä¸€è¡Œï¼Œé€’å¢çš„æ’å…¥</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">        colList:æ•°ç»„ï¼Œé‡Œé¢å­˜ç€åˆ—å¤´çš„id</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(colList,self.rownum)</span></span><br><span class="line">    <span class="variable language_">self</span>.rowdict[<span class="variable language_">self</span>.rownum] = colList</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹äºç»“ç‚¹ï¼Œåˆ—æ–¹å‘ä¸Šï¼Œä¸Šä¸‹æŒ‡é’ˆçš„å˜åŠ¨</span></span><br><span class="line">    <span class="keyword">for</span> cowId <span class="keyword">in</span> colList:</span><br><span class="line">        <span class="comment"># æ¯ä¸ªæ’å…¥çš„ç»“ç‚¹ï¼Œéƒ½ä¸ºè¯¥åˆ—æœ€åä¸€ä¸ªç»“ç‚¹</span></span><br><span class="line">        node = DLXNode(<span class="variable language_">self</span>.rownum, cowId)</span><br><span class="line">        node.down = <span class="variable language_">self</span>.col[cowId]</span><br><span class="line">        node.up = <span class="variable language_">self</span>.col[cowId].up</span><br><span class="line">        node.colHead = <span class="variable language_">self</span>.col[cowId]</span><br><span class="line">        <span class="variable language_">self</span>.col[cowId].up.down = node</span><br><span class="line">        <span class="variable language_">self</span>.col[cowId].up = node</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.col[cowId].count += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯¹äºç»“ç‚¹ï¼Œè¡Œæ–¹å‘çš„ä¸¤ä¸ªæŒ‡é’ˆçš„å˜åŠ¨</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(colList)):</span><br><span class="line">        <span class="variable language_">self</span>.col[colList[i]].up.left = <span class="variable language_">self</span>.col[colList[i-<span class="number">1</span>]].up</span><br><span class="line">        <span class="variable language_">self</span>.col[colList[i]].up.right = <span class="variable language_">self</span>.col[colList[(i+<span class="number">1</span>) % <span class="built_in">len</span>(colList)]].up</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">self</span>.rownum += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>æœ‰äº†ä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªDLXçš„æ•°æ®ç»“æ„äº†ï¼Œä¸‹é¢å°±éœ€è¦æ¥è¿›è¡Œå¯¹åº”ç»“ç‚¹çš„â€œè·³èˆâ€ï¼Œä¹Ÿå°±æ˜¯ç»“ç‚¹çš„åˆ é™¤å’Œæ¢å¤ã€‚å…ˆä»‹ç»ç»“ç‚¹çš„åˆ é™¤ï¼Œåˆ é™¤æˆ‘é‡‡ç”¨çš„æ˜¯ç»™å®šä¸€ä¸ªåˆ—çš„åˆ—å¤´ï¼Œéå†åˆ—çš„ç»“ç‚¹è¿›è¡Œå¯¹åº”çš„åˆ é™¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬åˆ é™¤é‡‡å–çš„æ–¹å¼æ˜¯æ”¹å˜ç»“ç‚¹<code>a</code>æŒ‡å‘çš„ç»“ç‚¹çš„æŒ‡é’ˆæŒ‡å‘ï¼Œä½†æ˜¯ä¸æ”¹å˜ç»“ç‚¹  çš„æŒ‡å‘ï¼Œè¿™å°±ä¸ºåç»­æ¢å¤ç»“ç‚¹çš„æ¢å¤åŸ‹ä¸‹ä¼ç¬”ï¼Œåˆ é™¤å‡½æ•°çš„è¾“å…¥æ˜¯éœ€è¦åˆ é™¤åˆ—çš„åˆ—å¤´ç»“ç‚¹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">self, c: DLXNode</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»¥åˆ—ä¸ºå•ä½è¿›è¡Œåˆ é™¤</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">        c:åˆ—å¤´</span></span><br><span class="line"><span class="string">    return:</span></span><br><span class="line"><span class="string">        åˆ é™¤æ˜¯å¦æˆåŠŸçš„ç»“æœ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># print(c.colId,&#x27;åˆ—è¢«åˆ é™¤&#x27;)</span></span><br><span class="line">    <span class="comment"># å°†åˆ—å¤´ä»é“¾è¡¨å¤´ä¸­åˆ é™¤ï¼Œåªæ”¹å˜äº†cç»“ç‚¹leftã€rightçš„æŒ‡å‘ï¼Œå¹¶æœªæ”¹å˜cçš„æŒ‡å‘ï¼Œä¸ºæ¢å¤åšå‡†å¤‡</span></span><br><span class="line">    c.left.right = c.right</span><br><span class="line">    c.right.left = c.left</span><br><span class="line">    <span class="keyword">if</span> c.down == c:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    i = c.down</span><br><span class="line">    <span class="keyword">while</span> i != c:</span><br><span class="line">        <span class="comment">#éå†è¿™ä¸€åˆ—ï¼Œiä¸ºè¿™ä¸€åˆ—ä¸­çš„ç»“ç‚¹</span></span><br><span class="line">        <span class="comment">#æ³¨æ„ï¼Œéå†äº†è¿™ä¸€åˆ—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ”¹å˜è¿™ä¸€åˆ—ç»“ç‚¹ä¹‹é—´çš„å…³ç³»ï¼Œä¸ºåé¢çš„æ¢å¤åŸ‹ä¸‹äº†ç§å­</span></span><br><span class="line">        j = i.right</span><br><span class="line">        <span class="keyword">while</span> j != i:</span><br><span class="line">            <span class="comment"># éå†iç»“ç‚¹è¿™ä¸€è¡Œï¼Œå°†è¿™ä¸€è¡Œçš„ç»“ç‚¹è¿›è¡Œåˆ é™¤</span></span><br><span class="line">            <span class="comment"># æ³¨æ„åªæ˜¯æ”¹å˜äº†jç»“ç‚¹upã€downçš„æŒ‡å‘ï¼Œå¹¶æ²¡æœ‰æ”¹å˜jçš„æŒ‡å‘ï¼Œä¸ºåé¢jçš„æ¢å¤åšå‡†å¤‡</span></span><br><span class="line">            j.up.down = j.down</span><br><span class="line">            j.down.up = j.up</span><br><span class="line">            j.colHead.count -= <span class="number">1</span></span><br><span class="line">            j = j.right</span><br><span class="line">        i = i.down</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p>ç»“ç‚¹çš„æ¢å¤å’Œç»“ç‚¹çš„åˆ é™¤åˆšå¥½ç›¸åï¼Œå°†å¯¹åº”çš„ç»“ç‚¹æ·»åŠ è¿›åŸå§‹çš„ä½ç½®ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰æ”¹å˜ç»“ç‚¹çš„æŒ‡å‘ï¼Œæ‰€ä»¥åªéœ€è¦æ ¹æ®ç»“ç‚¹è‡ªèº«å°±èƒ½è¿›è¡Œæ¢å¤ï¼Œæ¢å¤å‡½æ•°è¾“å…¥æ˜¯æ¢å¤åˆ—çš„åˆ—å¤´ç»“ç‚¹ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">recover</span>(<span class="params">self, c: DLXNode</span>):        </span><br><span class="line">    <span class="string">&quot;&quot;&quot;ä»¥åˆ—ä¸ºå•ä½è¿›è¡Œæ¢å¤</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">        c:åˆ—å¤´</span></span><br><span class="line"><span class="string">    return:</span></span><br><span class="line"><span class="string">        æ¢å¤æ˜¯å¦æˆåŠŸçš„ç»“æœ</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># print(c.colId,&#x27;åˆ—è¢«æ¢å¤&#x27;)</span></span><br><span class="line">    i = c.down</span><br><span class="line">    <span class="keyword">while</span> i != c:</span><br><span class="line">        <span class="comment">#éå†è¿™ä¸€åˆ—ï¼Œiä¸ºè¿™ä¸€åˆ—ç»“ç‚¹</span></span><br><span class="line">        j = i.right</span><br><span class="line">        <span class="keyword">while</span> j != i:</span><br><span class="line">            <span class="comment"># éå†iç»“ç‚¹è¿™ä¸€è¡Œï¼Œæ ¹æ®jç»“ç‚¹çš„æŒ‡å‘è¿›è¡Œæ¢å¤</span></span><br><span class="line">            j.up.down = j</span><br><span class="line">            j.down.up = j</span><br><span class="line">            j.colHead.count += <span class="number">1</span></span><br><span class="line">            j = j.right</span><br><span class="line">        i = i.down</span><br><span class="line">    <span class="comment"># æ ¹æ®cç»“ç‚¹çš„æŒ‡å‘ï¼Œå°†cåŠ å…¥åˆ°é“¾è¡¨å¤´å½“ä¸­</span></span><br><span class="line">    c.left.right = c</span><br><span class="line">    c.right.left = c</span><br></pre></td></tr></table></figure>
<p>æ¥ç€ä»‹ç»ä¸€ä¸‹â€œè·³èˆâ€éœ€è¦ä½¿ç”¨çš„åŠŸèƒ½å¯»æ‰¾æœ€å°‘ç»“ç‚¹çš„åˆ—çš„åŠŸèƒ½ï¼Œå› ä¸ºæ¯ä¸ªåˆ—å¤´éƒ½è®°å½•äº†è¯¥åˆ—çš„ç»“ç‚¹æ•°é‡æ‰€ä»¥åªéœ€è¦ç®€å•çš„éå†è¿™ä¸€åˆ—å°±å¯ä»¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¯»æ‰¾countæœ€å°çš„</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">FindMinCount</span>(<span class="params">self</span>):</span><br><span class="line">    c = <span class="variable language_">self</span>.head.right</span><br><span class="line">    minnode = c</span><br><span class="line">    <span class="keyword">while</span> c != <span class="variable language_">self</span>.head:</span><br><span class="line">        <span class="keyword">if</span> c.count &lt; minnode.count:</span><br><span class="line">            minnode = c</span><br><span class="line">        c = c.right</span><br><span class="line">    <span class="keyword">return</span> minnode</span><br></pre></td></tr></table></figure>
<p>æœ‰äº†ä¸Šé¢çš„å†…å®¹æˆ‘ä»¬å¯ä»¥è¿›è¡Œæœ€ç»ˆçš„â€œè·³èˆâ€äº†ã€‚è¿‡ç¨‹å¯ä»¥ç®€è¿°ä¸ºå…ˆé€‰å–ç»“ç‚¹æ•°æœ€å°‘çš„åˆ—ï¼Œç„¶åå°†è¿™ä¸€åˆ—çš„ç»“ç‚¹è¿›è¡Œåˆ é™¤ï¼Œç„¶åé€‰æ‹©å…¶ä¸­ä¸€è¡Œä½œä¸ºè§£ï¼Œç„¶åæŠŠè¿™ä¸€è¡Œå¯¹åº”çš„ç»“ç‚¹çš„åˆ—è¿›è¡Œåˆ é™¤ï¼Œç„¶åè¿›è¡Œé€’å½’æœ€ç»ˆå¾—åˆ°è§£ã€‚å…·ä½“çš„é€»è¾‘è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥å‚è€ƒ2.2èŠ‚ä¸­èˆè¹ˆé“¾çš„ä»‹ç»ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Dance</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># å¯»æ‰¾ç»“ç‚¹æ•°æœ€å°‘çš„åˆ—</span></span><br><span class="line">    c = <span class="variable language_">self</span>.FindMinCount()</span><br><span class="line">    <span class="keyword">if</span> c == <span class="variable language_">self</span>.head:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åˆ é™¤ç»“ç‚¹æ•°æœ€å°‘çš„åˆ—c</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable language_">self</span>.remove(c):</span><br><span class="line">        <span class="comment"># print(&#x27;åˆ é™¤å¤±è´¥&#x27;)</span></span><br><span class="line">        <span class="variable language_">self</span>.recover(c)</span><br><span class="line">        <span class="comment"># self.count-=1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line">    i = c.down</span><br><span class="line">    <span class="keyword">while</span> i != c:</span><br><span class="line">        <span class="comment"># é€‰æ‹©ç¬¬iè¡Œä¸ºç­”æ¡ˆï¼Œéœ€è¦å°†ç¬¬iè¡Œä¸Šç»“ç‚¹çš„åˆ—è¿›è¡Œåˆ é™¤</span></span><br><span class="line">        <span class="comment"># print((i.rowId,i.colId),self.count)</span></span><br><span class="line">        j = i.right</span><br><span class="line">        <span class="keyword">while</span> j != i:</span><br><span class="line">            <span class="variable language_">self</span>.remove(j.colHead)</span><br><span class="line">            j = j.right</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="variable language_">self</span>.Dance():</span><br><span class="line">            <span class="comment"># print(&quot;è·³èˆæˆåŠŸ&quot;)</span></span><br><span class="line">            <span class="variable language_">self</span>.ans.append(<span class="variable language_">self</span>.rowdict[i.rowId])</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># è¿›è¡Œå›æº¯</span></span><br><span class="line">        j = i.right</span><br><span class="line">        <span class="keyword">while</span> j != i:</span><br><span class="line">            <span class="variable language_">self</span>.recover(j.colHead)</span><br><span class="line">            j = j.right</span><br><span class="line">        i = i.down</span><br><span class="line"></span><br><span class="line">    <span class="comment"># self.count-=1</span></span><br><span class="line">    <span class="comment"># æ¢å¤è¢«åˆ é™¤çš„åˆ—c</span></span><br><span class="line">    <span class="variable language_">self</span>.recover(c)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h3 id="æ•°ç‹¬çš„DLX"><a href="#æ•°ç‹¬çš„DLX" class="headerlink" title="æ•°ç‹¬çš„DLX"></a>æ•°ç‹¬çš„DLX</h3><p>ä»‹ç»å®Œèˆè¹ˆé“¾çš„å®ä¹ ä¹‹åï¼Œè¿™ä¸€å°èŠ‚ä»‹ç»ä¸€ä¸‹å¦‚ä½•å°†æ•°ç‹¬é—®é¢˜è½¬åŒ–ä¸ºç²¾ç¡®è¦†ç›–é—®é¢˜ï¼Œç„¶åä½¿ç”¨èˆè¹ˆé“¾è¿›è¡Œæ±‚è§£ã€‚æ•°ç‹¬è§„åˆ™ä¸€å…±æœ‰å››ç‚¹ï¼š</p>
<ul>
<li>æ¯ä¸ªå•å…ƒæ ¼éœ€è¦å¡«å†™ä¸€ä¸ªæ•°å­—</li>
<li>æ¯è¡Œæ•°å­—ä¸èƒ½ç›¸åŒ</li>
<li>æ¯åˆ—æ•°å­—ä¸èƒ½ç›¸åŒ</li>
<li>æ¯æ ¼å®«æ•°å­—ä¸èƒ½ç›¸åŒ</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥æŠŠçŸ©é˜µæ¯ä¸€åˆ—éƒ½å®šä¹‰ä¸ºä¸€ä¸ªçº¦æŸï¼Œåœ¨å•å…ƒæ ¼å†…å¡«å†™æ•°å­—å°±æ˜¯åŠ ä¸€è¡Œï¼Œç„¶åå¯¹åº”çš„åˆ—ä¸º1ï¼Œæœ€ç»ˆéœ€è¦æ‰¾åˆ°å¯¹åº”çš„è¡Œæ¥è¦†ç›–è¿™ä¸ªçŸ©é˜µã€‚</p>
<p>é’ˆå¯¹ç¬¬ä¸€æ¡è§„åˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨$1-81$åˆ—è¿›è¡Œçº¦æŸï¼Œé‚£ä¸ªå•å…ƒæ ¼å¡«å†™äº†æ•°å­—ï¼Œé‚£ä¸€åˆ—å°±ä¼šæœ‰ä¸€ä¸ªç»“ç‚¹1ï¼Œå‡å¦‚è¯´é‚£ä¸ªå•å…ƒæ ¼æ²¡æœ‰å¡«æ•°å­—ï¼Œé‚£ä¹ˆç¬¬  åˆ—ä¸­æŸåˆ—å°±ä¸ä¼šè¢«è¦†ç›–ã€‚</p>
<p>é’ˆå¯¹ç¬¬äºŒæ¡è§„åˆ™ï¼Œæˆ‘ä»¬ä½¿ç”¨$82-162$åˆ—è¿›è¡Œçº¦æŸï¼Œç¬¬82åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1è¡Œå¡«äº†æ•°å­—1ï¼›â€¦â€¦ï¼›ç¬¬90åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1è¡Œå¡«äº†æ•°å­—9ï¼›â€¦â€¦ï¼›ç¬¬162åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬9è¡Œå¡«äº†æ•°å­—9ã€‚å¦‚æœç¬¬ä¸€è¡Œå¡«å†™äº†ä¸¤æ¬¡1ï¼Œé‚£ä¹ˆçŸ©é˜µä¸­åˆ—1å°±ä¼šæœ‰ä¸¤è¡Œï¼Œå†æ¶ˆé™¤çš„æ—¶å€™è¿™ä¸¤ä¸ªç»“ç‚¹ä¼šè¢«åŒæ—¶æ¶ˆé™¤ï¼Œå°±ä¼šå¯¼è‡´æ— æ³•å®Œå…¨è¦†ç›–ã€‚</p>
<p>é’ˆå¯¹ç¬¬ä¸‰æ¡è§„åˆ™ï¼Œæˆ‘ä»¬ä½¿ç”¨$163-243$åˆ—è¿›è¡Œçº¦æŸï¼Œç¬¬163åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1åˆ—å¡«äº†æ•°å­—1ï¼›â€¦â€¦ï¼›ç¬¬171åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1åˆ—å¡«äº†æ•°å­—9ï¼›â€¦â€¦ï¼›ç¬¬243åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬9åˆ—å¡«äº†æ•°å­—9ã€‚</p>
<p>é’ˆå¯¹ç¬¬å››æ¡è§„åˆ™ï¼Œæˆ‘ä»¬ä½¿ç”¨$82-162$åˆ—è¿›è¡Œçº¦æŸï¼Œç¬¬244åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1å®«å¡«äº†æ•°å­—1ï¼›â€¦â€¦ï¼›ç¬¬252åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬1å®«å¡«äº†æ•°å­—9ï¼›â€¦â€¦ï¼›ç¬¬324åˆ—å®šä¹‰æˆï¼šåœ¨ç¬¬9å®«å¡«äº†æ•°å­—9ã€‚</p>
<p>åŸºäºä¸Šè¿°è§„åˆ™ï¼Œå°±å¯ä»¥æŠŠæ•°ç‹¬è½¬åŒ–ä¸ºä¸€ä¸ªç²¾ç¡®è¦†ç›–é—®é¢˜çš„çŸ©é˜µï¼Œåœ¨æ•°ç‹¬è½¬åŒ–çš„æ—¶å€™æ•°ç‹¬æœ‰ä¸¤ç§æƒ…å†µï¼Œå¡«å†™äº†æ•°å­—çš„å•å…ƒæ ¼å’Œæ²¡æœ‰å¡«å†™æ•°å­—çš„å•å…ƒæ ¼ï¼Œé’ˆå¯¹è¿™ä¸¤ä¸­æƒ…å†µéœ€è¦åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚</p>
<p>æœ‰æ•°å­—çš„å•å…ƒæ ¼ï¼Œæˆ‘ä»¬ä½¿ç”¨$N_1,N_2,N_3,N_4$å¯¹åº”ç€è§„åˆ™ä¸­çš„åˆ—ï¼Œè®¾æ•°å­—åœ¨  è¡Œ  åˆ—æ•°å€¼ä¸º  ã€‚å¯¹åº”çš„å…¬å¼å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
N_1=x*9+y</script><script type="math/tex; mode=display">
N_2=x*9+z+81</script><script type="math/tex; mode=display">
N_3=y*9+z+162</script><script type="math/tex; mode=display">
N_4=[x/3]*3+[y/3]*9+243</script><p>å…¶ä¸­$[]$ä»£è¡¨å–æ•´ã€‚</p>
<p>å¯¹äºæ²¡æœ‰æ•°å­—çš„å•å…ƒæ ¼ï¼Œå› ä¸ºæˆ‘ä»¬æ˜¯è¿›è¡Œæ±‚è§£ï¼Œæ‰€ä»¥è¿™ä¸ªæ ¼å­å¯èƒ½ä¼šå¡«å…¥$1-9$ä¸­ä»»æ„ä¸€ä¸ªæ•°å­—ï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠè¿™9ä¸ªå¡«å†™äº§ç”Ÿçš„è¡Œéƒ½æ’å…¥åˆ°çŸ©é˜µä¸­ï¼Œæœ€ç»ˆçš„è§£è‚¯å®šæ˜¯è¿™9è¡Œä¹‹ä¸€ã€‚</p>
<p>ä»£ç çš„å®ç°ä¸Šï¼Œåˆ›å»ºäº†ä¸€ä¸ªsudokuç±»ç»§æ‰¿DLXï¼Œsudokuçš„åˆå§‹åŒ–ï¼Œå‡½æ•°çš„è¾“å…¥æ•°ç‹¬çš„æ•°ç»„ã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sudoku</span>(<span class="title class_ inherited__">DLX</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, maze</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        args:</span></span><br><span class="line"><span class="string">            maze:å¤§å°9*9ï¼Œå†…å®¹ä¸ºæ¯ä¸ªå•å…ƒæ ¼å¡«å†™çš„æ•°å­—</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(<span class="number">9</span>*<span class="number">9</span>*<span class="number">4</span>)</span><br><span class="line">        <span class="comment"># åˆ‡æ–­å…³ç³»é‡‡å–æ·±å¤åˆ¶</span></span><br><span class="line">        <span class="variable language_">self</span>.maze = copy.deepcopy(maze)</span><br></pre></td></tr></table></figure>
<p>å°†æ•°ç‹¬è½¬åŒ–ä¸ºç²¾ç¡®è¦†ç›–çš„çŸ©é˜µä»£ç å®ç°èµ·æ¥ä¸éš¾ï¼Œéå†æ•°ç‹¬æ•°ç»„ï¼Œå†æŒ‰ç…§ä¸Šé¢ä»‹ç»çš„è¿›è¡Œè½¬åŒ–å°±è¡Œã€‚</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">pushToDLX</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            z = <span class="built_in">int</span>(<span class="variable language_">self</span>.maze[x][y])</span><br><span class="line">            colList = []</span><br><span class="line">            <span class="keyword">if</span> z != <span class="number">0</span>:</span><br><span class="line">                <span class="comment"># å•å…ƒæ ¼æœ‰æ•°å­—</span></span><br><span class="line">                N1 = x*<span class="number">9</span>+y</span><br><span class="line">                N2 = x*<span class="number">9</span>+z+<span class="number">80</span></span><br><span class="line">                N3 = y*<span class="number">9</span>+z+<span class="number">161</span></span><br><span class="line">                N4 = ((x//<span class="number">3</span>)*<span class="number">3</span>+(y//<span class="number">3</span>))*<span class="number">9</span>+z+<span class="number">242</span></span><br><span class="line">                colList.append(N1)</span><br><span class="line">                colList.append(N2)</span><br><span class="line">                colList.append(N3)</span><br><span class="line">                colList.append(N4)</span><br><span class="line">                <span class="variable language_">self</span>.pushRow(colList)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># å•å…ƒæ ¼æ²¡æœ‰æ•°å­—ï¼Œå°†9ç§å¯èƒ½æ€§éƒ½æ’å…¥</span></span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>):</span><br><span class="line">                    colList = []</span><br><span class="line">                    z = i</span><br><span class="line">                    N1 = x*<span class="number">9</span>+y</span><br><span class="line">                    N2 = x*<span class="number">9</span>+z+<span class="number">80</span></span><br><span class="line">                    N3 = y*<span class="number">9</span>+z+<span class="number">161</span></span><br><span class="line">                    N4 = ((x//<span class="number">3</span>)*<span class="number">3</span>+(y//<span class="number">3</span>))*<span class="number">9</span>+z+<span class="number">242</span></span><br><span class="line">                    colList.append(N1)</span><br><span class="line">                    colList.append(N2)</span><br><span class="line">                    colList.append(N3)</span><br><span class="line">                    colList.append(N4)</span><br><span class="line">                    <span class="variable language_">self</span>.pushRow(colList)</span><br></pre></td></tr></table></figure>
<p>æœ€åè¿˜æœ‰ä¸€ä¸ªå‡½æ•°å°±æ˜¯å°†ç²¾ç¡®è¦†ç›–çš„è§£è½¬åŒ–ä¸ºæ•°ç‹¬æ•°ç»„é‡Œé¢çš„å€¼ï¼Œå› ä¸ºè§£é‡Œé¢å­˜çš„æ˜¯äºŒç»´æ•°ç»„ï¼Œä¸€è¡Œç§å­˜çš„æ˜¯å››ä¸ªåˆ—çš„å€¼ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸‹å…¬å¼è¿›è¡Œæ±‚è§£ã€‚</p>
<script type="math/tex; mode=display">
x=[N_1/9]</script><script type="math/tex; mode=display">
y=N1\%9</script><script type="math/tex; mode=display">
z=[N_2-81]\%9</script><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ans2Maze</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">for</span> col <span class="keyword">in</span> <span class="variable language_">self</span>.ans:</span><br><span class="line">        x = col[<span class="number">0</span>]//<span class="number">9</span></span><br><span class="line">        y = col[<span class="number">0</span>] % <span class="number">9</span></span><br><span class="line">        z = (col[<span class="number">1</span>]-<span class="number">80</span>) % <span class="number">9</span></span><br><span class="line">        <span class="keyword">if</span> z == <span class="number">0</span>:</span><br><span class="line">            z = <span class="number">9</span></span><br><span class="line">        <span class="variable language_">self</span>.maze[x][y] = z</span><br></pre></td></tr></table></figure>
<h3 id="sudokuoreä»‹ç»"><a href="#sudokuoreä»‹ç»" class="headerlink" title="sudokuoreä»‹ç»"></a>sudokuoreä»‹ç»</h3><p>sudokuoreæ˜¯ä¸€ä¸ªç±»ç”¨äºç®¡ç†æ•°ç‹¬æ¸¸æˆï¼Œæ¯”å¦‚ä»€ä¹ˆæç¤ºã€å¼€å§‹æ¸¸æˆã€é‡æ–°å¼€å§‹æ¸¸æˆç­‰åŠŸèƒ½ï¼Œåœ¨è¿™é‡Œåªä»‹ç»ä¸€ä¸‹æ•°ç»„æ¸¸æˆä¸­çš„ç”Ÿæˆæ•°ç»„ã€‚æ•°ç»„ç”Ÿæˆä¹Ÿæœ‰ä¸€ç³»åˆ—çš„æ–¹æ³•ï¼Œæ¯”å¦‚è‡ªå·±éšæœºç”Ÿæˆä¸€äº›æ•°å­—å¡«ä¸€ä¸‹ç„¶ååˆ¤æ–­æ•°å­—èƒ½å¦æœ‰è§£ä¹‹ç±»çš„ï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•ç”Ÿæˆæ—¶é—´å¤ªé•¿ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œé‡‡å–çš„æ˜¯é€‰ä¸€ä¸ªå·²ç»ç”Ÿæˆçš„åˆç›˜æ•°ç‹¬ï¼Œå°†å…¶ä¸­æ•°å­—è¿›è¡Œå˜æ¢ï¼Œæ¯”å¦‚æˆ‘ä»¬æŠŠåˆç›˜ä¸­â€œ1â€å’Œâ€œ2â€è¿›è¡Œæ›¿æ¢ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°ç»„è¿˜æ˜¯ä¸€æ ·çš„æœ‰è§£ï¼Œå®ç°äº†ä¸€ä¸ªçœ‹èµ·æ¥å’Œä¹‹å‰ç›¸æ¯”å°±æ˜¯å˜åŒ–çš„ï¼Œå¦‚å›¾å±•ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712162558036.png" alt="image-20220712162558036"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">sudokucore</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.Iscanchangmaze = [[<span class="literal">True</span>]*<span class="number">9</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>)]</span><br><span class="line">        <span class="variable language_">self</span>.randomList = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">10</span>)]</span><br><span class="line">        <span class="comment"># levelfile ä¿å­˜ç€åˆç›˜æ•°ç»„</span></span><br><span class="line">        <span class="variable language_">self</span>.LevelFile = <span class="string">&#x27;å›°éš¾.txt&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.initMaze()</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.Leveldict = <span class="built_in">dict</span>()</span><br><span class="line">        <span class="variable language_">self</span>.Leveldict[<span class="number">1</span>] = <span class="string">&#x27;ç®€å•.txt&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.Leveldict[<span class="number">2</span>] = <span class="string">&#x27;æ™®é€š.txt&#x27;</span></span><br><span class="line">        <span class="variable language_">self</span>.Leveldict[<span class="number">3</span>] = <span class="string">&#x27;å›°éš¾.txt&#x27;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="variable language_">self</span>.Iscanchangmaze)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">initMaze</span>(<span class="params">self</span>):</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">self</span>.maze = []</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="variable language_">self</span>.LevelFile, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">                <span class="variable language_">self</span>.maze.append(line.strip().split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">        <span class="comment"># è¿›è¡Œæ´—ç‰Œ</span></span><br><span class="line">        random.shuffle(<span class="variable language_">self</span>.randomList)</span><br><span class="line">        <span class="built_in">print</span>(<span class="variable language_">self</span>.randomList)</span><br><span class="line">        <span class="variable language_">self</span>.colDict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            <span class="variable language_">self</span>.colDict[<span class="variable language_">self</span>.randomList[i]] = i</span><br><span class="line">        <span class="comment"># è¿›è¡Œå˜æ¢</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="variable language_">self</span>.colDict)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">                z = <span class="built_in">int</span>(<span class="variable language_">self</span>.maze[i][j])</span><br><span class="line">                <span class="keyword">if</span> z != <span class="number">0</span>:</span><br><span class="line">                    index = <span class="variable language_">self</span>.colDict[z]</span><br><span class="line">                    <span class="comment"># å¯¹åº”çš„æ•°å­—è¿›è¡Œå˜æ¢</span></span><br><span class="line">                    <span class="variable language_">self</span>.maze[i][j] = <span class="variable language_">self</span>.randomList[(index+<span class="number">1</span>) % <span class="number">9</span>]</span><br><span class="line">                    <span class="variable language_">self</span>.Iscanchangmaze[i][j] = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<h2 id="è¿è¡Œç»“æœå±•ç¤º"><a href="#è¿è¡Œç»“æœå±•ç¤º" class="headerlink" title="è¿è¡Œç»“æœå±•ç¤º"></a>è¿è¡Œç»“æœå±•ç¤º</h2><p>ç•Œé¢è¿è¡Œå’Œå„ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½å±•ç¤ºï¼Œå¦‚å›¾5æ‰€å±•ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712162658587.png" alt="å›¾5"></p>
<p>å…¨éƒ¨å¡«å†™å®Œæˆåç»“æœå±•ç¤ºå¦‚å›¾6æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/æ•°æ®ç»“æ„/image-20220712162721385.png" alt="å›¾6"></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™æ¬¡çš„æ•°ç‹¬å°æ¸¸æˆï¼Œè®©æˆ‘å­¦ä¹ åˆ°äº†å¦‚ä½•å®Œæˆä¸€ä¸ªå®Œæ•´çš„å°å·¥ç¨‹ï¼Œä¹Ÿå­¦ä¹ äº†èˆè¹ˆé“¾çš„ç¼–å†™å’Œå®ç°ï¼Œè¿™ä¸ªé¡¹ç›®è¿˜æœ‰è®¸å¤šå€¼å¾—æ”¹è¿›çš„åœ°æ–¹ï¼Œå¸Œæœ›åç»­æœ‰æ—¶é—´å†è¿›è¡Œæ”¹è¿›å§ã€‚</p>
<p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/bugcat9/sudoku">https://github.com/bugcat9/sudoku</a></p>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a href="https://zh.m.wikipedia.org/zh-hans/X%E7%AE%97%E6%B3%95">https://zh.m.wikipedia.org/zh-hans/X%E7%AE%97%E6%B3%95</a></li>
<li><a href="https://zh.m.wikipedia.org/zh-hans/%E7%B2%BE%E7%A1%AE%E8%A6%86%E7%9B%96%E9%97%AE%E9%A2%98">https://zh.m.wikipedia.org/zh-hans/%E7%B2%BE%E7%A1%AE%E8%A6%86%E7%9B%96%E9%97%AE%E9%A2%98</a></li>
<li><a href="https://zh.m.wikipedia.org/zh-hans/%E8%88%9E%E8%B9%88%E9%93%BE">https://zh.m.wikipedia.org/zh-hans/%E8%88%9E%E8%B9%88%E9%93%BE</a></li>
<li><a href="http://www.mamicode.com/info-detail-2274481.html">http://www.mamicode.com/info-detail-2274481.html</a></li>
<li><a href="https://www.cnblogs.com/grenet/p/3145800.html">https://www.cnblogs.com/grenet/p/3145800.html</a></li>
<li><a href="https://www.cnblogs.com/grenet/p/3145800.html">https://www.cnblogs.com/grenet/p/3145800.html</a></li>
<li><a href="https://www.cnblogs.com/grenet/p/7903680.html">https://www.cnblogs.com/grenet/p/7903680.html</a></li>
<li><a href="https://www.cnblogs.com/wujiechao/p/5767124.html">https://www.cnblogs.com/wujiechao/p/5767124.html</a></li>
<li><a href="https://blog.csdn.net/WhereIsHeroFrom/article/details/79220897">https://blog.csdn.net/WhereIsHeroFrom/article/details/79220897</a></li>
<li><a href="https://blog.csdn.net/qq_26822029/article/details/81129701">https://blog.csdn.net/qq_26822029/article/details/81129701</a></li>
<li><a href="https://blog.csdn.net/peng_wu01/article/details/6026103">https://blog.csdn.net/peng_wu01/article/details/6026103</a></li>
<li><a href="https://blog.csdn.net/zj0395/article/details/72773001">https://blog.csdn.net/zj0395/article/details/72773001</a></li>
</ul>
]]></content>
      <categories>
        <category>æ•°æ®ç»“æ„</category>
      </categories>
      <tags>
        <tag>èˆè¹ˆé“¾</tag>
        <tag>æ•°ç‹¬</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxä¸­socketåœ°å€API</title>
    <url>/2022/08/11/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Linux%E4%B8%ADsocket%E5%9C%B0%E5%9D%80API/</url>
    <content><![CDATA[<h1 id="Linuxä¸­socketåœ°å€API"><a href="#Linuxä¸­socketåœ°å€API" class="headerlink" title="Linuxä¸­socketåœ°å€API"></a>Linuxä¸­socketåœ°å€API</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­socketåœ°å€çš„åŸºç¡€ï¼ŒåŒ…æ‹¬ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åºã€socketåœ°å€å’ŒIPåœ°å€è½¬åŒ–å‡½æ•°ã€‚</p>
<span id="more"></span>
<h2 id="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº"><a href="#ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº" class="headerlink" title="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº"></a>ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</h2><p>è®¡ç®—æœºç¡¬ä»¶æœ‰ä¸¤ç§å‚¨å­˜æ•°æ®çš„æ–¹å¼ï¼š<strong>å¤§ç«¯å­—èŠ‚åºï¼ˆbig endianï¼‰</strong>å’Œ<strong>å°ç«¯å­—èŠ‚åºï¼ˆlittle endianï¼‰</strong>ã€‚</p>
<ul>
<li><strong>å¤§ç«¯å­—èŠ‚åº</strong>ï¼šé«˜ä½å­—èŠ‚åœ¨å‰ï¼Œä½ä½å­—èŠ‚åœ¨åï¼Œç¬¦åˆäººç±»è¯»å†™æ•°å€¼çš„æ–¹æ³•ã€‚</li>
<li><strong>å°ç«¯å­—èŠ‚åº</strong>ï¼šä½ä½å­—èŠ‚åœ¨å‰ï¼Œé«˜ä½å­—èŠ‚åœ¨å</li>
</ul>
<p>æƒ³è¦åˆ¤åˆ«æœºå™¨çš„å­—èŠ‚åºå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">byteorder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="type">short</span> value;</span><br><span class="line">		<span class="type">char</span> union_bytes[<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">	&#125; test;</span><br><span class="line">	test.value = <span class="number">0x0102</span>;</span><br><span class="line">	<span class="keyword">if</span> ((test.union_bytes[<span class="number">0</span>] == <span class="number">1</span>) &amp;&amp; (test.union_bytes[<span class="number">1</span>] == <span class="number">2</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;big endian\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((test.union_bytes[<span class="number">0</span>] == <span class="number">2</span>) &amp;&amp; (test.union_bytes[<span class="number">1</span>] == <span class="number">1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;little endian\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;unknown...\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	byteorder();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220809181538872.png" alt="image-20220809181538872"></p>
<p>è¿™æ®µä»£ç ä½¿ç”¨çš„åŸç†æ˜¯<strong>unionå˜é‡æ‰€å ç”¨çš„å†…å­˜é•¿åº¦ç­‰äºæœ€é•¿çš„æˆå‘˜çš„å†…å­˜é•¿åº¦ã€‚</strong></p>
<p>æ‰€ä»¥<code>test</code>ä¸­<code>value</code>å’Œ<code>union_bytes</code>æ˜¯å…±ç”¨ä¸€æ®µå†…å­˜çš„ã€‚å› ä¸ºåœ¨cä¸­<code>short</code>æ˜¯16ä½ä¹Ÿå°±æ˜¯2å­—èŠ‚ï¼Œ<code>char</code>æ˜¯8ä½ä¹Ÿå°±æ˜¯1å­—èŠ‚ï¼Œæ‰€ä»¥<code>union_bytes</code>æ•°ç»„çš„å¤§å°æ˜¯2ã€‚</p>
<p>æˆ‘ä»¬ç»™<code>value</code>èµ‹å€¼ä¸º<code>0x0102</code>ã€‚å¦‚æœæ˜¯æœºå™¨æ˜¯å¤§ç«¯å­˜å‚¨ï¼Œé‚£ä¹ˆ<code>union_bytes</code>æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å­˜å‚¨<code>0x01</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ å­˜å‚¨<code>0x02</code>ï¼Œå¦‚æœæ˜¯æœºå™¨æ˜¯å°ç«¯å­˜å‚¨ï¼Œé‚£ä¹ˆ<code>union_bytes</code>æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å­˜å‚¨<code>0x02</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ å­˜å‚¨<code>0x01</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/Snipaste_2023-03-29_19-41-48.png" alt="image-20220809185922374"></p>
<p>æ‰©å±•åˆ°32ä½ï¼Œå››å­—èŠ‚æ¥è¯´ä»¥<code>0x12345678</code>ä¸ºä¾‹ï¼Œé‚£ä¹ˆ</p>
<p><strong>å¤§ç«¯å­—èŠ‚åº</strong>ï¼š0x12345678</p>
<p><strong>å°ç«¯å­—èŠ‚åº</strong>ï¼š0x78563412</p>
<p>æ€»ç»“æ¥è¯´å°±æ˜¯å¤§ç«¯å­—èŠ‚åºå’Œå°ç«¯å­—èŠ‚åºçš„åŒºåˆ«å°±æ˜¯ä»¥<strong>å­—èŠ‚</strong>ä¸ºå•ä½çš„å­˜å‚¨æ–¹å¼ä¸åŒã€‚</p>
<p>åœ¨ç½‘ç»œä¸­ä¸¤å°ä½¿ç”¨ä¸åŒå­—èŠ‚åºçš„ä¸»æœºä¹‹é—´ç›´æ¥ä¼ é€’æ—¶ï¼Œæ¥æ”¶ç«¯å¿…ç„¶ä¼šé€ æˆé”™è¯¯ã€‚ä¹¦ä¸­è¯´è§£å†³çš„æ–¹æ³•æ˜¯å‘é€ç«¯æ€»æ˜¯æŠŠè¦å‘é€çš„æ•°æ®è½¬åŒ–æˆå¤§ç«¯å­—èŠ‚åºæ•°æ®å†å‘é€ï¼Œæ¥å—ç«¯çŸ¥é“ä¼ é€è¿‡æ¥çš„æ•°æ®æ€»æ˜¯é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥æ¥æ”¶ç«¯æ ¹æ®è‡ªèº«é‡‡ç”¨çš„å­—èŠ‚åºå†å¯¹æ•°æ®è¿›è¡Œä¸€å®šçš„å¤„ç†ï¼ˆå°ç«¯è¿›è¡Œè½¬æ¢ï¼Œå¤§ç«¯å°±ä¸è½¬æ¢ï¼‰ã€‚</p>
<p>Linuxæä¾›äº†4ä¸ªå‡½æ•°æ¥å®Œæˆä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åºä¹‹é—´çš„è½¬æ¢:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810153657086.png" alt="image-20220810153657086"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ntohl</span> <span class="params">(<span class="type">uint32_t</span> __netlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">ntohs</span> <span class="params">(<span class="type">uint16_t</span> __netshort)</span>;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">htonl</span> <span class="params">(<span class="type">uint32_t</span> __hostlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">htons</span> <span class="params">(<span class="type">uint16_t</span> __hostshort)</span>;</span><br></pre></td></tr></table></figure>
<p>å®ƒä»¬çš„å«ä¹‰æ˜¯å°±æ˜¯é¦–å­—æ¯ç¼©å†™ï¼ˆè¿™è°çœ‹çš„å‡ºæ¥ï¼‰ï¼Œæ¯”å¦‚â€htonlâ€è¡¨ç¤ºâ€œhost to network longâ€ï¼Œå³å°†é•¿æ•´å‹ï¼ˆ32bitï¼‰çš„ä¸»æœºå­—èŠ‚åºæ•°æ®è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åºæ•°æ®ã€‚è¿™å››ä¸ªå‡½æ•°ä¸­ï¼Œé•¿æ•´å‹<code>uint32_t</code>å‡½æ•°é€šå¸¸ç”¨æ¥è½¬æ¢IPåœ°å€ï¼ŒçŸ­æ•´å‹<code>uint16_t</code>å‡½æ•°ç”¨æ¥è½¬åŒ–ç«¯å£å·ã€‚</p>
<p>ç®€å•ç¤ºä¾‹å±•ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="number">258</span>;</span><br><span class="line">    <span class="type">uint16_t</span> p = htons(port);</span><br><span class="line">    port = ntohs(p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;htons :%u \n&quot;</span>, p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ntohs :%u \n&quot;</span>, port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810181643405.png" alt="image-20220810181643405"></p>
<p><code>513</code>äºŒè¿›åˆ¶ï¼š<code>0000 0010 0000 0001</code></p>
<p><code>258</code>äºŒè¿›åˆ¶ï¼š<code>0000 0001 0000 0010</code></p>
<p>å¯ä»¥çœ‹å‡ºä¸¤è€…å­—èŠ‚åºæ˜¯ä¸åŒçš„</p>
<h2 id="socketåœ°å€"><a href="#socketåœ°å€" class="headerlink" title="socketåœ°å€"></a>socketåœ°å€</h2><h3 id="é€šç”¨socketåœ°å€"><a href="#é€šç”¨socketåœ°å€" class="headerlink" title="é€šç”¨socketåœ°å€"></a>é€šç”¨socketåœ°å€</h3><h4 id="sockaddr"><a href="#sockaddr" class="headerlink" title="sockaddr"></a>sockaddr</h4><p>socketç½‘ç»œæ¥å£ä¸­è¡¨ç¤ºsocketåœ°å€çš„æ˜¯ç»“æ„ä½“<code>sockaddr</code>ï¼Œä»–çš„å®šä¹‰åœ¨å¤´<code>&lt;bits/socket.h&gt;</code>ä¸­ï¼Œæˆ‘çœ‹åœ¨æˆ‘çš„ç”µè„‘ä¸Šçœ‹åˆ°çš„æ˜¯å¦‚ä¸‹çš„å®šä¹‰ï¼ˆå„ä¸ªç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å®ç°ä¸åŒï¼Œæˆ‘è¿™é‡Œå’Œä¹¦ä¸Šå°±ä¸å¤§ç›¸åŒï¼‰ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810185029006.png" alt="image-20220810185029006"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing a generic socket address.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sa_);	<span class="comment">/* Common data: address family and length.  */</span></span><br><span class="line">    <span class="type">char</span> sa_data[<span class="number">14</span>];		<span class="comment">/* Address data.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>__SOCKADDR_COMMON</code>å®šä¹‰åœ¨<code>&lt;bits/sockaddr.h&gt;</code>ä¸­</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810185204703.png" alt="image-20220810185204703"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/sockaddr.h&gt;</span></span></span><br><span class="line"><span class="comment">/* POSIX.1g specifies this type name for the `sa_family&#x27; member.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> <span class="type">sa_family_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This macro is used to declare the initial common members</span></span><br><span class="line"><span class="comment">   of the data types used for socket addresses, `struct sockaddr&#x27;,</span></span><br><span class="line"><span class="comment">   `struct sockaddr_in&#x27;, `struct sockaddr_un&#x27;, etc.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	__SOCKADDR_COMMON(sa_prefix) sa_family_t sa_prefix##family</span></span><br></pre></td></tr></table></figure>
<p><code>__SOCKADDR_COMMON</code>æ˜¯å®šä¹‰çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª<code>sa_family_t</code>ç±»å‹çš„æ•°æ®ï¼Œæ•°æ®çš„åå­—æ˜¯<code>sa_prefixfamily</code>ï¼Œå…¶ä¸­<code>sa_prefix</code>æ˜¯ä½ ä¼ è¿›å»çš„å€¼ã€‚æ¯”å¦‚ï¼š<code>__SOCKADDR_COMMON (sa_)</code>å…¶å®å°±æ˜¯è¿”å›<code>sa_family_t sa_family</code>ã€‚</p>
<p>æ‰€ä»¥<code>sockaddr</code>å…¶å®å°±æ˜¯ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯<code>sa_family_t</code>ï¼ˆåœ°å€æ—ï¼‰ç±»å‹çš„å˜é‡<code>sa_family</code>ï¼Œä¸€ä¸ª<code>char</code>æ•°ç»„ç±»å‹çš„å˜é‡<code>sa_data</code></p>
<p><code>sa_family_t</code>å¸¸è§çš„åè®®æ—ï¼ˆprotocol familyï¼Œä¹Ÿç§°domainï¼‰å’Œå¯¹åº”çš„åœ°å€æ—å¦‚ä¸‹è¡¨æ‰€ç¤º</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åè®®æ—</th>
<th style="text-align:center">åœ°å€æ—</th>
<th style="text-align:center">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PF_UNIX</td>
<td style="text-align:center">AF_UNIX</td>
<td style="text-align:center">UNIXæœ¬åœ°åè®®æ—</td>
</tr>
<tr>
<td style="text-align:center">PF_INET</td>
<td style="text-align:center">AF_INET</td>
<td style="text-align:center">IPv4åè®®æ—</td>
</tr>
<tr>
<td style="text-align:center">PF_INET6</td>
<td style="text-align:center">AF_INET6</td>
<td style="text-align:center">IPv6åè®®æ—</td>
</tr>
</tbody>
</table>
</div>
<p>å®PF_*å’ŒAF_*éƒ½å®šä¹‰åœ¨<code>&lt;bits/socket.h&gt;</code>å½“ä¸­ï¼Œä¸¤è€…çš„å€¼ç›¸åŒï¼Œæ‰€ä»¥ä¸¤è€…å¯ä»¥æ··ç”¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811094342093.png" alt="image-20220811094342093"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811094510529.png" alt="image-20220811094510529"></p>
<p><code>sa_data</code>æˆå‘˜ç”¨äºå­˜æ”¾socketåœ°å€å€¼ã€‚ä¸åŒçš„åè®®æ—çš„åœ°å€å€¼æœ‰ä¸åŒçš„å«ä¹‰å’Œé•¿åº¦ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åè®®æ—</th>
<th style="text-align:center">åœ°å€å€¼å«ä¹‰å’Œé•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PF_UNIX</td>
<td style="text-align:center">æ–‡ä»¶çš„è·¯å¾„åï¼Œé•¿åº¦å¯è¾¾108å­—èŠ‚</td>
</tr>
<tr>
<td style="text-align:center">PF_INET</td>
<td style="text-align:center">16bitç«¯å£å·å’Œ32bit IPv4åœ°å€ï¼Œå…±6å­—èŠ‚</td>
</tr>
<tr>
<td style="text-align:center">PF_INET6</td>
<td style="text-align:center">16bitç«¯å£å·ï¼Œ32bitæµæ ‡è¯†ï¼Œ128bit IPv6åœ°å€ï¼Œ32bitèŒƒå›´IDï¼Œå…±26å­—èŠ‚</td>
</tr>
</tbody>
</table>
</div>
<h4 id="sockaddr-storage"><a href="#sockaddr-storage" class="headerlink" title="sockaddr_storage"></a>sockaddr_storage</h4><p>å¯ä»¥çœ‹å‡º14å­—èŠ‚çš„<code>sa_data</code>æ ¹æœ¬æ— æ³•å®¹çº³å¤šæ•°åè®®æ—çš„åœ°å€å€¼ã€‚æ‰€ä»¥ï¼ŒLinuxä¸­å®šä¹‰äº†æ–°çš„é€šç”¨socketåœ°å€ç»“æ„ä½“ï¼ˆå…¶å®å°±æ˜¯æŠŠå­˜æ”¾åœ°å€çš„æ•°ç»„åŠ å¤§äº†ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure large enough to hold any socket address (with the historical</span></span><br><span class="line"><span class="comment">   exception of AF_UNIX).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ss_aligntype	unsigned long int</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SS_PADSIZE \</span></span><br><span class="line"><span class="meta">  (_SS_SIZE - __SOCKADDR_COMMON_SIZE - sizeof (__ss_aligntype))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (ss_);	<span class="comment">/* Address family, etc.  */</span></span><br><span class="line">    <span class="type">char</span> __ss_padding[_SS_PADSIZE];</span><br><span class="line">    __ss_aligntype __ss_align;	<span class="comment">/* Force desired alignment.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>_SS_SIZE</code>ã€<code>__SOCKADDR_COMMON_SIZE</code>åœ¨<code>&lt;bits/sockaddr.h&gt;</code>å½“ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/sockaddr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SOCKADDR_COMMON_SIZE	(sizeof (unsigned short int))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of struct sockaddr_storage.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SS_SIZE 128</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811135111456.png" alt="image-20220811135111456"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811135134566.png" alt="image-20220811135134566"></p>
<p>è¿™ä¸ªç»“æ„ä½“æä¾›äº†è¶³å¤Ÿå¤§çš„ç©ºé—´ç”¨äºå­˜æ”¾åœ°å€å€¼ï¼Œå¹¶ä¸”æ˜¯å†…å­˜å¯¹é½çš„ã€‚</p>
<p><code>ss_</code>ï¼ˆå…¶å®æ˜¯<code>ss_family</code>ï¼‰æ˜¯<code>sa_family_t</code>ç±»å‹ï¼ˆä»‹ç»<code>sockaddr</code>æœ‰æåˆ°ï¼‰ï¼Œå³<code>unsigned short int</code>ç±»å‹ï¼Œ2å­—èŠ‚ã€‚</p>
<p><code>__ss_align</code>æ˜¯<code>__ss_aligntype</code>ç±»å‹ï¼Œå³<code>unsigned long int</code>ç±»å‹ï¼Œ4å­—èŠ‚</p>
<p><code>__ss_padding</code>æ˜¯<code>char</code>ç±»å‹æ•°ç»„ï¼Œå¤§å°ä¸º<code>_SS_PADSIZE</code>ï¼Œè€Œ<code>_SS_PADSIZE=_SS_SIZE - __SOCKADDR_COMMON_SIZE - sizeof (__ss_aligntype)=128-2-4=122</code>å­—èŠ‚ï¼Œå®Œå…¨è¶³å¤Ÿä¿å­˜åœ°å€å€¼ã€‚</p>
<p>ç»¼ä¸Š<code>sockaddr_storage</code>æ˜¯128å­—èŠ‚å¤§å°ï¼Œä¿è¯äº†å†…å­˜å¯¹é½ã€‚</p>
<h3 id="ä¸“ç”¨socketåœ°å€"><a href="#ä¸“ç”¨socketåœ°å€" class="headerlink" title="ä¸“ç”¨socketåœ°å€"></a>ä¸“ç”¨socketåœ°å€</h3><p>ä¸Šé¢ä¸¤ç§é€šç”¨çš„socketåœ°å€ä½¿ç”¨èµ·æ¥æ˜¾ç„¶ä¸å¤Ÿæ–¹ä¾¿ï¼Œå› ä¸ºå°†IPåœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯ç›´æ¥æ”¾åœ¨åŒä¸€ä¸ª<code>char</code>æ•°ç»„ä¸­ï¼Œé‚£è¦å¾—åˆ°IPåœ°å€å’Œç«¯å£ä¿¡æ¯éƒ½å¾—è´¹å¥½å¤§åŠ²è¿›è¡Œæ“ä½œã€‚å› æ­¤ï¼ŒLinuxä¸ºå„ä¸ªåè®®æ—æä¾›äº†ä¸“é—¨çš„socketåœ°å€ç»“æ„ä½“ã€‚</p>
<p>UNIXæœ¬åœ°åè®®æ—ä½¿ç”¨<code>sockaddr_un</code>ï¼Œæ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªä¿å­˜åœ°å€æ—ç±»å‹çš„<code>sun_</code>ï¼ˆå…¶å®æ˜¯<code>sun_family</code>ï¼‰å’Œä¿å­˜æ–‡ä»¶ä½ç½®çš„<code>sun_path</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing the address of an AF_LOCAL (aka AF_UNIX) socket.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sun_);</span><br><span class="line">    <span class="type">char</span> sun_path[<span class="number">108</span>];		<span class="comment">/* Path name.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>IPv4åè®®æ—ä½¿ç”¨<code>sockaddr_in</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing an Internet socket address.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sin_);</span><br><span class="line">    <span class="type">in_port_t</span> sin_port;			<span class="comment">/* Port number.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span>		<span class="comment">/* Internet address.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pad to size of `struct sockaddr&#x27;.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sin_zero[<span class="keyword">sizeof</span> (<span class="keyword">struct</span> sockaddr)</span><br><span class="line">			   - __SOCKADDR_COMMON_SIZE</span><br><span class="line">			   - <span class="keyword">sizeof</span> (<span class="type">in_port_t</span>)</span><br><span class="line">			   - <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in_addr)];</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>in_port_t</code>å®šä¹‰ã€<code>in_addr_t</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Type to represent a port.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint16_t</span> <span class="type">in_port_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Internet address.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> <span class="type">in_addr_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">in_addr_t</span> s_addr;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143542024.png" alt="image-20220811143542024"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143600470.png" alt="image-20220811143600470"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143622907.png" alt="image-20220811143622907"></p>
<p>å¯ä»¥çœ‹çš„å‡ºæ¥<code>sin_</code>ï¼ˆå…¶å®æ˜¯<code>sin_family</code>ï¼‰å­˜æ”¾åœ°å€æ—ç±»å‹ï¼Œ<code>sin_port</code>å­˜æ”¾ç«¯å£ï¼Œ<code>sin_addr</code>å­˜æ”¾åœ°å€ã€‚<code>sin_zero</code>ä¸ºäº†è®©<code>sockaddr_in</code>å¤§å°å’Œ<code>sockaddr</code>ç›¸åŒï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªæˆå‘˜ï¼Œä¸ªäººæ„Ÿè§‰è¿™æ˜¯å› ä¸ºæ‰€ä»¥<strong>ä¸“ç”¨socket</strong>åœ¨å®é™…ä½¿ç”¨ä¸­éƒ½éœ€è¦è½¬åŒ–ä¸º<strong>é€šç”¨socketåœ°å€ç±»å‹</strong><code>socketaddr</code>ï¼Œå› ä¸ºsocketç¼–ç¨‹æ¥å£ä½¿ç”¨çš„æ˜¯å‚æ•°ç±»å‹æ˜¯<code>socketaddr</code>ã€‚</p>
<p>IPv6åè®®æ—ä½¿ç”¨<code>sockaddr_in6</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Ditto, for IPv6.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sin6_);</span><br><span class="line">    <span class="type">in_port_t</span> sin6_port;	<span class="comment">/* Transport layer port # */</span></span><br><span class="line">    <span class="type">uint32_t</span> sin6_flowinfo;	<span class="comment">/* IPv6 flow information */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">sin6_addr</span>;</span>	<span class="comment">/* IPv6 address */</span></span><br><span class="line">    <span class="type">uint32_t</span> sin6_scope_id;	<span class="comment">/* IPv6 scope-id */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>in6_addr</code>å¦‚ä¸‹ï¼Œå› ä¸ºIPv6ä¸æ˜¯å­¦ä¹ é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šå±•å¼€ä»‹ç»ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* IPv6 address */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">	<span class="type">uint8_t</span>	__u6_addr8[<span class="number">16</span>];</span><br><span class="line">	<span class="type">uint16_t</span> __u6_addr16[<span class="number">8</span>];</span><br><span class="line">	<span class="type">uint32_t</span> __u6_addr32[<span class="number">4</span>];</span><br><span class="line">      &#125; __in6_u;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> s6_addr			__in6_u.__u6_addr8</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __USE_MISC</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> s6_addr16		__in6_u.__u6_addr16</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> s6_addr32		__in6_u.__u6_addr32</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–éœ€è¦æ³¨æ„ï¼šæ‰€æœ‰<strong>ä¸“ç”¨socketåœ°å€</strong>ï¼ˆä»¥åŠ<code>sockaddr_storage</code>ï¼‰ç±»å‹çš„å˜é‡åœ¨å®é™…ä½¿ç”¨æ—¶éƒ½éœ€è¦è½¬åŒ–ä¸º<strong>é€šç”¨socketåœ°å€</strong>ç±»å‹<code>sockaddr</code>ï¼ˆå¼ºåˆ¶è½¬æ¢å³å¯)ï¼Œå› ä¸ºæ‰€æœ‰socketç¼–ç¨‹æ¥å£ä½¿ç”¨çš„åœ°å€å‚æ•°çš„ç±»å‹éƒ½æ˜¯sockaddrã€‚</p>
<h2 id="IPåœ°å€è½¬åŒ–å‡½æ•°"><a href="#IPåœ°å€è½¬åŒ–å‡½æ•°" class="headerlink" title="IPåœ°å€è½¬åŒ–å‡½æ•°"></a>IPåœ°å€è½¬åŒ–å‡½æ•°</h2><p>é€šå¸¸æ¥è¯´ï¼Œäººä»¬æ›´å–œæ¬¢ç”¨ç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºIPv4åœ°å€ï¼Œä½†æ˜¯åœ¨ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•´æ•°æ‰èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯è¾“å‡ºçš„æ—¶å€™æˆ‘ä»¬åˆéœ€è¦æŠŠæ•´æ•°è½¬åŒ–æˆç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·æ–¹ä¾¿è§‚å¯Ÿã€‚æ‰€ä»¥ç³»ç»Ÿæä¾›äº†3ä¸ªå‡½æ•°ç”¨äºç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²IPv4åœ°å€å’Œæ•´æ•°çš„IPv4åœ°å€ä¹‹é—´çš„è½¬åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet host address from numbers-and-dots notation in CP</span></span><br><span class="line"><span class="comment">   into binary data in network byte order.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">in_addr_t</span> <span class="title function_">inet_addr</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__cp)</span> __THROW;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet host address from numbers-and-dots notation in CP</span></span><br><span class="line"><span class="comment">   into binary data and store the result in the structure INP.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">inet_aton</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__cp, <span class="keyword">struct</span> in_addr *__inp)</span> __THROW;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet number in IN to ASCII representation.  The return value</span></span><br><span class="line"><span class="comment">   is a pointer to an internal array containing the string.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> *<span class="title function_">inet_ntoa</span> <span class="params">(<span class="keyword">struct</span> in_addr __in)</span> __THROW;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>inet_addr</code>å‡½æ•°å°†ç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€è½¬åŒ–ä¸ºç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€ã€‚å®ƒå¤±è´¥æ—¶è¿”å› <code>INADDR_NONE</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">in_addr_t</span> ip = <span class="built_in">inet_addr</span>(<span class="string">&quot;192.168.167.14&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ip == INADDR_NONE)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_addr %u \n&quot;</span>, ip);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811170759741.png" alt="image-20220811170759741"></p>
<p><code>inet_aton</code>åŠŸèƒ½å’Œ<code>inet_addr</code>ç›¸åŒï¼Œä½†æ˜¯å°†ç»“æœå­˜åœ¨åœ¨<code>in_addr_t</code>æŒ‡å‘çš„åœ°å€ç»“æ„å½“ä¸­ï¼Œå‡½æ•°æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_aton %u \n&quot;</span>, ip.s_addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811171444397.png" alt="image-20220811171444397"></p>
<p><code>inet_ntoa</code>å‡½æ•°å°†æ•´æ•°çš„IPv4åœ°å€è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²çš„IPv4ã€‚æˆåŠŸæ—¶è¿”å›è½¬æ¢çš„å­—ç¬¦ä¸²åœ°å€å€¼ï¼Œå¤±è´¥æ—¶è¿”å›-1ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_aton %u \n&quot;</span>, ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip_str = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811173503409.png" alt="image-20220811173503409"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>inet_ntoa</code>å‡½æ•°å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªé™æ€å˜é‡å­˜å‚¨è½¬åŒ–çš„ç»“æœï¼Œå‡½æ•°çš„è¿”å›å€¼æŒ‡å‘è¯¥é™æ€å†…å­˜ï¼Œå› æ­¤<code>inet_ntoa</code>æ˜¯ä¸å¯é‡å…¥çš„ï¼Œè¿™ä¸€ç‚¹éœ€è¦å¤šæ³¨æ„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="type">char</span> *ip_str1 = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.15&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="type">char</span> *ip_str2 = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811180430697.png" alt="image-20220811180430697"></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸‹é¢ä¸¤ä¸ªå‡½æ•°ä¹Ÿèƒ½å®Œæˆå‰ä¸‰ä¸ªå‡½æ•°çš„åŠŸèƒ½</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Convert from presentation format of an Internet number in buffer</span></span><br><span class="line"><span class="comment">   starting at CP to the binary network format and store result for</span></span><br><span class="line"><span class="comment">   interface type AF in buffer starting at BUF.  */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">int</span> <span class="title">inet_pton</span> <span class="params">(<span class="type">int</span> __af, <span class="type">const</span> <span class="type">char</span> *__restrict __cp,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="type">void</span> *__restrict __buf)</span> __THROW</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert a Internet address in binary network format for interface</span></span><br><span class="line"><span class="comment">   type AF in buffer starting at CP to presentation form and place</span></span><br><span class="line"><span class="comment">   result in buffer of length LEN astarting at BUF.  */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span> *<span class="title">inet_ntop</span> <span class="params">(<span class="type">int</span> __af, <span class="type">const</span> <span class="type">void</span> *__restrict __cp,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">char</span> *__restrict __buf, <span class="type">socklen_t</span> __len)</span></span></span><br><span class="line"><span class="function">     __THROW</span>;</span><br></pre></td></tr></table></figure>
<p><code>inet_pton</code>å‡½æ•°å°†ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„Påœ°å€<code>__cp</code>ï¼ˆç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€æˆ–ç”¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv6åœ°å€ï¼‰è½¬æ¢æˆç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPåœ°å€ï¼Œå¹¶æŠŠè½¬æ¢ç»“æœå­˜å‚¨äº<code>__buf</code>æŒ‡å‘çš„å†…å­˜ä¸­ã€‚å…¶ä¸­ï¼Œ<code>__af</code>å‚æ•°æŒ‡å®šåœ°å€æ—ï¼Œå¯ä»¥æ˜¯<code>AF_INET</code>æˆ–è€…<code>AF_INET6</code>ã€‚<code>inet_pton</code>æˆåŠŸæ—¶è¿”å›1ï¼Œå¤±è´¥åˆ™è¿”å›0å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>__restrict</code>emmmç›®å‰æ‰¾ä¸åˆ°å®šä¹‰ï¼Œä½†æ˜¯çœ‹äº†ä¸‹<code>restrict</code>å…³é”®å­—ï¼Œæ˜¯æŒ‡å‘Šè¯‰ç¼–è¯‘å™¨ä¼ å…¥çš„ä¸¤ä¸ªæŒ‡é’ˆä¸æŒ‡å‘åŒä¸€æ•°æ®ï¼Œæ–¹ä¾¿è¿›è¡Œä¼˜åŒ–ç”¨æ¥æå‡æ€§èƒ½ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ip_str[] = <span class="string">&quot;192.168.167.42&quot;</span>;</span><br><span class="line">    <span class="type">in_addr_t</span> ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, ip);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> in_ip;</span><br><span class="line">    ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;in_ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, in_ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811183002035.png" alt="image-20220811183002035"></p>
<p><code>inet_ntop</code>å‡½æ•°è¿›è¡Œç›¸åçš„è½¬æ¢ï¼Œå‰ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ä¸<code>inet_pton</code>çš„å‚æ•°ç›¸åŒï¼Œæœ€åä¸€ä¸ªå‚æ•° <code>__len</code>æŒ‡å®šç›®æ ‡å­˜å‚¨å•å…ƒçš„å¤§å°ã€‚ä¸‹é¢çš„ä¸¤ä¸ªå®èƒ½å¸®åŠ©æˆ‘ä»¬æŒ‡å®šè¿™ä¸ªå¤§å°(åˆ†åˆ«ç”¨äºIPv4å’ŒIPv6):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span>	</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INET_ADDRSTRLEN 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INET6_ADDRSTRLEN 46</span></span><br></pre></td></tr></table></figure>
<p><code>inet_ntop</code>æˆåŠŸæ—¶è¿”å›ç›®æ ‡å­˜å‚¨å•å…ƒçš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å›NULLå¹¶è®¾ç½®errnoã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ip_str[] = <span class="string">&quot;192.168.167.42&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> in_ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;in_ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, in_ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ip_str2[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip_str3 = <span class="built_in">inet_ntop</span>(AF_INET, &amp;in_ip, ip_str2, <span class="built_in">sizeof</span>(ip_str2));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ip_str3 == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error \n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str2);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811220718920.png" alt="image-20220811220718920"></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>ip_str2</code>å’Œ<code>ip_str3</code>çš„åœ°å€ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼ç›¸åŒï¼Œè™½ç„¶ä¸çŸ¥é“ä¸ºå•¥è¿™æ ·è®¾è®¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811221357471.png" alt="image-20220811221357471"></p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨muduoç¼–å†™webserver</title>
    <url>/2023/02/13/Linux/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BAmuduo/%E4%BD%BF%E7%94%A8muduo%E7%BC%96%E5%86%99webserver/</url>
    <content><![CDATA[<h1 id="ä½¿ç”¨muduoç¼–å†™webserver"><a href="#ä½¿ç”¨muduoç¼–å†™webserver" class="headerlink" title="ä½¿ç”¨muduoç¼–å†™webserver"></a>ä½¿ç”¨muduoç¼–å†™webserver</h1><p>å› ä¸ºå­¦ä¹ äº†muduoåº“ï¼Œæƒ³é€šè¿‡muduoåº“å†™ä¸€ä¸ªwebserverä½œä¸ºé¡¹ç›®ï¼Œåœ¨muduoå’ŒtinyWebserverçš„åŸºç¡€ä¸Šæ”¹äº†ä¸€ä¸‹ï¼Œç®€å•çš„æŠŠä»–ä»¬èåˆäº†ä¸€ä¸‹ã€‚</p>
<span id="more"></span>
<h2 id="httpserver"><a href="#httpserver" class="headerlink" title="httpserver"></a>httpserver</h2><p>åœ¨muduoåŸæœ¬çš„httpserverçš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹é€ ï¼ŒåŠ å…¥ç®€å•çš„æ•°æ®åº“æ“ä½œçš„éƒ¨åˆ†ã€‚é’ˆå¯¹httpè¯·æ±‚å¤„ç†çš„é€»è¾‘éƒ¨åˆ†å°è£…åœ¨äº†<code>onHttpProcess</code>ä¸­ã€‚</p>
<p>HttpServer.h</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _HTTPSERVER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _HTTPSERVER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../net/TcpServer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../base/SqlConnectionPool.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> tinyMuduo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> net</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">HttpRequest</span>;</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">HttpResponse</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// A simple embeddable HTTP server designed for report status of a program.</span></span><br><span class="line">        <span class="comment">/// It is not a fully HTTP 1.1 compliant server, but provides minimum features</span></span><br><span class="line">        <span class="comment">/// that can communicate with HttpClient and Web browser.</span></span><br><span class="line">        <span class="comment">/// It is synchronous, just like Java Servlet.</span></span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">HttpServer</span> : boost::noncopyable</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">public</span>:</span><br><span class="line">            <span class="keyword">typedef</span> std::function&lt;<span class="type">void</span>(<span class="type">const</span> HttpRequest &amp;,</span><br><span class="line">                                       HttpResponse *)&gt;</span><br><span class="line">                HttpCallback;</span><br><span class="line">            <span class="built_in">HttpServer</span>(EventLoop *loop,</span><br><span class="line">                       <span class="type">const</span> InetAddress &amp;listenAddr,</span><br><span class="line">                       <span class="type">const</span> string &amp;name,</span><br><span class="line">                       <span class="type">const</span> string &amp;user,</span><br><span class="line">                       <span class="type">const</span> string &amp;passwd,</span><br><span class="line">                       <span class="type">const</span> string &amp;databaseName,</span><br><span class="line">                       <span class="type">int</span> sqlNum,</span><br><span class="line">                       TcpServer::Option option = TcpServer::kNoReusePort);</span><br><span class="line"></span><br><span class="line">            <span class="function">EventLoop *<span class="title">getLoop</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> server_.<span class="built_in">getLoop</span>(); &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/// Not thread safe, callback be registered before calling start().</span></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">setHttpCallback</span><span class="params">(<span class="type">const</span> HttpCallback &amp;cb)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                httpCallback_ = cb;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">setThreadNum</span><span class="params">(<span class="type">int</span> numThreads)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                server_.<span class="built_in">setThreadNum</span>(numThreads);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span>:</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Buffer *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Timestamp receiveTime)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">onRequest</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;, <span class="type">const</span> HttpRequest &amp;)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">onWriteComplete</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span>;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">initmysql</span><span class="params">(ConnectionPool *connPool)</span></span>;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">onHttpProcess</span><span class="params">(<span class="type">const</span> HttpRequest &amp;req, HttpResponse *resp)</span></span>;</span><br><span class="line">            TcpServer server_;</span><br><span class="line">            HttpCallback httpCallback_;</span><br><span class="line"></span><br><span class="line">            ConnectionPool *connPool_; <span class="comment">// æ•°æ®åº“ç›¸å…³</span></span><br><span class="line">            string user_;              <span class="comment">// ç™»é™†æ•°æ®åº“ç”¨æˆ·å</span></span><br><span class="line">            string passwd_;            <span class="comment">// ç™»é™†æ•°æ®åº“å¯†ç </span></span><br><span class="line">            string databaseName_;      <span class="comment">// ä½¿ç”¨æ•°æ®åº“å</span></span><br><span class="line">            <span class="type">int</span> sqlNum_;</span><br><span class="line">            map&lt;string, string&gt; users;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="comment">// namespace net</span></span><br><span class="line">&#125; <span class="comment">// namespace tinyMuduo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _HTTPSERVER_H</span></span></span><br></pre></td></tr></table></figure>
<p>HttpServer.cpp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../net/http/HttpServer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../base/Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../net/http/HttpContext.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../net/http/HttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../net/http/HttpResponse.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tinyMuduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tinyMuduo::net;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> tinyMuduo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> net</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">namespace</span> detail</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">defaultHttpCallback</span><span class="params">(<span class="type">const</span> HttpRequest &amp;, HttpResponse *resp)</span></span></span><br><span class="line"><span class="function">            </span>&#123;</span><br><span class="line">                resp-&gt;<span class="built_in">setStatusCode</span>(HttpResponse::k404NotFound);</span><br><span class="line">                resp-&gt;<span class="built_in">setStatusMessage</span>(<span class="string">&quot;Not Found&quot;</span>);</span><br><span class="line">                resp-&gt;<span class="built_in">setCloseConnection</span>(<span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="comment">// namespace detail</span></span><br><span class="line">    &#125;     <span class="comment">// namespace net</span></span><br><span class="line">&#125; <span class="comment">// namespace tinyMuduo</span></span><br><span class="line"></span><br><span class="line">HttpServer::<span class="built_in">HttpServer</span>(EventLoop *loop,</span><br><span class="line">                       <span class="type">const</span> InetAddress &amp;listenAddr,</span><br><span class="line">                       <span class="type">const</span> string &amp;name,</span><br><span class="line">                       <span class="type">const</span> string &amp;user,</span><br><span class="line">                       <span class="type">const</span> string &amp;passwd,</span><br><span class="line">                       <span class="type">const</span> string &amp;databaseName,</span><br><span class="line">                       <span class="type">int</span> sqlNum,</span><br><span class="line">                       TcpServer::Option option)</span><br><span class="line">    : <span class="built_in">server_</span>(loop, listenAddr, name, option), <span class="built_in">user_</span>(user), <span class="built_in">passwd_</span>(passwd), <span class="built_in">databaseName_</span>(databaseName), <span class="built_in">sqlNum_</span>(sqlNum)</span><br><span class="line">&#123;</span><br><span class="line">    server_.<span class="built_in">setConnectionCallback</span>(</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;HttpServer::onConnection, <span class="keyword">this</span>, _1));</span><br><span class="line">    server_.<span class="built_in">setMessageCallback</span>(</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;HttpServer::onMessage, <span class="keyword">this</span>, _1, _2, _3));</span><br><span class="line">    server_.<span class="built_in">setWriteCompleteCallback</span>(</span><br><span class="line">        std::<span class="built_in">bind</span>(&amp;HttpServer::onWriteComplete, <span class="keyword">this</span>, _1));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>-&gt;<span class="built_in">setHttpCallback</span>(std::<span class="built_in">bind</span>(&amp;HttpServer::onHttpProcess, <span class="keyword">this</span>, _1, _2));</span><br><span class="line">    <span class="comment">// user_ = &quot;root&quot;;</span></span><br><span class="line">    <span class="comment">// passwd_ = &quot;123456&quot;;</span></span><br><span class="line">    <span class="comment">// databaseName_ = &quot;yourdb&quot;;</span></span><br><span class="line">    <span class="comment">// sqlNum_ = 8;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief åˆå§‹åŒ–æ•°æ®åº“</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param connPool</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::initmysql</span><span class="params">(ConnectionPool *connPool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å…ˆä»è¿æ¥æ± ä¸­å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">    MYSQL *mysql = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="function">tinyMuduo::ConnectionRAII <span class="title">mysqlcon</span><span class="params">(&amp;mysql, connPool)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨userè¡¨ä¸­æ£€ç´¢usernameï¼Œpasswdæ•°æ®ï¼Œæµè§ˆå™¨ç«¯è¾“å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(mysql, <span class="string">&quot;SELECT username,passwd FROM user&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="string">&quot;SELECT error: &quot;</span> &lt;&lt; <span class="built_in">mysql_error</span>(mysql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»è¡¨ä¸­æ£€ç´¢å®Œæ•´çš„ç»“æœé›†</span></span><br><span class="line">    MYSQL_RES *result = <span class="built_in">mysql_store_result</span>(mysql);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç»“æœé›†ä¸­çš„åˆ—æ•°</span></span><br><span class="line">    <span class="type">int</span> num_fields = <span class="built_in">mysql_num_fields</span>(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ‰€æœ‰å­—æ®µç»“æ„çš„æ•°ç»„</span></span><br><span class="line">    MYSQL_FIELD *fields = <span class="built_in">mysql_fetch_fields</span>(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»ç»“æœé›†ä¸­è·å–ä¸‹ä¸€è¡Œï¼Œå°†å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå­˜å…¥mapä¸­</span></span><br><span class="line">    <span class="keyword">while</span> (MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(result))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">string <span class="title">temp1</span><span class="params">(row[<span class="number">0</span>])</span></span>;</span><br><span class="line">        <span class="function">string <span class="title">temp2</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">        users[temp1] = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::start</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOG_WARN &lt;&lt; <span class="string">&quot;HttpServer[&quot;</span> &lt;&lt; server_.<span class="built_in">name</span>()</span><br><span class="line">             &lt;&lt; <span class="string">&quot;] starts listening on &quot;</span> &lt;&lt; server_.<span class="built_in">ipPort</span>();</span><br><span class="line">    server_.<span class="built_in">start</span>();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± </span></span><br><span class="line">    connPool_ = ConnectionPool::<span class="built_in">getInstance</span>();</span><br><span class="line">    connPool_-&gt;<span class="built_in">init</span>(<span class="string">&quot;127.0.0.1&quot;</span>, user_, passwd_, databaseName_, <span class="number">3306</span>, sqlNum_);</span><br><span class="line">    <span class="built_in">initmysql</span>(connPool_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;<span class="built_in">connected</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;<span class="built_in">setContext</span>(<span class="built_in">HttpContext</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Buffer *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Timestamp receiveTime)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HttpContext *context = boost::<span class="built_in">any_cast</span>&lt;HttpContext&gt;(conn-&gt;<span class="built_in">getMutableContext</span>());</span><br><span class="line">    <span class="comment">// LOG_INFO &lt;&lt; buf-&gt;toStringPiece();</span></span><br><span class="line">    <span class="keyword">if</span> (!context-&gt;<span class="built_in">parseRequest</span>(buf, receiveTime))</span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(<span class="string">&quot;HTTP/1.1 400 Bad Request\r\n\r\n&quot;</span>);</span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;<span class="built_in">gotAll</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">onRequest</span>(conn, context-&gt;<span class="built_in">request</span>());</span><br><span class="line">        context-&gt;<span class="built_in">reset</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::onRequest</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn, <span class="type">const</span> HttpRequest &amp;req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">const</span> string &amp;connection = req.<span class="built_in">getHeader</span>(<span class="string">&quot;Connection&quot;</span>);</span><br><span class="line">    <span class="type">bool</span> close = connection == <span class="string">&quot;close&quot;</span> ||</span><br><span class="line">                 (req.<span class="built_in">getVersion</span>() == HttpRequest::kHttp10 &amp;&amp; connection != <span class="string">&quot;Keep-Alive&quot;</span>);</span><br><span class="line">    <span class="function">HttpResponse <span class="title">response</span><span class="params">(close)</span></span>;</span><br><span class="line">    <span class="built_in">httpCallback_</span>(req, &amp;response);</span><br><span class="line">    Buffer buf;</span><br><span class="line">    response.<span class="built_in">appendToBuffer</span>(&amp;buf);</span><br><span class="line">    conn-&gt;<span class="built_in">send</span>(&amp;buf);</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *file = response.g_file.<span class="built_in">c_str</span>();</span><br><span class="line">    FILE *fp = ::<span class="built_in">fopen</span>(file, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">TcpConnection::FilePtr <span class="title">ctx</span><span class="params">(fp, ::fclose)</span></span>;</span><br><span class="line">        <span class="comment">// conn-&gt;setContext(ctx);</span></span><br><span class="line">        conn-&gt;filePtr_.<span class="built_in">swap</span>(ctx);</span><br><span class="line">        <span class="type">char</span> buf[TcpConnection::kBufSize];</span><br><span class="line">        <span class="type">size_t</span> nread = ::<span class="built_in">fread</span>(buf, <span class="number">1</span>, <span class="keyword">sizeof</span> buf, fp);</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(buf, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(nread));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; file &lt;&lt; <span class="string">&quot; no such file&quot;</span>;</span><br><span class="line">        conn-&gt;<span class="built_in">shutdown</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::onWriteComplete</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;conn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[TcpConnection::kBufSize];</span><br><span class="line">    <span class="type">size_t</span> nread = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (conn-&gt;filePtr_)</span><br><span class="line">        nread = ::<span class="built_in">fread</span>(buf, <span class="number">1</span>, <span class="keyword">sizeof</span> buf, <span class="built_in">get_pointer</span>(conn-&gt;filePtr_));</span><br><span class="line">    <span class="keyword">if</span> (nread &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;<span class="built_in">send</span>(buf, <span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(nread));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        conn-&gt;filePtr_.<span class="built_in">reset</span>();</span><br><span class="line">        LOG_INFO &lt;&lt; <span class="string">&quot;FileServer - done&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å¯¹httpæ¶ˆæ¯è¿›è¡Œå¤„ç†çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param req</span></span><br><span class="line"><span class="comment"> * @param resp</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HttpServer::onHttpProcess</span><span class="params">(<span class="type">const</span> HttpRequest &amp;req, HttpResponse *resp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LOG_INFO &lt;&lt; <span class="string">&quot;Headers &quot;</span> &lt;&lt; req.<span class="built_in">methodString</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; req.<span class="built_in">path</span>();</span><br><span class="line"></span><br><span class="line">    std::string file;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="built_in">body</span>().<span class="built_in">empty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *bodyStr = req.<span class="built_in">body</span>().<span class="built_in">c_str</span>();</span><br><span class="line">        <span class="comment">// å°†ç”¨æˆ·åå’Œå¯†ç æå–å‡ºæ¥</span></span><br><span class="line">        <span class="comment">// user=123&amp;passwd=123</span></span><br><span class="line">        <span class="type">char</span> name[<span class="number">100</span>], password[<span class="number">100</span>];</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">5</span>; bodyStr[i] != <span class="string">&#x27;&amp;&#x27;</span>; ++i)</span><br><span class="line">            name[i - <span class="number">5</span>] = bodyStr[i];</span><br><span class="line">        name[i - <span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (i = i + <span class="number">10</span>; bodyStr[i] != <span class="string">&#x27;\0&#x27;</span>; ++i, ++j)</span><br><span class="line">            password[j] = bodyStr[i];</span><br><span class="line">        password[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/3CGISQL.cgi&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºæ³¨å†Œ</span></span><br><span class="line">            <span class="keyword">if</span> (users.<span class="built_in">count</span>(name))</span><br><span class="line">            &#123;</span><br><span class="line">                file.<span class="built_in">append</span>(<span class="string">&quot;resources/registerError.html&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœæ˜¯æ³¨å†Œï¼Œå…ˆæ£€æµ‹æ•°æ®åº“ä¸­æ˜¯å¦æœ‰é‡åçš„</span></span><br><span class="line">                <span class="comment">// æ²¡æœ‰é‡åçš„ï¼Œè¿›è¡Œå¢åŠ æ•°æ®</span></span><br><span class="line">                <span class="type">char</span> *sql_insert = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">                <span class="built_in">strcpy</span>(sql_insert, <span class="string">&quot;INSERT INTO user(username, passwd) VALUES(&quot;</span>);</span><br><span class="line">                <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                <span class="built_in">strcat</span>(sql_insert, name);</span><br><span class="line">                <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;, &#x27;&quot;</span>);</span><br><span class="line">                <span class="built_in">strcat</span>(sql_insert, password);</span><br><span class="line">                <span class="built_in">strcat</span>(sql_insert, <span class="string">&quot;&#x27;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// å…ˆä»è¿æ¥æ± ä¸­å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">                MYSQL *mysql = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="function">ConnectionRAII <span class="title">mysqlcon</span><span class="params">(&amp;mysql, connPool_)</span></span>;</span><br><span class="line">                <span class="comment">// æ­¤å¤„æ„Ÿè§‰éœ€è¦é”ä¸€ä¸‹</span></span><br><span class="line">                <span class="type">int</span> res = <span class="built_in">mysql_query</span>(mysql, sql_insert);</span><br><span class="line">                <span class="keyword">if</span> (!res)</span><br><span class="line">                &#123;</span><br><span class="line">                    users[name] = password;</span><br><span class="line">                    file.<span class="built_in">append</span>(<span class="string">&quot;resources/login.html&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    file.<span class="built_in">append</span>(<span class="string">&quot;resources/registerError.html&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/2CGISQL.cgi&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºç™»å½•</span></span><br><span class="line">            <span class="keyword">if</span> (users.<span class="built_in">count</span>(name) &amp;&amp; users[name] == password)</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                file.<span class="built_in">append</span>(<span class="string">&quot;resources/welcome.html&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                file.<span class="built_in">append</span>(<span class="string">&quot;resources/logError.html&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/0&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/register.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/1&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/login.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/5&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/picture.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/6&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/video.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/7&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/fans.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.<span class="built_in">path</span>() == <span class="string">&quot;/404&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/404.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// strcpy(file, &quot;resources&quot;);</span></span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources&quot;</span>);</span><br><span class="line">        <span class="comment">// int len = strlen(file);</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *url_real = req.<span class="built_in">path</span>().<span class="built_in">c_str</span>();</span><br><span class="line">        file.<span class="built_in">append</span>(url_real);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> fileStat;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(file.<span class="built_in">c_str</span>(), &amp;fileStat) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_INFO &lt;&lt; file &lt;&lt; <span class="string">&quot; no such file&quot;</span>;</span><br><span class="line">        file.<span class="built_in">clear</span>();</span><br><span class="line">        file.<span class="built_in">append</span>(<span class="string">&quot;resources/404.html&quot;</span>);</span><br><span class="line">        <span class="built_in">stat</span>(file.<span class="built_in">c_str</span>(), &amp;fileStat);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (!(fileStat.st_mode &amp; S_IROTH))</span></span><br><span class="line">    <span class="comment">//   return;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (S_ISDIR(fileStat.st_mode))</span></span><br><span class="line">    <span class="comment">//   return;</span></span><br><span class="line"></span><br><span class="line">    resp-&gt;<span class="built_in">setStatusCode</span>(HttpResponse::k200Ok);</span><br><span class="line">    resp-&gt;<span class="built_in">setStatusMessage</span>(<span class="string">&quot;OK&quot;</span>);</span><br><span class="line">    resp-&gt;<span class="built_in">addHeader</span>(<span class="string">&quot;Server&quot;</span>, <span class="string">&quot;tinyMuduo&quot;</span>);</span><br><span class="line">    resp-&gt;<span class="built_in">setContentLength</span>(fileStat.st_size);</span><br><span class="line">    resp-&gt;<span class="built_in">setFile</span>(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡è¦çš„ä¸œè¥¿æ˜¯<code>onHttpProcess</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å¤„ç†httpè¯·æ±‚çš„é€»è¾‘ã€‚å…¶æ¬¡æˆ‘è§‰å¾—é‡è¦çš„æ˜¯<code>onRequest</code>ä¸­å‘é€æ–‡ä»¶ï¼Œå› ä¸ºå›¾ç‰‡ã€htmlé¡µé¢ç­‰æ–‡ä»¶å¤ªå¤§ï¼Œæ‰€ä»¥ä¸€æ¬¡å‘å¯èƒ½è£…ä¸ä¸‹ï¼Œæ‰€ä»¥è¿™é‡Œå‚è€ƒäº†muduoä¸­ftpçš„å®ç°ï¼Œåœ¨<code>onRequest</code>ä¸­å‘é€ä¸€æ¬¡æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å‘é€å®Œä¼šåœ¨<code>onWriteComplete</code>ä¸­æ¥ç€å‘é€ã€‚</p>
<h2 id="SqlConnectionPool"><a href="#SqlConnectionPool" class="headerlink" title="SqlConnectionPool"></a>SqlConnectionPool</h2><p>å› ä¸ºæ¶‰åŠè¿æ¥æ•°æ®åº“ï¼Œç®€å•å°†tinyWEbserveré‡Œé¢çš„æ•°æ®åº“æ± æ¬äº†è¿‡æ¥ã€‚</p>
<p>SqlConnectionPool.h</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _SQLCONNECTIONPOOL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SQLCONNECTIONPOOL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;error.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mutex&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;condition_variable&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> tinyMuduo</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ConnectionPool</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">MYSQL *<span class="title">getConnection</span><span class="params">()</span></span>;              <span class="comment">// è·å–æ•°æ®åº“è¿æ¥</span></span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">releaseConnection</span><span class="params">(MYSQL *conn)</span></span>; <span class="comment">// é‡Šæ”¾è¿æ¥</span></span><br><span class="line">        <span class="function"><span class="type">int</span> <span class="title">getFreeConn</span><span class="params">()</span></span>;                   <span class="comment">// è·å–è¿æ¥</span></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">destroyPool</span><span class="params">()</span></span>;                  <span class="comment">// é”€æ¯æ‰€æœ‰è¿æ¥</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å•ä¾‹æ¨¡å¼</span></span><br><span class="line">        <span class="function"><span class="type">static</span> ConnectionPool *<span class="title">getInstance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(string url, string User, string PassWord, string DataBaseName, <span class="type">int</span> Port, <span class="type">int</span> MaxConn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="built_in">ConnectionPool</span>();</span><br><span class="line">        ~<span class="built_in">ConnectionPool</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> maxConn_;          <span class="comment">// æœ€å¤§è¿æ¥æ•°</span></span><br><span class="line">        <span class="type">int</span> curConn_;          <span class="comment">// å½“å‰å·²ä½¿ç”¨çš„è¿æ¥æ•°</span></span><br><span class="line">        <span class="type">int</span> freeConn_;         <span class="comment">// å½“å‰ç©ºé—²çš„è¿æ¥æ•°</span></span><br><span class="line">        list&lt;MYSQL *&gt; connList; <span class="comment">// è¿æ¥æ± </span></span><br><span class="line">        std::mutex mutex_;</span><br><span class="line">        std::condition_variable condition_;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        string url_;          <span class="comment">// ä¸»æœºåœ°å€</span></span><br><span class="line">        string port_;         <span class="comment">// æ•°æ®åº“ç«¯å£å·</span></span><br><span class="line">        string user_;         <span class="comment">// ç™»é™†æ•°æ®åº“ç”¨æˆ·å</span></span><br><span class="line">        string passwd_;     <span class="comment">// ç™»é™†æ•°æ®åº“å¯†ç </span></span><br><span class="line">        string databaseName_; <span class="comment">// ä½¿ç”¨æ•°æ®åº“å</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ConnectionRAII</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="built_in">ConnectionRAII</span>(MYSQL **con, ConnectionPool *connPool);</span><br><span class="line">        ~<span class="built_in">ConnectionRAII</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        MYSQL *conRAII_;</span><br><span class="line">        ConnectionPool *poolRAII_;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _SQLCONNECTIONPOOL_H</span></span></span><br></pre></td></tr></table></figure>
<p>SqlConnectionPool.cpp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mysql/mysql.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;list&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;SqlConnectionPool.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> tinyMuduo</span><br><span class="line">&#123;</span><br><span class="line">    ConnectionPool::<span class="built_in">ConnectionPool</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        curConn_ = <span class="number">0</span>;</span><br><span class="line">        freeConn_ = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">ConnectionPool *<span class="title">ConnectionPool::getInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="type">static</span> ConnectionPool connPool;</span><br><span class="line">        <span class="keyword">return</span> &amp;connPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ åˆå§‹åŒ–</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ConnectionPool::init</span><span class="params">(string url, string User, string PassWord, string DBName, <span class="type">int</span> Port, <span class="type">int</span> MaxConn)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        url_ = url;</span><br><span class="line">        port_ = Port;</span><br><span class="line">        user_ = User;</span><br><span class="line">        passwd_ = PassWord;</span><br><span class="line">        databaseName_ = DBName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; MaxConn; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            MYSQL *con = <span class="literal">NULL</span>;</span><br><span class="line">            con = <span class="built_in">mysql_init</span>(con);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (con == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LOG_ERROR &lt;&lt; <span class="string">&quot;MySQL Error&quot;</span>;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            con = <span class="built_in">mysql_real_connect</span>(con, url.<span class="built_in">c_str</span>(), User.<span class="built_in">c_str</span>(), PassWord.<span class="built_in">c_str</span>(), DBName.<span class="built_in">c_str</span>(), Port, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (con == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                LOG_ERROR &lt;&lt; <span class="string">&quot;MySQL Error&quot;</span>;</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            connList.<span class="built_in">push_back</span>(con);</span><br><span class="line">            ++freeConn_;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        maxConn_ = freeConn_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“æœ‰è¯·æ±‚æ—¶ï¼Œä»æ•°æ®åº“è¿æ¥æ± ä¸­è¿”å›ä¸€ä¸ªå¯ç”¨è¿æ¥ï¼Œæ›´æ–°ä½¿ç”¨å’Œç©ºé—²è¿æ¥æ•°</span></span><br><span class="line">    <span class="function">MYSQL *<span class="title">ConnectionPool::getConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        MYSQL *con = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> == connList.<span class="built_in">size</span>())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">        con = connList.<span class="built_in">front</span>();</span><br><span class="line">        connList.<span class="built_in">pop_front</span>();</span><br><span class="line"></span><br><span class="line">        --freeConn_;</span><br><span class="line">        ++curConn_;</span><br><span class="line">        <span class="keyword">while</span> (freeConn_ &lt;= <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* code */</span></span><br><span class="line">            condition_.<span class="built_in">wait</span>(lk);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> con;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾å½“å‰ä½¿ç”¨çš„è¿æ¥</span></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">ConnectionPool::releaseConnection</span><span class="params">(MYSQL *con)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">NULL</span> == con)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lk</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">        connList.<span class="built_in">push_back</span>(con);</span><br><span class="line">        ++freeConn_;</span><br><span class="line">        --curConn_;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// condition_.wait(lk);</span></span><br><span class="line">        <span class="keyword">if</span> (freeConn_ &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            condition_.<span class="built_in">notify_all</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯æ•°æ®åº“è¿æ¥æ± </span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">ConnectionPool::destroyPool</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function">std::lock_guard&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(mutex_)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (connList.<span class="built_in">size</span>() &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            list&lt;MYSQL *&gt;::iterator it;</span><br><span class="line">            <span class="keyword">for</span> (it = connList.<span class="built_in">begin</span>(); it != connList.<span class="built_in">end</span>(); ++it)</span><br><span class="line">            &#123;</span><br><span class="line">                MYSQL *con = *it;</span><br><span class="line">                <span class="built_in">mysql_close</span>(con);</span><br><span class="line">            &#125;</span><br><span class="line">            curConn_ = <span class="number">0</span>;</span><br><span class="line">            freeConn_ = <span class="number">0</span>;</span><br><span class="line">            connList.<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“å‰ç©ºé—²çš„è¿æ¥æ•°</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">ConnectionPool::getFreeConn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;freeConn_;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConnectionPool::~<span class="built_in">ConnectionPool</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">destroyPool</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConnectionRAII::<span class="built_in">ConnectionRAII</span>(MYSQL **SQL, ConnectionPool *connPool)</span><br><span class="line">    &#123;</span><br><span class="line">        *SQL = connPool-&gt;<span class="built_in">getConnection</span>();</span><br><span class="line"></span><br><span class="line">        conRAII_ = *SQL;</span><br><span class="line">        poolRAII_ = connPool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ConnectionRAII::~<span class="built_in">ConnectionRAII</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        poolRAII_-&gt;<span class="built_in">releaseConnection</span>(conRAII_);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="comment">// namespace tinyMuduo</span></span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•SqlConnectionPool_test.cpp</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;../../base/SqlConnectionPool.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// éœ€è¦ä¿®æ”¹çš„æ•°æ®åº“ä¿¡æ¯,ç™»å½•å,å¯†ç ,åº“å</span></span><br><span class="line">string user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">string passwd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">string databasename = <span class="string">&quot;yourdb&quot;</span>;</span><br><span class="line"></span><br><span class="line">map&lt;string, string&gt; users;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initmysqlResult</span><span class="params">(tinyMuduo::ConnectionPool *connPool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// å…ˆä»è¿æ¥æ± ä¸­å–ä¸€ä¸ªè¿æ¥</span></span><br><span class="line">    MYSQL *mysql = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="function">tinyMuduo::ConnectionRAII <span class="title">mysqlcon</span><span class="params">(&amp;mysql, connPool)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨userè¡¨ä¸­æ£€ç´¢usernameï¼Œpasswdæ•°æ®ï¼Œæµè§ˆå™¨ç«¯è¾“å…¥</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">mysql_query</span>(mysql, <span class="string">&quot;SELECT username,passwd FROM user&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        LOG_ERROR &lt;&lt; <span class="string">&quot;SELECT error: &quot;</span> &lt;&lt; <span class="built_in">mysql_error</span>(mysql);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»è¡¨ä¸­æ£€ç´¢å®Œæ•´çš„ç»“æœé›†</span></span><br><span class="line">    MYSQL_RES *result = <span class="built_in">mysql_store_result</span>(mysql);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›ç»“æœé›†ä¸­çš„åˆ—æ•°</span></span><br><span class="line">    <span class="type">int</span> num_fields = <span class="built_in">mysql_num_fields</span>(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›æ‰€æœ‰å­—æ®µç»“æ„çš„æ•°ç»„</span></span><br><span class="line">    MYSQL_FIELD *fields = <span class="built_in">mysql_fetch_fields</span>(result);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»ç»“æœé›†ä¸­è·å–ä¸‹ä¸€è¡Œï¼Œå°†å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œå­˜å…¥mapä¸­</span></span><br><span class="line">    <span class="keyword">while</span> (MYSQL_ROW row = <span class="built_in">mysql_fetch_row</span>(result))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">string <span class="title">temp1</span><span class="params">(row[<span class="number">0</span>])</span></span>;</span><br><span class="line">        <span class="function">string <span class="title">temp2</span><span class="params">(row[<span class="number">1</span>])</span></span>;</span><br><span class="line">        users[temp1] = temp2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¿æ¥æ± </span></span><br><span class="line">    tinyMuduo::ConnectionPool *connPool = tinyMuduo::ConnectionPool::<span class="built_in">getInstance</span>();</span><br><span class="line">    connPool-&gt;<span class="built_in">init</span>(<span class="string">&quot;127.0.0.1&quot;</span>, user, passwd, databasename, <span class="number">3306</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–æ•°æ®åº“è¯»å–è¡¨</span></span><br><span class="line">    <span class="built_in">initmysqlResult</span>(connPool);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> iter = users.<span class="built_in">begin</span>(); iter != users.<span class="built_in">end</span>(); iter++)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;username: &quot;</span> &lt;&lt; iter-&gt;first &lt;&lt; <span class="string">&quot; passwd: &quot;</span> &lt;&lt; iter-&gt;second &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mysqlæ˜¯ä½¿ç”¨dockerè¿›è¡Œå®‰è£…çš„ï¼Œè¿›å…¥dockeræŸ¥çœ‹ä¸€ä¸‹æ•°æ®</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230213144740181.png" alt="image-20230213144740181"></p>
<p>è¿è¡Œæµ‹è¯•</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230213144824101.png" alt="image-20230213144824101"></p>
<p>å¯ä»¥çœ‹åˆ°ç®€å•çš„è¿æ¥æ˜¯æˆåŠŸçš„</p>
<h2 id="main"><a href="#main" class="headerlink" title="main"></a>main</h2><p>mainé‡Œé¢å®ç°å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯éœ€è¦å†™å¥½æ•°æ®åº“ç›¸å…³çš„ä¿¡æ¯</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;base/Logging.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/EventLoop.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/http/HttpServer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/http/HttpRequest.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;net/http/HttpResponse.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tinyMuduo;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tinyMuduo::net;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éœ€è¦ä¿®æ”¹çš„æ•°æ®åº“ä¿¡æ¯,ç™»å½•å,å¯†ç ,åº“å</span></span><br><span class="line">  string user = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">  string passwd = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">  string databasename = <span class="string">&quot;yourdb&quot;</span>;</span><br><span class="line">  <span class="type">int</span> sqlNum = <span class="number">8</span>;</span><br><span class="line">  <span class="type">int</span> numThreads = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">  EventLoop loop;</span><br><span class="line">  <span class="function">HttpServer <span class="title">server</span><span class="params">(&amp;loop, InetAddress(<span class="number">8080</span>), <span class="string">&quot;webserver&quot;</span>, user, passwd, databasename, sqlNum)</span></span>;</span><br><span class="line">  server.<span class="built_in">setThreadNum</span>(numThreads);</span><br><span class="line">  server.<span class="built_in">start</span>();</span><br><span class="line">  loop.<span class="built_in">loop</span>();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="è¿è¡Œç»“æœ"><a href="#è¿è¡Œç»“æœ" class="headerlink" title="è¿è¡Œç»“æœ"></a>è¿è¡Œç»“æœ</h2><p>ç™»å½•ç•Œé¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230213151254186.png" alt="image-20230213151254186"></p>
<p>é€‰æ‹©ç•Œé¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230213151319812.png" alt="image-20230213151319812"></p>
<p>å…³æ³¨ç•Œé¢</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20230213151339389.png" alt="image-20230213151339389"></p>
<h2 id="æ„Ÿè°¢"><a href="#æ„Ÿè°¢" class="headerlink" title="æ„Ÿè°¢"></a>æ„Ÿè°¢</h2><p>æ„Ÿè°¢muduoçš„ä»“åº“å’ŒtinyWebserverä»“åº“</p>
<p>muduoï¼š<a href="https://github.com/chenshuo/muduo">https://github.com/chenshuo/muduo</a></p>
<p>tinyWebServer:<a href="https://github.com/qinguoyi/TinyWebServer">https://github.com/qinguoyi/TinyWebServer</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨muduoçš„åŸºç¡€ä¸Šæƒ³å†™ä¸ªwebserverå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ä»–httpçš„åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›å°±å¯ä»¥ã€‚</p>
<p>æœ€å¥½ä»£ç ä»“åº“ï¼š<a href="https://github.com/bugcat9/tinyMuduo">https://github.com/bugcat9/tinyMuduo</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>muduo</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤šè¿›ç¨‹ç¼–ç¨‹</title>
    <url>/2022/08/31/Linux/%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="å¤šè¿›ç¨‹ç¼–ç¨‹"><a href="#å¤šè¿›ç¨‹ç¼–ç¨‹" class="headerlink" title="å¤šè¿›ç¨‹ç¼–ç¨‹"></a>å¤šè¿›ç¨‹ç¼–ç¨‹</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬åä¸‰ç« å¤šè¿›ç¨‹ç¼–ç¨‹ï¼Œé‡Œé¢ä»‹ç»äº†å„ç§Linuxç¼–ç¨‹ä¸­å¤šè¿›ç¨‹ç¼–ç¨‹çš„å†…å®¹ï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚è¿™ä¸€ç¯‡ä¸»è¦è®°å½•Linuxä¸­ã€‚è¿™ä¸€ç« åˆ†ä¸ºforkç³»ç»Ÿè°ƒç”¨ã€execç³»åˆ—ç³»ç»Ÿè°ƒç”¨ã€å¤„ç†åƒµå°¸è¿›ç¨‹ã€ä¿¡å·é‡ã€å…±äº«å†…å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€IPCå‘½ä»¤ã€‚</p>
<span id="more"></span>
<h2 id="forkç³»ç»Ÿè°ƒç”¨"><a href="#forkç³»ç»Ÿè°ƒç”¨" class="headerlink" title="forkç³»ç»Ÿè°ƒç”¨"></a>forkç³»ç»Ÿè°ƒç”¨</h2><p>Linuxå½“ä½œåˆ›å»ºæ–°è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨æ˜¯fork</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fork</code>å‡½æ•°çš„æ¯æ¬¡è°ƒç”¨éƒ½è¿”å›ä¸¤æ¬¡ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›çš„æ˜¯å­è¿›ç¨‹çš„<code>PID</code>ï¼Œåœ¨å­è¿›ç¨‹ä¸­åˆ™è¿”å›0ã€‚è¯¥è¿”å›å€¼æ˜¯åç»­ä»£ç åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹çš„ä¾æ®ã€‚</p>
<p><code>fork</code>è°ƒç”¨å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>fork</code>å‡½æ•°æ·±å…¥èµ·æ¥éœ€è¦æ³¨æ„çš„ç‚¹æœ‰å¾ˆå¤šï¼Œä¹¦ä¸­ç»™äº†ä¸‰ä¸ªéœ€è¦æ³¨æ„çš„éƒ¨åˆ†ï¼š</p>
<ul>
<li><code>fork</code>å‡½æ•°å¤åˆ¶å½“å‰è¿›ç¨‹ï¼Œåœ¨å†…æ ¸è¿›ç¨‹è¡¨ä¸­åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„</strong>è¿›ç¨‹è¡¨é¡¹ã€‚æ–°çš„è¿›ç¨‹è¡¨é¡¹æœ‰å¾ˆå¤šå±æ€§å’ŒåŸè¿›ç¨‹ç›¸åŒï¼Œæ¯”å¦‚å †æŒ‡é’ˆã€æ ˆæŒ‡é’ˆå’Œæ ‡å¿—å¯„å­˜å™¨çš„å€¼ã€‚ä½†ä¹Ÿæœ‰è®¸å¤šå±æ€§è¢«èµ‹äºˆäº†æ–°çš„å€¼ï¼Œæ¯”å¦‚è¯¥è¿›ç¨‹çš„<code>PPID</code>è¢«è®¾ç½®æˆåŸè¿›ç¨‹çš„<code>PID</code>ï¼Œ<strong>ä¿¡å·ä½å›¾è¢«æ¸…é™¤</strong>ï¼ˆåŸè¿›ç¨‹è®¾ç½®çš„ä¿¡å·å¤„ç†å‡½æ•°ä¸å†å¯¹æ–°è¿›ç¨‹èµ·ä½œç”¨)ã€‚</li>
<li>å­è¿›ç¨‹çš„ä»£ç ä¸çˆ¶è¿›ç¨‹å®Œå…¨<strong>ç›¸åŒ</strong>ï¼ŒåŒæ—¶å®ƒè¿˜ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼ˆå †æ•°æ®ã€æ ˆæ•°æ®å’Œé™æ€æ•°æ®)ã€‚æ•°æ®çš„å¤åˆ¶é‡‡ç”¨çš„æ˜¯æ‰€è°“çš„<strong>å†™æ—¶å¤åˆ¶</strong>(copy on writte)ï¼Œå³åªæœ‰åœ¨ä»»ä¸€è¿›ç¨‹(çˆ¶è¿›ç¨‹æˆ–å­è¿›ç¨‹ï¼‰å¯¹æ•°æ®æ‰§è¡Œäº†<strong>å†™æ“ä½œæ—¶</strong>ï¼Œå¤åˆ¶æ‰ä¼šå‘ç”Ÿï¼ˆå…ˆæ˜¯ç¼ºé¡µä¸­æ–­ï¼Œç„¶åæ“ä½œç³»ç»Ÿç»™å­è¿›ç¨‹åˆ†é…å†…å­˜å¹¶å¤åˆ¶çˆ¶è¿›ç¨‹çš„æ•°æ®)ã€‚å³ä¾¿å¦‚æ­¤ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç¨‹åºä¸­åˆ†é…äº†å¤§é‡å†…å­˜ï¼Œé‚£ä¹ˆä½¿ç”¨<code>fork</code>æ—¶ä¹Ÿåº”å½“ååˆ†è°¨æ…ï¼Œå°½é‡é¿å…æ²¡å¿…è¦çš„å†…å­˜åˆ†é…å’Œæ•°æ®å¤åˆ¶ã€‚</li>
<li>åˆ›å»ºå­è¿›ç¨‹åï¼Œçˆ¶è¿›ç¨‹ä¸­æ‰“å¼€çš„<strong>æ–‡ä»¶æè¿°ç¬¦</strong>é»˜è®¤åœ¨å­è¿›ç¨‹ä¸­ä¹Ÿæ˜¯æ‰“å¼€çš„ï¼Œä¸”æ–‡ä»¶æè¿°ç¬¦çš„å¼•ç”¨è®¡æ•°åŠ 1ã€‚ä¸ä»…å¦‚æ­¤ï¼Œçˆ¶è¿›ç¨‹çš„ç”¨æˆ·æ ¹ç›®å½•ã€å½“å‰å·¥ä½œç›®å½•ç­‰å˜é‡çš„å¼•ç”¨è®¡æ•°å‡ä¼šåŠ 1ã€‚</li>
</ul>
<p>å†™ä¸ªç®€å•çš„å°ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I&#x27;m parent pid = %d, parentID = %d\n&quot;</span>, getpid(), getppid());</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child  pid = %d, parentID=%d\n&quot;</span>, getpid(), getppid());</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220902104536913.png" alt="image-20220902104536913"></p>
<h2 id="execç³»åˆ—ç³»ç»Ÿè°ƒç”¨"><a href="#execç³»åˆ—ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="execç³»åˆ—ç³»ç»Ÿè°ƒç”¨"></a>execç³»åˆ—ç³»ç»Ÿè°ƒç”¨</h2><p>æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨å­è¿›ç¨‹ä¸­<strong>æ‰§è¡Œå…¶ä»–ç¨‹åº</strong>ï¼Œå³æ›¿æ¢å½“å‰è¿›ç¨‹æ˜ åƒï¼Œè¿™å°±éœ€è¦ä½¿ç”¨å¦‚ä¸‹execç³»åˆ—å‡½æ•°ä¹‹ä¸€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...<span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">const</span> <span class="type">char</span> *arg, ...<span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...<span class="comment">/*, (char *) NULL, char *const envp[] */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvpe</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[], <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure>
<p><code>path</code>å‚æ•°æŒ‡å®šå¯æ‰§è¡Œæ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œ<code>file</code>å‚æ•°å¯ä»¥æ¥å—æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶çš„å…·ä½“ä½ç½®åˆ™åœ¨ç¯å¢ƒå˜é‡<code>PATH</code>ä¸­æœå¯»ã€‚</p>
<p><code>arg</code>æ¥å—å¯å˜å‚æ•°ï¼Œ<code>argv</code>åˆ™æ¥å—å‚æ•°æ•°ç»„ï¼Œå®ƒä»¬éƒ½ä¼šè¢«ä¼ é€’ç»™æ–°ç¨‹åº(<code>path</code>æˆ–<code>file</code>æŒ‡å®šçš„ç¨‹åºï¼‰çš„<code>main</code>å‡½æ•°ã€‚<code>envp</code>å‚æ•°ç”¨äºè®¾ç½®æ–°ç¨‹åºçš„ç¯å¢ƒå˜é‡ã€‚å¦‚æœæœªè®¾ç½®å®ƒï¼Œåˆ™æ–°ç¨‹åºå°†ä½¿ç”¨ç”±å…¨å±€å˜é‡<code>environ</code>æŒ‡å®šçš„ç¯å¢ƒå˜é‡ã€‚</p>
<p>ä¸€èˆ¬<code>exec</code>å‡½æ•°æ˜¯ä¸è¿”å›çš„ï¼Œé™¤éå‡ºé”™ã€‚å®ƒå‡ºé”™æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚å¦‚æœæ²¡å‡ºé”™ï¼Œåˆ™åŸç¨‹åºä¸­<code>exec</code>è°ƒç”¨ä¹‹åçš„ä»£ç éƒ½ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºæ­¤æ—¶åŸç¨‹åºå·²ç»è¢«<code>exec</code>çš„å‚æ•°æŒ‡å®šçš„ç¨‹åºå®Œå…¨æ›¿æ¢ï¼ˆåŒ…æ‹¬ä»£ç å’Œæ•°æ®)ã€‚</p>
<p><code>exec</code>å‡½æ•°ä¸ä¼šå…³é—­åŸç¨‹åºæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œé™¤éè¯¥æ–‡ä»¶æè¿°ç¬¦è¢«è®¾ç½®äº†ç±»ä¼¼<code>SOCK_CLOEXEC</code>çš„å±æ€§ã€‚</p>
<p><code>exec</code>å‡½æ•°æ—ä¸€èˆ¬è§„å¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">l(list)       å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">p(path)       æœç´¢fileæ—¶ä½¿ç”¨ç¯å¢ƒå˜é‡</span><br><span class="line"></span><br><span class="line">v(vector)      ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ•°ç»„</span><br><span class="line"></span><br><span class="line">e(environment)    ä½¿ç”¨ç¯å¢ƒå˜é‡æ•°ç»„ï¼Œä¸é€‚ç”¨è¿›ç¨‹åŸæœ‰çš„ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®æ–°åŠ è½½ç¨‹åºè¿è¡Œçš„ç¯å¢ƒå˜é‡</span><br></pre></td></tr></table></figure>
<p>äº‹å®ä¸Šï¼Œåªæœ‰<code>execve</code>æ˜¯çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶ä»–5ä¸ªå‡½æ•°æœ€ç»ˆéƒ½è°ƒç”¨<code>execve</code>ï¼Œæ˜¯åº“å‡½æ•°ï¼Œæ‰€ä»¥<code>execve</code>åœ¨manæ‰‹å†Œç¬¬äºŒèŠ‚ï¼Œå…¶å®ƒå‡½æ•°åœ¨manæ‰‹å†Œç¬¬3èŠ‚ã€‚</p>
<p>å°æ —å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;========================\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *argvv[] = &#123;<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-F&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// execl(&quot;/bin/ls&quot;, &quot;ls&quot;, &quot;-l&quot;, &quot;-F&quot;, &quot;-a&quot;, NULL);</span></span><br><span class="line">        <span class="comment">// execv(&quot;/bin/ls&quot;, argvv);</span></span><br><span class="line">        execlp(<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;-F&quot;</span>, <span class="string">&quot;-a&quot;</span>, <span class="literal">NULL</span>); <span class="comment">// ä½¿ç”¨ç¯å¢ƒå˜é‡</span></span><br><span class="line"></span><br><span class="line">        perror(<span class="string">&quot;execlp&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220903203128588.png" alt="image-20220903203128588"></p>
<h2 id="å¤„ç†åƒµå°¸è¿›ç¨‹ï¼ˆå›æ”¶å­è¿›ç¨‹ï¼‰"><a href="#å¤„ç†åƒµå°¸è¿›ç¨‹ï¼ˆå›æ”¶å­è¿›ç¨‹ï¼‰" class="headerlink" title="å¤„ç†åƒµå°¸è¿›ç¨‹ï¼ˆå›æ”¶å­è¿›ç¨‹ï¼‰"></a>å¤„ç†åƒµå°¸è¿›ç¨‹ï¼ˆå›æ”¶å­è¿›ç¨‹ï¼‰</h2><p>å¯¹äºå¤šè¿›ç¨‹ç¨‹åºè€Œè¨€ï¼Œçˆ¶è¿›ç¨‹ä¸€èˆ¬éœ€è¦è·Ÿè¸ªå­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ã€‚å› æ­¤ï¼Œå½“å­è¿›ç¨‹ç»“æŸè¿è¡Œæ—¶ï¼Œå†…æ ¸ä¸ä¼šç«‹å³é‡Šæ”¾è¯¥è¿›ç¨‹çš„è¿›ç¨‹è¡¨è¡¨é¡¹ï¼Œä»¥æ»¡è¶³çˆ¶è¿›ç¨‹åç»­å¯¹è¯¥å­è¿›ç¨‹é€€å‡ºä¿¡æ¯çš„æŸ¥è¯¢ï¼ˆå¦‚æœçˆ¶è¿›ç¨‹è¿˜åœ¨è¿è¡Œ)ã€‚å› æ­¤æœ‰æ—¶å€™å­è¿›ç¨‹ä¼šäº§ç”Ÿä¸¤ç§ç‰¹æ®ŠçŠ¶æ€ï¼šå­¤å„¿è¿›ç¨‹å’Œåƒµå°¸è¿›ç¨‹ï¼ˆå¤§æ¦‚å°±è¿™ç§æ„æ€ï¼‰</p>
<p><strong>å­¤å„¿è¿›ç¨‹</strong>ï¼š<strong>çˆ¶è¿›ç¨‹é€€å‡º</strong>ï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ª<strong>å­è¿›ç¨‹è¿˜åœ¨è¿è¡Œ</strong>ï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢«<code>init</code>è¿›ç¨‹(è¿›ç¨‹å·ä¸º1)æ‰€æ”¶å…»ï¼Œå¹¶ç”±<code>init</code>è¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚ï¼ˆå­¤å„¿è¿›ç¨‹å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå±å®³ï¼Œå› ä¸º<code>init</code>è¿›ç¨‹ä¼šå¾ªç¯åœ°wait()å®ƒçš„å·²ç»é€€å‡ºçš„å­è¿›ç¨‹ï¼‰</p>
<p><strong>åƒµå°¸è¿›ç¨‹</strong>ï¼šä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœ<strong>å­è¿›ç¨‹é€€å‡º</strong>ï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨<code>wait</code>æˆ–<code>waitpid</code>è·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚</p>
<p><strong>å­¤å„¿è¿›ç¨‹</strong>ä¾‹å­:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am child, my parent pid = %d\n&quot;</span>, getppid());</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;I am parent, my pid is = %d\n&quot;</span>, getpid());</span><br><span class="line">        sleep(<span class="number">9</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;------------parent going to die------------\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹çš„çˆ¶è¿›ç¨‹é€€å‡ºåï¼Œå­è¿›ç¨‹çš„<code>ppid</code>å˜æˆäº†1ï¼ˆ<code>init</code>çš„<code>pid</code>ï¼‰,ä¹Ÿå°±æ˜¯è¯´å­è¿›ç¨‹è¢«<code>init</code>é¢†å…»äº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220903211841731.png" alt="image-20220903211841731"></p>
<p><strong>åƒµå°¸è¿›ç¨‹</strong>ä¾‹å­:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---child, my parent= %d, going to sleep 10s\n&quot;</span>, getppid());</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-------------child die--------------\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;I am parent, pid = %d, myson = %d\n&quot;</span>, getpid(), pid);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220903212739059.png" alt="image-20220903212739059"></p>
<p>å­è¿›ç¨‹å¤„äº<strong>åƒµå°¸æ€</strong>ä¼šå ç”¨å†…æ ¸èµ„æºï¼Œå†…æ ¸èµ„æºé•¿æœŸè¢«å ç”¨å¾—ä¸åˆ°é‡Šæ”¾æ˜¾ç„¶æ˜¯ä¸€ä»¶ä¸å¥½çš„äº‹æƒ…ã€‚æ‰€ä»¥çˆ¶è¿›ç¨‹éœ€è¦æ­£ç¡®çš„è¿›è¡Œè°ƒç”¨å¤„ç†å¥½å­è¿›ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *wstatus)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">waitpid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> *wstatus, <span class="type">int</span> options)</span>;</span><br></pre></td></tr></table></figure>
<p><code>wait</code>å‡½æ•°å°†<strong>é˜»å¡è¿›ç¨‹</strong>ï¼Œç›´åˆ°è¯¥è¿›ç¨‹çš„æŸä¸ªå­è¿›ç¨‹ç»“æŸè¿è¡Œä¸ºæ­¢ã€‚å®ƒè¿”å›ç»“æŸè¿è¡Œçš„å­è¿›ç¨‹<code>PID</code>ã€‚å¹¶å°†è¯¥å­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯å­˜å‚¨äº<code>wstatus</code>å‚æ•°æŒ‡å‘çš„å†…å­˜ä¸­ã€‚Linuxä¸­æœ‰å‡ ä¸ªå®æ¥å¸®åŠ©è§£é‡Šå­è¿›ç¨‹çš„é€€å‡ºçŠ¶æ€ä¿¡æ¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220903210213373.png" alt="image-20220903210213373"></p>
<p><code>wait</code>ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid, wpid;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line"></span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;---child, my id= %d, going to sleep 10s\n&quot;</span>, getpid());</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;-------------child die--------------\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">73</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// wpid = wait(NULL);          // ä¸å…³å¿ƒå­è¿›ç¨‹ç»“æŸåŸå› </span></span><br><span class="line">        wpid = wait(&amp;status); <span class="comment">// å¦‚æœå­è¿›ç¨‹æœªç»ˆæ­¢,çˆ¶è¿›ç¨‹é˜»å¡åœ¨è¿™ä¸ªå‡½æ•°ä¸Š</span></span><br><span class="line">        <span class="keyword">if</span> (wpid == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            perror(<span class="string">&quot;wait error&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">        &#123; <span class="comment">//ä¸ºçœŸ,è¯´æ˜å­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢.</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child exit with %d\n&quot;</span>, WEXITSTATUS(status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (WIFSIGNALED(status))</span><br><span class="line">        &#123; <span class="comment">//ä¸ºçœŸ,è¯´æ˜å­è¿›ç¨‹æ˜¯è¢«ä¿¡å·ç»ˆæ­¢.</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child kill with signal %d\n&quot;</span>, WTERMSIG(status));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;------------parent wait finish: %d\n&quot;</span>, wpid);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220903213718096.png" alt="image-20220903213718096"></p>
<p><code>wait</code>ä¼šé˜»å¡è¿›ç¨‹ï¼Œæ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æœåŠ¡å™¨æ‰€æœŸæœ›çš„ï¼Œè€Œ<code>waitpid</code>å‡½æ•°è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥è®¾ç½®éé˜»å¡ã€‚</p>
<p><code>waitpid</code>åªç­‰å¾…ç”±<code>pid</code>å‚æ•°æŒ‡å®šçš„å­è¿›ç¨‹ã€‚å¦‚æœ<code>pid</code>å–å€¼ä¸º-1ï¼Œé‚£ä¹ˆå®ƒå°±å’Œ waitå‡½æ•°ç›¸åŒï¼Œå³ç­‰å¾…<strong>ä»»æ„</strong>ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸã€‚</p>
<p><code>wstatus</code>å‚æ•°çš„å«ä¹‰å’Œ<code>wait</code>å‡½æ•°çš„<code>wstatus</code>å‚æ•°ç›¸åŒã€‚<code>options</code>å‚æ•°å¯ä»¥æ§åˆ¶<code>waitpid</code>å‡½æ•°çš„è¡Œä¸ºã€‚è¯¥å‚æ•°æœ€å¸¸ç”¨çš„å–å€¼æ˜¯<code>WNOHANG</code>ã€‚å½“<code>options</code>çš„å–å€¼æ˜¯<code>WNOHANG</code>æ—¶ï¼Œ<code>waitpid</code>è°ƒç”¨å°†æ˜¯éé˜»å¡çš„:å¦‚æœ<code>pid</code>æŒ‡å®šçš„ç›®æ ‡å­è¿›ç¨‹<strong>è¿˜æ²¡æœ‰ç»“æŸæˆ–æ„å¤–ç»ˆæ­¢</strong>ï¼Œåˆ™<code>waitpid</code>ç«‹å³è¿”å›0ï¼›å¦‚æœç›®æ ‡å­è¿›ç¨‹ç¡®å®æ­£å¸¸é€€å‡ºäº†ï¼Œåˆ™ <code>waitpid</code>è¿”å›è¯¥å­è¿›ç¨‹çš„<code>PID</code>ã€‚<code>waitpid</code>è°ƒç”¨å¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>Linuxåœ¨äº‹ä»¶<strong>å·²ç»å‘ç”Ÿçš„æƒ…å†µä¸‹</strong>æ‰§è¡Œéé˜»å¡è°ƒç”¨æ‰èƒ½æé«˜ç¨‹åºçš„æ•ˆç‡ã€‚å¯¹<code>waitpid</code>å‡½æ•°è€Œè¨€ï¼Œæˆ‘ä»¬æœ€å¥½åœ¨æŸä¸ªå­è¿›ç¨‹é€€å‡ºä¹‹åå†è°ƒç”¨å®ƒã€‚é‚£ä¹ˆçˆ¶è¿›ç¨‹ä»ä½•å¾—çŸ¥æŸä¸ªå­è¿›ç¨‹å·²ç»é€€å‡ºäº†å‘¢?è¿™æ­£æ˜¯<code>SIGCHLD</code>ä¿¡å·çš„ç”¨é€”ã€‚å½“ä¸€ä¸ªè¿›ç¨‹ç»“æŸæ—¶ï¼Œå®ƒå°†ç»™å…¶çˆ¶è¿›ç¨‹å‘é€ä¸€ä¸ª<code>SIGCHLD</code>ä¿¡å·ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨çˆ¶è¿›ç¨‹ä¸­æ•è·<code>SIGCHLD</code>ä¿¡å·ï¼Œå¹¶åœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­è°ƒç”¨<code>waitpid</code>å‡½æ•°ä»¥â€œå½»åº•ç»“æŸâ€ä¸€ä¸ªå­è¿›ç¨‹ã€‚</p>
<p><code>waitpid</code>ç®€å•å°ä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">handle_child</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">        &#123; <span class="comment">//ä¸ºçœŸ,è¯´æ˜å­è¿›ç¨‹æ­£å¸¸ç»ˆæ­¢.</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child exit with %d\n&quot;</span>, WEXITSTATUS(status));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (WIFSIGNALED(status))</span><br><span class="line">        &#123; <span class="comment">//ä¸ºçœŸ,è¯´æ˜å­è¿›ç¨‹æ˜¯è¢«ä¿¡å·ç»ˆæ­¢.</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;child kill with signal %d\n&quot;</span>, WTERMSIG(status));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child ID %d\n&quot;</span>, getpid());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">73</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">        <span class="keyword">struct</span> sigaction act;</span><br><span class="line">        act.sa_handler = handle_child;</span><br><span class="line">        act.sa_flags = <span class="number">0</span>;</span><br><span class="line">        sigemptyset(&amp;act.sa_mask); <span class="comment">//ä¸å±è”½ä»»ä½•ä¿¡å·</span></span><br><span class="line">        sigaction(SIGCHLD, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Parent ID %d\n&quot;</span>, getpid());</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        perror(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220905104308336.png" alt="image-20220905104308336"></p>
<h2 id="ä¿¡å·é‡"><a href="#ä¿¡å·é‡" class="headerlink" title="ä¿¡å·é‡"></a>ä¿¡å·é‡</h2><p>ä¿¡å·é‡ï¼ˆæ³¨æ„ä¸æ˜¯ä¿¡å·ï¼‰æ˜¯æ“ä½œç³»ç»Ÿï¼ˆå¹¶å‘ï¼‰é‡Œé¢çš„æ¦‚å¿µï¼Œè§£å†³çš„æ˜¯å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„åŒæ­¥é—®é¢˜ã€‚<code>Linux</code>ä¿¡å·é‡çš„APIéƒ½å®šä¹‰åœ¨<code>sys/sem.h</code>å¤´æ–‡ä»¶ä¸­ï¼Œä¸»è¦åŒ…å«3ä¸ªç³»ç»Ÿè°ƒç”¨:<code>semget,semopå’Œsemctl</code>ã€‚å®ƒä»¬éƒ½è¢«è®¾è®¡ä¸ºæ“ä½œä¸€ç»„ä¿¡å·é‡ï¼Œå³ä¿¡å·é‡é›†ï¼Œè€Œä¸æ˜¯å•ä¸ªä¿¡å·é‡ï¼Œå› æ­¤è¿™äº›æ¥å£çœ‹ä¸Šè¦å¤æ‚ä¸€ç‚¹ã€‚</p>
<h3 id="semget"><a href="#semget" class="headerlink" title="semget"></a>semget</h3><p><code>semget</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡å·é‡é›†ï¼Œæˆ–è€…è·å–ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ä¿¡å·é‡é›†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> nsems, <span class="type">int</span> semflg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>key</code>å‚æ•°æ˜¯ä¸€ä¸ªé”®å€¼ï¼Œç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå…¨å±€<strong>å”¯ä¸€</strong>çš„ä¿¡å·é‡é›†ã€‚è¦é€šè¿‡ä¿¡å·é‡é€šä¿¡çš„è¿›ç¨‹éœ€è¦ä½¿ç”¨ç›¸åŒçš„é”®å€¼æ¥åˆ›å»º/è·å–è¯¥ä¿¡å·é‡ã€‚</p>
<p><code>nsems</code>å‚æ•°æŒ‡å®šè¦åˆ›å»º/è·å–çš„ä¿¡å·é‡é›†ä¸­ä¿¡å·é‡çš„æ•°ç›®ã€‚å¦‚æœæ˜¯<strong>åˆ›å»º</strong>ä¿¡å·é‡ï¼Œåˆ™è¯¥å€¼å¿…é¡»è¢«æŒ‡å®šï¼›å¦‚æœæ˜¯<strong>è·å–</strong>å·²ç»å­˜åœ¨çš„ä¿¡å·é‡ï¼Œåˆ™å¯ä»¥æŠŠå®ƒè®¾ç½®ä¸º0ã€‚</p>
<p><code>semflg</code>å‚æ•°æŒ‡å®šä¿¡å·é‡çš„æ“ä½œç±»å‹ä»¥åŠæ“çºµæƒé™ã€‚</p>
<p><code>semget</code>æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ­£æ•´æ•°å€¼ï¼Œå®ƒæ˜¯ä¿¡å·é‡é›†çš„æ ‡è¯†ç¬¦ï¼›<code>semget</code>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>semget</code>ç”¨äºåˆ›å»ºä¿¡å·é‡é›†æ—¶ï¼Œå’Œå®ƒå…³è”çš„å†…æ ¸æ•°æ®ç»“æ„ä½“<code>semid_ds</code>å°†ä¼šè¢«åˆ›å»ºå¹¶åˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> &#123;</span></span><br><span class="line">   <span class="type">key_t</span>          __key; <span class="comment">/* Key supplied to semget(2) */</span></span><br><span class="line">   <span class="type">uid_t</span>          uid;   <span class="comment">/* Effective UID of owner */</span></span><br><span class="line">   <span class="type">gid_t</span>          gid;   <span class="comment">/* Effective GID of owner */</span></span><br><span class="line">   <span class="type">uid_t</span>          cuid;  <span class="comment">/* Effective UID of creator */</span></span><br><span class="line">   <span class="type">gid_t</span>          cgid;  <span class="comment">/* Effective GID of creator */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> mode;  <span class="comment">/* Permissions */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> __seq; <span class="comment">/* Sequence number */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">sem_perm</span>;</span>  <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">   <span class="type">time_t</span>          sem_otime; <span class="comment">/* Last semop time */</span></span><br><span class="line">   <span class="type">time_t</span>          sem_ctime; <span class="comment">/* Last change time */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">long</span>   sem_nsems; <span class="comment">/* No. of semaphores in set */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916110352739.png" alt="image-20220916110352739"></p>
<h3 id="semopç³»ç»Ÿè°ƒç”¨"><a href="#semopç³»ç»Ÿè°ƒç”¨" class="headerlink" title="semopç³»ç»Ÿè°ƒç”¨"></a>semopç³»ç»Ÿè°ƒç”¨</h3><p><code>semop</code>ç³»ç»Ÿè°ƒç”¨æ”¹å˜ä¿¡å·é‡çš„å€¼ï¼Œå³æ‰§è¡ŒPVæ“ä½œã€‚<code>semop</code>æ˜¯é€šè¿‡åœ¨åº•å±‚æ˜¯é€šè¿‡æ“ä½œä¸€äº›é‡è¦çš„å†…æ ¸å˜é‡ï¼Œå¦‚ï¼š<code>semval</code>ã€<code>semzcnt</code>ã€<code>semncnt</code>ã€<code>sempid</code>ï¼Œæ¥å®ç°PVåŠŸèƒ½</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">short</span>  semval;   <span class="comment">/* semaphore value */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>  semzcnt;  <span class="comment">/* # waiting for zero */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">short</span>  semncnt;  <span class="comment">/* # waiting for increase */</span></span><br><span class="line"><span class="type">pid_t</span>           sempid;   <span class="comment">/* PID of process that last</span></span><br></pre></td></tr></table></figure>
<p><code>semop</code>çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semop</span><span class="params">(<span class="type">int</span> semid, <span class="keyword">struct</span> sembuf *sops, <span class="type">size_t</span> nsops)</span>;</span><br></pre></td></tr></table></figure>
<p><code>semid</code>å‚æ•°æ˜¯ç”±<code>semget</code>è°ƒç”¨è¿”å›çš„ä¿¡å·é‡é›†æ ‡è¯†ç¬¦ï¼Œç”¨ä»¥æŒ‡å®šè¢«æ“ä½œçš„ç›®æ ‡ä¿¡å·é‡é›†ã€‚</p>
<p><code>sops</code>å‚æ•°æŒ‡å‘ä¸€ä¸ª<code>sembuf</code>ç»“æ„ä½“ç±»å‹çš„æ•°ç»„ï¼Œ<code>sembuf</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Structure used for argument to `semop&#x27; to describe operations.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> sem_num;	<span class="comment">/* semaphore number */</span></span><br><span class="line">  <span class="type">short</span> <span class="type">int</span> sem_op;		<span class="comment">/* semaphore operation */</span></span><br><span class="line">  <span class="type">short</span> <span class="type">int</span> sem_flg;		<span class="comment">/* operation flag */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>sem_num</code>æˆå‘˜æ˜¯ä¿¡å·é‡é›†ä¸­ä¿¡å·é‡çš„ç¼–å·ï¼Œ0è¡¨ç¤ºä¿¡å·é‡é›†ä¸­ç¬¬ä¸€ä¸ªä¿¡å·é‡ã€‚</p>
<p><code>sem_op</code>æˆå‘˜æŒ‡å®šæ“ä½œç±»å‹ï¼Œå…¶å¯é€‰å€¼ä¸ºæ­£æ•´æ•°ã€0å’Œè´Ÿæ•´æ•°ã€‚æ¯ç§ç±»å‹çš„æ“ä½œçš„è¡Œä¸ºåˆå—åˆ°<code>sem_fig</code>æˆå‘˜çš„å½±å“ã€‚<code>sem_fg</code>çš„å¯é€‰å€¼æ˜¯<code>IPC_NOWAIT</code>å’Œ<code>SEM_UNDO</code>ã€‚<code>IPC_NOWAIT</code>çš„å«ä¹‰æ˜¯ï¼Œæ— è®ºä¿¡å·é‡æ“ä½œæ˜¯å¦æˆåŠŸï¼Œ<code>semop</code>è°ƒç”¨éƒ½å°†ç«‹å³è¿”å›ï¼Œè¿™ç±»ä¼¼äºéé˜»å¡IOæ“ä½œã€‚<code>SEM_UNDO</code>çš„å«ä¹‰æ˜¯ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„<code>semop</code>æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œ<code>sem_op</code>å’Œ<code>sem_flg</code> å°†æŒ‰ç…§å¦‚ä¸‹æ–¹å¼æ¥å½±å“<code>semop</code>çš„è¡Œä¸º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220914191132925.png" alt="image-20220914191132925"></p>
<p><code>semop</code>ç³»ç»Ÿè°ƒç”¨çš„ç¬¬3ä¸ªå‚æ•°<code>num_sem_ops</code>æŒ‡å®šè¦æ‰§è¡Œçš„æ“ä½œä¸ªæ•°ï¼Œå³<code>sem_ops</code>æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚<code>semop</code>å¯¹æ•°ç»„<code>sem_ops</code>ä¸­çš„æ¯ä¸ªæˆå‘˜æŒ‰ç…§æ•°ç»„é¡ºåºä¾æ¬¡æ‰§è¡Œæ“ä½œï¼Œå¹¶ä¸”è¯¥è¿‡ç¨‹æ˜¯åŸå­æ“ä½œï¼Œä»¥é¿å…åˆ«çš„è¿›ç¨‹åœ¨åŒä¸€æ—¶åˆ»æŒ‰ç…§ä¸åŒçš„é¡ºåºå¯¹è¯¥ä¿¡å·é›†ä¸­çš„ä¿¡å·é‡æ‰§è¡Œ<code>semop</code>æ“ä½œå¯¼è‡´çš„ç«æ€æ¡ä»¶ã€‚</p>
<p><code>semop</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å¤±è´¥çš„æ—¶å€™ï¼Œ<code>sem_ops</code>æ•°ç»„ä¸­æŒ‡å®šçš„æ‰€æœ‰æ“ä½œéƒ½ä¸è¢«æ‰§è¡Œã€‚</p>
<h3 id="semtclç³»ç»Ÿè°ƒç”¨"><a href="#semtclç³»ç»Ÿè°ƒç”¨" class="headerlink" title="semtclç³»ç»Ÿè°ƒç”¨"></a>semtclç³»ç»Ÿè°ƒç”¨</h3><p><code>semctl</code>ç³»ç»Ÿè°ƒç”¨å…è®¸è°ƒç”¨è€…å¯¹ä¿¡å·é‡è¿›è¡Œç›´æ¥æ§åˆ¶ã€‚å…¶å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semctl</span><span class="params">(<span class="type">int</span> semid, <span class="type">int</span> semnum, <span class="type">int</span> cmd, ...)</span>;</span><br></pre></td></tr></table></figure>
<p><code>sem_id</code>å‚æ•°æ˜¯ç”±<code>semget</code>è°ƒç”¨è¿”å›çš„ä¿¡å·é‡é›†æ ‡è¯†ç¬¦ï¼Œç”¨ä»¥æŒ‡å®šè¢«æ“ä½œçš„ä¿¡å·é‡é›†ã€‚</p>
<p><code>semnum</code>å‚æ•°æŒ‡å®šè¢«æ“ä½œçš„ä¿¡å·é‡åœ¨ä¿¡å·é‡é›†ä¸­çš„ç¼–å·ã€‚</p>
<p><code>cmd</code>å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚æœ‰çš„å‘½ä»¤éœ€è¦è°ƒç”¨è€…ä¼ é€’ç¬¬4ä¸ªå‚æ•°ã€‚ç¬¬4ä¸ªå‚æ•°çš„ç±»å‹ç”±ç”¨æˆ·è‡ªå·±å®šä¹‰ï¼Œä½†<code>sys/sem.h</code>å¤´æ–‡ä»¶ç»™å‡ºäº†å®ƒçš„æ¨èæ ¼å¼ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">   <span class="type">int</span>              val;    <span class="comment">/* ç”¨äº SETVAL */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* ç”¨äº IPC_STAT, IPC_SET */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span>  *<span class="built_in">array</span>;  <span class="comment">/* ç”¨äº GETALL, SETALL */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* ç”¨äº IPC_INFO(Linux-specific) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span>  <span class="title">seminfo</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">int</span> semmap;				<span class="comment">/* Linuxå†…æ ¸æ²¡æœ‰ä½¿ç”¨ */</span></span><br><span class="line">  <span class="type">int</span> semmni;				<span class="comment">/* ç³»ç»Ÿæœ€å¤šå¯ä»¥æ‹¥æœ‰çš„ä¿¡å·é‡é›†æ•°ç›® */</span></span><br><span class="line">  <span class="type">int</span> semmns;				<span class="comment">/* ç³»ç»Ÿæœ€å¤šå¯ä»¥æ‹¥æœ‰çš„ä¿¡å·é‡æ•°ç›® */</span></span><br><span class="line">  <span class="type">int</span> semmnu;				<span class="comment">/* Linuxå†…æ ¸æ²¡æœ‰ä½¿ç”¨ */</span></span><br><span class="line">  <span class="type">int</span> semmsl;				<span class="comment">/* ä¸€ä¸ªä¿¡å·é›†æœ€å¤šå…è®¸åŒ…å«çš„ä¿¡å·é‡æ•°ç›® */</span></span><br><span class="line">  <span class="type">int</span> semopm;				<span class="comment">/* semopä¸€æ¬¡æœ€å¤šèƒ½æ‰§è¡Œçš„sem_opæ“ä½œæ•°ç›® */</span></span><br><span class="line">  <span class="type">int</span> semume;				<span class="comment">/* Linuxå†…æ ¸æ²¡æœ‰ä½¿ç”¨ */</span></span><br><span class="line">  <span class="type">int</span> semusz;				<span class="comment">/* sem_undoç»“æ„ä½“çš„å¤§å° */</span></span><br><span class="line">  <span class="type">int</span> semvmx;				<span class="comment">/* æœ€å¤§å…è®¸çš„ä¿¡å·é‡å€¼ */</span></span><br><span class="line">  <span class="type">int</span> semaem;				<span class="comment">/* æœ€å¤šå…è®¸çš„UNDOæ¬¡æ•°ï¼ˆå¾…SEM_UNDOæ ‡å¿—çš„semopæ“ä½œçš„æ¬¡æ•°ï¼‰*/</span></span><br><span class="line">    </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>semctl</code>æ”¯æŒçš„å‘½ä»¤</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220914213741897.png" alt="image-20220914213741897"></p>
<p>è¿™äº›æ“ä½œä¸­ï¼Œ<code>GETNCNT</code>ã€<code>GETPID</code>ã€<code>GETVAL</code>ã€<code>GETZCNT</code>å’Œ<code>SETVAL</code>æ“ä½œçš„æ˜¯å•ä¸ªä¿¡å·é‡ï¼Œå®ƒæ˜¯ç”±æ ‡è¯†ç¬¦<code>semid</code>æŒ‡å®šçš„ä¿¡å·é‡é›†ä¸­çš„ç¬¬<code>semnum</code>ä¸ªä¿¡å·é‡;è€Œå…¶ä»–æ“ä½œé’ˆå¯¹çš„æ˜¯æ•´ä¸ªä¿¡å·é‡é›†ï¼Œæ­¤æ—¶<code>semctl</code>çš„å‚æ•°<code>semnum</code>è¢«å¿½ç•¥ã€‚</p>
<p><code>semctl</code>æˆåŠŸæ—¶çš„è¿”å›å€¼å–å†³äº<code>cmd</code>å‚æ•°ï¼Œå¦‚è¡¨13-2æ‰€ç¤ºã€‚<code>semctl</code>å¤±è´¥æ—¶è¿”å›-1,å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<h3 id="ç‰¹æ®Šé”®å€¼IPC-PRIVATE"><a href="#ç‰¹æ®Šé”®å€¼IPC-PRIVATE" class="headerlink" title="ç‰¹æ®Šé”®å€¼IPC_PRIVATE"></a>ç‰¹æ®Šé”®å€¼IPC_PRIVATE</h3><p><code>semget</code>çš„è°ƒç”¨è€…å¯ä»¥ç»™å…¶<code>key</code>å‚æ•°ä¼ é€’ä¸€ä¸ªç‰¹æ®Šçš„é”®å€¼<code>IPC_PRIVATE</code>(å…¶å€¼ä¸º0)ï¼Œè¿™æ ·æ— è®ºè¯¥ä¿¡å·é‡æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œ<code>semget</code>éƒ½å°†åˆ›å»ºä¸€ä¸ªæ–°çš„ä¿¡å·é‡ã€‚ä½¿ç”¨è¯¥é”®å€¼åˆ›å»ºçš„ä¿¡å·é‡å¹¶éåƒå®ƒçš„åå­—å£°ç§°çš„é‚£æ ·æ˜¯è¿›ç¨‹ç§æœ‰çš„ã€‚å…¶ä»–è¿›ç¨‹ï¼Œå°¤å…¶æ˜¯å­è¿›ç¨‹ï¼Œä¹Ÿæœ‰æ–¹æ³•æ¥è®¿é—®è¿™ä¸ªä¿¡å·é‡ã€‚æ‰€ä»¥<code>semget</code>çš„ manæ‰‹å†Œçš„<code>BUGS</code>éƒ¨åˆ†ä¸Šè¯´ï¼Œä½¿ç”¨åå­—<code>IPC_PRIVATE</code>æœ‰äº›è¯¯å¯¼ï¼ˆå†å²åŸå› )ï¼Œåº”è¯¥ç§°ä¸º<code>IPC_NEW</code>ã€‚æ¯”å¦‚ä¸‹é¢çš„ä»£ç å°±åœ¨çˆ¶ã€å­è¿›ç¨‹é—´ä½¿ç”¨ä¸€ä¸ªIPC_PRIVATEä¿¡å·é‡æ¥åŒæ­¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> *<span class="built_in">array</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span> *__<span class="title">buf</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pv</span><span class="params">(<span class="type">int</span> sem_id, <span class="type">int</span> op)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> <span class="title">sem_b</span>;</span></span><br><span class="line">    sem_b.sem_num = <span class="number">0</span>;</span><br><span class="line">    sem_b.sem_op = op;</span><br><span class="line">    sem_b.sem_flg = SEM_UNDO;</span><br><span class="line">    semop(sem_id, &amp;sem_b, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> sem_id = semget(IPC_PRIVATE, <span class="number">1</span>, <span class="number">0666</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> <span class="title">semun</span> <span class="title">sem_un</span>;</span></span><br><span class="line">    sem_un.val = <span class="number">1</span>;</span><br><span class="line">    semctl(sem_id, <span class="number">0</span>, SETVAL, sem_un);</span><br><span class="line"></span><br><span class="line">    <span class="type">pid_t</span> id = fork();</span><br><span class="line">    <span class="keyword">if</span> (id &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (id == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child try to get binary sem\n&quot;</span>);</span><br><span class="line">        pv(sem_id, <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child get the sem and would release it after 5 seconds\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        pv(sem_id, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent try to get binary sem\n&quot;</span>);</span><br><span class="line">        pv(sem_id, <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent get the sem and would release it after 5 seconds\n&quot;</span>);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        pv(sem_id, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    waitpid(id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    semctl(sem_id, <span class="number">0</span>, IPC_RMID, sem_un);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å…±äº«å†…å­˜"><a href="#å…±äº«å†…å­˜" class="headerlink" title="å…±äº«å†…å­˜"></a>å…±äº«å†…å­˜</h2><p>å…±äº«å†…å­˜æ˜¯æœ€é«˜æ•ˆçš„IPCæœºåˆ¶ï¼Œå› ä¸ºå®ƒä¸æ¶‰åŠè¿›ç¨‹ä¹‹é—´çš„ä»»ä½•æ•°æ®ä¼ è¾“ã€‚è¿™ç§é«˜æ•ˆç‡å¸¦æ¥çš„é—®é¢˜æ˜¯ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨å…¶ä»–è¾…åŠ©æ‰‹æ®µæ¥åŒæ­¥è¿›ç¨‹å¯¹å…±äº«å†…å­˜çš„è®¿é—®ï¼Œå¦åˆ™ä¼šäº§ç”Ÿç«æ€æ¡ä»¶ã€‚å› æ­¤ï¼Œå…±äº«å†…å­˜é€šå¸¸å’Œå…¶ä»–è¿›ç¨‹é—´é€šä¿¡æ–¹å¼ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>Linuxå…±äº«å†…å­˜çš„APIéƒ½å®šä¹‰<code>sys/shm.h</code>å¤´æ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬4ä¸ªç³»ç»Ÿè°ƒç”¨: <code>shmget</code>ã€<code>shmat</code>ã€<code>shmdt</code> å’Œl<code>shmctl</code>ã€‚æˆ‘ä»¬å°†ä¾æ¬¡è®¨è®ºä¹‹ã€‚</p>
<h3 id="shmgetç³»ç»Ÿè°ƒç”¨"><a href="#shmgetç³»ç»Ÿè°ƒç”¨" class="headerlink" title="shmgetç³»ç»Ÿè°ƒç”¨"></a>shmgetç³»ç»Ÿè°ƒç”¨</h3><p><code>shmget</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€æ®µæ–°çš„å…±äº«å†…å­˜ï¼Œæˆ–è€…è·å–ä¸€æ®µå·²ç»å­˜åœ¨çš„å…±äº«å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">size_t</span> size, <span class="type">int</span> shmflg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>key</code>å‚æ•°æ˜¯ä¸€ä¸ªé”®å€¼ï¼Œç”¨æ¥æ ‡è¯†ä¸€æ®µå…¨å±€å”¯ä¸€çš„å…±äº«å†…å­˜ã€‚</p>
<p><code>size</code>å‚æ•°æŒ‡å®šå…±äº«å†…å­˜çš„å¤§å°ï¼Œå•ä½æ˜¯å­—èŠ‚ã€‚å¦‚æœæ˜¯åˆ›å»ºæ–°çš„å…±äº«å†…å­˜ï¼Œåˆ™sizeå€¼å¿…é¡»è¢«æŒ‡ã€‚å¦‚æœæ˜¯è·å–å·²ç»å­˜åœ¨çš„å…±äº«å†…å­˜ï¼Œåˆ™å¯ä»¥æŠŠ<code>size</code>è®¾ç½®ä¸º0ã€‚</p>
<p><code>shmflg</code>å‚æ•°æŒ‡å®šä¿¡å·é‡çš„æ“ä½œç±»å‹ä»¥åŠæ“çºµæƒé™ã€‚å®ƒå’Œ<code>semget</code>ä¸­<code>semflg</code>å‚æ•°ç›¸åŒï¼Œä½†æ˜¯<code>shmflg</code>æ”¯æŒä¸¤ä¸ªé¢å¤–çš„æ ‡å¿—ï¼š<code>SHM_HUGETLB</code>å’Œ<code>SHM_NORESERVE</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916104221617.png" alt="image-20220916104221617"></p>
<p><code>shmget</code>æˆåŠŸæ—¶è¿”å›â€”ä¸ªæ­£æ•´æ•°å€¼ï¼Œå®ƒæ˜¯å…±äº«å†…å­˜çš„æ ‡è¯†ç¬¦ã€‚<code>shmget</code>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>å¦‚æœ<code>shmget</code>ç”¨äºåˆ›å»ºå…±äº«å†…å­˜ï¼Œåˆ™è¿™æ®µå…±äº«å†…å­˜çš„æ‰€æœ‰å­—èŠ‚éƒ½è¢«åˆå§‹åŒ–ä¸º0ï¼Œä¸ä¹‹å…³è”çš„å†…æ ¸æ•°æ®ç»“æ„<code>shmid_ds</code>å°†è¢«åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚<code>shmid_ds</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shmid_ds</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">shm_perm</span>;</span>    <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">   <span class="type">size_t</span>          shm_segsz;   <span class="comment">/* Size of segment (bytes) */</span></span><br><span class="line">   <span class="type">time_t</span>          shm_atime;   <span class="comment">/* Last attach time */</span></span><br><span class="line">   <span class="type">time_t</span>          shm_dtime;   <span class="comment">/* Last detach time */</span></span><br><span class="line">   <span class="type">time_t</span>          shm_ctime;   <span class="comment">/* Last change time */</span></span><br><span class="line">   <span class="type">pid_t</span>           shm_cpid;    <span class="comment">/* PID of creator */</span></span><br><span class="line">   <span class="type">pid_t</span>           shm_lpid;    <span class="comment">/* PID of last shmat(2)/shmdt(2) */</span></span><br><span class="line">   <span class="type">shmatt_t</span>        shm_nattch;  <span class="comment">/* No. of current attaches */</span></span><br><span class="line">   ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> &#123;</span></span><br><span class="line">   <span class="type">key_t</span>          __key;    <span class="comment">/* Key supplied to shmget(2) */</span></span><br><span class="line">   <span class="type">uid_t</span>          uid;      <span class="comment">/* Effective UID of owner */</span></span><br><span class="line">   <span class="type">gid_t</span>          gid;      <span class="comment">/* Effective GID of owner */</span></span><br><span class="line">   <span class="type">uid_t</span>          cuid;     <span class="comment">/* Effective UID of creator */</span></span><br><span class="line">   <span class="type">gid_t</span>          cgid;     <span class="comment">/* Effective GID of creator */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> mode;     <span class="comment">/* Permissions + SHM_DEST and</span></span><br><span class="line"><span class="comment">                               SHM_LOCKED flags */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> __seq;    <span class="comment">/* Sequence number */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916110659249.png" alt="image-20220916110659249"></p>
<h3 id="shmatå’Œshdtç³»ç»Ÿè°ƒç”¨"><a href="#shmatå’Œshdtç³»ç»Ÿè°ƒç”¨" class="headerlink" title="shmatå’Œshdtç³»ç»Ÿè°ƒç”¨"></a>shmatå’Œshdtç³»ç»Ÿè°ƒç”¨</h3><p>å…±äº«å†…å­˜è¢«åˆ›å»º/è·å–ä¹‹åï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹å³è®¿é—®å®ƒï¼Œè€Œæ˜¯éœ€è¦å…ˆå°†å®ƒå…³è”åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­ã€‚ä½¿ç”¨å®Œå…±äº«å†…å­˜ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å°†å®ƒä»è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ†ç¦»ã€‚è¿™ä¸¤é¡¹ä»»åŠ¡åˆ†åˆ«ç”±å¦‚ä¸‹ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®ç°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">shmat</span><span class="params">(<span class="type">int</span> shmid, <span class="type">const</span> <span class="type">void</span> *shmaddr, <span class="type">int</span> shmflg)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmdt</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *shmaddr)</span>;</span><br></pre></td></tr></table></figure>
<p><code>shmid</code>å‚æ•°æ˜¯ç”±<code>shmget</code>è°ƒç”¨è¿”å›çš„å…±äº«å†…å­˜æ ‡è¯†ç¬¦ã€‚</p>
<p><code>shmaddr</code>å‚æ•°æŒ‡å®šå°†å…±äº«å†…å­˜å…³è”åˆ°è¿›ç¨‹çš„é‚£å—åœ°å€ç©ºé—´ï¼Œæœ€ç»ˆçš„æ•ˆæœè¿˜å—åˆ°<code>shmflg</code>å‚æ•°çš„å¯é€‰æ ‡å¿—<code>SHM_RND</code>çš„å½±å“ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916142910291.png" alt="image-20220916142910291"></p>
<p>é™¤äº†<code>SHM_RND</code>æ ‡å¿—å¤–ï¼Œshmflgå‚æ•°è¿˜æ”¯æŒå¦‚ä¸‹æ ‡å¿—ï¼š</p>
<p><img src="C:/Users/Administrator/AppData/Roaming/Typora/typora-user-images/image-20220916143225086.png" alt="image-20220916143225086"></p>
<p><code>shmat</code>æˆåŠŸæ—¶è¿”å›å…±äº«å†…å­˜è¢«å…³è”åˆ°çš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å›<code>(void*)-1</code>å¹¶è®¾ç½®<code>errno</code>ã€‚<code>shmat</code>æˆåŠŸæ—¶ï¼Œå°†ä¿®æ”¹å†…æ ¸æ•°æ®ç»“æ„<code>shmid_ds</code>çš„éƒ¨åˆ†å­—æ®µï¼Œå¦‚ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916143610901.png" alt="image-20220916143610901"></p>
<p><code>shmdt</code>å‡½æ•°å°†å…³è”åˆ°<code>shm_addr</code>å¤„çš„å…±äº«å†…å­˜ä»è¿›ç¨‹ä¸­åˆ†ç¦»ã€‚å®ƒæˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚<code>shmdt</code>åœ¨æˆåŠŸè°ƒç”¨æ—¶å°†ä¿®æ”¹å†…æ ¸æ•°æ®ç»“æ„<code>shmid_ds</code>çš„éƒ¨åˆ†å­—æ®µï¼Œå¦‚ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916143718065.png" alt="image-20220916143718065"></p>
<h3 id="shmctlç³»ç»Ÿè°ƒç”¨"><a href="#shmctlç³»ç»Ÿè°ƒç”¨" class="headerlink" title="shmctlç³»ç»Ÿè°ƒç”¨"></a>shmctlç³»ç»Ÿè°ƒç”¨</h3><p>shmctlç³»ç»Ÿè°ƒç”¨æ§åˆ¶å…±äº«å†…å­˜çš„æŸäº›å±æ€§ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shmctl</span><span class="params">(<span class="type">int</span> shmid, <span class="type">int</span> cmd, <span class="keyword">struct</span> shmid_ds *buf)</span>;</span><br></pre></td></tr></table></figure>
<p><code>shmid</code>å‚æ•°æ˜¯ç”±<code>shmget</code>è°ƒç”¨è¿”å›çš„å…±äº«å†…å­˜æ ‡è¯†ç¬¦ã€‚</p>
<p><code>cmd</code>å‚æ•°æŒ‡å®šè¦æ‰§è¡Œçš„å‘½ä»¤</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916160516010.png" alt="image-20220916160516010"></p>
<p><code>shmctl</code>æˆåŠŸæ—¶çš„è¿”å›å€¼å–å†³äº<code>cmd</code>å‚æ•°ï¼Œå¦‚ä¸Šè¡¨æ‰€å±•ç¤ºçš„ï¼Œ<code>shmctl</code>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶ä¸”è®¾ç½®<code>erron</code>ã€‚</p>
<h3 id="å…±äº«å†…å­˜POSIXæ–¹æ³•"><a href="#å…±äº«å†…å­˜POSIXæ–¹æ³•" class="headerlink" title="å…±äº«å†…å­˜POSIXæ–¹æ³•"></a>å…±äº«å†…å­˜POSIXæ–¹æ³•</h3><p>ä¹‹å‰ä»‹ç»è¿‡<code>mmap</code>å‡½æ•°ã€‚åˆ©ç”¨å®ƒçš„<code>MAP_ANONYMOUS</code>æ ‡å¿—æˆ‘ä»¬å¯ä»¥å®ç°çˆ¶ã€å­è¿›ç¨‹ä¹‹é—´çš„åŒ¿åå†…å­˜å…±äº«ã€‚é€šè¿‡æ‰“å¼€åŒä¸€ä¸ªæ–‡ä»¶ï¼Œ<code>mmap</code>ä¹Ÿå¯ä»¥å®ç°æ— å…³è¿›ç¨‹ä¹‹é—´çš„å†…å­˜å…±äº«ã€‚Linuxæä¾›äº†å¦å¤–ä¸€ç§åˆ©ç”¨<code>mmap</code>åœ¨æ— å…³è¿›ç¨‹ä¹‹é—´å…±äº«å†…å­˜çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼æ— é¡»ä»»ä½•æ–‡ä»¶çš„æ”¯æŒï¼Œä½†å®ƒéœ€è¦å…ˆä½¿ç”¨å¦‚ä¸‹å‡½æ•°æ¥åˆ›å»ºæˆ–æ‰“å¼€ä¸€ä¸ª<code>POSIX</code>å…±äº«å†…å­˜å¯¹è±¡:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>        <span class="comment">/* For mode constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>           <span class="comment">/* For O_* constants */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">shm_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> oflag, <span class="type">mode_t</span> mode)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">shm_unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure>
<p><code>shm_open</code>çš„ä½¿ç”¨æ–¹æ³•ä¸<code>open</code>ç³»ç»Ÿè°ƒç”¨å®Œå…¨ç›¸åŒã€‚</p>
<p><code>name</code>å‚æ•°æŒ‡å®šè¦åˆ›å»º<code>/</code>æ‰“å¼€çš„å…±äº«å†…å­˜å¯¹è±¡ã€‚ä»å¯ç§»æ¤æ€§çš„è§’åº¦è€ƒè™‘ï¼Œè¯¥å‚æ•°åº”è¯¥ä½¿ç”¨â€/somenameâ€çš„æ ¼å¼:ä»¥â€œ/â€å¼€å§‹ï¼Œåæ¥å¤šä¸ªå­—ç¬¦ï¼Œä¸”è¿™äº›å­—ç¬¦éƒ½ä¸æ˜¯â€œ/â€ï¼›ä»¥â€œ\0â€ç»“å°¾ï¼Œé•¿åº¦ä¸è¶…è¿‡<code>NAME_MAX</code>(é€šå¸¸æ˜¯255)ã€‚</p>
<p><code>oflag</code>å‚æ•°æŒ‡å®šåˆ›å»ºæ–¹å¼ã€‚å®ƒå¯ä»¥æ˜¯ä¸‹åˆ—æ ‡å¿—ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªçš„æŒ‰ä½æˆ–:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916183212921.png" alt="image-20220916183212921"></p>
<p><code>shm_open</code>è°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚è¯¥æ–‡ä»¶æè¿°ç¬¦å¯ç”¨äºåç»­çš„<code>mmap</code>è°ƒç”¨ï¼Œä»è€Œå°†å…±äº«å†…å­˜å…³è”åˆ°è°ƒç”¨è¿›ç¨‹ã€‚<code>shm_open</code>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>å’Œæ‰“å¼€çš„æ–‡ä»¶æœ€åéœ€è¦å…³é—­ä¸€æ ·ï¼Œç”±<code>shm_open</code>åˆ›å»ºçš„å…±äº«å†…å­˜å¯¹è±¡ä½¿ç”¨å®Œä¹‹åä¹Ÿéœ€è¦è¢«åˆ é™¤ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡<code>shm_unlink</code>å‡½æ•°å®ç°çš„ã€‚</p>
<p>è¯¥å‡½æ•°å°†<code>name</code>å‚æ•°æŒ‡å®šçš„å…±äº«å†…å­˜å¯¹è±¡æ ‡è®°ä¸ºç­‰å¾…åˆ é™¤ã€‚å½“æ‰€æœ‰ä½¿ç”¨è¯¥å…±äº«å†…å­˜å¯¹è±¡çš„è¿›ç¨‹éƒ½ä½¿ç”¨<code>ummap</code>å°†å®ƒä»è¿›ç¨‹ä¸­åˆ†ç¦»ä¹‹åï¼Œç³»ç»Ÿå°†é”€æ¯è¿™ä¸ªå…±äº«å†…å­˜å¯¹è±¡æ‰€å æ®çš„èµ„æºã€‚</p>
<p>å¦‚æœä»£ç ä¸­ä½¿ç”¨äº†ä¸Šè¿°<code>POSIX</code>å…±äº«å†…å­˜å‡½æ•°ï¼Œåˆ™ç¼–è¯‘çš„æ—¶å€™éœ€è¦æŒ‡å®šé“¾æ¥é€‰é¡¹<code>-lrt</code>ã€‚</p>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h2><p>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯åœ¨ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´ä¼ é€’äºŒè¿›åˆ¶å—æ•°æ®çš„ä¸€ç§ç®€å•æœ‰æ•ˆçš„æ–¹å¼ã€‚æ¯ä¸ªæ•°æ®å—éƒ½æœ‰ä¸€ä¸ªç‰¹å®šçš„ç±»å‹ï¼Œæ¥æ”¶æ–¹å¯ä»¥æ ¹æ®ç±»å‹æ¥æœ‰é€‰æ‹©åœ°æ¥æ”¶æ•°æ®ï¼Œè€Œä¸ä¸€å®šåƒç®¡é“å’Œå‘½åç®¡é“é‚£æ ·å¿…é¡»ä»¥å…ˆè¿›å…ˆå‡ºçš„æ–¹å¼æ¥æ”¶æ•°æ®ã€‚</p>
<p>Linuxæ¶ˆæ¯é˜Ÿåˆ—çš„APIéƒ½å®šä¹‰åœ¨<code>sys/msg.h</code>å¤´æ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬4ä¸ªç³»ç»Ÿè°ƒç”¨: <code>msgget</code>ã€<code>msgsnd</code>ã€<code>msgrcv</code>å’Œ <code>msgctl</code>ã€‚</p>
<h3 id="msggetç³»ç»Ÿè°ƒç”¨"><a href="#msggetç³»ç»Ÿè°ƒç”¨" class="headerlink" title="msggetç³»ç»Ÿè°ƒç”¨"></a>msggetç³»ç»Ÿè°ƒç”¨</h3><p><code>msgget</code>ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…è·å–ä¸€ä¸ªå·²æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚å…¶å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msgget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>key</code>å‚æ•°æ˜¯ä¸€ä¸ªé”®å€¼ï¼Œç”¨æ¥æ ‡è¯†ä¸€æ®µå…¨å±€å”¯ä¸€çš„å…±äº«å†…å­˜ã€‚</p>
<p><code>msgflg</code>å‚æ•°æŒ‡å®šä¿¡å·é‡çš„æ“ä½œç±»å‹ä»¥åŠæ“çºµæƒé™ã€‚å®ƒå’Œ<code>semget</code>ä¸­<code>semflg</code>å‚æ•°ç›¸åŒã€‚</p>
<p><code>msgget</code>æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªæ­£æ•´æ•°å€¼ï¼Œå®ƒæ˜¯æ¶ˆæ¯é˜Ÿåˆ—çš„æ ‡è¯†ç¬¦ã€‚<code>msgget</code>å¤±è´¥æ—¶è¿”å›-1ï¼Œå¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>å¦‚æœ<code>msgget</code>ç”¨äºåˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œåˆ™ä¸ä¹‹å…³è”çš„å†…æ ¸æ•°æ®ç»“æ„<code>msqid_ds</code>å°†è¢«åˆ›å»ºå¹¶åˆå§‹åŒ–ã€‚<code>msqid_ds</code>ç»“æ„ä½“çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msqid_ds</span> &#123;</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> <span class="title">msg_perm</span>;</span>     <span class="comment">/* Ownership and permissions */</span></span><br><span class="line">   <span class="type">time_t</span>          msg_stime;    <span class="comment">/* Time of last msgsnd(2) */</span></span><br><span class="line">   <span class="type">time_t</span>          msg_rtime;    <span class="comment">/* Time of last msgrcv(2) */</span></span><br><span class="line">   <span class="type">time_t</span>          msg_ctime;    <span class="comment">/* Time of last change */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">long</span>   __msg_cbytes; <span class="comment">/* Current number of bytes in</span></span><br><span class="line"><span class="comment">                                    queue (nonstandard) */</span></span><br><span class="line">   <span class="type">msgqnum_t</span>       msg_qnum;     <span class="comment">/* Current number of messages</span></span><br><span class="line"><span class="comment">                                    in queue */</span></span><br><span class="line">   <span class="type">msglen_t</span>        msg_qbytes;   <span class="comment">/* Maximum number of bytes</span></span><br><span class="line"><span class="comment">                                    allowed in queue */</span></span><br><span class="line">   <span class="type">pid_t</span>           msg_lspid;    <span class="comment">/* PID of last msgsnd(2) */</span></span><br><span class="line">   <span class="type">pid_t</span>           msg_lrpid;    <span class="comment">/* PID of last msgrcv(2) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ipc_perm</span> &#123;</span></span><br><span class="line">   <span class="type">key_t</span>          __key;       <span class="comment">/* Key supplied to msgget(2) */</span></span><br><span class="line">   <span class="type">uid_t</span>          uid;         <span class="comment">/* Effective UID of owner */</span></span><br><span class="line">   <span class="type">gid_t</span>          gid;         <span class="comment">/* Effective GID of owner */</span></span><br><span class="line">   <span class="type">uid_t</span>          cuid;        <span class="comment">/* Effective UID of creator */</span></span><br><span class="line">   <span class="type">gid_t</span>          cgid;        <span class="comment">/* Effective GID of creator */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> mode;        <span class="comment">/* Permissions */</span></span><br><span class="line">   <span class="type">unsigned</span> <span class="type">short</span> __seq;       <span class="comment">/* Sequence number */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="msgsndç³»ç»Ÿè°ƒç”¨"><a href="#msgsndç³»ç»Ÿè°ƒç”¨" class="headerlink" title="msgsndç³»ç»Ÿè°ƒç”¨"></a>msgsndç³»ç»Ÿè°ƒç”¨</h3><p><code>msgsnd</code>ç³»ç»Ÿè°ƒç”¨æŠŠä¸€æ¡æ¶ˆæ¯æ·»åŠ åˆ°æ¶ˆæ¯é˜Ÿåˆ—å½“ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msgsnd</span><span class="params">(<span class="type">int</span> msqid, <span class="type">const</span> <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>msqid</code>å‚æ•°æ˜¯ç”±<code>msgget</code>è°ƒç”¨è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚</p>
<p><code>msgp</code>å‚æ•°æŒ‡å‘ä¸€ä¸ªå‡†å¤‡å‘ç”Ÿçš„æ¶ˆæ¯ï¼Œæ¶ˆæ¯çš„ç±»å‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">   <span class="type">long</span> mtype;       <span class="comment">/* message type, must be &gt; 0 */</span></span><br><span class="line">   <span class="type">char</span> mtext[<span class="number">512</span>];    <span class="comment">/* message data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ<code>mtype</code>æˆå‘˜æŒ‡å®šæ¶ˆæ¯çš„ç±»å‹ï¼Œå®ƒå¿…é¡»æ˜¯ä¸€ä¸ªæ­£æ•´æ•°ã€‚<code>mtext</code>æ˜¯æ¶ˆæ¯æ•°æ®ã€‚</p>
<p><code>msgsz</code>å‚æ•°æ˜¯æ¶ˆæ¯çš„æ•°æ®éƒ¨åˆ†(<code>mtext</code>ï¼‰çš„é•¿åº¦ã€‚è¿™ä¸ªé•¿åº¦å¯ä»¥ä¸º0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ¶ˆæ¯æ•°æ®ã€‚</p>
<p><code>msgflg</code>å‚æ•°æ§åˆ¶<code>msgsnd</code>çš„è¡Œä¸ºã€‚å®ƒé€šå¸¸ä»…æ”¯æŒ<code>IPC_NOWAIT</code>æ ‡å¿—ï¼Œå³ä»¥éé˜»å¡çš„æ–¹å¼å‘é€æ¶ˆæ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå‘é€æ¶ˆæ¯æ—¶å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™<code>msgsnd</code>å°†é˜»å¡ã€‚è‹¥<code>IPC_NOWAIT</code>æ ‡å¿—è¢«æŒ‡å®šï¼Œåˆ™<code>msgsnd</code>å°†ç«‹å³è¿”å›å¹¶è®¾ç½®<code>errno</code>ä¸º<code>EAGAIN</code>ã€‚</p>
<p>å¤„äºé˜»å¡çŠ¶æ€çš„<code>msgsnd</code>è°ƒç”¨å¯èƒ½è¢«å¦‚ä¸‹ä¸¤ç§å¼‚å¸¸æƒ…å†µæ‰€ä¸­æ–­:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916203148729.png" alt="image-20220916203148729"></p>
<p><code>msgsnd</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚<code>msgsnd</code>æˆåŠŸæ—¶å°†ä¿®æ”¹å†…æ ¸æ•°æ®ç»“æ„<code>msqid_ds</code>çš„éƒ¨åˆ†å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916203319762.png" alt="image-20220916203319762"></p>
<h3 id="msgrcvè°ƒç”¨"><a href="#msgrcvè°ƒç”¨" class="headerlink" title="msgrcvè°ƒç”¨"></a>msgrcvè°ƒç”¨</h3><p><code>msgrcv</code>ç³»ç»Ÿè°ƒç”¨ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚å…¶å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">msgrcv</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp, <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure>
<p><code>msqid</code>å‚æ•°æ˜¯ç”±<code>msgget</code>è°ƒç”¨è¿”å›çš„æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ã€‚</p>
<p><code>msgp</code>å‚æ•°ç”¨äºå­˜å‚¨æ¥æ”¶çš„æ¶ˆæ¯ã€‚</p>
<p><code>msgsz</code>å‚æ•°æŒ‡çš„æ˜¯æ¶ˆæ¯æ•°æ®éƒ¨åˆ†çš„é•¿åº¦ã€‚</p>
<p><code>msgtyp</code>å‚æ•°æŒ‡å®šæ¥æ”¶ä½•ç§ç±»å‹çš„æ¶ˆæ¯ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‡ ç§æ–¹å¼æ¥æŒ‡å®šæ¶ˆæ¯ç±»å‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916203913760.png" alt="image-20220916203913760"></p>
<p><code>msgflg</code>å‚æ•°æ§åˆ¶<code>msgrcv</code>å‡½æ•°çš„è¡Œä¸ºã€‚å®ƒå¯ä»¥æ˜¯å¦‚ä¸‹ä¸€äº›æ ‡å¿—çš„æŒ‰ä½æˆ–:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916204159893.png" alt="image-20220916204159893"></p>
<p>å¤„äºé˜»å¡çŠ¶æ€çš„<code>msgrcv</code>è°ƒç”¨è¿˜å¯èƒ½è¢«å¦‚ä¸‹ä¸¤ç§å¼‚å¸¸æƒ…å†µæ‰€ä¸­æ–­:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916204353109.png" alt="image-20220916204353109"></p>
<p><code>msgrcv</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚<code>msgrcv</code>æˆåŠŸæ—¶å°†ä¿®æ”¹å†…æ ¸æ•°æ®ç»“æ„<code>msqid_ds</code>çš„éƒ¨åˆ†å­—æ®µï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220916204528137.png" alt="image-20220916204528137"></p>
<h2 id="IPCå‘½ä»¤"><a href="#IPCå‘½ä»¤" class="headerlink" title="IPCå‘½ä»¤"></a>IPCå‘½ä»¤</h2><p>ä¸Šè¿°3ç§System V IPCè¿›ç¨‹é—´é€šä¿¡æ–¹å¼éƒ½ä½¿ç”¨ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„é”®å€¼ï¼ˆkey)æ¥æè¿°ä¸€ä¸ªå…±äº«èµ„æºã€‚å½“ç¨‹åºè°ƒç”¨<code>semget</code>ã€<code>shmget</code>æˆ–è€…<code>msgget</code>æ—¶ï¼Œå°±åˆ›å»ºäº†è¿™äº›å…±äº«èµ„æºçš„ä¸€ä¸ªå®ä¾‹ã€‚Linuxæä¾›äº†<code>ipcs</code>å‘½ä»¤ï¼Œä»¥è§‚å¯Ÿå½“å‰ç³»ç»Ÿä¸Šæ‹¥æœ‰å“ªäº›å…±äº«èµ„æºå®ä¾‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220917105516824.png" alt="image-20220917105516824"></p>
<p>ä¸Šå›¾å±•ç¤ºäº†æœºå™¨é‡Œé¢æ²¡æœ‰ä»»ä½•æ¶ˆæ¯é˜Ÿåˆ—ï¼Œä½†æ˜¯æœ‰å…±äº«å†…å­˜å’Œä¿¡å·é‡ã€‚</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« ç»ƒä¹ é¢˜</title>
    <url>/2022/10/09/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%AC%AC2%E7%AB%A0%E7%BB%83%E4%B9%A0%E9%A2%98/</url>
    <content><![CDATA[<h1 id="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« ç»ƒä¹ é¢˜"><a href="#æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« ç»ƒä¹ é¢˜" class="headerlink" title="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« ç»ƒä¹ é¢˜"></a>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« ç»ƒä¹ é¢˜</h1><h2 id="ç»ƒä¹ é¢˜2-1å®Œæˆä¸‹é¢çš„æ•°å­—è½¬æ¢"><a href="#ç»ƒä¹ é¢˜2-1å®Œæˆä¸‹é¢çš„æ•°å­—è½¬æ¢" class="headerlink" title="ç»ƒä¹ é¢˜2.1å®Œæˆä¸‹é¢çš„æ•°å­—è½¬æ¢:"></a>ç»ƒä¹ é¢˜2.1å®Œæˆä¸‹é¢çš„æ•°å­—è½¬æ¢:</h2><p>A.å°†0x39A7F8è½¬æ¢ä¸ºäºŒè¿›åˆ¶ã€‚</p>
<script type="math/tex; mode=display">
(39A7F8)_{16} = (0011-1001-1010-0111-1111-1000)_2</script><p>B.å°†äºŒè¿›åˆ¶1100100101111011è½¬æ¢ä¸ºåå…­è¿›åˆ¶ã€‚</p>
<script type="math/tex; mode=display">
(1100-1001-0111-1011)_2 = (C97B)_{16}</script><p>C.å°†0xD5E4Cè½¬æ¢ä¸ºäºŒè¿›åˆ¶ã€‚</p>
<script type="math/tex; mode=display">
(D5E4C)_{16} = (1101-0101-1110-0100-1100)_2</script><p>D.å°†äºŒè¿›åˆ¶1001101110011110110101è½¬æ¢ä¸ºåå…­è¿›åˆ¶ã€‚</p>
<script type="math/tex; mode=display">
(10-0110-1110-0111-1011-0101)_2 =(26E7B5)_{16}</script><span id="more"></span>
<h2 id="ç»ƒä¹ é¢˜2-2-å¡«å†™ä¸‹è¡¨ä¸­çš„ç©ºç™½é¡¹-ç»™å‡º2çš„ä¸åŒæ¬¡å¹‚çš„äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶è¡¨ç¤ºâ€¥"><a href="#ç»ƒä¹ é¢˜2-2-å¡«å†™ä¸‹è¡¨ä¸­çš„ç©ºç™½é¡¹-ç»™å‡º2çš„ä¸åŒæ¬¡å¹‚çš„äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶è¡¨ç¤ºâ€¥" class="headerlink" title="ç»ƒä¹ é¢˜2.2 å¡«å†™ä¸‹è¡¨ä¸­çš„ç©ºç™½é¡¹,ç»™å‡º2çš„ä¸åŒæ¬¡å¹‚çš„äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶è¡¨ç¤ºâ€¥"></a>ç»ƒä¹ é¢˜2.2 å¡«å†™ä¸‹è¡¨ä¸­çš„ç©ºç™½é¡¹,ç»™å‡º2çš„ä¸åŒæ¬¡å¹‚çš„äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶è¡¨ç¤ºâ€¥</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221010210405379.png" alt="image-20221010210405379"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">$n$</th>
<th style="text-align:center">$2^n$(åè¿›åˆ¶)</th>
<th style="text-align:center">$2^n$(åå…­è¿›åˆ¶)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">512</td>
<td style="text-align:center">0x200</td>
</tr>
<tr>
<td style="text-align:center">19</td>
<td style="text-align:center">524288</td>
<td style="text-align:center">0x80000</td>
</tr>
<tr>
<td style="text-align:center">14</td>
<td style="text-align:center">16384</td>
<td style="text-align:center">0x4000</td>
</tr>
<tr>
<td style="text-align:center">16</td>
<td style="text-align:center">65536</td>
<td style="text-align:center">0x10000</td>
</tr>
<tr>
<td style="text-align:center">17</td>
<td style="text-align:center">131072</td>
<td style="text-align:center">0x20000</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">32</td>
<td style="text-align:center">20</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">128</td>
<td style="text-align:center">0x80</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-3-ä¸€ä¸ªå­—èŠ‚å¯ä»¥ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºã€‚å¡«å†™ä¸‹è¡¨ä¸­ç¼ºå¤±çš„é¡¹-ç»™å‡º-ä¸åŒå­—èŠ‚æ¨¡å¼çš„åè¿›åˆ¶ã€äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶å€¼"><a href="#ç»ƒä¹ é¢˜2-3-ä¸€ä¸ªå­—èŠ‚å¯ä»¥ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºã€‚å¡«å†™ä¸‹è¡¨ä¸­ç¼ºå¤±çš„é¡¹-ç»™å‡º-ä¸åŒå­—èŠ‚æ¨¡å¼çš„åè¿›åˆ¶ã€äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶å€¼" class="headerlink" title="ç»ƒä¹ é¢˜2.3 ä¸€ä¸ªå­—èŠ‚å¯ä»¥ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºã€‚å¡«å†™ä¸‹è¡¨ä¸­ç¼ºå¤±çš„é¡¹,ç»™å‡º ä¸åŒå­—èŠ‚æ¨¡å¼çš„åè¿›åˆ¶ã€äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶å€¼:"></a>ç»ƒä¹ é¢˜2.3 ä¸€ä¸ªå­—èŠ‚å¯ä»¥ç”¨ä¸¤ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºã€‚å¡«å†™ä¸‹è¡¨ä¸­ç¼ºå¤±çš„é¡¹,ç»™å‡º ä¸åŒå­—èŠ‚æ¨¡å¼çš„åè¿›åˆ¶ã€äºŒè¿›åˆ¶å’Œåå…­è¿›åˆ¶å€¼:</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221010212306528.png" alt="image-20221010212306528"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åè¿›åˆ¶</th>
<th style="text-align:center">äºŒè¿›åˆ¶</th>
<th style="text-align:center">åå…­è¿›åˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0000 0000</td>
<td style="text-align:center">0x00</td>
</tr>
<tr>
<td style="text-align:center">167</td>
<td style="text-align:center">1010 0111</td>
<td style="text-align:center">0xA7</td>
</tr>
<tr>
<td style="text-align:center">62</td>
<td style="text-align:center">0011 1110</td>
<td style="text-align:center">0x3E</td>
</tr>
<tr>
<td style="text-align:center">188</td>
<td style="text-align:center">1011 1100</td>
<td style="text-align:center">0xBC</td>
</tr>
<tr>
<td style="text-align:center">55</td>
<td style="text-align:center">0011 0111</td>
<td style="text-align:center">0x37</td>
</tr>
<tr>
<td style="text-align:center">136</td>
<td style="text-align:center">1000 1000</td>
<td style="text-align:center">0x88</td>
</tr>
<tr>
<td style="text-align:center">243</td>
<td style="text-align:center">1111 0011</td>
<td style="text-align:center">0xF3</td>
</tr>
<tr>
<td style="text-align:center">82</td>
<td style="text-align:center">0101 0010</td>
<td style="text-align:center">0x52</td>
</tr>
<tr>
<td style="text-align:center">172</td>
<td style="text-align:center">1010 1100</td>
<td style="text-align:center">0xAC</td>
</tr>
<tr>
<td style="text-align:center">231</td>
<td style="text-align:center">1110 0111</td>
<td style="text-align:center">0xE7</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-4-ä¸å°†æ•°å­—è½¬æ¢ä¸ºåè¿›åˆ¶æˆ–è€…äºŒè¿›åˆ¶-è¯•ç€è§£ç­”ä¸‹é¢çš„ç®—æœ¯é¢˜-ç­”æ¡ˆè¦ç”¨-åå…­è¿›åˆ¶è¡¨ç¤ºã€‚æç¤º-åªè¦å°†æ‰§è¡Œåè¿›åˆ¶åŠ æ³•å’Œå‡æ³•æ‰€ä½¿ç”¨çš„æ–¹æ³•æ”¹æˆä»¥16ä¸ºåŸºæ•°ã€‚"><a href="#ç»ƒä¹ é¢˜2-4-ä¸å°†æ•°å­—è½¬æ¢ä¸ºåè¿›åˆ¶æˆ–è€…äºŒè¿›åˆ¶-è¯•ç€è§£ç­”ä¸‹é¢çš„ç®—æœ¯é¢˜-ç­”æ¡ˆè¦ç”¨-åå…­è¿›åˆ¶è¡¨ç¤ºã€‚æç¤º-åªè¦å°†æ‰§è¡Œåè¿›åˆ¶åŠ æ³•å’Œå‡æ³•æ‰€ä½¿ç”¨çš„æ–¹æ³•æ”¹æˆä»¥16ä¸ºåŸºæ•°ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.4 ä¸å°†æ•°å­—è½¬æ¢ä¸ºåè¿›åˆ¶æˆ–è€…äºŒè¿›åˆ¶,è¯•ç€è§£ç­”ä¸‹é¢çš„ç®—æœ¯é¢˜,ç­”æ¡ˆè¦ç”¨ åå…­è¿›åˆ¶è¡¨ç¤ºã€‚æç¤º:åªè¦å°†æ‰§è¡Œåè¿›åˆ¶åŠ æ³•å’Œå‡æ³•æ‰€ä½¿ç”¨çš„æ–¹æ³•æ”¹æˆä»¥16ä¸ºåŸºæ•°ã€‚"></a>ç»ƒä¹ é¢˜2.4 ä¸å°†æ•°å­—è½¬æ¢ä¸ºåè¿›åˆ¶æˆ–è€…äºŒè¿›åˆ¶,è¯•ç€è§£ç­”ä¸‹é¢çš„ç®—æœ¯é¢˜,ç­”æ¡ˆè¦ç”¨ åå…­è¿›åˆ¶è¡¨ç¤ºã€‚æç¤º:åªè¦å°†æ‰§è¡Œåè¿›åˆ¶åŠ æ³•å’Œå‡æ³•æ‰€ä½¿ç”¨çš„æ–¹æ³•æ”¹æˆä»¥16ä¸ºåŸºæ•°ã€‚</h2><p>A. 0x503C + 0x8 </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x503C + 0x8 = 0x5044</span><br></pre></td></tr></table></figure>
<p>B. 0x503C - 0x40</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x503C - 0x40 = 0x4F9C</span><br></pre></td></tr></table></figure>
<p>C. 0x503C + 64</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x503C + 64 = 0x507c</span><br></pre></td></tr></table></figure>
<p>D. 0x50EA - 0x503C </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x50EA - 0x503C = 0xAF</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-5-æ€è€ƒä¸‹é¢å¯¹showä¸Šytesçš„ä¸‰æ¬¡è°ƒç”¨"><a href="#ç»ƒä¹ é¢˜2-5-æ€è€ƒä¸‹é¢å¯¹showä¸Šytesçš„ä¸‰æ¬¡è°ƒç”¨" class="headerlink" title="ç»ƒä¹ é¢˜2.5 æ€è€ƒä¸‹é¢å¯¹showä¸Šytesçš„ä¸‰æ¬¡è°ƒç”¨:"></a>ç»ƒä¹ é¢˜2.5 æ€è€ƒä¸‹é¢å¯¹showä¸Šytesçš„ä¸‰æ¬¡è°ƒç”¨:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">char</span> *byte_pointer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_bytes</span><span class="params">(byte_pointer start, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; %.2x&quot;</span>, start[i]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_int</span><span class="params">(<span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_float</span><span class="params">(<span class="type">float</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">float</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">show_pointer</span><span class="params">(<span class="type">void</span> *x)</span></span><br><span class="line">&#123;</span><br><span class="line">    show_bytes((byte_pointer)&amp;x, <span class="keyword">sizeof</span>(<span class="type">void</span> *));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> val = <span class="number">0x87654321</span>;</span><br><span class="line">byte_pointer valp = (byte_pointer) &amp;val;</span><br><span class="line">show_bytes(valp, <span class="number">1</span>);    <span class="comment">// A.</span></span><br><span class="line">show_bytes(valp, <span class="number">2</span>);    <span class="comment">// B.</span></span><br><span class="line">show_bytes(valp, <span class="number">3</span>);    <span class="comment">// C.</span></span><br></pre></td></tr></table></figure>
<p>æŒ‡å‡ºåœ¨å°ç«¯æ³•æœºå™¨å’Œå¤§ç«¯æ³•æœºå™¨ä¸Š,æ¯æ¬¡è°ƒç”¨çš„è¾“å‡ºå€¼ã€‚</p>
<p>åœ¨å°ç«¯æœºä¸Šè°ƒç”¨äº†ä¸€ä¸‹ï¼Œå¤§ç«¯æœºåªèƒ½ä½¿ç”¨æ¨¡æ‹Ÿå™¨ç›®å‰ä¸æ‰“ç®—è°ƒç”¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011112529883.png" alt="image-20221011112529883"></p>
<h2 id="ç»ƒä¹ é¢˜2-6-ä½¿ç”¨show-intå’Œshow-float-æˆ‘ä»¬ç¡®å®šæ•´æ•°3510593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141-è€Œæµ®ç‚¹æ•°3510593-0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x4A564504ã€‚"><a href="#ç»ƒä¹ é¢˜2-6-ä½¿ç”¨show-intå’Œshow-float-æˆ‘ä»¬ç¡®å®šæ•´æ•°3510593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141-è€Œæµ®ç‚¹æ•°3510593-0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x4A564504ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.6 ä½¿ç”¨show_intå’Œshow_float,æˆ‘ä»¬ç¡®å®šæ•´æ•°3510593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141,è€Œæµ®ç‚¹æ•°3510593.0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x4A564504ã€‚"></a>ç»ƒä¹ é¢˜2.6 ä½¿ç”¨show_intå’Œshow_float,æˆ‘ä»¬ç¡®å®šæ•´æ•°3510593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141,è€Œæµ®ç‚¹æ•°3510593.0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x4A564504ã€‚</h2><p>A.å†™å‡ºè¿™ä¸¤ä¸ªåå…­è¿›åˆ¶å€¼çš„äºŒè¿›åˆ¶è¡¨ç¤º</p>
<p>0x00359141    0000 0000 0011 0101 1001 0001 0100 0001</p>
<p>0x4A564504    0100 1010 0101 0110 0100 0101 0000 0100</p>
<p>B.ç§»åŠ¨è¿™ä¸¤ä¸ªäºŒè¿›åˆ¶ä¸²çš„ç›¸å¯¹ä½ç½®,ä½¿å¾—å®ƒä»¬ç›¸åŒ¹é…çš„ä½æ•°æœ€å¤šã€‚æœ‰å¤šå°‘ä½ç›¸åŒ¹é…å‘¢? </p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011142944151.png" alt="image-20221011142944151"></p>
<p>å¯ä»¥çœ‹åˆ°ç§»åŠ¨ä¸¤ä½åï¼Œæœ€å¤š11ä½ç›¸åŒ¹é…ã€‚</p>
<p>C.ä¸²ä¸­çš„ä»€ä¹ˆéƒ¨åˆ†ä¸ç›¸åŒ¹é…?</p>
<p>è¿™ä¸ªè·Ÿæµ®ç‚¹æ•°çš„å­˜å‚¨æœ‰å…³ï¼Œåç»­åº”è¯¥ä¼šå­¦ä¹ åˆ°ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-7-ä¸‹é¢å¯¹show-bytesçš„è°ƒç”¨å°†è¾“å‡ºä»€ä¹ˆç»“æœ"><a href="#ç»ƒä¹ é¢˜2-7-ä¸‹é¢å¯¹show-bytesçš„è°ƒç”¨å°†è¾“å‡ºä»€ä¹ˆç»“æœ" class="headerlink" title="ç»ƒä¹ é¢˜2.7 ä¸‹é¢å¯¹show_bytesçš„è°ƒç”¨å°†è¾“å‡ºä»€ä¹ˆç»“æœ?"></a>ç»ƒä¹ é¢˜2.7 ä¸‹é¢å¯¹show_bytesçš„è°ƒç”¨å°†è¾“å‡ºä»€ä¹ˆç»“æœ?</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *s = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line">show_bytes((byte_pointer)s,<span class="built_in">strlen</span>(s));</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„å­—æ¯<code>a</code>~<code>z</code>çš„ASCIIç ä¸º 0x61~0x7A</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011193359526.png" alt="image-20221011193359526"></p>
<h2 id="ç»ƒä¹ é¢˜2-8-å¡«å†™ä¸‹è¡¨-ç»™å‡ºä½å‘é‡çš„å¸ƒå°”è¿ç®—çš„æ±‚å€¼ç»“æœã€‚"><a href="#ç»ƒä¹ é¢˜2-8-å¡«å†™ä¸‹è¡¨-ç»™å‡ºä½å‘é‡çš„å¸ƒå°”è¿ç®—çš„æ±‚å€¼ç»“æœã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.8 å¡«å†™ä¸‹è¡¨,ç»™å‡ºä½å‘é‡çš„å¸ƒå°”è¿ç®—çš„æ±‚å€¼ç»“æœã€‚"></a>ç»ƒä¹ é¢˜2.8 å¡«å†™ä¸‹è¡¨,ç»™å‡ºä½å‘é‡çš„å¸ƒå°”è¿ç®—çš„æ±‚å€¼ç»“æœã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011194044827.png" alt="image-20221011194044827"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">è¿ç®—</th>
<th style="text-align:center">ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">a</td>
<td style="text-align:center">[01101001]</td>
</tr>
<tr>
<td style="text-align:center">b</td>
<td style="text-align:center">[01010101]</td>
</tr>
<tr>
<td style="text-align:center">~a</td>
<td style="text-align:center">[10010110]</td>
</tr>
<tr>
<td style="text-align:center">~b</td>
<td style="text-align:center">[10101010]</td>
</tr>
<tr>
<td style="text-align:center">a&amp;b</td>
<td style="text-align:center">[01000001]</td>
</tr>
<tr>
<td style="text-align:center">a\</td>
<td style="text-align:center">b</td>
<td>[01111101]</td>
</tr>
<tr>
<td style="text-align:center">a^b</td>
<td style="text-align:center">[00111100]</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-9"><a href="#ç»ƒä¹ é¢˜2-9" class="headerlink" title="ç»ƒä¹ é¢˜2.9"></a>ç»ƒä¹ é¢˜2.9</h2><p>é€šè¿‡æ··åˆä¸‰ç§ä¸åŒé¢œè‰²çš„å…‰(çº¢è‰²ã€ç»¿è‰²å’Œè“è‰²),è®¡ç®—æœºå¯ä»¥åœ¨è§†é¢‘å± å¹•æˆ–è€…æ¶²æ™¶æ˜¾ç¤ºå™¨ä¸Šäº§ç”Ÿå½©è‰²çš„ç”»é¢ã€‚è®¾æƒ³ä¸€ç§ç®€å•çš„æ–¹æ³•,ä½¿ç”¨ä¸‰ç§ä¸åŒé¢œè‰²çš„ å…‰,æ¯ç§å…‰éƒ½èƒ½æ‰“å¼€æˆ–å…³é—­,æŠ•å°„åˆ°ç»ç’ƒå±å¹•ä¸Š,å¦‚å›¾æ‰€ç¤º:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011194841837.png" alt="image-20221011194841837"></p>
<p>é‚£ä¹ˆåŸºäºå…‰æºR(çº¢)ã€ G(ç»¿)ã€ B(è“)çš„å…³é—­(0)æˆ–æ‰“å¼€(1),æˆ‘ä»¬å°±èƒ½å¤Ÿåˆ›å»º8 ç§ä¸åŒçš„é¢œè‰²:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011195958415.png" alt="image-20221011195958415"></p>
<p>è¿™äº›é¢œè‰²ä¸­çš„æ¯ä¸€ç§éƒ½èƒ½ç”¨ä¸€ä¸ªé•¿åº¦ä¸º3çš„ä½å‘é‡æ¥è¡¨ç¤º,æˆ‘ä»¬å¯ä»¥å¯¹å®ƒä»¬è¿›è¡Œå¸ƒå°”è¿ç®—ã€‚</p>
<p>A.ä¸€ç§é¢œè‰²çš„è¡¥æ˜¯é€šè¿‡å…³æ‰æ‰“å¼€çš„å…‰æº,ä¸”æ‰“å¼€å…³é—­çš„å…‰æºè€Œå½¢æˆçš„ã€‚é‚£ä¹ˆä¸Šé¢åˆ— å‡ºçš„8ç§é¢œè‰²æ¯ä¸€ç§çš„è¡¥æ˜¯ä»€ä¹ˆ?</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åŸé¢œè‰²</th>
<th style="text-align:center">ä»£ç </th>
<th style="text-align:center">è¡¥ç </th>
<th style="text-align:center">è¡¥é¢œè‰²</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">é»‘è‰²</td>
<td style="text-align:center">000</td>
<td style="text-align:center">111</td>
<td style="text-align:center">ç™½è‰²</td>
</tr>
<tr>
<td style="text-align:center">è“è‰²</td>
<td style="text-align:center">001</td>
<td style="text-align:center">110</td>
<td style="text-align:center">é»„è‰²</td>
</tr>
<tr>
<td style="text-align:center">ç»¿è‰²</td>
<td style="text-align:center">010</td>
<td style="text-align:center">101</td>
<td style="text-align:center">çº¢ç»¿è‰²</td>
</tr>
<tr>
<td style="text-align:center">è“ç»¿è‰²</td>
<td style="text-align:center">011</td>
<td style="text-align:center">100</td>
<td style="text-align:center">çº¢è‰²</td>
</tr>
<tr>
<td style="text-align:center">çº¢è‰²</td>
<td style="text-align:center">100</td>
<td style="text-align:center">111</td>
<td style="text-align:center">è“ç»¿è‰²</td>
</tr>
<tr>
<td style="text-align:center">çº¢ç´«è‰²</td>
<td style="text-align:center">101</td>
<td style="text-align:center">010</td>
<td style="text-align:center">ç»¿è‰²</td>
</tr>
<tr>
<td style="text-align:center">é»„è‰²</td>
<td style="text-align:center">110</td>
<td style="text-align:center">001</td>
<td style="text-align:center">è“è‰²</td>
</tr>
<tr>
<td style="text-align:center">ç™½è‰²</td>
<td style="text-align:center">111</td>
<td style="text-align:center">000</td>
<td style="text-align:center">é»‘è‰²</td>
</tr>
</tbody>
</table>
</div>
<p>B.æè¿°ä¸‹åˆ—é¢œè‰²åº”ç”¨å¸ƒå°”è¿ç®—çš„ç»“æœ:</p>
<p>è“è‰² | ç»¿è‰² =  (001 | 010) = 011 = è“ç»¿è‰²</p>
<p>é»„è‰² &amp; è“ç»¿è‰² =  (110 &amp; 011) = 010 = ç»¿è‰²</p>
<p>çº¢è‰² ^ çº¢ç´«è‰² =  (100 ^ 101) = 001 = è“è‰²</p>
<h2 id="ç»ƒä¹ é¢˜2-10-å¯¹äºä»»ä¸€ä½å‘é‡a-æœ‰a-a-0åº”ç”¨è¿™ä¸€å±æ€§-è€ƒè™‘ä¸‹é¢çš„ç¨‹åº"><a href="#ç»ƒä¹ é¢˜2-10-å¯¹äºä»»ä¸€ä½å‘é‡a-æœ‰a-a-0åº”ç”¨è¿™ä¸€å±æ€§-è€ƒè™‘ä¸‹é¢çš„ç¨‹åº" class="headerlink" title="ç»ƒä¹ é¢˜2.10 å¯¹äºä»»ä¸€ä½å‘é‡a,æœ‰a^a=0åº”ç”¨è¿™ä¸€å±æ€§,è€ƒè™‘ä¸‹é¢çš„ç¨‹åº:"></a>ç»ƒä¹ é¢˜2.10 å¯¹äºä»»ä¸€ä½å‘é‡a,æœ‰a^a=0åº”ç”¨è¿™ä¸€å±æ€§,è€ƒè™‘ä¸‹é¢çš„ç¨‹åº:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">inplace_swap</span><span class="params">(<span class="type">int</span> *x, <span class="type">int</span> *y)</span></span><br><span class="line">&#123;</span><br><span class="line">    *y = *x ^ *y; <span class="comment">/* Step 1 */</span></span><br><span class="line">    *x = *x ^ *y; <span class="comment">/* Step 2 */</span></span><br><span class="line">    *y = *x ^ *y; <span class="comment">/* Step 3 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­£å¦‚ç¨‹åºåå­—æ‰€æš—ç¤ºçš„é‚£æ ·,æˆ‘ä»¬è®¤ä¸ºè¿™ä¸ªè¿‡ç¨‹çš„æ•ˆæœæ˜¯äº¤æ¢æŒ‡é’ˆå˜é‡xå’Œyæ‰€æŒ‡å‘ çš„å­˜å‚¨ä½ç½®å¤„å­˜æ”¾çš„å€¼ã€‚æ³¨æ„,ä¸é€šå¸¸çš„äº¤æ¢ä¸¤ä¸ªæ•°å€¼çš„æŠ€æœ¯ä¸ä¸€æ ·,å½“ç§»åŠ¨ä¸€ä¸ªå€¼ æ—¶,æˆ‘ä»¬ä¸éœ€è¦ç¬¬ä¸‰ä¸ªä½ç½®æ¥ä¸´æ—¶å­˜å‚¨å¦ä¸€ä¸ªå€¼ã€‚è¿™ç§äº¤æ¢æ–¹å¼å¹¶æ²¡æœ‰æ€§èƒ½ä¸Šçš„ä¼˜ åŠ¿,å®ƒä»…ä»…æ˜¯ä¸€ä¸ªæ™ºåŠ›æ¸¸æ®‹ã€‚</p>
<p>ä»¥æŒ‡é’ˆxå’ŒyæŒ‡å‘çš„ä½ç½®å­˜å‚¨çš„å€¼åˆ†åˆ«æ˜¯Î±å’Œ6ä½œä¸ºå¼€å§‹,å¡«å†™ä¸‹è¡¨,ç»™å‡ºåœ¨ç¨‹åºçš„ æ¯ä¸€æ­¥ä¹‹å,å­˜å‚¨åœ¨è¿™ä¸¤ä¸ªä½ç½®ä¸­çš„å€¼ã€‚åˆ©ç”¨^çš„å±æ€§è¯æ˜è¾¾åˆ°äº†æ‰€å¸Œæœ›çš„æ•ˆæœã€‚å› æƒ³ä¸€ä¸‹,æ¯ä¸ªå…ƒç´ å°±æ˜¯å®ƒè‡ªèº«çš„åŠ æ³•é€†å…ƒ(a^a=0)ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221011201114181.png" alt="image-20221011201114181"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ­¥éª¤</th>
<th style="text-align:center">*x</th>
<th style="text-align:center">*y</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åˆå§‹</td>
<td style="text-align:center">a</td>
<td style="text-align:center">b</td>
</tr>
<tr>
<td style="text-align:center">ç¬¬1æ­¥</td>
<td style="text-align:center">a</td>
<td style="text-align:center">a^b</td>
</tr>
<tr>
<td style="text-align:center">ç¬¬2æ­¥</td>
<td style="text-align:center">a\^a\^b=b</td>
<td style="text-align:center">a^b</td>
</tr>
<tr>
<td style="text-align:center">ç¬¬3æ­¥</td>
<td style="text-align:center">b</td>
<td style="text-align:center">b\^a\^b=a</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-11åœ¨ç»ƒä¹ é¢˜2-10ä¸­çš„inplace-swapå‡½æ•°çš„åŸºç¡€ä¸Š-ä½ å†³å®šå†™ä¸€æ®µä»£ç -å®ç°å°†ä¸€ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ å¤´å°¾ä¸¤ç«¯ä¾æ¬¡å¯¹è°ƒã€‚ä½ å†™å‡ºä¸‹é¢è¿™ä¸ªå‡½æ•°"><a href="#ç»ƒä¹ é¢˜2-11åœ¨ç»ƒä¹ é¢˜2-10ä¸­çš„inplace-swapå‡½æ•°çš„åŸºç¡€ä¸Š-ä½ å†³å®šå†™ä¸€æ®µä»£ç -å®ç°å°†ä¸€ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ å¤´å°¾ä¸¤ç«¯ä¾æ¬¡å¯¹è°ƒã€‚ä½ å†™å‡ºä¸‹é¢è¿™ä¸ªå‡½æ•°" class="headerlink" title="ç»ƒä¹ é¢˜2.11åœ¨ç»ƒä¹ é¢˜2.10ä¸­çš„inplace_swapå‡½æ•°çš„åŸºç¡€ä¸Š,ä½ å†³å®šå†™ä¸€æ®µä»£ç , å®ç°å°†ä¸€ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ å¤´å°¾ä¸¤ç«¯ä¾æ¬¡å¯¹è°ƒã€‚ä½ å†™å‡ºä¸‹é¢è¿™ä¸ªå‡½æ•°:"></a>ç»ƒä¹ é¢˜2.11åœ¨ç»ƒä¹ é¢˜2.10ä¸­çš„inplace_swapå‡½æ•°çš„åŸºç¡€ä¸Š,ä½ å†³å®šå†™ä¸€æ®µä»£ç , å®ç°å°†ä¸€ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ å¤´å°¾ä¸¤ç«¯ä¾æ¬¡å¯¹è°ƒã€‚ä½ å†™å‡ºä¸‹é¢è¿™ä¸ªå‡½æ•°:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">reverse_array</span><span class="params">(<span class="type">int</span> a[], <span class="type">int</span> cnt)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> first, last;</span><br><span class="line">    <span class="keyword">for</span> (first = <span class="number">0</span>, last = cnt - <span class="number">1</span>; first &lt;= last; first++, last--)</span><br><span class="line">    &#123;</span><br><span class="line">        inplace_swap(&amp;a[first], &amp;a[last]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä½ å¯¹ä¸€ä¸ªåŒ…å«å…ƒç´ 1ã€ 2ã€ 3å’Œ4çš„æ•°çº½ä½¿ç”¨è¿™ä¸ªå‡½æ•°æ—¶,æ­£å¦‚é¢„æœŸçš„é‚£æ ·,ç°åœ¨æ•° çº½çš„å…ƒç´ å˜æˆäº†4ã€3ã€2å’Œ1ã€‚ä¸è¿‡,å½“ä½ å¯¹ä¸€ä¸ªåŒ…å«å…ƒç´ 1ã€2ã€3ã€4å’Œ5çš„æ•°çº½ä½¿ ç”¨è¿™ä¸ªå‡½æ•°æ—¶,ä½ ä¼šå¾ˆæƒŠå¥‡åœ°çœ‹åˆ°å¾—åˆ°æ•°å­—çš„å…ƒç´ ä¸º5ã€ 4ã€0ã€ 2å’Œ1ã€‚å®é™…ä¸Š,ä½ ä¼š å‘ç°è¿™æ®µä»£ç å¯¹æ‰€æœ‰å¶æ•°é•¿åº¦çš„æ•°ç»„éƒ½èƒ½æ­£ç¡®åœ°å·¥ä½œ,ä½†æ˜¯å½“æ•°ç»„çš„é•¿åº¦ä¸ºå¥‡æ•°æ—¶, å®ƒå°±ä¼šæŠŠä¸­é—´çš„å…ƒç´ è®¾ç½®æˆ0ã€‚</p>
<p>A.å¯¹äºä¸€ä¸ªé•¿åº¦ä¸ºå¥‡æ•°çš„æ•°çº½,é•¿åº¦cnt=2k+1,å‡½æ•°<code>reverse_array</code>æœ€åä¸€æ¬¡å¾ªç¯ä¸­,å˜é‡firstå’ŒIastçš„å€¼åˆ†åˆ«æ˜¯ä»€ä¹ˆ?</p>
<p>æœ€åä¸€æ¬¡å¾ªç¯æ—¶ï¼Œå˜é‡first = a[k]ï¼Œlast = a[k]ã€‚</p>
<p>B.ä¸ºä»€ä¹ˆè¿™æ—¶è°ƒç”¨å‡½æ•°<code>inplace_swap</code>ä¼šå°†æ•°ç»„å…ƒç´ è®¾ç½®ä¸º0?</p>
<p>å› ä¸ºæœ€åä¸€æ¬¡å¾ªç¯æ—¶ï¼Œå˜é‡first = a[k]ï¼Œlast = a[k]ã€‚ä»–ä»¬ä¹‹é—´è¿›è¡Œ<code>inplace_swap</code></p>
<p>ç¬¬ä¸€æ­¥ <em>y = </em>x ^ *y; æ›¿æ¢ä¹‹åa[k] = a[k] ^ a[k] =0;</p>
<p>ç¬¬äºŒæ­¥<em>x = </em>x ^ *y; æ›¿æ¢ä¹‹åa[k] = 0 ^ 0 =0;</p>
<p>ç¬¬äºŒæ­¥<em>y = </em>x ^ *y; æ›¿æ¢ä¹‹åa[k] = 0 ^ 0 =0;</p>
<p>C.å¯¹<code>reverse_array</code>çš„ä»£ç åšå“ªäº›ç­’å•æ”¹åŠ¨å°±èƒ½æ¶ˆé™¤è¿™ä¸ªé—®é¢˜?</p>
<p>åªéœ€è¦å°†<code>first &lt;= last</code>æ”¹ä¸º<code>first &lt; last</code>å³å¯</p>
<h2 id="ç»ƒä¹ é¢˜2-12-å¯¹äºä¸‹é¢çš„å€¼-å†™å‡ºå˜é‡xçš„Cè¯­è¨€è¡¨è¾¾å¼ã€‚"><a href="#ç»ƒä¹ é¢˜2-12-å¯¹äºä¸‹é¢çš„å€¼-å†™å‡ºå˜é‡xçš„Cè¯­è¨€è¡¨è¾¾å¼ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.12 å¯¹äºä¸‹é¢çš„å€¼,å†™å‡ºå˜é‡xçš„Cè¯­è¨€è¡¨è¾¾å¼ã€‚"></a>ç»ƒä¹ é¢˜2.12 å¯¹äºä¸‹é¢çš„å€¼,å†™å‡ºå˜é‡xçš„Cè¯­è¨€è¡¨è¾¾å¼ã€‚</h2><p>ä½ çš„ä»£ç åº”è¯¥å¯¹ä»»ä½•å­— é•¿$w\geq8$éƒ½èƒ½å·¥ä½œã€‚æˆ‘ä»¬ç»™å‡ºäº†å½“x=0x87654321ä»¥åŠ$w=32$æ—¶è¡¨è¾¾å¼æ±‚å€¼çš„ç»“æœ, ä»…ä¾›å‚è€ƒã€‚</p>
<p>A. xçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚,å…¶ä»–ä½å‡ç½®ä¸º0ã€‚[0x00000021]ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x &amp; 0xFF</span><br></pre></td></tr></table></figure>
<p>B.é™¤äº†xçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚å¤–,å…¶ä»–çš„ä½éƒ½å–è¡¥,æœ€ä½æœ‰æ•ˆå­—èŠ‚ä¿æŒä¸å˜ã€‚ [0x789ABC21]ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">~(x ^ 0xFF)æˆ–è€…x ^ (~0xFF)</span><br></pre></td></tr></table></figure>
<p>C.xçš„æœ€ä½æœ‰æ•ˆå­—èŠ‚è®¾ç½®æˆå…¨1ï¼Œå…¶ä»–å­—èŠ‚éƒ½ä¿æŒä¸å˜ã€‚[0x876543FF]ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">x | 0xFF</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-13"><a href="#ç»ƒä¹ é¢˜2-13" class="headerlink" title="ç»ƒä¹ é¢˜2.13"></a>ç»ƒä¹ é¢˜2.13</h2><p>ä»20ä¸–çºª70å¹´ä»£æœ«åˆ°80å¹´ä»£æœ«ï¼ŒDigital Equipmentçš„ VAXè®¡ç®—æœºæ˜¯ä¸€ç§éå¸¸æµè¡Œçš„æœºå‹ã€‚å®ƒæ²¡æœ‰å¸ƒå°”è¿ç®—AND å’ŒORæŒ‡ä»¤ï¼Œåªæœ‰bis(ä½è®¾ç½®)å’Œbic(ä½æ¸…é™¤)è¿™ä¸¤ç§æŒ‡ä»¤ã€‚ä¸¤ç§æŒ‡ä»¤çš„è¾“å…¥éƒ½æ˜¯ä¸€ä¸ªæ•°æ®å­—xå’Œä¸€ä¸ªæ©ç å­—mã€‚å®ƒä»¬ç”Ÿæˆä¸€ä¸ªç»“æœzï¼Œzæ˜¯ç”±æ ¹æ®æ©ç mçš„ä½æ¥ä¿®æ”¹xçš„ä½å¾—åˆ°çš„ã€‚ä½¿ç”¨bis æŒ‡ä»¤ï¼Œè¿™ç§ä¿®æ”¹å°±æ˜¯åœ¨mä¸º1çš„æ¯ä¸ªä½ç½®ä¸Šï¼Œå°†zå¯¹åº”çš„ä½è®¾ç½®ä¸º1ã€‚ä½¿ç”¨bicæŒ‡ä»¤ï¼Œè¿™ç§ä¿®æ”¹å°±æ˜¯åœ¨mä¸º1çš„æ¯ä¸ªä½ç½®ï¼Œå°†zå¯¹åº”çš„ä½è®¾ç½®ä¸º0ã€‚</p>
<p>ä¸ºäº†çœ‹æ¸…æ¥šè¿™äº›è¿ç®—ä¸Cè¯­è¨€ä½çº§è¿ç®—çš„å…³ç³»ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªå‡½æ•°biså’Œ bicæ¥å®ç°ä½è®¾ç½®å’Œä½æ¸…é™¤æ“ä½œã€‚åªæƒ³ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½•å…¶ä»–Cè¯­è¨€è¿ç®—ï¼Œæ¥å®ç°æŒ‰ä½|å’Œ~è¿ç®—ã€‚å¡«å†™ä¸‹åˆ—ä»£ç ä¸­ç¼ºå¤±çš„ä»£ç ã€‚æç¤º:å†™å‡ºbiså’Œ bicè¿ç®—çš„Cè¯­è¨€è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bis</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> m)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">bic</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> m)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bool_or</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> result = bis(x, y);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bool_xor</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> result = bis(bic(x, y), bic(y, x));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-14-å‡è®¾xå’Œyçš„å­—èŠ‚å€¼åˆ†åˆ«ä¸º0x66å’Œ0x39ã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜å„ä¸ªCè¡¨è¾¾å¼çš„å­—èŠ‚å€¼ã€‚"><a href="#ç»ƒä¹ é¢˜2-14-å‡è®¾xå’Œyçš„å­—èŠ‚å€¼åˆ†åˆ«ä¸º0x66å’Œ0x39ã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜å„ä¸ªCè¡¨è¾¾å¼çš„å­—èŠ‚å€¼ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.14 å‡è®¾xå’Œyçš„å­—èŠ‚å€¼åˆ†åˆ«ä¸º0x66å’Œ0x39ã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜å„ä¸ªCè¡¨è¾¾å¼çš„å­—èŠ‚å€¼ã€‚"></a>ç»ƒä¹ é¢˜2.14 å‡è®¾xå’Œyçš„å­—èŠ‚å€¼åˆ†åˆ«ä¸º0x66å’Œ0x39ã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜å„ä¸ªCè¡¨è¾¾å¼çš„å­—èŠ‚å€¼ã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221013122941220.png" alt="image-20221013122941220"></p>
<p>0x66 = 0110 0110</p>
<p>0x39 = 0011 1001</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">è¡¨è¾¾å¼</th>
<th style="text-align:center">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">x &amp; y</td>
<td style="text-align:center">0110 0110 &amp; 0011 1001 = 0010 0000 = 0x20</td>
</tr>
<tr>
<td style="text-align:center">x \</td>
<td style="text-align:center">y</td>
<td>0110 0110 \</td>
<td>0011 1001 = 0111 1111 = 0x7F</td>
</tr>
<tr>
<td style="text-align:center">~x \</td>
<td style="text-align:center">~y</td>
<td>~0110 0110 \</td>
<td>~0011 1001 = 1001 1001 \</td>
<td>1100 0110 = 1101 1111 = 0xDF</td>
</tr>
<tr>
<td style="text-align:center">x &amp; !y</td>
<td style="text-align:center">0110 0110 &amp; !0011 1001 = 0110 0110 &amp; 0000 0000 = 0x00</td>
</tr>
<tr>
<td style="text-align:center">x &amp;&amp; y</td>
<td style="text-align:center">0x01</td>
</tr>
<tr>
<td style="text-align:center">x \</td>
<td style="text-align:center">\</td>
<td>y</td>
<td>0x01</td>
</tr>
<tr>
<td style="text-align:center">!x \</td>
<td style="text-align:center">\</td>
<td>!y</td>
<td>0x00</td>
</tr>
<tr>
<td style="text-align:center">x &amp;&amp; ~y</td>
<td style="text-align:center">0x01</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-15ï¸°åªä½¿ç”¨ä½çº§å’Œé€»è¾‘è¿ç®—ï¼Œç¼–å†™ä¸€ä¸ªCè¡¨è¾¾å¼ï¼Œå®ƒç­‰ä»·äºx-yã€‚æ¢å¥äº‘è¯´ï¼Œå½“xå’Œyç›¸ç­‰æ—¶å®ƒå°†è¿”å›1ï¼Œå¦åˆ™å°±è¿”å›0ã€‚"><a href="#ç»ƒä¹ é¢˜2-15ï¸°åªä½¿ç”¨ä½çº§å’Œé€»è¾‘è¿ç®—ï¼Œç¼–å†™ä¸€ä¸ªCè¡¨è¾¾å¼ï¼Œå®ƒç­‰ä»·äºx-yã€‚æ¢å¥äº‘è¯´ï¼Œå½“xå’Œyç›¸ç­‰æ—¶å®ƒå°†è¿”å›1ï¼Œå¦åˆ™å°±è¿”å›0ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.15ï¸°åªä½¿ç”¨ä½çº§å’Œé€»è¾‘è¿ç®—ï¼Œç¼–å†™ä¸€ä¸ªCè¡¨è¾¾å¼ï¼Œå®ƒç­‰ä»·äºx= =yã€‚æ¢å¥äº‘è¯´ï¼Œå½“xå’Œyç›¸ç­‰æ—¶å®ƒå°†è¿”å›1ï¼Œå¦åˆ™å°±è¿”å›0ã€‚"></a>ç»ƒä¹ é¢˜2.15ï¸°åªä½¿ç”¨ä½çº§å’Œé€»è¾‘è¿ç®—ï¼Œç¼–å†™ä¸€ä¸ªCè¡¨è¾¾å¼ï¼Œå®ƒç­‰ä»·äºx= =yã€‚æ¢å¥äº‘è¯´ï¼Œå½“xå’Œyç›¸ç­‰æ—¶å®ƒå°†è¿”å›1ï¼Œå¦åˆ™å°±è¿”å›0ã€‚</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!(x^y)</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-16"><a href="#ç»ƒä¹ é¢˜2-16" class="headerlink" title="ç»ƒä¹ é¢˜2.16"></a>ç»ƒä¹ é¢˜2.16</h2><p>å¡«å†™ä¸‹è¡¨ï¼Œå±•ç¤ºä¸åŒç§»ä½è¿ç®—å¯¹å•å­—èŠ‚æ•°çš„å½±å“ã€‚æ€è€ƒç§»ä½è¿ç®—çš„æœ€å¥½æ–¹å¼æ˜¯ä½¿ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºã€‚å°†æœ€åˆçš„å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶ï¼Œæ‰§è¡Œç§»ä½è¿ç®—ï¼Œç„¶åå†è½¬æ¢å›åå…­è¿›åˆ¶ã€‚æ¯ä¸ªç­”æ¡ˆéƒ½åº”è¯¥æ˜¯8ä¸ªäºŒè¿›åˆ¶æ•°å­—æˆ–è€…2ä¸ªåå…­è¿›åˆ¶æ•°å­—ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221013124953580.png" alt="image-20221013124953580"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">x</th>
<th style="text-align:center"></th>
<th style="text-align:center">x&lt;&lt;3</th>
<th style="text-align:center"></th>
<th style="text-align:center">x&gt;&gt;2(é€»è¾‘)</th>
<th style="text-align:center"></th>
<th style="text-align:center">x&gt;&gt;2(ç®—æœ¯)</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">äºŒè¿›åˆ¶</td>
<td style="text-align:center">äºŒè¿›åˆ¶</td>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">äºŒè¿›åˆ¶</td>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">äºŒè¿›åˆ¶</td>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
</tr>
<tr>
<td style="text-align:center">0xC3</td>
<td style="text-align:center">1100 0011</td>
<td style="text-align:center">0001 1000</td>
<td style="text-align:center">0x18</td>
<td style="text-align:center">0011 0000</td>
<td style="text-align:center">0x30</td>
<td style="text-align:center">1111 0000</td>
<td style="text-align:center">0xF0</td>
</tr>
<tr>
<td style="text-align:center">0x75</td>
<td style="text-align:center">0111 0101</td>
<td style="text-align:center">1010 1000</td>
<td style="text-align:center">0xA8</td>
<td style="text-align:center">0001 1101</td>
<td style="text-align:center">0x1D</td>
<td style="text-align:center">0001 1101</td>
<td style="text-align:center">0x1D</td>
</tr>
<tr>
<td style="text-align:center">0x87</td>
<td style="text-align:center">1000 0111</td>
<td style="text-align:center">0011 1000</td>
<td style="text-align:center">0x38</td>
<td style="text-align:center">0010 0001</td>
<td style="text-align:center">0x21</td>
<td style="text-align:center">1110 0001</td>
<td style="text-align:center">0xE1</td>
</tr>
<tr>
<td style="text-align:center">0x66</td>
<td style="text-align:center">0110 0110</td>
<td style="text-align:center">0011 0000</td>
<td style="text-align:center">0x30</td>
<td style="text-align:center">0001 1001</td>
<td style="text-align:center">0x19</td>
<td style="text-align:center">0001 1001</td>
<td style="text-align:center">0x19</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-17"><a href="#ç»ƒä¹ é¢˜2-17" class="headerlink" title="ç»ƒä¹ é¢˜2.17"></a>ç»ƒä¹ é¢˜2.17</h2><p>å‡è®¾w=4ï¼ˆå­—é•¿ä¸º4ï¼‰ï¼Œæˆ‘ä»¬èƒ½ç»™æ¯ä¸ªå¯èƒ½çš„åå…­è¿›åˆ¶æ•°å­—èµ‹äºˆä¸€ä¸ªæ•°å€¼ï¼Œå‡è®¾ç”¨ä¸€ä¸ªæ— ç¬¦å·æˆ–è€…è¡¥ç è¡¨ç¤ºã€‚è¯·æ ¹æ®è¿™äº›è¡¨ç¤ºï¼Œé€šè¿‡å†™å‡ºç­‰å¼(2.1)å’Œç­‰å¼(2.3)æ‰€ç¤ºçš„æ±‚å’Œå…¬å¼ä¸­çš„2çš„éé›¶æ¬¡å¹‚ï¼Œå¡«å†™ä¸‹è¡¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015120400005.png" alt="image-20221015120400005"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">x</th>
<th style="text-align:center"></th>
<th style="text-align:center">æ— ç¬¦å·(B2U(x))</th>
<th style="text-align:center">è¡¥ç (B2T(x))</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">äºŒè¿›åˆ¶</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">0xE</td>
<td style="text-align:center">1110</td>
<td style="text-align:center">14</td>
<td style="text-align:center">-2</td>
</tr>
<tr>
<td style="text-align:center">0x0</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">0x5</td>
<td style="text-align:center">0101</td>
<td style="text-align:center">5</td>
<td style="text-align:center">5</td>
</tr>
<tr>
<td style="text-align:center">0x8</td>
<td style="text-align:center">1000</td>
<td style="text-align:center">8</td>
<td style="text-align:center">-8</td>
</tr>
<tr>
<td style="text-align:center">0xD</td>
<td style="text-align:center">1101</td>
<td style="text-align:center">13</td>
<td style="text-align:center">-3</td>
</tr>
<tr>
<td style="text-align:center">0xF</td>
<td style="text-align:center">1111</td>
<td style="text-align:center">15</td>
<td style="text-align:center">-1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-18"><a href="#ç»ƒä¹ é¢˜2-18" class="headerlink" title="ç»ƒä¹ é¢˜2.18"></a>ç»ƒä¹ é¢˜2.18</h2><p>åœ¨ç¬¬3ç« ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç”±åæ±‡ç¼–å™¨ç”Ÿæˆçš„åˆ—è¡¨ï¼Œåæ±‡ç¼–å™¨æ˜¯ä¸€ç§å°†å¯æ‰§è¡Œç¨‹åºæ–‡ä»¶è½¬æ¢å›å¯è¯»æ€§æ›´å¥½çš„ASCIIç å½¢å¼çš„ç¨‹åºã€‚è¿™äº›æ–‡ä»¶åŒ…å«è®¸å¤šåå…­è¿›åˆ¶æ•°å­—ï¼Œéƒ½æ˜¯ç”¨å…¸å‹çš„è¡¥ç å½¢å¼æ¥è¡¨ç¤ºè¿™äº›å€¼ã€‚èƒ½å¤Ÿè®¤è¯†è¿™äº›æ•°å­—å¹¶ç†è§£å®ƒä»¬çš„æ„ä¹‰(ä¾‹å¦‚å®ƒä»¬æ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°)ï¼Œæ˜¯ä¸€é¡¹é‡è¦çš„æŠ€å·§ã€‚</p>
<p>åœ¨ä¸‹é¢çš„åˆ—è¡¨ä¸­ï¼Œå¯¹äºæ ‡å·ä¸ºAï½I(æ ‡è®°åœ¨å³è¾¹)çš„é‚£äº›è¡Œï¼Œå°†æŒ‡ä»¤å(subã€movå’Œadd)å³è¾¹æ˜¾ç¤ºçš„(32ä½è¡¥ç å½¢å¼è¡¨ç¤ºçš„)åå…­è¿›åˆ¶å€¼è½¬æ¢ä¸ºç­‰ä»·çš„åè¿›åˆ¶å€¼ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015122226429.png" alt="image-20221015122226429"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">32ä½è¡¥ç </th>
<th style="text-align:center">åè¿›åˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x2e0</td>
<td style="text-align:center">736</td>
</tr>
<tr>
<td style="text-align:center">0x58</td>
<td style="text-align:center">88</td>
</tr>
<tr>
<td style="text-align:center">0x28</td>
<td style="text-align:center">40</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">48</td>
</tr>
<tr>
<td style="text-align:center">0x78</td>
<td style="text-align:center">120</td>
</tr>
<tr>
<td style="text-align:center">0x88</td>
<td style="text-align:center">136</td>
</tr>
<tr>
<td style="text-align:center">0x1f8</td>
<td style="text-align:center">504</td>
</tr>
<tr>
<td style="text-align:center">0x8</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">0xc0</td>
<td style="text-align:center">192</td>
</tr>
<tr>
<td style="text-align:center">0x48</td>
<td style="text-align:center">72</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-19-åˆ©ç”¨ä½ è§£ç­”ç»ƒä¹ é¢˜2-17æ—¶å¡«å†™çš„è¡¨æ ¼ï¼Œå¡«å†™ä¸‹åˆ—æè¿°å‡½æ•°T2Uã€‚çš„è¡¨æ ¼ã€‚"><a href="#ç»ƒä¹ é¢˜2-19-åˆ©ç”¨ä½ è§£ç­”ç»ƒä¹ é¢˜2-17æ—¶å¡«å†™çš„è¡¨æ ¼ï¼Œå¡«å†™ä¸‹åˆ—æè¿°å‡½æ•°T2Uã€‚çš„è¡¨æ ¼ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.19 åˆ©ç”¨ä½ è§£ç­”ç»ƒä¹ é¢˜2.17æ—¶å¡«å†™çš„è¡¨æ ¼ï¼Œå¡«å†™ä¸‹åˆ—æè¿°å‡½æ•°T2Uã€‚çš„è¡¨æ ¼ã€‚"></a>ç»ƒä¹ é¢˜2.19 åˆ©ç”¨ä½ è§£ç­”ç»ƒä¹ é¢˜2.17æ—¶å¡«å†™çš„è¡¨æ ¼ï¼Œå¡«å†™ä¸‹åˆ—æè¿°å‡½æ•°T2Uã€‚çš„è¡¨æ ¼ã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015132301591.png" alt="image-20221015132301591"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">x</th>
<th style="text-align:center">T2U(x)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-8</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">-3</td>
<td style="text-align:center">13</td>
</tr>
<tr>
<td style="text-align:center">-2</td>
<td style="text-align:center">14</td>
</tr>
<tr>
<td style="text-align:center">-1</td>
<td style="text-align:center">15</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">5</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-20"><a href="#ç»ƒä¹ é¢˜2-20" class="headerlink" title="ç»ƒä¹ é¢˜2.20"></a>ç»ƒä¹ é¢˜2.20</h2><p>è¯·è¯´æ˜ç­‰å¼(2.5)æ˜¯å¦‚ä½•åº”ç”¨åˆ°è§£ç­”ç»ƒä¹ é¢˜2.19æ—¶ç”Ÿæˆçš„è¡¨æ ¼ä¸­çš„å„é¡¹çš„ã€‚åè¿‡æ¥çœ‹ï¼Œæˆ‘ä»¬å¸Œæœ›æ¨å¯¼å‡ºä¸€ä¸ªæ— ç¬¦å·æ•°$u$å’Œä¸ä¹‹å¯¹åº”çš„æœ‰ç¬¦å·æ•°$U2T_w(u)$ä¹‹é—´çš„å…³ç³»:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221019105712222.png" alt="image-20221019105712222"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221019110140819.png" alt="image-20221019110140819"></p>
<h2 id="ç»ƒä¹ é¢˜2-21-å‡è®¾åœ¨é‡‡ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šå¯¹è¿™äº›è¡¨è¾¾å¼æ±‚å€¼ï¼ŒæŒ‰ç…§å›¾2-19çš„æ ¼å¼å¡«å†™ä¸‹è¡¨ï¼Œæè¿°å¼ºåˆ¶ç±»å‹è½¬æ¢å’Œå…³ç³»è¿ç®—çš„ç»“æœã€‚"><a href="#ç»ƒä¹ é¢˜2-21-å‡è®¾åœ¨é‡‡ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šå¯¹è¿™äº›è¡¨è¾¾å¼æ±‚å€¼ï¼ŒæŒ‰ç…§å›¾2-19çš„æ ¼å¼å¡«å†™ä¸‹è¡¨ï¼Œæè¿°å¼ºåˆ¶ç±»å‹è½¬æ¢å’Œå…³ç³»è¿ç®—çš„ç»“æœã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.21 å‡è®¾åœ¨é‡‡ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šå¯¹è¿™äº›è¡¨è¾¾å¼æ±‚å€¼ï¼ŒæŒ‰ç…§å›¾2-19çš„æ ¼å¼å¡«å†™ä¸‹è¡¨ï¼Œæè¿°å¼ºåˆ¶ç±»å‹è½¬æ¢å’Œå…³ç³»è¿ç®—çš„ç»“æœã€‚"></a>ç»ƒä¹ é¢˜2.21 å‡è®¾åœ¨é‡‡ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šå¯¹è¿™äº›è¡¨è¾¾å¼æ±‚å€¼ï¼ŒæŒ‰ç…§å›¾2-19çš„æ ¼å¼å¡«å†™ä¸‹è¡¨ï¼Œæè¿°å¼ºåˆ¶ç±»å‹è½¬æ¢å’Œå…³ç³»è¿ç®—çš„ç»“æœã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015134013727.png" alt="image-20221015134013727"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">è¡¨è¾¾å¼</th>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">æ±‚å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-2147483647-1==2147483648U</td>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">-2147483647-1&lt;2147482647</td>
<td style="text-align:center">æœ‰ç¬¦å·</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">-2147483647-1U &lt; 2147483647</td>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">-2147483647-1&lt;-2147482647</td>
<td style="text-align:center">æœ‰ç¬¦å·</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">-2147483647-1U&lt;-2147482647</td>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-22-é€šè¿‡åº”ç”¨ç­‰å¼-2-3-ï¼Œè¡¨æ˜ä¸‹é¢æ¯ä¸ªä½å‘é‡éƒ½æ˜¯-5çš„è¡¥ç è¡¨ç¤ºã€‚"><a href="#ç»ƒä¹ é¢˜2-22-é€šè¿‡åº”ç”¨ç­‰å¼-2-3-ï¼Œè¡¨æ˜ä¸‹é¢æ¯ä¸ªä½å‘é‡éƒ½æ˜¯-5çš„è¡¥ç è¡¨ç¤ºã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.22 é€šè¿‡åº”ç”¨ç­‰å¼(2.3)ï¼Œè¡¨æ˜ä¸‹é¢æ¯ä¸ªä½å‘é‡éƒ½æ˜¯-5çš„è¡¥ç è¡¨ç¤ºã€‚"></a>ç»ƒä¹ é¢˜2.22 é€šè¿‡åº”ç”¨ç­‰å¼(2.3)ï¼Œè¡¨æ˜ä¸‹é¢æ¯ä¸ªä½å‘é‡éƒ½æ˜¯-5çš„è¡¥ç è¡¨ç¤ºã€‚</h2><p>A.[1011]</p>
<p>1011 =  -2^3+2+1 = -5</p>
<p>B.[11011]</p>
<p>11011 = -2\^4+2\^3+2+1 = -5</p>
<p>C.[111011]</p>
<p>111011 = -2\^5+2\^4+2\^3+2+1 = -5</p>
<h2 id="ç»ƒä¹ é¢˜2-23è€ƒè™‘ä¸‹é¢çš„Cå‡½æ•°"><a href="#ç»ƒä¹ é¢˜2-23è€ƒè™‘ä¸‹é¢çš„Cå‡½æ•°" class="headerlink" title="ç»ƒä¹ é¢˜2.23è€ƒè™‘ä¸‹é¢çš„Cå‡½æ•°"></a>ç»ƒä¹ é¢˜2.23è€ƒè™‘ä¸‹é¢çš„Cå‡½æ•°</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">funl</span><span class="params">(<span class="type">unsigned</span> word)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)((word &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun2</span><span class="params">(<span class="type">unsigned</span> word)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">int</span>)word &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å‡è®¾åœ¨ä¸€ä¸ªé‡‡ç”¨è¡¥ç è¿ç®—çš„æœºå™¨ä¸Šä»¥32ä½ç¨‹åºæ¥æ‰§è¡Œè¿™äº›å‡½æ•°ã€‚è¿˜å‡è®¾æœ‰ç¬¦å·æ•°å€¼çš„å³ç§»æ˜¯ç®—æœ¯å³ç§»ï¼Œè€Œæ— ç¬¦å·æ•°å€¼çš„å³ç§»æ˜¯é€»è¾‘å³ç§»ã€‚</p>
<p>A.å¡«å†™ä¸‹è¡¨ï¼Œè¯´æ˜è¿™äº›å‡½æ•°å¯¹å‡ ä¸ªç¤ºä¾‹å‚æ•°çš„ç»“æœã€‚ä½ ä¼šå‘ç°ç”¨åå…­è¿›åˆ¶è¡¨ç¤ºæ¥åšä¼šæ›´æ–¹ä¾¿ï¼Œåªè¦è®°ä½åå…­è¿›åˆ¶æ•°å­—8åˆ°Fçš„æœ€é«˜æœ‰æ•ˆä½ç­‰äº1ã€‚</p>
<p>å†™ä¸‹å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun1</span><span class="params">(<span class="type">unsigned</span> word)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">int</span>)((word &lt;&lt; <span class="number">24</span>) &gt;&gt; <span class="number">24</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fun2</span><span class="params">(<span class="type">unsigned</span> word)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="type">int</span>)(word &lt;&lt; <span class="number">24</span>)) &gt;&gt; <span class="number">24</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a1 = <span class="number">0x00000076</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a2 = <span class="number">0x87654321</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a3 = <span class="number">0x000000C9</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> a4 = <span class="number">0xEDCBA987</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun1(a1) %x,&quot;</span>, fun1(a1));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun2(a1) %x\n&quot;</span>, fun2(a1));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun1(a2) %x,&quot;</span>, fun1(a2));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun2(a2) %x\n&quot;</span>, fun2(a2));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun1(a3) %x,&quot;</span>, fun1(a3));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun2(a3) %x\n&quot;</span>, fun2(a3));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun1(a4) %x,&quot;</span>, fun1(a4));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fun2(a4) %x\n&quot;</span>, fun2(a4));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015213023031.png" alt="image-20221015213023031"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">w</th>
<th style="text-align:center">fun1(w)</th>
<th style="text-align:center">fun2(w)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x00000076</td>
<td style="text-align:center">0x00000076</td>
<td style="text-align:center">0x00000076</td>
</tr>
<tr>
<td style="text-align:center">0x87654321</td>
<td style="text-align:center">0x00000021</td>
<td style="text-align:center">0x00000021</td>
</tr>
<tr>
<td style="text-align:center">0x000000c9</td>
<td style="text-align:center">0x000000C9</td>
<td style="text-align:center">0xffffffC9</td>
</tr>
<tr>
<td style="text-align:center">0xEDCBA987</td>
<td style="text-align:center">0x00000087</td>
<td style="text-align:center">0xffffff87</td>
</tr>
</tbody>
</table>
</div>
<p>B.ç”¨è¯­è¨€æ¥æè¿°è¿™äº›å‡½æ•°æ‰§è¡Œçš„æœ‰ç”¨çš„è®¡ç®—ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-24-å‡è®¾å°†ä¸€ä¸ª4ä½æ•°å€¼-ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½Fè¡¨ç¤º-æˆªæ–­åˆ°ä¸€ä¸ª3ä½æ•°-ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½7è¡¨ç¤º-ã€‚å¡«å†™ä¸‹è¡¨ï¼Œæ ¹æ®é‚£äº›ä½æ¨¡å¼çš„æ— ç¬¦å·å’Œè¡¥ç è§£é‡Šï¼Œæ˜è¿™ç§æˆªæ–­å¯¹æŸäº›æƒ…å†µçš„ç»“æœã€‚"><a href="#ç»ƒä¹ é¢˜2-24-å‡è®¾å°†ä¸€ä¸ª4ä½æ•°å€¼-ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½Fè¡¨ç¤º-æˆªæ–­åˆ°ä¸€ä¸ª3ä½æ•°-ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½7è¡¨ç¤º-ã€‚å¡«å†™ä¸‹è¡¨ï¼Œæ ¹æ®é‚£äº›ä½æ¨¡å¼çš„æ— ç¬¦å·å’Œè¡¥ç è§£é‡Šï¼Œæ˜è¿™ç§æˆªæ–­å¯¹æŸäº›æƒ…å†µçš„ç»“æœã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.24 å‡è®¾å°†ä¸€ä¸ª4ä½æ•°å€¼(ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½Fè¡¨ç¤º)æˆªæ–­åˆ°ä¸€ä¸ª3ä½æ•°(ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½7è¡¨ç¤º)ã€‚å¡«å†™ä¸‹è¡¨ï¼Œæ ¹æ®é‚£äº›ä½æ¨¡å¼çš„æ— ç¬¦å·å’Œè¡¥ç è§£é‡Šï¼Œæ˜è¿™ç§æˆªæ–­å¯¹æŸäº›æƒ…å†µçš„ç»“æœã€‚"></a>ç»ƒä¹ é¢˜2.24 å‡è®¾å°†ä¸€ä¸ª4ä½æ•°å€¼(ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½Fè¡¨ç¤º)æˆªæ–­åˆ°ä¸€ä¸ª3ä½æ•°(ç”¨åå…­è¿›åˆ¶æ•°å­—0ï½7è¡¨ç¤º)ã€‚å¡«å†™ä¸‹è¡¨ï¼Œæ ¹æ®é‚£äº›ä½æ¨¡å¼çš„æ— ç¬¦å·å’Œè¡¥ç è§£é‡Šï¼Œæ˜è¿™ç§æˆªæ–­å¯¹æŸäº›æƒ…å†µçš„ç»“æœã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015213952945.png" alt="image-20221015213952945"></p>
<p>è§£é‡Šå¦‚ä½•å°†ç­‰å¼(2.9)å’Œç­‰å¼(2.10)åº”ç”¨åˆ°è¿™äº›ç¤ºä¾‹ä¸Šã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åå…­è¿›åˆ¶</th>
<th style="text-align:center"></th>
<th style="text-align:center">æ— ç¬¦å·</th>
<th style="text-align:center"></th>
<th style="text-align:center">è¡¥ç </th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åŸå§‹å€¼</td>
<td style="text-align:center">æˆªæ–­å€¼</td>
<td style="text-align:center">åŸå§‹å€¼</td>
<td style="text-align:center">æˆªæ–­å€¼</td>
<td style="text-align:center">åŸå§‹å€¼</td>
<td style="text-align:center">æˆªæ–­å€¼</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">1</td>
<td style="text-align:center">9</td>
<td style="text-align:center">1</td>
<td style="text-align:center">-7</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">B</td>
<td style="text-align:center">3</td>
<td style="text-align:center">11</td>
<td style="text-align:center">3</td>
<td style="text-align:center">-5</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">F</td>
<td style="text-align:center">7</td>
<td style="text-align:center">15</td>
<td style="text-align:center">7</td>
<td style="text-align:center">-1</td>
<td style="text-align:center">-1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-25è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼Œè¿™æ®µä»£ç è¯•å›¾è®¡ç®—æ•°ç»„aä¸­æ‰€æœ‰å…ƒç´ çš„å’Œï¼Œå…¶ä¸­å…ƒç´ çš„æ•°é‡ç”±å‚æ•°length-ç»™å‡ºã€‚"><a href="#ç»ƒä¹ é¢˜2-25è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼Œè¿™æ®µä»£ç è¯•å›¾è®¡ç®—æ•°ç»„aä¸­æ‰€æœ‰å…ƒç´ çš„å’Œï¼Œå…¶ä¸­å…ƒç´ çš„æ•°é‡ç”±å‚æ•°length-ç»™å‡ºã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.25è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼Œè¿™æ®µä»£ç è¯•å›¾è®¡ç®—æ•°ç»„aä¸­æ‰€æœ‰å…ƒç´ çš„å’Œï¼Œå…¶ä¸­å…ƒç´ çš„æ•°é‡ç”±å‚æ•°length ç»™å‡ºã€‚"></a>ç»ƒä¹ é¢˜2.25è€ƒè™‘ä¸‹åˆ—ä»£ç ï¼Œè¿™æ®µä»£ç è¯•å›¾è®¡ç®—æ•°ç»„aä¸­æ‰€æœ‰å…ƒç´ çš„å’Œï¼Œå…¶ä¸­å…ƒç´ çš„æ•°é‡ç”±å‚æ•°length ç»™å‡ºã€‚</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">float</span> <span class="title function_">sum_elements</span><span class="params">(<span class="type">float</span> a[], <span class="type">unsigned</span> length)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">float</span> result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= length - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        result += a[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“å‚æ•°lengthç­‰äº0æ—¶ï¼Œè¿è¡Œè¿™æ®µä»£ç åº”è¯¥è¿”å›0.0ã€‚ä½†å®é™…ä¸Šï¼Œè¿è¡Œæ—¶ä¼šé‡åˆ°ä¸€ä¸ªå†…å­˜é”™è¯¯ã€‚è¯·è§£é‡Šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™æ ·çš„æƒ…å†µï¼Œå¹¶ä¸”è¯´æ˜å¦‚ä½•ä¿®æ”¹ä»£ç ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015220734092.png" alt="image-20221015220734092"></p>
<p>åŸå› æ˜¯lengthçš„ç±»å‹æ˜¯unsigned ä½†æ˜¯1çš„ç±»å‹æ˜¯æ˜¯intï¼Œæ‰€ä»¥è®¡ç®—è½¬ä¸ºæ— ç¬¦å·æ•°è®¡ç®—ï¼Œlength - 1=length +ï¼ˆ- 1ï¼‰ï¼Œç°åœ¨çš„é—®é¢˜æ˜¯-1çš„æ— ç¬¦å·æ•°æ˜¯å¤šå°‘-1çš„åå…­è¿›åˆ¶æ— ç¬¦å·æ•°ä¸º0xFFFFFFFFæ¢ç®—ä¹‹åæ˜¯4294967295,æ‰€ä»¥ä»£ç å°±å‡ºç°äº†å¼‚å¸¸,forå¾ªç¯è¿›å»ä¹‹åæ•°ç»„ä¸‹æ ‡è¶Šç•Œã€‚åªéœ€è¦å°†unsigned æ”¹ä¸ºintå³å¯ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-26ç°åœ¨ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå†™ä¸€ä¸ªå‡½æ•°ç”¨æ¥åˆ¤å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¯”å¦ä¸€ä¸ªæ›´é•¿ã€‚å‰ææ˜¯ä½ è¦ç”¨å­—ç¬¦ä¸²åº“å‡½æ•°strlenï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹"><a href="#ç»ƒä¹ é¢˜2-26ç°åœ¨ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå†™ä¸€ä¸ªå‡½æ•°ç”¨æ¥åˆ¤å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¯”å¦ä¸€ä¸ªæ›´é•¿ã€‚å‰ææ˜¯ä½ è¦ç”¨å­—ç¬¦ä¸²åº“å‡½æ•°strlenï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹" class="headerlink" title="ç»ƒä¹ é¢˜2.26ç°åœ¨ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå†™ä¸€ä¸ªå‡½æ•°ç”¨æ¥åˆ¤å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¯”å¦ä¸€ä¸ªæ›´é•¿ã€‚å‰ææ˜¯ä½ è¦ç”¨å­—ç¬¦ä¸²åº“å‡½æ•°strlenï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹:"></a>ç»ƒä¹ é¢˜2.26ç°åœ¨ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå†™ä¸€ä¸ªå‡½æ•°ç”¨æ¥åˆ¤å®šä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯å¦æ¯”å¦ä¸€ä¸ªæ›´é•¿ã€‚å‰ææ˜¯ä½ è¦ç”¨å­—ç¬¦ä¸²åº“å‡½æ•°strlenï¼Œå®ƒçš„å£°æ˜å¦‚ä¸‹:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">strlen</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">strlonger</span><span class="params">(<span class="type">char</span> *s, <span class="type">char</span> *t)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strlen</span>(s) - <span class="built_in">strlen</span>(t) &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ä½ åœ¨ä¸€äº›ç¤ºä¾‹ä¸Šæµ‹è¯•è¿™ä¸ªå‡½æ•°æ—¶ï¼Œä¸€åˆ‡ä¼¼ä¹éƒ½æ˜¯æ­£ç¡®çš„ã€‚è¿›ä¸€æ­¥ç ”ç©¶å‘ç°åœ¨å¤´æ–‡ä»¶stdio.hä¸­æ•°æ®ç±»å‹size_tæ˜¯å®šä¹‰æˆunsigned intçš„ã€‚</p>
<p>A.åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‡½æ•°ä¼šäº§ç”Ÿä¸æ­£ç¡®çš„ç»“æœï¼Ÿ</p>
<p>å½“så­—ç¬¦ä¸²çš„é•¿åº¦strlen1å°äºtå­—ç¬¦ä¸²çš„é•¿åº¦strlen2æ—¶ã€‚</p>
<p>B.è§£é‡Šä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·ä¸æ­£ç¡®çš„ç»“æœ?</p>
<p>å½“så­—ç¬¦ä¸²çš„é•¿åº¦strlen1å°äºtå­—ç¬¦ä¸²çš„é•¿åº¦strlen2æ—¶ï¼Œstrlen1-strlen2åº”å½“æ˜¯è´Ÿæ•°ï¼Œä½†æ˜¯size_tæ˜¯æ— ç¬¦å·ï¼Œæ ¹æ®æ— ç¬¦å·æ•°çš„æ–¹å¼è§£é‡Šå™¨è¡¥ç ï¼Œè¿™ä¸ªè´Ÿæ•°æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„æ­£æ•°ã€‚ç„¶åæ­£æ•°æ˜¯å¤§äº0ï¼Œä¸ç­‰å¼æˆç«‹ï¼Œå‡½æ•°å°±ä¼šè¿”å›é€»è¾‘Trueã€‚</p>
<p>C.è¯´æ˜å¦‚ä½•ä¿®æ”¹è¿™æ®µä»£ç å¥½è®©å®ƒèƒ½å¯é åœ°å·¥ä½œã€‚</p>
<p>ä¿®æ”¹åçš„è¡¨è¾¾å¼ï¼šreturn strlen(s)&gt;strlen(t);</p>
<h2 id="ç»ƒä¹ é¢˜2-27-å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°"><a href="#ç»ƒä¹ é¢˜2-27-å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°" class="headerlink" title="ç»ƒä¹ é¢˜2.27 å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°:"></a>ç»ƒä¹ é¢˜2.27 å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">uadd_ok</span><span class="params">(<span class="type">unsigned</span> x,<span class="type">unsigned</span> y)</span> </span><br></pre></td></tr></table></figure>
<p>å¦‚æœå‚æ•°xå’Œyç›¸åŠ ä¸ä¼šäº§ç”Ÿæº¢å‡ºï¼Œè¿™ä¸ªå‡½æ•°å°±è¿”å›1ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">uadd_ok</span><span class="params">(<span class="type">unsigned</span> x,<span class="type">unsigned</span> y)</span> &#123;</span><br><span class="line">    <span class="type">unsigned</span> result = x + y;</span><br><span class="line">    <span class="keyword">return</span> result &gt;= x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-28æˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w-4çš„ä½æ¨¡å¼ã€‚å¯¹äºè¿™äº›æ•°å­—çš„æ— ç¬¦å·è§£é‡Šï¼Œä½¿ç”¨ç­‰å¼-2-12-å¡«å†™ä¸‹è¡¨ï¼Œç»™å‡ºæ‰€ç¤ºæ•°å­—çš„æ— ç¬¦å·åŠ æ³•é€†å…ƒçš„ä½è¡¨ç¤º-ç”¨åå…­è¿›åˆ¶å½¢å¼-ã€‚"><a href="#ç»ƒä¹ é¢˜2-28æˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w-4çš„ä½æ¨¡å¼ã€‚å¯¹äºè¿™äº›æ•°å­—çš„æ— ç¬¦å·è§£é‡Šï¼Œä½¿ç”¨ç­‰å¼-2-12-å¡«å†™ä¸‹è¡¨ï¼Œç»™å‡ºæ‰€ç¤ºæ•°å­—çš„æ— ç¬¦å·åŠ æ³•é€†å…ƒçš„ä½è¡¨ç¤º-ç”¨åå…­è¿›åˆ¶å½¢å¼-ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.28æˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w=4çš„ä½æ¨¡å¼ã€‚å¯¹äºè¿™äº›æ•°å­—çš„æ— ç¬¦å·è§£é‡Šï¼Œä½¿ç”¨ç­‰å¼(2.12)å¡«å†™ä¸‹è¡¨ï¼Œç»™å‡ºæ‰€ç¤ºæ•°å­—çš„æ— ç¬¦å·åŠ æ³•é€†å…ƒçš„ä½è¡¨ç¤º(ç”¨åå…­è¿›åˆ¶å½¢å¼)ã€‚"></a>ç»ƒä¹ é¢˜2.28æˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w=4çš„ä½æ¨¡å¼ã€‚å¯¹äºè¿™äº›æ•°å­—çš„æ— ç¬¦å·è§£é‡Šï¼Œä½¿ç”¨ç­‰å¼(2.12)å¡«å†™ä¸‹è¡¨ï¼Œç»™å‡ºæ‰€ç¤ºæ•°å­—çš„æ— ç¬¦å·åŠ æ³•é€†å…ƒçš„ä½è¡¨ç¤º(ç”¨åå…­è¿›åˆ¶å½¢å¼)ã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221015222427723.png" alt="image-20221015222427723"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">$x$</th>
<th style="text-align:center"></th>
<th style="text-align:center">$-^u_4x$</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">åè¿›åˆ¶</td>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">åè¿›åˆ¶</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">5</td>
<td style="text-align:center">B</td>
<td style="text-align:center">11</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">8</td>
<td style="text-align:center">8</td>
<td style="text-align:center">8</td>
</tr>
<tr>
<td style="text-align:center">D</td>
<td style="text-align:center">13</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">F</td>
<td style="text-align:center">15</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-29æŒ‰ç…§å›¾2-25çš„å½¢å¼å¡«å†™ä¸‹è¡¨ã€‚åˆ†åˆ«åˆ—å‡º5ä½å‚æ•°çš„æ•´æ•°å€¼ã€æ•´æ•°å’Œä¸è¡¥ç å’Œçš„æ•°å€¼ã€è¡¥ç å’Œçš„ä½çº§è¡¨ç¤ºï¼Œä»¥åŠå±äºç­‰å¼-2-13-æ¨å¯¼ä¸­çš„å“ªç§æƒ…å†µã€‚"><a href="#ç»ƒä¹ é¢˜2-29æŒ‰ç…§å›¾2-25çš„å½¢å¼å¡«å†™ä¸‹è¡¨ã€‚åˆ†åˆ«åˆ—å‡º5ä½å‚æ•°çš„æ•´æ•°å€¼ã€æ•´æ•°å’Œä¸è¡¥ç å’Œçš„æ•°å€¼ã€è¡¥ç å’Œçš„ä½çº§è¡¨ç¤ºï¼Œä»¥åŠå±äºç­‰å¼-2-13-æ¨å¯¼ä¸­çš„å“ªç§æƒ…å†µã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.29æŒ‰ç…§å›¾2-25çš„å½¢å¼å¡«å†™ä¸‹è¡¨ã€‚åˆ†åˆ«åˆ—å‡º5ä½å‚æ•°çš„æ•´æ•°å€¼ã€æ•´æ•°å’Œä¸è¡¥ç å’Œçš„æ•°å€¼ã€è¡¥ç å’Œçš„ä½çº§è¡¨ç¤ºï¼Œä»¥åŠå±äºç­‰å¼(2.13)æ¨å¯¼ä¸­çš„å“ªç§æƒ…å†µã€‚"></a>ç»ƒä¹ é¢˜2.29æŒ‰ç…§å›¾2-25çš„å½¢å¼å¡«å†™ä¸‹è¡¨ã€‚åˆ†åˆ«åˆ—å‡º5ä½å‚æ•°çš„æ•´æ•°å€¼ã€æ•´æ•°å’Œä¸è¡¥ç å’Œçš„æ•°å€¼ã€è¡¥ç å’Œçš„ä½çº§è¡¨ç¤ºï¼Œä»¥åŠå±äºç­‰å¼(2.13)æ¨å¯¼ä¸­çš„å“ªç§æƒ…å†µã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221016100641498.png" alt="image-20221016100641498"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">$x$</th>
<th style="text-align:center">$y$</th>
<th style="text-align:center">$x+y$</th>
<th style="text-align:center">$x+^t_5y$</th>
<th style="text-align:center">æƒ…å†µ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[10100] -12</td>
<td style="text-align:center">[10001] -15</td>
<td style="text-align:center">[100101] -27</td>
<td style="text-align:center">[00101] 5</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">[11000] -8</td>
<td style="text-align:center">[11000] -8</td>
<td style="text-align:center">[110000] -16</td>
<td style="text-align:center">[10000] -16</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">[10111] -9</td>
<td style="text-align:center">[01000] 8</td>
<td style="text-align:center">[11111] -1</td>
<td style="text-align:center">[11111] -1</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">[00010] 2</td>
<td style="text-align:center">[00101] 5</td>
<td style="text-align:center">[00111] 7</td>
<td style="text-align:center">[00111] 7</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">[01100] 12</td>
<td style="text-align:center">[00100] 4</td>
<td style="text-align:center">[10000] 16</td>
<td style="text-align:center">[10000] -16</td>
<td style="text-align:center">-16</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-30å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°"><a href="#ç»ƒä¹ é¢˜2-30å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°" class="headerlink" title="ç»ƒä¹ é¢˜2.30å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°:"></a>ç»ƒä¹ é¢˜2.30å†™å‡ºä¸€ä¸ªå…·æœ‰å¦‚ä¸‹åŸå‹çš„å‡½æ•°:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Determine whether arguments can be added without overflow */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tadd_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span>;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå‚æ•°xå’Œyç›¸åŠ ä¸ä¼šäº§ç”Ÿæº¢å‡ºï¼Œè¿™ä¸ªå‡½æ•°å°±è¿”å›1ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tadd_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> s = x + y;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; <span class="number">0</span> &amp;&amp; y &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> s &gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span> &amp;&amp; y &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> s &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-31ä½ çš„åŒäº‹å¯¹ä½ è¡¥ç åŠ æ³•æº¢å‡ºæ¡ä»¶çš„åˆ†ææœ‰äº›ä¸è€çƒ¦äº†ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªå‡½æ•°tadd-okçš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤º"><a href="#ç»ƒä¹ é¢˜2-31ä½ çš„åŒäº‹å¯¹ä½ è¡¥ç åŠ æ³•æº¢å‡ºæ¡ä»¶çš„åˆ†ææœ‰äº›ä¸è€çƒ¦äº†ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªå‡½æ•°tadd-okçš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤º" class="headerlink" title="ç»ƒä¹ é¢˜2.31ä½ çš„åŒäº‹å¯¹ä½ è¡¥ç åŠ æ³•æº¢å‡ºæ¡ä»¶çš„åˆ†ææœ‰äº›ä¸è€çƒ¦äº†ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªå‡½æ•°tadd_okçš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤º:"></a>ç»ƒä¹ é¢˜2.31ä½ çš„åŒäº‹å¯¹ä½ è¡¥ç åŠ æ³•æº¢å‡ºæ¡ä»¶çš„åˆ†ææœ‰äº›ä¸è€çƒ¦äº†ï¼Œä»–ç»™å‡ºäº†ä¸€ä¸ªå‡½æ•°tadd_okçš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤º:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// determin whether arguments can be added without overflow</span></span><br><span class="line"><span class="comment">// WARNING: THIS code is buggy</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tadd_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> sum = x + y;</span><br><span class="line">    <span class="keyword">return</span> (sum - x == y) &amp;&amp; (sum - y == x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½ çœ‹äº†ä»£ç ä»¥åç¬‘äº†ã€‚è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆã€‚</p>
<p>å› ä¸ºsum-xä¸yæ˜¯æ’ç›¸ç­‰çš„ã€‚</p>
<p>å‡è®¾intçš„wæ˜¯4ï¼Œå³å­—é•¿ä¸º4ï¼Œå¹¶ä¸”sum=x+yå‘ç”Ÿæ­£æº¢å‡ºï¼ˆx&gt;0,y&gt;0,sum&lt;=0ï¼‰ã€‚é‚£ä¹ˆsum = x+y-16ã€‚</p>
<p>sum-x = x+y-16-x = y-16ã€‚å› ä¸ºå­—é•¿æ˜¯4ï¼Œå¹¶ä¸”y&gt;0 ï¼Œæ‰€ä»¥y = y-16æ˜¯æ’ç­‰çš„ã€‚ä¹Ÿå°±æ˜¯è¯´sum-x=yæ˜¯æ°¸è¿œæˆç«‹çš„ã€‚</p>
<p>åŒç†å¯ä»¥å¾—å‡ºè´Ÿæº¢å‡ºçš„æƒ…å†µã€‚æ‰€ä»¥å°±ç®—ä¸€ç°‡ä¸Šè¿°ä»£ç ä¹Ÿä¸ä¼šè¿”å›0ï¼Œä»£ç æ˜¯é”™è¯¯çš„ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-32ä½ ç°åœ¨æœ‰ä¸ªä»»åŠ¡ï¼Œç¼–å†™å‡½æ•°tsub-ok-çš„ä»£ç ï¼Œå‡½æ•°çš„å‚æ•°æ˜¯xå’Œyï¼Œå¦‚æœè®¡ç®—x-yä¸äº§ç”Ÿæº¢å‡ºï¼Œå‡½æ•°å°±è¿”å›1ã€‚å‡è®¾ä½ å†™çš„ç»ƒä¹ é¢˜2-30çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º"><a href="#ç»ƒä¹ é¢˜2-32ä½ ç°åœ¨æœ‰ä¸ªä»»åŠ¡ï¼Œç¼–å†™å‡½æ•°tsub-ok-çš„ä»£ç ï¼Œå‡½æ•°çš„å‚æ•°æ˜¯xå’Œyï¼Œå¦‚æœè®¡ç®—x-yä¸äº§ç”Ÿæº¢å‡ºï¼Œå‡½æ•°å°±è¿”å›1ã€‚å‡è®¾ä½ å†™çš„ç»ƒä¹ é¢˜2-30çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º" class="headerlink" title="ç»ƒä¹ é¢˜2.32ä½ ç°åœ¨æœ‰ä¸ªä»»åŠ¡ï¼Œç¼–å†™å‡½æ•°tsub_ok çš„ä»£ç ï¼Œå‡½æ•°çš„å‚æ•°æ˜¯xå’Œyï¼Œå¦‚æœè®¡ç®—x-yä¸äº§ç”Ÿæº¢å‡ºï¼Œå‡½æ•°å°±è¿”å›1ã€‚å‡è®¾ä½ å†™çš„ç»ƒä¹ é¢˜2.30çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º:"></a>ç»ƒä¹ é¢˜2.32ä½ ç°åœ¨æœ‰ä¸ªä»»åŠ¡ï¼Œç¼–å†™å‡½æ•°tsub_ok çš„ä»£ç ï¼Œå‡½æ•°çš„å‚æ•°æ˜¯xå’Œyï¼Œå¦‚æœè®¡ç®—x-yä¸äº§ç”Ÿæº¢å‡ºï¼Œå‡½æ•°å°±è¿”å›1ã€‚å‡è®¾ä½ å†™çš„ç»ƒä¹ é¢˜2.30çš„ä»£ç å¦‚ä¸‹æ‰€ç¤º:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tsub_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tadd_ok(x, -y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xå’Œyå–ä»€ä¹ˆå€¼æ—¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šäº§ç”Ÿé”™è¯¯çš„ç»“æœ?å†™ä¸€ä¸ªè¯¥å‡½æ•°çš„æ­£ç¡®ç‰ˆæœ¬(å®¶åº­ä½œä¸š2.74)ã€‚</p>
<p>å½“y = INT_MINæ—¶ä¼šå‘ç”Ÿé”™è¯¯ã€‚</p>
<p>åœ¨è®¡ç®—æœºå½“ä¸­ï¼Œy = INT_MINæ—¶ï¼Œ-y = INT_MINï¼ˆä¼šå‘ç”Ÿæº¢å‡ºï¼‰ã€‚æ‰€ä»¥è¿™æ—¶tadd_ok(x, -y)ä¼šåˆ¤æ–­é”™è¯¯ã€‚</p>
<p>è‡³äºæ­£ç¡®ç­”æ¡ˆï¼Œå¦‚æœ-y = INT_MINç†è§£ä¸ºä¹Ÿç®—æº¢å‡ºçš„è¯ï¼Œç­”æ¡ˆåº”è¯¥å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tsub_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (y == INT_MIN) <span class="comment">//åªè¦yä¸ºINT_MINï¼Œå°±ç›´æ¥è¿”å›0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> tadd_ok(x, -y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-33æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w-4çš„ä½æ¨¡å¼ã€‚æ ¹æ®è¿™äº›æ•°å­—çš„è¡¥ç çš„è§£é‡Šï¼Œå¡«å†™ä¸‹è¡¨ï¼Œç¡®å®šæ‰€ç¤ºæ•°å­—çš„åŠ æ³•é€†å…ƒã€‚"><a href="#ç»ƒä¹ é¢˜2-33æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w-4çš„ä½æ¨¡å¼ã€‚æ ¹æ®è¿™äº›æ•°å­—çš„è¡¥ç çš„è§£é‡Šï¼Œå¡«å†™ä¸‹è¡¨ï¼Œç¡®å®šæ‰€ç¤ºæ•°å­—çš„åŠ æ³•é€†å…ƒã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.33æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w=4çš„ä½æ¨¡å¼ã€‚æ ¹æ®è¿™äº›æ•°å­—çš„è¡¥ç çš„è§£é‡Šï¼Œå¡«å†™ä¸‹è¡¨ï¼Œç¡®å®šæ‰€ç¤ºæ•°å­—çš„åŠ æ³•é€†å…ƒã€‚"></a>ç»ƒä¹ é¢˜2.33æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—æ¥è¡¨ç¤ºé•¿åº¦w=4çš„ä½æ¨¡å¼ã€‚æ ¹æ®è¿™äº›æ•°å­—çš„è¡¥ç çš„è§£é‡Šï¼Œå¡«å†™ä¸‹è¡¨ï¼Œç¡®å®šæ‰€ç¤ºæ•°å­—çš„åŠ æ³•é€†å…ƒã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221016115010661.png" alt="image-20221016115010661"></p>
<p>å¯¹äºè¡¥ç å’Œæ— ç¬¦å·(ç»ƒä¹ é¢˜2.28)é(negation)äº§ç”Ÿçš„ä½æ¨¡å¼ï¼Œä½ è§‚å¯Ÿåˆ°ä»€ä¹ˆ?</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">$x$</th>
<th style="text-align:center"></th>
<th style="text-align:center">$-^t_4x$</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">åè¿›åˆ¶</td>
<td style="text-align:center">åå…­è¿›åˆ¶</td>
<td style="text-align:center">åè¿›åˆ¶</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">5</td>
<td style="text-align:center">B</td>
<td style="text-align:center">-5</td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">-8</td>
<td style="text-align:center">8</td>
<td style="text-align:center">-8</td>
</tr>
<tr>
<td style="text-align:center">D</td>
<td style="text-align:center">-3</td>
<td style="text-align:center">3</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">F</td>
<td style="text-align:center">-1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-34-æŒ‰ç…§å›¾2-27çš„é£æ ¼å¡«å†™ä¸‹è¡¨ï¼Œè¯´æ˜ä¸åŒçš„3ä½æ•°å­—ä¹˜æ³•çš„ç»“æœã€‚"><a href="#ç»ƒä¹ é¢˜2-34-æŒ‰ç…§å›¾2-27çš„é£æ ¼å¡«å†™ä¸‹è¡¨ï¼Œè¯´æ˜ä¸åŒçš„3ä½æ•°å­—ä¹˜æ³•çš„ç»“æœã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.34 æŒ‰ç…§å›¾2-27çš„é£æ ¼å¡«å†™ä¸‹è¡¨ï¼Œè¯´æ˜ä¸åŒçš„3ä½æ•°å­—ä¹˜æ³•çš„ç»“æœã€‚"></a>ç»ƒä¹ é¢˜2.34 æŒ‰ç…§å›¾2-27çš„é£æ ¼å¡«å†™ä¸‹è¡¨ï¼Œè¯´æ˜ä¸åŒçš„3ä½æ•°å­—ä¹˜æ³•çš„ç»“æœã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221016120202629.png" alt="image-20221016120202629"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ¨¡å¼</th>
<th style="text-align:center">x</th>
<th style="text-align:center">y</th>
<th style="text-align:center">x*y</th>
<th style="text-align:center">æˆªæ–­çš„x*y</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">[100] 4</td>
<td style="text-align:center">[101] 5</td>
<td style="text-align:center">[001 0100] 20</td>
<td style="text-align:center">[100] 4</td>
</tr>
<tr>
<td style="text-align:center">è¡¥ç </td>
<td style="text-align:center">[100] -4</td>
<td style="text-align:center">[101] -3</td>
<td style="text-align:center">[000 1100] 12</td>
<td style="text-align:center">[100] -4</td>
</tr>
<tr>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">[010] 2</td>
<td style="text-align:center">[111] 7</td>
<td style="text-align:center">[000 1110] 14</td>
<td style="text-align:center">[110] 6</td>
</tr>
<tr>
<td style="text-align:center">è¡¥ç </td>
<td style="text-align:center">[010] 2</td>
<td style="text-align:center">[111] -1</td>
<td style="text-align:center">[111 1110] -2</td>
<td style="text-align:center">[110] -2</td>
</tr>
<tr>
<td style="text-align:center">æ— ç¬¦å·</td>
<td style="text-align:center">[110] 6</td>
<td style="text-align:center">[110] 6</td>
<td style="text-align:center">[010 0100] 36</td>
<td style="text-align:center">[100] 4</td>
</tr>
<tr>
<td style="text-align:center">è¡¥ç </td>
<td style="text-align:center">[110] -2</td>
<td style="text-align:center">[110] -2</td>
<td style="text-align:center">[000 0100 ] 4</td>
<td style="text-align:center">[100] -4</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-35ï¹-ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å‘å‡½æ•°tmult-ok-çš„ä»£ç ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜æ˜¯å¦ä¼šäº§ç”Ÿæº¢å‡ºã€‚ä¸‹é¢æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆ"><a href="#ç»ƒä¹ é¢˜2-35ï¹-ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å‘å‡½æ•°tmult-ok-çš„ä»£ç ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜æ˜¯å¦ä¼šäº§ç”Ÿæº¢å‡ºã€‚ä¸‹é¢æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ç»ƒä¹ é¢˜2.35ï¹ ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å‘å‡½æ•°tmult ok çš„ä»£ç ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜æ˜¯å¦ä¼šäº§ç”Ÿæº¢å‡ºã€‚ä¸‹é¢æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆ:"></a>ç»ƒä¹ é¢˜2.35ï¹ ç»™ä½ ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å‘å‡½æ•°tmult ok çš„ä»£ç ï¼Œè¯¥å‡½æ•°ä¼šåˆ¤æ–­ä¸¤ä¸ªå‚æ•°ç›¸ä¹˜æ˜¯å¦ä¼šäº§ç”Ÿæº¢å‡ºã€‚ä¸‹é¢æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆ:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Determine whether arguments can be multiplied without overflow */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tmult_ok</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> p = x * y;</span><br><span class="line">    <span class="comment">/*Either x is zero, or dividing p by x gives y */</span></span><br><span class="line">    <span class="keyword">return</span> !x || p / x == y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-36å¯¹äºæ•°æ®ç±»å‹intä¸º32ä½çš„æƒ…å†µï¼Œè®¾è®¡ä¸€ä¸ªç‰ˆæœ¬çš„tmult-okå‡½æ•°-ç»ƒä¹ é¢˜2-35-ï¼Œä½¿ç”¨64ä½ç²¾åº¦çš„æ•°æ®ç±»å‹int64-tï¼Œè€Œä¸ä½¿ç”¨é™¤æ³•ã€‚"><a href="#ç»ƒä¹ é¢˜2-36å¯¹äºæ•°æ®ç±»å‹intä¸º32ä½çš„æƒ…å†µï¼Œè®¾è®¡ä¸€ä¸ªç‰ˆæœ¬çš„tmult-okå‡½æ•°-ç»ƒä¹ é¢˜2-35-ï¼Œä½¿ç”¨64ä½ç²¾åº¦çš„æ•°æ®ç±»å‹int64-tï¼Œè€Œä¸ä½¿ç”¨é™¤æ³•ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.36å¯¹äºæ•°æ®ç±»å‹intä¸º32ä½çš„æƒ…å†µï¼Œè®¾è®¡ä¸€ä¸ªç‰ˆæœ¬çš„tmult_okå‡½æ•°(ç»ƒä¹ é¢˜2.35)ï¼Œä½¿ç”¨64ä½ç²¾åº¦çš„æ•°æ®ç±»å‹int64_tï¼Œè€Œä¸ä½¿ç”¨é™¤æ³•ã€‚"></a>ç»ƒä¹ é¢˜2.36å¯¹äºæ•°æ®ç±»å‹intä¸º32ä½çš„æƒ…å†µï¼Œè®¾è®¡ä¸€ä¸ªç‰ˆæœ¬çš„tmult_okå‡½æ•°(ç»ƒä¹ é¢˜2.35)ï¼Œä½¿ç”¨64ä½ç²¾åº¦çš„æ•°æ®ç±»å‹int64_tï¼Œè€Œä¸ä½¿ç”¨é™¤æ³•ã€‚</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">tmult_ok2</span><span class="params">(<span class="type">int32_t</span> x, <span class="type">int32_t</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int64_t</span> p = (<span class="type">int64_t</span>)x * y; <span class="comment">/*ä¸€å®šè¦å…ˆå°†å³è¾¹æ‰‹åŠ¨è½¬æˆ int64_t */</span></span><br><span class="line">	<span class="comment">/*printf(&quot;p=%&quot; PRId64 &quot;, q=%&quot; PRId32 &quot;\n&quot;, p,q);*/</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> p == (<span class="type">int32_t</span>)p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-37ç°åœ¨ä½ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œå½“æ•°æ®ç±»å‹intå’Œsize-t-éƒ½æ˜¯32ä½çš„ï¼Œä¿®è¡¥ä¸Šè¿°æ—æ³¨ç»™å‡ºçš„XDRä»£ç ä¸­çš„æ¼æ´ã€‚ä½ å†³å®šå°†å¾…åˆ†é…å­—èŠ‚æ•°è®¾ç½®ä¸ºæ•°æ®ç±»å‹uint64-tï¼Œæ¥æ¶ˆé™¤ä¹˜æ³•æº¢å‡ºçš„å¯èƒ½æ€§ã€‚ä½ æŠŠåŸæ¥å¯¹mallocå‡½æ•°çš„è°ƒç”¨-ç¬¬9è¡Œ-æ›¿æ¢å¦‚ä¸‹"><a href="#ç»ƒä¹ é¢˜2-37ç°åœ¨ä½ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œå½“æ•°æ®ç±»å‹intå’Œsize-t-éƒ½æ˜¯32ä½çš„ï¼Œä¿®è¡¥ä¸Šè¿°æ—æ³¨ç»™å‡ºçš„XDRä»£ç ä¸­çš„æ¼æ´ã€‚ä½ å†³å®šå°†å¾…åˆ†é…å­—èŠ‚æ•°è®¾ç½®ä¸ºæ•°æ®ç±»å‹uint64-tï¼Œæ¥æ¶ˆé™¤ä¹˜æ³•æº¢å‡ºçš„å¯èƒ½æ€§ã€‚ä½ æŠŠåŸæ¥å¯¹mallocå‡½æ•°çš„è°ƒç”¨-ç¬¬9è¡Œ-æ›¿æ¢å¦‚ä¸‹" class="headerlink" title="ç»ƒä¹ é¢˜2.37ç°åœ¨ä½ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œå½“æ•°æ®ç±»å‹intå’Œsize_t éƒ½æ˜¯32ä½çš„ï¼Œä¿®è¡¥ä¸Šè¿°æ—æ³¨ç»™å‡ºçš„XDRä»£ç ä¸­çš„æ¼æ´ã€‚ä½ å†³å®šå°†å¾…åˆ†é…å­—èŠ‚æ•°è®¾ç½®ä¸ºæ•°æ®ç±»å‹uint64_tï¼Œæ¥æ¶ˆé™¤ä¹˜æ³•æº¢å‡ºçš„å¯èƒ½æ€§ã€‚ä½ æŠŠåŸæ¥å¯¹mallocå‡½æ•°çš„è°ƒç”¨(ç¬¬9è¡Œ)æ›¿æ¢å¦‚ä¸‹:"></a>ç»ƒä¹ é¢˜2.37ç°åœ¨ä½ æœ‰ä¸€ä¸ªä»»åŠ¡ï¼Œå½“æ•°æ®ç±»å‹intå’Œsize_t éƒ½æ˜¯32ä½çš„ï¼Œä¿®è¡¥ä¸Šè¿°æ—æ³¨ç»™å‡ºçš„XDRä»£ç ä¸­çš„æ¼æ´ã€‚ä½ å†³å®šå°†å¾…åˆ†é…å­—èŠ‚æ•°è®¾ç½®ä¸ºæ•°æ®ç±»å‹uint64_tï¼Œæ¥æ¶ˆé™¤ä¹˜æ³•æº¢å‡ºçš„å¯èƒ½æ€§ã€‚ä½ æŠŠåŸæ¥å¯¹mallocå‡½æ•°çš„è°ƒç”¨(ç¬¬9è¡Œ)æ›¿æ¢å¦‚ä¸‹:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">uint64_t</span> asize = ele_cnt * (<span class="type">uint64_t</span>) ele_size;</span><br><span class="line"><span class="type">void</span> *result = <span class="built_in">malloc</span>(asize);</span><br></pre></td></tr></table></figure>
<p>æé†’ä¸€ä¸‹ï¼Œmalloc çš„å‚æ•°ç±»å‹æ˜¯size_tã€‚</p>
<p><strong>Aï¼è¿™æ®µä»£ç å¯¹åŸå§‹çš„ä»£ç æœ‰äº†å“ªäº›æ”¹è¿›?</strong></p>
<p>å‡è®¾ä¼šæº¢å‡ºï¼Œé‚£ä¹ˆè™½ç„¶åˆ°äº†asizeè¿™æ­¥è¿˜ä¸ä¼šæº¢å‡ºï¼Œå› ä¸ºåœ¨ç­‰å¼å³è¾¹å·²ç»å…ˆæŠŠä¸¤ä¸ªä¹˜å­å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º<code>uint64_t</code>äº†ã€‚<br>ä½†æ˜¯åˆ°äº†mallocå‡½æ•°æ—¶ï¼Œç”±äºæ­¤å‡½æ•°çš„åŸå‹è®¾è®¡ï¼Œè¿˜æ˜¯ä¼šè¢«æˆªæ–­ï¼Œä¼ å…¥mallocå‡½æ•°æ—¶å‘ç”Ÿæº¢å‡ºã€‚</p>
<p><strong>B.ä½ è¯¥å¦‚ä½•ä¿®æ”¹ä»£ç æ¥æ¶ˆé™¤è¿™ä¸ªæ¼æ´?</strong></p>
<h2 id="ç»ƒä¹ é¢˜2-38å°±åƒæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼ŒLEAæŒ‡ä»¤èƒ½å¤Ÿæ‰§è¡Œå½¢å¦‚-a-lt-lt-k-bçš„è®¡ç®—ï¼Œè¿™é‡Œk-ç­‰äº0ã€1ã€2æˆ–3ï¼Œè€Œbç­‰äº0æˆ–è€…æŸä¸ªç¨‹åºå€¼ã€‚ç¼–è¯‘å™¨å¸¸å¸¸ç”¨è¿™æ¡æŒ‡ä»¤æ¥æ‰§è¡Œå¸¸æ•°å› å­ä¹˜æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨-a-lt-lt-1-aæ¥è®¡ç®—3-aã€‚è€ƒè™‘bç­‰äº0æˆ–è€…ç­‰äºaã€kä¸ºä»»æ„å¯èƒ½çš„å€¼çš„æƒ…å†µï¼Œç”¨ä¸€æ¡LEAæŒ‡ä»¤å¯ä»¥è®¡ç®—açš„å“ªäº›å€æ•°"><a href="#ç»ƒä¹ é¢˜2-38å°±åƒæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼ŒLEAæŒ‡ä»¤èƒ½å¤Ÿæ‰§è¡Œå½¢å¦‚-a-lt-lt-k-bçš„è®¡ç®—ï¼Œè¿™é‡Œk-ç­‰äº0ã€1ã€2æˆ–3ï¼Œè€Œbç­‰äº0æˆ–è€…æŸä¸ªç¨‹åºå€¼ã€‚ç¼–è¯‘å™¨å¸¸å¸¸ç”¨è¿™æ¡æŒ‡ä»¤æ¥æ‰§è¡Œå¸¸æ•°å› å­ä¹˜æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨-a-lt-lt-1-aæ¥è®¡ç®—3-aã€‚è€ƒè™‘bç­‰äº0æˆ–è€…ç­‰äºaã€kä¸ºä»»æ„å¯èƒ½çš„å€¼çš„æƒ…å†µï¼Œç”¨ä¸€æ¡LEAæŒ‡ä»¤å¯ä»¥è®¡ç®—açš„å“ªäº›å€æ•°" class="headerlink" title="ç»ƒä¹ é¢˜2.38å°±åƒæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼ŒLEAæŒ‡ä»¤èƒ½å¤Ÿæ‰§è¡Œå½¢å¦‚(a&lt;&lt;k)+bçš„è®¡ç®—ï¼Œè¿™é‡Œk ç­‰äº0ã€1ã€2æˆ–3ï¼Œè€Œbç­‰äº0æˆ–è€…æŸä¸ªç¨‹åºå€¼ã€‚ç¼–è¯‘å™¨å¸¸å¸¸ç”¨è¿™æ¡æŒ‡ä»¤æ¥æ‰§è¡Œå¸¸æ•°å› å­ä¹˜æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨(a&lt;&lt;1)+aæ¥è®¡ç®—3*aã€‚è€ƒè™‘bç­‰äº0æˆ–è€…ç­‰äºaã€kä¸ºä»»æ„å¯èƒ½çš„å€¼çš„æƒ…å†µï¼Œç”¨ä¸€æ¡LEAæŒ‡ä»¤å¯ä»¥è®¡ç®—açš„å“ªäº›å€æ•°?"></a>ç»ƒä¹ é¢˜2.38å°±åƒæˆ‘ä»¬å°†åœ¨ç¬¬3ç« ä¸­çœ‹åˆ°çš„é‚£æ ·ï¼ŒLEAæŒ‡ä»¤èƒ½å¤Ÿæ‰§è¡Œå½¢å¦‚(a&lt;&lt;k)+bçš„è®¡ç®—ï¼Œè¿™é‡Œk ç­‰äº0ã€1ã€2æˆ–3ï¼Œè€Œbç­‰äº0æˆ–è€…æŸä¸ªç¨‹åºå€¼ã€‚ç¼–è¯‘å™¨å¸¸å¸¸ç”¨è¿™æ¡æŒ‡ä»¤æ¥æ‰§è¡Œå¸¸æ•°å› å­ä¹˜æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨(a&lt;&lt;1)+aæ¥è®¡ç®—3*aã€‚è€ƒè™‘bç­‰äº0æˆ–è€…ç­‰äºaã€kä¸ºä»»æ„å¯èƒ½çš„å€¼çš„æƒ…å†µï¼Œç”¨ä¸€æ¡LEAæŒ‡ä»¤å¯ä»¥è®¡ç®—açš„å“ªäº›å€æ•°?</h2><p>å½“b=0æ—¶ï¼Œ(a&lt;&lt;k)+b = a*2\^kï¼Œè€Œk=0ã€1ã€2æˆ–3ï¼Œæ‰€ä»¥ç»“æœä¸ºaï¼Œ2aï¼Œ4aï¼Œ8a</p>
<p>å½“b=aæ—¶ï¼Œ(a&lt;&lt;k)+a = a(2^k+1)ï¼Œè€Œk=0ã€1ã€2æˆ–3ï¼Œæ‰€ä»¥ç»“æœä¸º2aï¼Œ3aï¼Œ5aï¼Œ9a</p>
<p>ç»¼ä¸Šï¼šç»“æœä¸ºaï¼Œ2aï¼Œ3aï¼Œ4aï¼Œ5aï¼Œ8aï¼Œ9a</p>
<h2 id="ç»ƒä¹ é¢˜2-39å¯¹äºä½ä½ç½®nä¸ºæœ€é«˜æœ‰æ•ˆä½çš„æƒ…å†µï¼Œæˆ‘ä»¬è¦æ€æ ·ä¿®æ”¹å½¢å¼Bçš„è¡¨è¾¾å¼"><a href="#ç»ƒä¹ é¢˜2-39å¯¹äºä½ä½ç½®nä¸ºæœ€é«˜æœ‰æ•ˆä½çš„æƒ…å†µï¼Œæˆ‘ä»¬è¦æ€æ ·ä¿®æ”¹å½¢å¼Bçš„è¡¨è¾¾å¼" class="headerlink" title="ç»ƒä¹ é¢˜2.39å¯¹äºä½ä½ç½®nä¸ºæœ€é«˜æœ‰æ•ˆä½çš„æƒ…å†µï¼Œæˆ‘ä»¬è¦æ€æ ·ä¿®æ”¹å½¢å¼Bçš„è¡¨è¾¾å¼?"></a>ç»ƒä¹ é¢˜2.39å¯¹äºä½ä½ç½®nä¸ºæœ€é«˜æœ‰æ•ˆä½çš„æƒ…å†µï¼Œæˆ‘ä»¬è¦æ€æ ·ä¿®æ”¹å½¢å¼Bçš„è¡¨è¾¾å¼?</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221019110357157.png" alt="image-20221019110357157"></p>
<p>è¿™ä¸ªè¡¨è¾¾å¼å°±å˜æˆäº†$-(x&lt;&lt;m)$ã€‚è¦çœ‹æ¸…è¿™ä¸€ç‚¹ï¼Œè®¾å­—é•¿ä¸º$w$ï¼Œ$n=wâ€”1$ã€‚å½¢å¼Bè¯´æˆ‘ä»¬è¦è®¡ç®—$(x&lt;&lt;w)-(x&lt;&lt;m)$ï¼Œä½†æ˜¯å°†xå‘å·¦ç§»åŠ¨wä½ä¼šå¾—åˆ°å€¼0ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-40å¯¹äºä¸‹é¢æ¯ä¸ªKçš„å€¼ï¼Œæ‰¾å‡ºåªç”¨æŒ‡å®šæ•°é‡çš„è¿ç®—è¡¨è¾¾x-K-çš„æ–¹æ³•ï¹è¿™é‡Œæˆ‘ä»¬è®¤ä¸ºåŠ æ³•å’Œå‡æ³•çš„å¼€é”€ç›¸å½“ã€‚é™¤äº†æˆ‘ä»¬å·²ç»è€ƒè™‘è¿‡çš„ç®€å•çš„å½¢å¼Aå’ŒBåŸåˆ™-ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨ä¸€äº›æŠ€å·§ã€‚"><a href="#ç»ƒä¹ é¢˜2-40å¯¹äºä¸‹é¢æ¯ä¸ªKçš„å€¼ï¼Œæ‰¾å‡ºåªç”¨æŒ‡å®šæ•°é‡çš„è¿ç®—è¡¨è¾¾x-K-çš„æ–¹æ³•ï¹è¿™é‡Œæˆ‘ä»¬è®¤ä¸ºåŠ æ³•å’Œå‡æ³•çš„å¼€é”€ç›¸å½“ã€‚é™¤äº†æˆ‘ä»¬å·²ç»è€ƒè™‘è¿‡çš„ç®€å•çš„å½¢å¼Aå’ŒBåŸåˆ™-ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨ä¸€äº›æŠ€å·§ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.40å¯¹äºä¸‹é¢æ¯ä¸ªKçš„å€¼ï¼Œæ‰¾å‡ºåªç”¨æŒ‡å®šæ•°é‡çš„è¿ç®—è¡¨è¾¾x* K çš„æ–¹æ³•ï¹è¿™é‡Œæˆ‘ä»¬è®¤ä¸ºåŠ æ³•å’Œå‡æ³•çš„å¼€é”€ç›¸å½“ã€‚é™¤äº†æˆ‘ä»¬å·²ç»è€ƒè™‘è¿‡çš„ç®€å•çš„å½¢å¼Aå’ŒBåŸåˆ™,ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨ä¸€äº›æŠ€å·§ã€‚"></a>ç»ƒä¹ é¢˜2.40å¯¹äºä¸‹é¢æ¯ä¸ªKçš„å€¼ï¼Œæ‰¾å‡ºåªç”¨æŒ‡å®šæ•°é‡çš„è¿ç®—è¡¨è¾¾x* K çš„æ–¹æ³•ï¹è¿™é‡Œæˆ‘ä»¬è®¤ä¸ºåŠ æ³•å’Œå‡æ³•çš„å¼€é”€ç›¸å½“ã€‚é™¤äº†æˆ‘ä»¬å·²ç»è€ƒè™‘è¿‡çš„ç®€å•çš„å½¢å¼Aå’ŒBåŸåˆ™,ä½ å¯èƒ½ä¼šéœ€è¦ä½¿ç”¨ä¸€äº›æŠ€å·§ã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221016123931135.png" alt="image-20221016123931135"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">K</th>
<th style="text-align:center">ç§»ä½</th>
<th style="text-align:center">åŠ æ³•/å‡æ³•</th>
<th style="text-align:center">è¡¨è¾¾å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">(x &lt;&lt; 2) + (x&lt;&lt;1)</td>
</tr>
<tr>
<td style="text-align:center">31</td>
<td style="text-align:center">1</td>
<td style="text-align:center">1</td>
<td style="text-align:center">(x &lt;&lt;5 ) - x</td>
</tr>
<tr>
<td style="text-align:center">-6</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">(x &lt;&lt; 1) - (x &lt;&lt; 3)</td>
</tr>
<tr>
<td style="text-align:center">55</td>
<td style="text-align:center">2</td>
<td style="text-align:center">2</td>
<td style="text-align:center">(x &lt;&lt; 6) - (x &lt;&lt;3) - x</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-41å¯¹äºä¸€ç»„ä»ä½ä½ç½®nå¼€å§‹åˆ°ä½ä½ç½®m-çš„è¿ç»­çš„1-nâ‰¥m-ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥äº§ç”Ÿä¸¤ç§å½¢å¼çš„ä»£ç ï¼ŒAå’ŒBã€‚ç¼–è¯‘å™¨è¯¥å¦‚ä½•å†³å®šä½¿ç”¨å“ªä¸€ç§å‘¢"><a href="#ç»ƒä¹ é¢˜2-41å¯¹äºä¸€ç»„ä»ä½ä½ç½®nå¼€å§‹åˆ°ä½ä½ç½®m-çš„è¿ç»­çš„1-nâ‰¥m-ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥äº§ç”Ÿä¸¤ç§å½¢å¼çš„ä»£ç ï¼ŒAå’ŒBã€‚ç¼–è¯‘å™¨è¯¥å¦‚ä½•å†³å®šä½¿ç”¨å“ªä¸€ç§å‘¢" class="headerlink" title="ç»ƒä¹ é¢˜2.41å¯¹äºä¸€ç»„ä»ä½ä½ç½®nå¼€å§‹åˆ°ä½ä½ç½®m çš„è¿ç»­çš„1(nâ‰¥m)ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥äº§ç”Ÿä¸¤ç§å½¢å¼çš„ä»£ç ï¼ŒAå’ŒBã€‚ç¼–è¯‘å™¨è¯¥å¦‚ä½•å†³å®šä½¿ç”¨å“ªä¸€ç§å‘¢?"></a>ç»ƒä¹ é¢˜2.41å¯¹äºä¸€ç»„ä»ä½ä½ç½®nå¼€å§‹åˆ°ä½ä½ç½®m çš„è¿ç»­çš„1(nâ‰¥m)ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯ä»¥äº§ç”Ÿä¸¤ç§å½¢å¼çš„ä»£ç ï¼ŒAå’ŒBã€‚ç¼–è¯‘å™¨è¯¥å¦‚ä½•å†³å®šä½¿ç”¨å“ªä¸€ç§å‘¢?</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221019110357157.png" alt="image-20221019110357157"></p>
<p>å‡è®¾åŠ æ³•å’Œå‡æ³•æœ‰åŒæ ·çš„æ€§èƒ½ï¼Œé‚£ä¹ˆåŸåˆ™å°±æ˜¯å½“n=mæ—¶ï¼Œé€‰æ‹©å½¢å¼Aï¼Œå½“n=m+1æ—¶ï¼Œéšä¾¿é€‰å“ªç§ï¼Œè€Œå½“n&gt;mï¼‹1æ—¶ï¼Œé€‰æ‹©å½¢å¼Bã€‚</p>
<p>å½“ n=m æ—¶ï¼ŒA:x&lt;&lt;n , B:(x&lt;&lt;n+1)-(x&lt;&lt;n) å½¢å¼Aåªéœ€è¦1ä¸ªç§»ä½,è€Œå½¢å¼Béœ€è¦ 2ä¸ªç§»ä½å’Œ1ä¸ªå‡æ³• ï¼Œæ‰€ä»¥é€‰æ‹©A</p>
<p>å½“n=m+1æ—¶ï¼ŒA:(x&lt;&lt;n)+(x&lt;&lt;m)ï¼ŒB:(x&lt;&lt;n+1)-(x&lt;&lt;n)å½¢å¼Aåªéœ€è¦2ä¸ªç§»ä½ä¸€ä¸ªåŠ æ³•ï¼Œè€Œå½¢å¼Béœ€è¦ 2ä¸ªç§»ä½å’Œ1ä¸ªå‡æ³• ï¼Œæ‰€ä»¥éšä¾¿é€‰é‚£ç§</p>
<p>å½“n&gt;m+1æ—¶ï¼Œå°±å¦‚åŒä¸Šå›¾æ‰€å±•ç¤ºï¼Œå¾ˆæ˜¾ç„¶é€‰æ‹©B</p>
<h2 id="ç»ƒä¹ é¢˜2-42å†™ä¸€ä¸ªå‡½æ•°-div16ï¼Œå¯¹äºæ•´æ•°å‚æ•°xè¿”å›x-16çš„å€¼ã€‚ä½ çš„å‡½æ•°ä¸èƒ½ä½¿ç”¨é™¤æ³•ã€æ¨¡è¿ç®—ã€ä¹˜æ³•ã€ä»»ä½•æ¡ä»¶è¯­å¥-ifæˆ–è€…-ã€ä»»ä½•æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆä¾‹å¦‚-lt-ã€-gt-æˆ–-æˆ–ä»»ä½•å¾ªç¯ã€‚ä½ å¯ä»¥å‡è®¾æ•°æ®ç±»å‹intæ˜¯32ä½é•¿ï¼Œä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œè€Œå³ç§»æ˜¯ç®—æœ¯å³ç§»ã€‚"><a href="#ç»ƒä¹ é¢˜2-42å†™ä¸€ä¸ªå‡½æ•°-div16ï¼Œå¯¹äºæ•´æ•°å‚æ•°xè¿”å›x-16çš„å€¼ã€‚ä½ çš„å‡½æ•°ä¸èƒ½ä½¿ç”¨é™¤æ³•ã€æ¨¡è¿ç®—ã€ä¹˜æ³•ã€ä»»ä½•æ¡ä»¶è¯­å¥-ifæˆ–è€…-ã€ä»»ä½•æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆä¾‹å¦‚-lt-ã€-gt-æˆ–-æˆ–ä»»ä½•å¾ªç¯ã€‚ä½ å¯ä»¥å‡è®¾æ•°æ®ç±»å‹intæ˜¯32ä½é•¿ï¼Œä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œè€Œå³ç§»æ˜¯ç®—æœ¯å³ç§»ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.42å†™ä¸€ä¸ªå‡½æ•° div16ï¼Œå¯¹äºæ•´æ•°å‚æ•°xè¿”å›x/16çš„å€¼ã€‚ä½ çš„å‡½æ•°ä¸èƒ½ä½¿ç”¨é™¤æ³•ã€æ¨¡è¿ç®—ã€ä¹˜æ³•ã€ä»»ä½•æ¡ä»¶è¯­å¥(ifæˆ–è€…?:)ã€ä»»ä½•æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆä¾‹å¦‚&lt;ã€&gt;æˆ–= =)æˆ–ä»»ä½•å¾ªç¯ã€‚ä½ å¯ä»¥å‡è®¾æ•°æ®ç±»å‹intæ˜¯32ä½é•¿ï¼Œä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œè€Œå³ç§»æ˜¯ç®—æœ¯å³ç§»ã€‚"></a>ç»ƒä¹ é¢˜2.42å†™ä¸€ä¸ªå‡½æ•° div16ï¼Œå¯¹äºæ•´æ•°å‚æ•°xè¿”å›x/16çš„å€¼ã€‚ä½ çš„å‡½æ•°ä¸èƒ½ä½¿ç”¨é™¤æ³•ã€æ¨¡è¿ç®—ã€ä¹˜æ³•ã€ä»»ä½•æ¡ä»¶è¯­å¥(ifæˆ–è€…?:)ã€ä»»ä½•æ¯”è¾ƒè¿ç®—ç¬¦ï¼ˆä¾‹å¦‚&lt;ã€&gt;æˆ–= =)æˆ–ä»»ä½•å¾ªç¯ã€‚ä½ å¯ä»¥å‡è®¾æ•°æ®ç±»å‹intæ˜¯32ä½é•¿ï¼Œä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œè€Œå³ç§»æ˜¯ç®—æœ¯å³ç§»ã€‚</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">book_div16</span><span class="params">(<span class="type">int</span> x)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">/* Compute bias to be either 0 (x &gt;= 0) or 15 (x &lt; 0) */</span></span><br><span class="line">        <span class="type">int</span> bias = (x &gt;&gt; <span class="number">31</span>) &amp; <span class="number">0xF</span>;<span class="comment">//å³ç§»31ä½åï¼Œ32ä½ä¸Šé¢éƒ½æ˜¯ç¬¦å·ä½çš„å€¼</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºéè´Ÿæ•°ï¼Œç¬¦å·ä½ä¸º0ï¼Œbiaså˜é‡ä¸º0</span></span><br><span class="line">        <span class="comment">//å¦‚æœä¸ºè´Ÿæ•°ï¼Œç¬¦å·ä½ä¸º1ï¼Œbiaså˜é‡ä¸º0xFï¼Œå³15</span></span><br><span class="line">        <span class="keyword">return</span> (x + bias) &gt;&gt; <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜2-43åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†å¸¸æ•°Må’ŒNçš„å®šä¹‰"><a href="#ç»ƒä¹ é¢˜2-43åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†å¸¸æ•°Må’ŒNçš„å®šä¹‰" class="headerlink" title="ç»ƒä¹ é¢˜2.43åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†å¸¸æ•°Må’ŒNçš„å®šä¹‰:"></a>ç»ƒä¹ é¢˜2.43åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†å¸¸æ•°Må’ŒNçš„å®šä¹‰:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> M <span class="comment">/*Mystery number 1 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> N <span class="comment">/* Mystery number 2*/</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">arith</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> result = <span class="number">0</span>;</span><br><span class="line">    result = x * M + y / N; <span class="comment">/*Mand N are mystery numbers. */</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä»¥æŸä¸ªMå’ŒNçš„å€¼ç¼–è¯‘è¿™æ®µä»£ç ã€‚ç¼–è¯‘å™¨ç”¨æˆ‘ä»¬è®¨è®ºè¿‡çš„æ–¹æ³•ä¼˜åŒ–ä¹˜æ³•å’Œé™¤æ³•ã€‚ä¸‹é¢æ˜¯å°†äº§ç”Ÿå‡ºçš„æœºå™¨ä»£ç ç¿»è¯‘å›Cè¯­è¨€çš„ç»“æœ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">optarith</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> t = x;</span><br><span class="line">    x &lt;&lt;= <span class="number">5</span>;</span><br><span class="line">    x -= t;</span><br><span class="line">    <span class="keyword">if</span> (y &lt; <span class="number">0</span>)</span><br><span class="line">        y += <span class="number">7</span>;</span><br><span class="line">    y &gt;&gt;= <span class="number">3</span>; <span class="comment">/* Arithmetic shift */</span></span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…ˆçœ‹M:<br>ä»£ç ç­‰ä»·äºx = x <em> 32 -x = x </em> 31.æ‰€ä»¥Mä¸º31.</p>
<p>å†çœ‹N</p>
<p>7=2\^3-1,æœ€åçš„å³ç§»æ“ä½œä¹Ÿæ˜¯å³ç§»3ä½ï¼Œæ‰€ä»¥N=8</p>
<h2 id="ç»ƒä¹ é¢˜2-44å‡è®¾æˆ‘ä»¬åœ¨å¯¹æœ‰ç¬¦å·å€¼ä½¿ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šè¿è¡Œä»£ç ã€‚å¯¹äºæœ‰ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯ç®—æœ¯å³ç§»ï¼Œè€Œå¯¹äºæ— ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯é€»è¾‘å³ç§»ã€‚å˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–å¦‚ä¸‹"><a href="#ç»ƒä¹ é¢˜2-44å‡è®¾æˆ‘ä»¬åœ¨å¯¹æœ‰ç¬¦å·å€¼ä½¿ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šè¿è¡Œä»£ç ã€‚å¯¹äºæœ‰ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯ç®—æœ¯å³ç§»ï¼Œè€Œå¯¹äºæ— ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯é€»è¾‘å³ç§»ã€‚å˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–å¦‚ä¸‹" class="headerlink" title="ç»ƒä¹ é¢˜2.44å‡è®¾æˆ‘ä»¬åœ¨å¯¹æœ‰ç¬¦å·å€¼ä½¿ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šè¿è¡Œä»£ç ã€‚å¯¹äºæœ‰ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯ç®—æœ¯å³ç§»ï¼Œè€Œå¯¹äºæ— ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯é€»è¾‘å³ç§»ã€‚å˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–å¦‚ä¸‹:"></a>ç»ƒä¹ é¢˜2.44å‡è®¾æˆ‘ä»¬åœ¨å¯¹æœ‰ç¬¦å·å€¼ä½¿ç”¨è¡¥ç è¿ç®—çš„32ä½æœºå™¨ä¸Šè¿è¡Œä»£ç ã€‚å¯¹äºæœ‰ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯ç®—æœ¯å³ç§»ï¼Œè€Œå¯¹äºæ— ç¬¦å·å€¼ä½¿ç”¨çš„æ˜¯é€»è¾‘å³ç§»ã€‚å˜é‡çš„å£°æ˜å’Œåˆå§‹åŒ–å¦‚ä¸‹:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> x = foo();</span><br><span class="line"><span class="type">int</span> y = bar();</span><br><span class="line"><span class="type">unsigned</span> ux = x;</span><br><span class="line"><span class="type">unsigned</span> uy = y;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºä¸‹é¢æ¯ä¸ªCè¡¨è¾¾å¼ï¼Œ1)è¯æ˜å¯¹äºæ‰€æœ‰çš„xå’Œyå€¼ï¼Œå®ƒéƒ½ä¸ºçœŸ(ç­‰äº1);æˆ–è€…2)ç»™å‡ºä½¿å¾—å®ƒä¸ºå‡(ç­‰äº0)çš„xå’Œyçš„å€¼:</p>
<p><strong>A. (x &gt; 0)||(x-1 &lt;0)</strong></p>
<p>å½“xä¸ºTMINæ—¶ï¼Œå·¦è¾¹ä¸ç¬¦åˆæ¡ä»¶ï¼Œä¸º0ï¼›å³è¾¹è´Ÿæº¢å‡ºä¸ºTMAXï¼Œæ­£æ•°ä¸å°äº0ï¼Œä¸º0ï¼›æ­¤æ—¶ä¸ºfalse</p>
<p><strong>B. (x &amp; 7) != 7 || (x&lt;&lt;29&lt; 0)</strong></p>
<p>å·¦è¾¹è¦æ±‚çš„æ˜¯xçš„ä½3ä½ä¸èƒ½éƒ½ä¸º1ï¼›å³è¾¹è¦æ±‚ç¬¬3ä½ä¸º1ï¼ˆå…ˆå·¦ç§»29ä½ï¼Œæ‰€ä»¥æœ‰åŸå§‹çš„ä½3ä½å’Œ29ä½ä¸ª0ç»„æˆï¼Œæ­¤æ—¶å°äº0ï¼Œè¯´æ˜ç¬¦å·ä½ä¸º1ï¼Œå³åŸå§‹çš„ä½3ä½çš„æœ€é«˜é‚£ä¸ªä¸º1ï¼‰ï¼›<br>ä½3ä½åˆ†ä¸¤ç§æƒ…å†µï¼š<br>1ï¼‰é™¤111å¤–çš„æ‰€æœ‰æƒ…å†µï¼šå·¦è¾¹ç¬¦åˆï¼Œå¿…è¿”å›1ï¼Œä¸ç”¨ç®¡å³è¾¹ã€‚<br>2ï¼‰111ï¼šå·¦è¾¹ä¸ç¬¦åˆï¼Œä½†å³è¾¹ç¬¦åˆäº†ï¼Œä¹Ÿè¿”å›1ã€‚<br>è¯¥è¡¨è¾¾å¼å¿…ä¸ºtrueã€‚</p>
<p><strong>C. (x* x) &gt;= 0</strong></p>
<p>x = 182</p>
<p>182*182-65536=33124-65536=-32412</p>
<p><strong>D. x &lt;0 || -x &lt;=0</strong></p>
<p>å½“xä¸º0æ—¶ï¼Œå³è¾¹æˆç«‹ï¼›<br>å½“xä¸º[1,TMAX]ï¼Œå³è¾¹å¿…æˆç«‹ï¼›<br>å½“xä¸º[TMIN+1,-1]ï¼Œå·¦è¾¹æˆç«‹ï¼›<br>å½“xä¸ºTMINï¼Œå·¦å³éƒ½æˆç«‹ï¼›<br>ç»¼ä¸Šï¼Œæ­¤è¡¨è¾¾å¼å¿…ä¸º1.</p>
<p><strong>E. x &gt; 0 || -x &gt;= 0</strong></p>
<p>å½“xä¸º0æ—¶ï¼Œå³è¾¹æˆç«‹ï¼›<br>å½“xä¸º[1,TMAX]ï¼Œå·¦è¾¹æˆç«‹ï¼›<br>å½“xä¸º[TMIN+1,-1]ï¼Œå³è¾¹æˆç«‹ï¼›<br>å½“xä¸ºTMINï¼Œå·¦å³ç†è®ºä¸Šéƒ½ä¸æˆç«‹ï¼ˆå®é™…ä¸Šæœ‰é—®é¢˜ï¼‰ï¼›</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221016132814756.png" alt="image-20221016132814756"></p>
<p><strong>F. x+y == uy+ux</strong></p>
<p>è¡¨è¾¾å¼ä¸­å«æœ‰æ— ç¬¦å·æ•°ï¼Œæ‰€ä»¥å·¦è¾¹ä¹Ÿä¼šè½¬æ¢ä¸ºæ— ç¬¦å·æ•°ã€‚ç­‰ä»·äºunsigned(x+y) == uy+ux.<br>åœ¨äºŒè¿›åˆ¶ä¸Šï¼Œæ— ç¬¦å·æ•°å’Œæœ‰ç¬¦å·æ•°çš„åŠ æ³•æ˜¯ä¸€æ ·çš„ï¼Œæ•…éƒ½ä¸ºçœŸã€‚</p>
<p><strong>G.x*~y + uy*ux=-x</strong></p>
<p>-y = ~y+1,æ•… ~y=-y-1, å·¦è¾¹= x*(-y-1)+uy*ux = uy*ux - x*y -x, ä¸ç®¡æ˜¯æ— ç¬¦å·æ•°è¿˜æ˜¯æœ‰ç¬¦å·æ•°ï¼Œåœ¨äºŒè¿›åˆ¶å±‚é¢ä¸Šç›¸ä¹˜åæˆªçŸ­åçš„ç»“æœéƒ½æ˜¯ç›¸åŒçš„ã€‚æ•… uy*ux-x*y=0, æ•…ç»“æœéƒ½ä¸ºçœŸ</p>
<h2 id="ç»ƒä¹ é¢˜2-45å¡«å†™ä¸‹è¡¨ä¸­çš„ç¼ºå¤±çš„ä¿¡æ¯"><a href="#ç»ƒä¹ é¢˜2-45å¡«å†™ä¸‹è¡¨ä¸­çš„ç¼ºå¤±çš„ä¿¡æ¯" class="headerlink" title="ç»ƒä¹ é¢˜2.45å¡«å†™ä¸‹è¡¨ä¸­çš„ç¼ºå¤±çš„ä¿¡æ¯:"></a>ç»ƒä¹ é¢˜2.45å¡«å†™ä¸‹è¡¨ä¸­çš„ç¼ºå¤±çš„ä¿¡æ¯:</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221018111104045.png" alt="image-20221018111104045"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">å°æ•°å€¼</th>
<th style="text-align:center">äºŒè¿›åˆ¶è¡¨ç¤º</th>
<th style="text-align:center">åè¿›åˆ¶è¡¨ç¤º</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$\frac{1}{8}$</td>
<td style="text-align:center">0.001</td>
<td style="text-align:center">0.125</td>
</tr>
<tr>
<td style="text-align:center">$\frac{3}{4}$</td>
<td style="text-align:center">0.110</td>
<td style="text-align:center">0.75</td>
</tr>
<tr>
<td style="text-align:center">$\frac{25}{16}$</td>
<td style="text-align:center">1.1001</td>
<td style="text-align:center">1.5625</td>
</tr>
<tr>
<td style="text-align:center">$\frac{43}{16}$</td>
<td style="text-align:center">10.1011</td>
<td style="text-align:center">2.6875</td>
</tr>
<tr>
<td style="text-align:center">$\frac{9}{8}$</td>
<td style="text-align:center">1.001</td>
<td style="text-align:center">1.125</td>
</tr>
<tr>
<td style="text-align:center">$\frac{47}{8}$</td>
<td style="text-align:center">101.111</td>
<td style="text-align:center">5.875</td>
</tr>
<tr>
<td style="text-align:center">$\frac{51}{16}$</td>
<td style="text-align:center">11.0011</td>
<td style="text-align:center">3.1875</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-46"><a href="#ç»ƒä¹ é¢˜2-46" class="headerlink" title="ç»ƒä¹ é¢˜2.46"></a>ç»ƒä¹ é¢˜2.46</h2><p>å¤ªé•¿äº†ï¼Œç•¥ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜2-47ï¸°å‡è®¾ä¸€ä¸ªåŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„5ä½æµ®ç‚¹è¡¨ç¤ºï¼Œæœ‰1ä¸ªç¬¦å·ä½ã€2ä¸ªé˜¶ç ä½-k-2-å’Œä¸¤ä¸ªå°æ•°ä½-n-2-ã€‚é˜¶ç åç½®é‡æ˜¯-2-2-1-1-ã€‚"><a href="#ç»ƒä¹ é¢˜2-47ï¸°å‡è®¾ä¸€ä¸ªåŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„5ä½æµ®ç‚¹è¡¨ç¤ºï¼Œæœ‰1ä¸ªç¬¦å·ä½ã€2ä¸ªé˜¶ç ä½-k-2-å’Œä¸¤ä¸ªå°æ•°ä½-n-2-ã€‚é˜¶ç åç½®é‡æ˜¯-2-2-1-1-ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.47ï¸°å‡è®¾ä¸€ä¸ªåŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„5ä½æµ®ç‚¹è¡¨ç¤ºï¼Œæœ‰1ä¸ªç¬¦å·ä½ã€2ä¸ªé˜¶ç ä½(k=2)å’Œä¸¤ä¸ªå°æ•°ä½(n=2)ã€‚é˜¶ç åç½®é‡æ˜¯$2^{2-1}=1$ã€‚"></a>ç»ƒä¹ é¢˜2.47ï¸°å‡è®¾ä¸€ä¸ªåŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„5ä½æµ®ç‚¹è¡¨ç¤ºï¼Œæœ‰1ä¸ªç¬¦å·ä½ã€2ä¸ªé˜¶ç ä½(k=2)å’Œä¸¤ä¸ªå°æ•°ä½(n=2)ã€‚é˜¶ç åç½®é‡æ˜¯$2^{2-1}=1$ã€‚</h2><p>ä¸‹è¡¨ä¸­åˆ—ä¸¾äº†è¿™ä¸ª5ä½æµ®ç‚¹è¡¨ç¤ºçš„å…¨éƒ¨éè´Ÿå–å€¼èŒƒå›´ã€‚ä½¿ç”¨ä¸‹é¢çš„æ¡ä»¶ï¼Œå¡«å†™è¡¨æ ¼ä¸­çš„ç©ºç™½é¡¹:</p>
<p>$e$:å‡å®šé˜¶ç å­—æ®µæ˜¯ä¸€ä¸ªæ— ç¬¦å·æ•´æ•°æ‰€è¡¨ç¤ºçš„å€¼ã€‚</p>
<p>$E$:åç½®ä¹‹åçš„é˜¶ç å€¼ã€‚</p>
<p>$2^E$:é˜¶ç çš„æƒé‡ã€‚</p>
<p>$f$ :å°æ•°å€¼ã€‚</p>
<p>$M$:å°¾æ•°çš„å€¼ã€‚</p>
<p>$2^EÃ—M$:è¯¥æ•°(æœªå½’çº¦çš„)å°æ•°å€¼ã€‚</p>
<p>$V$:è¯¥æ•°å½’çº¦åçš„å°æ•°å€¼ã€‚</p>
<p>åè¿›åˆ¶:è¯¥æ•°çš„åè¿›åˆ¶è¡¨ç¤ºã€‚</p>
<p>å†™å‡º$2^E$ã€fã€Mã€$2^E\times M$å’ŒVçš„å€¼ï¼Œè¦ä¹ˆæ˜¯æ•´æ•°(å¦‚æœå¯èƒ½çš„è¯)ï¼Œè¦ä¹ˆæ˜¯å½¢å¦‚$\frac{x}{y}$çš„å°æ•°ï¼Œè¿™é‡Œyæ˜¯2çš„å¹‚ã€‚æ ‡æ³¨ä¸ºâ€œâ€”â€çš„æ¡ç›®ä¸ç”¨å¡«ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221018154232508.png" alt="image-20221018154232508"></p>
<p>åç½®é‡æ˜¯$2^{2-1}-1=1$</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">ä½</th>
<th style="text-align:center">e</th>
<th style="text-align:center">$E$</th>
<th style="text-align:center">$2^E$</th>
<th style="text-align:center">$f$</th>
<th style="text-align:center">$M$</th>
<th style="text-align:center">$2^E \times M$</th>
<th style="text-align:center">$V$</th>
<th style="text-align:center">åè¿›åˆ¶</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0 00 00</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{0}{4}$</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0.0</td>
</tr>
<tr>
<td style="text-align:center">0 00 01</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">0.25</td>
</tr>
<tr>
<td style="text-align:center">0 00 10</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{2}{4}$</td>
<td style="text-align:center">$\frac{2}{4}$</td>
<td style="text-align:center">$\frac{2}{4}$</td>
<td style="text-align:center">$\frac{1}{2}$</td>
<td style="text-align:center">0.5</td>
</tr>
<tr>
<td style="text-align:center">0 00 11</td>
<td style="text-align:center">0</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{3}{4}$</td>
<td style="text-align:center">$\frac{3}{4}$</td>
<td style="text-align:center">$\frac{3}{4}$</td>
<td style="text-align:center">$\frac{3}{4}$</td>
<td style="text-align:center">0.75</td>
</tr>
<tr>
<td style="text-align:center">0 01 00</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{0}{4}$</td>
<td style="text-align:center">$\frac{4}{4}$</td>
<td style="text-align:center">$\frac{4}{4}$</td>
<td style="text-align:center">$1$</td>
<td style="text-align:center">1.0</td>
</tr>
<tr>
<td style="text-align:center">0 01 01</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">$\frac{5}{4}$</td>
<td style="text-align:center">$\frac{5}{4}$</td>
<td style="text-align:center">$\frac{5}{4}$</td>
<td style="text-align:center">1.25</td>
</tr>
<tr>
<td style="text-align:center">0 01 11</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0</td>
<td style="text-align:center">1</td>
<td style="text-align:center">$\frac{2}{4}$</td>
<td style="text-align:center">$\frac{6}{4}$</td>
<td style="text-align:center">$\frac{6}{4}$</td>
<td style="text-align:center">$\frac{3}{2}$</td>
<td style="text-align:center">1.5</td>
</tr>
<tr>
<td style="text-align:center">0 10 00</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">0</td>
<td style="text-align:center">$\frac{4}{4}$</td>
<td style="text-align:center">$\frac{8}{4}$</td>
<td style="text-align:center">$2$</td>
<td style="text-align:center">2</td>
</tr>
<tr>
<td style="text-align:center">0 10 01</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">$\frac{1}{4}$</td>
<td style="text-align:center">$\frac{5}{4}$</td>
<td style="text-align:center">$\frac{10}{4}$</td>
<td style="text-align:center">$\frac{5}{2}$</td>
<td style="text-align:center">2.5</td>
</tr>
<tr>
<td style="text-align:center">0 10 11</td>
<td style="text-align:center">2</td>
<td style="text-align:center">1</td>
<td style="text-align:center">2</td>
<td style="text-align:center">$\frac{2}{4}$</td>
<td style="text-align:center">$\frac{6}{4}$</td>
<td style="text-align:center">$\frac{12}{4}$</td>
<td style="text-align:center">$3$</td>
<td style="text-align:center">3</td>
</tr>
<tr>
<td style="text-align:center">0 11 00</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">$+\infty$</td>
<td style="text-align:center">â€”â€”</td>
</tr>
<tr>
<td style="text-align:center">0 11 01</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">NAN</td>
<td style="text-align:center">â€”â€”</td>
</tr>
<tr>
<td style="text-align:center">0 11 10</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">NAN</td>
<td style="text-align:center">â€”â€”</td>
</tr>
<tr>
<td style="text-align:center">0 11 11</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">â€”â€”</td>
<td style="text-align:center">NAN</td>
<td style="text-align:center">â€”â€”</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-48æ­£å¦‚åœ¨ç»ƒä¹ é¢˜2-6ä¸­æåˆ°çš„ï¼Œæ•´æ•°3-510-593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141ï¼Œè€Œå•ç²¾åº¦æµ®ç‚¹æ•°3510593-0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x42564504ã€‚æ¨å¯¼å‡ºè¿™ä¸ªæµ®ç‚¹è¡¨ç¤ºï¼Œå¹¶è§£é‡Šæ•´æ•°å’Œæµ®ç‚¹æ•°è¡¨ç¤ºçš„ä½ä¹‹é—´çš„å…³ç³»ã€‚"><a href="#ç»ƒä¹ é¢˜2-48æ­£å¦‚åœ¨ç»ƒä¹ é¢˜2-6ä¸­æåˆ°çš„ï¼Œæ•´æ•°3-510-593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141ï¼Œè€Œå•ç²¾åº¦æµ®ç‚¹æ•°3510593-0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x42564504ã€‚æ¨å¯¼å‡ºè¿™ä¸ªæµ®ç‚¹è¡¨ç¤ºï¼Œå¹¶è§£é‡Šæ•´æ•°å’Œæµ®ç‚¹æ•°è¡¨ç¤ºçš„ä½ä¹‹é—´çš„å…³ç³»ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.48æ­£å¦‚åœ¨ç»ƒä¹ é¢˜2.6ä¸­æåˆ°çš„ï¼Œæ•´æ•°3 510 593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141ï¼Œè€Œå•ç²¾åº¦æµ®ç‚¹æ•°3510593.0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x42564504ã€‚æ¨å¯¼å‡ºè¿™ä¸ªæµ®ç‚¹è¡¨ç¤ºï¼Œå¹¶è§£é‡Šæ•´æ•°å’Œæµ®ç‚¹æ•°è¡¨ç¤ºçš„ä½ä¹‹é—´çš„å…³ç³»ã€‚"></a>ç»ƒä¹ é¢˜2.48æ­£å¦‚åœ¨ç»ƒä¹ é¢˜2.6ä¸­æåˆ°çš„ï¼Œæ•´æ•°3 510 593çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x00359141ï¼Œè€Œå•ç²¾åº¦æµ®ç‚¹æ•°3510593.0çš„åå…­è¿›åˆ¶è¡¨ç¤ºä¸º0x42564504ã€‚æ¨å¯¼å‡ºè¿™ä¸ªæµ®ç‚¹è¡¨ç¤ºï¼Œå¹¶è§£é‡Šæ•´æ•°å’Œæµ®ç‚¹æ•°è¡¨ç¤ºçš„ä½ä¹‹é—´çš„å…³ç³»ã€‚</h2><p>æ•´æ•° 0x00359141 = 0000 0000 0011 0101 1001 0001 0100 0001</p>
<p>è½¬æ¢æˆæµ®ç‚¹è¡¨ç¤ºæ—¶, å…ˆå°†å°æ•°ç‚¹æ”¾åœ¨å€¼ä¸º 1 çš„æœ€é«˜æœ‰æ•ˆä½çš„å³è¾¹, å¾—åˆ° $1.1 0101 1001 0001 0100 0001_2\times 2^{21} $ã€‚</p>
<p>å› æ­¤å°¾æ•°å€¼ä¸º$1.101011001000101000001_2$ï¼Œèˆå¼ƒå¼€å¤´çš„1ï¼Œæœ«å°¾è¿˜éœ€è¦å¢åŠ ä¸¤ä¸ª0 ï¼ˆæ€»å…±å°¾æ•°23ä½ï¼‰ï¼Œå°¾æ•°éƒ¨åˆ†ä¸º$101 0110 0100 0101 0000 0100$ã€‚</p>
<p>å¯¹äºé˜¶ç ä½æ•° k=8ï¼Œ$Bias =2^{k-1}-1=2^7-1=127$ï¼ŒæŒ‡æ•°å€¼ E = 21, E = e-B, ä»è€Œ e= 21+127=148,148 = 1001 0100</p>
<p>å¯¹äºç¬¦å·ä½ï¼Œç›´æ¥ä¸º0</p>
<p>ç»¼ä¸Šï¼Œ3510593.0 çš„æµ®ç‚¹è¡¨ç¤ºä¸º 0 10010100 10101100100010100000100</p>
<p>è€Œ 0x4a564504 çš„ä½æ¨¡å¼åˆšå¥½ä¸º 010010100101 0110 0100 0101 0000 0100</p>
<h2 id="ç»ƒä¹ é¢˜2-49"><a href="#ç»ƒä¹ é¢˜2-49" class="headerlink" title="ç»ƒä¹ é¢˜2.49"></a>ç»ƒä¹ é¢˜2.49</h2><p>A. å¯¹äºä¸€ç§å…·æœ‰nä½å°æ•°çš„æµ®ç‚¹æ ¼å¼ï¼Œç»™å‡ºä¸èƒ½å‡†ç¡®æè¿°çš„æœ€å°æ­£æ•´æ•°çš„å…¬å¼(å› ä¸ºè¦æƒ³å‡†ç¡®è¡¨ç¤ºå®ƒéœ€è¦nï¼‹1ä½å°æ•°)ã€‚å‡è®¾é˜¶ç å­—æ®µé•¿åº¦kè¶³å¤Ÿå¤§ï¼Œå¯ä»¥è¡¨ç¤ºçš„é˜¶ç èŒƒå›´ä¸ä¼šé™åˆ¶è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>è¯¥ç»ƒä¹ æœ‰åŠ©äºæˆ‘ä»¬æ€è€ƒä»€ä¹ˆæ•°ä¸èƒ½ç”¨æµ®ç‚¹æ•°ç²¾ç¡®è¡¨ç¤ºï¼Œå› ä¸ºé˜¶ç èŒƒå›´ä¸é™åˆ¶, æ•…åªéœ€è€ƒè™‘å°æ•°éƒ¨åˆ†æœ€å°èƒ½è¡¨ç¤ºçš„æ•°å³å¯ã€‚</p>
<p>å°æ•°æœ€å¤š n ä½, æ•…æœ€å°èƒ½è¡¨ç¤ºçš„å°æ•° f æ˜¯ n ä¸ª 0 åé¢å†åŠ ä¸€ä¸ª 1, è¿™ä¸ªå°æ•°éœ€è¦ n+1 ä¸ªä½æ¥è¡¨ç¤º, é‚£ä¹ˆå°¾æ•° $M = f+1 =1.0000â‹¯01_2$</p>
<p>å³è¦ç¤ºçš„æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸ºï¼š1 åé¢è·Ÿ n ä¸ª 0, å†è·Ÿä¸€ä¸ª 1, å€¼ä¸º$2^{n+1}+1$</p>
<p>B. å¯¹äºå•ç²¾åº¦æ ¼å¼(n=23)ï¼Œè¿™ä¸ªæ•´æ•°çš„æ•°å­—å€¼æ˜¯å¤šå°‘?</p>
<p>å¯¹äºå•ç²¾åº¦æ ¼å¼ n=23, è¿™ä¸ªæ•°ä¸º $2^{24}+1=16777217$</p>
<h2 id="ç»ƒä¹ é¢˜2-50æ ¹æ®èˆå…¥åˆ°å¶æ•°è§„åˆ™ï¼Œè¯´æ˜å¦‚ä½•å°†ä¸‹åˆ—äºŒè¿›åˆ¶å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„äºŒåˆ†ä¹‹ä¸€-äºŒè¿›åˆ¶å°æ•°ç‚¹å³è¾¹1ä½-ã€‚å¯¹æ¯ç§æƒ…å†µï¼Œç»™å‡ºèˆå…¥å‰åçš„æ•°å­—å€¼ã€‚"><a href="#ç»ƒä¹ é¢˜2-50æ ¹æ®èˆå…¥åˆ°å¶æ•°è§„åˆ™ï¼Œè¯´æ˜å¦‚ä½•å°†ä¸‹åˆ—äºŒè¿›åˆ¶å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„äºŒåˆ†ä¹‹ä¸€-äºŒè¿›åˆ¶å°æ•°ç‚¹å³è¾¹1ä½-ã€‚å¯¹æ¯ç§æƒ…å†µï¼Œç»™å‡ºèˆå…¥å‰åçš„æ•°å­—å€¼ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.50æ ¹æ®èˆå…¥åˆ°å¶æ•°è§„åˆ™ï¼Œè¯´æ˜å¦‚ä½•å°†ä¸‹åˆ—äºŒè¿›åˆ¶å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„äºŒåˆ†ä¹‹ä¸€(äºŒè¿›åˆ¶å°æ•°ç‚¹å³è¾¹1ä½)ã€‚å¯¹æ¯ç§æƒ…å†µï¼Œç»™å‡ºèˆå…¥å‰åçš„æ•°å­—å€¼ã€‚"></a>ç»ƒä¹ é¢˜2.50æ ¹æ®èˆå…¥åˆ°å¶æ•°è§„åˆ™ï¼Œè¯´æ˜å¦‚ä½•å°†ä¸‹åˆ—äºŒè¿›åˆ¶å°æ•°å€¼èˆå…¥åˆ°æœ€æ¥è¿‘çš„äºŒåˆ†ä¹‹ä¸€(äºŒè¿›åˆ¶å°æ•°ç‚¹å³è¾¹1ä½)ã€‚å¯¹æ¯ç§æƒ…å†µï¼Œç»™å‡ºèˆå…¥å‰åçš„æ•°å­—å€¼ã€‚</h2><p>A.$10.010_2 = 10.0$</p>
<p>B.$10.011_2 = 10.1$</p>
<p>C.$10.110_2 = 11.0$</p>
<p>D.$11.001_2=11.0$</p>
<h2 id="ç»ƒä¹ é¢˜2-51"><a href="#ç»ƒä¹ é¢˜2-51" class="headerlink" title="ç»ƒä¹ é¢˜2.51"></a>ç»ƒä¹ é¢˜2.51</h2><h2 id="ç»ƒä¹ é¢˜2-52è€ƒè™‘ä¸‹åˆ—åŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„7ä½æµ®ç‚¹è¡¨ç¤ºã€‚ä¸¤ä¸ªæ ¼å¼éƒ½æ²¡æœ‰ç¬¦å·ä½â€”â€”å®ƒä»¬åªèƒ½è¡¨ç¤ºéè´Ÿçš„æ•°å­—ã€‚"><a href="#ç»ƒä¹ é¢˜2-52è€ƒè™‘ä¸‹åˆ—åŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„7ä½æµ®ç‚¹è¡¨ç¤ºã€‚ä¸¤ä¸ªæ ¼å¼éƒ½æ²¡æœ‰ç¬¦å·ä½â€”â€”å®ƒä»¬åªèƒ½è¡¨ç¤ºéè´Ÿçš„æ•°å­—ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜2.52è€ƒè™‘ä¸‹åˆ—åŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„7ä½æµ®ç‚¹è¡¨ç¤ºã€‚ä¸¤ä¸ªæ ¼å¼éƒ½æ²¡æœ‰ç¬¦å·ä½â€”â€”å®ƒä»¬åªèƒ½è¡¨ç¤ºéè´Ÿçš„æ•°å­—ã€‚"></a>ç»ƒä¹ é¢˜2.52è€ƒè™‘ä¸‹åˆ—åŸºäºIEEEæµ®ç‚¹æ ¼å¼çš„7ä½æµ®ç‚¹è¡¨ç¤ºã€‚ä¸¤ä¸ªæ ¼å¼éƒ½æ²¡æœ‰ç¬¦å·ä½â€”â€”å®ƒä»¬åªèƒ½è¡¨ç¤ºéè´Ÿçš„æ•°å­—ã€‚</h2><p>1.æ ¼å¼A</p>
<ul>
<li>æœ‰k=3ä¸ªé˜¶ç ä½ã€‚é˜¶ç çš„åç½®å€¼æ˜¯3ã€‚</li>
<li>æœ‰n=4ä¸ªå°æ•°1ã€‚</li>
</ul>
<p>2.æ ¼å¼B</p>
<ul>
<li>æœ‰k=4ä¸ªé˜¶ç ä½ã€‚é˜¶ç çš„åç½®å€¼æ˜¯7ã€‚</li>
<li>æœ‰n=3ä¸ªå°æ•°ä½ã€‚</li>
</ul>
<p>ä¸‹é¢ç»™å‡ºäº†ä¸€äº›æ ¼å¼Aè¡¨ç¤ºçš„ä½æ¨¡å¼ï¼Œä½ çš„ä»»åŠ¡æ˜¯å°†å®ƒä»¬è½¬æ¢æˆæ ¼å¼Bä¸­æœ€æ¥è¿‘çš„å€¼ã€‚å¦‚æœéœ€è¦ï¼Œè¯·ä½¿ç”¨èˆå…¥åˆ°å¶æ•°çš„èˆå…¥åŸåˆ™ã€‚å¦å¤–ï¼Œç»™å‡ºç”±æ ¼å¼Aå’Œæ ¼å¼Bè¡¨ç¤ºçš„ä½æ¨¡å¼å¯¹åº”çš„æ•°å­—çš„å€¼ã€‚ç»™å‡ºæ•´æ•°(ä¾‹å¦‚17)æˆ–è€…å°æ•°(ä¾‹å¦‚17/64)ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221019191037787.png" alt="image-20221019191037787"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ ¼å¼A</th>
<th style="text-align:center"></th>
<th style="text-align:center">æ ¼å¼B</th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ä½</td>
<td style="text-align:center">å€¼</td>
<td style="text-align:center">ä½</td>
<td style="text-align:center">å€¼</td>
</tr>
<tr>
<td style="text-align:center">011 0000</td>
<td style="text-align:center">1</td>
<td style="text-align:center">0111 000</td>
<td style="text-align:center">1</td>
</tr>
<tr>
<td style="text-align:center">101 1110</td>
<td style="text-align:center">$\frac{15}{2}$</td>
<td style="text-align:center">1001 111</td>
<td style="text-align:center">$\frac{15}{2}$</td>
</tr>
<tr>
<td style="text-align:center">010 1001</td>
<td style="text-align:center">$\frac{25}{32}$</td>
<td style="text-align:center">0110 100</td>
<td style="text-align:center">$\frac{3}{4}$</td>
</tr>
<tr>
<td style="text-align:center">110 1111</td>
<td style="text-align:center">$\frac{31}{2}$</td>
<td style="text-align:center">1010 000</td>
<td style="text-align:center">16</td>
</tr>
<tr>
<td style="text-align:center">000 0001</td>
<td style="text-align:center">$\frac{1}{64}$</td>
<td style="text-align:center">0001 000</td>
<td style="text-align:center">$\frac{1}{64}$</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜2-53å®Œæˆä¸‹åˆ—å®å®šä¹‰ï¼Œç”ŸæˆåŒç²¾åº¦å€¼-âˆ-âˆ’âˆå’Œ-0"><a href="#ç»ƒä¹ é¢˜2-53å®Œæˆä¸‹åˆ—å®å®šä¹‰ï¼Œç”ŸæˆåŒç²¾åº¦å€¼-âˆ-âˆ’âˆå’Œ-0" class="headerlink" title="ç»ƒä¹ é¢˜2.53å®Œæˆä¸‹åˆ—å®å®šä¹‰ï¼Œç”ŸæˆåŒç²¾åº¦å€¼+âˆ, âˆ’âˆå’Œ 0:"></a>ç»ƒä¹ é¢˜2.53å®Œæˆä¸‹åˆ—å®å®šä¹‰ï¼Œç”ŸæˆåŒç²¾åº¦å€¼+âˆ, âˆ’âˆå’Œ 0:</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define POS_INFINITY 1e400</span><br><span class="line">#define NEG_INFINITY (-POS_INFINITY)</span><br><span class="line">#define NEG_ZERO (-1.0/POS_INFINITY)</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-2-54-å‡è®¾å˜é‡-x-f-d-ç±»å‹åˆ†åˆ«æ˜¯-int-float-double-å®ƒä»¬é™¤äº†ä¸æ˜¯-âˆ-âˆ’âˆ-å’Œ-NaN-å¤–-å¯ä»¥æ˜¯ä»»æ„å€¼-å¯¹äºä¸‹é¢çš„æ¯ä¸ª-C-è¡¨è¾¾å¼-è¯æ˜å®ƒä»¬æ€»æ˜¯çœŸï¼ˆä¹Ÿå°±æ˜¯æ±‚å€¼ä¸º1ï¼‰-æˆ–è€…ç»™å‡ºä¸€ä¸ªä½¿å…¶ä¸ä¸ºçœŸçš„å€¼ï¼ˆå°±æ˜¯æ±‚å€¼ä¸º0-ã€‚"><a href="#ç»ƒä¹ é¢˜-2-54-å‡è®¾å˜é‡-x-f-d-ç±»å‹åˆ†åˆ«æ˜¯-int-float-double-å®ƒä»¬é™¤äº†ä¸æ˜¯-âˆ-âˆ’âˆ-å’Œ-NaN-å¤–-å¯ä»¥æ˜¯ä»»æ„å€¼-å¯¹äºä¸‹é¢çš„æ¯ä¸ª-C-è¡¨è¾¾å¼-è¯æ˜å®ƒä»¬æ€»æ˜¯çœŸï¼ˆä¹Ÿå°±æ˜¯æ±‚å€¼ä¸º1ï¼‰-æˆ–è€…ç»™å‡ºä¸€ä¸ªä½¿å…¶ä¸ä¸ºçœŸçš„å€¼ï¼ˆå°±æ˜¯æ±‚å€¼ä¸º0-ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜ 2.54 å‡è®¾å˜é‡ x, f, d ç±»å‹åˆ†åˆ«æ˜¯ int, float, double, å®ƒä»¬é™¤äº†ä¸æ˜¯ +âˆ, âˆ’âˆ å’Œ NaN å¤–,å¯ä»¥æ˜¯ä»»æ„å€¼, å¯¹äºä¸‹é¢çš„æ¯ä¸ª C è¡¨è¾¾å¼, è¯æ˜å®ƒä»¬æ€»æ˜¯çœŸï¼ˆä¹Ÿå°±æ˜¯æ±‚å€¼ä¸º1ï¼‰,æˆ–è€…ç»™å‡ºä¸€ä¸ªä½¿å…¶ä¸ä¸ºçœŸçš„å€¼ï¼ˆå°±æ˜¯æ±‚å€¼ä¸º0)ã€‚"></a>ç»ƒä¹ é¢˜ 2.54 å‡è®¾å˜é‡ x, f, d ç±»å‹åˆ†åˆ«æ˜¯ int, float, double, å®ƒä»¬é™¤äº†ä¸æ˜¯ +âˆ, âˆ’âˆ å’Œ NaN å¤–,å¯ä»¥æ˜¯ä»»æ„å€¼, å¯¹äºä¸‹é¢çš„æ¯ä¸ª C è¡¨è¾¾å¼, è¯æ˜å®ƒä»¬æ€»æ˜¯çœŸï¼ˆä¹Ÿå°±æ˜¯æ±‚å€¼ä¸º1ï¼‰,æˆ–è€…ç»™å‡ºä¸€ä¸ªä½¿å…¶ä¸ä¸ºçœŸçš„å€¼ï¼ˆå°±æ˜¯æ±‚å€¼ä¸º0)ã€‚</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">A.x == (<span class="type">int</span>)(<span class="type">double</span>) x</span><br><span class="line">B.x == (<span class="type">int</span>)(<span class="type">float</span>) x</span><br><span class="line">C.d == (<span class="type">double</span>)(<span class="type">float</span>) d</span><br><span class="line">D.f == (<span class="type">float</span>)(<span class="type">double</span>)f</span><br><span class="line">E.f == -(-f)</span><br><span class="line">F<span class="number">.1</span><span class="number">.0</span>/<span class="number">2</span> == <span class="number">1</span>/<span class="number">2.0</span></span><br><span class="line">G.d*d &gt;= <span class="number">0.0</span></span><br><span class="line">H. (f+d)-f == d</span><br></pre></td></tr></table></figure>
<p>float çš„æœ€å¤§è§„æ ¼åŒ–æ•°æ˜¯ 3.4e38, å°äº 1e40, double çš„æœ€å¤§è§„æ ¼åŒ–æ•°æ˜¯ 1.8e308, å°äº 1e309.</p>
<p>A.  x == (int)(double) x : int è½¬æ¢åˆ° double æ—¶èƒ½ç²¾ç¡®è½¬æ¢, æ•…æ€»ä¸ºçœŸ</p>
<p>B.x == (int)(float) x: int åˆ° float, ä¸æº¢å‡º, å¯èƒ½èˆå…¥, æ ¹æ®ç»ƒä¹ é¢˜ 2.49, æœ€å°ä¸èƒ½è¡¨ç¤ºçš„æ­£æ•°æ˜¯$2^{23}+1$ï¼Œæ­¤æ—¶ä¼šèˆå…¥åˆ°$2^{23}$</p>
<p>C. d == (double)(float) d: double è½¬æ¢åˆ° float ä¼šæº¢å‡º,ä¹Ÿä¼šèˆå…¥, d = 1e40 æ—¶å³è¾¹ä¼šæ˜¯æ­£æ— ç©·</p>
<p>D. f == (float)(double)f:ã€€éƒ½ä¸ºçœŸ</p>
<p>E. f == -(-f): éƒ½ä¸ºçœŸ, å› ä¸ºæµ®ç‚¹æ•°çš„æ­£è´Ÿè½¬æ¢åªéœ€è½¬æ¢ç¬¦å·ä½å³å¯.</p>
<p>F. 1.0/2 == 1/2.0:ã€€éƒ½ä¸ºçœŸ, å› ä¸ºåˆ†å­å’Œåˆ†æ¯åœ¨è¿ç®—å‰éƒ½ä¼šå…ˆè½¬æ¢æˆæµ®ç‚¹æ•°ï¼</p>
<p>G. d*d &gt;= 0.0ï¼šå®æ•°ä¹˜æ³•ç¬¦åˆå•è°ƒæ€§, æ•…éƒ½ä¸ºçœŸ, ä¸è¿‡å¯èƒ½æº¢å‡ºä¸º +âˆ</p>
<p>H. (f+d)-f == d: å½“ f+d æº¢å‡ºæ—¶, ä¸ä¸ºçœŸ, ä¾‹å¦‚ f=1e20, d=1.0 æ—¶, å·¦è¾¹ä¼š 0,å³è¾¹ ä¸º 1.0</p>
]]></content>
      <categories>
        <category>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« </tag>
        <tag>CSAPP</tag>
      </tags>
  </entry>
  <entry>
    <title>A Survey on Temporal Action Localization</title>
    <url>/2021/06/15/%E8%AE%BA%E6%96%87%E5%AD%A6%E4%B9%A0/A%20Survey%20on%20Temporal%20Action%20Localization/</url>
    <content><![CDATA[<p>[toc]</p>
<h1 id="A-Survey-on-Temporal-Action-Localization"><a href="#A-Survey-on-Temporal-Action-Localization" class="headerlink" title="A Survey on Temporal Action Localization"></a>A Survey on Temporal Action Localization</h1><blockquote>
<p><strong>æ‘˜è¦:</strong>åœ¨è®¡ç®—æœºè§†è§‰ä¸­ï¼Œæ—¶é—´åŠ¨ä½œå®šä½æ˜¯è§†é¢‘ç†è§£ä¸­æœ€å…³é”®ä¹Ÿæ˜¯æœ€å…·æŒ‘æˆ˜æ€§çš„é—®é¢˜ä¹‹ä¸€ã€‚ç”±äºå…¶å¹¿æ³›çš„åº”ç”¨ï¼Œè¿‘å¹´æ¥å¼•èµ·äº†å¹¿æ³›çš„å…³æ³¨æ—¥å¸¸ç”Ÿæ´»åº”ç”¨ã€‚æ—¶é—´åŠ¨ä½œå®šä½æŠ€æœ¯å·²ç»å–å¾—äº†å¾ˆå¤§çš„è¿›å±•ï¼Œç‰¹åˆ«æ˜¯æœ€è¿‘æ·±åº¦å­¦ä¹ çš„å‘å±•ã€‚è€Œä¸”åœ¨æœªè£å‰ªçš„æƒ…å†µä¸‹ï¼Œç°åœ¨éœ€è¦æ›´å¤šçš„æ—¶é—´åŠ¨ä½œå®šä½è§†é¢‘ã€‚åœ¨è¿™ç¯‡è®ºæ–‡ä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯è°ƒæŸ¥æœ€æ–°çš„æŠ€æœ¯å’Œæ¨¡å‹çš„è§†é¢‘æ—¶é—´è¡ŒåŠ¨å®šä½ã€‚ä¸»è¦åŒ…æ‹¬ç›¸å…³æŠ€æœ¯ã€ä¸€äº›åŸºå‡†æ•°æ®é›†å’Œè¯„ä»·æ—¶é—´åŠ¨ä½œå®šä½çš„åº¦é‡ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬ä»ä¸¤ä¸ªæ–¹é¢æ€»ç»“äº†æ—¶é—´åŠ¨ä½œå®šä½å„æ–¹é¢:å…¨ç›‘ç£å­¦ä¹ å’Œå¼±ç›‘ç£å­¦ä¹ ã€‚å¹¶åˆ—ä¸¾äº†å‡ éƒ¨å…·æœ‰ä»£è¡¨æ€§çš„ä½œå“å¹¶æ¯”è¾ƒä»–ä»¬å„è‡ªçš„è¡¨ç°ã€‚æœ€åï¼Œå¯¹å…¶è¿›è¡Œäº†æ·±å…¥åˆ†æï¼Œå¹¶æå‡ºäº†å‘å±•å‰æ™¯ç ”ç©¶æ–¹å‘ï¼Œå¹¶æ€»ç»“è°ƒæŸ¥ã€‚</p>
</blockquote>
<p><strong>å…³é”®è¯</strong>ï¼šåŠ¨ä½œæ£€æµ‹ï¼Œè®¡ç®—æœºè§†è§‰ï¼Œå…¨ç›‘ç£å­¦ä¹ ï¼Œæ—¶é—´åŠ¨ä½œå®šä½ï¼Œå¼±ç›‘ç£å­¦ä¹ ã€‚</p>
<h2 id="1-å¼•è¨€"><a href="#1-å¼•è¨€" class="headerlink" title="1.å¼•è¨€"></a>1.å¼•è¨€</h2><p>éšç€è§†é¢‘æ•°é‡æ€¥å‰§çš„å¢é•¿ï¼Œè§†é¢‘ç†è§£æˆä¸ºäº†è®¡ç®—æœºè§†è§‰é¢†åŸŸçš„ä¸€ä¸ªçƒ­ç‚¹é—®é¢˜å’Œå…·æœ‰æŒ‘æˆ˜æ€§çš„æ–¹å‘ã€‚è¿™ä¸ªè§†é¢‘ç†è§£å‘ä¸ªä¿¡åŒ…æ‹¬è®¸å¤šå­ç ”ç©¶æ–¹å‘ï¼ŒåŒ…æ‹¬åœ¨å¤å¨å¤·ï¼Œè¢«CVPRä¸¾åŠçš„ActivityNet æŒ‘æˆ˜2017ï¼Œè¿™ä¸ªç½‘ç»œä¸€å…±æå‡ºäº†5ä¸ªä»»åŠ¡ã€‚</p>
<ul>
<li>æœªè£å‰ªçš„è§†é¢‘åˆ†ç±»(Untrimmed Video Classification )</li>
<li>è£å‰ªåçš„è¡ŒåŠ¨è¯†åˆ«( Trimmed Action Recognition)</li>
<li>æ—¶é—´åŠ¨ä½œæ£€æµ‹( Temporal Action Proposals)</li>
<li>æ—¶é—´åŠ¨ä½œå®šä½(Temporal Action Localization)</li>
<li>è§†é¢‘ä¸­å¯†é›†çš„å­—å¹•äº‹ä»¶(Dense-Captioning Events in Videos)</li>
</ul>
<p>åœ¨æœ€è¿‘çš„è°ƒæŸ¥ä¸­ï¼Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯æ—¶é—´åŠ¨ä½œå®šä½ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢åˆ—å‡ºçš„ç¬¬å››ä¸ªã€‚å®ƒéœ€è¦æ£€æµ‹åŒ…å«ç›®æ ‡åŠ¨ä½œçš„æ—¶é—´é—´éš”ã€‚å¯¹äºé•¿æ—¶é—´çš„<strong>æœªè£å‰ªçš„è§†é¢‘</strong>ï¼Œæ—¶é—´åŠ¨ä½œå®šä½ä¸»è¦è§£å†³ä¸¤ä¸ªä»»åŠ¡ï¼Œè¯†åˆ«å’Œå®šä½ã€‚ç‰¹åˆ«æ˜¯,a)åŠ¨ä½œå‘ç”Ÿçš„èµ·å§‹æ—¶é—´å’Œç»ˆæ­¢æ—¶é—´,b)æ¯ä¸ªææ¡ˆçš„ç±»åˆ«æ˜¯ä»€ä¹ˆå±äº(å¦‚æŒ¥æ‰‹ã€çˆ¬å±±ã€æ‰£ç¯®)ã€‚å½“ç„¶ï¼Œä¸€ä¸ªè§†é¢‘å¯èƒ½åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªè¡ŒåŠ¨å‰ªè¾‘(action clips),æ‰€ä»¥æ—¶é—´åŠ¨ä½œå®šä½æ˜¯è¦å¼€å‘æ¨¡å‹å’ŒæŠ€æœ¯æ¥æä¾›è®¡ç®—æœºè§†è§‰åº”ç”¨æ‰€éœ€è¦çš„æœ€åŸºæœ¬çš„ä¿¡æ¯:åŠ¨ä½œæ˜¯ä»€ä¹ˆï¼ŒåŠ¨ä½œä»€ä¹ˆæ—¶å€™å‘ç”Ÿ?æˆ‘ä»¬å°†è¿™ä¸ªä»»åŠ¡ä½œä¸ºåŠ¨ä½œå®šä½ï¼Œæˆ–æ—¶é—´åŠ¨ä½œå®šä½ï¼Œæˆ–åŠ¨ä½œæ£€æµ‹ã€‚</p>
<p>è™½ç„¶åŠ¨ä½œè¯†åˆ«å’ŒåŠ¨ä½œæœ¬åœ°åŒ–éƒ½æ˜¯è§†é¢‘ç†è§£é‡Œé¢å¾ˆé‡è¦çš„ä»»åŠ¡ï¼Œä½†æ˜¯æ—¶é—´åŠ¨ä½œå®šä½æ¯”åŠ¨ä½œè¯†åˆ«æ›´åŠ å…·æœ‰æŒ‘æˆ˜æ€§ã€‚åŠ¨ä½œè¯†åˆ«å’ŒåŠ¨ä½œå®šä½çš„å…³ç³»å’Œå›¾åƒæ£€æµ‹ç±»ä¼¼äºå›¾åƒè¯†åˆ«å’Œå›¾åƒæ£€æµ‹ã€‚ä½†æ˜¯ç”±äºæ—¶é—´è¿ç»­ä¿¡æ¯(temporal series information),æ—¶é—´åŠ¨ä½œå®šä½æ¯”å›¾åƒæ£€æµ‹æ›´è§å›°éš¾ã€‚å›°éš¾ä¸»è¦æ¥è‡ªä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š<strong>a)</strong>æ—¶é—´ä¿¡æ¯ï¼Œç”±äº1ç»´æ—¶é—´è¿ç»­ä¿¡æ¯ï¼Œæ—¶é—´åŠ¨ä½œå®šä½ä¸èƒ½ä½¿ç”¨é™æ€å›¾ç‰‡ä¿¡æ¯ï¼Œå®ƒå¿…é¡»ç»“åˆæ—¶é—´è¿ç»­ä¿¡æ¯ã€‚<strong>b)</strong>ä¸ç›®æ ‡æ£€æµ‹ä¸åŒçš„æ˜¯ï¼Œè¾¹ç•Œå¯¹è±¡é€šå¸¸æ˜¯éå¸¸æ¸…æ™°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ä¸ºå¯¹è±¡æ ‡è®°ä¸€ä¸ªæ›´æ¸…æ™°çš„è¾¹ç•Œæ¡†ã€‚ç„¶è€Œï¼Œå¯èƒ½æ²¡æœ‰å…³äºåŠ¨ä½œçš„ç¡®åˆ‡æ—¶é—´èŒƒå›´åˆç†å®šä¹‰ï¼Œæ‰€ä»¥ï¼Œä¸å¯èƒ½ç»™ä¸€ä¸ªåŠ¨ä½œå¼€å§‹å’Œç»“æŸçš„å‡†ç¡®è¾¹ç•Œã€‚<strong>c)</strong>å¤§çš„æ—¶é—´è·¨åº¦ï¼Œæ—¶é—´åŠ¨ä½œç‰‡æ®µçš„è·¨åº¦å¯ä»¥æ˜¯éå¸¸å¤§çš„ï¼Œæ¯”å¦‚ï¼ŒæŒ¥æ‰‹å¯èƒ½åªå‡ ç§’é’Ÿä½†æ˜¯æ”€å²©å’Œéª‘è‡ªè¡Œè½¦èƒ½å¤ŸæŒç»­åå‡ ç§’ã€‚å®ƒä»¬æ—¶é—´è·¨åº¦åœ¨é•¿åº¦ä¸Šçš„ä¸åŒï¼Œæ˜¯çš„æå–æ£€æµ‹(extract proposals)å¾ˆå›°éš¾ã€‚å¦å¤–ï¼Œåœ¨å¼€æ”¾çš„ç¯å¢ƒå½“ä¸­ï¼Œè¿™é‡Œä¹Ÿåˆè®¸å¤šé—®é¢˜ï¼Œä¾‹å¦‚å¤šå°ºåº¦ï¼Œå¤šç›®æ ‡å’Œç›¸æœºç§»åŠ¨ã€‚</p>
<p>æ—¶é—´åŠ¨ä½œå®šä½éå¸¸è´´è¿‘æˆ‘ä»¬çš„ç”Ÿæ´»ï¼Œå®ƒå…·æœ‰å¹¿æ³›çš„åº”ç”¨å‰æ™¯å’Œç¤¾ä¼šä»·å€¼åœ¨è§†é¢‘æ¦‚å†µ(video summarization)ã€å…¬å…±è§†é¢‘ç›‘æ§ã€æŠ€èƒ½è¯„ä¼°å’Œæ—¥å¸¸ç”Ÿæ´»å®‰å…¨ã€‚æ‰€ä»¥å®ƒåœ¨æœ€æœ€è¿‘å‡ å¹´å¾—åˆ°äº†å¹¿æ³›çš„å…³æ³¨ã€‚ä¸â€œåŠ¨ä½œæ£€æµ‹â€æœ‰å…³çš„å‡ºç‰ˆç‰©æ€»æ•°çº¦ä¸º324127ä»½ï¼Œè¿‘äºŒåå¹´æ¥åŒ…æ‹¬ä¹¦ç±ã€æœŸåˆŠã€è®ºæ–‡ã€ä¼šè®®è®ºæ–‡ã€ä¸“åˆ©å’Œä¸€äº›ç§‘æŠ€æˆæœã€‚ä¸‹é¢æˆ‘ä»¬ä¸»è¦åˆ†æå‡ºç‰ˆå­¦æœ¯å’Œå›å¿†è®ºæ–‡çš„è¶‹åŠ¿åŠ¨ä½œæ£€æµ‹ï¼Œå¦‚åŒ<strong>å›¾1</strong>æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201027193624091.png" alt=""></p>
<p>æœ¬è°ƒæŸ¥æ—¨åœ¨å¸®åŠ©å¯¹æ—¶æ€åŠ¨ä½œæœ¬åœ°åŒ–æ„Ÿå…´è¶£çš„åˆå­¦è€…ã€‚å®ƒæä¾›ä¸€ä¸ªæ¦‚æ‹¬åŠ¨ä½œå®šä½çš„æ–¹æ³•å’Œæœ€æ–°è¿›å±•ï¼Œæœ¬æ–‡ä½™ä¸‹éƒ¨åˆ†ç»„ç»‡å¦‚ä¸‹ã€‚</p>
<ul>
<li>ç¬¬äºŒèŠ‚æ¦‚è¿°ç›¸å…³æŠ€æœ¯ã€‚</li>
<li>ç¬¬ä¸‰èŠ‚ä»‹ç»åŸºæœ¬çš„æ—¶é—´åŠ¨ä½œå®šä½æ•°æ®é›†</li>
<li>ç¬¬å››èŠ‚æè¿°æ¨¡å‹çš„æ€§èƒ½è¯„ä¼°æŒ‡æ ‡</li>
<li>ç¬¬äº”èŠ‚ä»å…¨ç›‘ç£å’Œå¼±ç›‘ç£ä¸¤æ–¹é¢ï¼Œæä¾›ä¸€ä¸ªæ—¶é—´åŠ¨ä½œå®šä½æ¨¡å‹å’Œæ–¹æ³•çš„æ¦‚è¿°</li>
<li>ç¬¬å…­èŠ‚è®¨è®ºç°åœ¨çš„æŒ‘æˆ˜å’Œå»ºè®®æœªæ¥çš„æ–¹å‘</li>
<li>ç¬¬ä¸ƒèŠ‚æ€»ç»“æœ¬è®ºæ–‡</li>
</ul>
<span id="more"></span>
<h2 id="2-ç›¸å…³æŠ€æœ¯"><a href="#2-ç›¸å…³æŠ€æœ¯" class="headerlink" title="2.ç›¸å…³æŠ€æœ¯"></a>2.ç›¸å…³æŠ€æœ¯</h2><p>å› ä¸ºæœ€è¿‘æ—¶é—´æœ¬åœ°åŒ–å·²ç»æˆä¸ºäº†ä¸€ä¸ªæ´»è·ƒçš„ç ”ç©¶é¢†åŸŸï¼Œè®¸å¤šè§£å†³æ­¤é—®é¢˜çš„ä¸åŒçš„æ–¹æ³•è¢«æå‡ºã€‚è™½ç„¶åŠ¨ä½œæ£€æµ‹å·²ç»ç ”ç©¶äº†è®¸å¤šå¹´ï¼Œä½†æ˜¯å®ƒä»å¤„äºå®éªŒå®¤æ•°æ®é›†çš„æµ‹è¯•é˜¶æ®µï¼Œæ²¡æœ‰å®é™…çš„å®ç”¨æ€§å’Œå·¥ä¸šåŒ–ã€‚ç†è§£è§†é¢‘ä¸­åŠ¨ä½œå‘ç”Ÿçš„æ—¶é—´å’Œå†…å®¹æ˜¯éå¸¸å…·æœ‰æŒ‘æˆ˜æ€§çš„ã€‚å¯ä»¥çœ‹å‡ºï¼Œç›®å‰å¯¹äºè¿™ä¸ªä»»åŠ¡ä»ç„¶æ²¡æœ‰å¥å£®çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å›é¡¾æ—¶é—´åŠ¨ä½œå®šä½çš„ç›¸å…³æŠ€æœ¯ã€‚</p>
<p>ä¼—æ‰€å‘¨çŸ¥ï¼Œè§†é¢‘ç‰¹å¾è¡¨ç¤ºå¯ä»¥ä¸ºè§†é¢‘åŠ¨ä½œæä¾›æœ‰ç”¨çš„ä¿¡æ¯ï¼Œå¹¶ä¸”å¾ˆå¤šå®éªŒå·²ç»è¢«åšäº†ã€‚åœ¨è¿‡å»çš„äºŒåå¹´ï¼Œä¼—æ‰€å‘¨çŸ¥ç‰¹å¾æå–çš„è¿›å±•ä¸€èˆ¬ç»å†äº†ä¸¤ä¸ªé‡è¦çš„å†å²æ—¶æœŸã€‚ä¸€ä¸ªæ˜¯ä¼ ç»Ÿçš„åŠ¨ä½œæ£€æµ‹é˜¶æ®µåœ¨2014å¹´ä¹‹å‰ï¼Œå¦ä¸€ä¸ªæ—¶æœŸæ—¶æ·±åº¦å­¦ä¹ é˜¶æ®µï¼Œåœ¨2014å¹´ä¹‹åã€‚æ—¶é—´çº¿æ¡†æ¶å¦‚<strong>å›¾2</strong>æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201027201856154.png" alt="image-20201027201856154"></p>
<p>åœ¨æ·±åº¦å­¦ä¹ é˜¶æ®µï¼Œå®ƒä»¬ä¸»è¦è¢«åˆ†ä¸ºä¸¤ç§ç±»å‹æ¡†æ¶ï¼šâ€œä¸¤é˜¶æ®µæ£€æµ‹(â€˜two-stage detection)â€å’Œâ€œä¸€é˜¶æ®µæ£€æµ‹ï¼ˆone-stage detectionï¼‰â€ã€‚ç‰¹åˆ«ï¼Œå‰é¢ä¸€ç§ä¾èµ–â€œæ£€æµ‹å’Œåˆ†ç±»â€(proposal-then-classification)èŒƒå¼ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸»æµæ–¹æ³•ï¼Œåä¸€ç§åŒæ—¶æ£€æµ‹å’Œåˆ†ç±»,æ‰€ä»¥æˆ‘ä»¬ç§°ä¹‹ä¸ºä¸€çº§æ£€æµ‹</p>
<h3 id="A-ä¼ ç»Ÿçš„æ–¹æ³•-TRADITIONAL-METHODS"><a href="#A-ä¼ ç»Ÿçš„æ–¹æ³•-TRADITIONAL-METHODS" class="headerlink" title="A.ä¼ ç»Ÿçš„æ–¹æ³•(TRADITIONAL METHODS)"></a>A.ä¼ ç»Ÿçš„æ–¹æ³•(TRADITIONAL METHODS)</h3><p>ç”±äºåŠ¨ä½œè¯†åˆ«æ˜¯æ—¶é—´åŠ¨ä½œå®šä½çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥å¤§å¤šæ•°æ—©æœŸåŠ¨ä½œå®šä½ç®—æ³•éƒ½ä¾èµ–äºæ‰‹åŠ¨åˆ¶ä½œçš„ç‰¹ç‚¹ï¼Œè¿™ä¸€ç‚¹å’ŒåŠ¨ä½œè¯†åˆ«ç›¸åŒã€‚è¿™é‡Œæœ‰å‡ ç§æ–¹å¼å»æå–è§†é¢‘ç‰¹å¾ï¼ŒåŒ…å«é™æ€å›¾åƒç‰¹å¾å’Œæ—¶é—´è§†è§‰ç‰¹å¾ã€‚å…·ä½“æ¥è¯´ï¼Œé™æ€å›¾åƒç‰¹å¾æ˜¯SIFT (ScaleInvariant Feature Transformï¼Œç‰¹æ€§å˜æ¢)å’Œ HOG (Histogram of Oriented Gradientsï¼Œå€¾æ–œçš„ç›´æ–¹å›¾)ç­‰å¾…ã€‚HOGå¯ä»¥è®¤ä¸ºæ˜¯SIFTçš„ä¸€ç§æ”¹è¿›ï¼Œç„¶è€Œæ—¶é—´è§†è§‰ç‰¹å¾æ˜¯é™æ€å›¾åƒä¿¡æ¯å’Œæ—¶é—´ä¿¡æ¯çš„ç»“åˆã€‚é€šè¿‡è¿™äº›ç‰¹å¾ï¼Œå¯ä»¥å¾—åˆ°è§†é¢‘çš„æ—¶é—´ä¿¡æ¯ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†ç‰¹å¾æå–åˆ†ä¸ºå±€éƒ¨ç‰¹å¾æå–å’Œå…¨å±€ç‰¹å¾æå–ã€‚<strong>a)</strong>å±€éƒ¨ç‰¹å¾æå–æ˜¯æŒ‡è§†é¢‘ä¸­çš„å±€éƒ¨æ„Ÿå…´è¶£ç‚¹å’Œæ„Ÿå…´è¶£åŒºåŸŸï¼ŒåŒ…æ‹¬ç»Ÿè®¡æ•°æ®ï¼Œå­—æ®µå­¦ä¹ (dictionary learning),bagof-words (BoW),ç‰¹å¾å­¦ä¹ ç­‰ç­‰ã€‚å’Œå…¨å±€ç‰¹å¾æå–æƒ³æ¯”è¾ƒï¼Œå±€éƒ¨ç‰¹å¾æå–å¯¹äºè§†é¢‘ç…§æ˜ã€æŠ•æ˜¯ã€ç›¸æœºæŠ–åŠ¨å’Œå¤æ‚èƒŒæ™¯æ›´å…·æœ‰å¥å£®æ€§ã€‚<strong>b)</strong>å…¨å±€ç‰¹å¾æå–æŒ‡çš„æ˜¯äººç±»è¡Œä¸ºçš„æ•´ä½“ç‰¹å¾ï¼Œå¦‚äººä½“çš„è½®å»“ã€éª¨æ¶ç­‰ï¼Œå®ƒåŒ…æ‹¬å…¨å±€å¯†åº¦å’Œè½¨è¿¹æ–¹æ³•ã€‚ä¸ºäº†è§£å†³åœ¨å¤ç‚¸åœºæ™¯ä¸­äººç±»è¡Œä¸ºçš„é—®é¢˜ï¼Œä»…ä»…æ£€æµ‹æ—¶ç©ºåŒºåŸŸç°åº¦å˜åŒ–æ˜¯ä¸å¤Ÿçš„ã€‚å› æ­¤ï¼Œç ”ç©¶äººå‘˜å·²ç»æå‡ºäº†è®¸å¤šä¾èµ–äºç‚¹è½¨è¿¹çš„ç‰¹å¾æå–çš„æ–¹æ³•ã€‚è¿‘ä¼¼çš„è¿‡ç¨‹å¦‚ä¸‹ï¼šç¬¬ä¸€ï¼Œè¿™äº›æ–¹æ³•å…ˆåœ¨è§†é¢‘çš„æ—¶é—´åŒºåŸŸæ£€æµ‹ç‰¹å¾ç‚¹ï¼Œç„¶åä¸€å¸§ä¸€å¸§è·Ÿè¸ªè¿™äº›ç‰¹å¾ç‚¹ï¼Œå¹¶å°†å½¢æˆçš„ç‰¹å¾ç‚¹çš„è½¨è¿¹è¿æ¥èµ·æ¥ï¼Œæœ€åå®ƒä»¬ä½¿ç”¨ç‰¹å¾æè¿°å™¨(feature descriptors)æ¥æè¿°è¿™ä¸ªè½¨è¿¹å’Œå®ƒçš„æ—¶é—´åŸŸã€‚è®¸å¤šç‰¹å¾æå–çš„æ–¹æ³•ä¾èµ–ç‰¹å¾ç‚¹çš„è½¨è¿¹ä¼ ç»Ÿæ–¹æ³•æ˜¯Dense Trajectories (DT)ï¼Œéšåï¼Œè€ƒè™‘åˆ°æ‘„åƒæœºçš„è¿åŠ¨å¯¼è‡´DTæå–çš„ç‰¹å¾å’Œäººç±»è¡Œä¸ºä¸ç›¸å…³å…³è”ï¼ŒDTç‰¹å¾æå–è¢«æ›´æ·±çš„æ”¹è¿›äº†ï¼Œä¸€ç§å«iDTçš„æ–¹æ³•è¢«æå‡ºã€‚iDTçš„éå¸¸æœ‰ä»·å€¼çš„è§è§£(valuable insight)ä»ç„¶å½±å“ç€ä»¥åçš„ç ”ç©¶å·¥ä½œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯æ·±åº¦å­¦ä¹ å’ŒiDTçš„ç»“åˆé€šå¸¸å¯ä»¥æ›´è¿›ä¸€æ­¥çš„æé«˜æ€§èƒ½ã€‚è®¸å¤šè®ºæ–‡å·²ç»é‡‡çº³ä»¥â€æˆ‘ä»¬çš„æ–¹æ³•+iDTâ€çš„å½¢å¼å»å®ç°æœ€é«˜æ°´å¹³SOTA(state-of-the-Art)</p>
<p>  æ— è®ºå¦‚ä½•ï¼Œä¼ ç»Ÿç‰¹å¾æå–æ–¹æ³•çš„ç ”ç©¶è¿‡ç¨‹å’Œæ€æƒ³éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºè¿™äº›æ–¹æ³•å…·æœ‰å¾ˆå¼ºçš„å¯è§£é‡Šæ€§ã€‚å®ƒä»¬ä¸ºè®¾è®¡æ·±åº¦å­¦ä¹ æ–¹æ³•æ¥è§£å†³æ­¤ç±»é—®é¢˜æä¾›äº†å¯å‘å’Œç±»æ¯”ã€‚</p>
<h3 id="B-æ·±åº¦å­¦ä¹ çš„æ–¹æ³•-DEEP-LEARNING-METHODS"><a href="#B-æ·±åº¦å­¦ä¹ çš„æ–¹æ³•-DEEP-LEARNING-METHODS" class="headerlink" title="B.æ·±åº¦å­¦ä¹ çš„æ–¹æ³•(DEEP LEARNING METHODS)"></a>B.æ·±åº¦å­¦ä¹ çš„æ–¹æ³•(DEEP LEARNING METHODS)</h3><p>éšç€ä½¿ç”¨æ‰‹å·¥ç‰¹å¾æå–çš„æ–¹æ³•çš„è¡¨ç°å˜å¾—ç¨³å®šï¼Œæ—¶é—´åŠ¨ä½œå®šä½ä»¥åŠè¾¾åˆ°äº†ä¸€å®šé«˜åº¦ã€‚éšç€å·ç§¯ç¥ç»ç½‘ç»œçš„é‡ç”Ÿï¼Œå¤§é‡çš„ç ”ç©¶ä¹Ÿéšä¹‹å…´èµ·ã€‚å·ç§¯ç¥ç»ç½‘ç»œå¯ä»¥å­¦ä¹ è§çŠ¶çš„å’Œé«˜æ°´å‡†çš„ç‰¹å¾è¡¨ç¤ºã€‚æ¯”å¦‚ï¼Œä¸€ä¸ª2D-CNNå¯¹äºä¸€ä¸ªå¤§è§„æ¨¡çš„è§†é¢‘åˆ†ç±»æ˜¯æè²è²çš„å°ç»„åœ¨å¹´æå‡ºæ¥çš„ã€‚è™½ç„¶å®ƒçš„è¡¨ç°å’Œä¾èµ–ä¼ ç»Ÿæ–¹æ³•çš„ç‰¹å¾æå–ä¸èƒ½ç›¸æ¯”ï¼Œä½†æ˜¯è¿™ä¸ªæƒ³æ³•å¯å‘äº†åæ¥çš„ç ”ç©¶äººå‘˜ã€‚åæ¥ï¼Œä¸¤ç§æµæ´¾CNN((RGB frames and optical flow),  3Då·ç§¯ç¥ç»ç½‘ç»œå’Œç´§æ¥ç€å®ƒä»¬çš„å˜åŒ–æˆä¸ºäº†å­¦ä¹ åŠ¨ä½œè¯†åˆ«ä¸­çš„åŒºåˆ«æ€§ç‰¹å¾å—æ¬¢è¿æ–¹æ³•ã€‚éšåï¼Œä¸€ä¸ªç»“åˆä¸¤ç§æµæ´¾å’ŒC3Dç½‘ç»œè¢«å‘½åä¸ºI3D(Inception 3D)è¢«æå‡ºã€‚è€Œä¸”å®ƒä»¥åŠæˆä¸ºäº†ä¸€ç§é€šç”¨çš„è§†é¢‘ç‰¹å¾è¡¨ç¤ºç¼–ç å™¨(video feature representation encoder)ã€‚é™¤äº†å‡ ç§ä¾èµ–ç¥ç»ç½‘ç»œçš„æ–¹æ³•è¢«ä»‹ç»ç”¨æ¥æ•æ‰åŠ¨æ€çš„åŠ¨ä½œè¯†åˆ«ï¼ŒTSNé€šè¿‡ç¨€ç–é‡‡æ ·çš„ç­–ç•¥ï¼Œä¹Ÿè¢«è®¾è®¡æ¥å¯¹æ•´ä¸ªè§†é¢‘ä¿¡æ¯è¿›è¡Œå¹³å‡èšé›†å»ºæ¨¡ã€‚æ ¹æ®<strong>å›¾1</strong>ï¼Œæˆ‘ä»¬å€¼å¾—ï¼Œæ·±åº¦å­¦ä¹ åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼šä¸¤é˜¶æ®µå®šä½å’Œä¸€é˜¶æ®µå®šä½ã€‚</p>
<h4 id="1ï¼‰ä¸¤é˜¶æ®µå®šä½æ–¹æ³•"><a href="#1ï¼‰ä¸¤é˜¶æ®µå®šä½æ–¹æ³•" class="headerlink" title="1ï¼‰ä¸¤é˜¶æ®µå®šä½æ–¹æ³•"></a>1ï¼‰ä¸¤é˜¶æ®µå®šä½æ–¹æ³•</h4><p>ä¸¤é˜¶æ®µç±»å‹ä¾èµ–å®šä½-ç„¶å-åˆ†ç±»( proposal-thenclassification)çš„èŒƒå¼.è¿™ä¸ªèŒƒå¼å…ˆæå–æ—¶é—´å®šä½ï¼Œç„¶åæ¥ç€å¤„ç†åˆ†ç±»å’Œå›å½’æ“ä½œã€‚è¿™æ–¹å¼æ˜¯ä¸»æµæ–¹æ³•ï¼Œæ‰€ä»¥å¤§å¤šæ•°è®ºæ–‡éƒ½æ˜¯é‡‡ç”¨æ­¤æ–¹æ³•ã€‚äº‹å®ä¸Šï¼Œè¿™ä¸ªå®šä½çš„ç”Ÿæˆæ˜¯æ—¶é—´å®šä½èŒƒå¼ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ï¼Œè¿™ä¸ªå’Œç›®æ ‡æ£€æµ‹ä¸­å®šä½çš„ç”Ÿæˆç›¸ç±»ä¼¼(RNNä¸­åŒºåŸŸå®šä½ç”Ÿæˆ)ã€‚ä¸€ä¸ªå¥½çš„å®šä½ç®—æ³•å¯ä»¥æ›´å¥½çš„æé«˜è¿™ä¸ªæ¨¡å‹çš„æ•ˆæœ</p>
<p>æ—¶é—´åŠ¨ä½œå®šä½ç”Ÿæˆå™¨çš„ä»»åŠ¡æ˜¯ç”Ÿæˆä¸€å®šæ•°é‡çš„æ—¶é—´å®šä½å¯¹äºä¸€ä¸ªæœªè£å‰ªçš„é•¿è§†é¢‘ã€‚ä¸€ä¸ªæ—¶é—´åŠ¨ä½œå®šä½æ˜¯ä¸€ä¸ªæ—¶é—´é—´éš”åŒ…å«åŠ¨ä½œç‰‡æ®µ(ä»èµ·ç‚¹è¾¹ç•Œåˆ°ç»ˆç‚¹è¾¹ç•Œ)ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œå¹³å‡å¬å›ç‡ç”¨æ¥è¡¡é‡ç®—æ³•çš„æ€§èƒ½ã€‚æ•°æ®åº“ä¸€èˆ¬ä½¿ç”¨ActivityNetå’ŒTHUMOS14ï¼Œæœ‰å‡ ç§æ–¹æ³•æå–å®šä½çš„æ–¹æ³•ã€‚</p>
<h5 id="a-æ»‘åŠ¨çª—å£-SLIDING-WINDOW-S-CNN-14-2016"><a href="#a-æ»‘åŠ¨çª—å£-SLIDING-WINDOW-S-CNN-14-2016" class="headerlink" title="a:æ»‘åŠ¨çª—å£(SLIDING WINDOW,S-CNN [14], 2016)"></a>a:æ»‘åŠ¨çª—å£(SLIDING WINDOW,S-CNN [14], 2016)</h5><p>åœ¨2016å¹´ï¼ŒS-CNNç¬¬ä¸€ä¸ªæ–¹æ³•æ˜¯å›ºå®šä¸€äº›å¤§å°æ»‘åŠ¨çª—å£å»ç”Ÿæˆå„ç§å¤§å°ä¸åŒçš„è§†é¢‘ç‰‡æ®µï¼Œç„¶åé€šè¿‡å¤šçº§ç½‘ç»œ(SegmentCNN)å¤„ç†è¿™äº›ç‰‡æ®µã€‚SCNNåŒ…æ‹¬3ä¸ªå­ç½‘ç»œéƒ½ä½¿ç”¨C3Dç½‘ç»œã€‚ç¬¬ä¸€ä¸ªæ˜¯å®šä½(proposal)ç½‘ç»œï¼Œå®ƒç”¨æ¥ç¡®å®šå½“å‰è·¯æ®µæ˜¯ä¸€ä¸ªåŠ¨ä½œçš„æ¦‚ç‡ï¼Œç¬¬äºŒä¸ªæ˜¯åˆ†ç±»ç½‘ç»œï¼Œç”¨æ¥ç»™è§†é¢‘ç‰‡æ®µåˆ†ç±»ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å®šä½(localization)ç½‘ç»œ,å®ƒçš„è¾“å‡ºä»»ç„¶æ˜¯ä¸€ä¸ªç±»åˆ«çš„æ¦‚ç‡ã€‚å¹¶åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­åŠ å…¥é‡å ç›¸å…³çš„æŸå¤±å‡½æ•°ï¼Œä½¿å¾—ç½‘ç»œèƒ½å¤Ÿæ›´å¥½åœ°ä¼°è®¡è§†é¢‘ç‰‡æ®µçš„ç±»åˆ«å–é‡å ã€‚åŸåˆ™ä¸Šï¼Œå½“é‡å åº¦è¶Šé«˜ï¼Œæ•ˆæœè¶Šå¥½ã€‚æœ€ånon-maximized suppression (NMS)è¢«ç”¨äºé‡å¤çš„ç‰‡æ®µå’Œå®Œæˆé¢„æµ‹ã€‚</p>
<p>ç†è®ºä¸Šï¼Œåªæœ‰é‡å è¶³å¤Ÿé«˜ï¼Œè¿™ç§æ–¹æ³•æ˜¯æœ€å…¨é¢çš„ï¼Œä½†å®ƒæœ‰æ›´å¤šçš„å†—ä½™ã€‚</p>
<h5 id="b-æ—¶é—´æ´»åŠ¨åˆ†ç»„-TEMPORAL-ACTIONNESS-GROUPING-TAG-15-2017"><a href="#b-æ—¶é—´æ´»åŠ¨åˆ†ç»„-TEMPORAL-ACTIONNESS-GROUPING-TAG-15-2017" class="headerlink" title="b:æ—¶é—´æ´»åŠ¨åˆ†ç»„(TEMPORAL ACTIONNESS GROUPING,TAG [15], 2017)"></a>b:æ—¶é—´æ´»åŠ¨åˆ†ç»„(TEMPORAL ACTIONNESS GROUPING,TAG [15], 2017)</h5><p>ä»¥å‰çš„å·¥ä½œä½¿ç”¨æ»‘åŠ¨çª—å£å»æå–å»ºè®®çš„åŒºåŸŸï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•ä¸èƒ½å¤„ç†ä¸åŒè§†é¢‘åŠ¨ä½œé•¿åº¦ã€‚å› ä¸ºä¸€èˆ¬çš„æ˜¯åŠ¨ä½œè¯†åˆ«ï¼Œå·ç§¯é€‚ç”¨äºå¯†é›†è§†é¢‘å¸§ï¼Œè€Œä¸”å¯¹äºé•¿åŠ¨ä½œè§†é¢‘æ»‘åŠ¨çª—å£æ¶ˆè€—çš„èµ„æºå¤ªå¤šã€‚</p>
<p>Y. Xiong et alåœ¨2017å¹´æå‡ºäº†ä¸€ä¸ªæ–°çš„æ¡†æ¶ç”¨æ¥å‡†ç¡®çš„ç¡®å®šä¸åŒé•¿åº¦çš„åŠ¨ä½œè§†é¢‘çš„è¾¹ç•Œã€‚è¿™ä¸ªæ¡†æ¶åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šç”Ÿæˆæ—¶é—´åŒºåŸŸ(generating temporal proposals)å’Œåˆ†ç±»å¾…é€‰(classifying proposed candidates)ã€‚å‰ä¸€éƒ¨åˆ†ç”Ÿæˆä¸€ç³»åˆ—çš„å»ºè®®åŒºåŸŸï¼Œè€Œåè€…ç¡®å®šå®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªåŠ¨ä½œå¹¶ä¸”é¢„æµ‹å®ƒçš„ç±»åˆ«ã€‚æœªæ¥ç”Ÿæˆæ—¶é—´å»ºè®®åŒºåŸŸï¼ŒTAGç½‘ç»œè¢«æå‡ºã€‚ä»–ä»¬æœ‰ä¸‰ä¸ªä¸»è¦æ­¥éª¤ï¼ša)æå–ç‰‡æ®µ(Extract snippets):æ¯ä¸ªç‰‡æ®µåŒ…å«ä¸€ä¸ªè§†é¢‘çš„å¸§å’Œè§†è§‰ç•™ä¿¡æ¯ï¼Œè€Œä¸”ç‰‡æ®µæ˜¯åœ¨ä¸€ä¸ªè§„å¾‹çš„é—´éš”å†…è·å¾—çš„ã€‚b)åŠ¨ä½œï¼šåˆ¤æ–­ä¸€ä¸ªç‰‡æ®µæ˜¯å¦åŒ…å«åŠ¨ä½œï¼Œä¸ºäº†åšè¿™ä»¶äº‹ï¼Œå®ƒä½¿ç”¨TSN(Temporal Segment Network)å­¦ä¹ äºŒåˆ†ç±»ç½‘ç»œã€‚c)åˆ†ç»„ï¼šå¯¹äºè¾“å‡ºçš„ç‰‡æ®µåºåˆ—å’Œä»–ä»¬çš„æ¦‚ç‡ï¼Œå®ƒå°†é‚£äº›å¾—åˆ†è¾ƒé«˜çš„è¿ç»­ç‰‡æ®µè¿›è¡Œåˆ†ç»„ã€‚ä¸æ­¤åŒæ—¶ï¼Œè®¾ç½®ä¸€äº›é˜ˆå€¼å»åˆ é™¤åˆ†æ•°è¾ƒä½çš„ç‰‡æ®µï¼Œä»¥é˜²æ­¢å™ªå£°å¹²æ‰°ï¼Œå¹¶ä¸”é€šå¸¸è®¾ç½®å¤šç»„é˜ˆå€¼ï¼Œä»¥é˜²æ­¢ç¼ºå¤±å»ºè®®åŒºåŸŸã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•å¯¹äºè¾¹ç•Œæ›´åŠ çµæ´»ï¼Œä½†æ˜¯å®ƒå¯èƒ½å› ä¸ºåˆ†ç±»é”™è¯¯è€Œé”™è¿‡ä¸€äº›å»ºè®®åŒºåŸŸ</p>
<h5 id="c-æ—¶é—´å•ä½å›å½’ç½‘ç»œ-TEMPORAL-UNIT-REGRESS-NETWORK-TURN-TAP-16-2017"><a href="#c-æ—¶é—´å•ä½å›å½’ç½‘ç»œ-TEMPORAL-UNIT-REGRESS-NETWORK-TURN-TAP-16-2017" class="headerlink" title="c:æ—¶é—´å•ä½å›å½’ç½‘ç»œ(TEMPORAL UNIT REGRESS NETWORK,TURN TAP [16], 2017)"></a>c:æ—¶é—´å•ä½å›å½’ç½‘ç»œ(TEMPORAL UNIT REGRESS NETWORK,TURN TAP [16], 2017)</h5><p>åœ¨SCNNç½‘ç»œä¸­ï¼Œå®ƒä½¿ç”¨æ»‘åŠ¨çª—å£å»å¯»æ‰¾å»ºè®®åŒºåŸŸã€‚å¦‚æœä½ æƒ³å¾—åˆ°å‡†ç¡®çš„ç»“æœï¼Œä½ éœ€è¦å¢åŠ çª—å£ä¹‹é—´çš„é¢é‡å ï¼Œè¿™å›å¯¼è‡´è®¡ç®—é‡å¤§çš„é—®é¢˜ã€‚</p>
<p>ä¸ºäº†å‡å°‘è®¡ç®—é‡å’Œå¢åŠ æ—¶é—´å®šä½å‡†ç¡®åº¦ï¼Œåœ¨2017ï¼Œ Gao J.Y. et alåœ¨faster-RCNNæ˜ å…¥è¾¹ç•Œå›å½’æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œæå‡ºäº†è½¬å‘å­¦ä¹ çš„æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•å°†è§†é¢‘åˆ†å‰²æˆå›ºå®šå¤§å°çš„å•å…ƒï¼Œåˆ—å…¥16å¸§çš„å•å…ƒï¼Œç„¶åå°†æ¯ä¸ªå•å…ƒæ”¾å…¥C3Dç§æå–æ°´å¹³ç‰¹å¾ã€‚ç›¸é‚»å•å…ƒå½¢æˆä¸€ä¸ªclipï¼Œè®©ä¹ˆä¸ªå•ä½å½¢æˆä¸€ä¸ªé”šå•ä½ï¼Œæ„æˆä¸€ä¸ªclipé‡‘å­—å¡”ã€‚ç„¶ååœ¨å•å…ƒå¤„è¿›è¡Œæ—¶é—´åæ ‡å›å½’ï¼Œè¿™ä¸ªç½‘ç»œåŒ…å«ä¸¤ä¸ªè¾“å‡ºï¼Œç¬¬ä¸€ä¸ªè¾“å‡ºæ˜¯ç¡®å®šclipæ˜¯å¦åŒ…å«åŠ¨ä½œçš„åˆ†æ•°ï¼›ç¬¬äºŒä¸ªè¾“å‡ºæ˜¯è°ƒæ•´è¾¹ç•Œçš„æ—¶é—´åæ ‡åç§»é‡ã€‚</p>
<p>è¿™ä¸ªæ–¹æ³•ä¸»è¦çš„è´¡çŒ®å¦‚ä¸‹ï¼š1ï¼‰ä¸€ç§åˆ©ç”¨åæ ‡å›å½’ç”Ÿæˆæ—¶é—´å»ºè®®åˆ†æ®µçš„æ–°æ–¹æ³•ã€‚2ï¼‰å¿«çš„é€Ÿåº¦(800fps)ã€‚3ï¼‰ä¸€ä¸ªæ–°çš„è¯„ä»·æŒ‡æ ‡AR-Fè¢«æå‡º</p>
<h5 id="d-è¾¹ç•Œæ•æ„Ÿç½‘ç»œ-BOUNDARY-SENSITIVE-NETWORK-BSN-21-2018"><a href="#d-è¾¹ç•Œæ•æ„Ÿç½‘ç»œ-BOUNDARY-SENSITIVE-NETWORK-BSN-21-2018" class="headerlink" title="d:è¾¹ç•Œæ•æ„Ÿç½‘ç»œ(BOUNDARY SENSITIVE NETWORK ,BSN [21], 2018)"></a>d:è¾¹ç•Œæ•æ„Ÿç½‘ç»œ(BOUNDARY SENSITIVE NETWORK ,BSN [21], 2018)</h5><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œé«˜è´¨é‡çš„æ—¶é—´åŠ¨ä½œå»ºè®®åŒºåŸŸåº”è¯¥æœ‰ä¸€ä¸‹å‡ ç‚¹ç‰¹å¾ï¼ša)çµæ´»çš„æ—¶é—´é•¿åº¦,b)ç²¾ç¡®çš„æ—¶é—´ç•Œé™,c)å¯é çš„ä¿¡å¿ƒå¾—åˆ†ã€‚ä½†æ˜¯ç°æœ‰çš„æ–¹æ³•ä¸èƒ½åŒæ—¶å…¼é¡¾è¿™äº›æ–¹é¢ï¼Œä¸ºäº†è§£å†³è¿™äº›å›°éš¾ï¼ŒT. Lin et al. [21]æå‡ºäº†BSNåœ¨2018å¹´ã€‚</p>
<p>ç®€ç•¥çš„è¯´ï¼ŒBSNæœå…ˆå®šä½æ—¶é—´åŠ¨ä½œç‰‡æ®µçš„è¾¹ç•Œ(å¼€å§‹èŠ‚ç‚¹å’Œç»“æŸèŠ‚ç‚¹)ã€‚è¾¹ç•ŒèŠ‚ç‚¹ç›´æ¥ç»„åˆæˆä¸€ä¸ªæ—¶é—´å»ºè®®åŒºåŸŸã€‚ç„¶åæ ¹æ®æ¯ä¸ªå»ºè®®åŒºåŸŸææ¡ˆçš„åŠ¨ä½œç½®ä¿¡åº¦è¯„åˆ†åºåˆ—æå–ä¸€ä¸ª32ç»´å»ºè®®åŒºåŸŸç‰¹å¾ã€‚æœ€åï¼Œæ ¹æ®æ‰€æå–çš„å»ºè®®åŒºåŸŸå±‚æ¬¡ç‰¹å¾ï¼Œå¯¹æ—¶é—´ææ¡ˆçš„ç½®ä¿¡åº¦è¿›è¡Œè¯„ä¼°ã€‚</p>
<p>è¿™æ–¹æ³•ä¸»è¦çš„è´¡çŒ®å¦‚ä¸‹ï¼ša)æ–°é¢–çš„æ¡†æ¶å¯ä»¥åœ¨åŒä¸€æ—¶é—´æ»¡è¶³ä¸Šè¯‰ä¸‰ç‚¹ã€‚b)BSNæ¨¡å—ç®€å•çµæ´»ï¼Œç¼ºç‚¹æ˜¯:a)å¯¹æ¯ä¸ªæ—¶é—´æ–¹æ¡ˆé€ä¸ªè¿›è¡Œç‰¹å¾æå–å’Œç½®ä¿¡åº¦è¯„ä¼°ï¼Œæ•ˆç‡ä¸å¤Ÿã€‚b)è¯­ä¹‰ä¿¡æ¯ä¸è¶³ã€‚ä¸ºäº†ä¿è¯åŠ¨ä½œå»ºè®®åŒºåŸŸç‰¹å¾æå–çš„æ•ˆç‡ï¼ŒBSNè®¾è®¡çš„32ç»´ç‰¹å¾ç›¸å¯¹ç®€å•ï¼Œä½†ä¹Ÿé™åˆ¶äº†ç½®ä¿¡åº¦è¯„ä»·æ¨¡å—è·å–æ›´å¤šçš„è¯­ä¹‰ä¿¡æ¯ã€‚c)è¯¥æ–¹æ³•å…·æœ‰å¤šé˜¶æ®µæ€§ã€‚å®ƒæ²¡æœ‰è”åˆä¼˜åŒ–ç½‘ç»œçš„å‡ ä¸ªéƒ¨åˆ†ã€‚</p>
<h5 id="e-è¾¹ç•ŒåŒ¹é…ç½‘ç»œ-BOUNDARY-MATCHING-NETWORK-BMN-72-2019"><a href="#e-è¾¹ç•ŒåŒ¹é…ç½‘ç»œ-BOUNDARY-MATCHING-NETWORK-BMN-72-2019" class="headerlink" title="e:è¾¹ç•ŒåŒ¹é…ç½‘ç»œ(BOUNDARY-MATCHING NETWORK,BMN [72], 2019)"></a>e:è¾¹ç•ŒåŒ¹é…ç½‘ç»œ(BOUNDARY-MATCHING NETWORK,BMN [72], 2019)</h5><p>ä¸ºäº†è§£å†³BSNçš„ç¼ºç‚¹ï¼Œæ–°çš„æ—¶é—´å»ºè®®åŒºåŸŸç½®ä¿¡åº¦è¯„ä»·æœºåˆ¶å–è¾¹ç•ŒåŒ¹é…æœºåˆ¶ä¹Ÿç”±T. Linåœ¨2019å¹´æå‡ºã€‚BMNèƒ½å¤Ÿç”Ÿæˆä¸€ç»´è¾¹ç•Œæ¦‚ç‡å–äºŒç»´BMç½®ä¿¡åº¦å›¾ã€‚ç„¶åå¯¹æ‰€æœ‰å¯èƒ½çš„æ—¶é—´å»ºè®®åŒºåŸŸè¿›è¡Œå¯†é›†è¯„ä¼°ã€‚</p>
<p>ä»¥ä¸Šæ—¶é—´åŠ¨ä½œå»ºè®®åŒºåŸŸæ–¹æ³•çš„æ€§èƒ½æ¯”è¾ƒå¦‚è¡¨1æ‰€ç¤ºã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201114104053741.png" alt=""></p>
<h4 id="ä¸€é˜¶æ®µå®šä½æ–¹æ³•"><a href="#ä¸€é˜¶æ®µå®šä½æ–¹æ³•" class="headerlink" title="ä¸€é˜¶æ®µå®šä½æ–¹æ³•"></a>ä¸€é˜¶æ®µå®šä½æ–¹æ³•</h4><p>å¦ä¸€ç§æ˜¯åŒæ—¶å¤„ç†å»ºè®®åŒºåŸŸå’Œåˆ†ç±»çš„ä¸€é˜¶æ®µæ¡†æ¶ã€‚æ¯”å¦‚ï¼Œåœ¨2017å¹´T. Lin æå‡ºSSADå’Œæè²è²æå‡ºäº†SSâ€”TADï¼ˆç«¯åˆ°ç«¯ï¼Œå•æµæ—¶é—´åŠ¨ä½œæ£€æµ‹ï¼‰ã€‚ä»–ä»¬éƒ½æ˜¯åŸºäºå•ä¸ªæ£€æµ‹å™¨ã€‚ç”±äºæ—¶é—´åŠ¨ä½œå®šä½å’Œç›®æ ‡æ£€æµ‹ç›¸ä¼¼æ€§ï¼ŒSSADç»“åˆäº†YOLOå’ŒSSDä¸¤ç§ç›®æ ‡æ£€æµ‹æ¨¡å‹çš„ç‰¹ç‚¹ã€‚SSADçš„ä¸€èˆ¬æµç¨‹å¦‚ä¸‹ï¼Œä½¿ç”¨æå‰è®­ç»ƒçš„æ¨¡å‹ï¼Œå¾—åˆ°ç‰¹å¾åºåˆ—ï¼Œä½œä¸ºSSADæ¨¡å‹çš„è¾“å…¥ã€‚æ¨¡å‹å¤„ç†åè¾“å‡ºæ£€æµ‹ç»“æœã€‚è€ŒSS-TADå°†æ—¶é—´åŠ¨ä½œå®šä½çš„è¯­ä¹‰å­ä»»åŠ¡ä½œä¸ºè°ƒæ•´è¯­ä¹‰çº¦æŸï¼Œæé«˜äº†è®­ç»ƒå’Œæµ‹è¯•æ€§èƒ½ã€‚æ•ˆæœä¼˜äºSSADï¼ŒSS-TADæå–ç‰¹å¾ä½¿ç”¨C3Dï¼Œä¸SSADç›¸åŒã€‚è€ŒSS-TADé‡‡ç”¨é”šå®šæœºæ„å’Œå åŠ GRUå•å…ƒã€‚æœ€è¿‘ï¼ŒFuchen Longä»‹ç»äº†GTAN(Gaussian Temporal Awareness Networks,é«˜æ–¯æ—¶é—´æ„ŸçŸ¥ç½‘ç»œ),è¯¥ç½‘ç»œå°†æ—¶é—´ç»“æ„ä¸å•é˜¶æ®µåŠ¨ä½œå®šä½ç›¸ç»“åˆã€‚åœ¨GTANï¼Œè¯¥ç®—æ³•å¼•å…¥é«˜æ–¯æ ¸å‡½æ•°ï¼ŒåŠ¨æ€ä¼˜åŒ–æ¯ä¸ªåŠ¨ä½œå»ºè®®çš„æ—¶é—´å°ºåº¦ã€‚</p>
<p>æ­¤å¤–ï¼Œæœ‰äº›æ–¹æ³•åŸºäºé¡ºåºå†³ç­–è¿‡ç¨‹ï¼Œä¹Ÿå±äºå•é˜¶æ®µæ¡†æ¶ã€‚ä¾‹å¦‚ï¼Œæ–‡çŒ®10æ˜¯ç¬¬ä¸€ä¸ªæå‡ºåœ¨è§†é¢‘ä¸­å­¦ä¹ åŠ¨ä½œæ£€æµ‹çš„ç«¯åˆ°ç«¯çš„æ–¹æ³•ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­,å®ƒä½¿ç”¨å¼ºåŒ–å­¦ä¹ æ¥è®­ç»ƒä¸€ä¸ªåŸºäºrnnçš„ä»£ç†ã€‚ä»£ç†å¯ä»¥ä¸æ–­è§‚å¯Ÿè§†é¢‘å¸§ï¼Œå¹¶å†³å®šä¸‹ä¸€æ­¥çœ‹å“ªé‡Œï¼Œä½•æ—¶ç”ŸæˆåŠ¨ä½œé¢„æµ‹</p>
<h2 id="3-åŸºå‡†æ•°æ®é›†"><a href="#3-åŸºå‡†æ•°æ®é›†" class="headerlink" title="3.åŸºå‡†æ•°æ®é›†"></a>3.åŸºå‡†æ•°æ®é›†</h2><p>è™½ç„¶æ²¡æœ‰ä¸€ä¸ªæ—¶é—´åŠ¨ä½œå®šä½çš„æ ‡å‡†åŸºå‡†ï¼Œä½†å¤§å¤šæ•°ç ”ç©¶äººå‘˜ä½¿ç”¨THUMOS14[6]å’ŒActivityNet [7]ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªå¤§å‹æ•°æ®é›†ç”¨äºæ—¶é—´åŠ¨ä½œæ£€æµ‹ã€‚æ¯”å¦‚ï¼ŒMEXaction2ã€MutiTHUMOSã€Charadeså’ŒAVAç­‰ã€‚ä¸‹é¢è¿™æ®µä¸»è¦ä»‹ç»å‡ ç§å¸¸ç”¨çš„æ•°æ®é›†</p>
<h3 id="A-THUMOS14"><a href="#A-THUMOS14" class="headerlink" title="A.THUMOS14"></a>A.THUMOS14</h3><p>THUMOS14æ¥è‡ª2014å¹´çš„THUMOS Challengeã€‚è¿™ä¸ªæ•°æ®é›†åŒ…å«ä¸¤ä¸ªä»»åŠ¡ï¼šåŠ¨ä½œè¯†åˆ«å’Œæ—¶é—´åŠ¨ä½œæ£€æµ‹ã€‚å¤§å¤šæ•°è®ºæ–‡éƒ½åœ¨è¿™ä¸ªæ•°æ®é›†ä¸­è¿›è¡Œè¯„ä¼°ã€‚THUMOSæ•°æ®é›†åœ¨å…¶è®­ç»ƒã€éªŒè¯å’Œæµ‹è¯•é›†ä¸­æœ‰101ä¸ªåŠ¨ä½œç±»çš„è§†é¢‘çº§æ³¨é‡Šï¼Œè€Œåœ¨20ä¸ªç±»çš„éªŒè¯å’Œæµ‹è¯•é›†ä¸­åªæœ‰ä¸€å°éƒ¨åˆ†è§†é¢‘æœ‰æ—¶æ€æ³¨é‡Šã€‚</p>
<p>ä¸€äº›å…¨ç›‘ç£å­¦ä¹ æ–¹æ³•çš„ç»†èŠ‚å¦‚ä¸‹:a)è®­ç»ƒé›†:UCF101,101ç§åŠ¨ä½œç±»å‹ï¼Œå…±è®¡ä¿®å‰ªäº†13320ä¸ªè§†é¢‘å‰ªè¾‘ã€‚b)éªŒè¯é›†ï¼š1010ä¸ªæœªä¿®å‰ªçš„è§†é¢‘ï¼Œå…¶ä¸­200ä¸ªè´´æœ‰æ—¶é—´æ³¨é‡Šã€‚(3007ä¸ªåŠ¨ä½œç‰‡æ®µï¼Œåªæœ‰20ä¸ªç±»å¯ä»¥ç”¨äºæ—¶é—´åŠ¨ä½œæ£€æµ‹ä»»åŠ¡)ã€‚c)æµ‹è¯•é›†ï¼š1574ä¸ªæœªä¿®å‰ªçš„è§†é¢‘ï¼Œå…¶ä¸­213ä¸ªæœ‰æ—¶æ€åŠ¨ä½œæ³¨é‡Šã€‚ï¼ˆ3358ä¸ªè¡Œä¸ºç‰‡æ®µï¼Œåªæœ‰20ä¸ªç±»å¯ä»¥ç”¨äºæ—¶é—´åŠ¨ä½œæ£€æµ‹ä»»åŠ¡ï¼‰</p>
<p>æ€»ä¹‹ï¼Œè¿™ä¸ªæ•°æ®é›†å¾ˆæœ‰æŒ‘æˆ˜æ€§ï¼Œå› ä¸ºæœ‰äº›è§†é¢‘æ¯”è¾ƒé•¿(é•¿è¾¾26åˆ†é’Ÿ)ï¼Œå¹¶ä¸”åŒ…å«å¤šä¸ªåŠ¨ä½œå®ä¾‹ã€‚åŠ¨ä½œçš„é•¿åº¦åœ¨ä¸€ç§’åˆ°å‡ åˆ†é’Ÿä¹‹é—´å˜åŒ–å¾ˆå¤§ã€‚</p>
<h3 id="B-ActivityNet"><a href="#B-ActivityNet" class="headerlink" title="B.ActivityNet"></a>B.ActivityNet</h3><p>ActivityNetæ•°æ®é›†æ˜¯æœ€è¿‘å¼•å…¥åŠ¨ä½œè¯†åˆ«å’ŒåŠ¨ä½œå®šä½åŸºå‡†çš„æœ€å¤§çš„éè£å‰ªè§†é¢‘æ•°æ®é›†ã€‚è¯¥æ•°æ®é›†åªæä¾›YouTubeè§†é¢‘é“¾æ¥ï¼Œä¸èƒ½ç›´æ¥ä¸‹è½½è§†é¢‘ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä½¿ç”¨YouTubeä¸‹è½½å·¥å…·è‡ªåŠ¨ä¸‹è½½ã€‚ActivityNet1.3åŒ…å«10,024ä¸ªè®­ç»ƒè§†é¢‘ï¼Œ4,926ä¸ªéªŒè¯è§†é¢‘ï¼Œ5044ä¸ªæµ‹è¯•è§†é¢‘ï¼Œ200ä¸ªæ´»åŠ¨ç±»åˆ«ï¼Œå¦‚â€œé›ç‹—â€ã€â€œè·³è¿œâ€å’Œâ€œç»™åœ°æ¿å¸å°˜â€ã€‚ActivityNet1.3 å¹³å‡æ¯ä¸ªè§†é¢‘åªåŒ…å«1.5æ¬¡å‡ºç°ï¼Œå¤§å¤šæ•°è§†é¢‘åªåŒ…å«å•ä¸ªåŠ¨ä½œç±»åˆ«ï¼Œå¹³å‡36%çš„èƒŒæ™¯ã€‚</p>
<p>è¿™ä¸ªæ•°æ®é›†åŒ…å«åœ¨è¯­ä¹‰åˆ†ç±»ä¸‹æ¶‰åŠå„ç§äººç±»æ´»åŠ¨çš„å¤§é‡è‡ªç„¶è§†é¢‘ã€‚</p>
<h3 id="C-MEXaction2"><a href="#C-MEXaction2" class="headerlink" title="C.MEXaction2"></a>C.MEXaction2</h3><p>MEXaction2æ•°æ®é›†åŒ…å«ä¸¤ç§ç±»å‹çš„åŠ¨ä½œï¼Œå³éª‘é©¬å’Œæ–—ç‰›ã€‚è¿™ä¸ªæ•°æ®é›†ç”±ä¸‰éƒ¨åˆ†ç»„æˆ:YouTubeè§†é¢‘ï¼ŒUCF101ä¸­çš„éª‘é©¬è§†é¢‘å’ŒINAè§†é¢‘ã€‚å…¶ä¸­UCF101ä¸­çš„YouTubeè§†é¢‘ç‰‡æ®µå’Œéª‘é©¬è§†é¢‘æ˜¯è£å‰ªåçš„çŸ­è§†é¢‘ç‰‡æ®µï¼Œç”¨äºè®­ç»ƒé›†ï¼Œè€ŒINAè§†é¢‘æ˜¯æœªè£å‰ªçš„é•¿è§†é¢‘ï¼Œæ€»é•¿åº¦ä¸º77å°æ—¶ã€‚INAè§†é¢‘åˆ†ä¸ºåŸ¹è®­ã€éªŒè¯å’Œæµ‹è¯•é›†ã€‚è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ä¸­åˆ†åˆ«æœ‰1336ã€310å’Œ329ä¸ªåŠ¨ä½œç‰‡æ®µã€‚</p>
<p>æ€»ä¹‹ï¼ŒMEXaction2 datasetçš„ç‰¹ç‚¹æ˜¯æœªè£å‰ªçš„è§†é¢‘éå¸¸é•¿ï¼Œæ³¨é‡Šç‰‡æ®µåªå æ•´ä¸ªè§†é¢‘çš„å¾ˆå°ä¸€éƒ¨åˆ†ã€‚</p>
<h3 id="D-MUTITHUMOS"><a href="#D-MUTITHUMOS" class="headerlink" title="D.MUTITHUMOS"></a>D.MUTITHUMOS</h3><p>MUTITHUMOSæ˜¯ä¸€ä¸ªå¯†é›†çš„ï¼Œå¤šç±»ï¼Œå¸§æ˜æ™ºæ ‡ç­¾è§†é¢‘æ•°æ®é›†ï¼ŒåŒ…æ‹¬400ä¸ªè§†é¢‘30å°æ—¶ï¼Œ38,690ä¸ª65ä¸ªç±»çš„æ³¨é‡Šã€‚å¹³å‡æ¯å¸§æœ‰1.5ä¸ªæ ‡ç­¾ï¼Œæ¯æ®µè§†é¢‘æœ‰10.5ä¸ªåŠ¨ä½œç±»ã€‚è¿™æ˜¯THUMOSçš„å¢å¼ºç‰ˆã€‚ç›®å‰ï¼Œæˆ‘ä»¬åªåœ¨2017çš„è®ºæ–‡â€œâ€˜Learning Latent Super-Events to Detect Multiple Activities in Videosâ€ä¸­çœ‹åˆ°å¯¹è¯¥æ•°æ®é›†çš„è¯„ä»·</p>
<h3 id="E-CHARADES"><a href="#E-CHARADES" class="headerlink" title="E.CHARADES"></a>E.CHARADES</h3><p>Charadesæ˜¯æœªåˆ å‡çš„è§†é¢‘ï¼Œå…¶ä¸­åŒ…å«9,848ä¸ªå®¤å†…è§†é¢‘ï¼Œ(7985ä¸ªè®­ç»ƒæ•°æ®ï¼Œ1863å¹´æµ‹è¯•æ•°æ®)ï¼Œä»¥åŠæ¥è‡ª267ä¸ªä¸åŒäººçš„157ä¸ªè¯¾ç¨‹ã€‚æ¯ä¸ªè§†é¢‘å¤§çº¦30ç§’ã€‚æ¯ä¸ªè§†é¢‘éƒ½æœ‰å¤šä¸ªæ³¨é‡Šï¼Œæ¯ä¸ªåŠ¨ä½œçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ã€‚</p>
<h3 id="F-AVA"><a href="#F-AVA" class="headerlink" title="F.AVA"></a>F.AVA</h3><p>AVAæ˜¯ä¸€ä¸ªæ—¶ç©ºæœ¬åœ°åŒ–çš„åŸå­è§†è§‰åŠ¨ä½œæ•°æ®é›†ã€‚å®ƒåŒ…å«äº†430ä¸ª15åˆ†é’Ÿé•¿çš„ç”µå½±ç‰‡æ®µï¼Œå¹¶æ³¨é‡Šäº†80ä¸ªåŠ¨ä½œã€‚æœ‰38.6ä¸‡ä¸ªæ ‡è®°ç‰‡æ®µï¼Œ61.4ä¸‡ä¸ªæ ‡è®°åŒ…å›´æ¡†å’Œ8.1ä¸‡ä¸ªäººå‘˜è½¨è¿¹ã€‚æ€»å…±æœ‰158ä¸‡æ ‡è®°çš„è¡Œä¸ºï¼Œæ¯ä¸ªäººç»å¸¸æœ‰å¤šä¸ªæ ‡è®°ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ€»ç»“å’Œæ¯”è¾ƒè¿™äº›æ•°æ®é›†æ˜¾ç¤ºè¡¨2ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201114213744116.png" alt=""></p>
<h2 id="4-è¯„ä»·æŒ‡æ ‡"><a href="#4-è¯„ä»·æŒ‡æ ‡" class="headerlink" title="4.è¯„ä»·æŒ‡æ ‡"></a>4.è¯„ä»·æŒ‡æ ‡</h2><h3 id="A-åŸºæœ¬æ¦‚å¿µ"><a href="#A-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="A.åŸºæœ¬æ¦‚å¿µ"></a>A.åŸºæœ¬æ¦‚å¿µ</h3><p>åœ¨äºŒåˆ†ç±»é—®é¢˜å½“ä¸­ï¼ŒTPä»£è¡¨True Positiveï¼ŒFPä»£è¡¨False Positiveï¼ŒTNä»£è¡¨True Negativeï¼Œè€ŒFNä»£è¡¨False Negativeã€‚è¿™å››ä¸ªå‚æ•°è¢«ç”¨æ¥è®¡ç®—å¤šç§æ€§èƒ½è¯„ä»·æŒ‡æ ‡ã€‚ç»™å‡ºäº†å››ä¸ªå‚æ•°çš„é€»è¾‘ç»†èŠ‚åœ¨è¡¨3ä¸­ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201114214140041.png" alt=""></p>
<p>å…¶ä¸­ï¼Œåœ¨å®é™…çš„äºŒè¿›åˆ¶åˆ†ç±»ä¸­ï¼Œpositive-1æ ‡ç­¾æŒ‡çš„æ˜¯ä½ æ¯”è¾ƒå…³å¿ƒçš„æ ·æœ¬ï¼Œæ¯”å¦‚ä¸€ä¸ªåŠ¨ä½œæˆ–è€…ä¸€ä¸ªå¼‚å¸¸äº‹ä»¶ã€‚</p>
<h4 id="1-ACCURACY"><a href="#1-ACCURACY" class="headerlink" title="1)ACCURACY"></a>1)ACCURACY</h4><p>å‡†ç¡®åº¦æ˜¯æŒ‡æ­£ç¡®åˆ†ç±»æ ·æœ¬çš„æ¯”ä¾‹ã€‚å®ƒè¢«ç”¨æ¥è¯„ä»·åˆ†çº§æœºçš„æ€§èƒ½ã€‚</p>
<script type="math/tex; mode=display">
accuracy=\frac{rP+TN}{TP + TN + FP + FN}=\frac{TP+TN}{ALL}(1)</script><h4 id="2-RECALL"><a href="#2-RECALL" class="headerlink" title="2)RECALL"></a>2)RECALL</h4><p>å¬å›ç‡æ˜¯æ­£ç¡®é¢„æµ‹çš„èŒƒå›´ã€‚å‡†ç¡®çš„è¯´ï¼Œæ‰¾å›æ˜¯æµ‹è¯•é›†ä¸­ç¡®å®šäº†å¤šå°‘çœŸçš„positiveæ ·æœ¬ã€‚å®ƒçš„å…¬å¼å¦‚ä¸‹ã€‚</p>
<script type="math/tex; mode=display">
recall=\frac{TP}{TP+FN}ï¼ˆ2ï¼‰</script><h4 id="3-PRECISION"><a href="#3-PRECISION" class="headerlink" title="3)PRECISION"></a>3)PRECISION</h4><p>å‡†ç¡®çš„è¯´ï¼Œå‡†åº¦æ˜¯é¢„æµ‹çœŸå®positiveæ ·æœ¬å é¢„æµ‹ç»“æœçš„ç™¾åˆ†æ¯”ã€‚å®ƒçš„å…¬å¼å¦‚ä¸‹ã€‚</p>
<script type="math/tex; mode=display">
Precision=\frac{TP}{TP+FP}=\frac{TP}{n}(3)</script><p>å…¶ä¸­ï¼Œnä¸ºçœŸpositiveå’Œå‡positiveä¹‹å’Œï¼Œnä¸ºç³»ç»Ÿè¯†åˆ«çš„æ ·æœ¬æ€»æ•°ã€‚</p>
<h4 id="4-INTERSECTION-OVER-UNION-IoU"><a href="#4-INTERSECTION-OVER-UNION-IoU" class="headerlink" title="4)INTERSECTION-OVER-UNION (IoU)"></a>4)INTERSECTION-OVER-UNION (IoU)</h4><p>IoUå¯ä»¥ç†è§£ä¸ºæ¨¡å‹é¢„æµ‹çš„æ£€æµ‹æ¡†ä¸å›¾åƒä¸­ç›®æ ‡æ£€æµ‹çš„åœ°é¢çœŸå®å€¼çš„é‡å ã€‚å…¶å®å°±æ˜¯æ£€æµ‹çš„å‡†ç¡®æ€§ï¼Œè®¡ç®—å…¬å¼ä¸ºæ¢æµ‹ç»“æœä¸åœ°é¢çœŸå€¼çš„äº¤ç‚¹ï¼Œå¹¶ä¸ä¸¤è€…çš„è”åˆè¿›è¡Œæ¯”è¾ƒã€‚</p>
<script type="math/tex; mode=display">
IoU=\frac{predicted detection box\cap ground truth}{predicted detection box\cup ground truth}(4)</script><p>IoUç”¨äºæ£€æŸ¥é¢„æµ‹ç»“æœä¸åœ°é¢çœŸå®å€¼ä¹‹é—´çš„IoUæ˜¯å¦å¤§äºé¢„æµ‹é˜ˆå€¼ã€‚æˆ‘ä»¬é€šå¸¸æŠŠ0.5ä½œä¸ºé˜ˆå€¼ã€‚å¦‚æœIoUå¤§äº0.5ï¼Œåˆ™è¯¥å¯¹è±¡è¢«è¯†åˆ«ä¸ºâ€œæ£€æµ‹æˆåŠŸâ€ï¼Œå¦åˆ™è¢«è¯†åˆ«ä¸ºâ€œæ¼æŠ¥â€ã€‚åœ¨æ—¶é—´åŠ¨ä½œæ£€æµ‹ä¸­ï¼Œå°†IoUè½¬åŒ–ä¸ºæ—¶é—´çš„t-IoUï¼Œè¯¥t-IoUåªæœ‰ä¸€ç»´ã€‚</p>
<h3 id="B-è¯„ä»·æŒ‡æ ‡"><a href="#B-è¯„ä»·æŒ‡æ ‡" class="headerlink" title="B. è¯„ä»·æŒ‡æ ‡"></a>B. è¯„ä»·æŒ‡æ ‡</h3><h3 id="C-å¹³å‡å¬å›-AVERAGE-RECALL-AR"><a href="#C-å¹³å‡å¬å›-AVERAGE-RECALL-AR" class="headerlink" title="C.å¹³å‡å¬å›(AVERAGE RECALL,AR)"></a>C.å¹³å‡å¬å›(AVERAGE RECALL,AR)</h3><p>ARæ˜¯æ—¶é—´åŠ¨ä½œå»ºè®®åŒºåŸŸç”Ÿæˆçš„è¯„ä»·æŒ‡æ ‡ã€‚å› ä¸ºæ—¶é—´åŠ¨ä½œå»ºè®®åŒºåŸŸç”Ÿæˆä¸éœ€è¦åˆ†ç±»ï¼Œå®ƒä»…ä»…åªéœ€è¦å»å‘ç°å»ºè®®åŒºåŸŸã€‚å› æ­¤ï¼Œæˆ‘ä»¬å‘ç°çš„æ—¶é—´åŠ¨ä½œå»ºè®®åŒºåŸŸæ˜¯å¦å®Œæ•´ï¼Œå¯ä»¥ç”¨æ¥è¯„ä¼°è¯¥æ–¹æ³•çš„æ€§èƒ½ã€‚æ‰€æœ‰æˆ‘ä»¬ç»å¸¸ä½¿ç”¨ARæ¥å¯¹æ­¤è¿›è¡Œåˆ¤æ–­</p>
<script type="math/tex; mode=display">
AR=\frac{sum of the videos recalled}{total number of videos}(5)</script><h3 id="D-å‡å€¼å¹³å‡ç²¾åº¦-MEAN-AVERAGE-PRECISION-mAP"><a href="#D-å‡å€¼å¹³å‡ç²¾åº¦-MEAN-AVERAGE-PRECISION-mAP" class="headerlink" title="D. å‡å€¼å¹³å‡ç²¾åº¦(MEAN AVERAGE PRECISION,mAP)"></a>D. å‡å€¼å¹³å‡ç²¾åº¦(MEAN AVERAGE PRECISION,mAP)</h3><p>åœ¨æ—¶é—´åŠ¨ä½œå®šä½ä»»åŠ¡ä¸­ï¼ŒmAPæ˜¯æœ€å¸¸ç”¨çš„è¯„ä»·æŒ‡æ ‡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åœ¨t-IoU = 0.5çš„æƒ…å†µä¸‹æ¯”è¾ƒmApã€‚</p>
<p>ç®€å•åœ°è¯´ï¼Œ Precision (P)æ˜¯ç»™å®šè§†é¢‘ä¸­å•ä¸ªç±»çš„æ­£ç¡®æ£€æµ‹ç¨‹åº¦ã€‚ä¾‹å¦‚ï¼Œå¯¹äºç»™å®šçš„å•ä¸ªè§†é¢‘ï¼Œåœ¨å…¬å¼ä¸­æ˜¾ç¤ºäº†ç±»Cçš„ç²¾åº¦ã€‚</p>
<script type="math/tex; mode=display">
P=\frac{TP}{TP + FP}=\frac{number of predicted correct proposals}{total mumber of predicted proposals}(6)</script><p>ç”±äºæµ‹è¯•é›†ä¸­æœ‰å¾ˆå¤šè§†é¢‘ï¼Œå¹³å‡ç²¾åº¦(AP)æ˜¯ç±»Cä¸­æ‰€æœ‰è§†é¢‘çš„å¹³å‡ç²¾åº¦ã€‚åŒæ—¶ï¼Œç”±äºæµ‹è¯•é›†è§†é¢‘å¯¹åº”çš„ç±»ä¹Ÿå¾ˆå¤šï¼Œæ‰€ä»¥å¹³å‡å¹³å‡ç²¾åº¦å°±æ˜¯æ‰€æœ‰æµ‹è¯•è§†é¢‘ä¸­æ‰€æœ‰ç±»çš„å¹³å‡ç²¾åº¦ã€‚</p>
<script type="math/tex; mode=display">
mAP=\frac{the sum of average precision of all classes}{total number of videos in testing set}(7)</script><p>æ€»ä¹‹ï¼Œåœ¨æŸt-IoUä¸‹ï¼ŒPæ˜¯æŸç±»Cåœ¨è§†é¢‘ä¸­é¢„æµ‹å»ºè®®åŒºåŸŸçš„å‡†ç¡®æ€§ã€‚APæ˜¯è§†é¢‘ä¸­æ‰€æœ‰ç±»åˆ«çš„é¢„æµ‹å»ºè®®çš„å¹³å‡ç²¾åº¦ã€‚MAPæ˜¯æ‰€æœ‰æµ‹è¯•è§†é¢‘ä¸­æ‰€æœ‰ç±»çš„é¢„æµ‹å»ºè®®çš„å¹³å‡ç²¾åº¦çš„å¹³å‡å€¼ã€‚åœ¨æ ‡å‡†è¯„ä»·æ–¹æ¡ˆä¸‹ï¼Œå‡ ä¹æ‰€æœ‰çš„æ–‡çŒ®éƒ½æŠ¥é“äº†ä¸åŒé˜ˆå€¼çš„t-IoUä¸‹çš„mAP</p>
<h2 id="5-æœ€è¿‘çš„æ–¹æ³•å’Œå‘å±•"><a href="#5-æœ€è¿‘çš„æ–¹æ³•å’Œå‘å±•" class="headerlink" title="5.æœ€è¿‘çš„æ–¹æ³•å’Œå‘å±•"></a>5.æœ€è¿‘çš„æ–¹æ³•å’Œå‘å±•</h2><h3 id="A-å…¨ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½-FULLY-SUPETVISED-TEMPORAL-ACTION-LOCALIZATION-F-TAL"><a href="#A-å…¨ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½-FULLY-SUPETVISED-TEMPORAL-ACTION-LOCALIZATION-F-TAL" class="headerlink" title="A.å…¨ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½(FULLY-SUPETVISED TEMPORAL ACTION LOCALIZATION,F-TAL)"></a>A.å…¨ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½(FULLY-SUPETVISED TEMPORAL ACTION LOCALIZATION,F-TAL)</h3><h4 id="1-å…¨ç›‘ç£å­¦ä¹ "><a href="#1-å…¨ç›‘ç£å­¦ä¹ " class="headerlink" title="1)å…¨ç›‘ç£å­¦ä¹ "></a>1)å…¨ç›‘ç£å­¦ä¹ </h4><p>==å…¨ç›‘ç£å­¦ä¹ æ˜¯è®­ç»ƒä¸€ç§æ™ºèƒ½ç®—æ³•å°†è¾“å…¥æ•°æ®æ˜ å°„åˆ°æ ‡ç­¾çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æ¯ä¸ªè®­ç»ƒæ•°æ®éƒ½æœ‰å…¶å¯¹åº”çš„è¡¨ç¤ºå…¶ground truthçš„æ ‡ç­¾==ã€‚æˆ‘ä»¬ç»å¸¸å­¦ä¹ çš„åˆ†ç±»å’Œå›å½’æ˜¯ç›‘ç£å¼å­¦ä¹ çš„ä»£è¡¨ã€‚åœ¨æ—¶é—´åŠ¨ä½œå®šä½ä»»åŠ¡ä¸­ï¼Œå…¨ç›‘ç£é‡‡ç”¨è®­ç»ƒé›†çš„æ ‡ç­¾ï¼Œè¯¥æ ‡ç­¾æ—¢åŒ…å«è§†é¢‘çº§ç±»åˆ«æ ‡ç­¾ï¼ŒåˆåŒ…å«åŠ¨ä½œç‰‡æ®µçš„æ—¶é—´æ ‡æ³¨ä¿¡æ¯(åŒ…æ‹¬åŠ¨ä½œçš„å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´)ã€‚</p>
<h4 id="2-ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•"><a href="#2-ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•" class="headerlink" title="2)ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•"></a>2)ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•</h4><p>å¾ˆå¤šæ–¹æ³•(å¦‚S-CNN[14]å’ŒPSDF[18])é€šè¿‡æ»‘åŠ¨çª—å£ç”Ÿæˆå»ºè®®åŒºåŸŸï¼Œå¹¶å°†ææ¡ˆåˆ†ç±»ä¸ºC + 1ç±»ï¼Œå³CåŠ¨ä½œç±»å’Œä¸€ä¸ªèƒŒæ™¯ç±»ã€‚å…¶ä¸­ï¼ŒS-CNNä½¿ç”¨äº†å¤šçº§CNNæ—¶é—´åŠ¨ä½œå®šä½æ•è·é²æ£’çš„è§†é¢‘ç‰¹å¾è¡¨ç¤ºã€‚ä¸ºäº†ç²¾ç¡®çš„è¾¹ç•Œï¼ŒCDC [19] (Convolutional- de -Convolutional)ç½‘ç»œå’ŒTPC-Net [20] ((Temporal Preservation Convolutional network)ç½‘ç»œè¢«æå‡ºç”¨äºå¸§çº§çš„åŠ¨ä½œé¢„æµ‹ã€‚è¾¹ç•Œæ•æ„Ÿç½‘ç»œ(Boundary Sensitive Network, BSN[21])æ˜¯æœ€è¿‘æå‡ºçš„ä¸€ç§ç”¨äºå®šä½æ—¶é—´è¾¹ç•Œçš„ç½‘ç»œï¼Œå¹¶è¿›ä¸€æ­¥æ•´åˆåˆ°åŠ¨ä½œå»ºè®®åŒºåŸŸä¸­ã€‚æ¬¡å¹´ï¼ŒBSNçš„ä½œè€…æå‡ºäº†ä¸€ä¸ªæ–°çš„æ—¶é—´å»ºè®®åŒºåŸŸç½®ä¿¡åº¦è¯„ä»·æœºåˆ¶å’Œè¾¹ç•ŒåŒ¹é…æœºåˆ¶BMN [72]ã€‚BMNå¯ä»¥åŒæ—¶ç”Ÿæˆä¸€ç»´è¾¹ç•Œæ¦‚ç‡å’ŒäºŒç»´BMçš„ç½®ä¿¡åº¦å›¾ã€‚ä¸ºäº†ä¿è¯å»ºè®®åŒºåŸŸçš„å®Œæ•´æ€§ï¼ŒSSN[22]å¼•å…¥äº†ç»“æ„åŒ–æ—¶é—´é‡‘å­—å¡”ï¼Œåˆ©ç”¨è§£è€¦çš„åˆ†ç±»å™¨å¯¹è¡ŒåŠ¨è¿›è¡Œåˆ†ç±»å’Œç¡®å®šå®Œæ•´æ€§ã€‚æ­¤å¤–ï¼Œä¸€äº›åŸºäºåŒºåŸŸçš„æ–¹æ³•(å¦‚R-C3D[23]å’Œtalo - net[24])æå‡ºå°†äºŒç»´ç›®æ ‡æ£€æµ‹æ–¹æ³•æ¨å¹¿åˆ°ä¸€ç»´æ—¶é—´åŠ¨ä½œå®šä½ã€‚æœ€è¿‘ï¼Œä¸ºäº†ç²¾ç¡®åŠ¨ä½œå®šä½è€Œæå‡ºäº†TSA-Net [26]å’ŒGaussian temporal modeling [25]ã€‚ä¸‹é¢æ˜¯æ€§èƒ½æ¯”è¾ƒã€‚ä¸ºäº†ç®€å•å’Œå…¬å¹³ï¼Œæˆ‘ä»¬åœ¨THUMOS14æ•°æ®é›†å’Œå„ç§ä»£è¡¨æ€§æ–¹æ³•çš„å‡ºç‰ˆç‰©ä¸Šå¯¹mAP@tIoU = 0.5è¿›è¡Œæ€§èƒ½æ¯”è¾ƒï¼Œå¦‚è¡¨4æ‰€ç¤ºã€‚</p>
<p>è¿‘å¹´æ¥ï¼Œéšç€å„ç§æ–°å‹ç½‘ç»œçš„å¼•è¿›ï¼Œå‡†ç¡®ç‡å·²è¾¾åˆ°æœ€æ–°çš„46.9%[26]ã€‚å½“ç„¶ï¼Œä¸å›¾åƒä¸­çš„ç›®æ ‡æ£€æµ‹è¿˜æœ‰ä¸€å®šçš„å·®è·ï¼Œè¿™ä¹Ÿæ˜¯ç›®å‰éš¾ä»¥å®ç°å¤§è§„æ¨¡å•†ä¸šåŒ–çš„åŸå› ã€‚ä½†æˆ‘ä»¬å¯ä»¥ç›¸ä¿¡ï¼Œéšç€æŠ€æœ¯çš„ä¸æ–­è¿›æ­¥ï¼Œç²¾åº¦ä¸€å®šä¼šå®ç°çªç ´ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201115121823022.png" alt=""></p>
<h3 id="B-å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½-W-TAL"><a href="#B-å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½-W-TAL" class="headerlink" title="B.å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½(W-TAL)"></a>B.å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œå®šä½(W-TAL)</h3><p>ç”±ä¸ŠèŠ‚å¯çŸ¥ï¼Œç›®å‰çš„å…¨ç›‘ç£å­¦ä¹ æŠ€æœ¯åœ¨æ—¶é—´åŠ¨ä½œå®šä½æ–¹é¢å–å¾—äº†å¾ˆå¤§çš„æˆåŠŸã€‚å› ä¸ºè®¸å¤šç°æœ‰çš„æŠ€æœ¯ä¾èµ–äºè£å‰ªåçš„è§†é¢‘ä½œä¸ºè¾“å…¥ï¼Œä¾‹å¦‚ï¼šUCF101ï¼Œä»–ä»¬æœ‰è¿™äº›ç²¾ç¡®çš„æ—¶é—´æ³¨é‡Šã€‚ä½†åœ¨ç°å®æƒ…å†µä¸‹ï¼Œå¤§å¤šæ•°è§†é¢‘éƒ½æ˜¯æœªä¿®å‰ªå¹¶åŒ…å«è®¸å¤šä¸ç›®æ ‡åŠ¨ä½œæ— å…³çš„å¸§ã€‚å› æ­¤ï¼Œå¯¹æ—¶æ€æ ‡æ³¨çš„è¦æ±‚æ˜¯éå¸¸å›°éš¾çš„ã€‚å…·ä½“åŸå› æ€»ç»“å¦‚ä¸‹:a)æ¯ä¸ªåŠ¨ä½œå®ä¾‹çš„å¸§çº§æ³¨é‡Šæ—¢æ˜‚è´µåˆè€—æ—¶ã€‚b)æ—¶é—´è¡Œä¸ºå¹¶æ²¡æœ‰æ˜ç¡®çš„å®šä¹‰ï¼Œè¿™äº›æ—¶é—´è¡Œä¸ºçš„æ ‡æ³¨å¯èƒ½æ˜¯å› äººè€Œå¼‚çš„ã€‚</p>
<p>å› æ­¤ï¼Œå¼±ç›‘ç£å­¦ä¹ æ–¹æ³•è¶Šæ¥è¶Šå—æ¬¢è¿ã€‚</p>
<h4 id="1-å¼±ç›‘ç£å­¦ä¹ "><a href="#1-å¼±ç›‘ç£å­¦ä¹ " class="headerlink" title="1)å¼±ç›‘ç£å­¦ä¹ "></a>1)å¼±ç›‘ç£å­¦ä¹ </h4><p>è®©æˆ‘ä»¬çœ‹ä¸€çœ‹å¼±ç›‘ç£å­¦ä¹ ã€‚è¿™é‡Œæœ‰ä¸‰ç§ç±»å‹çš„å¼±ç›‘ç£å­¦ä¹ ã€‚a)ä¸å®Œå…¨å¼±ç›‘ç£å­¦ä¹ ã€‚ä¸å®Œå…¨ç›‘ç£ï¼Œè¿™åªæ˜¯è®­ç»ƒæ•°æ®çš„ä¸€å°éƒ¨åˆ†æ ‡è®°ï¼Œè€Œå…¶ä»–æ•°æ®æ²¡æœ‰æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾åƒåˆ†ç±»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»ç½‘ä¸Šå¾—åˆ°å¤§é‡çš„å›¾åƒï¼Œä½†ç”±äºäººå·¥æˆæœ¬æ˜‚è´µï¼Œåªæœ‰å°‘æ•°å›¾åƒæœ‰æ³¨é‡Šã€‚b)ä¸ç²¾ç¡®å¼±ç›‘ç£å­¦ä¹ ã€‚ä¹Ÿå°±æ˜¯è¯´è®­ç»ƒæ•°æ®åªæœ‰ç²—ç²’åº¦çš„æ ‡ç­¾ã€‚æˆ‘ä»¬è¿˜ä»¥å›¾åƒåˆ†ç±»ä¸ºä¾‹ã€‚æˆ‘ä»¬é€šå¸¸æœ‰å›¾åƒçº§æ ‡ç­¾ï¼Œä½†æ²¡æœ‰å¯¹è±¡çº§æ ‡ç­¾ã€‚c)ä¸å‡†ç¡®å¼±ç›‘ç£å­¦ä¹ ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç»™æˆ‘ä»¬çš„æ ‡ç­¾å¹¶ä¸æ€»æ˜¯çœŸå®çš„ã€‚ä¾‹å¦‚ï¼Œå½“å›¾åƒæ³¨é‡Šå™¨ç–²åŠ³æˆ–è€…ç²—å¿ƒå¤§æ„çš„æ—¶å€™ï¼Œæˆ–è€…ä¸€äº›å›¾åƒå¾ˆéš¾åˆ†ç±»çš„æ—¶å€™ï¼Œå°±ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚</p>
<p>ç”±ä¸Šå¯çŸ¥ï¼Œå¼±ç›‘ç£æ—¶é—´å®šä½åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­åªæœ‰è§†é¢‘çº§æ ‡ç­¾ï¼Œæ²¡æœ‰å¸§çº§æ—¶é—´æ ‡æ³¨ï¼Œå±äºç¬¬äºŒç±»å¼±ç›‘ç£ï¼Œå³ä¸ç²¾ç¡®ç›‘ç£ã€‚</p>
<h4 id="2-ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•-1"><a href="#2-ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•-1" class="headerlink" title="2)ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•"></a>2)ç›®å‰å…·æœ‰ä»£è¡¨æ€§çš„æ–¹æ³•</h4><p>ç›®å‰åŸºäºå¼±ç›‘ç£çš„å®šä½æ–¹æ³•å¾ˆå°‘ï¼Œä»…ä¾èµ–äºè§†é¢‘çº§çš„ç±»æ ‡ç­¾æ¥å®ç°æ—¶é—´åŠ¨ä½œå®šä½ã€‚å—å›¾åƒä¸­å¼±ç›‘ç£ç›®æ ‡æ£€æµ‹çš„å¯å‘ï¼Œç ”ç©¶äººå‘˜å¯¹UntrimmedNet[29]å’ŒHide-and-seek [30]è¿›è¡Œäº†ç ”ç©¶ã€‚UntrimmedNetæ˜¯ç¬¬ä¸€ä¸ªæå‡ºåŠ¨ä½œè¯†åˆ«å’Œå¼±ç›‘ç£åŠ¨ä½œæ£€æµ‹çš„å…¬å¸ã€‚å®ƒæ˜¯å­¦ä¹ å•æ ‡ç­¾åŠ¨ä½œåˆ†ç±»å’Œæ£€æµ‹çš„ä¸€ä¸ªç«¯åˆ°ç«¯æ¨¡å‹ã€‚STPN [31]æ˜¯ä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œï¼Œä¾èµ–äºåˆ†ç±»ã€‚è¿™ä¸ªç½‘ç»œçš„æ€»ä½“ç»“æ„å¦‚ä¸‹:å°†è§†é¢‘åˆ†ä¸ºNä¸ªç‰‡æ®µï¼Œæ³¨æ„åŠ›æ¨¡å—å¯ä»¥è¯†åˆ«å…³é”®ç‰‡æ®µçš„ç¨€ç–å­é›†ã€‚ç„¶åæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°åœ¨åˆ†ç±»æ ‡ç­¾é¢„æµ‹è¿‡ç¨‹ä¸­å„ä¸ªç¯èŠ‚çš„é‡è¦æ€§ã€‚å› æ­¤ï¼Œå®ƒèƒ½å¤Ÿé€šè¿‡è‡ªé€‚åº”æ—¶é—´æ± åŒ–ç”Ÿæˆç›¸åº”çš„ç±»åˆ«æ ‡ç­¾å’ŒåŒºé—´å»ºè®®ã€‚AutoLoc [32]å°è¯•æ ¹æ®CASçš„é˜ˆå€¼ç›´æ¥é¢„æµ‹ä¸åŒäºä»¥å¾€å¼±ç›‘ç£æ—¶é—´åŠ¨ä½œæ£€æµ‹çš„æ—¶é—´è¾¹ç•Œã€‚==å…¶ä¸»è¦æ€æƒ³æ˜¯é¼“åŠ±åŠ¨ä½œéƒ¨åˆ†å¤–çš„å¹³å‡åˆ†ä½äºåŠ¨ä½œç±»å†…çš„å¹³å‡åˆ†==ã€‚W-TALC [33] å¼•å…¥ä¸€ç§æ–°çš„å‡½æ•°æ¥è¿›è¡ŒK-maxå¤šå®ä¾‹å­¦ä¹ ï¼ŒæŒ–æ˜åŒä¸€ç±»å±€éƒ¨å®ä¾‹ä¹‹é—´çš„ååŒæ´»åŠ¨å…³ç³»ã€‚ä¸ºäº†è§£å†³åˆ†ç±»å™¨æ‰€å…³å¿ƒçš„è§†é¢‘å¸§çš„ç¢ç‰‡åŒ–å’ŒåŠ¨ä½œçš„å®Œæ•´æ€§é—®é¢˜ï¼ŒHide-and-seek[30]éšæœºéšè—ä¸€äº›å¸§ï¼Œè¿«ä½¿å‰©ä½™æ³¨æ„åŠ›åœ¨æ¯æ¬¡è®­ç»ƒä¸­å­¦ä¹ è¾¨åˆ«åº¦è¾ƒä½çš„è§†é¢‘å¸§ã€‚è™½ç„¶ï¼Œå®ƒä¸èƒ½ä¿è¯åœ¨æ¯æ¬¡è®­ç»ƒä¸­éƒ½èƒ½å‘ç°æ–°é›¶ä»¶ã€‚ç»“æœè¡¨æ˜ï¼Œè¯¥æ–¹æ³•å¯¹ç©ºé—´ç›®æ ‡æ£€æµ‹æ•ˆæœè‰¯å¥½ï¼Œä½†å¯¹æ—¶é—´åŠ¨ä½œå®šä½æ•ˆæœä¸ä½³ã€‚Step-by-step erasion, one-by-one collection å¯¹å¤šä¸ªåˆ†ç±»å™¨è¿›è¡Œæ“¦é™¤å’Œè®­ç»ƒï¼Œç›´æ¥åˆå¹¶æ¯ä¸ªåˆ†ç±»å™¨çš„é¢„æµ‹ç‰‡æ®µã€‚æ€§èƒ½å¥½äº†ä¸€äº›ï¼Œä½†æ˜¯å®ƒèŠ±è´¹æ›´å¤šçš„æ—¶é—´å’Œè®¡ç®—ã€‚éšåï¼ŒCMCS[35]æå‡ºäº†ä¸€ç§å…·æœ‰å¤šæ ·æ€§æŸå¤±çš„å¤šåˆ†æ”¯ç½‘ç»œç»“æ„ï¼Œç”¨äºåŠ¨ä½œå®Œæ•´æ€§å»ºæ¨¡ã€‚ä¸æ­¤åŒæ—¶ï¼Œä»–ä»¬æå‡ºäº†ä¸€ä¸ªæ–¹æ¡ˆï¼Œç”Ÿæˆä¸€ä¸ªhard negative è§†é¢‘æ¥åˆ†ç¦»ä¸Šä¸‹æ–‡ã€‚è™½ç„¶æœ¬æ–‡çš„é‡ç‚¹ä¸æ˜¯èƒŒæ™¯ç±»ï¼Œä½†å®ƒå¯å‘äº†æ¥ä¸‹æ¥çš„ä¸‰ä¸ªä½œå“ï¼Œå³BaSNet[36]ï¼Œbackground modeling[37]å’ŒLPAT [38]ã€‚åœ¨æ²¡æœ‰è€ƒè™‘èƒŒæ™¯ç±»åˆ«çš„æƒ…å†µä¸‹ï¼Œå°†èƒŒæ™¯å¸§è¯¯åˆ†ç±»ä¸ºåŠ¨ä½œç±»åˆ«ï¼Œå¯¼è‡´å¤§é‡FPsã€‚åœ¨BasNetä¸­ï¼Œä¸ºäº†æ„é€ èƒŒæ™¯ç±»çš„è´Ÿæ ·æœ¬ï¼Œåœ¨å¦ä¸€ä¸ªç½‘ç»œä¸­å¼•å…¥æ³¨æ„æ¨¡å—æ¥æŠ‘åˆ¶èƒŒæ™¯å“åº”ã€‚å¦å¤–ä¸¤éƒ¨ä½œå“ä»ä¸åŒçš„è§’åº¦è€ƒè™‘èƒŒæ™¯é˜¶çº§ï¼Œæœ‰æ•ˆåœ°æŠ‘åˆ¶äº†èƒŒæ™¯çš„å½±å“ã€‚æœ€åï¼Œå®ƒä»¬éƒ½æé«˜äº†å®šä½çš„å‡†ç¡®æ€§ã€‚</p>
<p>ä»¥ä¸‹æ˜¯åœ¨THUMOS14æ•°æ®é›†ä¸Šçš„æ€§èƒ½æ¯”è¾ƒï¼Œä¸å…¨ç›‘ç£å­¦ä¹ å’Œå„ç§ä»£è¡¨æ€§æ–¹æ³•å‘è¡¨çš„æ ‡å‡†ç›¸åŒï¼Œå¦‚è¡¨5æ‰€ç¤º</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/paper/image-20201115130532292.png" alt=""></p>
<h4 id="3ï¼‰å¯¹W-TALé—®é¢˜çš„è§è§£"><a href="#3ï¼‰å¯¹W-TALé—®é¢˜çš„è§è§£" class="headerlink" title="3ï¼‰å¯¹W-TALé—®é¢˜çš„è§è§£"></a>3ï¼‰å¯¹W-TALé—®é¢˜çš„è§è§£</h4><p>è¿‘å¹´æ¥ï¼Œå¤šç”¨ä¾‹å­¦ä¹ (multiple instance learning, MIL)è¢«åº”ç”¨äºW-TALå­¦ä¹ ä¸­ã€‚MILæ¨¡å‹ä¸æ˜¯ä½¿ç”¨ä¸€ç»„å•ç‹¬æ ‡è®°çš„å®ä¾‹æ¥å­¦ä¹ ï¼Œè€Œæ˜¯æ¥æ”¶ä¸€ç»„æ ‡è®°çš„åŒ…ï¼Œæ¯ä¸ªåŒ…åŒ…å«è®¸å¤šå®ä¾‹ã€‚å¦‚æœæˆ‘ä»¬æŠŠè§†é¢‘ä¸­çš„åŠ¨ä½œå®ä¾‹çœ‹ä½œä¸€ä¸ªåŒ…ï¼ŒæŠŠè§†é¢‘çº§åˆ«çš„æ³¨é‡Šçœ‹ä½œæ ‡ç­¾ï¼Œé‚£ä¹ˆW-TALå¯ä»¥è¢«è¡¨è¿°ä¸ºä¸€ä¸ªå¤šå®ä¾‹å­¦ä¹ çš„è¿‡ç¨‹ã€‚</p>
<p>æ—¶åºç±»æ¿€æ´»æ˜ å°„(Temporal class activation mappingï¼ŒT-CAM)æˆ–ç±»æ¿€æ´»åºåˆ—(r Class activation sequence ï¼ŒCAS)æ˜¯è¿‘å¹´æ¥å‡ºç°çš„å¦ä¸€ç§W-TALæ–¹æ³•ã€‚CNNå¯è§†åŒ–æ˜¾ç¤ºï¼ŒCNNçš„å·ç§¯å±‚ä½œä¸ºåŠ¨ä½œæ¢æµ‹å™¨æ‰§è¡Œï¼Œå°½ç®¡å¯¹æ´»åŠ¨çš„ä½ç½®æ²¡æœ‰ç›‘ç£ã€‚ç±»æ¿€æ´»åºåˆ—è¯´æ˜ï¼ŒCNNå°½ç®¡æ¥å—è¿‡è§†é¢‘å±‚æ¬¡æ ‡ç­¾çš„è®­ç»ƒï¼Œä½†ä»ç„¶èƒ½å¤Ÿå…·æœ‰æœ¬åœ°åŒ–èƒ½åŠ›ã€‚æ­¤å¤–ï¼ŒåŸºäºå¼±ç›‘ç£ç›®æ ‡æ£€æµ‹çš„å…¶ä»–ç ”ç©¶ï¼Œå¦‚äº¤äº’å¼æ ‡æ³¨å’Œç”Ÿæˆå¯¹æŠ—è®­ç»ƒï¼Œä¹Ÿå¯¹W-TALçš„ç ”ç©¶æœ‰æ‰€å¯å‘ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿°ï¼Œå¼±ç›‘ç£å­¦ä¹ é™ä½äº†åŠ³åŠ¨å’Œæ—¶é—´æˆæœ¬ï¼Œä½†ä¹Ÿå¢åŠ äº†æ—¶é—´æ£€æµ‹çš„éš¾åº¦ã€‚ä½†å¯¹äºå¤§å¤šæ•°åŠ¨ä½œç±»çš„å¤§å¤šæ•°è§†é¢‘å‰ªè¾‘æ¥è¯´ï¼Œæ•ˆæœä¼¼ä¹è¿˜ä¸é”™ã€‚å½“ç„¶ï¼Œä»æœ‰å¾ˆå¤§çš„æ”¹è¿›ç©ºé—´</p>
<h2 id="5-æœªæ¥æ–¹å‘å’Œå‘å±•è¶‹åŠ¿"><a href="#5-æœªæ¥æ–¹å‘å’Œå‘å±•è¶‹åŠ¿" class="headerlink" title="5.æœªæ¥æ–¹å‘å’Œå‘å±•è¶‹åŠ¿"></a>5.æœªæ¥æ–¹å‘å’Œå‘å±•è¶‹åŠ¿</h2><p>æ—¶é—´åŠ¨ä½œå®šä½çš„åº”ç”¨å®é™…ä¸Šä¼šè¶Šæ¥è¶Šå¹¿æ³›ï¼Œæœªæ¥çš„å‘å±•è¶‹åŠ¿å¯èƒ½é›†ä¸­ä½†ä¸é™äºä»¥ä¸‹å‡ æ–¹é¢</p>
<p>a)ç²¾åº¦å’Œæ•ˆç‡çš„æ”¹è¿›ã€‚é€šè¿‡ä¸äºŒç»´å·ç§¯æ³•å’Œä¸‰ç»´å·ç§¯æ³•çš„æ¯”è¾ƒï¼ŒäºŒç»´å·ç§¯æ³•çš„ç²¾åº¦æ›´é«˜ï¼Œä½†æ•ˆç‡è¾ƒä½ã€‚å¦‚ä½•æ›´å¥½åœ°å‘æŒ¥äºŒè€…çš„ä¼˜åŠ¿æ˜¯ä¸€ä¸ªå¯èƒ½çš„ç ”ç©¶æ–¹å‘</p>
<p>b)åŠ¨ä½œæ£€æµ‹å°†ä»æ—¶é—´åŠ¨ä½œæ£€æµ‹æ‰©å±•åˆ°æ—¶ç©ºåŠ¨ä½œæ£€æµ‹[39]ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åº”è¯¥ä»ä¸€ç»´çš„æ—¶é—´é—´éš”æ£€æµ‹åˆ°äºŒç»´çš„æ—¶ç©ºç›’ï¼Œè¿™æ ·å¯ä»¥æ›´å…¨é¢çš„æ£€æµ‹åŠ¨ä½œ</p>
<p>c)åœ¨çº¿è§†é¢‘çš„åŠ¨ä½œæ£€æµ‹ã€‚è¿™æ˜¯ä¸€ä¸ªå¤„ç†è§†é¢‘æµçš„è¿‡ç¨‹ï¼Œéœ€è¦åœ¨çº¿æ£€æµ‹åŠ¨ä½œçš„ç±»åˆ«ï¼Œä½†æ£€æµ‹æ—¶é—´è¿‡åæ— æ³•çŸ¥é“å†…å®¹ã€‚åœ¨çº¿çš„è®¾ç½®æ›´ç¬¦åˆéœ€è¦å®æ—¶æ£€æµ‹æˆ–é¢„è­¦çš„ç›‘æ§è§†é¢‘çš„è¦æ±‚ï¼Œå¦‚å¼‚å¸¸æ£€æµ‹[41]ã€‚</p>
<p>d)æ—¶é—´åŠ¨ä½œå®šä½çš„å¼±ç›‘ç£å­¦ä¹ å°†ä¼šè¶Šæ¥è¶Šå—æ¬¢è¿ã€‚åœ¨è®¸å¤šä»»åŠ¡ä¸­ï¼Œç”±äºæ•°æ®æ ‡æ³¨è¿‡ç¨‹æˆæœ¬é«˜æ˜‚ï¼Œéš¾ä»¥è·å¾—å®Œæ•´çš„ç›‘ç®¡ä¿¡æ¯ã€‚</p>
<p>e)è§†é¢‘æ˜¯ä¸€ç§åŒ…å«å›¾åƒå’ŒéŸ³é¢‘çš„å¤šæ¨¡æ€æ•°æ®ã€‚æ˜¯å¦åˆ©ç”¨éŸ³é¢‘ä¿¡æ¯è¾…åŠ©æ—¶é—´åŠ¨ä½œå®šä½æ˜¯å€¼å¾—è€ƒè™‘çš„æ–¹å‘ã€‚æ­£å¦‚Aytarç­‰äººä½¿ç”¨å›¾åƒè¾…åŠ©éŸ³é¢‘åˆ†æ[45]ã€‚</p>
<h2 id="6-ç»“è®º"><a href="#6-ç»“è®º" class="headerlink" title="6.ç»“è®º"></a>6.ç»“è®º</h2><p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯¹æ—¶é—´åŠ¨ä½œå®šä½è¿›è¡Œäº†å…¨é¢çš„æ¦‚è¿°ã€‚æˆ‘ä»¬ä»æ—¶é—´åˆ’åˆ†çš„è§’åº¦åˆ†æäº†ç›¸å…³æŠ€æœ¯:ä¼ ç»Ÿæ–¹æ³•å’Œæ·±åº¦å­¦ä¹ æ–¹æ³•ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ€»ç»“åŸºå‡†æ•°æ®é›†å’Œåˆ†æè¯„ä¼°æŒ‡æ ‡ã€‚ç„¶åå›é¡¾äº†æ—¶é—´åŠ¨ä½œå®šä½ä»å®Œå…¨ç›‘ç£å­¦ä¹ åˆ°å¼±ç›‘ç£å­¦ä¹ æ–¹æ³•çš„æœ€æ–°è¿›å±•ã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬è¯•å›¾ç»™å‡ºæ—¶é—´è¡Œä¸ºæœ¬åœŸåŒ–çš„ç›¸å…³æ€§å’Œç°çŠ¶ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›å¯¹æ—¶é—´åŠ¨ä½œå®šä½æ„Ÿå…´è¶£çš„è¯»è€…æœ‰æ‰€å¸®åŠ©ã€‚</p>
<p>æ—¶é—´åŠ¨ä½œå®šä½æ˜¯è§†é¢‘ç†è§£é¢†åŸŸçš„ä¸€ä¸ªç ”ç©¶çƒ­ç‚¹ï¼Œå…·æœ‰å¾ˆå¤§çš„å¤æ‚æ€§å’ŒæŒ‘æˆ˜æ€§ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬ç›¸ä¿¡åœ¨ä¸ä¹…çš„å°†æ¥ï¼Œæ·±åº¦å­¦ä¹ æŠ€æœ¯çš„åº”ç”¨å¯ä»¥æ”¹å–„ç»“æœï¼Œä»»åŠ¡ä¹Ÿä¼šå˜å¾—æ›´åŠ å®¹æ˜“ã€‚</p>
]]></content>
      <categories>
        <category>è®ºæ–‡å­¦ä¹ </category>
      </categories>
      <tags>
        <tag>æ—¶åºåŠ¨ä½œå®šä½</tag>
        <tag>åŠ¨ä½œæ£€æµ‹</tag>
        <tag>ç»¼è¿°</tag>
      </tags>
  </entry>
  <entry>
    <title>æ™ºèƒ½æŒ‡é’ˆ</title>
    <url>/2024/10/07/C++/%E6%99%BA%E8%83%BD%E6%8C%87%E9%92%88/</url>
    <content><![CDATA[<p>C++ä¸­å·²ç»åŸºæœ¬ä¸æ¨èä½¿ç”¨è£¸æŒ‡é’ˆï¼ˆæ‰‹åŠ¨è¿›è¡Œ<code>new</code>å’Œ<code>delete</code>ï¼‰ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆã€‚æ‰€ä»¥ä½œä¸ºC++ç¨‹åºå‘˜å¿…é¡»å­¦ä¼šæ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨ï¼š<code>auto_ptr</code>ï¼ˆå·²åºŸå¼ƒä¸å»ºè®®ä½¿ç”¨ï¼‰ã€<code>unique_ptr</code>ã€<code>share_ptr</code>ã€<code>weak_ptr</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ™ºèƒ½æŒ‡é’ˆæ€ç»´å¯¼å›¾.png" alt="ç”»æ¿"><br><span id="more"></span></p>
<h2 id="auto-ptr-å·²åºŸå¼ƒ"><a href="#auto-ptr-å·²åºŸå¼ƒ" class="headerlink" title="auto_ptr(å·²åºŸå¼ƒ)"></a><code>auto_ptr</code>(å·²åºŸå¼ƒ)</h2><p><code>auto_ptr</code>æ˜¯C++98æ ‡å‡†åº“ä¸­æä¾›çš„æ™ºèƒ½æŒ‡é’ˆä¹‹ä¸€ï¼Œç”¨äºç®¡ç†åŠ¨æ€åˆ†é…çš„å†…å­˜èµ„æºã€‚å®ƒé‡‡ç”¨<strong>ç‹¬å æ‰€æœ‰æƒ</strong>çš„æ–¹å¼ç®¡ç†èµ„æºï¼Œå³åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª<code>auto_ptr</code>å®ä¾‹æ‹¥æœ‰ç‰¹å®šèµ„æºçš„æ‰€æœ‰æƒã€‚å½“<code>auto_ptr</code>å®ä¾‹è¢«é”€æ¯æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨é‡Šæ”¾æ‰€ç®¡ç†çš„èµ„æºï¼Œä»è€Œé¿å…äº†å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">auto_ptr&lt;string&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> string(<span class="string">&quot;hello world&quot;</span>))</span></span>;</span><br><span class="line">auto_ptr&lt;string&gt; sp2;</span><br><span class="line">sp2 = sp1;   <span class="comment">// èµ‹å€¼åsp1ä¸ºç©º</span></span><br></pre></td></tr></table></figure>
<p><code>auto_ptr</code>è¢«åºŸå¼ƒæœ‰ä¸€ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>è¯­ä¹‰ä¸æ¸…ã€‚å½“å¤åˆ¶ä¸€ä¸ª<code>auto_ptr</code>å¯¹è±¡æ—¶ï¼ˆæ‹·è´å¤åˆ¶æˆ–operator =å¤åˆ¶ï¼‰ï¼ŒåŸå¯¹è±¡æ‰€æŒæœ‰çš„å †å†…å­˜å¯¹è±¡ä¹Ÿä¼šè½¬ç§»ç»™å¤åˆ¶å‡ºæ¥çš„å¯¹è±¡ã€‚è¿™ç§æ˜¯å¤åˆ¶è¯­ä¹‰ï¼Œä½†æ˜¯å…·ä½“å®ç°å´æ˜¯è½¬ç§»ï¼ˆmoveï¼‰ï¼Œè¯­ä¹‰ä¸Šå°±å®¹æ˜“è®©äººæ··æ·†ï¼Œè®©äººé€»è¾‘ä¸Šå¾ˆå®¹æ˜“é”™è¯¯ï¼Œæ‰€ä»¥åé¢å‡ºç°äº†<code>unique_ptr</code>ä»£æ›¿<code>auto_ptr</code></li>
<li>ä¸é€‚ç”¨äºå®¹å™¨ï¼š<code>auto_ptr</code>ä¸èƒ½å¾ˆå¥½åœ°ä¸STLå®¹å™¨ä¸€èµ·ä½¿ç”¨ï¼Œå› ä¸ºåœ¨å®¹å™¨ä¸­è¿›è¡Œå…ƒç´ çš„å¤åˆ¶æˆ–ç§»åŠ¨æ“ä½œæ—¶ä¼šå¯¼è‡´æŒ‡é’ˆæ‰€æœ‰æƒçš„è½¬ç§»ï¼Œå¯èƒ½å¼•å‘é”™è¯¯ã€‚</li>
</ol>
<p><code>auto_ptr</code>äº†è§£ä¸€ä¸‹å°±è¡Œï¼Œä¸»è¦æ„Ÿè§‰å…«è‚¡æ–‡è€ƒçš„å¤šä¸€äº›</p>
<h2 id="unique-ptr"><a href="#unique-ptr" class="headerlink" title="unique_ptr"></a>unique_ptr</h2><p><code>unique_ptr</code>æ˜¯C++11æ ‡å‡†å¼•å…¥çš„æ™ºèƒ½æŒ‡é’ˆä¹‹ä¸€ï¼Œå®ƒé‡‡ç”¨<strong>ç‹¬å æ‰€æœ‰æƒ</strong>çš„æ–¹å¼ï¼Œå³åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª<code>unique_ptr</code>å®ä¾‹æ‹¥æœ‰ç‰¹å®šèµ„æºçš„æ‰€æœ‰æƒã€‚è¿™æ„å‘³ç€åœ¨ä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ª<code>unique_ptr</code>å¯ä»¥æŒ‡å‘ç‰¹å®šçš„èµ„æºï¼Œé¿å…äº†å¤šé‡æ‰€æœ‰æƒå¯èƒ½å¼•å‘çš„é—®é¢˜ã€‚<code>unique_ptr</code>å¯ä»¥è¯´æ˜¯<code>auto_ptr</code>çš„å‡çº§ç‰ˆæœ¬ã€‚</p>
<p>å‰é¢<code>auto_ptr</code>ä»£ç ä½¿ç”¨<code>unique_ptr</code>ä»£æ›¿ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;std::string&gt; <span class="title">uptr1</span><span class="params">(<span class="keyword">new</span> std::string(<span class="string">&quot;hello world&quot;</span>))</span></span>;</span><br><span class="line">std::unique_ptr&lt;std::string&gt; uptr2;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°† uptr1 çš„æ‰€æœ‰æƒè½¬ç§»ç»™ uptr2ï¼Œè½¬ç§»åuptr1ä¸ºnullptr</span></span><br><span class="line">uptr2 = std::<span class="built_in">move</span>(uptr1);</span><br></pre></td></tr></table></figure>
<ol>
<li><code>auto_ptr</code> çš„å‰è½¦ä¹‹é‰´ï¼Œ<code>unique_ptr</code> ç¦æ­¢å¤åˆ¶è¯­ä¹‰ï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸ªæ•ˆæœï¼Œ<code>std::unique_ptr</code> ç±»çš„æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦ï¼ˆ<code>operator =</code>ï¼‰è¢«æ ‡è®°ä¸º <code>delete</code>ã€‚<code>unique_ptr</code> åªèƒ½é€šè¿‡ç§»åŠ¨æ„é€ æˆ–è€…ç§»åŠ¨èµ‹å€¼è¿›è¡Œè½¬ç§»</li>
<li>è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚<code>unique_ptr</code>é»˜è®¤çš„åˆ é™¤å™¨æ˜¯<code>delete</code>ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬æƒ³å®šä¹‰è‡ªå·±çš„åˆ é™¤å™¨ï¼Œè¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥å®ç°çš„ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨autoå’Œlambdaè¡¨è¾¾å¼å®šä¹‰è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line">    <span class="keyword">auto</span> customDeleter = [](<span class="type">int</span>* ptr) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;è‡ªå®šä¹‰åˆ é™¤å™¨è¢«è°ƒç”¨ï¼Œé‡Šæ”¾èµ„æºï¼š&quot;</span> &lt;&lt; *ptr &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> ptr;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line">    <span class="function">std::unique_ptr&lt;<span class="type">int</span>, <span class="title">decltype</span><span class="params">(customDeleter)</span>&gt; <span class="title">uptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">42</span>), customDeleter)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰‹åŠ¨é‡Šæ”¾èµ„æº</span></span><br><span class="line">    uptr.<span class="built_in">reset</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>unique_ptr</code>çš„æŒ‡é’ˆå¤§å°å’Œæ™®é€šæŒ‡é’ˆç›¸ç­‰ï¼Œæ‰€ä»¥ä¸€èˆ¬æ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>unique_ptr</code>æœ€èŠ‚çº¦å†…å­˜ã€‚</li>
</ol>
<h3 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p> <code>unique_ptr</code>å…¶ä¸­çš„æºç ï¼ˆvisual studio C++20ï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span> <span class="comment">/* = default_delete&lt;_Ty&gt; */</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">unique_ptr</span> &#123; <span class="comment">// non-copyable pointer to an object</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// æŒ‡é’ˆç±»å‹</span></span><br><span class="line">    <span class="keyword">using</span> pointer      = <span class="keyword">typename</span> _Get_deleter_pointer_type&lt;_Ty, <span class="type">remove_reference_t</span>&lt;_Dx&gt;&gt;::type;</span><br><span class="line">    <span class="comment">// å…ƒç´ ç±»å‹</span></span><br><span class="line">    <span class="keyword">using</span> element_type = _Ty;</span><br><span class="line">    <span class="comment">// åˆ é™¤å™¨ç±»å‹</span></span><br><span class="line">    <span class="keyword">using</span> deleter_type = _Dx;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx2</span> = _Dx, _Unique_ptr_enable_default_t&lt;_Dx2&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">unique_ptr</span>() <span class="keyword">noexcept</span> : _Mypair(_Zero_then_variadic_args_t&#123;&#125;) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Dx2 = _Dx, _Unique_ptr_enable_default_t&lt;_Dx2&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="keyword">constexpr</span> <span class="built_in">unique_ptr</span>(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> : _Mypair(_Zero_then_variadic_args_t&#123;&#125;) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    _CONSTEXPR23 unique_ptr&amp; <span class="keyword">operator</span>=(<span class="type">nullptr_t</span>) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">reset</span>();</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The Standard depicts these constructors that accept pointer as taking type_identity_t&lt;pointer&gt; to inhibit CTAD.</span></span><br><span class="line">    <span class="comment">// Since pointer is an opaque type alias in our implementation, it inhibits CTAD without extra decoration.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx2</span> = _Dx, _Unique_ptr_enable_default_t&lt;_Dx2&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 <span class="keyword">explicit</span> <span class="built_in">unique_ptr</span>(pointer _Ptr) <span class="keyword">noexcept</span> : _Mypair(_Zero_then_variadic_args_t&#123;&#125;, _Ptr) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Dx2 = _Dx, <span class="type">enable_if_t</span>&lt;is_constructible_v&lt;_Dx2, <span class="type">const</span> _Dx2&amp;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 <span class="built_in">unique_ptr</span>(pointer _Ptr, <span class="type">const</span> _Dx&amp; _Dt) <span class="keyword">noexcept</span> : _Mypair(_One_then_variadic_args_t&#123;&#125;, _Dt, _Ptr) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Dx2                                                                            = _Dx,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;negation&lt;is_reference&lt;_Dx2&gt;&gt;, is_constructible&lt;_Dx2, _Dx2&gt;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 <span class="built_in">unique_ptr</span>(pointer _Ptr, _Dx&amp;&amp; _Dt) <span class="keyword">noexcept</span></span><br><span class="line">        : _Mypair(_One_then_variadic_args_t&#123;&#125;, _STD <span class="built_in">move</span>(_Dt), _Ptr) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Dx2                                                                                      = _Dx,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_reference&lt;_Dx2&gt;, is_constructible&lt;_Dx2, <span class="type">remove_reference_t</span>&lt;_Dx2&gt;&gt;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">unique_ptr</span>(pointer, <span class="type">remove_reference_t</span>&lt;_Dx&gt;&amp;&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">    <span class="comment">// ç§»åŠ¨æ„é€ </span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx2</span> = _Dx, <span class="type">enable_if_t</span>&lt;is_move_constructible_v&lt;_Dx2&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 <span class="built_in">unique_ptr</span>(unique_ptr&amp;&amp; _Right) <span class="keyword">noexcept</span></span><br><span class="line">        : _Mypair(_One_then_variadic_args_t&#123;&#125;, _STD forward&lt;_Dx&gt;(_Right.<span class="built_in">get_deleter</span>()), _Right.<span class="built_in">release</span>()) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Ty2, <span class="keyword">class</span> _Dx2,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;</span><br><span class="line">            conjunction_v&lt;negation&lt;is_array&lt;_Ty2&gt;&gt;, is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Ty2, _Dx2&gt;::pointer, pointer&gt;,</span><br><span class="line">                <span class="type">conditional_t</span>&lt;is_reference_v&lt;_Dx&gt;, is_same&lt;_Dx2, _Dx&gt;, is_convertible&lt;_Dx2, _Dx&gt;&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 <span class="built_in">unique_ptr</span>(unique_ptr&lt;_Ty2, _Dx2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span></span><br><span class="line">        : _Mypair(_One_then_variadic_args_t&#123;&#125;, _STD forward&lt;_Dx2&gt;(_Right.<span class="built_in">get_deleter</span>()), _Right.<span class="built_in">release</span>()) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> _Ty2, <span class="keyword">class</span> _Dx2,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;negation&lt;is_array&lt;_Ty2&gt;&gt;, is_assignable&lt;_Dx&amp;, _Dx2&gt;,</span><br><span class="line">                        is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Ty2, _Dx2&gt;::pointer, pointer&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 unique_ptr&amp; <span class="keyword">operator</span>=(unique_ptr&lt;_Ty2, _Dx2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">reset</span>(_Right.<span class="built_in">release</span>());</span><br><span class="line">        _Mypair._Get_first() = _STD forward&lt;_Dx2&gt;(_Right._Mypair._Get_first());</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç§»åŠ¨èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx2</span> = _Dx, <span class="type">enable_if_t</span>&lt;is_move_assignable_v&lt;_Dx2&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _CONSTEXPR23 unique_ptr&amp; <span class="keyword">operator</span>=(unique_ptr&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> != _STD <span class="built_in">addressof</span>(_Right)) &#123;</span><br><span class="line">            <span class="built_in">reset</span>(_Right.<span class="built_in">release</span>());</span><br><span class="line">            _Mypair._Get_first() = _STD forward&lt;_Dx&gt;(_Right._Mypair._Get_first());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_CONSTEXPR23 <span class="type">void</span> <span class="title">swap</span><span class="params">(unique_ptr&amp; _Right)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        _Swap_adl(_Mypair._Myval2, _Right._Mypair._Myval2);</span><br><span class="line">        _Swap_adl(_Mypair._Get_first(), _Right._Mypair._Get_first());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _CONSTEXPR23 ~<span class="built_in">unique_ptr</span>() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_Mypair._Myval2) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨ firståˆ é™¤å™¨ åˆ é™¤ æŒ‡é’ˆ</span></span><br><span class="line">            _Mypair._Get_first()(_Mypair._Myval2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD _CONSTEXPR23 _Dx&amp; <span class="title">get_deleter</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Mypair._Get_first();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD _CONSTEXPR23 <span class="type">const</span> _Dx&amp; <span class="title">get_deleter</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Mypair._Get_first();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _NODISCARD _CONSTEXPR23 <span class="type">add_lvalue_reference_t</span>&lt;_Ty&gt; <span class="keyword">operator</span>*() <span class="function"><span class="type">const</span> <span class="title">noexcept</span><span class="params">(<span class="keyword">noexcept</span>(*_STD declval&lt;pointer&gt;()))</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *_Mypair._Myval2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _NODISCARD _CONSTEXPR23 pointer <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> _Mypair._Myval2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD _CONSTEXPR23 pointer <span class="title">get</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Mypair._Myval2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_CONSTEXPR23 <span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">bool</span>&gt;(_Mypair._Myval2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_CONSTEXPR23 pointer <span class="title">release</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _STD <span class="built_in">exchange</span>(_Mypair._Myval2, <span class="literal">nullptr</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_CONSTEXPR23 <span class="type">void</span> <span class="title">reset</span><span class="params">(pointer _Ptr = <span class="literal">nullptr</span>)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        pointer _Old = _STD <span class="built_in">exchange</span>(_Mypair._Myval2, _Ptr);</span><br><span class="line">        <span class="keyword">if</span> (_Old) &#123;</span><br><span class="line">            _Mypair._Get_first()(_Old);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¤åˆ¶æ“ä½œè®¾ç½®ä¸ºdelete</span></span><br><span class="line">    <span class="built_in">unique_ptr</span>(<span class="type">const</span> unique_ptr&amp;)            = <span class="keyword">delete</span>;</span><br><span class="line">    unique_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> unique_ptr&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span>, <span class="keyword">class</span>&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">unique_ptr</span>;</span><br><span class="line">    <span class="comment">// _Mypair firstæ˜¯åˆ é™¤å™¨ï¼Œsecondæ˜¯æŒ‡é’ˆ</span></span><br><span class="line">    _Compressed_pair&lt;_Dx, pointer&gt; _Mypair;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>unique_ptr</code>å®ç°ç²—ç•¥çœ‹æ¯”è¾ƒç®€å•ï¼Œæ•°æ®æˆå‘˜æ¯”è¾ƒé‡è¦çš„å°±æ˜¯<code>_Mypair</code>ï¼Œé‡Œé¢å­˜æ”¾è€…åˆ é™¤å™¨å’ŒæŒ‡é’ˆï¼Œåœ¨ææ„çš„æ—¶å€™å°±è°ƒç”¨åˆ é™¤å™¨åˆ é™¤æŒ‡é’ˆã€‚</p>
<h2 id="share-ptr"><a href="#share-ptr" class="headerlink" title="share_ptr"></a>share_ptr</h2><p><code>share_ptr</code>é€šè¿‡å¼•ç”¨è®¡æ•°çš„æ–¹å¼æ¥æ§åˆ¶èµ„æºçš„é‡Šæ”¾ï¼Œå…è®¸å¤šä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªèµ„æºï¼ˆå…±äº«ï¼‰ï¼Œæ¯å¤šä¸€ä¸ª<code>std::shared_ptr</code>å¯¹èµ„æºçš„å¼•ç”¨ï¼Œèµ„æºå¼•ç”¨è®¡æ•°å°†å¢åŠ 1ï¼Œæ¯ä¸€ä¸ªæŒ‡å‘è¯¥èµ„æºçš„<code>std::shared_ptr</code>å¯¹è±¡ææ„æ—¶ï¼Œèµ„æºå¼•ç”¨è®¡æ•°å‡1ï¼Œæœ€åä¸€ä¸ª<code>std::shared_ptr</code>å¯¹è±¡ææ„æ—¶ï¼Œå‘ç°èµ„æºè®¡æ•°ä¸º0ï¼Œå°†é‡Šæ”¾å…¶æŒæœ‰çš„èµ„æºã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆå§‹åŒ–æ–¹å¼1</span></span><br><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp1</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">123</span>))</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ–¹å¼2</span></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sp2;</span><br><span class="line">sp<span class="number">2.</span><span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">123</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆå§‹åŒ–æ–¹å¼3</span></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; sp3;</span><br><span class="line">sp3 = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt;(<span class="number">123</span>);</span><br></pre></td></tr></table></figure>
<ol>
<li>è‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œ<code>shared_ptr</code>è‡ªå®šä¹‰åˆ é™¤å™¨æ¯”<code>unique_ptr</code> ç®€å•ä¸€äº›ï¼Œä¸ä¼šå½±å“æŒ‡é’ˆæŒ‡é’ˆçš„ç±»å‹</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨autoå’Œlambdaè¡¨è¾¾å¼å®šä¹‰è‡ªå®šä¹‰åˆ é™¤å™¨</span></span><br><span class="line">    <span class="keyword">auto</span> customDeleter = [](<span class="type">int</span>* ptr) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;è‡ªå®šä¹‰åˆ é™¤å™¨è¢«è°ƒç”¨ï¼Œé‡Šæ”¾èµ„æºï¼š&quot;</span> &lt;&lt; *ptr &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">delete</span> ptr;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨autoå’Œlambdaè¡¨è¾¾å¼å®ç°è‡ªå®šä¹‰åˆ é™¤å™¨çš„shared_ptr</span></span><br><span class="line">    <span class="keyword">auto</span> sptr = std::<span class="built_in">shared_ptr</span>&lt;<span class="type">int</span>&gt;(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">42</span>), customDeleter);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨shared_ptrè®¿é—®èµ„æº</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sptræŒ‡å‘çš„æ•´æ•°æ˜¯: &quot;</span> &lt;&lt; *sptr &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å½“æœ€åä¸€ä¸ªshared_ptré”€æ¯æ—¶ï¼Œè‡ªå®šä¹‰åˆ é™¤å™¨ä¼šè¢«è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>åœ¨<code>shared_ptr</code>æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘èµ„æºï¼Œä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ§åˆ¶å—ï¼Œæ‰€ä»¥<code>shared_ptr</code>å¤§å°å…¶å®æ˜¯æ™®é€šæŒ‡é’ˆçš„ä¸¤å€ï¼Œå¹¶ä¸”æ¯æ¬¡<code>shared_ptr</code>æ“ä½œéƒ½ä¼šå¯¹æ§åˆ¶å—è¿›è¡Œæ“ä½œï¼ˆå¯¹å¼•ç”¨æŠ€æœ¯è¿›è¡Œæ“ä½œï¼‰ï¼Œæ‰€ä»¥æ•ˆç‡æ²¡æœ‰<code>unique_ptr</code>é«˜ã€‚</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/share_ptrç¤ºæ„.png" alt=""></p>
<h3 id="æºç åˆ†æ-1"><a href="#æºç åˆ†æ-1" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h3><p>å…ˆçœ‹ç±»å›¾</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/share_ptrç±»å›¾.png" alt=""></p>
<ol>
<li><code>shared_ptr</code> ç»§æ‰¿<code>_Ptr_base</code>ï¼Œå…³äºæŒ‡é’ˆå’Œæ§åˆ¶å—çš„éƒ¨åˆ†éƒ½æ˜¯åœ¨<code>_Ptr_base</code>ä¸­ï¼Œ<code>shared_ptr</code>è°ƒç”¨<code>_Ptr_base</code>ä¸­å†…å®¹è¿›è¡Œå¼•ç”¨è®¡ç®—çš„å¢åŠ å’Œå‡å°‘</li>
<li><code>_Ptr_base</code>é‡è¦çš„æ•°æ®æˆå‘˜ï¼š<code>_Ptr</code>ã€<code>_Rep</code>ä¸¤ä¸ªæŒ‡é’ˆä¸€ä¸ªæŒ‡å‘èµ„æºã€ä¸€ä¸ªæŒ‡å‘æ§åˆ¶å—ï¼ˆ<code>_Ref_count_base</code>ï¼‰</li>
<li><code>_Ref_count_base</code>ï¼ˆæ§åˆ¶å—ï¼‰æ˜¯ä¸ªçº¯è™šç±»ï¼Œé‡Œé¢æœ‰useså’Œweaksä¸¤ä¸ªå¼•ç”¨æ§åˆ¶å—</li>
<li><code>_Ref_count_base</code>æœ‰ä¸‰ä¸ªå®ç°ç±»<code>_Ref_count</code>ã€<code>_Ref_count_resource</code>ã€<code>_Ref_count_resource_alloc</code>ï¼Œåˆ†åˆ«ä»£è¡¨æ™®é€šå¼•ç”¨è®¡æ•°ã€å¸¦åˆ é™¤å™¨çš„å¼•ç”¨è®¡æ•°ã€å¸¦åˆ é™¤å™¨å’Œåˆ†é…å™¨çš„å¼•ç”¨è®¡æ•°</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">shared_ptr</span> : <span class="keyword">public</span> _Ptr_base&lt;_Ty&gt; &#123; <span class="comment">// class for reference counted resource management</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">using</span> _Mybase = _Ptr_base&lt;_Ty&gt;;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">typename</span> _Mybase::element_type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _HAS_CXX17</span></span><br><span class="line">    <span class="keyword">using</span> weak_type = weak_ptr&lt;_Ty&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _HAS_CXX17</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">shared_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>= <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">shared_ptr</span><span class="params">(<span class="type">nullptr_t</span>)</span> <span class="keyword">noexcept</span> </span>&#123;&#125; <span class="comment">// construct empty shared_ptr</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;<span class="type">conditional_t</span>&lt;is_array_v&lt;_Ty&gt;, _Can_array_delete&lt;_Ux&gt;, _Can_scalar_delete&lt;_Ux&gt;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">shared_ptr</span>(_Ux* _Px) &#123; <span class="comment">// construct shared_ptr object that owns _Px</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">constexpr</span> (is_array_v&lt;_Ty&gt;) &#123;</span><br><span class="line">            _Setpd(_Px, default_delete&lt;_Ux[]&gt;&#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _Temporary_owner&lt;_Ux&gt; _Owner(_Px);</span><br><span class="line">            <span class="comment">// æ­¤å‡½æ•°å’Œenable_share_from_thisç›¸å…³</span></span><br><span class="line">            _Set_ptr_rep_and_enable_shared(_Owner._Ptr, <span class="keyword">new</span> _Ref_count&lt;_Ux&gt;(_Owner._Ptr));</span><br><span class="line">            _Owner._Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, _Ux*&amp;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(_Ux* _Px, _Dx _Dt) &#123; <span class="comment">// construct with _Px, deleter</span></span><br><span class="line">        _Setpd(_Px, _STD <span class="built_in">move</span>(_Dt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>, <span class="keyword">class</span> <span class="title class_">_Alloc</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, _Ux*&amp;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(_Ux* _Px, _Dx _Dt, _Alloc _Ax) &#123; <span class="comment">// construct with _Px, deleter, allocator</span></span><br><span class="line">        _Setpda(_Px, _STD <span class="built_in">move</span>(_Dt), _Ax);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, <span class="type">nullptr_t</span>&amp;&gt;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span>, _Dx _Dt) &#123; <span class="comment">// construct with nullptr, deleter</span></span><br><span class="line">        _Setpd(<span class="literal">nullptr</span>, _STD <span class="built_in">move</span>(_Dt));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Dx</span>, <span class="keyword">class</span> <span class="title class_">_Alloc</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, <span class="type">nullptr_t</span>&amp;&gt;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(<span class="type">nullptr_t</span>, _Dx _Dt, _Alloc _Ax) &#123; <span class="comment">// construct with nullptr, deleter, allocator</span></span><br><span class="line">        _Setpda(<span class="literal">nullptr</span>, _STD <span class="built_in">move</span>(_Dt), _Ax);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Right, element_type* _Px) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// construct shared_ptr object that aliases _Right</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Alias_construct_from(_Right, _Px);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(shared_ptr&lt;_Ty2&gt;&amp;&amp; _Right, element_type* _Px) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// move construct shared_ptr object that aliases _Right</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Alias_move_construct_from(_STD <span class="built_in">move</span>(_Right), _Px);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&amp; _Other) <span class="keyword">noexcept</span> &#123; <span class="comment">// construct shared_ptr object that owns same resource as _Other</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Copy_construct_from(_Other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// construct shared_ptr object that owns same resource as _Other</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Copy_construct_from(_Other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">shared_ptr</span>(shared_ptr&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123; <span class="comment">// construct shared_ptr object that takes resource from _Right</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Move_construct_from(_STD <span class="built_in">move</span>(_Right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">shared_ptr</span>(shared_ptr&lt;_Ty2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123; <span class="comment">// construct shared_ptr object that takes resource from _Right</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Move_construct_from(_STD <span class="built_in">move</span>(_Right));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="keyword">explicit</span> <span class="built_in">shared_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Ty2&gt;&amp; _Other) &#123; <span class="comment">// construct shared_ptr object that owns resource *_Other</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>-&gt;_Construct_from_weak(_Other)) &#123;</span><br><span class="line">            _Throw_bad_weak_ptr();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;_SP_pointer_compatible&lt;_Ux, _Ty&gt;,</span><br><span class="line">                        is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Ux, _Dx&gt;::pointer, element_type*&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="comment">// ä»unique_ptrè¿›è¡Œæ„é€ </span></span><br><span class="line">    <span class="built_in">shared_ptr</span>(unique_ptr&lt;_Ux, _Dx&gt;&amp;&amp; _Other) &#123;</span><br><span class="line">        <span class="keyword">using</span> _Fancy_t   = <span class="keyword">typename</span> unique_ptr&lt;_Ux, _Dx&gt;::pointer;</span><br><span class="line">        <span class="keyword">using</span> _Raw_t     = <span class="keyword">typename</span> unique_ptr&lt;_Ux, _Dx&gt;::element_type*;</span><br><span class="line">        <span class="keyword">using</span> _Deleter_t = <span class="type">conditional_t</span>&lt;is_reference_v&lt;_Dx&gt;, <span class="keyword">decltype</span>(_STD <span class="built_in">ref</span>(_Other.<span class="built_in">get_deleter</span>())), _Dx&gt;;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> _Fancy_t _Fancy = _Other.<span class="built_in">get</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_Fancy) &#123;</span><br><span class="line">            <span class="type">const</span> _Raw_t _Raw = _Fancy;</span><br><span class="line">            <span class="type">const</span> <span class="keyword">auto</span> _Rx =</span><br><span class="line">                <span class="keyword">new</span> _Ref_count_resource&lt;_Fancy_t, _Deleter_t&gt;(_Fancy, _STD forward&lt;_Dx&gt;(_Other.<span class="built_in">get_deleter</span>()));</span><br><span class="line">            _Set_ptr_rep_and_enable_shared(_Raw, _Rx);</span><br><span class="line">            _Other.<span class="built_in">release</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ææ„çš„æ—¶å€™è°ƒç”¨_Decrefå‡å°‘å¼•ç”¨</span></span><br><span class="line">    ~<span class="built_in">shared_ptr</span>() <span class="keyword">noexcept</span> &#123; <span class="comment">// release resource</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Decref();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">shared_ptr</span>(_Right).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">shared_ptr</span>(_Right).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(shared_ptr&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123; <span class="comment">// take resource from _Right</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_STD <span class="built_in">move</span>(_Right)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(shared_ptr&lt;_Ty2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123; <span class="comment">// take resource from _Right</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_STD <span class="built_in">move</span>(_Right)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;_SP_pointer_compatible&lt;_Ux, _Ty&gt;,</span><br><span class="line">                        is_convertible&lt;<span class="keyword">typename</span> unique_ptr&lt;_Ux, _Dx&gt;::pointer, element_type*&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    shared_ptr&amp; <span class="keyword">operator</span>=(unique_ptr&lt;_Ux, _Dx&gt;&amp;&amp; _Right) &#123; <span class="comment">// move from unique_ptr</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_STD <span class="built_in">move</span>(_Right)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(shared_ptr&amp; _Other)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Swap(_Other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123; <span class="comment">// release resource and convert to empty shared_ptr object</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>().<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;<span class="type">conditional_t</span>&lt;is_array_v&lt;_Ty&gt;, _Can_array_delete&lt;_Ux&gt;, _Can_scalar_delete&lt;_Ux&gt;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">reset</span>(_Ux* _Px) &#123; <span class="comment">// release, take ownership of _Px</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_Px).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, _Ux*&amp;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">reset</span>(_Ux* _Px, _Dx _Dt) &#123; <span class="comment">// release, take ownership of _Px, with deleter _Dt</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_Px, _Dt).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>, <span class="keyword">class</span> <span class="title class_">_Alloc</span>,</span><br><span class="line">        <span class="type">enable_if_t</span>&lt;conjunction_v&lt;is_move_constructible&lt;_Dx&gt;, _Can_call_function_object&lt;_Dx&amp;, _Ux*&amp;&gt;,</span><br><span class="line">                        _SP_convertible&lt;_Ux, _Ty&gt;&gt;,</span><br><span class="line">            <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">reset</span>(_Ux* _Px, _Dx _Dt, _Alloc _Ax) &#123; <span class="comment">// release, take ownership of _Px, with deleter _Dt, allocator _Ax</span></span><br><span class="line">        <span class="built_in">shared_ptr</span>(_Px, _Dt, _Ax).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> _Mybase::get;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span> = _Ty, <span class="type">enable_if_t</span>&lt;!disjunction_v&lt;is_array&lt;_Ty2&gt;, is_void&lt;_Ty2&gt;&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _NODISCARD _Ty2&amp; <span class="keyword">operator</span>*() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="built_in">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span> = _Ty, <span class="type">enable_if_t</span>&lt;!is_array_v&lt;_Ty2&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _NODISCARD _Ty2* <span class="keyword">operator</span>-&gt;() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span> = _Ty, <span class="keyword">class</span> _Elem = element_type, <span class="type">enable_if_t</span>&lt;is_array_v&lt;_Ty2&gt;, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    _NODISCARD _Elem&amp; <span class="keyword">operator</span>[](<span class="type">ptrdiff_t</span> _Idx) <span class="type">const</span> <span class="keyword">noexcept</span> <span class="comment">/* strengthened */</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>()[_Idx];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="title">bool</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">get</span>() != <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_UxptrOrNullptr</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Setpd(<span class="type">const</span> _UxptrOrNullptr _Px, _Dx _Dt) &#123; <span class="comment">// take ownership of _Px, deleter _Dt</span></span><br><span class="line">        _Temporary_owner_del&lt;_UxptrOrNullptr, _Dx&gt; _Owner(_Px, _Dt);</span><br><span class="line">        _Set_ptr_rep_and_enable_shared(</span><br><span class="line">            _Owner._Ptr, <span class="keyword">new</span> _Ref_count_resource&lt;_UxptrOrNullptr, _Dx&gt;(_Owner._Ptr, _STD <span class="built_in">move</span>(_Dt)));</span><br><span class="line">        _Owner._Call_deleter = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_UxptrOrNullptr</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>, <span class="keyword">class</span> <span class="title class_">_Alloc</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Setpda(<span class="type">const</span> _UxptrOrNullptr _Px, _Dx _Dt, _Alloc _Ax) &#123; <span class="comment">// take ownership of _Px, deleter _Dt, allocator _Ax</span></span><br><span class="line">        <span class="keyword">using</span> _Alref_alloc = _Rebind_alloc_t&lt;_Alloc, _Ref_count_resource_alloc&lt;_UxptrOrNullptr, _Dx, _Alloc&gt;&gt;;</span><br><span class="line"></span><br><span class="line">        _Temporary_owner_del&lt;_UxptrOrNullptr, _Dx&gt; _Owner(_Px, _Dt);</span><br><span class="line">        _Alref_alloc _Alref(_Ax);</span><br><span class="line">        _Alloc_construct_ptr&lt;_Alref_alloc&gt; _Constructor(_Alref);</span><br><span class="line">        _Constructor._Allocate();</span><br><span class="line">        _Construct_in_place(*_Constructor._Ptr, _Owner._Ptr, _STD <span class="built_in">move</span>(_Dt), _Ax);</span><br><span class="line">        _Set_ptr_rep_and_enable_shared(_Owner._Ptr, _Unfancy(_Constructor._Ptr));</span><br><span class="line">        _Constructor._Ptr    = <span class="literal">nullptr</span>;</span><br><span class="line">        _Owner._Call_deleter = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ux</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Set_ptr_rep_and_enable_shared(_Ux* <span class="type">const</span> _Px, _Ref_count_base* <span class="type">const</span> _Rx) <span class="keyword">noexcept</span> &#123; <span class="comment">// take ownership of _Px</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Ptr = _Px;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Rep = _Rx;</span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(conjunction_v&lt;negation&lt;is_array&lt;_Ty&gt;&gt;, negation&lt;is_volatile&lt;_Ux&gt;&gt;, _Can_enable_shared&lt;_Ux&gt;&gt;)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_Px &amp;&amp; _Px-&gt;_Wptr.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">                _Px-&gt;_Wptr = shared_ptr&lt;<span class="type">remove_cv_t</span>&lt;_Ux&gt;&gt;(*<span class="keyword">this</span>, <span class="keyword">const_cast</span>&lt;<span class="type">remove_cv_t</span>&lt;_Ux&gt;*&gt;(_Px));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Set_ptr_rep_and_enable_shared(<span class="type">nullptr_t</span>, _Ref_count_base* <span class="type">const</span> _Rx) <span class="keyword">noexcept</span> &#123; <span class="comment">// take ownership of nullptr</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Rep = _Rx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_Ptr_base</span> &#123; <span class="comment">// base class for shared_ptr and weak_ptr</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> element_type = <span class="type">remove_extent_t</span>&lt;_Ty&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD <span class="type">long</span> <span class="title">use_count</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Rep ? _Rep-&gt;_Use_count() : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="function">_NODISCARD <span class="type">bool</span> <span class="title">owner_before</span><span class="params">(<span class="type">const</span> _Ptr_base&lt;_Ty2&gt;&amp; _Right)</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="comment">// compare addresses of manager objects</span></span><br><span class="line">        <span class="keyword">return</span> _Rep &lt; _Right._Rep;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Ptr_base(<span class="type">const</span> _Ptr_base&amp;)            = <span class="keyword">delete</span>;</span><br><span class="line">    _Ptr_base&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Ptr_base&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function">_NODISCARD element_type* <span class="title">get</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constexpr</span> _Ptr_base() <span class="keyword">noexcept</span> = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    ~_Ptr_base() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Move_construct_from(_Ptr_base&lt;_Ty2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement shared_ptr&#x27;s (converting) move ctor and weak_ptr&#x27;s move ctor</span></span><br><span class="line">        _Ptr = _Right._Ptr;</span><br><span class="line">        _Rep = _Right._Rep;</span><br><span class="line"></span><br><span class="line">        _Right._Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        _Right._Rep = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Copy_construct_from(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement shared_ptr&#x27;s (converting) copy ctor</span></span><br><span class="line">        _Other._Incref();</span><br><span class="line"></span><br><span class="line">        _Ptr = _Other._Ptr;</span><br><span class="line">        _Rep = _Other._Rep;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Alias_construct_from(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Other, element_type* _Px) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement shared_ptr&#x27;s aliasing ctor</span></span><br><span class="line">        _Other._Incref();</span><br><span class="line"></span><br><span class="line">        _Ptr = _Px;</span><br><span class="line">        _Rep = _Other._Rep;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Alias_move_construct_from(shared_ptr&lt;_Ty2&gt;&amp;&amp; _Other, element_type* _Px) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement shared_ptr&#x27;s aliasing move ctor</span></span><br><span class="line">        _Ptr = _Px;</span><br><span class="line">        _Rep = _Other._Rep;</span><br><span class="line"></span><br><span class="line">        _Other._Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        _Other._Rep = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty0</span>&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">weak_ptr</span>; <span class="comment">// specifically, weak_ptr::lock()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">bool</span> _Construct_from_weak(<span class="type">const</span> weak_ptr&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement shared_ptr&#x27;s ctor from weak_ptr, and weak_ptr::lock()</span></span><br><span class="line">        <span class="keyword">if</span> (_Other._Rep &amp;&amp; _Other._Rep-&gt;_Incref_nz()) &#123;</span><br><span class="line">            _Ptr = _Other._Ptr;</span><br><span class="line">            _Rep = _Other._Rep;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Userå¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="type">void</span> _Incref() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_Rep) &#123;</span><br><span class="line">            _Rep-&gt;_Incref();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Userå‡å°‘å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="type">void</span> _Decref() <span class="keyword">noexcept</span> &#123; <span class="comment">// decrement reference count</span></span><br><span class="line">        <span class="keyword">if</span> (_Rep) &#123;</span><br><span class="line">            _Rep-&gt;_Decref();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Swap(_Ptr_base&amp; _Right) <span class="keyword">noexcept</span> &#123; <span class="comment">// swap pointers</span></span><br><span class="line">        <span class="function">_STD <span class="title">swap</span><span class="params">(_Ptr, _Right._Ptr)</span></span>;</span><br><span class="line">        <span class="function">_STD <span class="title">swap</span><span class="params">(_Rep, _Right._Rep)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Weakly_construct_from(<span class="type">const</span> _Ptr_base&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123; <span class="comment">// implement weak_ptr&#x27;s ctors</span></span><br><span class="line">        <span class="keyword">if</span> (_Other._Rep) &#123;</span><br><span class="line">            _Ptr = _Other._Ptr;</span><br><span class="line">            _Rep = _Other._Rep;</span><br><span class="line">            _Rep-&gt;_Incwref();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _STL_INTERNAL_CHECK(!_Ptr &amp;&amp; !_Rep);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Weakly_convert_lvalue_avoiding_expired_conversions(<span class="type">const</span> _Ptr_base&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement weak_ptr&#x27;s copy converting ctor</span></span><br><span class="line">        <span class="keyword">if</span> (_Other._Rep) &#123;</span><br><span class="line">            _Rep = _Other._Rep; <span class="comment">// always share ownership</span></span><br><span class="line">            _Rep-&gt;_Incwref();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_Rep-&gt;_Incref_nz()) &#123;</span><br><span class="line">                _Ptr = _Other._Ptr; <span class="comment">// keep resource alive during conversion, handling virtual inheritance</span></span><br><span class="line">                _Rep-&gt;_Decref();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                _STL_INTERNAL_CHECK(!_Ptr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _STL_INTERNAL_CHECK(!_Ptr &amp;&amp; !_Rep);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">void</span> _Weakly_convert_rvalue_avoiding_expired_conversions(_Ptr_base&lt;_Ty2&gt;&amp;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="comment">// implement weak_ptr&#x27;s move converting ctor</span></span><br><span class="line">        _Rep        = _Other._Rep; <span class="comment">// always transfer ownership</span></span><br><span class="line">        _Other._Rep = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_Rep &amp;&amp; _Rep-&gt;_Incref_nz()) &#123;</span><br><span class="line">            _Ptr = _Other._Ptr; <span class="comment">// keep resource alive during conversion, handling virtual inheritance</span></span><br><span class="line">            _Rep-&gt;_Decref();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _STL_INTERNAL_CHECK(!_Ptr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _Other._Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weakså¢åŠ å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="type">void</span> _Incwref() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_Rep) &#123;</span><br><span class="line">            _Rep-&gt;_Incwref();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// weakså‡å°‘å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="type">void</span> _Decwref() <span class="keyword">noexcept</span> &#123; <span class="comment">// decrement weak reference count</span></span><br><span class="line">        <span class="keyword">if</span> (_Rep) &#123;</span><br><span class="line">            _Rep-&gt;_Decwref();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="comment">// æ™ºèƒ½æŒ‡é’ˆå…³è”çš„åŸå§‹æŒ‡é’ˆ</span></span><br><span class="line">    element_type* _Ptr&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line"><span class="comment">// ç®¡ç†æ™ºèƒ½æŒ‡é’ˆçš„ æ§åˆ¶å—</span></span><br><span class="line">    _Ref_count_base* _Rep&#123;<span class="literal">nullptr</span>&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">__declspec</span>(novtable) _Ref_count_base &#123; <span class="comment">// common code for reference counting</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _M_CEE_PURE</span></span><br><span class="line">    <span class="comment">// permanent workaround to avoid mentioning _purecall in msvcurt.lib, ptrustu.lib, or other support libs</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> _Destroy() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="function">_STD <span class="title">terminate</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> _Delete_this() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="function">_STD <span class="title">terminate</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// ^^^ _M_CEE_PURE / !_M_CEE_PURE vvv</span></span></span><br><span class="line">   <span class="comment">// çº¯è™šå‡½æ•°</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> _Destroy() <span class="keyword">noexcept</span>     = <span class="number">0</span>; <span class="comment">// destroy managed resource</span></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span> _Delete_this() <span class="keyword">noexcept</span> = <span class="number">0</span>; <span class="comment">// destroy self</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line">    <span class="comment">// å¼ºæŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ï¼ˆåŸå­ï¼‰</span></span><br><span class="line">    _Atomic_counter_t _Uses  = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å¼±æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ï¼ˆåŸå­ï¼‰</span></span><br><span class="line">    _Atomic_counter_t _Weaks = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="keyword">constexpr</span> _Ref_count_base() <span class="keyword">noexcept</span> = <span class="keyword">default</span>; <span class="comment">// non-atomic initializations</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// ä¸å…è®¸å¤åˆ¶</span></span><br><span class="line">    _Ref_count_base(<span class="type">const</span> _Ref_count_base&amp;)            = <span class="keyword">delete</span>;</span><br><span class="line">    _Ref_count_base&amp; <span class="keyword">operator</span>=(<span class="type">const</span> _Ref_count_base&amp;) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~_Ref_count_base() <span class="keyword">noexcept</span> &#123;&#125; <span class="comment">// TRANSITION, should be non-virtual</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> _Incref_nz() <span class="keyword">noexcept</span> &#123; <span class="comment">// increment use count if not zero, return true if successful</span></span><br><span class="line">        <span class="keyword">auto</span>&amp; _Volatile_uses = <span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">long</span>&amp;&gt;(_Uses);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _M_CEE_PURE</span></span><br><span class="line">        <span class="type">long</span> _Count = *_Atomic_address_as&lt;<span class="type">const</span> <span class="type">long</span>&gt;(&amp;_Volatile_uses);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        <span class="type">long</span> _Count = __iso_volatile_load32(<span class="built_in">reinterpret_cast</span>&lt;<span class="keyword">volatile</span> <span class="type">int</span>*&gt;(&amp;_Volatile_uses));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="keyword">while</span> (_Count != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">long</span> _Old_value = _INTRIN_RELAXED(_InterlockedCompareExchange)(&amp;_Volatile_uses, _Count + <span class="number">1</span>, _Count);</span><br><span class="line">            <span class="keyword">if</span> (_Old_value == _Count) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            _Count = _Old_value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Incref() <span class="keyword">noexcept</span> &#123; <span class="comment">// increment use count</span></span><br><span class="line">        _MT_INCR(_Uses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Incwref() <span class="keyword">noexcept</span> &#123; <span class="comment">// increment weak reference count</span></span><br><span class="line">        _MT_INCR(_Weaks);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Decref() <span class="keyword">noexcept</span> &#123; <span class="comment">// decrement use count</span></span><br><span class="line">        <span class="keyword">if</span> (_MT_DECR(_Uses) == <span class="number">0</span>) &#123;</span><br><span class="line">            _Destroy();</span><br><span class="line">            _Decwref();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Decwref() <span class="keyword">noexcept</span> &#123; <span class="comment">// decrement weak reference count</span></span><br><span class="line">        <span class="keyword">if</span> (_MT_DECR(_Weaks) == <span class="number">0</span>) &#123;</span><br><span class="line">            _Delete_this();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> _Use_count() <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">static_cast</span>&lt;<span class="type">long</span>&gt;(_Uses);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> <span class="type">void</span>* _Get_deleter(<span class="type">const</span> type_info&amp;) <span class="type">const</span> <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ä¸å¸¦åˆ é™¤å™¨çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_Ref_count</span> : <span class="keyword">public</span> _Ref_count_base &#123; <span class="comment">// handle reference counting for pointer without deleter</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">explicit</span> _Ref_count(_Ty* _Px) : _Ref_count_base(), _Ptr(_Px) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">void</span> _Destroy() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy managed resource</span></span><br><span class="line">        <span class="keyword">delete</span> _Ptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Delete_this() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy self</span></span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Ty* _Ptr;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// å¸¦åˆ é™¤å™¨çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Resource</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_Ref_count_resource</span> : <span class="keyword">public</span> _Ref_count_base &#123; <span class="comment">// handle reference counting for object with deleter</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    _Ref_count_resource(_Resource _Px, _Dx _Dt)</span><br><span class="line">        : _Ref_count_base(), _Mypair(_One_then_variadic_args_t&#123;&#125;, _STD <span class="built_in">move</span>(_Dt), _Px) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __EDG__ <span class="comment">// TRANSITION, VSO-1292293</span></span></span><br><span class="line">    ~_Ref_count_resource() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123;&#125; <span class="comment">// TRANSITION, should be non-virtual</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// ^^^ workaround / no workaround vvv</span></span></span><br><span class="line">    ~_Ref_count_resource() <span class="keyword">noexcept</span> <span class="keyword">override</span> = <span class="keyword">default</span>; <span class="comment">// TRANSITION, should be non-virtual</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ^^^ no workaround ^^^</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* _Get_deleter(<span class="type">const</span> type_info&amp; _Typeid) <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _HAS_STATIC_RTTI</span></span><br><span class="line">        <span class="keyword">if</span> (_Typeid == <span class="built_in">typeid</span>(_Dx)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Dx*&gt;(_STD <span class="built_in">addressof</span>(_Mypair._Get_first()));</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// _HAS_STATIC_RTTI</span></span></span><br><span class="line">        (<span class="type">void</span>) _Typeid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _HAS_STATIC_RTTI</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">void</span> _Destroy() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy managed resource</span></span><br><span class="line">        _Mypair._Get_first()(_Mypair._Myval2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Delete_this() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy self</span></span><br><span class="line">        <span class="keyword">delete</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Compressed_pair&lt;_Dx, _Resource&gt; _Mypair;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¦åˆ é™¤å™¨å’Œåˆ†é…å™¨ çš„ å¼•ç”¨è®¡æ•°</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Resource</span>, <span class="keyword">class</span> <span class="title class_">_Dx</span>, <span class="keyword">class</span> <span class="title class_">_Alloc</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">_Ref_count_resource_alloc</span> : <span class="keyword">public</span> _Ref_count_base &#123;</span><br><span class="line">    <span class="comment">// handle reference counting for object with deleter and allocator</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    _Ref_count_resource_alloc(_Resource _Px, _Dx _Dt, <span class="type">const</span> _Alloc&amp; _Ax)</span><br><span class="line">        : _Ref_count_base(),</span><br><span class="line">          _Mypair(_One_then_variadic_args_t&#123;&#125;, _STD <span class="built_in">move</span>(_Dt), _One_then_variadic_args_t&#123;&#125;, _Ax, _Px) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __EDG__ <span class="comment">// TRANSITION, VSO-1292293</span></span></span><br><span class="line">    ~_Ref_count_resource_alloc() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123;&#125; <span class="comment">// TRANSITION, should be non-virtual</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// ^^^ workaround / no workaround vvv</span></span></span><br><span class="line">    ~_Ref_count_resource_alloc() <span class="keyword">noexcept</span> <span class="keyword">override</span> = <span class="keyword">default</span>; <span class="comment">// TRANSITION, should be non-virtual</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// ^^^ no workaround ^^^</span></span></span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* _Get_deleter(<span class="type">const</span> type_info&amp; _Typeid) <span class="type">const</span> <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> _HAS_STATIC_RTTI</span></span><br><span class="line">        <span class="keyword">if</span> (_Typeid == <span class="built_in">typeid</span>(_Dx)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">const_cast</span>&lt;_Dx*&gt;(_STD <span class="built_in">addressof</span>(_Mypair._Get_first()));</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// _HAS_STATIC_RTTI</span></span></span><br><span class="line">        (<span class="type">void</span>) _Typeid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _HAS_STATIC_RTTI</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">using</span> _Myalty = _Rebind_alloc_t&lt;_Alloc, _Ref_count_resource_alloc&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Destroy() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy managed resource</span></span><br><span class="line">        _Mypair._Get_first()(_Mypair._Myval<span class="number">2.</span>_Myval2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> _Delete_this() <span class="keyword">noexcept</span> <span class="keyword">override</span> &#123; <span class="comment">// destroy self</span></span><br><span class="line">        _Myalty _Al = _Mypair._Myval<span class="number">2.</span>_Get_first();</span><br><span class="line">        <span class="keyword">this</span>-&gt;~_Ref_count_resource_alloc();</span><br><span class="line">        _Deallocate_plain(_Al, <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _Compressed_pair&lt;_Dx, _Compressed_pair&lt;_Myalty, _Resource&gt;&gt; _Mypair;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="weak-ptr"><a href="#weak-ptr" class="headerlink" title="weak_ptr"></a>weak_ptr</h2><p><code>std::weak_ptr</code> æ˜¯ C++ æ ‡å‡†åº“ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºè§£å†³ <code>std::shared_ptr</code> çš„å¾ªç¯å¼•ç”¨ï¼ˆcircular referenceï¼‰é—®é¢˜ã€‚<code>std::weak_ptr</code> æ˜¯ä¸€ç§å¼±å¼•ç”¨ï¼Œä¸ä¼šå¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¹Ÿä¸ä¼šæ‹¥æœ‰è¢«ç®¡ç†çš„å¯¹è±¡ã€‚å®ƒé€šå¸¸ç”¨äºè§£å†³ç”± <code>std::shared_ptr</code> å½¢æˆçš„å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼Œç®€å•æ¥è¯´<code>weak_ptr</code>å°±æ˜¯ç”¨æ¥é…åˆ<code>share_ptr</code>ä¸€èµ·è¿›è¡Œä½¿ç”¨</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    std::string name;</span><br><span class="line">    std::weak_ptr&lt;Person&gt; partner;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Person</span>(<span class="type">const</span> std::string&amp; n) : <span class="built_in">name</span>(n) &#123;</span><br><span class="line">        std::cout &lt;&lt; name &lt;&lt; <span class="string">&quot; is created\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">Person</span>() &#123;</span><br><span class="line">        std::cout &lt;&lt; name &lt;&lt; <span class="string">&quot; is destroyed\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::shared_ptr&lt;Person&gt; alice = std::<span class="built_in">make_shared</span>&lt;Person&gt;(<span class="string">&quot;Alice&quot;</span>);</span><br><span class="line">    std::shared_ptr&lt;Person&gt; bob = std::<span class="built_in">make_shared</span>&lt;Person&gt;(<span class="string">&quot;Bob&quot;</span>);</span><br><span class="line"></span><br><span class="line">    alice-&gt;partner = bob;</span><br><span class="line">    bob-&gt;partner = alice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä½¿ç”¨ weak_ptr åˆ›å»º shared_ptrï¼Œé¿å…å¾ªç¯å¼•ç”¨</span></span><br><span class="line">    std::shared_ptr&lt;Person&gt; alicePartner = alice-&gt;partner.<span class="built_in">lock</span>();</span><br><span class="line">    std::shared_ptr&lt;Person&gt; bobPartner = bob-&gt;partner.<span class="built_in">lock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (alicePartner &amp;&amp; bobPartner) &#123;</span><br><span class="line">        std::cout &lt;&lt; alice-&gt;name &lt;&lt; <span class="string">&quot;&#x27;s partner is: &quot;</span> &lt;&lt; alicePartner-&gt;name &lt;&lt; std::endl;</span><br><span class="line">        std::cout &lt;&lt; bob-&gt;name &lt;&lt; <span class="string">&quot;&#x27;s partner is: &quot;</span> &lt;&lt; bobPartner-&gt;name &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;One of the partners is no longer available\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡å‰é¢<code>share_ptr</code>æºç çš„ç†è§£ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çŒœæµ‹<code>weak_ptr</code>æ˜¯é€šè¿‡æ§åˆ¶å—ä¸­<code>weaks</code>è¿›è¡Œæ§åˆ¶çš„ï¼Œä»æºç è§’åº¦æ¥è¯´<code>weak_ptr</code>ä»£ç é‡Œé¢åº”è¯¥æ˜¯å¯¹<code>weaks</code>è¿›è¡Œæ§åˆ¶ï¼Œå½“æœ‰ä¸€ä¸ªæ–°çš„<code>weak_ptr</code>æŒ‡å‘<code>share_ptr</code>å¼ï¼Œ<code>weaks</code>æ•°é‡è¿›è¡Œå¢åŠ ï¼Œ</p>
<p>æ‰€ä»¥å†…å­˜é‡Šæ”¾æ¥è¯´ï¼š</p>
<ul>
<li>å½“<code>Uses</code> ä¸º0æ—¶ï¼Œ<code>share_ptr</code>æŒ‡å‘èµ„æºä¼šè¿›è¡Œé‡Šæ”¾</li>
<li>å½“<code>weaks</code>ä¸º0æ—¶ï¼Œæ§åˆ¶å—å†…å­˜æ‰æœ€ç»ˆè¿›è¡Œäº†é‡Šæ”¾</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">weak_ptr</span> : <span class="keyword">public</span> _Ptr_base&lt;_Ty&gt; &#123; <span class="comment">// class for pointer to reference counted resource</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _M_CEE_PURE</span></span><br><span class="line">    <span class="comment">// When a constructor is converting from weak_ptr&lt;_Ty2&gt; to weak_ptr&lt;_Ty&gt;, the below type trait intentionally asks</span></span><br><span class="line">    <span class="comment">// whether it would be possible to static_cast from _Ty* to const _Ty2*; see N4901 [expr.static.cast]/11.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Primary template, the value is used when the substitution fails.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="keyword">class</span> = <span class="type">const</span> _Ty2*&gt;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">bool</span> _Must_avoid_expired_conversions_from = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Template specialization, the value is used when the substitution succeeds.</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>&gt;</span><br><span class="line">    <span class="type">static</span> <span class="keyword">constexpr</span> <span class="type">bool</span></span><br><span class="line">        _Must_avoid_expired_conversions_from&lt;_Ty2, <span class="keyword">decltype</span>(<span class="built_in">static_cast</span>&lt;<span class="type">const</span> _Ty2*&gt;(<span class="built_in">static_cast</span>&lt;_Ty*&gt;(<span class="literal">nullptr</span>)))&gt; =</span><br><span class="line">            <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">weak_ptr</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Weakly_construct_from(_Other); <span class="comment">// same type, no conversion</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">weak_ptr</span>(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Weakly_construct_from(_Other); <span class="comment">// shared_ptr keeps resource alive during conversion</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">weak_ptr</span>(<span class="type">const</span> weak_ptr&lt;_Ty2&gt;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _M_CEE_PURE</span></span><br><span class="line">        <span class="keyword">constexpr</span> <span class="type">bool</span> _Avoid_expired_conversions = <span class="literal">true</span>; <span class="comment">// slow, but always safe; avoids error LNK1179</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line">        <span class="keyword">constexpr</span> <span class="type">bool</span> _Avoid_expired_conversions = _Must_avoid_expired_conversions_from&lt;_Ty2&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(_Avoid_expired_conversions)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;_Weakly_convert_lvalue_avoiding_expired_conversions(_Other);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;_Weakly_construct_from(_Other);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">weak_ptr</span>(weak_ptr&amp;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Move_construct_from(_STD <span class="built_in">move</span>(_Other));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    <span class="built_in">weak_ptr</span>(weak_ptr&lt;_Ty2&gt;&amp;&amp; _Other) <span class="keyword">noexcept</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _M_CEE_PURE</span></span><br><span class="line">        <span class="keyword">constexpr</span> <span class="type">bool</span> _Avoid_expired_conversions = <span class="literal">true</span>; <span class="comment">// slow, but always safe; avoids error LNK1179</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line">        <span class="keyword">constexpr</span> <span class="type">bool</span> _Avoid_expired_conversions = _Must_avoid_expired_conversions_from&lt;_Ty2&gt;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// _M_CEE_PURE</span></span></span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(_Avoid_expired_conversions)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;_Weakly_convert_rvalue_avoiding_expired_conversions(_STD <span class="built_in">move</span>(_Other));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>-&gt;_Move_construct_from(_STD <span class="built_in">move</span>(_Other));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‡å°‘weakså¼•ç”¨è®¡æ•°</span></span><br><span class="line">    ~<span class="built_in">weak_ptr</span>() <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Decwref();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">weak_ptr</span>(_Right).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    weak_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> weak_ptr&lt;_Ty2&gt;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">weak_ptr</span>(_Right).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    weak_ptr&amp; <span class="keyword">operator</span>=(weak_ptr&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">weak_ptr</span>(_STD <span class="built_in">move</span>(_Right)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    weak_ptr&amp; <span class="keyword">operator</span>=(weak_ptr&lt;_Ty2&gt;&amp;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">weak_ptr</span>(_STD <span class="built_in">move</span>(_Right)).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty2</span>, <span class="type">enable_if_t</span>&lt;_SP_pointer_compatible&lt;_Ty2, _Ty&gt;::value, <span class="type">int</span>&gt; = <span class="number">0</span>&gt;</span><br><span class="line">    weak_ptr&amp; <span class="keyword">operator</span>=(<span class="type">const</span> shared_ptr&lt;_Ty2&gt;&amp; _Right) <span class="keyword">noexcept</span> &#123;</span><br><span class="line">        <span class="built_in">weak_ptr</span>(_Right).<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123; <span class="comment">// release resource, convert to null weak_ptr object</span></span><br><span class="line">        weak_ptr&#123;&#125;.<span class="built_in">swap</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">swap</span><span class="params">(weak_ptr&amp; _Other)</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Swap(_Other);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD <span class="type">bool</span> <span class="title">expired</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>-&gt;<span class="built_in">use_count</span>() == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD shared_ptr&lt;_Ty&gt; <span class="title">lock</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123; <span class="comment">// convert to shared_ptr</span></span><br><span class="line">        shared_ptr&lt;_Ty&gt; _Ret;</span><br><span class="line">        (<span class="type">void</span>) _Ret._Construct_from_weak(*<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> _Ret;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="make-uniqueå’Œmake-shared"><a href="#make-uniqueå’Œmake-shared" class="headerlink" title="make_uniqueå’Œmake_shared"></a><code>make_unique</code>å’Œ<code>make_shared</code></h2><p>ç°ä»£C++å»ºè®®å¤šä½¿ç”¨<code>make_unique</code>å’Œ<code>make_shared</code>ï¼ŒåŸå› ä¸»è¦æ˜¯ä¸¤ç‚¹</p>
<ul>
<li><strong>æ€§èƒ½ä¼˜åŠ¿</strong>ï¼š<code>std::make_shared</code>å¯ä»¥åœ¨å•ä¸ªå†…å­˜åˆ†é…ä¸­<strong>åŒæ—¶åˆ†é…æ§åˆ¶å—å’Œå¯¹è±¡å†…å­˜</strong>ï¼Œè€Œç›´æ¥ä½¿ç”¨<code>std::shared_ptr</code>åˆ™éœ€è¦åˆ†åˆ«è¿›è¡Œä¸¤æ¬¡å†…å­˜åˆ†é…ã€‚è¿™æ ·å¯ä»¥æé«˜å†…å­˜è®¿é—®çš„æ•ˆç‡å¹¶å‡å°‘å†…å­˜ç¢ç‰‡ã€‚ï¼ˆä»…ä»…é’ˆå¯¹<code>make_shared</code>ï¼‰</li>
<li><strong>å¼‚å¸¸å®‰å…¨æ€§</strong>ï¼š<code>std::make_shared</code>å¯ä»¥ç¡®ä¿åœ¨å†…å­˜åˆ†é…å¤±è´¥æ—¶ä¸ä¼šæ³„æ¼å†…å­˜ï¼Œå› ä¸ºå®ƒæ˜¯åŸå­æ“ä½œï¼Œè¦ä¹ˆæˆåŠŸåˆ›å»º<code>std::shared_ptr</code>ï¼Œè¦ä¹ˆä¸åˆ›å»ºï¼Œä¸ä¼šå‡ºç°ä¸­é—´çŠ¶æ€ã€‚</li>
</ul>
<p>ç¬¬äºŒç‚¹å¼‚å¸¸å®‰å…¨æ€§çš„è§£é‡Šï¼š</p>
<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸ªå‡½æ•°æŒ‰ç…§æŸç§ä¼˜å…ˆçº§å¤„ç†<code>Widget</code>:<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">processWidget</span><span class="params">(std::shared_ptr&lt;Widget&gt; spw, <span class="type">int</span> priority)</span></span>;</span><br></pre></td></tr></table></figure><br>ç°åœ¨å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°æ¥è®¡ç®—ç›¸å…³çš„ä¼˜å…ˆçº§ï¼Œ<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">computePriority</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure><br>å¹¶ä¸”æˆ‘ä»¬åœ¨è°ƒç”¨<code>processWidget</code>æ—¶ä½¿ç”¨äº†<code>new</code>è€Œä¸æ˜¯<code>std::make_shared</code>ï¼š<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">shared_ptr</span>&lt;Widget&gt;(<span class="keyword">new</span> Widget),  <span class="comment">//æ½œåœ¨çš„èµ„æºæ³„æ¼ï¼</span></span><br><span class="line">              <span class="built_in">computePriority</span>());</span><br></pre></td></tr></table></figure><br>åœ¨è¿è¡Œæ—¶ï¼Œä¸€ä¸ªå‡½æ•°çš„å®å‚å¿…é¡»å…ˆè¢«è®¡ç®—ï¼Œè¿™ä¸ªå‡½æ•°å†è¢«è°ƒç”¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>processWidget</code>ä¹‹å‰ï¼Œå¿…é¡»æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œ<code>processWidget</code>æ‰å¼€å§‹æ‰§è¡Œï¼š</p>
<ul>
<li>è¡¨è¾¾å¼<code>new Widget</code>å¿…é¡»è®¡ç®—ï¼Œä¾‹å¦‚ï¼Œä¸€ä¸ª<code>Widget</code>å¯¹è±¡å¿…é¡»åœ¨å †ä¸Šè¢«åˆ›å»º</li>
<li>è´Ÿè´£ç®¡ç†<code>new</code>å‡ºæ¥æŒ‡é’ˆçš„<code>std::shared_ptr&lt;Widget&gt;</code>æ„é€ å‡½æ•°å¿…é¡»è¢«æ‰§è¡Œ</li>
<li><code>computePriority</code>å¿…é¡»è¿è¡Œ</li>
</ul>
<p>ç¼–è¯‘å™¨ä¸éœ€è¦æŒ‰ç…§æ‰§è¡Œé¡ºåºç”Ÿæˆä»£ç ã€‚<code>new Widget</code>å¿…é¡»åœ¨<code>std::shared_ptr</code>çš„æ„é€ å‡½æ•°è¢«è°ƒç”¨å‰æ‰§è¡Œï¼Œå› ä¸º<code>new</code>å‡ºæ¥çš„ç»“æœä½œä¸ºæ„é€ å‡½æ•°çš„å®å‚ï¼Œä½†<code>computePriority</code>å¯èƒ½åœ¨è¿™ä¹‹å‰ï¼Œä¹‹åï¼Œæˆ–è€…ä¹‹é—´æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼–è¯‘å™¨å¯èƒ½æŒ‰ç…§è¿™ä¸ªæ‰§è¡Œé¡ºåºç”Ÿæˆä»£ç ï¼š</p>
<ol>
<li>æ‰§è¡Œ<code>new Widget</code></li>
<li>æ‰§è¡Œ<code>computePriority</code></li>
<li>è¿è¡Œ<code>std::shared_ptr</code>æ„é€ å‡½æ•°<br>å¦‚æœæŒ‰ç…§è¿™æ ·ç”Ÿæˆä»£ç ï¼Œå¹¶ä¸”åœ¨è¿è¡Œæ—¶<code>computePriority</code>äº§ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆç¬¬ä¸€æ­¥åŠ¨æ€åˆ†é…çš„<code>Widget</code>å°±ä¼šæ³„æ¼ã€‚å› ä¸ºå®ƒæ°¸è¿œéƒ½ä¸ä¼šè¢«ç¬¬ä¸‰æ­¥çš„<code>std::shared_ptr</code>æ‰€ç®¡ç†äº†ã€‚<br>ä½¿ç”¨<code>std::make_shared</code>å¯ä»¥é˜²æ­¢è¿™ç§é—®é¢˜ã€‚è°ƒç”¨ä»£ç çœ‹èµ·æ¥åƒæ˜¯è¿™æ ·ï¼š<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">processWidget</span>(std::<span class="built_in">make_shared</span>&lt;Widget&gt;(),   <span class="comment">//æ²¡æœ‰æ½œåœ¨çš„èµ„æºæ³„æ¼</span></span><br><span class="line">    <span class="built_in">computePriority</span>());</span><br></pre></td></tr></table></figure>
åœ¨è¿è¡Œæ—¶ï¼Œ<code>std::make_shared</code>å’Œ<code>computePriority</code>å…¶ä¸­ä¸€ä¸ªä¼šå…ˆè¢«è°ƒç”¨ã€‚å¦‚æœæ˜¯<code>std::make_shared</code>å…ˆè¢«è°ƒç”¨ï¼Œåœ¨<code>computePriority</code>è°ƒç”¨å‰ï¼ŒåŠ¨æ€åˆ†é…<code>Widget</code>çš„åŸå§‹æŒ‡é’ˆä¼šå®‰å…¨çš„ä¿å­˜åœ¨ä½œä¸ºè¿”å›å€¼çš„<code>std::shared_ptr</code>ä¸­ã€‚å¦‚æœ<code>computePriority</code>äº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆ<code>std::shared_ptr</code>ææ„å‡½æ•°å°†ç¡®ä¿ç®¡ç†çš„<code>Widget</code>è¢«é”€æ¯ã€‚å¦‚æœé¦–å…ˆè°ƒç”¨<code>computePriority</code>å¹¶äº§ç”Ÿä¸€ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆ<code>std::make_shared</code>å°†ä¸ä¼šè¢«è°ƒç”¨ï¼Œå› æ­¤ä¹Ÿå°±ä¸éœ€è¦æ‹…å¿ƒåŠ¨æ€åˆ†é…<code>Widget</code>ï¼ˆä¼šæ³„æ¼ï¼‰ã€‚<br>å½“ç„¶é™¤äº†ä½¿ç”¨<code>std::make_shared&lt;Widget&gt;()</code>ï¼Œè¿˜æœ‰å…¶ä»–è§£æ³•æ¯”å¦‚ï¼š<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;Widget&gt; <span class="title">spw</span><span class="params">(<span class="keyword">new</span> Widget)</span></span>;</span><br><span class="line"><span class="built_in">processWidget</span>(spw, <span class="built_in">computePriority</span>());  <span class="comment">// æ­£ç¡®ï¼Œä½†æ˜¯æ²¡ä¼˜åŒ–ï¼Œè§ä¸‹</span></span><br></pre></td></tr></table></figure>
ä½†æ˜¯èƒ½å¤Ÿä¸€è¡Œä»£ç è§£é‡Šæ¸…æ¥šæœ€å¥½è¿˜æ˜¯ä½¿ç”¨ä¸€è¡Œä»£ç ï¼Œæ‰€ä»¥è¿˜æ˜¯å»ºè®®ä½¿ç”¨<code>make_shared</code></li>
</ol>
<h3 id="make-sharedä¸é€‚ç”¨åœºæ™¯"><a href="#make-sharedä¸é€‚ç”¨åœºæ™¯" class="headerlink" title="make_sharedä¸é€‚ç”¨åœºæ™¯"></a>make_sharedä¸é€‚ç”¨åœºæ™¯</h3><ol>
<li>éœ€è¦è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚makeå‡½æ•°ä¸èƒ½è‡ªå®šä¹‰åˆ é™¤å™¨</li>
<li>éœ€è¦ç²¾ç¡®ç²¾ç¡®çš„åˆ†é…ã€é‡Šæ”¾å¯¹è±¡å¤§å°çš„å†…å­˜ï¼ˆé‡è½½äº†<code>operator new</code>å’Œ<code>operator delete</code>ï¼‰çš„ç±»ï¼Œå› ä¸ºmake_sharedï¼Œå› ä¸ºmake_sharedä½¿ç”¨std::allocate_sharedè¿›è¡Œå†…å­˜åˆ†é…ï¼Œ<code>std::allocate_shared</code>éœ€è¦çš„å†…å­˜æ€»å¤§å°ä¸ç­‰äºåŠ¨æ€åˆ†é…çš„å¯¹è±¡å¤§å°ï¼Œè¿˜éœ€è¦å†åŠ ä¸Šæ§åˆ¶å—å¤§å°</li>
<li>å¯¹äºå¤§å¯¹è±¡æ¥è¯´ï¼Œ<code>std::weak_ptr</code>sæ¯”å¯¹åº”çš„<code>std::shared_ptr</code>sæ´»å¾—æ›´ä¹…çš„æƒ…å†µä¹Ÿä¸å»ºè®®ä½¿ç”¨make_sharedã€‚å› ä¸ºmake_sharedç”³è¯·çš„å†…å­˜æ˜¯åŒ…æ‹¬èµ„æºå’Œå†…å­˜å—çš„å†…å®¹ï¼Œåªæœ‰æœ€åä¸€ä¸ª<code>std::shared_ptr</code>å’Œæœ€åä¸€ä¸ªæŒ‡å‘å®ƒçš„<code>std::weak_ptr</code>å·²è¢«é”€æ¯ï¼Œæ•´å—å†…å­˜æ‰ä¼šé‡Šæ”¾ã€‚è€Œæ™®é€šçš„æ–¹å¼åˆ›å»ºçš„<code>shared_ptr</code>ï¼Œæœ€åä¸€ä¸ª<code>shared_ptr</code>è¢«é”€æ¯å°±å°†å¯¹è±¡çš„å†…å­˜é”€æ¯äº†ï¼Œæ§åˆ¶å—çš„è¿˜ä¿ç•™</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReallyBigType</span> &#123; â€¦ &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> pBigObj =                          <span class="comment">//é€šè¿‡std::make_shared</span></span><br><span class="line">    std::<span class="built_in">make_shared</span>&lt;ReallyBigType&gt;();  <span class="comment">//åˆ›å»ºä¸€ä¸ªå¤§å¯¹è±¡</span></span><br><span class="line">                    </span><br><span class="line">â€¦           <span class="comment">//åˆ›å»ºstd::shared_ptrså’Œstd::weak_ptrs</span></span><br><span class="line">            <span class="comment">//æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨å®ƒä»¬</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//æœ€åä¸€ä¸ªstd::shared_ptråœ¨è¿™é”€æ¯ï¼Œ</span></span><br><span class="line">            <span class="comment">//ä½†std::weak_ptrsè¿˜åœ¨</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒåŸæ¥åˆ†é…ç»™å¤§å¯¹è±¡çš„å†…å­˜è¿˜åˆ†é…ç€</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//æœ€åä¸€ä¸ªstd::weak_ptråœ¨è¿™é‡Œé”€æ¯ï¼›</span></span><br><span class="line">            <span class="comment">//æ§åˆ¶å—å’Œå¯¹è±¡çš„å†…å­˜è¢«é‡Šæ”¾</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ReallyBigType</span> &#123; â€¦ &#125;;              <span class="comment">//å’Œä¹‹å‰ä¸€æ ·</span></span><br><span class="line"></span><br><span class="line"><span class="function">std::shared_ptr&lt;ReallyBigType&gt; <span class="title">pBigObj</span><span class="params">(<span class="keyword">new</span> ReallyBigType)</span></span>;</span><br><span class="line">                                        <span class="comment">//é€šè¿‡newåˆ›å»ºå¤§å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//åƒä¹‹å‰ä¸€æ ·ï¼Œåˆ›å»ºstd::shared_ptrså’Œstd::weak_ptrs</span></span><br><span class="line">            <span class="comment">//æŒ‡å‘è¿™ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨å®ƒä»¬</span></span><br><span class="line">            </span><br><span class="line">â€¦           <span class="comment">//æœ€åä¸€ä¸ªstd::shared_ptråœ¨è¿™é”€æ¯,</span></span><br><span class="line">            <span class="comment">//ä½†std::weak_ptrsè¿˜åœ¨ï¼›</span></span><br><span class="line">            <span class="comment">//å¯¹è±¡çš„å†…å­˜è¢«é‡Šæ”¾</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//åœ¨è¿™é˜¶æ®µï¼Œåªæœ‰æ§åˆ¶å—çš„å†…å­˜ä»ç„¶ä¿æŒåˆ†é…</span></span><br><span class="line"></span><br><span class="line">â€¦           <span class="comment">//æœ€åä¸€ä¸ªstd::weak_ptråœ¨è¿™é‡Œé”€æ¯ï¼›</span></span><br><span class="line">            <span class="comment">//æ§åˆ¶å—å†…å­˜è¢«é‡Šæ”¾</span></span><br></pre></td></tr></table></figure>
<h2 id="enable-share-from-this"><a href="#enable-share-from-this" class="headerlink" title="enable_share_from_this"></a>enable_share_from_this</h2><p>å®é™…å¼€å‘ä¸­ï¼Œæœ‰æ—¶å€™éœ€è¦åœ¨ç±»ä¸­è¿”å›åŒ…è£¹å½“å‰å¯¹è±¡ï¼ˆthisï¼‰çš„ä¸€ä¸ª<strong>std::shared_ptr</strong>å¯¹è±¡ç»™å¤–éƒ¨ä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦enable_shared_from_thisã€‚</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyClass</span> : <span class="keyword">public</span> std::enable_shared_from_this&lt;MyClass&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">std::shared_ptr&lt;MyClass&gt; <span class="title">getShared</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">shared_from_this</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">printMessage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Hello, this is MyClass!&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªstd::shared_ptræŒ‡å‘MyClasså¯¹è±¡</span></span><br><span class="line">    std::shared_ptr&lt;MyClass&gt; ptr = std::<span class="built_in">make_shared</span>&lt;MyClass&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è°ƒç”¨getShared()å‡½æ•°è·å–æŒ‡å‘å½“å‰å¯¹è±¡çš„std::shared_ptr</span></span><br><span class="line">    std::shared_ptr&lt;MyClass&gt; ptr2 = ptr-&gt;<span class="built_in">getShared</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨ptr2è°ƒç”¨å¯¹è±¡çš„æˆå‘˜å‡½æ•°</span></span><br><span class="line">    ptr2-&gt;<span class="built_in">printMessage</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æºç åˆ†æï¼š</p>
<p><code>enable_shared_from_this</code>ä¸­æœ‰ä¸€ä¸ª<code>_Wptr</code>ï¼Œå°†<code>_Wptr</code>å’Œ<code>this</code>å¯¹åº”çš„<code>share_ptr</code>è¿›è¡Œå…³è”ï¼Œä»è€Œåç»­é€šè¿‡<code>shared_from_this</code>ä»æ­¤<code>_Wptr</code>å¾—åˆ°<code>share_ptr</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Ty</span>&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">enable_shared_from_this</span> &#123; <span class="comment">// provide member functions that create shared_ptr to this</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// åœ¨_Can_enable_sharedä¸­ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">using</span> _Esft_type = enable_shared_from_this;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD shared_ptr&lt;_Ty&gt; <span class="title">shared_from_this</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;_Ty&gt;(_Wptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD shared_ptr&lt;<span class="type">const</span> _Ty&gt; <span class="title">shared_from_this</span><span class="params">()</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">shared_ptr</span>&lt;<span class="type">const</span> _Ty&gt;(_Wptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD weak_ptr&lt;_Ty&gt; <span class="title">weak_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Wptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">_NODISCARD weak_ptr&lt;<span class="type">const</span> _Ty&gt; <span class="title">weak_from_this</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _Wptr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="title">enable_shared_from_this</span><span class="params">()</span> <span class="keyword">noexcept</span> : _Wptr() &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">enable_shared_from_this</span>(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span> : _Wptr() &#123;</span><br><span class="line">        <span class="comment">// construct (must value-initialize _Wptr)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    enable_shared_from_this&amp; <span class="keyword">operator</span>=(<span class="type">const</span> enable_shared_from_this&amp;) <span class="keyword">noexcept</span> &#123; <span class="comment">// assign (must not change _Wptr)</span></span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ~<span class="built_in">enable_shared_from_this</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Yty</span>&gt;</span><br><span class="line">    <span class="keyword">friend</span> <span class="keyword">class</span> <span class="title class_">shared_ptr</span>;</span><br><span class="line">    <span class="comment">// å¼±æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">mutable</span> weak_ptr&lt;_Ty&gt; _Wptr;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆè¿™ä¸ªæ˜¯ä»€ä¹ˆæ—¶å€™å°†<code>_Wptr</code>å’Œ<code>share_ptr</code> å…³è”çš„å‘¢ï¼Ÿæ˜¯é€šè¿‡<code>_Set_ptr_rep_and_enable_shared</code>å‡½æ•°</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">shared_ptr</span><span class="params">(_Ux* _Px)</span> </span>&#123; <span class="comment">// construct shared_ptr object that owns _Px</span></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(is_array_v&lt;_Ty&gt;)</span> </span>&#123;</span><br><span class="line">            _Setpd(_Px, default_delete&lt;_Ux[]&gt;&#123;&#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            _Temporary_owner&lt;_Ux&gt; _Owner(_Px);</span><br><span class="line">            <span class="comment">// æ­¤å‡½æ•°å’Œenable_share_from_thisç›¸å…³</span></span><br><span class="line">            _Set_ptr_rep_and_enable_shared(_Owner._Ptr, <span class="keyword">new</span> _Ref_count&lt;_Ux&gt;(_Owner._Ptr));</span><br><span class="line">            _Owner._Ptr = <span class="literal">nullptr</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p><code>_Set_ptr_rep_and_enable_shared</code>å‡½æ•°ä¸­ä¼šè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯<code>_Can_enable_shared</code>å°±ä¼šå…³è”</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> _Set_ptr_rep_and_enable_shared(_Ux* <span class="type">const</span> _Px, _Ref_count_base* <span class="type">const</span> _Rx) <span class="keyword">noexcept</span> &#123; <span class="comment">// take ownership of _Px</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;_Ptr = _Px;</span><br><span class="line">        <span class="keyword">this</span>-&gt;_Rep = _Rx;</span><br><span class="line">    <span class="comment">//åœ¨è¿™ä¸ªå‡½æ•°ä¸­</span></span><br><span class="line">        <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(conjunction_v&lt;negation&lt;is_array&lt;_Ty&gt;&gt;, negation&lt;is_volatile&lt;_Ux&gt;&gt;, _Can_enable_shared&lt;_Ux&gt;&gt;)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (_Px &amp;&amp; _Px-&gt;_Wptr.<span class="built_in">expired</span>()) &#123;</span><br><span class="line">                <span class="comment">//å°†_Wptrå’Œshared_ptrå…³è”</span></span><br><span class="line">                _Px-&gt;_Wptr = shared_ptr&lt;<span class="type">remove_cv_t</span>&lt;_Ux&gt;&gt;(*<span class="keyword">this</span>, <span class="keyword">const_cast</span>&lt;<span class="type">remove_cv_t</span>&lt;_Ux&gt;*&gt;(_Px));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>_Can_enable_shared</code>çš„å®ç°ä½¿ç”¨äº†<code>SFINAE</code></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Yty</span>, <span class="keyword">class</span> = <span class="type">void</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> _Can_enable_shared : false_type &#123;&#125;; <span class="comment">// detect unambiguous and accessible inheritance from enable_shared_from_this</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Yty</span>&gt;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_Can_enable_shared</span>&lt;_Yty, <span class="type">void_t</span>&lt;<span class="keyword">typename</span> _Yty::_Esft_type&gt;&gt;</span><br><span class="line">    : is_convertible&lt;<span class="type">remove_cv_t</span>&lt;_Yty&gt;*, <span class="keyword">typename</span> _Yty::_Esft_type*&gt;::type &#123;</span><br><span class="line">    <span class="comment">// is_convertible is necessary to verify unambiguous inheritance</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h2><p>å…ˆè¯´ç»“è®º<strong>æ™ºèƒ½æŒ‡é’ˆ</strong>çº¿ç¨‹ä¸å®‰å…¨ã€‚</p>
<p><code>share_ptr</code>æœ‰ä¸¤éƒ¨åˆ†æŒ‡å‘èµ„æºçš„æŒ‡é’ˆ å’ŒæŒ‡å‘æ§åˆ¶å—çš„æŒ‡é’ˆï¼Œå…¶ä¸­æ§åˆ¶å—éƒ¨åˆ†ä¸­<strong>å¼•ç”¨è®¡æ•°</strong>æ˜¯åŸå­çš„æ“ä½œå¯ä»¥è¯´å®ƒæ˜¯å®‰å…¨çš„ï¼Œå…¶ä»–éƒ¨åˆ†éƒ½æ²¡æœ‰ä¿éšœï¼Œæ¯”å¦‚æŒ‡é’ˆçš„æŒ‡å‘ã€‚</p>
<p>æ‰€ä»¥æ™ºèƒ½æŒ‡é’ˆæ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/share_ptrç¤ºæ„.png" alt=""></p>
<p>æƒ³è¦å¯¹æ™ºèƒ½æŒ‡é’ˆå®‰å…¨æ“ä½œå¯ä»¥å‚è€ƒmuduoä»£ç ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ™ºèƒ½æŒ‡é’ˆå¤šçº¿ç¨‹1.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/cpp/æ™ºèƒ½æŒ‡é’ˆå¤šçº¿ç¨‹2.png" alt=""></p>
<h2 id="æ™ºèƒ½æŒ‡é’ˆè‡ªå·±çš„å®ç°"><a href="#æ™ºèƒ½æŒ‡é’ˆè‡ªå·±çš„å®ç°" class="headerlink" title="æ™ºèƒ½æŒ‡é’ˆè‡ªå·±çš„å®ç°"></a>æ™ºèƒ½æŒ‡é’ˆè‡ªå·±çš„å®ç°</h2><h3 id="unique-ptrå®ç°"><a href="#unique-ptrå®ç°" class="headerlink" title="unique_ptrå®ç°"></a>unique_ptrå®ç°</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">KSmartPointUni</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">KSmartPointUni</span>();</span><br><span class="line">	<span class="built_in">KSmartPointUni</span>(T* ptr);</span><br><span class="line">	~<span class="built_in">KSmartPointUni</span>();</span><br><span class="line">	<span class="built_in">KSmartPointUni</span>(KSmartPointUni&amp;&amp; ptr);</span><br><span class="line">	KSmartPointUni&amp; <span class="keyword">operator</span>=(KSmartPointUni&amp;&amp; ptr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">KSmartPointUni</span>(<span class="type">const</span> KSmartPointUni&amp; ptr) = <span class="keyword">delete</span>; <span class="comment">// ä¸å…è®¸æ‹·è´</span></span><br><span class="line">	KSmartPointUni&amp; <span class="keyword">operator</span>=(<span class="type">const</span> KSmartPointUni&amp; ptr) = <span class="keyword">delete</span>;</span><br><span class="line">	T&amp; <span class="keyword">operator</span>*() <span class="type">const</span>; <span class="comment">// è¿”å›*m_ptrå¯¹è±¡</span></span><br><span class="line">	T* <span class="keyword">operator</span>-&gt;() <span class="type">const</span>; <span class="comment">// è¿”å›m_ptrå¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	T* m_ptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> KSmartPointUni&lt;T&gt;::<span class="built_in">KSmartPointUni</span>() :<span class="built_in">m_ptr</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> KSmartPointUni&lt;T&gt;::<span class="built_in">KSmartPointUni</span>(T* ptr) : <span class="built_in">m_ptr</span>(ptr)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> KSmartPointUni&lt;T&gt;::~<span class="built_in">KSmartPointUni</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (m_ptr != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		<span class="keyword">delete</span> m_ptr;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> KSmartPointUni&lt;T&gt;::<span class="built_in">KSmartPointUni</span>(KSmartPointUni&lt;T&gt;&amp;&amp; ptr)</span><br><span class="line">&#123;</span><br><span class="line">	m_ptr = ptr.m_ptr;</span><br><span class="line">	ptr.m_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> KSmartPointUni&lt;T&gt;&amp; KSmartPointUni&lt;T&gt;::<span class="keyword">operator</span>=(KSmartPointUni&amp;&amp; ptr)</span><br><span class="line">&#123;</span><br><span class="line">	m_ptr = ptr.m_ptr;</span><br><span class="line">	ptr.m_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> T&amp; KSmartPointUni&lt;T&gt;::<span class="keyword">operator</span>*() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> *m_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> T* KSmartPointUni&lt;T&gt;::<span class="keyword">operator</span>-&gt;() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> m_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="share-ptrçš„å®ç°"><a href="#share-ptrçš„å®ç°" class="headerlink" title="share_ptrçš„å®ç°"></a>share_ptrçš„å®ç°</h3><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MySharedPtr</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">MySharedPtr</span>(T* ptr = <span class="literal">nullptr</span>); <span class="comment">//æ„é€ </span></span><br><span class="line">	~<span class="built_in">MySharedPtr</span>(); <span class="comment">// ææ„</span></span><br><span class="line">	<span class="built_in">MySharedPtr</span>(<span class="type">const</span> MySharedPtr&lt;T&gt;&amp; sp);</span><br><span class="line">	MySharedPtr&lt;T&gt;&amp; <span class="keyword">operator</span>=(<span class="type">const</span> MySharedPtr&lt;T&gt;&amp; sp);</span><br><span class="line">	T&amp; <span class="keyword">operator</span>*(); <span class="comment">// è¿”å›*m_ptrå¯¹è±¡</span></span><br><span class="line">	T* <span class="keyword">operator</span>-&gt;(); <span class="comment">// è¿”å›m_ptrå¯¹è±¡</span></span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">useCount</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">T* <span class="title">get</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// é‡‡å–å¼•ç”¨è®¡æ•°</span></span><br><span class="line">	T* m_ptr;</span><br><span class="line">    <span class="comment">// æ§åˆ¶å—</span></span><br><span class="line">	<span class="type">int</span>* m_count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> MySharedPtr&lt;T&gt;::<span class="built_in">MySharedPtr</span>(T* ptr) :<span class="built_in">m_ptr</span>(ptr)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (ptr == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">		m_count = <span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		m_count = <span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> MySharedPtr&lt;T&gt;::~<span class="built_in">MySharedPtr</span>()</span><br><span class="line">&#123;</span><br><span class="line">	(*m_count)--;</span><br><span class="line">	<span class="keyword">if</span> ((*m_count) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_count)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_ptr;</span><br><span class="line">			m_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_count)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_count;</span><br><span class="line">			m_count = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> MySharedPtr&lt;T&gt;::<span class="built_in">MySharedPtr</span>(<span class="type">const</span> MySharedPtr&lt;T&gt;&amp; sp)</span><br><span class="line">&#123;</span><br><span class="line">	m_ptr = sp.m_ptr;</span><br><span class="line">	m_count = sp.m_count;</span><br><span class="line">	(*m_count)++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> MySharedPtr&lt;T&gt;&amp; MySharedPtr&lt;T&gt;::<span class="keyword">operator</span>=(<span class="type">const</span> MySharedPtr&lt;T&gt;&amp; sp)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span> == &amp;sp) <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">	(*m_count)--;</span><br><span class="line">	<span class="keyword">if</span> ((*m_count) == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (m_ptr)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_ptr;</span><br><span class="line">			m_ptr = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (m_count)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">delete</span> m_count;</span><br><span class="line">			m_count = <span class="literal">nullptr</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	m_ptr = sp.m_ptr;</span><br><span class="line">	m_count = sp.m_count;</span><br><span class="line">	(*m_count)++;</span><br><span class="line">	<span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> T&amp; MySharedPtr&lt;T&gt;::<span class="keyword">operator</span>*()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> *m_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> T* MySharedPtr&lt;T&gt;::<span class="keyword">operator</span>-&gt;()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> m_ptr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> MySharedPtr&lt;T&gt;::<span class="built_in">useCount</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> *m_count;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="keyword">inline</span> T* MySharedPtr&lt;T&gt;::<span class="built_in">get</span>() <span class="type">const</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> m_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>C++</category>
      </categories>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬3ç« ç»ƒä¹ é¢˜</title>
    <url>/2022/10/25/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%AC%AC3%E7%AB%A0%E7%BB%83%E4%B9%A0%E9%A2%98/</url>
    <content><![CDATA[<h1 id="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬3ç« ç»ƒä¹ é¢˜"><a href="#æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬3ç« ç»ƒä¹ é¢˜" class="headerlink" title="æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬3ç« ç»ƒä¹ é¢˜"></a>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬3ç« ç»ƒä¹ é¢˜</h1><h2 id="ç»ƒä¹ é¢˜3-1å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾åœ¨æŒ‡æ˜çš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­"><a href="#ç»ƒä¹ é¢˜3-1å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾åœ¨æŒ‡æ˜çš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­" class="headerlink" title="ç»ƒä¹ é¢˜3.1å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾åœ¨æŒ‡æ˜çš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­:"></a>ç»ƒä¹ é¢˜3.1å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾åœ¨æŒ‡æ˜çš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­:</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221025203611818.png" alt="image-20221025203611818"></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ“ä½œæ•°</th>
<th style="text-align:center">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">%rax</td>
<td style="text-align:center">0x100</td>
</tr>
<tr>
<td style="text-align:center">0x104</td>
<td style="text-align:center">0xAB</td>
</tr>
<tr>
<td style="text-align:center">$0x108</td>
<td style="text-align:center">0x108</td>
</tr>
<tr>
<td style="text-align:center">(%rax)</td>
<td style="text-align:center">0xFF</td>
</tr>
<tr>
<td style="text-align:center">4(%rax)</td>
<td style="text-align:center">0xAB</td>
</tr>
<tr>
<td style="text-align:center">9(%rax,%rdx)</td>
<td style="text-align:center">0x11</td>
</tr>
<tr>
<td style="text-align:center">260(%rcx,%rdx)</td>
<td style="text-align:center">0x13</td>
</tr>
<tr>
<td style="text-align:center">0xFC(,%rcx,4)</td>
<td style="text-align:center">0xFF</td>
</tr>
<tr>
<td style="text-align:center">(%rax,%rdx,4)</td>
<td style="text-align:center">0x11</td>
</tr>
</tbody>
</table>
</div>
<span id="more"></span>
<h2 id="ç»ƒä¹ é¢˜3-2å¯¹äºä¸‹é¢æ±‡ç¼–ä»£ç çš„æ¯ä¸€è¡Œï¼Œæ ¹æ®æ“ä½œæ•°ï¼Œç¡®å®šé€‚å½“çš„æŒ‡ä»¤åç¼€ã€‚-ä¾‹å¦‚ï¼Œmov-å¯ä»¥è¢«é‡å†™æˆmovbã€movwã€movlæˆ–è€…movqã€‚ï¼‰"><a href="#ç»ƒä¹ é¢˜3-2å¯¹äºä¸‹é¢æ±‡ç¼–ä»£ç çš„æ¯ä¸€è¡Œï¼Œæ ¹æ®æ“ä½œæ•°ï¼Œç¡®å®šé€‚å½“çš„æŒ‡ä»¤åç¼€ã€‚-ä¾‹å¦‚ï¼Œmov-å¯ä»¥è¢«é‡å†™æˆmovbã€movwã€movlæˆ–è€…movqã€‚ï¼‰" class="headerlink" title="ç»ƒä¹ é¢˜3.2å¯¹äºä¸‹é¢æ±‡ç¼–ä»£ç çš„æ¯ä¸€è¡Œï¼Œæ ¹æ®æ“ä½œæ•°ï¼Œç¡®å®šé€‚å½“çš„æŒ‡ä»¤åç¼€ã€‚(ä¾‹å¦‚ï¼Œmov å¯ä»¥è¢«é‡å†™æˆmovbã€movwã€movlæˆ–è€…movqã€‚ï¼‰"></a>ç»ƒä¹ é¢˜3.2å¯¹äºä¸‹é¢æ±‡ç¼–ä»£ç çš„æ¯ä¸€è¡Œï¼Œæ ¹æ®æ“ä½œæ•°ï¼Œç¡®å®šé€‚å½“çš„æŒ‡ä»¤åç¼€ã€‚(ä¾‹å¦‚ï¼Œmov å¯ä»¥è¢«é‡å†™æˆmovbã€movwã€movlæˆ–è€…movqã€‚ï¼‰</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221025222250940.png" alt="image-20221025222250940"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">movl %eax, (%rsp)		;%eaxæ˜¯2ä¸ªå­—çš„ï¼Œä¼ è¾“2å­—ï¼Œæ‰€ä»¥æ˜¯movl</span><br><span class="line">movw (%rax), %dx		;%dxæ˜¯1ä¸ªå­—çš„ï¼Œä¼ è¾“1å­—ï¼Œæ‰€ä»¥æ˜¯movw</span><br><span class="line">movb $0xFF, %b1			;%b1æ˜¯1ä¸ªå­—èŠ‚çš„ï¼Œä¼ è¾“1å­—ï¼Œæ‰€ä»¥æ˜¯movb</span><br><span class="line">movb (%rsp,%rdx,4), %dl ;%dlæ˜¯1ä¸ªå­—çš„ï¼Œä¼ è¾“1å­—ï¼Œæ‰€ä»¥æ˜¯movb</span><br><span class="line">movq (%rdx), %rax		;%raxæ˜¯4ä¸ªå­—çš„ï¼Œä¼ è¾“1å­—ï¼Œæ‰€ä»¥æ˜¯movq</span><br><span class="line">movbw %dx, (%rax)		;%dxæ˜¯1ä¸ªå­—çš„ï¼Œä¼ è¾“1å­—ï¼Œæ‰€ä»¥æ˜¯movw</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜3-3å½“æˆ‘ä»¬è°ƒç”¨æ±‡ç¼–å™¨çš„æ—¶å€™ï¼Œä¸‹é¢ä»£ç çš„æ¯ä¸€è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚è§£é‡Šæ¯ä¸€è¡Œéƒ½æ˜¯å“ªé‡Œå‡ºäº†é”™ã€‚"><a href="#ç»ƒä¹ é¢˜3-3å½“æˆ‘ä»¬è°ƒç”¨æ±‡ç¼–å™¨çš„æ—¶å€™ï¼Œä¸‹é¢ä»£ç çš„æ¯ä¸€è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚è§£é‡Šæ¯ä¸€è¡Œéƒ½æ˜¯å“ªé‡Œå‡ºäº†é”™ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜3.3å½“æˆ‘ä»¬è°ƒç”¨æ±‡ç¼–å™¨çš„æ—¶å€™ï¼Œä¸‹é¢ä»£ç çš„æ¯ä¸€è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚è§£é‡Šæ¯ä¸€è¡Œéƒ½æ˜¯å“ªé‡Œå‡ºäº†é”™ã€‚"></a>ç»ƒä¹ é¢˜3.3å½“æˆ‘ä»¬è°ƒç”¨æ±‡ç¼–å™¨çš„æ—¶å€™ï¼Œä¸‹é¢ä»£ç çš„æ¯ä¸€è¡Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯æ¶ˆæ¯ã€‚è§£é‡Šæ¯ä¸€è¡Œéƒ½æ˜¯å“ªé‡Œå‡ºäº†é”™ã€‚</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221026110728710.png" alt="image-20221026110728710"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">movb $0xF, (%ebx) 		;å†…å­˜å¼•ç”¨çš„å¯„å­˜å™¨å¿…é¡»æ˜¯å››ä¸ªå­—çš„ï¼Œæ”¹æˆmovb $0xF, (%rbx)</span><br><span class="line">movl %rax, (%rsp) 		;%raxæ˜¯å››ä¸ªå­—è€Œlä»£è¡¨ä¸¤ä¸ªå­—ï¼Œæ”¹æˆmovl %eax, (%rsp) æˆ–è€… movq %rax, (%rsp)</span><br><span class="line">movw (%rax), 4(%rsp)	;ä¸¤ä¸ªæ“ä½œæ•°ä¸èƒ½éƒ½æ˜¯å†…å­˜å¼•ç”¨</span><br><span class="line">movb %al, %sl			;æ²¡æœ‰å¯„å­˜å™¨åå­—å«%sl</span><br><span class="line">movq %rax,$0x123		;ç«‹å³æ•°ä¸èƒ½ä½œä¸ºdesæ“ä½œæ•°</span><br><span class="line">movl %eax, %rdx			;ç­”æ¡ˆä¸Šè¯´ç›®æ ‡æ“ä½œæ•°å¤§å°ä¸æ­£ç¡®ï¼ˆdestination operand incorrect sizeï¼‰ï¼Œè¿™ä¸ªæœ‰ç‚¹ä¸å¤ªç†è§£</span><br><span class="line">movb %si, 8(%rbp)		;%siæ˜¯ä¸€ä¸ªå­—è€Œbä»£è¡¨ä¸€ä¸ªå­—èŠ‚ï¼Œæ”¹æˆmovb %sil, 8(%rbp) æˆ–è€… movw %si, 8(%rbp)</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜3-4å‡è®¾å˜é‡spå’Œdpè¢«å£°æ˜ä¸ºç±»å‹"><a href="#ç»ƒä¹ é¢˜3-4å‡è®¾å˜é‡spå’Œdpè¢«å£°æ˜ä¸ºç±»å‹" class="headerlink" title="ç»ƒä¹ é¢˜3.4å‡è®¾å˜é‡spå’Œdpè¢«å£°æ˜ä¸ºç±»å‹"></a>ç»ƒä¹ é¢˜3.4å‡è®¾å˜é‡spå’Œdpè¢«å£°æ˜ä¸ºç±»å‹</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">src_t</span> *sp;</span><br><span class="line"><span class="type">dest_t</span> *dp;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œsrc_tå’Œdest_tæ˜¯ç”¨typedefå£°æ˜çš„æ•°æ®ç±»å‹ã€‚æˆ‘ä»¬æƒ³ä½¿ç”¨é€‚å½“çš„æ•°æ®ä¼ é€æŒ‡ä»¤æ¥å®ç°ä¸‹é¢çš„æ“ä½œ;</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">*dp = (<span class="type">dest_t</span>) *sp;</span><br></pre></td></tr></table></figure>
<p>å‡è®¾ sp å’Œ dp çš„å€¼åˆ†åˆ«å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdi å’Œ %rsi ä¸­ã€‚å¯¹äºè¡¨ä¸­çš„æ¯ä¸ªè¡¨é¡¹ï¼Œç»™å‡ºå®ç°æŒ‡å®šæ•°æ®ä¼ é€çš„ä¸¤æ¡æŒ‡ä»¤ã€‚å…¶ä¸­ç¬¬ä¸€æ¡æŒ‡ä»¤åº”è¯¥ä»å†…å­˜ä¸­è¯»æ•°ï¼Œåšé€‚å½“çš„è½¬æ¢ï¼Œå¹¶è®¾ç½®å¯„å­˜å™¨ %rax çš„é€‚å½“éƒ¨åˆ†ã€‚ç„¶åï¼Œç¬¬äºŒæ¡æŒ‡ä»¤è¦æŠŠ %rax çš„é€‚å½“éƒ¨åˆ†å†™åˆ°å†…å­˜ã€‚åœ¨è¿™ä¸¤ç§æƒ…å†µä¸­ï¼Œå¯„å­˜å™¨çš„éƒ¨åˆ†å¯ä»¥æ˜¯ %raxã€%eaxã€%ax æˆ– %alï¼Œä¸¤è€…å¯ä»¥äº’ä¸ç›¸åŒã€‚</p>
<p>è®°ä½ï¼Œå½“æ‰§è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢æ—¢æ¶‰åŠå¤§å°å˜åŒ–åˆæ¶‰åŠ C è¯­è¨€ä¸­ç¬¦å·å˜åŒ–æ—¶ï¼Œæ“ä½œåº”è¯¥å…ˆæ”¹å˜å¤§å°ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">src_t</th>
<th style="text-align:center">dest_t</th>
<th style="text-align:left">æŒ‡ä»¤</th>
<th style="text-align:center">è§£é‡Š</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">long</td>
<td style="text-align:center">long</td>
<td style="text-align:left">movq (%rdi), %rax <br/>movq %rax, (%rsi)</td>
<td style="text-align:center">long ä¸º 8 å­—èŠ‚ï¼Œç›®æ ‡å­—èŠ‚æ•°ä¹Ÿä¸º 8ï¼Œæ‰€ä»¥éƒ½ç”¨ movq ã€‚</td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">int</td>
<td style="text-align:left">movsbl (%rdi), %eax<br/> movl %eax, (%rsi)</td>
<td style="text-align:center">å› ä¸ºæºæœ‰ç¬¦å·ï¼Œæ‰€ä»¥ç”¨ movs ã€‚åˆå› ä¸ºæ˜¯ char åˆ° int ï¼Œæ‰€ä»¥ä½¿ç”¨ bl ã€‚</td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">unsigned</td>
<td style="text-align:left">movsbl (%rdi), %eax<br/> movl %eax, (%rsi)</td>
<td style="text-align:center">åŒä¸Šã€‚</td>
</tr>
<tr>
<td style="text-align:center">unsigned char</td>
<td style="text-align:center">long</td>
<td style="text-align:left">movzbl (%rdi), %eax<br/> movq %rax, (%rsi)</td>
<td style="text-align:center">éœ€è¦æŠŠå­—èŠ‚æ‰©å±•æˆå››å­—ï¼Œç”±äºæ˜¯ unsignedï¼Œæ‰€ä»¥ç”¨é›¶æ‰©å±•ã€‚</td>
</tr>
<tr>
<td style="text-align:center">int</td>
<td style="text-align:center">char</td>
<td style="text-align:left">movl (%rdi), %edx<br/> movb %al, (%rsi)</td>
<td style="text-align:center">åŸå§‹å­—èŠ‚è¿˜æ˜¯è¦è¯»å‡ºæ¥çš„ï¼Œä½†æ˜¯åªä¼ é€ä½ä½å­—èŠ‚ï¼Œå³æŒ‰ç›®æ ‡å¤§å°è¿›è¡Œæˆªæ–­ã€‚æºæœ‰æ— ç¬¦å·æ— æ‰€è°“ã€‚</td>
</tr>
<tr>
<td style="text-align:center">unsigned</td>
<td style="text-align:center">unsigned char</td>
<td style="text-align:left">movl (%rdi), %al<br/> movb %al, (%rsi)</td>
<td style="text-align:center">æœ¬è´¨åŒä¸Šã€‚</td>
</tr>
<tr>
<td style="text-align:center">char</td>
<td style="text-align:center">short</td>
<td style="text-align:left">movsbw (%rdi), %ax<br/> movw %ax, (%rsi)</td>
<td style="text-align:center">éœ€è¦è¿›è¡Œç¬¦å·æ‹“å±•ã€‚</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜3-5å·²çŸ¥ä¿¡æ¯å¦‚ä¸‹ã€‚å°†ä¸€ä¸ªåŸå‹ä¸º"><a href="#ç»ƒä¹ é¢˜3-5å·²çŸ¥ä¿¡æ¯å¦‚ä¸‹ã€‚å°†ä¸€ä¸ªåŸå‹ä¸º" class="headerlink" title="ç»ƒä¹ é¢˜3.5å·²çŸ¥ä¿¡æ¯å¦‚ä¸‹ã€‚å°†ä¸€ä¸ªåŸå‹ä¸º"></a>ç»ƒä¹ é¢˜3.5å·²çŸ¥ä¿¡æ¯å¦‚ä¸‹ã€‚å°†ä¸€ä¸ªåŸå‹ä¸º</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">decode1</span><span class="params">(<span class="type">long</span> *p, <span class="type">long</span> *yp, <span class="type">long</span> *zp)</span>;</span><br></pre></td></tr></table></figure>
<p>çš„å‡½æ•°ç¼–è¯‘æˆæ±‡ç¼–ä»£ç ï¼Œå¾—åˆ°å¦‚ä¸‹ä»£ç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  void decode1(1ong *xp, long *yp, long *zp);</span><br><span class="line">  xp in %rdi, yp in %rsi, zp in %rdx</span><br><span class="line">decode1:</span><br><span class="line">  movq  (%rdi), %r8</span><br><span class="line">  movq  (%rsi), %rcx</span><br><span class="line">  movq  (%rdx), %rax</span><br><span class="line">  movq  %r8, (%rsi)</span><br><span class="line">  movq  (%rcx), (%rdx)</span><br><span class="line">  movq  (%rax), (%rdi)</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>
<p>å‚æ•° xpã€yp å’Œ zp åˆ†åˆ«å­˜å‚¨åœ¨å¯¹åº”çš„å¯„å­˜å™¨ %rdiã€%rsi å’Œ %rdx ä¸­ã€‚</p>
<p>è¯·å†™å‡ºç­‰æ•ˆäºä¸Šé¢æ±‡ç¼–ä»£ç çš„ decode1 çš„ C ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">decode1</span><span class="params">(<span class="type">long</span> *p, <span class="type">long</span> *yp, <span class="type">long</span> *zp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">long</span> x = *xp;</span><br><span class="line">	<span class="type">long</span> y = *yp;</span><br><span class="line">	<span class="type">long</span> z = *zp;</span><br><span class="line">	</span><br><span class="line">    *yp = x;</span><br><span class="line">    *zp = y;</span><br><span class="line">    *xp = z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜3-6-å‡è®¾å¯„å­˜å™¨-rax-çš„å€¼ä¸º-xï¼Œ-rcx-çš„å€¼ä¸º-yã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜ä¸‹é¢æ¯æ¡æ±‡ç¼–ä»£ç æŒ‡ä»¤å­˜å‚¨åœ¨å¯„å­˜å™¨-rdx-ä¸­çš„å€¼ï¼š"><a href="#ç»ƒä¹ é¢˜3-6-å‡è®¾å¯„å­˜å™¨-rax-çš„å€¼ä¸º-xï¼Œ-rcx-çš„å€¼ä¸º-yã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜ä¸‹é¢æ¯æ¡æ±‡ç¼–ä»£ç æŒ‡ä»¤å­˜å‚¨åœ¨å¯„å­˜å™¨-rdx-ä¸­çš„å€¼ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜3.6 å‡è®¾å¯„å­˜å™¨ %rax çš„å€¼ä¸º xï¼Œ%rcx çš„å€¼ä¸º yã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜ä¸‹é¢æ¯æ¡æ±‡ç¼–ä»£ç æŒ‡ä»¤å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdx ä¸­çš„å€¼ï¼š"></a>ç»ƒä¹ é¢˜3.6 å‡è®¾å¯„å­˜å™¨ %rax çš„å€¼ä¸º xï¼Œ%rcx çš„å€¼ä¸º yã€‚å¡«å†™ä¸‹è¡¨ï¼ŒæŒ‡æ˜ä¸‹é¢æ¯æ¡æ±‡ç¼–ä»£ç æŒ‡ä»¤å­˜å‚¨åœ¨å¯„å­˜å™¨ %rdx ä¸­çš„å€¼ï¼š</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">è¡¨è¾¾å¼</th>
<th style="text-align:center">ç»“æœ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">leaq 6 (%rax), %rdx</td>
<td style="text-align:center"><code>x + 6</code></td>
</tr>
<tr>
<td style="text-align:center">leaq (%rax, %rcx), %rdx</td>
<td style="text-align:center"><code>x + y</code></td>
</tr>
<tr>
<td style="text-align:center">leaq (%rax, %rcx, 4), %rdx</td>
<td style="text-align:center"><code>x + 4y</code></td>
</tr>
<tr>
<td style="text-align:center">leaq 7 (%rax, %rax, 8), %rdx</td>
<td style="text-align:center"><code>9x + 7</code></td>
</tr>
<tr>
<td style="text-align:center">leaq 0xA (, %rcx, 4), %rdx</td>
<td style="text-align:center"><code>4y + 10</code></td>
</tr>
<tr>
<td style="text-align:center">leaq 9 (%rax, %rcx, 2), %rdx</td>
<td style="text-align:center"><code>x + 2y + 9</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜3-7è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœç•¥äº†è¢«è®¡ç®—çš„è¡¨è¾¾å¼ï¼š"><a href="#ç»ƒä¹ é¢˜3-7è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœç•¥äº†è¢«è®¡ç®—çš„è¡¨è¾¾å¼ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜3.7è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœç•¥äº†è¢«è®¡ç®—çš„è¡¨è¾¾å¼ï¼š"></a>ç»ƒä¹ é¢˜3.7è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬çœç•¥äº†è¢«è®¡ç®—çš„è¡¨è¾¾å¼ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">scale2</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">    <span class="type">long</span> t = ____________________;</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ GCC ç¼–è¯‘å®é™…çš„å‡½æ•°å¾—åˆ°å¦‚ä¸‹çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  long scale2(long x, long y, long z)</span><br><span class="line">  x in %rdi, y in %rsi, z in %rdx</span><br><span class="line">scale2:</span><br><span class="line">  leaq  (%rdi, %rdi, 4), %rax</span><br><span class="line">  leaq  (%rax, %rsi, 2), %rax</span><br><span class="line">  leaq  (%rax, %rdx, 8), %rax</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>
<p>å¡«å†™å‡º C ä»£ç ä¸­ç¼ºå¤±çš„è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> t = <span class="number">5</span>*x + <span class="number">2</span>*y + <span class="number">8</span>*z</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-8-å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾æŒ‡å®šçš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­ï¼š"><a href="#ç»ƒä¹ é¢˜-3-8-å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾æŒ‡å®šçš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.8 å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾æŒ‡å®šçš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­ï¼š"></a>ç»ƒä¹ é¢˜ 3.8 å‡è®¾ä¸‹é¢çš„å€¼å­˜æ”¾æŒ‡å®šçš„å†…å­˜åœ°å€å’Œå¯„å­˜å™¨ä¸­ï¼š</h2><p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221027211920652.png" alt="image-20221027211920652"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221027211934019.png" alt="image-20221027211934019"></p>
<p>å¡«å†™ä¸‹è¡¨ï¼Œç»™å‡ºä¸‹é¢æŒ‡ä»¤çš„æ•ˆæœï¼Œè¯´æ˜å°†è¢«æ›´æ–°çš„å¯„å­˜å™¨æˆ–å†…å­˜ä½ç½®ï¼Œä»¥åŠå¾—åˆ°çš„å€¼ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æŒ‡ä»¤</th>
<th style="text-align:center">ç›®çš„</th>
<th style="text-align:center">å€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">addq %rcx, (%rax)</td>
<td style="text-align:center">0x100</td>
<td style="text-align:center">0xFF + 0x1 = 0x100</td>
</tr>
<tr>
<td style="text-align:center">subq %rdx, 8 (%rax)</td>
<td style="text-align:center">0x108</td>
<td style="text-align:center">0xAB - 0x3 = 0xA8</td>
</tr>
<tr>
<td style="text-align:center">imulq $16, (%rax, %rdx, 8)</td>
<td style="text-align:center">0x100 + 0x3 * 8 = 0x118</td>
<td style="text-align:center">0x11 * 16 = 0x110</td>
</tr>
<tr>
<td style="text-align:center">incq 16 (%rax)</td>
<td style="text-align:center">0x110</td>
<td style="text-align:center">0x14</td>
</tr>
<tr>
<td style="text-align:center">decq %rcx</td>
<td style="text-align:center">%rcx</td>
<td style="text-align:center">0x0</td>
</tr>
<tr>
<td style="text-align:center">subq %rdx, %rax</td>
<td style="text-align:center">%rax</td>
<td style="text-align:center">0x0FD</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-9è®¾æˆ‘ä»¬æƒ³ç”Ÿæˆä»¥ä¸‹-C-å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-9è®¾æˆ‘ä»¬æƒ³ç”Ÿæˆä»¥ä¸‹-C-å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.9è®¾æˆ‘ä»¬æƒ³ç”Ÿæˆä»¥ä¸‹ C å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.9è®¾æˆ‘ä»¬æƒ³ç”Ÿæˆä»¥ä¸‹ C å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">shift_left4_rightn</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    x &lt;&lt;= <span class="number">4</span>;</span><br><span class="line">    x &gt;&gt;= n;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢è¿™æ®µæ±‡ç¼–ä»£ç æ‰§è¡Œå®é™…çš„ç§»ä½ï¼Œå¹¶å°†æœ€åçš„ç»“æœæ”¾åœ¨å¯„å­˜å™¨ %rax ä¸­ã€‚æ­¤å¤„çœç•¥äº†ä¸¤æ¡å…³é”®çš„æŒ‡ä»¤ã€‚å‚æ•° x å’Œ n åˆ†åˆ«å­˜æ”¾åœ¨å¯„å­˜å™¨ %rdi å’Œ %rsi ä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  long shift_left4_rightn(long x, long n)</span><br><span class="line">  x in %rdi, n in %rsi</span><br><span class="line">shift_left4_rightn:</span><br><span class="line">  movq  %rdi, %rax    Get x</span><br><span class="line">  ________________    x &lt;&lt;= 4</span><br><span class="line">  movl  %esi, %ecx    Get n (4 bytes)</span><br><span class="line">  ________________    x &gt;&gt;= n</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å³è¾¹çš„æ³¨é‡Šï¼Œå¡«å‡ºç¼ºå¤±çš„æŒ‡ä»¤ã€‚è¯·ä½¿ç”¨ç®—æœ¯å³ç§»æ“ä½œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">salq  $4, %rax      x &lt;&lt;= 4</span><br><span class="line">sarq  %cl, %rax     x &gt;&gt;= n</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-10-ä¸‹é¢çš„å‡½æ•°æ˜¯å›¾3-11aä¸­å‡½æ•°ä¸€ä¸ªå˜ç§ï¼Œå…¶ä¸­æœ‰äº›è¡¨è¾¾å¼ç”¨ç©ºæ ¼æ›¿ä»£"><a href="#ç»ƒä¹ é¢˜-3-10-ä¸‹é¢çš„å‡½æ•°æ˜¯å›¾3-11aä¸­å‡½æ•°ä¸€ä¸ªå˜ç§ï¼Œå…¶ä¸­æœ‰äº›è¡¨è¾¾å¼ç”¨ç©ºæ ¼æ›¿ä»£" class="headerlink" title="ç»ƒä¹ é¢˜ 3.10 ä¸‹é¢çš„å‡½æ•°æ˜¯å›¾3-11aä¸­å‡½æ•°ä¸€ä¸ªå˜ç§ï¼Œå…¶ä¸­æœ‰äº›è¡¨è¾¾å¼ç”¨ç©ºæ ¼æ›¿ä»£:"></a>ç»ƒä¹ é¢˜ 3.10 ä¸‹é¢çš„å‡½æ•°æ˜¯å›¾3-11aä¸­å‡½æ•°ä¸€ä¸ªå˜ç§ï¼Œå…¶ä¸­æœ‰äº›è¡¨è¾¾å¼ç”¨ç©ºæ ¼æ›¿ä»£:</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">arith2</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> t1 = _____;</span><br><span class="line">    <span class="type">long</span> t2 = _____;</span><br><span class="line">    <span class="type">long</span> t3 = _____;</span><br><span class="line">    <span class="type">long</span> t4 = _____;</span><br><span class="line">    <span class="keyword">return</span> t4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ç°è¿™äº›è¡¨è¾¾å¼çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  long arith2(long x, long y, long z)</span><br><span class="line">  x in %rdi, y in %rsi, z in %rdx</span><br><span class="line">arith2:</span><br><span class="line">  orq   %rsi, %rdi</span><br><span class="line">  sarq  $3, %rdi</span><br><span class="line">  notq  %rdi</span><br><span class="line">  movq  %rdx, %rax</span><br><span class="line">  subq  %rdi, %rax</span><br><span class="line">  ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åŸºäºè¿™äº›æ±‡ç¼–ä»£ç ï¼Œå¡«å†™ C è¯­è¨€ä»£ç ä¸­ç¼ºå¤±çš„éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> t1 = x | y;</span><br><span class="line"><span class="type">long</span> t2 = t1 &gt;&gt; <span class="number">3</span>;</span><br><span class="line"><span class="type">long</span> t3 = ~ t2;</span><br><span class="line"><span class="type">long</span> t4 = z - t3;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-11å¸¸å¸¸å¯ä»¥çœ‹è§ä»¥ä¸‹å½¢å¼çš„æ±‡ç¼–ä»£ç è¡Œï¼š"><a href="#ç»ƒä¹ é¢˜-3-11å¸¸å¸¸å¯ä»¥çœ‹è§ä»¥ä¸‹å½¢å¼çš„æ±‡ç¼–ä»£ç è¡Œï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.11å¸¸å¸¸å¯ä»¥çœ‹è§ä»¥ä¸‹å½¢å¼çš„æ±‡ç¼–ä»£ç è¡Œï¼š"></a>ç»ƒä¹ é¢˜ 3.11å¸¸å¸¸å¯ä»¥çœ‹è§ä»¥ä¸‹å½¢å¼çš„æ±‡ç¼–ä»£ç è¡Œï¼š</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xorq %rdx, %rdx</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨äº§ç”Ÿè¿™æ®µæ±‡ç¼–ä»£ç çš„ C ä»£ç ä¸­ï¼Œå¹¶æ²¡æœ‰å‡ºç° EXCLUSIVE-OR æ“ä½œã€‚</p>
<p>A. è§£é‡Šè¿™æ¡ç‰¹æ®Šçš„ EXCLUSIVE-OR æŒ‡ä»¤çš„æ•ˆæœï¼Œå®ƒå®ç°äº†ä»€ä¹ˆæœ‰ç”¨çš„æ“ä½œã€‚</p>
<p>B. æ›´ç›´æ¥åœ°è¡¨è¾¾è¿™ä¸ªæ“ä½œçš„æ±‡ç¼–ä»£ç æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>C. æ¯”è¾ƒåŒæ ·ä¸€ä¸ªæ“ä½œçš„ä¸¤ç§ä¸åŒå®ç°çš„ç¼–ç å­—èŠ‚é•¿åº¦ã€‚</p>
<blockquote>
<p>A. è¿™ä¸ªæŒ‡ä»¤ç”¨æ¥å°†å¯„å­˜å™¨ %rdx è®¾ç½®ä¸º 0ï¼Œè¿ç”¨äº†å¯¹ä»»æ„ xï¼Œx^x=0 è¿™ä¸€å±æ€§ã€‚å®ƒå¯¹åº”äº C è¯­å¥ x=0 ã€‚</p>
<p>B. å°†å¯„å­˜å™¨ %rdx è®¾ç½®ä¸º 0 çš„æ›´ç›´æ¥çš„æ–¹æ³•æ˜¯ç”¨æŒ‡ä»¤ movq $0, %rdx ã€‚</p>
<p>C. æ±‡ç¼–å’Œåæ±‡ç¼–è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨ xorq çš„ç‰ˆæœ¬åªéœ€è¦ 3 ä¸ªå­—èŠ‚ï¼Œè€Œä½¿ç”¨ movq çš„ç‰ˆæœ¬éœ€è¦ 7 ä¸ªå­—èŠ‚ã€‚å…¶ä»–å°† %rdx è®¾ç½®ä¸º 0 çš„æ–¹æ³•éƒ½ä¾èµ–äºè¿™æ ·ä¸€ä¸ªå±æ€§ï¼Œå³ä»»ä½•æ›´æ–°ä½ä½ 4 å­—èŠ‚çš„æŒ‡ä»¤éƒ½ä¼šæŠŠé«˜ä½å­—èŠ‚è®¾ç½®ä¸º 0 ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ xorl %edx, %edxï¼ˆ2 å­—èŠ‚ï¼‰æˆ– movl $0, %edxï¼ˆ5 å­—èŠ‚ï¼‰ã€‚</p>
</blockquote>
<h2 id="ç»ƒä¹ é¢˜-3-12-è€ƒè™‘å¦‚ä¸‹å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸¤ä¸ªæ— ç¬¦å·-64-ä½æ•°çš„å•†å’Œä½™æ•°ï¼š"><a href="#ç»ƒä¹ é¢˜-3-12-è€ƒè™‘å¦‚ä¸‹å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸¤ä¸ªæ— ç¬¦å·-64-ä½æ•°çš„å•†å’Œä½™æ•°ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.12 è€ƒè™‘å¦‚ä¸‹å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•°çš„å•†å’Œä½™æ•°ï¼š"></a>ç»ƒä¹ é¢˜ 3.12 è€ƒè™‘å¦‚ä¸‹å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•°çš„å•†å’Œä½™æ•°ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">uremdiv</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x, <span class="type">unsigned</span> <span class="type">long</span> y, <span class="type">unsigned</span> <span class="type">long</span> *qp, <span class="type">unsigned</span> <span class="type">long</span> *rp)</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> q = x / y;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> r = x % y;</span><br><span class="line">    *qp = q;</span><br><span class="line">    *rp = r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹æœ‰ç¬¦å·é™¤æ³•çš„æ±‡ç¼–ä»£ç æ¥å®ç°è¿™ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  void uremdiv(unsigned long x, unsigned long y, unsigned long *qp, unsigned long *rp)</span><br><span class="line">  x in %rdi, y in %rsi, qp in %rdx, rp in %rcx</span><br><span class="line">uremdiv:</span><br><span class="line">  movq  %rdx, %r8      Copy qp</span><br><span class="line">  movq  %rdi, %rax     Move x to lower 8 bytes of dividend</span><br><span class="line">  movl  $0, %edx       Set upper 8 bytes of divended to 0</span><br><span class="line">  divq  %rsi           Divide by y</span><br><span class="line">  movq  %rax, (%r8)    Store quotient at qp</span><br><span class="line">  movq  %rdx, (%rcx)   Store remainder at rp</span><br><span class="line">  ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-13-è™‘ä¸‹åˆ—çš„-C-è¯­è¨€ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-13-è™‘ä¸‹åˆ—çš„-C-è¯­è¨€ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.13 è™‘ä¸‹åˆ—çš„ C è¯­è¨€ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.13 è™‘ä¸‹åˆ—çš„ C è¯­è¨€ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">comp</span><span class="params">(<span class="type">data_t</span> a, <span class="type">data_t</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a COMP b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒç»™å‡ºäº†å‚æ•° a å’Œ b ä¹‹é—´æ¯”è¾ƒçš„ä¸€èˆ¬å½¢å¼ï¼Œè¿™é‡Œï¼Œå‚æ•°çš„æ•°æ®ç±»å‹ <code>data_t</code>ï¼ˆé€šè¿‡ <code>typedef</code>ï¼‰è¢«å£°æ˜ä¸ºè¡¨ 3-1 ä¸­åˆ—å‡ºçš„æŸç§æ•´æ•°ç±»å‹ï¼Œå¯ä»¥æ˜¯æœ‰ç¬¦å·çš„ä¹Ÿå¯ä»¥æ˜¯æ— ç¬¦å·çš„ã€‚ COMP é€šè¿‡ <code>#define</code> æ¥å®šä¹‰ã€‚</p>
<p>å‡è®¾ a åœ¨ %rdi ä¸­æŸä¸ªéƒ¨åˆ†ï¼Œb åœ¨ %rsi ä¸­æŸä¸ªéƒ¨åˆ†ã€‚å¯¹äºä¸‹é¢æ¯ä¸ªæŒ‡ä»¤åºåˆ—ï¼Œç¡®å®šå“ªç§æ•°æ®ç±»å‹ <code>data_t</code> å’Œæ¯”è¾ƒ COMP ä¼šå¯¼è‡´ç¼–è¯‘å™¨äº§ç”Ÿè¿™æ ·çš„ä»£ç ã€‚ï¼ˆå¯èƒ½æœ‰å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œè¯·åˆ—å‡ºæ‰€æœ‰çš„æ­£ç¡®ç­”æ¡ˆã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221030184524281.png" alt="image-20221030184524281"></p>
<p>A.åç¼€ â€˜lâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 32 ä½æ“ä½œæ•°ï¼Œè€Œä¸”è°ƒç”¨çš„æ˜¯æœ‰ç¬¦å·çš„å°äºæ¯”è¾ƒã€‚æ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ int ã€‚</p>
<p>B.åç¼€ â€˜wâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 16 ä½æ“ä½œæ•°ï¼Œè€Œä¸”è°ƒç”¨çš„æ˜¯æœ‰ç¬¦å·çš„å¤§äºç­‰äºã€‚æ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ shortã€‚</p>
<p>C.åç¼€ â€˜bâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 8 ä½æ“ä½œæ•°ï¼Œè€Œä¸”è°ƒç”¨çš„æ˜¯æ— ç¬¦å·å°äºç­‰äºã€‚æ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ unsigned char ã€‚</p>
<p>D.åç¼€ â€˜qâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 64 ä½æ“ä½œæ•°ï¼ŒåŒæ—¶æ¯”è¾ƒç¬¦å·æ˜¯ <code>!=</code> ï¼Œæœ‰ç¬¦å·ã€æ— ç¬¦å·å’ŒæŒ‡é’ˆå‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥ <code>data_t</code> å¯ä»¥æ˜¯ longã€unsigned long æˆ– char * ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-14-è€ƒè™‘ä¸‹é¢çš„-C-è¯­è¨€ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-14-è€ƒè™‘ä¸‹é¢çš„-C-è¯­è¨€ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.14 è€ƒè™‘ä¸‹é¢çš„ C è¯­è¨€ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.14 è€ƒè™‘ä¸‹é¢çš„ C è¯­è¨€ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">test</span><span class="params">(<span class="type">data_t</span> a)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a TEST <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å®ƒç»™å‡ºäº†å‚æ•° a å’Œ 0 ä¹‹é—´æ¯”è¾ƒçš„ä¸€èˆ¬å½¢å¼ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>typedef</code> æ¥å£°æ˜ <code>data_t</code> ï¼Œä»è€Œè®¾ç½®å‚æ•°çš„æ•°æ®ç±»å‹ï¼Œç”¨ <code>#define</code> æ¥å£°æ˜ TESTï¼Œä»è€Œè®¾ç½®æ¯”è¾ƒçš„ç±»å‹ã€‚å¯¹äºä¸‹é¢æ¯ä¸ªæŒ‡ä»¤åºåˆ—ï¼Œç¡®å®šå“ªç§æ•°æ®ç±»å‹ <code>data_t</code> å’Œæ¯”è¾ƒ <code>TEST</code> ä¼šå¯¼è‡´ç¼–è¯‘å™¨äº§ç”Ÿè¿™æ ·çš„ä»£ç ã€‚ï¼ˆå¯èƒ½æœ‰å¤šä¸ªæ­£ç¡®ç­”æ¡ˆï¼Œè¯·åˆ—å‡ºæ‰€æœ‰çš„æ­£ç¡®ç­”æ¡ˆã€‚ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221030192217880.png" alt="image-20221030192217880"></p>
<p>A.åç¼€ â€˜qâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 64 ä½æ“ä½œæ•°ï¼Œè€Œä¸”è°ƒç”¨æœ‰ç¬¦å·å¤§äºç­‰äºï¼Œæ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ long ã€‚</p>
<p>B.åç¼€ â€˜wâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 16 ä½æ“ä½œæ•°ï¼Œæ¯”è¾ƒç¬¦ <code>==</code> å¯¹äºæœ‰æ— ç¬¦å·éƒ½æ˜¯ä¸€æ ·çš„ã€‚æ‰€ä»¥ <code>data_t</code> å¯ä»¥æ˜¯ <code>short</code> æˆ–è€… <code>unsigned short</code> ã€‚</p>
<p>C.åç¼€ â€˜bâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 8 ä½æ“ä½œæ•°ï¼Œä½¿ç”¨çš„æ˜¯æ— ç¬¦å·å¤§äºï¼Œæ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ <code>unsigned char</code> ã€‚</p>
<p>D.åç¼€ â€˜lâ€™ å’Œå¯„å­˜å™¨æŒ‡ç¤ºç¬¦è¡¨æ˜æ˜¯ 32 ä½æ“ä½œæ•°ï¼Œä½¿ç”¨çš„æ˜¯å¸¦ç¬¦å·çš„å°äºç­‰äºï¼Œæ‰€ä»¥ <code>data_t</code> ä¸€å®šæ˜¯ <code>int</code> ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-15åœ¨ä¸‹é¢è¿™äº›åæ±‡ç¼–äºŒè¿›åˆ¶ä»£ç èŠ‚é€‰ä¸­ï¼Œæœ‰äº›ä¿¡æ¯è¢«-X-ä»£æ›¿äº†ã€‚å›ç­”ä¸‹åˆ—å…³äºè¿™äº›æŒ‡ä»¤çš„é—®é¢˜ã€‚"><a href="#ç»ƒä¹ é¢˜-3-15åœ¨ä¸‹é¢è¿™äº›åæ±‡ç¼–äºŒè¿›åˆ¶ä»£ç èŠ‚é€‰ä¸­ï¼Œæœ‰äº›ä¿¡æ¯è¢«-X-ä»£æ›¿äº†ã€‚å›ç­”ä¸‹åˆ—å…³äºè¿™äº›æŒ‡ä»¤çš„é—®é¢˜ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜ 3.15åœ¨ä¸‹é¢è¿™äº›åæ±‡ç¼–äºŒè¿›åˆ¶ä»£ç èŠ‚é€‰ä¸­ï¼Œæœ‰äº›ä¿¡æ¯è¢« X ä»£æ›¿äº†ã€‚å›ç­”ä¸‹åˆ—å…³äºè¿™äº›æŒ‡ä»¤çš„é—®é¢˜ã€‚"></a>ç»ƒä¹ é¢˜ 3.15åœ¨ä¸‹é¢è¿™äº›åæ±‡ç¼–äºŒè¿›åˆ¶ä»£ç èŠ‚é€‰ä¸­ï¼Œæœ‰äº›ä¿¡æ¯è¢« X ä»£æ›¿äº†ã€‚å›ç­”ä¸‹åˆ—å…³äºè¿™äº›æŒ‡ä»¤çš„é—®é¢˜ã€‚</h2><p>A. ä¸‹é¢ je æŒ‡ä»¤çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆåœ¨æ­¤ï¼Œä½ ä¸éœ€è¦çŸ¥é“ä»»ä½•æœ‰å…³ callq æŒ‡ä»¤çš„ä¿¡æ¯ã€‚ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4003fa: 74 02    je    XXXXXX</span><br><span class="line">4003fc: ff do    callq *%rax</span><br></pre></td></tr></table></figure>
<p>je æŒ‡ä»¤çš„ç›®æ ‡ä¸º <code>0x4003fc + 0x02 = 0x4003fe</code> ã€‚</p>
<p>B. ä¸‹é¢ je æŒ‡ä»¤çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">40042f: 74 f4    je   XXXXXX</span><br><span class="line">400431: 5d       pop  %rbp</span><br></pre></td></tr></table></figure>
<p>je æŒ‡ä»¤çš„ç›®æ ‡ä¸º <code>0x400431 - 12ï¼ˆç”±äº 0xf4 æ˜¯ -12 çš„ä¸€ä¸ªå­—èŠ‚çš„è¡¥ç è¡¨ç¤ºï¼‰= 0x400425</code> ã€‚</p>
<p>C. ja å’Œ pop æŒ‡ä»¤çš„åœ°å€æ˜¯å¤šå°‘ï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">XXXXXX: 77 02    ja   400547</span><br><span class="line">XXXXXX: 5d       pop  %rbp</span><br></pre></td></tr></table></figure>
<p>è·³è½¬ç›®æ ‡æ˜¯ç»å¯¹åœ°å€ <code>0x400547</code> ã€‚æ ¹æ®å­—èŠ‚ç¼–ç ï¼Œä¸€å®šåœ¨è·ç¦» pop æŒ‡ä»¤ <code>0x2</code> çš„åœ°å€å¤„ã€‚æ‰€ä»¥ï¼Œpop æŒ‡ä»¤åœ°å€ä¸º <code>0x400547 - 0x2 = 0x400545</code> ã€‚<strong>æ³¨æ„ï¼Œja æŒ‡ä»¤çš„ç¼–ç éœ€è¦ 2 ä¸ªå­—èŠ‚ã€‚</strong>æ‰€ä»¥ ja æŒ‡ä»¤çš„åœ°å€ä¸º <code>0x400543</code> å¤„ã€‚</p>
<p>D. åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œè·³è½¬ç›®æ ‡çš„ç¼–ç æ˜¯ PC ç›¸å¯¹çš„ï¼Œä¸”æ˜¯ä¸€ä¸ª 4 å­—èŠ‚è¡¥ç æ•°ã€‚å­—èŠ‚æŒ‰ç…§ä»æœ€ä½ä½åˆ°æœ€é«˜ä½çš„é¡ºåºåˆ—å‡ºï¼Œåæ˜ å‡º x86-64 çš„å°ç«¯æ³•å­—èŠ‚é¡ºåºã€‚è·³è½¬ç›®æ ‡çš„åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">4005e8: e9 73 ff ff ff     jmp  XXXXXX</span><br><span class="line">4005ed: 90                 nop</span><br></pre></td></tr></table></figure>
<p>ä»¥ç›¸åçš„é¡ºåºæ¥è¯»è¿™äº›å­—èŠ‚ï¼Œæˆ‘ä»¬çœ‹åˆ°ç›®æ ‡åç§»é‡æ˜¯ <code>0xffffff73</code> ï¼Œæˆ–è€…åè¿›åˆ¶æ•° <code>-141</code> ã€‚æ‰€ä»¥è·³è½¬ç›®æ ‡ä¸º <code>0x4005ed - 141 = 0x400560</code> ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-16å·²çŸ¥ä¸‹åˆ—-C-ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-16å·²çŸ¥ä¸‹åˆ—-C-ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.16å·²çŸ¥ä¸‹åˆ— C ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.16å·²çŸ¥ä¸‹åˆ— C ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">cond</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (p &amp;&amp; a &gt; *p)</span><br><span class="line">        *p = a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC ä¼šäº§ç”Ÿä¸‹é¢çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># void cond(long a, long *p)</span><br><span class="line"># a in %rdi, p in %rsi</span><br><span class="line">cond:</span><br><span class="line">  testq  %rsi, %rsi   # æµ‹è¯• p</span><br><span class="line">  je     .L1          # å¦‚æœæ˜¯ 0 å°±è·³è½¬åˆ° L1 </span><br><span class="line">  comq   %rdi, (%rsi) # æ¯”è¾ƒ *p å’Œ a</span><br><span class="line">  jge    .L1          # å¦‚æœ *p &gt;= aï¼Œè·³è½¬åˆ° L1</span><br><span class="line">  movq   %rdi, (%rsi) # *p = a</span><br><span class="line">.L1:</span><br><span class="line">  rep; ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. æŒ‰ç…§å›¾ 3-16b ä¸­æ‰€ç¤ºçš„é£æ ¼ï¼Œç”¨ C è¯­è¨€å†™ä¸€ä¸ª goto ç‰ˆæœ¬ï¼Œæ‰§è¡ŒåŒæ ·çš„è®¡ç®—ï¼Œå¹¶æ¨¡æ‹Ÿæ±‡ç¼–ä»£ç çš„æ§åˆ¶æµã€‚åƒç¤ºä¾‹ä¸­é‚£æ ·ç»™æ±‡ç¼–ä»£ç åŠ ä¸Šæ³¨è§£å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">goto_cond</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> *p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">goto</span> done;</span><br><span class="line">    <span class="keyword">if</span> (*p &gt;= a)</span><br><span class="line">      <span class="keyword">goto</span> done;</span><br><span class="line">    *p = a;</span><br><span class="line">  done:</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>B. è¯·è¯´æ˜ä¸ºä»€ä¹ˆ C è¯­è¨€ä»£ç ä¸­åªæœ‰ä¸€ä¸ª if è¯­å¥ï¼Œè€Œæ±‡ç¼–ä»£ç åŒ…å«ä¸¤ä¸ªæ¡ä»¶åˆ†æ”¯ã€‚</p>
<p>ç¬¬ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯æ˜¯ &amp;&amp; è¡¨è¾¾å¼å®ç°çš„ä¸€éƒ¨åˆ†ã€‚å¦‚æœå¯¹ p ä¸ºéç©ºçš„æµ‹è¯•å¤±è´¥ï¼Œä»£ç ä¼šè·³è¿‡å¯¹ <code>a &gt; *p</code> çš„æµ‹è¯•ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-17å°†-if-è¯­å¥ç¿»è¯‘æˆ-goto-ä»£ç çš„å¦ä¸€ç§å¯è¡Œçš„è§„åˆ™å¦‚ä¸‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-17å°†-if-è¯­å¥ç¿»è¯‘æˆ-goto-ä»£ç çš„å¦ä¸€ç§å¯è¡Œçš„è§„åˆ™å¦‚ä¸‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.17å°† if è¯­å¥ç¿»è¯‘æˆ goto ä»£ç çš„å¦ä¸€ç§å¯è¡Œçš„è§„åˆ™å¦‚ä¸‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.17å°† if è¯­å¥ç¿»è¯‘æˆ goto ä»£ç çš„å¦ä¸€ç§å¯è¡Œçš„è§„åˆ™å¦‚ä¸‹ï¼š</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    t = test-expr;</span><br><span class="line">    if (t)</span><br><span class="line">        goto true;</span><br><span class="line">    else-statement</span><br><span class="line">    goto done;</span><br><span class="line">true:</span><br><span class="line">    then-statement</span><br><span class="line">done:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. åŸºäºè¿™ç§è§„åˆ™ï¼Œé‡å†™ absdiff_se çš„ goto ç‰ˆæœ¬ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">gotodiff_se_alt</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123;</span><br><span class="line">    <span class="type">long</span> result;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y)</span><br><span class="line">        <span class="keyword">goto</span> x_lt_y;</span><br><span class="line">    go_cnt++</span><br><span class="line">    result = x - y;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">x_lt_y:</span><br><span class="line">    lt_cnt++;</span><br><span class="line">    result = y - x;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>B. ä½ èƒ½æƒ³å‡ºé€‰ç”¨ä¸€ç§è§„åˆ™è€Œä¸é€‰ç”¨å¦ä¸€ç§è§„åˆ™çš„ç†ç”±å—ï¼Ÿ</p>
<p>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¯ä»¥åœ¨è¿™ä¸¤ç§æ–¹å¼ä¸­ä»»æ„é€‰æ‹©ã€‚ä½†æ˜¯åŸæ¥çš„æ–¹æ³•å¯¹å¸¸è§çš„æ²¡æœ‰ else è¯­å¥çš„æƒ…å†µæ›´å¥½ä¸€äº›ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬åªç”¨ç®€å•åœ°å°†ç¿»è¯‘è§„åˆ™ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    t = test-expr;</span><br><span class="line">    if (!t)</span><br><span class="line">        goto done;</span><br><span class="line">    then-statement</span><br><span class="line">done:</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-18ä»å¦‚ä¸‹å½¢å¼çš„-C-è¯­è¨€ä»£ç å¼€å§‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-18ä»å¦‚ä¸‹å½¢å¼çš„-C-è¯­è¨€ä»£ç å¼€å§‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.18ä»å¦‚ä¸‹å½¢å¼çš„ C è¯­è¨€ä»£ç å¼€å§‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.18ä»å¦‚ä¸‹å½¢å¼çš„ C è¯­è¨€ä»£ç å¼€å§‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, <span class="type">long</span> z)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = ___________;</span><br><span class="line">    <span class="keyword">if</span> (______) &#123;</span><br><span class="line">        <span class="keyword">if</span> (______)</span><br><span class="line">            val = ______;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            val = ______;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (______)</span><br><span class="line">        val = ______;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC äº§ç”Ÿå¦‚ä¸‹çš„æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># long test(long x, long y, long z)</span></span><br><span class="line"><span class="meta"># x in %rdi, y in %rsi, z in %rdx</span></span><br><span class="line">test:</span><br><span class="line">  leaq  (%rdi, %rsi), %rax  <span class="meta"># long temp1 = x + y</span></span><br><span class="line">  addq  %rdx, %rax          # temp1 = temp1 + z</span><br><span class="line">  cmpq  $<span class="number">-3</span>, %rdi           # æ¯”è¾ƒ x å’Œ <span class="number">-3</span></span><br><span class="line">  jge   .L2                 <span class="meta"># x &gt;= -3 æ—¶è·³è½¬åˆ° L2</span></span><br><span class="line">  cmpq  %rdx, %rsi          # æ¯”è¾ƒ y å’Œ z</span><br><span class="line">  jge   .L3                 <span class="meta"># y &gt;= z æ—¶è·³è½¬åˆ° L3</span></span><br><span class="line">  movq  %rdi, %rax          # temp1 = x</span><br><span class="line">  imulq %rsi, %rax          # temp1 = temp1 * y</span><br><span class="line">  ret                       <span class="meta"># return</span></span><br><span class="line">.L3:</span><br><span class="line">  movq  %rsi, %rax          # æ­¤æ—¶ x &lt; <span class="number">-3</span>ï¼Œy &gt;= zï¼›temp1 = y</span><br><span class="line">  imulq %rdx, %rax          # temp1 = temp1 * z</span><br><span class="line">  ret                       <span class="meta"># return</span></span><br><span class="line">.L2:</span><br><span class="line">  cmpq  $<span class="number">2</span>, %rdi            # æ­¤æ—¶ x &gt;= <span class="number">-3</span>ï¼›æ¯”è¾ƒ x å’Œ <span class="number">2</span></span><br><span class="line">  jle   .L4                 <span class="meta"># x &lt;= 2 æ—¶è·³è½¬åˆ° L4</span></span><br><span class="line">  movq  %rdi, %rax          # temp1 = x</span><br><span class="line">  imulq %rdx, %rax          # temp1 = temp1 * z</span><br><span class="line">.L4:</span><br><span class="line">  rep; ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¡«å†™ C ä»£ç ä¸­ç¼ºå¤±çš„è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y, longz)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = x + y + z;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">-3</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (y &lt; z)</span><br><span class="line">            val = x * y;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            val = y * z;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; <span class="number">2</span>) </span><br><span class="line">        val = x * z;</span><br><span class="line">   <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-20-ä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼š"><a href="#ç»ƒä¹ é¢˜-3-20-ä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„-C-å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹-OP-æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.20 ä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼š"></a>ç»ƒä¹ é¢˜ 3.20 ä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼šä¸‹é¢çš„ C å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¯¹ OP æ“ä½œçš„å®šä¹‰æ˜¯ä¸å®Œæ•´çš„ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> OP _________ <span class="comment">/* Unknown operator */</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">arith</span><span class="params">(<span class="type">long</span> x)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x OP <span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç¼–è¯‘æ—¶ï¼ŒGCC ä¼šäº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long arith(long x)</span><br><span class="line"># x in %rdi</span><br><span class="line">arith:</span><br><span class="line">  leaq  7(%rdi), %rax   # temp = x + 7</span><br><span class="line">  testq %rdi, %rdi      # Test x</span><br><span class="line">  cmovns %rdi, %rax     # if x &gt;= 0, temp = x</span><br><span class="line">  sarq   $3, %rax       # result = temp &gt;&gt; 3 (= x / 8)</span><br><span class="line">  ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. OP è¿›è¡Œçš„æ˜¯ä»€ä¹ˆæ“ä½œï¼Ÿ</p>
<p>è¿ç®—ç¬¦æ˜¯ â€˜/â€™ ã€‚å¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªé€šè¿‡å³ç§»å®ç°é™¤ä»¥ 2 çš„ 3 æ¬¡å¹‚çš„ä¾‹å­ã€‚åœ¨ç§»ä½ <code>k = 3</code> ä¹‹å‰ï¼Œå¦‚æœè¢«é™¤æ•°æ˜¯è´Ÿæ•°çš„è¯ï¼Œå¿…é¡»åŠ ä¸Šåç§»é‡ 2kâˆ’1=7 ï¼ˆå‘ä¸Šèˆå…¥ï¼‰ã€‚</p>
<p>B. ç»™ä»£ç æ·»åŠ æ³¨é‡Šï¼Œè§£é‡Šå®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-21-C-ä»£ç å¼€å§‹çš„å½¢å¼å¦‚ä¸‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-21-C-ä»£ç å¼€å§‹çš„å½¢å¼å¦‚ä¸‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.21 C ä»£ç å¼€å§‹çš„å½¢å¼å¦‚ä¸‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.21 C ä»£ç å¼€å§‹çš„å½¢å¼å¦‚ä¸‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = _____;</span><br><span class="line">    <span class="keyword">if</span> (_____) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_____)</span><br><span class="line">            val = ______;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            val = ______;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (______)</span><br><span class="line">        val = ________;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC ä¼šäº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long test(long x, long y)</span><br><span class="line"># x in %rdi, y in %rsi</span><br><span class="line">test:</span><br><span class="line">  leaq  0(, %rdi, 8), %rax  # long temp = 8 * x</span><br><span class="line">  testq %rsi, %rsi          # test y</span><br><span class="line">  jle   .L2                 # y &lt;= 0</span><br><span class="line">  movq  %rsi, %rax          # temp = y</span><br><span class="line">  subq  %rdi, %rax          # temp = temp - x</span><br><span class="line">  movq  %rdi, %rdx          # long temp2 = x</span><br><span class="line">  andq  %rsi, %rdx          # temp2 = temp2 &amp; y</span><br><span class="line">  cmpq  %rsi, %rdi          # æ¯”è¾ƒ x å’Œ y</span><br><span class="line">  cmovge %rdx, %rax         # x &gt;= y, temp = temp2</span><br><span class="line">  ret</span><br><span class="line">.L2:</span><br><span class="line">  addq  %rsi, %rdi          # x = x + y</span><br><span class="line">  cmpq  $-2, $rsi           # æ¯”è¾ƒ y å’Œ -2</span><br><span class="line">  cmovle %rdi, %rax         # y &lt;= -2, temp = x + y</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>
<p>å¡«è¡¥ C ä»£ç ä¸­ç¼ºå¤±çš„è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> y)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">8</span> * x;</span><br><span class="line">    <span class="keyword">if</span> (y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (x &lt; y)</span><br><span class="line">            val = y - x;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            val = x &amp; y;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (y &lt;= <span class="number">-2</span>)</span><br><span class="line">        val = x + y;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-22"><a href="#ç»ƒä¹ é¢˜-3-22" class="headerlink" title="ç»ƒä¹ é¢˜ 3.22"></a>ç»ƒä¹ é¢˜ 3.22</h2><p>A. ç”¨ä¸€ä¸ª 32 ä½ int è¡¨ç¤º n! ï¼Œæœ€å¤§çš„ n çš„å€¼æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>å¦‚æœæ„å»ºä¸€å¼ ä½¿ç”¨æ•°æ®ç±»å‹ int æ¥è®¡ç®—çš„é˜¶ä¹˜è¡¨ï¼Œå¾—åˆ°ä¸‹é¢è¿™æ ·çš„ç»“æœï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>n</th>
<th>n!</th>
<th>OK?</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
<td>Y</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>Y</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
<td>Y</td>
</tr>
<tr>
<td>4</td>
<td>24</td>
<td>Y</td>
</tr>
<tr>
<td>5</td>
<td>120</td>
<td>Y</td>
</tr>
<tr>
<td>6</td>
<td>720</td>
<td>Y</td>
</tr>
<tr>
<td>7</td>
<td>5040</td>
<td>Y</td>
</tr>
<tr>
<td>8</td>
<td>40320</td>
<td>Y</td>
</tr>
<tr>
<td>9</td>
<td>362880</td>
<td>Y</td>
</tr>
<tr>
<td>10</td>
<td>3628800</td>
<td>Y</td>
</tr>
<tr>
<td>11</td>
<td>39916800</td>
<td>Y</td>
</tr>
<tr>
<td>12</td>
<td>479001600</td>
<td>Y</td>
</tr>
<tr>
<td>13</td>
<td>1932053504</td>
<td>N</td>
</tr>
</tbody>
</table>
</div>
<p>å½“ <code>n = 13</code> æ—¶å‘ç”Ÿæº¢å‡ºï¼Œå¯ä»¥é€šè¿‡$x/n$çœ‹å®ƒæ˜¯å¦ç­‰äº$(n-1)!$è¿›è¡Œåˆ¤æ–­ã€‚</p>
<p>B. å¦‚æœç”¨ä¸€ä¸ª 64 ä½ long è¡¨ç¤ºï¼Œæœ€å¤§çš„ n çš„å€¼æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>ç”¨longè¡¨ç¤ºçš„è¯ï¼Œæœ€å¤§çš„ n å€¼ä¸º 20ï¼Œæ‰æº¢å‡ºï¼Œä¹Ÿå°±æ˜¯çŸ¥é“20ï¼longç±»å‹æ‰æº¢å‡ºã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-23-å·²çŸ¥-C-ä»£ç å¦‚ä¸‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-23-å·²çŸ¥-C-ä»£ç å¦‚ä¸‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.23 å·²çŸ¥ C ä»£ç å¦‚ä¸‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.23 å·²çŸ¥ C ä»£ç å¦‚ä¸‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">dw_loop</span><span class="params">(<span class="type">long</span> x)</span>&#123;</span><br><span class="line">    <span class="type">long</span> y = x * x;</span><br><span class="line">    <span class="type">long</span> *p = &amp;x;</span><br><span class="line">    <span class="type">long</span> n = <span class="number">2</span> * x;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        x += y;</span><br><span class="line">        (*p)++;</span><br><span class="line">        n--;</span><br><span class="line">    &#125; <span class="keyword">while</span> (n &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC äº§ç”Ÿçš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long dw_loop(long x)</span><br><span class="line"># x initially in %rdi</span><br><span class="line"></span><br><span class="line">long dw_loop(long x)</span><br><span class="line">dw_loop:</span><br><span class="line">    movq   %rdi, %rax            # Copy x to %rax   </span><br><span class="line">    movq   %rdi, %rcx               </span><br><span class="line">    imulq  %rdi, %rcx            # Compute y = x*x   </span><br><span class="line">    leaq   (%rdi, %rdi), %rdx    # Compute n = x+x   </span><br><span class="line"></span><br><span class="line">  .L2:                           # loop:</span><br><span class="line">    leaq   1(%rcx, %rax), %rax   # Compute x += y + 1   </span><br><span class="line">    subq   $1, %rdx              # Decrement n   </span><br><span class="line">    testq  %rdx, %rdx            # Test n   </span><br><span class="line">    jg     .L2                   # If &gt; 0, goto loop   </span><br><span class="line">    rep;ret                      # Return   </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. å“ªäº›å¯„å­˜å™¨ç”¨æ¥å­˜æ”¾ç¨‹åºå€¼ xã€y å’Œ n ï¼Ÿ</p>
<p><code>%rax</code> å­˜æ”¾ x ï¼Œ<code>%rcx</code> å­˜æ”¾ y ï¼Œ<code>%rdx</code> å­˜æ”¾ n ã€‚</p>
<p>B. ç¼–è¯‘å™¨å¦‚ä½•æ¶ˆé™¤å¯¹æŒ‡é’ˆå˜é‡ p å’Œè¡¨è¾¾å¼ <code>(*p)++</code> éšå«çš„æŒ‡é’ˆé—´æ¥å¼•ç”¨çš„éœ€æ±‚ï¼Ÿ</p>
<p>ç¼–è¯‘å™¨è®¤ä¸ºæŒ‡é’ˆ p æ€»æ˜¯æŒ‡å‘ x ï¼Œå› æ­¤è¡¨è¾¾å¼ <code>(*p)++</code> å°±èƒ½å¤Ÿå®ç° x åŠ ä¸€ã€‚ä»£ç é€šè¿‡ <code>leaq</code> æŒ‡ä»¤ï¼ŒæŠŠè¿™ä¸ªåŠ ä¸€å’ŒåŠ  y ç»„åˆèµ·æ¥ã€‚</p>
<p>C. å¯¹æ±‡ç¼–ä»£ç æ·»åŠ ä¸€äº›æ³¨é‡Šï¼Œæè¿°ç¨‹åºæ“ä½œã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-24å¯¹äºå¦‚ä¸‹-C-ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-24å¯¹äºå¦‚ä¸‹-C-ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.24å¯¹äºå¦‚ä¸‹ C ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.24å¯¹äºå¦‚ä¸‹ C ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">loop_while</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> result = ____;</span><br><span class="line">    <span class="keyword">while</span> (____) &#123;</span><br><span class="line">        result = ____;</span><br><span class="line">        a = ____ ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥å‘½ä»¤è¡Œé€‰é¡¹ <code>-Og</code> è¿è¡Œ GCC äº§ç”Ÿå¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long loop_while(long a, long b)</span><br><span class="line"># a in %rdi, b in %rsi</span><br><span class="line">loop_while:</span><br><span class="line">    movl   $1, %eax            </span><br><span class="line">    jmp    .L2                 </span><br><span class="line"></span><br><span class="line">  .L3:</span><br><span class="line">    leaq   (%rdi, %rsi), %rdx  </span><br><span class="line">    imulq  %rdx, %rax          </span><br><span class="line">    addq   $1, %rdi            </span><br><span class="line"></span><br><span class="line">  .L2:</span><br><span class="line">    cmpq   %rsi, %rdi          </span><br><span class="line">    jl     .L3                 </span><br><span class="line">    rep; ret                   </span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘å™¨ä½¿ç”¨äº†è·³è½¬åˆ°ä¸­é—´çš„ç¿»è¯‘æ–¹æ³•ï¼Œåœ¨ç”¨ jmp è·³è½¬åˆ°æ ‡å· .L2 å¼€å§‹æµ‹è¯•ã€‚å¡«å†™ C ä»£ç ä¸­ç¼ºå¤±çš„éƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">loop_while</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> result = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (a &lt; b) &#123;</span><br><span class="line">        result = result * (a + b);</span><br><span class="line">        a = a + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-25å¯¹äºå¦‚ä¸‹-C-ä»£ç ï¼š"><a href="#ç»ƒä¹ é¢˜-3-25å¯¹äºå¦‚ä¸‹-C-ä»£ç ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.25å¯¹äºå¦‚ä¸‹ C ä»£ç ï¼š"></a>ç»ƒä¹ é¢˜ 3.25å¯¹äºå¦‚ä¸‹ C ä»£ç ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">loop_while2</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> result = ____;</span><br><span class="line">    <span class="keyword">while</span> (____) &#123;</span><br><span class="line">        result = ____;</span><br><span class="line">        b = ____ ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥å‘½ä»¤è¡Œé€‰é¡¹ <code>-ol</code> è¿è¡Œ GCC ï¼Œäº§ç”Ÿå¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># a in %rdi, b in %rsi</span><br><span class="line">loop_while2:</span><br><span class="line">    testq   %rsi, %rsi      </span><br><span class="line">    jle     .L8             </span><br><span class="line">    movq    %rsi, %rax      </span><br><span class="line">  .L7:</span><br><span class="line">    imulq   %rdi, %rax      </span><br><span class="line">    subq    %rdi, %rsi      </span><br><span class="line">    testq   %rsi, %rsi      </span><br><span class="line">    jg      .L7             </span><br><span class="line">    rep; ret                </span><br><span class="line">  .L8:</span><br><span class="line">    movq    %rsi, %rax      </span><br><span class="line">    ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ç¼–è¯‘å™¨ä½¿ç”¨äº† guarded-do çš„ç¿»è¯‘æ–¹æ³•ï¼Œä½¿ç”¨äº† <code>jle</code> æŒ‡ä»¤ä½¿å¾—å½“åˆå§‹æµ‹è¯•ä¸æˆç«‹æ—¶ï¼Œå¿½ç•¥å¾ªç¯ä»£ç ã€‚å¡«å†™ç¼ºå¤±çš„ C ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">loop_while2</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> result = b;</span><br><span class="line">    <span class="keyword">while</span> (b&gt;<span class="number">0</span>) &#123;</span><br><span class="line">        result = result * a;</span><br><span class="line">        b = b - a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-26-å‡½æ•°-fun-a-æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š"><a href="#ç»ƒä¹ é¢˜-3-26-å‡½æ•°-fun-a-æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.26 å‡½æ•° fun_a æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š"></a>ç»ƒä¹ é¢˜ 3.26 å‡½æ•° fun_a æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fun_a</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (...) &#123;</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ...;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC C ç¼–è¯‘å™¨äº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long fun_a(unsigned long x)</span><br><span class="line"># x in %rdi</span><br><span class="line">long fun_a(unsigned long x)</span><br><span class="line"></span><br><span class="line">fun_a:</span><br><span class="line">    movl   $0, eax      </span><br><span class="line">    jmp    .L5          </span><br><span class="line"></span><br><span class="line">  .L6:</span><br><span class="line">    xorq   %rdi, %rax   </span><br><span class="line">    shrq   %rdi         # Shift right by 1</span><br><span class="line"></span><br><span class="line">  .L5:</span><br><span class="line">    testq  %rdi, %rdi   </span><br><span class="line">    jne    .L6          </span><br><span class="line">    andl   $1, %eax     </span><br><span class="line">    ret                 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é€†å‘å·¥ç¨‹è¿™æ®µä»£ç çš„æ“ä½œï¼Œç„¶åå®Œæˆä¸‹é¢ä½œä¸šï¼š</p>
<p>A. ç¡®å®šè¿™æ®µä»£ç ä½¿ç”¨çš„å¾ªç¯ç¿»è¯‘æ–¹æ³•ã€‚</p>
<p>ä½¿ç”¨çš„æ˜¯è·³è½¬åˆ°ä¸­é—´ç¿»è¯‘æ–¹æ³•ã€‚æ±‡ç¼–ä¸­ä½¿ç”¨äº† <code>jmp</code> æŒ‡ä»¤ã€‚</p>
<p>B. æ ¹æ®æ±‡ç¼–ä»£ç ç‰ˆæœ¬å¡«å†™å®Œ C ä»£ç ä¸­ç¼ºå¤±çš„éƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fun_a</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (x != <span class="number">0</span>) &#123;</span><br><span class="line">        val ^= x ;</span><br><span class="line">        x &gt;&gt;= <span class="number">1</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> val &amp; <span class="number">0x1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C. ç”¨è‡ªç„¶è¯­è¨€æè¿°è¿™ä¸ªå‡½æ•°æ˜¯è®¡ç®—ä»€ä¹ˆçš„ã€‚</p>
<p>è¿™ä¸ªä»£ç è®¡ç®—å‚æ•° x çš„å¥‡å¶æ€§ã€‚ä¹Ÿå°±æ˜¯ï¼Œå¦‚æœ x ä¸­æœ‰å¥‡æ•°ä¸ª 1ï¼Œå°±è¿”å› 1ï¼Œå¦‚æœæœ‰å¶æ•°ä¸ª 1ï¼Œå°±è¿”å› 0ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-27"><a href="#ç»ƒä¹ é¢˜-3-27" class="headerlink" title="ç»ƒä¹ é¢˜ 3.27"></a>ç»ƒä¹ é¢˜ 3.27</h2><p>å…ˆæŠŠ <code>fact_for</code> è½¬æ¢æˆ while å¾ªç¯ï¼Œå†è¿›è¡Œ guarded-do å˜åŒ–ï¼Œå†™å‡º <code>fact_for</code> çš„ goto ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fact_for_gd_goto</span><span class="params">(<span class="type">long</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> i = <span class="number">2</span>;</span><br><span class="line">    <span class="type">long</span> result = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    loop:</span><br><span class="line">        result *= i;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span> (i &lt;= n)</span><br><span class="line">            <span class="keyword">goto</span> loop;</span><br><span class="line">    done:</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-28å‡½æ•°-fun-b-æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š"><a href="#ç»ƒä¹ é¢˜-3-28å‡½æ•°-fun-b-æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.28å‡½æ•° fun_b æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š"></a>ç»ƒä¹ é¢˜ 3.28å‡½æ•° <code>fun_b</code> æœ‰å¦‚ä¸‹æ•´ä½“ç»“æ„ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fun_b</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="keyword">for</span> ( ... ; ... ; ... ) &#123;</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>GCC ç¼–è¯‘å™¨äº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long fun_b(unsigned long x)</span><br><span class="line"># x in %rdi</span><br><span class="line"></span><br><span class="line">fun_b:</span><br><span class="line">    movl   $64, %edx        # %edx å¯„å­˜å™¨ä¸­å­˜å…¥ 64</span><br><span class="line">    movl   $0, %eax         # å¯¹åº” long val = 0</span><br><span class="line"></span><br><span class="line">  .L10:</span><br><span class="line">    movq   %rdi, %rcx       # long temp = x</span><br><span class="line">    andl   $1, %ecx         # temp = temp ^ 0x1  x çš„æœ€ä½ä½</span><br><span class="line">    addq   %rax, %rax       # val = val * 2</span><br><span class="line">    orq    %rcx, %rax       # val = val | temp æœ€ä½ä½å¦‚æœæ˜¯ 1ï¼Œå°±æ˜¯çœŸ</span><br><span class="line">    shrq   %rdi             # é€»è¾‘å³ç§» 1 ä½</span><br><span class="line">    subq   $1, %rdx         # è£…å…¥å¯„å­˜å™¨ï¼Œå‡å» 1</span><br><span class="line">    jne    .L10             # %rdx ä¸æ˜¯ 0 çš„æƒ…å†µä¸‹ç»§ç»­å¾ªç¯</span><br><span class="line">    rep; ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>é€†å‘å·¥ç¨‹è¿™æ®µä»£ç çš„æ“ä½œï¼Œç„¶åå®Œæˆä¸‹é¢çš„å·¥ä½œï¼š</p>
<p>A. æ ¹æ®æ±‡ç¼–ä»£ç ç‰ˆæœ¬å¡«å†™ C ä»£ç ä¸­ç¼ºå¤±çš„éƒ¨åˆ†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fun_b</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> i;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">64</span> ; i!=<span class="number">0</span> ; i-- ) &#123;</span><br><span class="line">        val = (val &lt;&lt; <span class="number">1</span>) | (x &amp; <span class="number">0x1</span>);</span><br><span class="line">        x &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>B. è§£é‡Šå¾ªç¯å‰ä¸ºä»€ä¹ˆæ²¡æœ‰åˆè¯†æµ‹è¯•ä¹Ÿæ²¡æœ‰åˆå§‹è·³è½¬åˆ°å¾ªç¯å†…éƒ¨çš„æµ‹è¯•éƒ¨åˆ†ã€‚</p>
<p>è¿™æ®µä»£ç ä½¿ç”¨ guarded-do å˜æ¢ç”Ÿæˆçš„ï¼Œä½†æ˜¯ç¼–è¯‘å™¨å‘ç°å› ä¸º i åˆå§‹åŒ–æˆäº† 64ï¼Œæ‰€ä»¥ä¸€å®šä¼šæ»¡è¶³æµ‹è¯• <code>i != 0</code> ï¼Œå› æ­¤åˆå§‹çš„æµ‹è¯•æ˜¯æ²¡å¿…è¦çš„ã€‚</p>
<p>C. ç”¨è‡ªç„¶è¯­è¨€æè¿°è¿™ä¸ªå‡½æ•°æ˜¯è®¡ç®—ä»€ä¹ˆçš„ã€‚</p>
<p>è¿™æ®µä»£ç æŠŠ x ä¸­çš„ä½åè¿‡æ¥ï¼Œåˆ›é€ ä¸€ä¸ªé•œåƒã€‚å®ç°çš„æ–¹æ³•æ˜¯ï¼šå°† x çš„ä½ä»å·¦å¾€å³ç§»ï¼Œç„¶åå†å¡«å…¥è¿™äº›ä½ï¼Œå°±åƒæ˜¯æŠŠ val ä»å³å¾€å·¦ç§»ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-29"><a href="#ç»ƒä¹ é¢˜-3-29" class="headerlink" title="ç»ƒä¹ é¢˜ 3.29"></a>ç»ƒä¹ é¢˜ 3.29</h2><p>åœ¨ C è¯­è¨€ä¸­æ‰§è¡Œ continue è¯­å¥ä¼šå¯¼è‡´ç¨‹åºè·³åˆ°å½“å‰å¾ªç¯è¿­ä»£çš„ç»“å°¾ã€‚å½“å¤„ç† continue è¯­å¥æ—¶ï¼Œå°† for å¾ªç¯ç¿»è¯‘æˆ while å¾ªç¯çš„æè¿°è§„åˆ™éœ€è¦ä¸€äº›æ”¹è¿›ã€‚ä¾‹å¦‚ï¼Œå½“è€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Example of for loop containing a continue statement */</span></span><br><span class="line"><span class="comment">/* Sum even numbers between 0 and 9 */</span></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &amp; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    sum += i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. å¦‚æœæˆ‘ä»¬ç®€å•åœ°ç›´æ¥åº”ç”¨å°† for å¾ªç¯ç¿»è¯‘åˆ° while å¾ªç¯çš„è§„åˆ™ï¼Œä¼šå¾—åˆ°ä»€ä¹ˆå‘¢ï¼Ÿäº§ç”Ÿçš„ä»£ç ä¼šæœ‰ä»€ä¹ˆé”™è¯¯å‘¢ï¼Ÿ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Naive translation of for loop into while loop */</span></span><br><span class="line"><span class="comment">/* WARNING: This is buggy code */</span></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &amp; <span class="number">1</span>)</span><br><span class="line">        <span class="comment">/* This will cause an infinite loop */</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    sum += i;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å› ä¸º continue è¯­å¥ä¼šé˜»æ­¢ç´¢å¼•å˜é‡ i è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥è¿™æ®µä»£ç æ˜¯æ— é™å¾ªç¯ã€‚</p>
<p>B. å¦‚ä½•ç”¨ goto è¯­å¥æ¥æ›¿ä»£ continue è¯­å¥ï¼Œä¿è¯ while å¾ªç¯çš„è¡Œä¸ºåŒ for å¾ªç¯çš„è¡Œä¸ºå®Œå…¨ä¸€æ ·ï¼Ÿ</p>
<p>é€šç”¨çš„è§£å†³æ–¹æ³•æ˜¯ç”¨ goto è¯­å¥æ›¿ä»£ continue è¯­å¥ï¼Œå®ƒä¼šè·³è¿‡å¾ªç¯ä½“ä¸­ä½™ä¸‹çš„éƒ¨åˆ†ï¼Œç›´æ¥è·³åˆ° update éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Correct translation of for loop into while loop */</span></span><br><span class="line"><span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="type">long</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (i &lt; <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &amp; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">goto</span> update;</span><br><span class="line">    sum += i;</span><br><span class="line">    update:</span><br><span class="line">        i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-30ä¸‹é¢çš„-C-å‡½æ•°çœç•¥äº†-switch-è¯­å¥çš„ä¸»ä½“ã€‚åœ¨-C-ä»£ç ä¸­ï¼Œæƒ…å†µæ ‡å·æ˜¯ä¸è¿ç»­çš„ï¼Œè€Œæœ‰äº›æƒ…å†µæœ‰å¤šä¸ªæ ‡å·ã€‚"><a href="#ç»ƒä¹ é¢˜-3-30ä¸‹é¢çš„-C-å‡½æ•°çœç•¥äº†-switch-è¯­å¥çš„ä¸»ä½“ã€‚åœ¨-C-ä»£ç ä¸­ï¼Œæƒ…å†µæ ‡å·æ˜¯ä¸è¿ç»­çš„ï¼Œè€Œæœ‰äº›æƒ…å†µæœ‰å¤šä¸ªæ ‡å·ã€‚" class="headerlink" title="ç»ƒä¹ é¢˜ 3.30ä¸‹é¢çš„ C å‡½æ•°çœç•¥äº† switch è¯­å¥çš„ä¸»ä½“ã€‚åœ¨ C ä»£ç ä¸­ï¼Œæƒ…å†µæ ‡å·æ˜¯ä¸è¿ç»­çš„ï¼Œè€Œæœ‰äº›æƒ…å†µæœ‰å¤šä¸ªæ ‡å·ã€‚"></a>ç»ƒä¹ é¢˜ 3.30ä¸‹é¢çš„ C å‡½æ•°çœç•¥äº† switch è¯­å¥çš„ä¸»ä½“ã€‚åœ¨ C ä»£ç ä¸­ï¼Œæƒ…å†µæ ‡å·æ˜¯ä¸è¿ç»­çš„ï¼Œè€Œæœ‰äº›æƒ…å†µæœ‰å¤šä¸ªæ ‡å·ã€‚</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">switch2</span><span class="params">(<span class="type">long</span> x, <span class="type">long</span> *dest)</span> &#123;</span><br><span class="line">    <span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (x) &#123;</span><br><span class="line">        .</span><br><span class="line">        .  <span class="comment">// Body of switch statement omitted</span></span><br><span class="line">        .</span><br><span class="line">    &#125;</span><br><span class="line">    *dest = val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åœ¨ç¼–è¯‘è¯¥å‡½æ•°æ—¶ï¼ŒGCC ä¸ºç¨‹åºçš„åˆå§‹éƒ¨åˆ†ç”Ÿæˆäº†ä»¥ä¸‹æ±‡ç¼–ä»£ç ï¼Œå˜é‡ x åœ¨å¯„å­˜å™¨ <code>%rdi</code> ä¸­ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># void switch2(long x, long *dest)</span><br><span class="line"># x in %rdi</span><br><span class="line">switch2:</span><br><span class="line">    addq    $1, %rdi    # x = x + 1 ï¼Œç”±äºå°†ç´¢å¼•æ§åˆ¶åœ¨ 0 å¼€å§‹ï¼Œæ‰€ä»¥ x çš„æœ€å°å€¼æ˜¯ -1      </span><br><span class="line">    cmpq    $8, %rdi    # æ¯”è¾ƒ x - 8ï¼Œå…¶å®å°±æ˜¯ x + 1 - 8 &gt; 0 ï¼Œåˆ™åŸå§‹çš„ x æœ€å¤§æ ‡å·æ˜¯ 7       </span><br><span class="line">    ja      .L2         # è¶…è¿‡ 8 å°±è·³è½¬åˆ° L2ï¼ŒL2 ç›¸å½“äº default   </span><br><span class="line">    jmp     *.L4(, %rdi, 8)    # æ²¡æœ‰è¶…è¿‡ 8 å°±è¿›å…¥è·³è½¬è¡¨</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä¸ºè·³è½¬è¡¨ç”Ÿæˆä»¥ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.L4</span><br><span class="line">    quad:   .L9    # -1</span><br><span class="line">    quad:   .L5    # 0</span><br><span class="line">    quad:   .L6    # 1</span><br><span class="line">    quad:   .L7    # 2</span><br><span class="line">    quad:   .L2    # default</span><br><span class="line">    quad:   .L7    # 4</span><br><span class="line">    quad:   .L8    # 5</span><br><span class="line">    quad:   .L2    # default </span><br><span class="line">    quad:   .L5    # 7</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. switch è¯­å¥å†…æƒ…å†µæ ‡å·çš„å€¼åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>-1ã€0ã€1ã€2ã€4ã€5 å’Œ 7</p>
<p>B. C ä»£ç ä¸­å“ªäº›æƒ…å†µæœ‰å¤šä¸ªæ ‡å·ï¼Ÿ</p>
<p><code>.L5</code> çš„æƒ…å†µä¸º 0 å’Œ 7ï¼Œ<code>.L7</code> çš„æƒ…å†µæ ‡å·ä¸º 2 å’Œ 4ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-31"><a href="#ç»ƒä¹ é¢˜-3-31" class="headerlink" title="ç»ƒä¹ é¢˜ 3.31"></a>ç»ƒä¹ é¢˜ 3.31</h2><p>å¯¹äºä¸€ä¸ªé€šç”¨ç»“æ„çš„ C å‡½æ•° switcher:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">switcher</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b, <span class="type">long</span> c, <span class="type">long</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> val;</span><br><span class="line">    <span class="keyword">switch</span>(a) &#123;</span><br><span class="line">    <span class="keyword">case</span> ____:     <span class="comment">/* Case A */</span></span><br><span class="line">        c = ____;</span><br><span class="line">        <span class="comment">/* Fall through */</span></span><br><span class="line">    <span class="keyword">case</span> ____:     <span class="comment">/* Case B */</span></span><br><span class="line">        val = ____;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ____:     <span class="comment">/* Case C */</span></span><br><span class="line">    <span class="keyword">case</span> ____:     <span class="comment">/* Case D */</span></span><br><span class="line">        val = ____;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ____:     <span class="comment">/* Case E */</span></span><br><span class="line">        val = ____;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        val = ____;</span><br><span class="line">    &#125;</span><br><span class="line">    *dest = val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>GCC äº§ç”Ÿå¦‚ä¸‹æ‰€ç¤ºçš„æ±‡ç¼–ä»£ç å’Œè·³è½¬è¡¨ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221108153523592.png" alt="image-20221108153523592"></p>
<p>å¡«å†™ C ä»£ç ä¸­ç¼ºå¤±çš„éƒ¨åˆ†ã€‚é™¤äº†æƒ…å†µæ ‡å· C å’Œ D çš„é¡ºåºä¹‹å¤–ï¼Œå°†ä¸åŒæƒ…å†µå¡«å…¥è¿™ä¸ªæ¨¡æ¿çš„æ–¹å¼æ˜¯å”¯ä¸€çš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">switcher</span><span class="params">(<span class="type">long</span> a, <span class="type">long</span> b, <span class="type">long</span> c, <span class="type">long</span> *dest)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> val;</span><br><span class="line">    <span class="keyword">switch</span>(a) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:     <span class="comment">/* Case A */</span></span><br><span class="line">        c = b ^ <span class="number">15</span>;</span><br><span class="line">        <span class="comment">/* Fall through */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:     <span class="comment">/* Case B */</span></span><br><span class="line">        val = c + <span class="number">112</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> :     <span class="comment">/* Case C */</span></span><br><span class="line">    <span class="keyword">case</span> :     <span class="comment">/* Case D */</span></span><br><span class="line">        val =  (c + b) &lt;&lt; <span class="number">2</span> ;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> :     <span class="comment">/* Case E */</span></span><br><span class="line">        val = a;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        val = b;</span><br><span class="line">    &#125;</span><br><span class="line">    *dest = val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-32"><a href="#ç»ƒä¹ é¢˜-3-32" class="headerlink" title="ç»ƒä¹ é¢˜ 3.32"></a>ç»ƒä¹ é¢˜ 3.32</h2><p>ä¸‹é¢åˆ—å‡ºçš„æ˜¯ä¸¤ä¸ªå‡½æ•° first å’Œ last çš„åæ±‡ç¼–ä»£ç ï¼Œä»¥åŠ main å‡½æ•°è°ƒç”¨ first çš„ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Disassembly of last(long u, long v)</span><br><span class="line"># u in %rdi, v in %rsi</span><br><span class="line">0000000000400540 &lt;last&gt;:</span><br><span class="line">  400540:  48 89 f8          mov   %rdi, %rax     # L1: u</span><br><span class="line">  400543:  48 0f af c6       imul  %rsi, %rax     # L2: u*v</span><br><span class="line">  400547:  c3                req                  # L3: Return</span><br><span class="line">  </span><br><span class="line"># Disassembly of first(long x)</span><br><span class="line"># x in %rdi</span><br><span class="line">0000000000400548 &lt;first&gt;:</span><br><span class="line">   400548: 48 8d 77 01       lea   0x1(%rdi), %rsi  # F1: x+1</span><br><span class="line">   40054c: 48 83 ef 01       sub   $0x1, %rdi       # F2: x-1</span><br><span class="line">   400500: e8 eb ff ff ff    callq 400540 &lt;last&gt;    # F3: Call last(x-1, x+1)</span><br><span class="line">   400555: f3 c3             repz  retq             # F4: Return</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   400560: e8 e3 ff ff ff    callq 400548 &lt;first&gt;   # M1: Call first(10)</span><br><span class="line">   400565: 48 89 c2          mov   %rax, %rdx       # M2: Resume</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä» main è°ƒç”¨ first(10) å¼€å§‹ï¼Œåˆ°ç¨‹åºè¿”å› main æ—¶ä¸ºæ­¢ï¼Œå¡«å†™ä¸‹è¡¨è®°å½•æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">æŒ‡ä»¤</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
<th style="text-align:center">çŠ¶æ€å€¼</th>
<th style="text-align:center">(æŒ‡ä»¤æ‰§è¡Œå‰)</th>
<th style="text-align:center"></th>
<th style="text-align:center"></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">æ ‡å·</td>
<td style="text-align:center">PC</td>
<td style="text-align:center">æŒ‡ä»¤</td>
<td style="text-align:center">%rdi</td>
<td style="text-align:center">%rsi</td>
<td style="text-align:center">%rax</td>
<td style="text-align:center">%rsp</td>
<td style="text-align:center"><em>%rsp</em></td>
<td style="text-align:center">æè¿°</td>
</tr>
<tr>
<td style="text-align:center">M1</td>
<td style="text-align:center">0x400560</td>
<td style="text-align:center">callq</td>
<td style="text-align:center">10</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0x7fffffffe820</td>
<td style="text-align:center">-</td>
<td style="text-align:center">è°ƒç”¨ first(10)</td>
</tr>
<tr>
<td style="text-align:center">F1</td>
<td style="text-align:center">0x400548</td>
<td style="text-align:center">leq</td>
<td style="text-align:center">10</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0x7fffffffe818</td>
<td style="text-align:center">0x400565</td>
<td style="text-align:center">first çš„å…¥å£</td>
</tr>
<tr>
<td style="text-align:center">F2</td>
<td style="text-align:center">0x40054c</td>
<td style="text-align:center">sub</td>
<td style="text-align:center">10</td>
<td style="text-align:center">11</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0x7fffffffe818</td>
<td style="text-align:center">0x400565</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">F3</td>
<td style="text-align:center">0x400550</td>
<td style="text-align:center">callq</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0x7fffffffe810</td>
<td style="text-align:center">0x400565</td>
<td style="text-align:center">è°ƒç”¨ last(9, 11)</td>
</tr>
<tr>
<td style="text-align:center">L1</td>
<td style="text-align:center">0x400540</td>
<td style="text-align:center">mov</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">-</td>
<td style="text-align:center">0x7fffffffe810</td>
<td style="text-align:center">0x400555</td>
<td style="text-align:center">last çš„å…¥å£</td>
</tr>
<tr>
<td style="text-align:center">L2</td>
<td style="text-align:center">0x400543</td>
<td style="text-align:center">imul</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">9</td>
<td style="text-align:center">0x7fffffffe810</td>
<td style="text-align:center">0x400555</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">L3</td>
<td style="text-align:center">0x400547</td>
<td style="text-align:center">retq</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">99</td>
<td style="text-align:center">0x7fffffffe810</td>
<td style="text-align:center">0x400555</td>
<td style="text-align:center">ä» last è¿”å› 99</td>
</tr>
<tr>
<td style="text-align:center">F4</td>
<td style="text-align:center">0x400555</td>
<td style="text-align:center">repz repq</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">99</td>
<td style="text-align:center">0x7fffffffe818</td>
<td style="text-align:center">0x400565</td>
<td style="text-align:center">ä» first è¿”å› 99</td>
</tr>
<tr>
<td style="text-align:center">M2</td>
<td style="text-align:center">0x400565</td>
<td style="text-align:center">mov</td>
<td style="text-align:center">9</td>
<td style="text-align:center">11</td>
<td style="text-align:center">99</td>
<td style="text-align:center">0x7fffffffe820</td>
<td style="text-align:center">-</td>
<td style="text-align:center">ç»§ç»­æ‰§è¡Œ main</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-33"><a href="#ç»ƒä¹ é¢˜-3-33" class="headerlink" title="ç»ƒä¹ é¢˜ 3.33"></a>ç»ƒä¹ é¢˜ 3.33</h2><p>C å‡½æ•° <code>procprob</code> æœ‰ 4 ä¸ªå‚æ•° uã€aã€v å’Œ bï¼Œæ¯ä¸ªå‚æ•°è¦ä¹ˆæ˜¯ä¸€ä¸ªæœ‰ç¬¦å·æ•°ï¼Œè¦ä¹ˆæ˜¯ä¸€ä¸ªæŒ‡å‘æœ‰ç¬¦å·æ•°çš„æŒ‡é’ˆï¼Œè¿™é‡Œçš„æ•°å¤§å°ä¸åŒã€‚è¯¥å‡½æ•°çš„å‡½æ•°ä½“å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">*u += a;</span><br><span class="line">*v += b;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">sizeof</span>(a) + <span class="keyword">sizeof</span>(b);</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å¾—åˆ°å¦‚ä¸‹ x86-64 ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">procprob:</span><br><span class="line">  movslq  %edi, %rdi</span><br><span class="line">  addq    %rdi, (%rdx)</span><br><span class="line">  addb    %sil, (%rcx)</span><br><span class="line">  movl    $6, %eax</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>
<p>ç¡®å®š 4 ä¸ªå‚æ•°çš„åˆæ³•é¡ºåºå’Œç±»å‹ã€‚</p>
<p>å› ä¸ºä»£ç çš„ return é‡Œè¿”å›çš„æ˜¯ 6ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“ a å’Œ b ä¸¤ä¸ªæ•°ä¸€ä¸ªæ˜¯ 4 ä½é•¿ï¼Œä¸€ä¸ªæ˜¯ 2 ä½é•¿ã€‚</p>
<p>å‡å¦‚ a æ˜¯ 4 ä½é•¿åº¦ï¼Œ åˆ™ä¸€å¼€å§‹æ‰©å±• %edi ç¬¦å·å®é™…ä¸Šæ“ä½œçš„æ˜¯ aï¼Œ é‚£ä¹ˆä¹‹åæŠŠ a åŠ åˆ° (%rdx) ä¸Šè¾¹ï¼Œè¯´æ˜ %rdx ä¸­æ˜¯ uã€‚å¯¹åº”çš„ï¼Œ%sil ä¸­æ˜¯ bï¼Œ%rcx ä¸­æ˜¯ vã€‚</p>
<p>a é€šè¿‡ %edi ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼ŒæŠŠå®ƒä» 4 ä¸ªå­—èŠ‚è½¬æ¢æˆ 8 ä¸ªå­—èŠ‚ï¼Œå†åŠ åˆ° %rdx æŒ‡å‘çš„ 8 ä¸ªå­—èŠ‚ä¸Šã€‚è¿™å°±æ„å‘³ç€ a å¿…å®šæ˜¯ int ç±»å‹ï¼Œu ä¸€å®šæ˜¯ long <em> ç±»å‹ã€‚è¿˜å¯ä»¥çœ‹åˆ° b çš„ä½ä½å­—èŠ‚è¢«åŠ åˆ°äº† %rcx æŒ‡å‘çš„å­—èŠ‚ã€‚è¿™å°±æ„å‘³ç€ v ä¸€å®šæ˜¯ char </em> ã€‚</p>
<p>å‡å¦‚ b æ˜¯ 4 ä½é•¿åº¦,ï¼Œåˆ™ä¸€å¼€å§‹æ‰©å±• %edi ç¬¦å·å®é™…ä¸Šæ“ä½œçš„æ˜¯ b ï¼Œé‚£ä¹ˆä¹‹åæŠŠ b åŠ åˆ° (%rdx) ä¸Šè¾¹ï¼Œè¯´æ˜ %rdx ä¸­æ˜¯ vã€‚å¯¹åº”çš„ï¼Œ%sil ä¸­æ˜¯ aï¼Œ%rcx ä¸­æ˜¯ u ã€‚</p>
<p>æ‰€ä»¥ä¸¤ç§æƒ…å†µæ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">procprob</span><span class="params">(<span class="type">int</span> a, <span class="type">short</span> b, <span class="type">long</span> *u, <span class="type">char</span> *v)</span>`</span><br><span class="line"><span class="type">int</span> <span class="title function_">procprob</span><span class="params">(<span class="type">int</span> b, <span class="type">short</span> a, <span class="type">long</span> *v, <span class="type">char</span> *u)</span></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-34"><a href="#ç»ƒä¹ é¢˜-3-34" class="headerlink" title="ç»ƒä¹ é¢˜ 3.34"></a>ç»ƒä¹ é¢˜ 3.34</h2><p>ä¸€ä¸ªå‡½æ•° P ç”Ÿæˆåä¸º a0 ~ a7 çš„å±€éƒ¨å˜é‡ï¼Œç„¶åè°ƒç”¨å‡½æ•° Q ï¼Œæ²¡æœ‰å‚æ•°ã€‚GCC ä¸º P çš„ç¬¬ä¸€éƒ¨åˆ†äº§ç”Ÿå¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long P(long x)</span><br><span class="line"># x in %rdi</span><br><span class="line">P:</span><br><span class="line">    pushq   %r15</span><br><span class="line">    pushq   %r14</span><br><span class="line">    pushq   %r13</span><br><span class="line">    pushq   %r12</span><br><span class="line">    pushq   %rbp</span><br><span class="line">    pushq   %rbx    </span><br><span class="line"></span><br><span class="line">    subq    $24, %rsp      </span><br><span class="line"></span><br><span class="line">    movq    %rdi, %rbx     </span><br><span class="line">    leaq    1(%rdi), %r15  </span><br><span class="line">    leaq    2(%rdi), %r14  </span><br><span class="line">    leaq    3(%rdi), %r13  </span><br><span class="line">    leaq    4(%rdi), %r12  </span><br><span class="line">    leaq    5(%rdi), %rbp  </span><br><span class="line"></span><br><span class="line">    leaq    6(%rdi), %rax  </span><br><span class="line">    mov     %rax, (%rsp)   </span><br><span class="line">    leaq    7(%rdi), %rdx  </span><br><span class="line">    movq    %rdx, 8(%rsp)  </span><br><span class="line">    movl    $0, %eax       </span><br><span class="line">    call    Q              </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. ç¡®å®šå“ªäº›å±€éƒ¨å€¼å­˜å‚¨åœ¨è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ä¸­ã€‚</p>
<p>å±€éƒ¨å€¼ a0 ~ a5 åˆ†åˆ«ä¿å­˜è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ %rbxã€%r15ã€%r14ã€%13ã€%12 å’Œ %rbpã€‚</p>
<p>B. ç¡®å®šå“ªäº›å±€éƒ¨å˜é‡å­˜å‚¨åœ¨æ ˆä¸Šã€‚</p>
<p>å±€éƒ¨å€¼ a6 å’Œ a7 å­˜æ”¾åœ¨æ ˆä¸­ç›¸å¯¹äºæ ˆæŒ‡é’ˆåç§»é‡ä¸º 0 å’Œ 8 çš„åœ°æ–¹ã€‚</p>
<p>C. è§£é‡Šä¸ºä»€ä¹ˆä¸èƒ½æŠŠæ‰€æœ‰çš„å±€éƒ¨å€¼éƒ½å­˜å‚¨åœ¨è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ä¸­ã€‚</p>
<p>å­˜å‚¨å®Œ 6 ä¸ªå±€éƒ¨å˜é‡åï¼Œç¨‹åºç”¨å®Œäº†æ‰€æœ‰çš„è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼Œæ‰€ä»¥å‰©ä¸‹çš„ä¸¤ä¸ªå€¼ä¿å­˜åœ¨æ ˆä¸Šã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-35-ä¸€ä¸ªå…·æœ‰é€šç”¨ç»“æ„çš„-C-å‡½æ•°å¦‚ä¸‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-35-ä¸€ä¸ªå…·æœ‰é€šç”¨ç»“æ„çš„-C-å‡½æ•°å¦‚ä¸‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.35 ä¸€ä¸ªå…·æœ‰é€šç”¨ç»“æ„çš„ C å‡½æ•°å¦‚ä¸‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.35 ä¸€ä¸ªå…·æœ‰é€šç”¨ç»“æ„çš„ C å‡½æ•°å¦‚ä¸‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">rfun</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(______)&#123;</span><br><span class="line">        <span class="keyword">return</span> ______;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> nx = ______;</span><br><span class="line">    <span class="type">long</span> rv = rfun(nx);</span><br><span class="line">    <span class="keyword">return</span> ______;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>GCC äº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long rfun(unsigned long x)</span><br><span class="line"># x in %rdi</span><br><span class="line"></span><br><span class="line">rfun:</span><br><span class="line">    pushq   %rbx           </span><br><span class="line">    movq    %rdi, %rbx     </span><br><span class="line">    movl    %0, %eax       </span><br><span class="line">    testq   %rdi, %rdi     </span><br><span class="line">    je      .L2            </span><br><span class="line">    shrq    $2, %rdi       </span><br><span class="line">    callq   rfun           </span><br><span class="line">    addq    %rbx, %rax     </span><br><span class="line"></span><br><span class="line">  .L2</span><br><span class="line">    popq    %rbx           </span><br><span class="line">    ret                    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. rfun å­˜å‚¨åœ¨è¢«è°ƒç”¨è€…ä¿å­˜å™¨ %rbx ä¸­çš„å€¼æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>å¯„å­˜å™¨ %rbx ä¿å­˜å‚æ•° x çš„å€¼</p>
<p>B. å¡«å†™ä¸Šè¿° C ä»£ç ä¸­ç¼ºå¤±çš„è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">rfun</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> x)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(x == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> nx = x &gt;&gt; <span class="number">2</span>;</span><br><span class="line">	<span class="type">long</span> rv = rfun(nx);</span><br><span class="line">    <span class="keyword">return</span> x + rv ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-36"><a href="#ç»ƒä¹ é¢˜-3-36" class="headerlink" title="ç»ƒä¹ é¢˜ 3.36"></a>ç»ƒä¹ é¢˜ 3.36</h2><p>è€ƒè™‘ä¸‹é¢çš„å£°æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">short</span> S[<span class="number">7</span>];</span><br><span class="line"><span class="type">short</span> *T[<span class="number">3</span>];</span><br><span class="line"><span class="type">short</span> **U[<span class="number">6</span>];</span><br><span class="line"><span class="type">int</span>   V[<span class="number">8</span>];</span><br><span class="line"><span class="type">double</span> *W[<span class="number">4</span>];</span><br></pre></td></tr></table></figure>
<p>å¡«å†™ä¸‹è¡¨ï¼Œæè¿°æ¯ä¸ªæ•°ç»„çš„å…ƒç´ å¤§å°ã€æ•´ä¸ªæ•°ç»„çš„å¤§å°ä»¥åŠå…ƒç´  i çš„åœ°å€ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ•°ç»„</th>
<th style="text-align:center">å…ƒç´ å¤§å°</th>
<th style="text-align:center">æ•´ä¸ªæ•°ç»„çš„å¤§å°</th>
<th style="text-align:center">èµ·å§‹åœ°å€</th>
<th style="text-align:center">å…ƒç´  i</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">S</td>
<td style="text-align:center">2</td>
<td style="text-align:center">14</td>
<td style="text-align:center">$x_S$</td>
<td style="text-align:center">$x_S+2i$</td>
</tr>
<tr>
<td style="text-align:center">T</td>
<td style="text-align:center">8</td>
<td style="text-align:center">24</td>
<td style="text-align:center">$x_T$</td>
<td style="text-align:center">$x_T+8i$</td>
</tr>
<tr>
<td style="text-align:center">U</td>
<td style="text-align:center">8</td>
<td style="text-align:center">48</td>
<td style="text-align:center">$x_U$</td>
<td style="text-align:center">$x_U+8i$</td>
</tr>
<tr>
<td style="text-align:center">V</td>
<td style="text-align:center">4</td>
<td style="text-align:center">32</td>
<td style="text-align:center">$x_V$</td>
<td style="text-align:center">$x_V+4i$</td>
</tr>
<tr>
<td style="text-align:center">W</td>
<td style="text-align:center">8</td>
<td style="text-align:center">32</td>
<td style="text-align:center">$x_W$</td>
<td style="text-align:center">$x_W+8i$</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-37"><a href="#ç»ƒä¹ é¢˜-3-37" class="headerlink" title="ç»ƒä¹ é¢˜ 3.37"></a>ç»ƒä¹ é¢˜ 3.37</h2><p>å‡è®¾çŸ­æ•´å½¢æ•°ç»„ S çš„åœ°å€ $x_S$ å’Œæ•´æ•°ç´¢å¼• i åˆ†åˆ«å­˜æ”¾åœ¨å¯„å­˜å™¨ <code>%rdx</code> å’Œ <code>%rcx</code> ä¸­ã€‚å¯¹ä¸‹é¢æ¯ä¸ªè¡¨è¾¾å¼ï¼Œç»™å‡ºå®ƒçš„ç±»å‹ã€å€¼çš„è¡¨è¾¾å¼å’Œæ±‡ç¼–ä»£ç å®ç°ã€‚å¦‚æœç»“æœæ˜¯æŒ‡é’ˆçš„è¯ï¼Œè¦ä¿å­˜åœ¨å¯„å­˜å™¨ <code>%rax</code> ä¸­ï¼Œå¦‚æœæ•°æ®ç±»å‹ä¸º shortï¼Œå°±ä¿å­˜åœ¨å¯„å­˜å™¨å…ƒç´  <code>%ax</code> ä¸­ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">è¡¨è¾¾å¼</th>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">å€¼</th>
<th style="text-align:center">æ±‡ç¼–ä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>S + 1</code></td>
<td style="text-align:center">short*</td>
<td style="text-align:center">$x_S+2$</td>
<td style="text-align:center"><code>leaq 2(%rdx), %rax</code></td>
</tr>
<tr>
<td style="text-align:center"><code>S[3]</code></td>
<td style="text-align:center">short</td>
<td style="text-align:center">$M[x_S+6]$</td>
<td style="text-align:center"><code>movw 6(%rdx), %ax</code></td>
</tr>
<tr>
<td style="text-align:center"><code>&amp;S[i]</code></td>
<td style="text-align:center">short*</td>
<td style="text-align:center">$x_S+2i$</td>
<td style="text-align:center"><code>leaq (%rdx, %rcx, 2), %rax</code></td>
</tr>
<tr>
<td style="text-align:center"><code>S[4*i+1]</code></td>
<td style="text-align:center">short</td>
<td style="text-align:center">$M[x_S+8_i+2]$</td>
<td style="text-align:center"><code>movw 2(%rdx, %rcx, 8), %ax</code></td>
</tr>
<tr>
<td style="text-align:center"><code>S + i - 5</code></td>
<td style="text-align:center">short*</td>
<td style="text-align:center">$x_S+2iâˆ’10$</td>
<td style="text-align:center"><code>leaq -10(%rdx, %rcx, 2), %rax</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-38"><a href="#ç»ƒä¹ é¢˜-3-38" class="headerlink" title="ç»ƒä¹ é¢˜ 3.38"></a>ç»ƒä¹ é¢˜ 3.38</h2><p>è€ƒè™‘ä¸‹é¢çš„æºç ï¼Œå…¶ä¸­ M å’Œ N æ˜¯ç”¨ <code>#define</code> å£°æ˜çš„å¸¸æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> P[M][N];</span><br><span class="line"><span class="type">long</span> Q[N][M];</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">sum_element</span><span class="params">(<span class="type">long</span> i, <span class="type">long</span> j)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> P[i][j] + Q[j][i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ç¼–è¯‘è¿™ä¸ªç¨‹åºä¸­ï¼ŒGCC äº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long sum_element(long i, long j)</span><br><span class="line"># i in %rdi, j in %rsi</span><br><span class="line"></span><br><span class="line">sum_element:</span><br><span class="line">    leaq   0(,%rdi, 8),  %rdx       # %rdx = 8i</span><br><span class="line">    subq   %rdi, %rdx               # %rdx - i = 7i</span><br><span class="line">    addq   %rsi, %rdx               # %rdx = 7i + j</span><br><span class="line">    leaq   (%rsi, %rsi, 4), %rax    # %rax = 5j</span><br><span class="line">    addq   %rax, %rdi               # %rdi = i + 5j</span><br><span class="line">    movq   Q(, %rdi, 8), %rax       # M[xQ + 8(5j + i)]</span><br><span class="line">    movq   P(, %rdx, 8), %rax       # M[xP + 8(7i + j)]</span><br><span class="line">    ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿ç”¨é€†å‘å·¥ç¨‹æŠ€èƒ½ï¼Œæ ¹æ®è¿™æ®µæ±‡ç¼–ä»£ç ï¼Œç¡®å®š M å’Œ N çš„å€¼ã€‚</p>
<p>P æœ‰ 7 åˆ—ï¼ŒQ æœ‰ 5 åˆ—ï¼Œå¾—åˆ° <code>M=5</code> å’Œ <code>M=7</code> ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜3-39"><a href="#ç»ƒä¹ é¢˜3-39" class="headerlink" title="ç»ƒä¹ é¢˜3.39"></a>ç»ƒä¹ é¢˜3.39</h2><p>åˆ©ç”¨ç­‰å¼3.1æ¥è§£é‡Šå›¾3-37bçš„Cä»£ç ä¸­Aptrã€Bptrå’Œ Bendçš„åˆå§‹å€¼è®¡ç®—(ç¬¬3~5è¡Œ)æ˜¯å¦‚ä½•æ­£ç¡®åæ˜ fix_prod_eleçš„æ±‡ç¼–ä»£ç ä¸­å®ƒä»¬çš„è®¡ç®—(ç¬¬3~5è¡Œ)çš„ã€‚</p>
<p>å¯¹äºL=4ï¼ŒC=16å’Œj=0ï¼ŒæŒ‡é’ˆAptrç­‰äº$x_Aï¼‹4Ã—(16iï¼‹0)=x_A+64i$ã€‚</p>
<p>å¯¹äºL=4ï¼ŒC=16ï¼Œi=0å’Œj=kï¼ŒæŒ‡é’ˆ Bptrç­‰äº$x_B+4Ã—(16Ã—0+k)=x_B+4k$ã€‚</p>
<p>å¯¹äºL=4ï¼ŒC=16ï¼Œi=16å’Œj=kï¼ŒBendç­‰äº$x_B+4Ã—(16Ã—16+k)=x_B+1024+4k$ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-41è€ƒè™‘ä¸‹é¢çš„ç»“æ„å£°æ˜ï¼š"><a href="#ç»ƒä¹ é¢˜-3-41è€ƒè™‘ä¸‹é¢çš„ç»“æ„å£°æ˜ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.41è€ƒè™‘ä¸‹é¢çš„ç»“æ„å£°æ˜ï¼š"></a>ç»ƒä¹ é¢˜ 3.41è€ƒè™‘ä¸‹é¢çš„ç»“æ„å£°æ˜ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">prob</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> *p;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> x;</span><br><span class="line">        <span class="type">int</span> y;</span><br><span class="line">    &#125; s;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">prob</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå£°æ˜è¯´æ˜ä¸€ä¸ªç»“æ„å¯ä»¥åµŒå¥—åœ¨å¦ä¸€ä¸ªç»“æ„ä¸­ï¼Œå°±åƒæ•°ç»„å¯ä»¥åµŒå¥—åœ¨ç»“æ„ä¸­ã€æ•°ç»„å¯ä»¥åµŒå¥—åœ¨æ•°ç»„ä¸­ä¸€æ ·ã€‚</p>
<p>ä¸‹é¢çš„è¿‡ç¨‹ï¼ˆçœç•¥äº†æŸäº›è¡¨è¾¾å¼ï¼‰å¯¹è¿™ä¸ªç»“æ„è¿›è¡Œæ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sp_init</span><span class="params">(<span class="keyword">struct</span> prob *sp)</span> &#123;</span><br><span class="line">    sp-&gt;s.x = _____;</span><br><span class="line">    sp-&gt;p   = _____;</span><br><span class="line">    sp-&gt;next= _____;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>A. ä¸‹åˆ—å­—æ®µçš„åç§»é‡æ˜¯å¤šå°‘ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Ÿ</p>
<p>p: æŒ‡é’ˆ p æ˜¯ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåç§»é‡ä¸º 0<br>s.x: æ˜¯ç´§æ¥åœ¨ p ä¹‹åçš„ç»“æ„å†…ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåç§»é‡ä¸º 8<br>s.y: x çš„é•¿åº¦ä¸º 4ï¼Œæ‰€ä»¥åç§»é‡ä¸º 12<br>next: y çš„é•¿åº¦ä¸º 4ï¼Œæ‰€ä»¥åç§»é‡ä¸º 16</p>
<p>B. è¿™ä¸ªç»“æ„æ€»å…±éœ€è¦å¤šå°‘å­—èŠ‚ï¼Ÿ<br>æŒ‡é’ˆé•¿åº¦ä¸º 8ï¼Œintä¸º4ï¼Œæ€»å…±24å­—èŠ‚ã€‚</p>
<p>C. ç¼–è¯‘å™¨ä¸º <code>sp_init</code> çš„ä¸»ä½“äº§ç”Ÿçš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># void sp_init(struct prob *sp)</span><br><span class="line"># sp in %rdi</span><br><span class="line">sp_init:</span><br><span class="line">movl 12(%rdi), %eax     # Get sp-&gt;s.y</span><br><span class="line">movl %eax, 8(%rdi)      # Save in sp-&gt;s.x</span><br><span class="line">leaq 8(%rdi), %rax      # Compute &amp;(sp-&gt;s.x)</span><br><span class="line">movq %rax, (%rdi)       # Store in sp-&gt;p</span><br><span class="line">movq %rdi, 16(%rdi)     # Store sp in sp-&gt;next</span><br><span class="line">ret</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>æ ¹æ®è¿™äº›ä¿¡æ¯ï¼Œå¡«å†™ <code>sp_init</code> ä»£ç ä¸­ç¼ºå¤±çš„è¡¨è¾¾å¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sp_init</span><span class="params">(<span class="keyword">struct</span> prob *sp)</span> &#123;</span><br><span class="line">    sp-&gt;s.x = sp-&gt;s.y ;</span><br><span class="line">    sp-&gt;p   = &amp;(sp-&gt;s.x);</span><br><span class="line">    sp-&gt;next= sp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-42ä¸‹é¢çš„ä»£ç ç»™å‡ºäº†ç±»å‹-ELE-çš„ç»“æ„å£°æ˜ä»¥åŠå‡½æ•°-fun-çš„åŸå‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-42ä¸‹é¢çš„ä»£ç ç»™å‡ºäº†ç±»å‹-ELE-çš„ç»“æ„å£°æ˜ä»¥åŠå‡½æ•°-fun-çš„åŸå‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.42ä¸‹é¢çš„ä»£ç ç»™å‡ºäº†ç±»å‹ ELE çš„ç»“æ„å£°æ˜ä»¥åŠå‡½æ•° fun çš„åŸå‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.42ä¸‹é¢çš„ä»£ç ç»™å‡ºäº†ç±»å‹ ELE çš„ç»“æ„å£°æ˜ä»¥åŠå‡½æ•° fun çš„åŸå‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ELE</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> v;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ELE</span> *<span class="title">p</span>;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">fun</span><span class="params">(<span class="keyword">struct</span> ELE *ptr)</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å½“ç¼–è¯‘ fun çš„ä»£ç æ—¶ï¼ŒGCC ä¼šäº§ç”Ÿå¦‚ä¸‹æ±‡ç¼–ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># long fun(struct ELE *ptr)</span><br><span class="line"># ptr in %rdi</span><br><span class="line"></span><br><span class="line">fun:</span><br><span class="line">    movl   $0, %eax          # result = 0</span><br><span class="line">    jmp    .L2               # Goto middle</span><br><span class="line">  .L3:                       # loop:</span><br><span class="line">    addq   (%rdi), %rax      # result += ptr-&gt;v</span><br><span class="line">    movq   8(%rdi), %rdi     # ptr = ptr-&gt;p</span><br><span class="line">  .L2:                       # middle:</span><br><span class="line">    testq  %rdi, %rdi        # Test ptr</span><br><span class="line">    jne    .L3               # If != NULL, goto loop</span><br><span class="line">    rep; ret                </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>A. åˆ©ç”¨é€†å‘å·¥ç¨‹æŠ€å·§å†™å‡º fun çš„ C ä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">fun</span><span class="params">(<span class="keyword">struct</span> ELE *ptr)</span> &#123;</span><br><span class="line">	<span class="type">long</span> val = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(ptr)&#123;</span><br><span class="line">        val += ptr-&gt;v;</span><br><span class="line">        ptr = ptr-&gt;p;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>B. æè¿°è¿™ä¸ªç»“æ„å®ç°çš„æ•°æ®ç»“æ„ä»¥åŠ fun æ‰§è¡Œçš„æ“ä½œã€‚</p>
<p>æ¯ä¸ªç»“æ„éƒ½æ˜¯ä¸€ä¸ªå•é“¾è¡¨ä¸­çš„å…ƒç´ ï¼Œå­—æ®µ v æ˜¯å…ƒç´ çš„å€¼ï¼Œå­—æ®µ p æ˜¯æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚å‡½æ•° fun è®¡ç®—åˆ—è¡¨ä¸­å…ƒç´ å€¼çš„å’Œã€‚</p>
<h2 id="ä¹ é¢˜-3-43"><a href="#ä¹ é¢˜-3-43" class="headerlink" title="ä¹ é¢˜ 3.43"></a>ä¹ é¢˜ 3.43</h2><p>å‡è®¾ç»™ä½ ä¸ªä»»åŠ¡ï¼Œæ£€æŸ¥ä¸€ä¸‹ C ç¼–è¯‘å™¨ä¸ºç»“æ„å’Œè”åˆçš„è®¿é—®äº§ç”Ÿæ­£ç¡®çš„ä»£ç ã€‚ä½ å†™äº†ä¸‹é¢çš„ç»“æ„å£°æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">long</span> u;</span><br><span class="line">        <span class="type">short</span> v;</span><br><span class="line">        <span class="type">char</span> w;</span><br><span class="line">    &#125; t1;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> a[<span class="number">2</span>];</span><br><span class="line">        <span class="type">char</span> *p;</span><br><span class="line">    &#125; t2;</span><br><span class="line">&#125; u_type;</span><br></pre></td></tr></table></figure>
<p>ä½ å†™äº†ä¸€ç»„å…·æœ‰ä¸‹é¢è¿™ç§å½¢å¼çš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(u_type *up, type *dest)</span> &#123;</span><br><span class="line">    *dest = expr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç»„å‡½æ•°æœ‰ä¸ä¸€æ ·çš„è®¿é—®è¡¨è¾¾å¼ exprï¼Œè€Œä¸”æ ¹æ® expr çš„ç±»å‹æ¥è®¾ç½®ç›®çš„æ•°æ®ç±»å‹ type ã€‚ç„¶åå†æ£€æŸ¥ç¼–è¯‘è¿™äº›å‡½æ•°æ—¶äº§ç”Ÿçš„ä»£ç ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦ä¸ä½ é¢„æœŸçš„ä¸€æ ·ã€‚</p>
<p>å‡è®¾åœ¨è¿™äº›å‡½æ•°ä¸­ï¼Œup å’Œ dest åˆ†åˆ«è¢«åŠ è½½åˆ°å¯„å­˜å™¨ <code>%rdi</code> å’Œ <code>%rsi</code> ä¸­ã€‚å¡«å†™ä¸‹è¡¨ä¸­çš„æ•°æ®ç±»å‹ typeï¼Œå¹¶ç”¨ 1 ~ 3 æ¡æŒ‡ä»¤åºåˆ—æ¥è®¡ç®—è¡¨è¾¾å¼ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ° dest ä¸­ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>expr</th>
<th>type</th>
<th>ä»£ç </th>
</tr>
</thead>
<tbody>
<tr>
<td><code>up-&gt;t1.u</code></td>
<td>long</td>
<td><code>movq (%rdi), %rax movq %rax, (%rsi)</code></td>
</tr>
<tr>
<td><code>up-&gt;t1.v</code></td>
<td>short</td>
<td><code>movw 8(%rdi), %ax movw %ax, (%rsi)</code></td>
</tr>
<tr>
<td><code>&amp;up-&gt;t1.w</code></td>
<td>char*</td>
<td><code>addq $10, %rdi movq %rdi, (%rsi)</code></td>
</tr>
<tr>
<td><code>up-&gt;t2.a</code></td>
<td>int*</td>
<td><code>movq %rdi, (%rsi)</code></td>
</tr>
<tr>
<td><code>up-&gt;t2.a[up-&gt;t1.u]</code></td>
<td>int</td>
<td><code>movq (%rdi), %rax movl (%rdi, %rax, 4), %eax movl %eax, (%rsi)</code></td>
</tr>
<tr>
<td><code>*up-&gt;t2.p</code></td>
<td>char</td>
<td><code>movq 8(%rdi), %rax movb (%rax), %al movb %al, (%rsi)</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-44-å¯¹ä¸‹é¢æ¯ä¸ªç»“æ„å£°æ˜ï¼Œç¡®å®šæ¯ä¸ªå­—æ®µçš„åç§»é‡ï¼Œç»“æ„æ€»çš„å¤§å°ï¼Œä»¥åŠåœ¨-x86-64-ä¸‹å®ƒçš„å¯¹é½è¦æ±‚ï¼š"><a href="#ç»ƒä¹ é¢˜-3-44-å¯¹ä¸‹é¢æ¯ä¸ªç»“æ„å£°æ˜ï¼Œç¡®å®šæ¯ä¸ªå­—æ®µçš„åç§»é‡ï¼Œç»“æ„æ€»çš„å¤§å°ï¼Œä»¥åŠåœ¨-x86-64-ä¸‹å®ƒçš„å¯¹é½è¦æ±‚ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.44 å¯¹ä¸‹é¢æ¯ä¸ªç»“æ„å£°æ˜ï¼Œç¡®å®šæ¯ä¸ªå­—æ®µçš„åç§»é‡ï¼Œç»“æ„æ€»çš„å¤§å°ï¼Œä»¥åŠåœ¨ x86-64 ä¸‹å®ƒçš„å¯¹é½è¦æ±‚ï¼š"></a>ç»ƒä¹ é¢˜ 3.44 å¯¹ä¸‹é¢æ¯ä¸ªç»“æ„å£°æ˜ï¼Œç¡®å®šæ¯ä¸ªå­—æ®µçš„åç§»é‡ï¼Œç»“æ„æ€»çš„å¤§å°ï¼Œä»¥åŠåœ¨ x86-64 ä¸‹å®ƒçš„å¯¹é½è¦æ±‚ï¼š</h2><p>A. <code>struct P1 &#123;int i; char c; int j; char d&#125;;</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>i</th>
<th>c</th>
<th>j</th>
<th>d</th>
<th>æ€»å…±</th>
<th>å¯¹é½</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>4</td>
<td>8</td>
<td>12</td>
<td>16</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
<p>B. <code>struct P2 &#123;int i; char c; char d; long j&#125;;</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>i</th>
<th>c</th>
<th>d</th>
<th>j</th>
<th>æ€»å…±</th>
<th>å¯¹é½</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>4</td>
<td>5</td>
<td>8</td>
<td>16</td>
<td>8</td>
</tr>
</tbody>
</table>
</div>
<p>â€‹    C. <code>struct P3 &#123;short w[3]; char c[3]&#125;;</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>w</th>
<th>c</th>
<th>æ€»å…±</th>
<th>å¯¹é½</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>6</td>
<td>10</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
<p>D. <code>struct P4 &#123;short w[5]; char *c[3]&#125;;</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>w</th>
<th>c</th>
<th>æ€»å…±</th>
<th>å¯¹é½</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>16</td>
<td>40</td>
<td>8</td>
</tr>
</tbody>
</table>
</div>
<p>E. <code>struct P5 &#123;struct P3 a[2]; struct P2 t&#125;;</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>a</th>
<th>t</th>
<th>æ€»å…±</th>
<th>å¯¹é½</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>24</td>
<td>40</td>
<td>8</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-45"><a href="#ç»ƒä¹ é¢˜-3-45" class="headerlink" title="ç»ƒä¹ é¢˜ 3.45"></a>ç»ƒä¹ é¢˜ 3.45</h2><p>å¯¹äºä¸‹åˆ—ç»“æ„å£°æ˜å›ç­”åç»­é—®é¢˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>  *a;    </span><br><span class="line">    <span class="type">short</span>  b;    </span><br><span class="line">    <span class="type">double</span> c;   </span><br><span class="line">    <span class="type">char</span>   d;     </span><br><span class="line">    <span class="type">float</span>  e;    </span><br><span class="line">    <span class="type">char</span>   f;     </span><br><span class="line">    <span class="type">long</span>   g;     </span><br><span class="line">    <span class="type">int</span>    h;      </span><br><span class="line">&#125; rec;</span><br></pre></td></tr></table></figure>
<p>A. è¿™ä¸ªç»“æ„ä¸­æ‰€ä»¥çš„å­—æ®µçš„å­—èŠ‚åç§»é‡æ˜¯å¤šå°‘ï¼Ÿ</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>a</th>
<th>b</th>
<th>c</th>
<th>d</th>
<th>e</th>
<th>f</th>
<th>g</th>
<th>h</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤§å°</td>
<td>8</td>
<td>2</td>
<td>8</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>8</td>
<td>4</td>
</tr>
<tr>
<td>åç§»é‡</td>
<td>0</td>
<td>8</td>
<td>16</td>
<td>24</td>
<td>28</td>
<td>32</td>
<td>40</td>
<td>48</td>
</tr>
</tbody>
</table>
</div>
<p>B. è¿™ä¸ªç»“æ„æ€»çš„å¤§å°æ˜¯å¤šå°‘ï¼Ÿ</p>
<p>æ€»å…± 56 ä¸ªå­—èŠ‚é•¿ã€‚</p>
<p>C. é‡æ–°æ’åˆ—è¿™ä¸ªç»“æ„ä¸­çš„å­—æ®µï¼Œä»¥æœ€å°åŒ–æµªè´¹çš„ç©ºé—´ï¼Œç„¶åå†ç»™å‡ºé‡æ’è¿‡çš„ç»“æ„çš„å­—èŠ‚åç§»é‡å’Œæ€»çš„å¤§å°ã€‚</p>
<p>å½“æ‰€æœ‰çš„æ•°æ®å…ƒç´ çš„é•¿åº¦éƒ½æ˜¯ 2 çš„å¹‚æ—¶ï¼Œä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„ç­–ç•¥æ˜¯æŒ‰ç…§å¤§å°çš„é™åºæ’åˆ—ç»“æ„çš„å…ƒç´ ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>   *a;</span><br><span class="line">    <span class="type">double</span>  c; </span><br><span class="line">    <span class="type">long</span>    g;</span><br><span class="line">    <span class="type">float</span>   e;</span><br><span class="line">    <span class="type">int</span>     h;</span><br><span class="line">    <span class="type">short</span>   b;</span><br><span class="line">    <span class="type">char</span>    d;</span><br><span class="line">    <span class="type">char</span>    f;</span><br><span class="line">&#125; rec;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¾—åˆ°çš„åç¦»é‡å¦‚ä¸‹ï¼š</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>a</th>
<th>c</th>
<th>g</th>
<th>e</th>
<th>h</th>
<th>b</th>
<th>d</th>
<th>f</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¤§å°</td>
<td>8</td>
<td>8</td>
<td>8</td>
<td>4</td>
<td>4</td>
<td>2</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>åç§»é‡</td>
<td>0</td>
<td>8</td>
<td>16</td>
<td>24</td>
<td>28</td>
<td>32</td>
<td>34</td>
<td>35</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>è¿™ä¸ªç»“æ„è¦å¡«å…… 4 ä¸ªå­—èŠ‚ä»¥æ»¡è¶³ 8 å­—èŠ‚å¯¹é½çš„è¦æ±‚ï¼Œæ‰€ä»¥æ€»å…±æ˜¯ 40 ä¸ªå­—èŠ‚ã€‚</p>
</blockquote>
<h2 id="ç»ƒä¹ é¢˜-3-47"><a href="#ç»ƒä¹ é¢˜-3-47" class="headerlink" title="ç»ƒä¹ é¢˜ 3.47"></a>ç»ƒä¹ é¢˜ 3.47</h2><p>åœ¨è¿è¡Œ Linux ç‰ˆæœ¬ 2.6.16 çš„æœºå™¨ä¸Šè¿è¡Œæ ˆæ£€æŸ¥ä»£ç  10 000 æ¬¡ï¼Œæˆ‘ä»¬è·å¾—åœ°å€çš„èŒƒå›´ä»æœ€å°çš„ <code>0xffffb754</code> åˆ°æœ€å¤§çš„ <code>0xffffd754</code> ã€‚</p>
<p>A. åœ°å€çš„å¤§æ¦‚èŒƒå›´æ˜¯å¤šå¤§ï¼Ÿ</p>
<p><code>0xffffd754 - 0xffffd754 = 0x00002000</code> å¤§çº¦ $2^{13}$ ä¸ªåœ°å€çš„èŒƒå›´ã€‚</p>
<p>B. å¦‚æœæˆ‘ä»¬å°è¯•ä¸€ä¸ªæœ‰ 128 å­—èŠ‚ nop sled çš„ç¼“å†²åŒºæº¢å‡ºï¼Œè¦æƒ³ç©·å°½æ‰€æœ‰çš„èµ·å§‹åœ°å€ï¼Œéœ€è¦å°è¯•å¤šå°‘æ¬¡ï¼Ÿ</p>
<p>$2^7$ ä¸º 128ï¼Œ$2^{13}Ã·2^7=2^6$ ï¼Œéœ€è¦ 64 æ¬¡å°è¯•ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜3-49"><a href="#ç»ƒä¹ é¢˜3-49" class="headerlink" title="ç»ƒä¹ é¢˜3.49"></a>ç»ƒä¹ é¢˜3.49</h2><p>åœ¨è¿™é“é¢˜ä¸­ï¼Œæˆ‘ä»¬è¦æ¢ç©¶å›¾3-43bç¬¬5ï½11è¡Œä»£ç èƒŒåçš„é€»è¾‘ï¼Œå®ƒåˆ†é…äº†å˜é•¿å¤§å°çš„æ•°ç»„pã€‚æ­£å¦‚ä»£ç çš„æ³¨é‡Šè¡¨æ˜çš„ï¼Œ$s_1$è¡¨ç¤ºæ‰§è¡Œç¬¬4è¡Œçš„ subqæŒ‡ä»¤ä¹‹åæ ˆæŒ‡é’ˆçš„åœ°å€ã€‚è¿™æ¡æŒ‡ä»¤ä¸ºå±€éƒ¨å˜é‡iåˆ†é…ç©ºé—´ã€‚$s_2$è¡¨ç¤ºæ‰§è¡Œç¬¬4è¡Œçš„subq æŒ‡ä»¤ä¹‹åæ ˆæŒ‡é’ˆçš„å€¼ã€‚è¿™æ¡æŒ‡ä»¤ä¸ºå±€éƒ¨æ•°ç»„p åˆ†é…å­˜å‚¨ã€‚æœ€åï¼Œpè¡¨ç¤ºç¬¬10ï½11è¡Œçš„æŒ‡ä»¤èµ‹ç»™å¯„å­˜å™¨%r8å’Œ%rcxçš„å€¼ã€‚è¿™ä¸¤ä¸ªå¯„å­˜å™¨éƒ½ç”¨æ¥å¼•ç”¨æ•°ç»„pã€‚</p>
<p>å›¾3-44çš„å³è¾¹ç”»å‡ºäº†$s_1$ã€$s_2$å’ŒpæŒ‡ç¤ºçš„ä½ç½®ã€‚å›¾ä¸­è¿˜ç”»å‡ºäº†$s_2$å’Œpçš„å€¼ä¹‹é—´å¯èƒ½æœ‰ä¸€ä¸ªåç§»é‡ä¸º$e_2$å­—èŠ‚çš„ä½ç½®ï¼Œè¯¥ç©ºé—´æ˜¯æœªè¢«ä½¿ç”¨çš„ã€‚æ•°ç»„pçš„ç»“å°¾å’ŒsæŒ‡ç¤ºçš„ä½ç½®ä¹‹é—´è¿˜å¯èƒ½æœ‰ä¸€ä¸ªåç§»é‡ä¸º$e_1$å­—èŠ‚çš„åœ°æ–¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221110194157270.png" alt="image-20221110194157270"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/3-43b" alt="3-43b"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/os/image-20221110194231170.png" alt="image-20221110194231170"></p>
<p><strong>A.ç”¨æ•°å­¦è¯­è¨€è§£é‡Šç¬¬5ï½7è¡Œä¸­è®¡ç®—s2çš„é€»è¾‘ã€‚æç¤º:æƒ³æƒ³â€”16çš„ä½çº§è¡¨ç¤ºä»¥åŠå®ƒåœ¨ç¬¬6è¡ŒandqæŒ‡ä»¤ä¸­çš„ä½œç”¨ã€‚</strong></p>
<p>ç¬¬5è¡Œçš„leaqæŒ‡ä»¤è®¡ç®—å€¼8nï¼‹22ï¼Œç„¶åç¬¬6è¡Œçš„andqæŒ‡ä»¤æŠŠå®ƒå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„16çš„å€æ•°ã€‚å½“næ˜¯å¥‡æ•°æ—¶ï¼Œç»“æœå€¼ä¼šæ˜¯8n+8ï¼Œå½“næ˜¯å¶æ•°æ—¶ï¼Œç»“æœå€¼ä¼šæ˜¯8n+16ï¼Œè¿™ä¸ªå€¼å‡å»$s_1$å°±å¾—åˆ°$s_2$ã€‚</p>
<p><strong>è§£é‡Šï¼š</strong></p>
<p>ç¬¬5è¡Œæ±‡ç¼–å¾—åˆ°8n+22ã€‚</p>
<p>ç¬¬6è¡Œ8n+22ä¸ç«‹å³æ•°-16è¿›è¡Œä¸è¿ç®—ã€‚æŒ‰ç…§æœ€é«˜ä½ä¸ºç¬¦å·ä½æ¥è¯´ï¼Œ-16çš„äºŒè¿›åˆ¶ä¸º<code>1 0000</code>ï¼Œå› ä¸ºç¬¦å·æ‹“å±•å€¼ä¸å˜ï¼Œæ‰€ä»¥-16çš„8å­—èŠ‚è¡¨ç¤ºä¸º<code>.... 1111 0000</code>ï¼Œçœç•¥å·å…¨ä¸º1ã€‚æ‰€ä»¥ç¬¬6è¡Œæ˜¯è¦å°†8n+22ä¸<code>.... 1111 0000</code>è¿›è¡Œä¸è¿ç®—ï¼Œè¿™ä¼šå¯¼è‡´8n+22çš„ä½4ä½å¦‚æœè°æœ‰1éƒ½ä¼šè¢«èˆå¼ƒæ‰ï¼ŒåŸæ–‡æè¿°ä¸ºï¼šâ€œæŠŠå®ƒå‘ä¸‹èˆå…¥åˆ°æœ€æ¥è¿‘çš„16çš„å€æ•°â€ï¼Œå› ä¸ºæ˜¯èˆå¼ƒä½4ä½æ‰€ä»¥æ˜¯â€œå‘ä¸‹èˆå…¥â€ã€‚æŒ‰ç…§æœ¬äººæè¿°ä¸ºï¼šèˆå¼ƒæ‰æƒå€¼ä¸º8,4,2,1çš„äºŒè¿›åˆ¶ä½ï¼Œåªç•™ä¸‹æƒå€¼å¤§äºç­‰äº8çš„äºŒè¿›åˆ¶ä½ã€‚</p>
<p>æ‰€ä»¥ï¼Œä¸$-16è¿›è¡Œä¸è¿ç®—åï¼Œç»“æœå°†ä¼šæ˜¯16çš„å€æ•°ã€‚å€æ•°å¯èƒ½æ˜¯0,1â€¦</p>
<p>å½“nä¸ºå¶æ•°æ—¶ï¼Œå°†8n+22æ‹†åˆ†ä¸º8nå’Œ22ã€‚æ—¢ç„¶nä¸ºå¶æ•°ï¼Œåˆ™8nä¸º16çš„å€æ•°ï¼Œé‚£ä¹ˆ<code>8n and $-16 = 8n</code>ã€‚<code>22 and $-16 = 16</code>ã€‚å°†ä¸¤ä¸ªç»“æœåŠ èµ·æ¥å°±æ˜¯<code>8n + 16</code>ã€‚<br>å½“nä¸ºå¥‡æ•°æ—¶ï¼Œå°†8n+22æ‹†åˆ†ä¸º8(n-1)å’Œ30ã€‚æ—¢ç„¶n-1ä¸ºå¶æ•°ï¼Œåˆ™8(n-1)ä¸º16çš„å€æ•°ï¼Œé‚£ä¹ˆ<code>8(n-1) and $-16 = 8(n-1)</code>ã€‚<code>30 and $-16 = 16</code>ã€‚å°†ä¸¤ä¸ªç»“æœåŠ èµ·æ¥å°±æ˜¯8n + 8.</p>
<p>è¿˜æœ‰å°±æ˜¯è¿™ä¸ª22ï¼Œå…¶å®å¯ä»¥æ›¿æ¢ä¸º16-23ä¸­ä¸€ä¸ªæ•°éƒ½å¯ä»¥ï¼ŒæŠŠè¿™ä¸ªæ•°ç§°ä¸ºmï¼Œé‚£ä¹ˆè¦æ±‚mæˆ–è€…m+8åœ¨å’Œä¸<code>$-16</code>è¿›è¡Œä¸è¿ç®—åï¼Œç»“æœå¿…é¡»ä¸º16ï¼Œä»è¿™ä¸ªè¦æ±‚å°±å¯ä»¥å¾—å‡ºè¿™ä¸ªèŒƒå›´ã€‚</p>
<p><strong>B.ç”¨æ•°å­¦è¯­è¨€è§£é‡Šç¬¬8ï½10è¡Œä¸­è®¡ç®—pçš„é€»è¾‘ã€‚æç¤º:å¯ä»¥å‚è€ƒ2.3.7èŠ‚ä¸­æœ‰å…³é™¤ä»¥2çš„å¹‚çš„è®¨è®ºã€‚</strong></p>
<p>è¯¥åºåˆ—ä¸­çš„ä¸‰æ¡æŒ‡ä»¤å°†s2èˆå…¥åˆ°æœ€è¿‘çš„8çš„å€æ•°ã€‚å®ƒä»¬åˆ©ç”¨äº†2.3.7èŠ‚ä¸­å®ç°é™¤ä»¥â’‰çš„å¹‚ç”¨åˆ°çš„åç§»å’Œç§»ä½çš„ç»„åˆã€‚</p>
<p><strong>è§£é‡Šï¼š</strong></p>
<p>åœ¨ç¬¬8è¡Œï¼Œå°†%rspåŠ ä¸Š7å³$2^3-1$ï¼Œå‡è®¾%rspæ ˆæŒ‡é’ˆä¸ºxï¼Œåœ¨ç¬¬9è¡Œå³ç§»3ä½ï¼Œè¿™é‡Œå°†äº§ç”Ÿ$âŒˆx/2^3âŒ‰$å³$âŒˆx/8âŒ‰$ã€‚<br>ç¬¬10è¡Œä¹˜ä»¥8ï¼Œç›¸å½“äºå·¦ç§»3ä½ã€‚å¯ä»¥æƒ³è±¡ï¼Œå½“%rspåˆšå¥½æ˜¯8çš„å€æ•°æ—¶ï¼Œæ‰§è¡Œå®Œ8-10è¡Œï¼Œä¸å˜ï¼Œå› ä¸ºå‘ä¸Šå–æ•´æ—¶ä¸ºæœ¬èº«ã€‚å½“%rspä¸æ˜¯8çš„å€æ•°æ—¶ï¼Œæ‰§è¡Œå®Œ8-10è¡Œï¼Œä¸º%rsp+8ï¼Œå› ä¸ºå‘ä¸Šå–æ•´æ—¶åŠ 1äº†ã€‚</p>
<p>æ¢ä¸ªè§’åº¦ï¼Œ7çš„äºŒè¿›åˆ¶ä¸º111ï¼Œå½“%rspçš„ä½ä¸‰ä½æ˜¯000æ—¶ï¼ŒåŠ ä¸Š111ä¸ä¼šä½¿å¾—ç¬¬4ä½åŠ 1ï¼›å½“%rspçš„ä½ä¸‰ä½ä¸æ˜¯000è€Œæ˜¯å…¶ä»–æƒ…å†µæ—¶ï¼ŒåŠ ä¸Š111è‚¯å®šä½¿å¾—ç¬¬4ä½åŠ 1ã€‚ç„¶åç¬¬9,10è¡Œçš„æ“ä½œæ˜¯å…ˆå³ç§»3ä½ï¼Œå†å·¦ç§»3ä½ï¼Œè¿™å°±ç›¸å½“äºæŠŠä½3ä½çš„äºŒè¿›åˆ¶å€¼æ¸…0ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼šè¦ä¹ˆ%rspä¸å˜ï¼Œè¦ä¹ˆ%rspå‘ä¸Šèˆå…¥åˆ°æœ€æ¥è¿‘8çš„å€æ•°ã€‚</p>
<p><strong>C.å¯¹äºä¸‹é¢nå’Œ$s_1$çš„å€¼ï¼Œè·Ÿè¸ªä»£ç çš„æ‰§è¡Œï¼Œç¡®å®š$s_2$ã€$p$ã€$e_1$å’Œ$e_2$çš„ç»“æœå€¼ã€‚</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>n</th>
<th>$s_1$</th>
<th>$s_2$</th>
<th>$p$</th>
<th>$e_1$</th>
<th>$e_2$</th>
</tr>
</thead>
<tbody>
<tr>
<td>5</td>
<td>2065</td>
<td>2017</td>
<td>2024</td>
<td>1</td>
<td>7</td>
</tr>
<tr>
<td>6</td>
<td>2064</td>
<td>2000</td>
<td>2000</td>
<td>16</td>
<td>0</td>
</tr>
</tbody>
</table>
</div>
<p><strong>è§£é‡Šï¼š</strong></p>
<p>åœ¨ç¬¬7è¡Œæ±‡ç¼–åˆ†é…æ ˆç©ºé—´æ—¶ï¼Œæ˜¯å°†$e_1$å’Œ$e_2$å’Œæ•°ç»„çš„ç©ºé—´ä¸€èµ·è€ƒè™‘çš„äº†ã€‚</p>
<p>å½“ç¬¬10è¡Œæ±‡ç¼–æ‰§è¡Œï¼Œæ‰ä¼šç¡®å®šäº†$e_1$å’Œ$e_2$çš„å¤§å°ã€‚å› ä¸ºåªæœ‰è¿™ä¸ªæ—¶å€™æ‰çŸ¥é“äº†æ•°ç»„ç©ºé—´çš„å¼€å§‹åœ°å€å’Œç»“æŸåœ°å€ã€‚æ³¨æ„è¿™ä¸ªå›¾é‡Œé¢ï¼Œ$e_1$å’Œ$e_2$ä¸ä¸€å®šéƒ½æ˜¯8ä¸ªå­—èŠ‚ã€‚</p>
<p>å½“$s_1$ä¸ºåˆšå¥½ä¸º8çš„å€æ•°æ—¶,$e_1$å’Œ$e_2$å°±æ²¡ä»€ä¹ˆç”¨äº†ï¼Œèµ·ç ä¸éœ€è¦å®ƒä¿©æ¥8Kå¯¹é½äº†ï¼Œå› ä¸ºæœ¬æ¥å°±æ˜¯8Kå¯¹é½çš„ã€‚</p>
<p>å½“$s_1$ä¸æ˜¯8çš„å€æ•°æ—¶ï¼Œ$e_1$å’Œ$e_2$å¯ä»¥ç”¨æ¥ä¿è¯æ•°ç»„æ¯ä¸ªå…ƒç´ 8Kå¯¹é½ã€‚</p>
<p><strong>D.è¿™æ®µä»£ç ä¸º$s_2$å’Œpçš„å€¼æä¾›äº†ä»€ä¹ˆæ ·çš„å¯¹é½å±æ€§?</strong></p>
<p>å¯ä»¥çœ‹åˆ°$s_2$çš„è®¡ç®—æ–¹å¼ä¼šä¿ç•™$s_1$çš„åç§»é‡ä¸ºæœ€æ¥è¿‘çš„16çš„å€æ•°ã€‚è¿˜å¯ä»¥çœ‹åˆ°pä¼šä»¥8çš„å€æ•°å¯¹é½ï¼Œæ­£æ˜¯å¯¹8å­—èŠ‚å…ƒç´ æ•°ç»„å»ºè®®ä½¿ç”¨çš„ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-50"><a href="#ç»ƒä¹ é¢˜-3-50" class="headerlink" title="ç»ƒä¹ é¢˜ 3.50"></a>ç»ƒä¹ é¢˜ 3.50</h2><p>å¯¹äºä¸‹é¢çš„ C ä»£ç ï¼Œè¡¨è¾¾å¼ <code>val1</code> ~ <code>val4</code> åˆ†åˆ«å¯¹åº”ç¨‹åºå€¼ iã€fã€d å’Œ lï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">fcvt2</span><span class="params">(<span class="type">int</span> *ip, <span class="type">float</span> *fp, <span class="type">double</span> *dp, <span class="type">long</span> l)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = *ip;</span><br><span class="line">    <span class="type">float</span> f = *fp;</span><br><span class="line">    <span class="type">double</span> d = *dp;</span><br><span class="line">    *ip = (<span class="type">int</span>)     val1;</span><br><span class="line">    *fp = (<span class="type">float</span>)   val2;</span><br><span class="line">    *dp = (<span class="type">double</span>)  val3;</span><br><span class="line">    <span class="keyword">return</span> (<span class="type">double</span>) val4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®è¯¥å‡½æ•°å¦‚ä¸‹çš„ x86-64 ä»£ç ï¼Œç¡®å®šè¿™ä¸ªæ˜ å°„å…³ç³»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># double fcvt2(int *ip, float *fp, double *dp, long l)</span><br><span class="line"># ip in %rdi, fp in %rsi, dp in %rdx, l in %rcx</span><br><span class="line"># Result returned in %xmm0</span><br><span class="line"></span><br><span class="line">fcvt2:</span><br><span class="line">    movl        (%rdi), %eax        # æŠŠ ip çš„å€¼æ”¾å…¥ %eax</span><br><span class="line">    vmovss      (%rsi), %xmm0       # ä¼ é€å•ç²¾åº¦æ•°, æŠŠ fp æ”¾å…¥ %xmm0</span><br><span class="line">    vcvttsd2si  (%rdx), %r8d        # åŒç²¾åº¦è½¬ 32 ä½æ•´æ•°ï¼Œdp æ”¾å…¥ %r8d</span><br><span class="line">    movl        %r8d, (%rdi)        # è½¬æ¢åå†™å…¥ ip å¯¹åº”çš„å†…å­˜ä½ç½®</span><br><span class="line">    vcvtsi2ss   %eax, %xmm1, %xmm1  # 32 ä½æ•´æ•°è½¬å•ç²¾åº¦æµ®ç‚¹æ•°</span><br><span class="line">    vmovss      %xmm1, (%rsi)       # è½¬æ¢åå†™å…¥ fp å¯¹åº”çš„åœ°å€</span><br><span class="line">    vcvtsi2sdq  %rcx, %xmm1, %xmm1  # 64 ä½æ•´æ•°è½¬ä¸ºåŒç²¾åº¦æµ®ç‚¹</span><br><span class="line">    vmovsd      %xmm1, (%rdx)       # è½¬æ¢åå†™å…¥åˆ° dp å¯¹åº”çš„åœ°å€</span><br><span class="line">    vunpcklps   %xmm0, %xmm0, %xmm0 # å•ç²¾åº¦è½¬æ¢ä¸ºåŒç²¾åº¦</span><br><span class="line">    vcvtps2pd   %xmm0, %xmm0        </span><br><span class="line">    ret                             </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>å–å‡ºä½äº dp çš„å€¼ï¼Œè½¬æ¢æˆ intï¼Œå†å­˜å‚¨åˆ° ipã€‚å› æ­¤æ¨æ–­å‡º <code>val1</code> æ˜¯ dã€‚</li>
<li>å–å‡ºä½äº ip çš„å€¼ï¼Œè½¬æ¢æˆ floatï¼Œå†å­˜å‚¨åˆ° fpã€‚å› æ­¤æ¨æ–­å‡º <code>val2</code> æ˜¯ iã€‚</li>
<li>l çš„å€¼è½¬æ¢æˆ doubleï¼Œå¹¶å­˜å‚¨åœ¨ dpã€‚å› æ­¤æ¨æ–­å‡º <code>val3</code> æ˜¯ lã€‚</li>
<li>fp çš„å€¼è¢«è½¬æ¢æˆåŒç²¾åº¦ï¼Œå€¼é€šè¿‡å¯„å­˜å™¨ <code>%xmm0</code> è¿”å›ã€‚å› æ­¤æ¨æ–­å‡º <code>val4</code> æ˜¯ fã€‚</li>
</ul>
<h2 id="ç»ƒä¹ é¢˜-3-51"><a href="#ç»ƒä¹ é¢˜-3-51" class="headerlink" title="ç»ƒä¹ é¢˜ 3.51"></a>ç»ƒä¹ é¢˜ 3.51</h2><p>ä¸‹é¢çš„ C å‡½æ•°å°†ç±»å‹ä¸º <code>src_t</code> çš„å‚æ•°è½¬æ¢ä¸ºç±»å‹ä¸º <code>dst_t</code> çš„è¿”å›å€¼ï¼Œè¿™é‡Œä¸¤ç§å‚æ•°ç±»å‹éƒ½ç”¨ <code>typedef</code> å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">dest_t</span> <span class="title function_">cvt</span><span class="params">(<span class="type">src_t</span> x)</span>&#123;</span><br><span class="line">    <span class="type">dest_t</span> y = (<span class="type">dest_t</span>) x;</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ x86-64 ä¸Šæ‰§è¡Œè¿™æ®µä»£ç ï¼Œå‡è®¾å‚æ•° x åœ¨ <code>%xmm0</code> ä¸­ï¼Œæˆ–è€…åœ¨å¯„å­˜å™¨ <code>%rdi</code> çš„æŸä¸ªé€‚å½“çš„å‘½åä¸­ï¼ˆå³ <code>%rdi</code> æˆ– <code>%edi</code>ï¼‰ã€‚ç”¨ä¸€æ¡æˆ–ä¸¤æ¡æŒ‡ä»¤æ¥å®Œæˆç±»å‹è½¬æ¢ï¼Œå¹¶æŠŠç»“æœå€¼å¤åˆ¶åˆ°å¯„å­˜å™¨ <code>%rax</code> çš„æŸä¸ªé€‚å½“å‘½ä»¤éƒ¨åˆ†ä¸­ï¼ˆæ•´æ•°ç»“æœï¼‰ï¼Œæˆ– <code>%xmm0</code> ä¸­ï¼ˆæµ®ç‚¹ç»“æœï¼‰ã€‚ç»™å‡ºè¿™æ¡æˆ–è¿™äº›æŒ‡ä»¤ï¼ŒåŒ…æ‹¬æºå’Œç›®çš„å¯„å­˜å™¨ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>Tx</th>
<th>Ty</th>
<th>æŒ‡ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>long</td>
<td>double</td>
<td><code>vcvtsi2sdq %rdi, %xmm0</code></td>
</tr>
<tr>
<td>double</td>
<td>int</td>
<td><code>vcvvttsd2si %xmm0, %eax</code></td>
</tr>
<tr>
<td>double</td>
<td>float</td>
<td><code>vunpcklpd %xmm0, %xmm0, %xmm0 vcvtpd2ps %xmm0, %xmm0</code></td>
</tr>
<tr>
<td>long</td>
<td>float</td>
<td><code>vcvtsi2ssq %rdi, %xmm0, %xmm0</code></td>
</tr>
<tr>
<td>float</td>
<td>long</td>
<td><code>vcvttss2siq %xmm0, %rax</code></td>
</tr>
</tbody>
</table>
</div>
<h2 id="ç»ƒä¹ é¢˜-3-52"><a href="#ç»ƒä¹ é¢˜-3-52" class="headerlink" title="ç»ƒä¹ é¢˜ 3.52"></a>ç»ƒä¹ é¢˜ 3.52</h2><p>å¯¹äºä¸‹é¢æ¯ä¸ªå‡½æ•°å£°æ˜ï¼Œç¡®å®šå‚æ•°çš„å¯„å­˜å™¨åˆ†é…ï¼š</p>
<p>A. <code>double g1(double a, long b, float c, int d);</code></p>
<p>a åœ¨ <code>%xmm0</code> ï¼Œb åœ¨ <code>%rdi</code> ä¸­ï¼Œc åœ¨ <code>%xmm1</code> ä¸­ï¼Œd åœ¨ <code>%esi</code> ä¸­ã€‚</p>
<p>B. <code>double g2(int a, double *b, float *c, long d);</code></p>
<p>a åœ¨ <code>%edi</code> ä¸­ï¼Œb åœ¨ <code>%rsi</code> ä¸­ï¼Œc åœ¨ <code>%rdx</code> ä¸­ï¼Œd åœ¨ <code>%rcx</code> ä¸­ã€‚</p>
<p>C. <code>double g3(double *a, double b, int c, float d);</code></p>
<p>a åœ¨ <code>%rdi</code> ä¸­ï¼Œb åœ¨ <code>%xmm0</code> ä¸­ï¼Œc åœ¨ <code>%esi</code> ä¸­ï¼Œd åœ¨ <code>%xmm1</code> ä¸­ã€‚</p>
<p>D. <code>double g4(float a, int *b, float c, double d);</code></p>
<p>a åœ¨ <code>%xmm0</code> ä¸­ï¼Œb åœ¨ <code>%rdi</code> ä¸­ï¼Œc åœ¨ <code>%xmm1</code> ä¸­ï¼Œd åœ¨ <code>%xmm2</code> ä¸­ã€‚</p>
<h2 id="ç»ƒä¹ é¢˜-3-53"><a href="#ç»ƒä¹ é¢˜-3-53" class="headerlink" title="ç»ƒä¹ é¢˜ 3.53"></a>ç»ƒä¹ é¢˜ 3.53</h2><p>å¯¹äºä¸‹é¢çš„ C å‡½æ•°ï¼Œ4 ä¸ªå‚æ•°çš„ç±»å‹ç”± <code>typedef</code> å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">funct1</span><span class="params">(<span class="type">art1_t</span> p, <span class="type">arg2_t</span> q, <span class="type">arg3_t</span> r, <span class="type">arg4_t</span> s)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> p/(q+r) - s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘æ—¶ï¼ŒGCC äº§ç”Ÿå¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Assembly</span><br><span class="line"># double funct1(art1_t p, arg2_t q, arg3_t r, arg4_t s)</span><br><span class="line"># Refer to arguments as i1(%rdi), i2(%esi), f1(%xmm0), and f2(%xmm1)</span><br><span class="line"></span><br><span class="line">funct1:</span><br><span class="line">    vcvtsi2ssq      %rsi, %xmm2, %xmm2      # Get i2 and convert from long to float</span><br><span class="line">    vaddss          %xmm0, %xmm2, %xmm0     # Add f1 (type float)</span><br><span class="line">    vcvtsi2ss       %edi, %xmm2, %xmm2      # Get i1 and convert from int to float</span><br><span class="line">    vdivss          %xmm0, %xmm2, %xmm0     # Compute i1 / (i2 + f1)</span><br><span class="line">    vunpcklps       %xmm0, %xmm0, %xmm0</span><br><span class="line">    vcvtps2pd       %xmm0, %xmm0            # Convert to double</span><br><span class="line">    vsubsd          %xmm1, %xmm0, %xmm0     # Compute i1 / (i2 + f1) - f2(double)</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>ç¡®å®š 4 ä¸ªå‚æ•°ç±»å‹çš„å¯èƒ½ç»„åˆã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">funct1a</span><span class="params">(<span class="type">int</span> p, <span class="type">float</span> q, <span class="type">long</span> r, <span class="type">double</span> s)</span>;</span><br><span class="line"><span class="type">double</span> <span class="title function_">funct1b</span><span class="params">(<span class="type">int</span> p, <span class="type">long</span> q, <span class="type">float</span> r, <span class="type">double</span> s)</span>;</span><br></pre></td></tr></table></figure>
<h2 id="ç»ƒä¹ é¢˜-3-54-å‡½æ•°-func2-å…·æœ‰å¦‚ä¸‹åŸå‹ï¼š"><a href="#ç»ƒä¹ é¢˜-3-54-å‡½æ•°-func2-å…·æœ‰å¦‚ä¸‹åŸå‹ï¼š" class="headerlink" title="ç»ƒä¹ é¢˜ 3.54 å‡½æ•° func2 å…·æœ‰å¦‚ä¸‹åŸå‹ï¼š"></a>ç»ƒä¹ é¢˜ 3.54 å‡½æ•° <code>func2</code> å…·æœ‰å¦‚ä¸‹åŸå‹ï¼š</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">funct2</span><span class="params">(<span class="type">double</span> w, <span class="type">int</span> x, <span class="type">float</span> y, <span class="type">long</span> z)</span>;</span><br></pre></td></tr></table></figure>
<p>GCC ä¸ºè¯¥å‡½æ•°äº§ç”Ÿå¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Assembly</span><br><span class="line"># double funct2(double w, int x, float y,long z)</span><br><span class="line"># w in %xmm0, x in %edi, y in %xmm1, z in %rsi</span><br><span class="line"></span><br><span class="line">funct2:</span><br><span class="line">    vcvtsi2ss       %edi, %xmm2, %xmm2      # Convert x to float</span><br><span class="line">    vmulss          %xmm1, %xmm2, %xmm1     # Multiply by y</span><br><span class="line">    vunpcklps       %xmm1, %xmm1, %xmm1</span><br><span class="line">    vcvtps2pd       %xmm1, %xmm2            # Convert x*y to double</span><br><span class="line">    vcvtsi2sdq      %rsi, %xmm1, %xmm1      # Convert z to double</span><br><span class="line">    vdivsd          %xmm1, %xmm0, %xmm0     # Compute w/z</span><br><span class="line">    vsudsd          %xmm0, %xmm2, %xmm0     # Subtract from x*y</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure>
<p>å†™å‡º <code>funct2</code> çš„ C è¯­è¨€ç‰ˆæœ¬ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> <span class="title function_">funct2</span><span class="params">(<span class="type">double</span> w, <span class="type">int</span> x, <span class="type">float</span> y,<span class="type">long</span> z)</span>&#123;</span><br><span class="line">    <span class="type">float</span> temp = (<span class="type">float</span>) x;</span><br><span class="line">    y = y * temp;</span><br><span class="line">    <span class="type">double</span> temp2 = (<span class="type">double</span>) y;</span><br><span class="line">    <span class="type">double</span> temp3 = (<span class="type">double</span>) z;</span><br><span class="line">    w = w / temp3;</span><br><span class="line">    <span class="keyword">return</span> y - w;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">double</span> <span class="title function_">funct2</span><span class="params">(<span class="type">double</span> w, <span class="type">int</span> x, <span class="type">float</span> y,<span class="type">long</span> z)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> y * x - w / z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>æ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿç¬¬2ç« </tag>
        <tag>CSAPP</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API</title>
    <url>/2022/08/09/Linux/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80API/</url>
    <content><![CDATA[<h1 id="Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API"><a href="#Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API" class="headerlink" title="Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API"></a>Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€API</h1><p>å­¦ä¹ ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬äº”ç« Linuxç½‘ç»œç¼–ç¨‹åŸºç¡€APIï¼Œä¸ºäº†å°è±¡æ·±åˆ»ä¸€äº›ï¼Œå¤šåŠ¨æ‰‹å¤šå®è·µï¼Œæ‰€ä»¥è®°ä¸‹è¿™ä¸ªç¬”è®°ã€‚</p>
<span id="more"></span>
<h2 id="socketåœ°å€API"><a href="#socketåœ°å€API" class="headerlink" title="socketåœ°å€API"></a>socketåœ°å€API</h2><h3 id="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº"><a href="#ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº" class="headerlink" title="ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº"></a>ä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åº</h3><p>è®¡ç®—æœºç¡¬ä»¶æœ‰ä¸¤ç§å‚¨å­˜æ•°æ®çš„æ–¹å¼ï¼š<strong>å¤§ç«¯å­—èŠ‚åºï¼ˆbig endianï¼‰</strong>å’Œ<strong>å°ç«¯å­—èŠ‚åºï¼ˆlittle endianï¼‰</strong>ã€‚</p>
<ul>
<li><strong>å¤§ç«¯å­—èŠ‚åº</strong>ï¼šé«˜ä½å­—èŠ‚åœ¨å‰ï¼Œä½ä½å­—èŠ‚åœ¨åï¼Œç¬¦åˆäººç±»è¯»å†™æ•°å€¼çš„æ–¹æ³•ã€‚</li>
<li><strong>å°ç«¯å­—èŠ‚åº</strong>ï¼šä½ä½å­—èŠ‚åœ¨å‰ï¼Œé«˜ä½å­—èŠ‚åœ¨å</li>
</ul>
<p>æƒ³è¦åˆ¤åˆ«æœºå™¨çš„å­—èŠ‚åºå¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„ä»£ç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">byteorder</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">	&#123;</span></span><br><span class="line">		<span class="type">short</span> value;</span><br><span class="line">		<span class="type">char</span> union_bytes[<span class="keyword">sizeof</span>(<span class="type">short</span>)];</span><br><span class="line">	&#125; test;</span><br><span class="line">	test.value = <span class="number">0x0102</span>;</span><br><span class="line">	<span class="keyword">if</span> ((test.union_bytes[<span class="number">0</span>] == <span class="number">1</span>) &amp;&amp; (test.union_bytes[<span class="number">1</span>] == <span class="number">2</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;big endian\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> ((test.union_bytes[<span class="number">0</span>] == <span class="number">2</span>) &amp;&amp; (test.union_bytes[<span class="number">1</span>] == <span class="number">1</span>))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;little endian\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;unknown...\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	byteorder();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220809181538872.png" alt="image-20220809181538872"></p>
<p>è¿™æ®µä»£ç ä½¿ç”¨çš„åŸç†æ˜¯<strong>unionå˜é‡æ‰€å ç”¨çš„å†…å­˜é•¿åº¦ç­‰äºæœ€é•¿çš„æˆå‘˜çš„å†…å­˜é•¿åº¦ã€‚</strong></p>
<p>æ‰€ä»¥<code>test</code>ä¸­<code>value</code>å’Œ<code>union_bytes</code>æ˜¯å…±ç”¨ä¸€æ®µå†…å­˜çš„ã€‚å› ä¸ºåœ¨cä¸­<code>short</code>æ˜¯16ä½ä¹Ÿå°±æ˜¯2å­—èŠ‚ï¼Œ<code>char</code>æ˜¯8ä½ä¹Ÿå°±æ˜¯1å­—èŠ‚ï¼Œæ‰€ä»¥<code>union_bytes</code>æ•°ç»„çš„å¤§å°æ˜¯2ã€‚</p>
<p>æˆ‘ä»¬ç»™<code>value</code>èµ‹å€¼ä¸º<code>0x0102</code>ã€‚å¦‚æœæ˜¯æœºå™¨æ˜¯é«˜ä½å­˜å‚¨ï¼Œé‚£ä¹ˆ<code>union_bytes</code>æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å­˜å‚¨<code>0x01</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ å­˜å‚¨<code>0x02</code>ï¼Œå¦‚æœæ˜¯æœºå™¨æ˜¯é«˜ä½å­˜å‚¨ï¼Œé‚£ä¹ˆ<code>union_bytes</code>æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å­˜å‚¨<code>0x02</code>ï¼Œç¬¬äºŒä¸ªå…ƒç´ å­˜å‚¨<code>0x01</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220809185922374.png" alt="image-20220809185922374"></p>
<p>æ‰©å±•åˆ°32ä½ï¼Œå››å­—èŠ‚æ¥è¯´ä»¥<code>0x12345678</code>ä¸ºä¾‹ï¼Œé‚£ä¹ˆ</p>
<p><strong>å¤§ç«¯å­—èŠ‚åº</strong>ï¼š0x12345678</p>
<p><strong>å°ç«¯å­—èŠ‚åº</strong>ï¼š0x78563412</p>
<p>æ€»ç»“æ¥è¯´å°±æ˜¯å¤§ç«¯å­—èŠ‚åºå’Œå°ç«¯å­—èŠ‚åºçš„åŒºåˆ«å°±æ˜¯ä»¥<strong>å­—èŠ‚</strong>ä¸ºå•ä½çš„å­˜å‚¨æ–¹å¼ä¸åŒã€‚</p>
<p>åœ¨ç½‘ç»œä¸­ä¸¤å°ä½¿ç”¨ä¸åŒå­—èŠ‚åºçš„ä¸»æœºä¹‹é—´ç›´æ¥ä¼ é€’æ—¶ï¼Œæ¥æ”¶ç«¯å¿…ç„¶ä¼šé€ æˆé”™è¯¯ã€‚ä¹¦ä¸­è¯´è§£å†³çš„æ–¹æ³•æ˜¯å‘é€ç«¯æ€»æ˜¯æŠŠè¦å‘é€çš„æ•°æ®è½¬åŒ–æˆå¤§ç«¯å­—èŠ‚åºæ•°æ®å†å‘é€ï¼Œæ¥å—ç«¯çŸ¥é“ä¼ é€è¿‡æ¥çš„æ•°æ®æ€»æ˜¯é‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œæ‰€ä»¥æ¥æ”¶ç«¯æ ¹æ®è‡ªèº«é‡‡ç”¨çš„å­—èŠ‚åºå†å¯¹æ•°æ®è¿›è¡Œä¸€å®šçš„å¤„ç†ï¼ˆå°ç«¯è¿›è¡Œè½¬æ¢ï¼Œå¤§ç«¯å°±ä¸è½¬æ¢ï¼‰ã€‚</p>
<p>Linuxæä¾›äº†4ä¸ªå‡½æ•°æ¥å®Œæˆä¸»æœºå­—èŠ‚åºå’Œç½‘ç»œå­—èŠ‚åºä¹‹é—´çš„è½¬æ¢:</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810153657086.png" alt="image-20220810153657086"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ntohl</span> <span class="params">(<span class="type">uint32_t</span> __netlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">ntohs</span> <span class="params">(<span class="type">uint16_t</span> __netshort)</span>;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">htonl</span> <span class="params">(<span class="type">uint32_t</span> __hostlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">htons</span> <span class="params">(<span class="type">uint16_t</span> __hostshort)</span>;</span><br></pre></td></tr></table></figure>
<p>å®ƒä»¬çš„å«ä¹‰æ˜¯å°±æ˜¯é¦–å­—æ¯ç¼©å†™ï¼ˆè¿™è°çœ‹çš„å‡ºæ¥ï¼‰ï¼Œæ¯”å¦‚â€htonlâ€è¡¨ç¤ºâ€œhost to network longâ€ï¼Œå³å°†é•¿æ•´å‹ï¼ˆ32bitï¼‰çš„ä¸»æœºå­—èŠ‚åºæ•°æ®è½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åºæ•°æ®ã€‚è¿™å››ä¸ªå‡½æ•°ä¸­ï¼Œé•¿æ•´å‹<code>uint32_t</code>å‡½æ•°é€šå¸¸ç”¨æ¥è½¬æ¢IPåœ°å€ï¼ŒçŸ­æ•´å‹<code>uint16_t</code>å‡½æ•°ç”¨æ¥è½¬åŒ–ç«¯å£å·ã€‚</p>
<p>ç®€å•ç¤ºä¾‹å±•ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> port = <span class="number">258</span>;</span><br><span class="line">    <span class="type">uint16_t</span> p = htons(port);</span><br><span class="line">    port = ntohs(p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;htons :%u \n&quot;</span>, p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ntohs :%u \n&quot;</span>, port);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810181643405.png" alt="image-20220810181643405"></p>
<p><code>513</code>äºŒè¿›åˆ¶ï¼š<code>0000 0010 0000 0001</code></p>
<p><code>258</code>äºŒè¿›åˆ¶ï¼š<code>0000 0001 0000 0010</code></p>
<p>å¯ä»¥çœ‹å‡ºä¸¤è€…å­—èŠ‚åºæ˜¯ä¸åŒçš„</p>
<h3 id="socketåœ°å€"><a href="#socketåœ°å€" class="headerlink" title="socketåœ°å€"></a>socketåœ°å€</h3><h4 id="é€šç”¨socketåœ°å€"><a href="#é€šç”¨socketåœ°å€" class="headerlink" title="é€šç”¨socketåœ°å€"></a>é€šç”¨socketåœ°å€</h4><h5 id="sockaddr"><a href="#sockaddr" class="headerlink" title="sockaddr"></a>sockaddr</h5><p>socketç½‘ç»œæ¥å£ä¸­è¡¨ç¤ºsocketåœ°å€çš„æ˜¯ç»“æ„ä½“<code>sockaddr</code>ï¼Œä»–çš„å®šä¹‰åœ¨å¤´<code>&lt;bits/socket.h&gt;</code>ä¸­ï¼Œæˆ‘çœ‹åœ¨æˆ‘çš„ç”µè„‘ä¸Šçœ‹åˆ°çš„æ˜¯å¦‚ä¸‹çš„å®šä¹‰ï¼ˆå„ä¸ªç‰ˆæœ¬ä¸åŒï¼Œå¯èƒ½å®ç°ä¸åŒï¼Œæˆ‘è¿™é‡Œå’Œä¹¦ä¸Šå°±ä¸å¤§ç›¸åŒï¼‰ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810185029006.png" alt="image-20220810185029006"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing a generic socket address.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sa_);	<span class="comment">/* Common data: address family and length.  */</span></span><br><span class="line">    <span class="type">char</span> sa_data[<span class="number">14</span>];		<span class="comment">/* Address data.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>__SOCKADDR_COMMON</code>å®šä¹‰åœ¨<code>&lt;bits/sockaddr.h&gt;</code>ä¸­</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220810185204703.png" alt="image-20220810185204703"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/sockaddr.h&gt;</span></span></span><br><span class="line"><span class="comment">/* POSIX.1g specifies this type name for the `sa_family&#x27; member.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> <span class="type">sa_family_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This macro is used to declare the initial common members</span></span><br><span class="line"><span class="comment">   of the data types used for socket addresses, `struct sockaddr&#x27;,</span></span><br><span class="line"><span class="comment">   `struct sockaddr_in&#x27;, `struct sockaddr_un&#x27;, etc.  */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	__SOCKADDR_COMMON(sa_prefix) sa_family_t sa_prefix##family</span></span><br></pre></td></tr></table></figure>
<p><code>__SOCKADDR_COMMON</code>æ˜¯å®šä¹‰çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒè¿”å›ä¸€ä¸ª<code>sa_family_t</code>ç±»å‹çš„æ•°æ®ï¼Œæ•°æ®çš„åå­—æ˜¯<code>sa_prefixfamily</code>ï¼Œå…¶ä¸­<code>sa_prefix</code>æ˜¯ä½ ä¼ è¿›å»çš„å€¼ã€‚æ¯”å¦‚ï¼š<code>__SOCKADDR_COMMON (sa_)</code>å…¶å®å°±æ˜¯è¿”å›<code>sa_family_t sa_family</code>ã€‚</p>
<p>æ‰€ä»¥<code>sockaddr</code>å…¶å®å°±æ˜¯ä¸¤ä¸ªæˆå‘˜ï¼Œä¸€ä¸ªæ˜¯<code>sa_family_t</code>ï¼ˆåœ°å€æ—ï¼‰ç±»å‹çš„å˜é‡<code>sa_family</code>ï¼Œä¸€ä¸ª<code>char</code>æ•°ç»„ç±»å‹çš„å˜é‡<code>sa_data</code></p>
<p><code>sa_family_t</code>å¸¸è§çš„åè®®æ—ï¼ˆprotocol familyï¼Œä¹Ÿç§°domainï¼‰å’Œå¯¹åº”çš„åœ°å€æ—å¦‚ä¸‹è¡¨æ‰€ç¤º</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åè®®æ—</th>
<th style="text-align:center">åœ°å€æ—</th>
<th style="text-align:center">æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PF_UNIX</td>
<td style="text-align:center">AF_UNIX</td>
<td style="text-align:center">UNIXæœ¬åœ°åè®®æ—</td>
</tr>
<tr>
<td style="text-align:center">PF_INET</td>
<td style="text-align:center">AF_INET</td>
<td style="text-align:center">IPv4åè®®æ—</td>
</tr>
<tr>
<td style="text-align:center">PF_INET6</td>
<td style="text-align:center">AF_INET6</td>
<td style="text-align:center">IPv6åè®®æ—</td>
</tr>
</tbody>
</table>
</div>
<p>å®PF_*å’ŒAF_*éƒ½å®šä¹‰åœ¨<code>&lt;bits/socket.h&gt;</code>å½“ä¸­ï¼Œä¸¤è€…çš„å€¼ç›¸åŒï¼Œæ‰€ä»¥ä¸¤è€…å¯ä»¥æ··ç”¨</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811094342093.png" alt="image-20220811094342093"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811094510529.png" alt="image-20220811094510529"></p>
<p><code>sa_data</code>æˆå‘˜ç”¨äºå­˜æ”¾socketåœ°å€å€¼ã€‚ä¸åŒçš„åè®®æ—çš„åœ°å€å€¼æœ‰ä¸åŒçš„å«ä¹‰å’Œé•¿åº¦ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">åè®®æ—</th>
<th style="text-align:center">åœ°å€å€¼å«ä¹‰å’Œé•¿åº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">PF_UNIX</td>
<td style="text-align:center">æ–‡ä»¶çš„è·¯å¾„åï¼Œé•¿åº¦å¯è¾¾108å­—èŠ‚</td>
</tr>
<tr>
<td style="text-align:center">PF_INET</td>
<td style="text-align:center">16bitç«¯å£å·å’Œ32bit IPv4åœ°å€ï¼Œå…±6å­—èŠ‚</td>
</tr>
<tr>
<td style="text-align:center">PF_INET6</td>
<td style="text-align:center">16bitç«¯å£å·ï¼Œ32bitæµæ ‡è¯†ï¼Œ128bit IPv6åœ°å€ï¼Œ32bitèŒƒå›´IDï¼Œå…±26å­—èŠ‚</td>
</tr>
</tbody>
</table>
</div>
<h5 id="sockaddr-storage"><a href="#sockaddr-storage" class="headerlink" title="sockaddr_storage"></a>sockaddr_storage</h5><p>å¯ä»¥çœ‹å‡º14å­—èŠ‚çš„<code>sa_data</code>æ ¹æœ¬æ— æ³•å®¹çº³å¤šæ•°åè®®æ—çš„åœ°å€å€¼ã€‚æ‰€ä»¥ï¼ŒLinuxä¸­å®šä¹‰äº†æ–°çš„é€šç”¨socketåœ°å€ç»“æ„ä½“ï¼ˆå…¶å®å°±æ˜¯æŠŠå­˜æ”¾åœ°å€çš„æ•°ç»„åŠ å¤§äº†ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/socket.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure large enough to hold any socket address (with the historical</span></span><br><span class="line"><span class="comment">   exception of AF_UNIX).  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __ss_aligntype	unsigned long int</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SS_PADSIZE \</span></span><br><span class="line"><span class="meta">  (_SS_SIZE - __SOCKADDR_COMMON_SIZE - sizeof (__ss_aligntype))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (ss_);	<span class="comment">/* Address family, etc.  */</span></span><br><span class="line">    <span class="type">char</span> __ss_padding[_SS_PADSIZE];</span><br><span class="line">    __ss_aligntype __ss_align;	<span class="comment">/* Force desired alignment.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>_SS_SIZE</code>ã€<code>__SOCKADDR_COMMON_SIZE</code>åœ¨<code>&lt;bits/sockaddr.h&gt;</code>å½“ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/sockaddr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SOCKADDR_COMMON_SIZE	(sizeof (unsigned short int))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Size of struct sockaddr_storage.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _SS_SIZE 128</span></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811135111456.png" alt="image-20220811135111456"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811135134566.png" alt="image-20220811135134566"></p>
<p>è¿™ä¸ªç»“æ„ä½“æä¾›äº†è¶³å¤Ÿå¤§çš„ç©ºé—´ç”¨äºå­˜æ”¾åœ°å€å€¼ï¼Œå¹¶ä¸”æ˜¯å†…å­˜å¯¹é½çš„ã€‚</p>
<p><code>ss_</code>ï¼ˆå…¶å®æ˜¯<code>ss_family</code>ï¼‰æ˜¯<code>sa_family_t</code>ç±»å‹ï¼ˆä»‹ç»<code>sockaddr</code>æœ‰æåˆ°ï¼‰ï¼Œå³<code>unsigned short int</code>ç±»å‹ï¼Œ2å­—èŠ‚ã€‚</p>
<p><code>__ss_align</code>æ˜¯<code>__ss_aligntype</code>ç±»å‹ï¼Œå³<code>unsigned long int</code>ç±»å‹ï¼Œ4å­—èŠ‚</p>
<p><code>__ss_padding</code>æ˜¯<code>char</code>ç±»å‹æ•°ç»„ï¼Œå¤§å°ä¸º<code>_SS_PADSIZE</code>ï¼Œè€Œ<code>_SS_PADSIZE=_SS_SIZE - __SOCKADDR_COMMON_SIZE - sizeof (__ss_aligntype)=128-2-4=122</code>å­—èŠ‚ï¼Œå®Œå…¨è¶³å¤Ÿä¿å­˜åœ°å€å€¼ã€‚</p>
<p>ç»¼ä¸Š<code>sockaddr_storage</code>æ˜¯128å­—èŠ‚å¤§å°ï¼Œä¿è¯äº†å†…å­˜å¯¹é½ã€‚</p>
<h4 id="ä¸“ç”¨socketåœ°å€"><a href="#ä¸“ç”¨socketåœ°å€" class="headerlink" title="ä¸“ç”¨socketåœ°å€"></a>ä¸“ç”¨socketåœ°å€</h4><p>ä¸Šé¢ä¸¤ç§é€šç”¨çš„socketåœ°å€ä½¿ç”¨èµ·æ¥æ˜¾ç„¶ä¸å¤Ÿæ–¹ä¾¿ï¼Œå› ä¸ºå°†IPåœ°å€å’Œç«¯å£ç­‰ä¿¡æ¯ç›´æ¥æ”¾åœ¨åŒä¸€ä¸ª<code>char</code>æ•°ç»„ä¸­ï¼Œé‚£è¦å¾—åˆ°IPåœ°å€å’Œç«¯å£ä¿¡æ¯éƒ½å¾—è´¹å¥½å¤§åŠ²è¿›è¡Œæ“ä½œã€‚å› æ­¤ï¼ŒLinuxä¸ºå„ä¸ªåè®®æ—æä¾›äº†ä¸“é—¨çš„socketåœ°å€ç»“æ„ä½“ã€‚</p>
<p>UNIXæœ¬åœ°åè®®æ—ä½¿ç”¨<code>sockaddr_un</code>ï¼Œæ•°æ®ç»“æ„å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªä¿å­˜åœ°å€æ—ç±»å‹çš„<code>sun_</code>ï¼ˆå…¶å®æ˜¯<code>sun_family</code>ï¼‰å’Œä¿å­˜æ–‡ä»¶ä½ç½®çš„<code>sun_path</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing the address of an AF_LOCAL (aka AF_UNIX) socket.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sun_);</span><br><span class="line">    <span class="type">char</span> sun_path[<span class="number">108</span>];		<span class="comment">/* Path name.  */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>IPv4åè®®æ—ä½¿ç”¨<code>sockaddr_in</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Structure describing an Internet socket address.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sin_);</span><br><span class="line">    <span class="type">in_port_t</span> sin_port;			<span class="comment">/* Port number.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span>		<span class="comment">/* Internet address.  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Pad to size of `struct sockaddr&#x27;.  */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> sin_zero[<span class="keyword">sizeof</span> (<span class="keyword">struct</span> sockaddr)</span><br><span class="line">			   - __SOCKADDR_COMMON_SIZE</span><br><span class="line">			   - <span class="keyword">sizeof</span> (<span class="type">in_port_t</span>)</span><br><span class="line">			   - <span class="keyword">sizeof</span> (<span class="keyword">struct</span> in_addr)];</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>in_port_t</code>å®šä¹‰ã€<code>in_addr_t</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Type to represent a port.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint16_t</span> <span class="type">in_port_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Internet address.  */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">uint32_t</span> <span class="type">in_addr_t</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="type">in_addr_t</span> s_addr;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143542024.png" alt="image-20220811143542024"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143600470.png" alt="image-20220811143600470"></p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811143622907.png" alt="image-20220811143622907"></p>
<p>å¯ä»¥çœ‹çš„å‡ºæ¥<code>sin_</code>ï¼ˆå…¶å®æ˜¯<code>sin_family</code>ï¼‰å­˜æ”¾åœ°å€æ—ç±»å‹ï¼Œ<code>sin_port</code>å­˜æ”¾ç«¯å£ï¼Œ<code>sin_addr</code>å­˜æ”¾åœ°å€ã€‚<code>sin_zero</code>ä¸ºäº†è®©<code>sockaddr_in</code>å¤§å°å’Œ<code>sockaddr</code>ç›¸åŒï¼Œä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªæˆå‘˜ï¼Œä¸ªäººæ„Ÿè§‰è¿™æ˜¯å› ä¸ºæ‰€ä»¥<strong>ä¸“ç”¨socket</strong>åœ¨å®é™…ä½¿ç”¨ä¸­éƒ½éœ€è¦è½¬åŒ–ä¸º<strong>é€šç”¨socketåœ°å€ç±»å‹</strong><code>socketaddr</code>ï¼Œå› ä¸ºsocketç¼–ç¨‹æ¥å£ä½¿ç”¨çš„æ˜¯å‚æ•°ç±»å‹æ˜¯<code>socketaddr</code>ã€‚</p>
<p>IPv6åè®®æ—ä½¿ç”¨<code>sockaddr_in6</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Ditto, for IPv6.  */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in6</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    __SOCKADDR_COMMON (sin6_);</span><br><span class="line">    <span class="type">in_port_t</span> sin6_port;	<span class="comment">/* Transport layer port # */</span></span><br><span class="line">    <span class="type">uint32_t</span> sin6_flowinfo;	<span class="comment">/* IPv6 flow information */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span> <span class="title">sin6_addr</span>;</span>	<span class="comment">/* IPv6 address */</span></span><br><span class="line">    <span class="type">uint32_t</span> sin6_scope_id;	<span class="comment">/* IPv6 scope-id */</span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>in6_addr</code>å¦‚ä¸‹ï¼Œå› ä¸ºIPv6ä¸æ˜¯å­¦ä¹ é‡ç‚¹ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šå±•å¼€ä»‹ç»ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* IPv6 address */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in6_addr</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">	<span class="type">uint8_t</span>	__u6_addr8[<span class="number">16</span>];</span><br><span class="line">	<span class="type">uint16_t</span> __u6_addr16[<span class="number">8</span>];</span><br><span class="line">	<span class="type">uint32_t</span> __u6_addr32[<span class="number">4</span>];</span><br><span class="line">      &#125; __in6_u;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> s6_addr			__in6_u.__u6_addr8</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __USE_MISC</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> s6_addr16		__in6_u.__u6_addr16</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> s6_addr32		__in6_u.__u6_addr32</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>é™¤æ­¤ä¹‹å¤–éœ€è¦æ³¨æ„ï¼šæ‰€æœ‰<strong>ä¸“ç”¨socketåœ°å€</strong>ï¼ˆä»¥åŠ<code>sockaddr_storage</code>ï¼‰ç±»å‹çš„å˜é‡åœ¨å®é™…ä½¿ç”¨æ—¶éƒ½éœ€è¦è½¬åŒ–ä¸º<strong>é€šç”¨socketåœ°å€</strong>ç±»å‹<code>sockaddr</code>ï¼ˆå¼ºåˆ¶è½¬æ¢å³å¯)ï¼Œå› ä¸ºæ‰€æœ‰socketç¼–ç¨‹æ¥å£ä½¿ç”¨çš„åœ°å€å‚æ•°çš„ç±»å‹éƒ½æ˜¯sockaddrã€‚</p>
<h3 id="IPåœ°å€è½¬åŒ–å‡½æ•°"><a href="#IPåœ°å€è½¬åŒ–å‡½æ•°" class="headerlink" title="IPåœ°å€è½¬åŒ–å‡½æ•°"></a>IPåœ°å€è½¬åŒ–å‡½æ•°</h3><p>é€šå¸¸æ¥è¯´ï¼Œäººä»¬æ›´å–œæ¬¢ç”¨ç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²æ¥è¡¨ç¤ºIPv4åœ°å€ï¼Œä½†æ˜¯åœ¨ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªå­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•´æ•°æ‰èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯è¾“å‡ºçš„æ—¶å€™æˆ‘ä»¬åˆéœ€è¦æŠŠæ•´æ•°è½¬åŒ–æˆç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·æ–¹ä¾¿è§‚å¯Ÿã€‚æ‰€ä»¥ç³»ç»Ÿæä¾›äº†3ä¸ªå‡½æ•°ç”¨äºç‚¹åˆ†åè¿›åˆ¶çš„å­—ç¬¦ä¸²IPv4åœ°å€å’Œæ•´æ•°çš„IPv4åœ°å€ä¹‹é—´çš„è½¬åŒ–ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet host address from numbers-and-dots notation in CP</span></span><br><span class="line"><span class="comment">   into binary data in network byte order.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">in_addr_t</span> <span class="title function_">inet_addr</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__cp)</span> __THROW;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet host address from numbers-and-dots notation in CP</span></span><br><span class="line"><span class="comment">   into binary data and store the result in the structure INP.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">inet_aton</span> <span class="params">(<span class="type">const</span> <span class="type">char</span> *__cp, <span class="keyword">struct</span> in_addr *__inp)</span> __THROW;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert Internet number in IN to ASCII representation.  The return value</span></span><br><span class="line"><span class="comment">   is a pointer to an internal array containing the string.  */</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> *<span class="title function_">inet_ntoa</span> <span class="params">(<span class="keyword">struct</span> in_addr __in)</span> __THROW;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>inet_addr</code>å‡½æ•°å°†ç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€è½¬åŒ–ä¸ºç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPv4åœ°å€ã€‚å®ƒå¤±è´¥æ—¶è¿”å› <code>INADDR_NONE</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">in_addr_t</span> ip = <span class="built_in">inet_addr</span>(<span class="string">&quot;192.168.167.14&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (ip == INADDR_NONE)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_addr %u \n&quot;</span>, ip);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811170759741.png" alt="image-20220811170759741"></p>
<p><code>inet_aton</code>åŠŸèƒ½å’Œ<code>inet_addr</code>ç›¸åŒï¼Œä½†æ˜¯å°†ç»“æœå­˜åœ¨åœ¨<code>in_addr_t</code>æŒ‡å‘çš„åœ°å€ç»“æ„å½“ä¸­ï¼Œå‡½æ•°æˆåŠŸè¿”å›1ï¼Œå¤±è´¥è¿”å›0ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_aton %u \n&quot;</span>, ip.s_addr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811171444397.png" alt="image-20220811171444397"></p>
<p><code>inet_ntoa</code>å‡½æ•°å°†æ•´æ•°çš„IPv4åœ°å€è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²çš„IPv4ã€‚æˆåŠŸæ—¶è¿”å›è½¬æ¢çš„å­—ç¬¦ä¸²åœ°å€å€¼ï¼Œå¤±è´¥æ—¶è¿”å›-1ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_aton %u \n&quot;</span>, ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip_str = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811173503409.png" alt="image-20220811173503409"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>inet_ntoa</code>å‡½æ•°å†…éƒ¨ä½¿ç”¨ä¸€ä¸ªé™æ€å˜é‡å­˜å‚¨è½¬åŒ–çš„ç»“æœï¼Œå‡½æ•°çš„è¿”å›å€¼æŒ‡å‘è¯¥é™æ€å†…å­˜ï¼Œå› æ­¤<code>inet_ntoa</code>æ˜¯ä¸å¯é‡å…¥çš„ï¼Œè¿™ä¸€ç‚¹éœ€è¦å¤šæ³¨æ„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> ip;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.14&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="type">char</span> *ip_str1 = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">inet_aton</span>(<span class="string">&quot;192.168.167.15&quot;</span>, &amp;ip);</span><br><span class="line">    <span class="type">char</span> *ip_str2 = <span class="built_in">inet_ntoa</span>(ip);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811180430697.png" alt="image-20220811180430697"></p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸‹é¢ä¸¤ä¸ªå‡½æ•°ä¹Ÿèƒ½å®Œæˆå‰ä¸‰ä¸ªå‡½æ•°çš„åŠŸèƒ½</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Convert from presentation format of an Internet number in buffer</span></span><br><span class="line"><span class="comment">   starting at CP to the binary network format and store result for</span></span><br><span class="line"><span class="comment">   interface type AF in buffer starting at BUF.  */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">int</span> <span class="title">inet_pton</span> <span class="params">(<span class="type">int</span> __af, <span class="type">const</span> <span class="type">char</span> *__restrict __cp,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="type">void</span> *__restrict __buf)</span> __THROW</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Convert a Internet address in binary network format for interface</span></span><br><span class="line"><span class="comment">   type AF in buffer starting at CP to presentation form and place</span></span><br><span class="line"><span class="comment">   result in buffer of length LEN astarting at BUF.  */</span></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">char</span> *<span class="title">inet_ntop</span> <span class="params">(<span class="type">int</span> __af, <span class="type">const</span> <span class="type">void</span> *__restrict __cp,</span></span></span><br><span class="line"><span class="params"><span class="function">			      <span class="type">char</span> *__restrict __buf, <span class="type">socklen_t</span> __len)</span></span></span><br><span class="line"><span class="function">     __THROW</span>;</span><br></pre></td></tr></table></figure>
<p><code>inet_pton</code>å‡½æ•°å°†ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºçš„Påœ°å€<code>__cp</code>ï¼ˆç”¨ç‚¹åˆ†åè¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv4åœ°å€æˆ–ç”¨åå…­è¿›åˆ¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPv6åœ°å€ï¼‰è½¬æ¢æˆç”¨ç½‘ç»œå­—èŠ‚åºæ•´æ•°è¡¨ç¤ºçš„IPåœ°å€ï¼Œå¹¶æŠŠè½¬æ¢ç»“æœå­˜å‚¨äº<code>__buf</code>æŒ‡å‘çš„å†…å­˜ä¸­ã€‚å…¶ä¸­ï¼Œ<code>__af</code>å‚æ•°æŒ‡å®šåœ°å€æ—ï¼Œå¯ä»¥æ˜¯<code>AF_INET</code>æˆ–è€…<code>AF_INET6</code>ã€‚<code>inet_pton</code>æˆåŠŸæ—¶è¿”å›1ï¼Œå¤±è´¥åˆ™è¿”å›0å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>__restrict</code>emmmç›®å‰æ‰¾ä¸åˆ°å®šä¹‰ï¼Œä½†æ˜¯çœ‹äº†ä¸‹<code>restrict</code>å…³é”®å­—ï¼Œæ˜¯æŒ‡å‘Šè¯‰ç¼–è¯‘å™¨ä¼ å…¥çš„ä¸¤ä¸ªæŒ‡é’ˆä¸æŒ‡å‘åŒä¸€æ•°æ®ï¼Œæ–¹ä¾¿è¿›è¡Œä¼˜åŒ–ç”¨æ¥æå‡æ€§èƒ½ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ip_str[] = <span class="string">&quot;192.168.167.42&quot;</span>;</span><br><span class="line">    <span class="type">in_addr_t</span> ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, ip);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> in_ip;</span><br><span class="line">    ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;in_ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, in_ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811183002035.png" alt="image-20220811183002035"></p>
<p><code>inet_ntop</code>å‡½æ•°è¿›è¡Œç›¸åçš„è½¬æ¢ï¼Œå‰ä¸‰ä¸ªå‚æ•°çš„å«ä¹‰ä¸<code>inet_pton</code>çš„å‚æ•°ç›¸åŒï¼Œæœ€åä¸€ä¸ªå‚æ•° <code>__len</code>æŒ‡å®šç›®æ ‡å­˜å‚¨å•å…ƒçš„å¤§å°ã€‚ä¸‹é¢çš„ä¸¤ä¸ªå®èƒ½å¸®åŠ©æˆ‘ä»¬æŒ‡å®šè¿™ä¸ªå¤§å°(åˆ†åˆ«ç”¨äºIPv4å’ŒIPv6):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span>	</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INET_ADDRSTRLEN 16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INET6_ADDRSTRLEN 46</span></span><br></pre></td></tr></table></figure>
<p><code>inet_ntop</code>æˆåŠŸæ—¶è¿”å›ç›®æ ‡å­˜å‚¨å•å…ƒçš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å›NULLå¹¶è®¾ç½®errnoã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> ip_str[] = <span class="string">&quot;192.168.167.42&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">in_addr</span> in_ip;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">inet_pton</span>(AF_INET, ip_str, &amp;in_ip);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == ret)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip convert by inet_pton %u \n&quot;</span>, in_ip.s_addr);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ip_str2[<span class="number">1024</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip_str3 = <span class="built_in">inet_ntop</span>(AF_INET, &amp;in_ip, ip_str2, <span class="built_in">sizeof</span>(ip_str2));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ip_str3 == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;ip error \n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str2);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;address :%s \n&quot;</span>, ip_str3);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811220718920.png" alt="image-20220811220718920"></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯<code>ip_str2</code>å’Œ<code>ip_str3</code>çš„åœ°å€ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´ä¼ å…¥å‚æ•°å’Œè¿”å›å€¼ç›¸åŒï¼Œè™½ç„¶ä¸çŸ¥é“ä¸ºå•¥è¿™æ ·è®¾è®¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220811221357471.png" alt="image-20220811221357471"></p>
<h2 id="åˆ›å»ºsocket"><a href="#åˆ›å»ºsocket" class="headerlink" title="åˆ›å»ºsocket"></a>åˆ›å»ºsocket</h2><p>socketä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å¯ä»¥åˆ›å»ºä¸€ä¸ªsocket</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br></pre></td></tr></table></figure>
<p><code>domain</code>å‚æ•°æ˜¯å‘Šè¯‰ç³»ç»Ÿä½¿ç”¨çš„æ˜¯é‚£ä¸ªåº•å±‚åè®®æ—ï¼Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨IPv4ï¼Œæ‰€ä»¥ä½¿ç”¨<code>AF_INET</code>å³å¯ã€‚å…³äº<code>socket</code>ç³»ç»Ÿè°ƒç”¨æ”¯æŒçš„æ‰€æœ‰åè®®æ—ï¼Œå¯ä»¥æŸ¥çœ‹manæ‰‹å†Œï¼ˆè™½ç„¶å‚æ•°åä¸ä¸€æ ·ï¼Œä½†æ˜¯å¹¶æ— å¤§ç¢ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812095854483.png" alt="image-20220812095854483"></p>
<p><code>type</code>å‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ã€‚æœåŠ¡ç±»å‹ä¸»è¦æœ‰<code>SOCK_STREAM</code>æœåŠ¡ï¼ˆæµæœåŠ¡ï¼‰å’Œ<code>SOCK_UGRAM</code>ï¼ˆæ•°æ®æŠ¥ï¼‰æœåŠ¡ã€‚å¯¹TCP/IPåè®®æ—è€Œè¨€ï¼Œå…¶å€¼å–<code>SOCK_STREAM</code>è¡¨ç¤ºä¼ è¾“å±‚ä½¿ç”¨TCPåè®®ï¼Œå–<code>SOCK_DGRAM</code>è¡¨ç¤ºä¼ è¾“å±‚ä½¿ç”¨UDPåè®®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812101617247.png" alt="image-20220812101617247"></p>
<p>å¹¶ä¸”ä»Linuxå†…æ ¸2.6.17èµ·ï¼Œå¢åŠ äº†<code>SOCK_NONBLOCK</code>å’Œ<code>SOCK_CLOEXEC</code>è¿™ä¸¤ä¸ªæ ‡å¿—å€¼ï¼Œè¡¨ç¤ºå°†æ–°åˆ›å»ºçš„socketè®¾ä¸ºéé˜»å¡ï¼Œä»¥åŠforkè°ƒç”¨åˆ›å»ºå­è¿›ç¨‹æ—¶åœ¨å­è¿›ç¨‹ä¸­å…³é—­è¯¥socketã€‚åœ¨Linuxå†…æ ¸2.6.17å‰ï¼Œéœ€è¦è°ƒç”¨<code>fcntl</code>è¿›è¡Œè®¾ç½®ã€‚</p>
<p><code>protocol</code>å‚æ•°è®¾ç½®å…·ä½“çš„åè®®ã€‚ä½†æ˜¯åœ¨å‰ä¸¤ä¸ªå‚æ•°ç¡®å®šçš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå‚æ•°çš„å€¼åŸºæœ¬ä¸Šå”¯ä¸€çš„ï¼Œæ‰€æœ‰å‡ ä¹åœ¨æ‰€æœ‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºä½¿ç”¨é»˜è®¤åè®®ã€‚</p>
<p>socketç³»ç»Ÿè°ƒç”¨æˆåŠŸæ—¶è¿”å›ä¸€ä¸ªsocketæ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> lfd = <span class="number">0</span>;</span><br><span class="line">    lfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//åˆ›å»ºä¸€ä¸ª socket</span></span><br><span class="line">    close(lfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="å‘½åsocket"><a href="#å‘½åsocket" class="headerlink" title="å‘½åsocket"></a>å‘½åsocket</h2><p>åˆ›å»ºsocketæ—¶ï¼Œæˆ‘ä»¬æŒ‡å®šäº†åœ°å€æ—ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç»™å®šå…·ä½“çš„åœ°å€ï¼Œè¿™æ ·ä½œä¸ºæœåŠ¡å™¨åˆ«äººæ˜¯è®¿é—®ä¸åˆ°æˆ‘ä»¬çš„ã€‚å°†ä¸€ä¸ªsocket ä¸socketåœ°å€ç»‘å®šç§°ä¸ºç»™socketå‘½åã€‚å‘½åsocketçš„ç³»ç»Ÿè°ƒç”¨æ˜¯bindã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>bind</code>å°†<code>addr</code>æ‰€æŒ‡çš„socketåœ°å€åˆ†é…ç»™æœªå‘½åçš„<code>sockfd</code>æ–‡ä»¶æè¿°ç¬¦ï¼Œ<code>addrlen</code>å‚æ•°æŒ‡å‡ºè¯¥socketåœ°å€çš„é•¿åº¦ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812104757237.png" alt="image-20220812104757237"></p>
<p><code>bind</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å…¶ä¸­ä¸¤ç§å¸¸è§çš„<code>errno</code>æ˜¯<code>EACCES</code>å’Œ<code>EADDRINUSE</code>ï¼Œå®ƒä»¬çš„å«ä¹‰åˆ†åˆ«æ˜¯:</p>
<ul>
<li><code>EACCES</code>ï¼Œè¢«ç»‘å®šçš„åœ°å€æ˜¯å—ä¿æŠ¤çš„åœ°å€ï¼Œä»…è¶…çº§ç”¨æˆ·èƒ½å¤Ÿè®¿é—®ã€‚æ¯”å¦‚æ™®é€šç”¨æˆ·å°†socketç»‘å®šåˆ°çŸ¥åæœåŠ¡ç«¯å£ï¼ˆç«¯å£å·ä¸º0~1023ï¼‰ä¸Šæ—¶ï¼Œ<code>bind</code>å°†è¿”å›<code>EACCES</code>é”™è¯¯ã€‚</li>
<li><code>EADDRINUSE</code>ï¼Œè¢«ç»‘å®šçš„åœ°å€æ­£åœ¨ä½¿ç”¨ä¸­ã€‚æ¯”å¦‚å°†socketç»‘å®šåˆ°ä¸€ä¸ªå¤„äº<code>TIME_WAIT</code>çŠ¶æ€çš„socketåœ°å€ã€‚</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812105430276.png" alt="image-20220812105430276"></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERV_PORT 8080</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> lfd = <span class="number">0</span>, cfd = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serv_addr, clit_addr; <span class="comment">// å®šä¹‰æœåŠ¡å™¨åœ°å€ç»“æ„ å’Œ å®¢æˆ·ç«¯åœ°å€ç»“æ„</span></span><br><span class="line">    <span class="type">socklen_t</span> clit_addr_len;                 <span class="comment">// å®¢æˆ·ç«¯åœ°å€ç»“æ„å¤§å°</span></span><br><span class="line"></span><br><span class="line">    serv_addr.sin_family = AF_INET;                <span class="comment">// IPv4</span></span><br><span class="line">    serv_addr.sin_port = <span class="built_in">htons</span>(SERV_PORT);         <span class="comment">// è½¬ä¸ºç½‘ç»œå­—èŠ‚åºçš„ ç«¯å£å·</span></span><br><span class="line">    serv_addr.sin_addr.s_addr = <span class="built_in">htonl</span>(INADDR_ANY); <span class="comment">// è·å–æœ¬æœºä»»æ„æœ‰æ•ˆIP</span></span><br><span class="line"></span><br><span class="line">    lfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>); <span class="comment">//åˆ›å»ºä¸€ä¸ª socket</span></span><br><span class="line">    <span class="keyword">if</span> (lfd == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bind</span>(lfd, (<span class="keyword">struct</span> sockaddr *)&amp;serv_addr, <span class="built_in">sizeof</span>(serv_addr)); <span class="comment">//ç»™æœåŠ¡å™¨socketç»‘å®šåœ°å€ç»“æ„ï¼ˆIP+port)</span></span><br><span class="line">    <span class="built_in">close</span>(lfd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç›‘å¬socket"><a href="#ç›‘å¬socket" class="headerlink" title="ç›‘å¬socket"></a>ç›‘å¬socket</h2><p>socketè¢«å‘½ååï¼Œè¿˜éœ€è¦è°ƒç”¨<code>listen</code>åˆ›å»ºä¸€ä¸ªç›‘å¬é˜Ÿåˆ—æ¥å­˜æ”¾å¤„ç†çš„å®¢æˆ·è¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812112118847.png" alt="image-20220812112118847"></p>
<p><code>sockfd</code>å‚æ•°æŒ‡å®šè¢«ç›‘å¬çš„socketã€‚<code>backlog</code>å‚æ•°æç¤ºå†…æ ¸ç›‘å¬é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ã€‚ç›‘å¬é˜Ÿåˆ—çš„é•¿åº¦å¦‚æœè¶…è¿‡<code>backlog</code>ï¼ŒæœåŠ¡å™¨å°†ä¸å—ç†æ–°çš„å®¢æˆ·è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°†æ”¶åˆ°<code>ECONNREFUSED</code>é”™è¯¯ä¿¡æ¯ã€‚</p>
<p>åœ¨å†…æ ¸ç‰ˆæœ¬2.2ä¹‹å‰çš„Linuxä¸­ï¼Œ<code>backlog</code>å‚æ•°æ˜¯æŒ‡æ‰€æœ‰å¤„äºåŠè¿æ¥çŠ¶æ€ï¼ˆ<code>SYN_RCVD</code>ï¼‰å’Œå®Œå…¨è¿æ¥çŠ¶æ€ï¼ˆ<code>ESTABLISHED</code>)çš„socket çš„ä¸Šé™ã€‚ä½†è‡ªå†…æ ¸ç‰ˆæœ¬2.2ä¹‹åï¼Œå®ƒåªè¡¨ç¤ºå¤„äºå®Œå…¨è¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™ï¼Œå¤„äºåŠè¿æ¥çŠ¶æ€çš„socketçš„ä¸Šé™åˆ™ç”±<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>å†…æ ¸å‚æ•°å®šä¹‰ã€‚<code>backlog</code>å‚æ•°çš„å…¸å‹å€¼æ˜¯5ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812113608890.png" alt="image-20220812113608890"></p>
<p><code>listen</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>erron</code>ã€‚</p>
<p>æœ¬æ¥æƒ³æµ‹è¯•<code>backlog</code>è¿™ä¸ªå‚æ•°çš„æ•ˆæœï¼Œä½†æ˜¯æ€ä¹ˆä¹ŸæˆåŠŸä¸äº†ï¼Œä¸çŸ¥é“åŸå› ï¼Œä»¥åæœ‰æœºä¼šå†è¿›è¡Œå°è¯•å§ã€‚</p>
<h2 id="æ¥å—è¿æ¥"><a href="#æ¥å—è¿æ¥" class="headerlink" title="æ¥å—è¿æ¥"></a>æ¥å—è¿æ¥</h2><p>æ¥å—è¿æ¥é€šè¿‡<code>accept</code>è¿›è¡Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812143816774.png" alt="image-20220812143816774"></p>
<p><code>sockfd</code>æŒ‡æ‰§è¡Œè¿‡<code>listen</code>çš„ç›‘å¬å¥—æ¥å­—çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>addr</code>æ˜¯ä¼ å‡ºå‚æ•°ï¼Œç”¨æ¥è·å–æ¥å—è¿æ¥çš„è¿œç«¯socketåœ°å€ï¼Œåœ°å€çš„é•¿åº¦ç”±<code>addrlen</code>å‚æ•°æŒ‡å‡ºã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812151534158.png" alt="image-20220812151534158"></p>
<p>å¹¶ä¸”<strong>ä¹¦ä¸Šé¢çš„å®éªŒ</strong>è¯´æ˜äº†<code>accept</code>ç›´æ¥ä»ç›‘å¬é˜Ÿåˆ—ä¸­å–å‡ºè¿æ¥ï¼Œè€Œä¸è®ºè¿æ¥å¤„äºä½•ç§çŠ¶æ€ï¼Œæ›´ä¸å…³å¿ƒä»»ä½•ç½‘ç»œçŠ¶å†µçš„å˜åŒ–ã€‚æ¯”å¦‚ï¼šå®¢æˆ·ç«¯åœ¨æœåŠ¡å™¨<code>accept</code>ä¹‹å‰å°±æ–­ç½‘äº†ï¼Œ<code>accept</code>è¿˜æ˜¯å¯ä»¥æ­£å¸¸è¿›è¡Œï¼Œå®ƒå¹¶ä¸ä¼šè¿”å›é”™è¯¯ã€‚</p>
<h2 id="å‘èµ·è¿æ¥"><a href="#å‘èµ·è¿æ¥" class="headerlink" title="å‘èµ·è¿æ¥"></a>å‘èµ·è¿æ¥</h2><p>å‘åŠ¨è¿æ¥ä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯è¿›è¡Œçš„ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>connect</code>ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812154447716.png" alt="image-20220812154447716"></p>
<p><code>sockfd</code>å‚æ•°ç”±socketç³»ç»Ÿè°ƒç”¨è¿”å›ä¸€ä¸ª<code>socket</code>ã€‚<code>addr</code>å‚æ•°æ˜¯æœåŠ¡å™¨ç›‘å¬çš„<code>socket</code>åœ°å€ã€‚<code>addrlen</code>å‚æ•°æŒ‡è¿™ä¸ªåœ°å€é•¿åº¦ã€‚</p>
<p><code>connect</code>æˆåŠŸæ—¶è¿”å›0ã€‚ä¸€æ—¦æˆåŠŸå»ºç«‹è¿æ¥ï¼Œ<code>sockfd</code>å°±å”¯ä¸€åœ°æ ‡è¯†äº†è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯å°±å¯ä»¥é€šè¿‡è¯»å†™sockfdæ¥ä¸æœåŠ¡å™¨é€šä¿¡ã€‚<code>connect</code>å¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚å…¶ä¸­ä¸¤ç§å¸¸è§çš„<code>errno</code>æ˜¯<code>ECONNREFUSED</code>å’Œ<code>ETIMEDOUT</code>ï¼Œå®ƒä»¬çš„å«ä¹‰å¦‚ä¸‹:</p>
<ul>
<li><code>ECONNREFUSED</code>è¡¨ç¤ºç›®æ ‡ç«¯å£ä¸å­˜åœ¨ï¼Œè¿æ¥è¢«æ‹’ç»ã€‚</li>
<li><code>ETIMEDOUT</code>è¡¨ç¤ºè¿æ¥è¶…æ—¶ã€‚</li>
</ul>
<h2 id="å…³é—­è¿æ¥"><a href="#å…³é—­è¿æ¥" class="headerlink" title="å…³é—­è¿æ¥"></a>å…³é—­è¿æ¥</h2><p>å…³é—­è¿æ¥ä¸€èˆ¬æ¥è¯´ä½¿ç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure>
<p><code>fd</code>å‚æ•°æ˜¯å¾…å…³é—­çš„socketã€‚ä¸è¿‡ï¼Œ<code>close</code>å¹¶ä¸ä¼šç«‹å³å…³é—­è¿™ä¸ªè¿æ¥ï¼Œè€Œæ˜¯å°†<code>fd</code>çš„å¼•ç”¨æ•°é‡å‡1ï¼Œç›´åˆ°<code>fd</code>å¼•ç”¨æ•°é‡ä¸º0ï¼Œæ‰çœŸæ­£å…³é—­è¿æ¥ã€‚åœ¨å¤šè¿›ç¨‹ç¨‹åºä¸­ï¼Œä¸€æ¬¡<code>fork</code>ç³»ç»Ÿè°ƒç”¨é»˜è®¤å°†çˆ¶è¿›ç¨‹ä¸­<code>socket</code>çš„å¼•ç”¨è®¡ç®—åŠ 1ï¼Œå› æ­¤å¿…é¡»åœ¨å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹éƒ½å¯¹è¯¥<code>socket</code>è¿›è¡Œ<code>close</code>è°ƒç”¨æ‰èƒ½å°†è¿æ¥å…³é—­ã€‚</p>
<p>å¦‚æœæƒ³ç«‹åˆ»ç»ˆæ­¢è¿æ¥ï¼Œç›´æ¥è°ƒç”¨<code>shutdown</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">shutdown</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> how)</span>;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812160846669.png" alt="image-20220812160846669"></p>
<p><code>sockfd</code>å‚æ•°æ˜¯å¾…å…³é—­çš„socketï¼Œ<code>howto</code>å‚æ•°å†³å®šäº†<code>shutdown</code>çš„è¡Œä¸ºã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">å¯é€‰å€¼</th>
<th style="text-align:left">å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SHUT_RD</td>
<td style="text-align:left">å…³é—­sockfdä¸Šè¯»çš„è¿™ä¸€åŠã€‚åº”ç”¨ç¨‹åºä¸èƒ½å†é’ˆå¯¹socketæ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œè¯»æ“ä½œï¼Œå¹¶ä¸”è¯¥sockctæ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®éƒ½è¢«ä¸¢å¼ƒã€‚</td>
</tr>
<tr>
<td style="text-align:center">SHUT_WR</td>
<td style="text-align:left">å…³é—­sockfdä¸Šå†™çš„è¿™ä¸€åŠã€‚sockfd çš„å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®ä¼šåœ¨çœŸæ­£å…³é—­è¿æ¥ä¹‹å‰å…¨éƒ¨å‘é€å‡ºå»ï¼Œåº”ç”¨ç¨‹åºä¸å¯å†å¯¹è¯¥socketæ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œå†™æ“ä½œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿æ¥å¤„äºåŠå…³é—­çŠ¶æ€ã€‚</td>
</tr>
<tr>
<td style="text-align:center">SHUT_RDWR</td>
<td style="text-align:left">åŒæ—¶å…³é—­sockfdä¸Šçš„è¯»å’Œå†™ã€‚</td>
</tr>
</tbody>
</table>
</div>
<p>å¯ä»¥çœ‹å‡º<code>shutdown</code>å¯ä»¥çµæ´»çš„å…³é—­socketä¸Šçš„è¯»æˆ–å†™ã€‚è€Œ<code>close</code>åœ¨å…³é—­è¿æ¥æ—¶åªèƒ½å°†<code>socket</code>ä¸Šçš„è¯»å’Œå†™åŒæ—¶å…³é—­ã€‚</p>
<p><code>shutdown</code>æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<h2 id="æ•°æ®è¯»å†™"><a href="#æ•°æ®è¯»å†™" class="headerlink" title="æ•°æ®è¯»å†™"></a>æ•°æ®è¯»å†™</h2><h3 id="TCPæ•°æ®è¯»å†™"><a href="#TCPæ•°æ®è¯»å†™" class="headerlink" title="TCPæ•°æ®è¯»å†™"></a>TCPæ•°æ®è¯»å†™</h3><p>å¯¹æ–‡ä»¶çš„è¯»å†™æ“ä½œ<code>read</code>å’Œ<code>write</code>åŒæ ·é€‚ç”¨äºsocketã€‚ä½†æ˜¯socketç¼–ç¨‹æ¥å£æä¾›äº†å‡ ä¸ªä¸“é—¨ç”¨äºsocketæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒä»¬å¢åŠ äº†å¯¹æ•°æ®çš„è¯»å†™çš„æ§åˆ¶ã€‚åœ¨TCPä¸­æµæ•°æ®è¯»å†™çš„ç³»ç»Ÿè°ƒç”¨æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recv</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">send</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>recv</code>è¯»å–<code>sockfd</code>ä¸Šçš„æ•°æ®ï¼Œ<code>buf</code>å’Œ<code>len</code>å‚æ•°åˆ†åˆ«æŒ‡å®šè¯»ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚</p>
<p><code>recv</code>æˆåŠŸè¯»å–æ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®é•¿åº¦ï¼Œå®ƒå¯èƒ½å°äºæˆ‘ä»¬æœŸæœ›çš„é•¿åº¦<code>len</code>ã€‚å› æ­¤éœ€è¦å¤šæ¬¡è°ƒç”¨<code>recv</code>æ‰èƒ½è¯»å–åˆ°å®Œæ•´çš„æ•°æ®ã€‚<code>recv</code>è¿”å›0ï¼Œæ„å‘³ç€å¯¹æ–¹å·²ç»å…³é—­è¿æ¥ã€‚<code>recv</code>å‡ºé”™æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>send</code>å‘é€<code>sockfd</code>ä¸Šçš„æ•°æ®ã€‚<code>buf</code>å’Œ<code>len</code>å‚æ•°åˆ†åˆ«æŒ‡å®šå†™ç¼“å†²åŒºçš„ä½ç½®å’Œå¤§å°ã€‚</p>
<p><code>send</code>æˆåŠŸè¯»å–æ—¶è¿”å›å®é™…è¯»å–åˆ°çš„æ•°æ®é•¿åº¦ï¼Œå‡ºé”™æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p><code>flags</code>ç”¨äºæ§åˆ¶æ•°æ®çš„æ¥æ”¶å’Œå‘é€ï¼Œä¸€èˆ¬æ¥è¯´è®¾ç½®ä¸º0ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè®¾ç½®ï¼Œä»è€Œè¿›è¡Œæ§åˆ¶ã€‚</p>
<p>æ§åˆ¶å‚æ•°å¯ä»¥é€šè¿‡manæ‰‹å†Œè¿›è¡ŒæŸ¥çœ‹ï¼Œè¿™é‡Œç›´æ¥æˆªå–ä¹¦ä¸Šçš„è¡¨æ ¼</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220812171929139.png" alt="image-20220812171929139"></p>
<h3 id="UDPæ•°æ®è¯»å†™"><a href="#UDPæ•°æ®è¯»å†™" class="headerlink" title="UDPæ•°æ®è¯»å†™"></a>UDPæ•°æ®è¯»å†™</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr *src_addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendto</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *dest_addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p>é’ˆå¯¹UDPç³»ç»Ÿæä¾›çš„æ˜¯è¯»å†™å‡½æ•°æ˜¯<code>recvfrom</code>å’Œ<code>sendto</code>ï¼Œå…¶ä¸­å‡½æ•°<code>recvfrom</code>å’Œ<code>sendto</code>å‰4ä¸ªå‚æ•°å’Œ<code>recv</code>ã€<code>send</code>æ„ä¹‰ç›¸åŒï¼Œæœ€åä¸¤ä¸ªæ˜¯å‘é€ç«¯/æ¥æ”¶ç«¯çš„åœ°å€ã€‚å› ä¸ºUDPæ˜¯æ²¡æœ‰è¿æ¥çš„æ¦‚å¿µï¼Œæ‰€ä»¥è°ƒç”¨è¿™ä¸¤ä¸ªå‡½æ•°çš„æ—¶å€™éƒ½è¦æŒ‡å®šåœ°å€ã€‚<code>recvfrom</code>å’Œ<code>sendto</code>çš„è¿”å›å€¼å’Œ<code>recv</code>ã€<code>send</code>ä¹Ÿç›¸åŒï¼Œæ‰€ä»¥ä¸ç”¨è¿‡å¤šä»‹ç»ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œ<code>recvfrom</code>å’Œ<code>sendto</code>ä¹Ÿå¯ä»¥ç”¨äºTCPä½¿ç”¨ï¼Œåªéœ€è¦æŠŠæœ€åä¸¤ä¸ªå‚æ•°è®¾ç½®ä¸ºNULLå³å¯ã€‚</p>
<h3 id="é€šç”¨æ•°æ®è¯»å†™å‡½æ•°"><a href="#é€šç”¨æ•°æ®è¯»å†™å‡½æ•°" class="headerlink" title="é€šç”¨æ•°æ®è¯»å†™å‡½æ•°"></a>é€šç”¨æ•°æ®è¯»å†™å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvmsg</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> msghdr *msg, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendmsg</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> msghdr *msg, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>recvmsg</code>å’Œ<code>sendmsg</code>çš„å‚æ•°ä¸­<code>sockfd</code>å’Œ<code>flags</code>æ¯”è¾ƒç®€å•ï¼Œå¤æ‚ä¸€äº›çš„å‚æ•°å°±æ˜¯<code>msg</code>ã€‚<code>msg</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> &#123;</span>                    <span class="comment">/* Scatter/gather array items */</span></span><br><span class="line">   <span class="type">void</span>  *iov_base;              <span class="comment">/* Starting address */</span></span><br><span class="line">   <span class="type">size_t</span> iov_len;               <span class="comment">/* Number of bytes to transfer */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> &#123;</span></span><br><span class="line">   <span class="type">void</span>         *msg_name;       <span class="comment">/* Optional address */</span></span><br><span class="line">   <span class="type">socklen_t</span>     msg_namelen;    <span class="comment">/* Size of address */</span></span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> *<span class="title">msg_iov</span>;</span>        <span class="comment">/* Scatter/gather array */</span></span><br><span class="line">   <span class="type">size_t</span>        msg_iovlen;     <span class="comment">/* # elements in msg_iov */</span></span><br><span class="line">   <span class="type">void</span>         *msg_control;    <span class="comment">/* Ancillary data, see below */</span></span><br><span class="line">   <span class="type">size_t</span>        msg_controllen; <span class="comment">/* Ancillary data buffer len */</span></span><br><span class="line">   <span class="type">int</span>           msg_flags;      <span class="comment">/* Flags on received message */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>msg_name</code>æŒ‡å‘socketåœ°å€ï¼Œå¯¹äºTCPåè®®æ— æ„ä¹‰ï¼Œæ‰€ä»¥åœ¨TCPåè®®ä¸­è®¾ç½®ä¸ºNULLï¼Œè€Œå¯¹äºUDPç­‰å…¶ä»–åè®®å°±è¯´æ˜äº†å‘é€æˆ–è€…æ¥æ”¶çš„åœ°å€ã€‚<code>msg_namelen</code>æŒ‡å®šsocketåœ°å€çš„é•¿åº¦ã€‚</p>
<p><code>msg_iov</code>æ˜¯<code>iovec</code>ç±»å‹çš„æŒ‡é’ˆï¼Œæ ¹æ®æ³¨é‡Šæ¥åˆ¤æ–­åº”è¯¥æ˜¯ä¸ªæ•°ç»„ã€‚<code>iovec</code>ç»“æ„ä½“å°è£…äº†ä¸€å—å†…å­˜çš„èµ·å§‹ä½ç½®å’Œé•¿åº¦ã€‚<code>msg_iovlen</code>æŒ‡å®šè¿™æ ·çš„<code>iovec</code>ç»“æ„å¯¹è±¡æœ‰å¤šå°‘ä¸ªã€‚</p>
<p>å¯¹äº<code>recvmsg</code>è€Œè¨€ï¼Œæ•°æ®å°†è¢«è¯»å–å¹¶å­˜æ”¾åœ¨<code>msg_iovlen</code>å—åˆ†æ•£çš„å†…å­˜ä¸­ï¼Œè¿™äº›å†…å­˜çš„ä½ç½®å’Œé•¿åº¦åˆ™ç”±<code>msg_iov</code>æŒ‡å‘çš„æ•°ç»„æŒ‡å®šï¼Œè¿™ç§°ä¸ºåˆ†æ•£è¯»( scatter read);å¯¹äº<code>sendmsg</code>è€Œè¨€ï¼Œ<code>msg_iovlen</code>å—åˆ†æ•£å†…å­˜ä¸­çš„æ•°æ®å°†è¢«ä¸€å¹¶å‘é€ï¼Œè¿™ç§°ä¸ºé›†ä¸­å†™( gather write)ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦æœ‰åˆ†æ•£è¯»å’Œé›†ä¸­å†™å‘¢ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„ä½¿ç”¨ï¼Œæ–¹ä¾¿ä¼ è¾“ç»“æ„ä¸åŒçš„æ•°æ®ã€‚æ¯”å¦‚ï¼šå‘é€httpåº”ç­”æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå‰é¢çš„<strong>è¯·æ±‚å¤´</strong>å’Œ<strong>è¯·æ±‚çš„æ–‡ä»¶</strong>åˆ†ä¸ºä¸¤ä¸ªbufferï¼Œä½†æ˜¯æœ€ç»ˆä¸€èµ·è¿›è¡Œå†™å…¥ï¼Œå‡å°‘äº†æ‹¼æ¥å¸¦æ¥çš„éº»çƒ¦ã€‚åŒç†æˆ‘æ¥æ”¶çš„æ—¶å€™ä¹Ÿæ˜¯æƒ³<strong>è¯·æ±‚å¤´</strong>å’Œ<strong>è¯·æ±‚çš„æ–‡ä»¶</strong>åˆ†å¼€ï¼Œæ‰€ä»¥ä½¿ç”¨åˆ†æ•£è¯»ã€‚</p>
<p><code>msg_flags</code>æˆå‘˜æ— é¡»è®¾å®šï¼Œå®ƒä¼šå¤åˆ¶<code>recvmsg/sendmsg</code>çš„<code>flags</code>å‚æ•°çš„å†…å®¹ä»¥å½±å“æ•°æ®è¯»å†™è¿‡ç¨‹ã€‚<code>recvmsg</code>è¿˜ä¼šåœ¨è°ƒç”¨ç»“æŸå‰ï¼Œå°†æŸäº›æ›´æ–°åçš„æ ‡å¿—è®¾ç½®åˆ°<code>msg_flags</code>ä¸­ã€‚</p>
<p><code>recvmsg/sendmsg</code>çš„ <code>flags</code>å‚æ•°ä»¥åŠè¿”å›å€¼çš„å«ä¹‰å‡ä¸<code>sendrecv</code>çš„ <code>flags</code>å‚æ•°åŠè¿”å›å€¼ç›¸åŒã€‚</p>
<p><code>msg_control</code>å’Œ <code>msg_controllen</code>æˆå‘˜ç”¨äºè¾…åŠ©æ•°æ®çš„ä¼ é€ã€‚ç›®å‰ä¹¦ä¸­å¹¶æœªè¿›è¡Œè®²è§£ï¼Œåç»­å†è¡¥å……ã€‚</p>
<p><code>recvmsg</code>å’Œ<code>sendmsg</code>çš„ä¾‹å­ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 256</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line">		</span><br><span class="line">        <span class="type">char</span> buffer1[<span class="number">6</span>];</span><br><span class="line">        <span class="type">char</span> buffer2[BUFFER_SIZE];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">        bzero(&amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">        <span class="comment">//è®¾ç½®é›†ä¸­å†™</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_arry</span>[2];</span></span><br><span class="line">        iovec_arry[<span class="number">0</span>].iov_base = (<span class="type">void</span> *)buffer1;</span><br><span class="line">        iovec_arry[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(buffer1);</span><br><span class="line">        iovec_arry[<span class="number">1</span>].iov_base = (<span class="type">void</span> *)buffer2;</span><br><span class="line">        iovec_arry[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span>(buffer2);</span><br><span class="line"></span><br><span class="line">        msg.msg_iov = iovec_arry;</span><br><span class="line">        msg.msg_iovlen = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> n = recvmsg(connfd, &amp;msg, <span class="number">0</span>);</span><br><span class="line">        assert(n != <span class="number">-1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot; have recv %d byte msg1 %s and msg2 %s \n&quot;</span>, n, buffer1, buffer2);</span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>sendmsg</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = connect(sock, (<span class="keyword">struct</span> sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer1[] = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buffer2[] = <span class="string">&quot;world&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msghdr</span> <span class="title">msg</span>;</span></span><br><span class="line">    bzero(&amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line">    <span class="comment">// å› ä¸ºæ˜¯é’ˆå¯¹TCPï¼Œæ‰€ä»¥msg_nameæ— æ„ä¹‰</span></span><br><span class="line">    msg.msg_name = <span class="literal">NULL</span>;</span><br><span class="line">    msg.msg_namelen = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è®¾ç½®é›†ä¸­å†™</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">iovec_arry</span>[2];</span></span><br><span class="line">    iovec_arry[<span class="number">0</span>].iov_base = (<span class="type">void</span> *)buffer1;</span><br><span class="line">    iovec_arry[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(buffer1);</span><br><span class="line">    iovec_arry[<span class="number">1</span>].iov_base = (<span class="type">void</span> *)buffer2;</span><br><span class="line">    iovec_arry[<span class="number">1</span>].iov_len = <span class="keyword">sizeof</span>(buffer2);</span><br><span class="line"></span><br><span class="line">    msg.msg_iov = iovec_arry;</span><br><span class="line">    msg.msg_iovlen = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n = sendmsg(sock, &amp;msg, <span class="number">0</span>);</span><br><span class="line">    assert(n != <span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; have send %d byte msg1 %s and msg2 %s \n&quot;</span>, n, buffer1, buffer2);</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813123219330.png" alt="image-20220813123219330"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>recvmsg</code>åªæœ‰åœ¨å‰é¢çš„bufferä½¿ç”¨å®Œä¹‹åï¼Œæ‰ä¼šä½¿ç”¨åé¢çš„bufferã€‚è¿™ä¹Ÿæ˜¯ä¸ºå•¥æŠŠ<code>buffer1</code>çš„å¤§å°è®¾ç½®ä¸º6ã€‚</p>
<h2 id="åœ°å€ä¿¡æ¯å‡½æ•°"><a href="#åœ°å€ä¿¡æ¯å‡½æ•°" class="headerlink" title="åœ°å€ä¿¡æ¯å‡½æ•°"></a>åœ°å€ä¿¡æ¯å‡½æ•°</h2><p>å¦‚æœæˆ‘ä»¬è¦æŸ¥è¯¢ä¸€ä¸ªè¿æ¥socketçš„æœ¬ç«¯socketåœ°å€ï¼Œä»¥åŠè¿œç«¯çš„socketåœ°å€ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getsockname</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">getpeername</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>getsockname</code>è·å¾—<code>sockfd</code>å¯¹åº”çš„æœ¬ç«¯åœ°å€ï¼ˆæœ¬åœ°è‡ªå·±çš„åœ°å€ï¼‰ï¼Œ<code>getpeername</code>è·å¾—<code>sockfd</code>å¯¹åº”çš„è¿œç«¯åœ°å€ï¼ˆè¿œç«¯è¿æ¥çš„åœ°å€ï¼‰ã€‚ä¸¤ä¸ªå‡½æ•°éƒ½æŠŠåœ°å€å­˜å‚¨åœ¨<code>addr</code>å‚æ•°æŒ‡å®šçš„å†…å­˜ä¸­ï¼Œå°†è¯¥åœ°å€çš„é•¿åº¦å­˜æ”¾åœ¨<code>addrlen</code>å½“ä¸­ã€‚</p>
<p>å¦‚æœå®é™…socketåœ°å€çš„é•¿åº¦å¤§äº<code>addr</code>æ‰€æŒ‡å†…å­˜åŒºçš„å¤§å°ï¼Œé‚£ä¹ˆè¯¥socketåœ°å€å°†è¢«æˆªæ–­ã€‚ä¸¤ä¸ªå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>æˆ‘å†™äº†ä»£ç æµ‹è¯•äº†ä¸€ä¸‹ï¼Œä½¿ç”¨telnetè¿›è¡Œè¿æ¥</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 256</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    sockaddr_in address;</span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = bind(sock, (sockaddr *)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    ret = listen(sock, <span class="number">5</span>);</span><br><span class="line">    assert(ret != <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> client_addrlength = <span class="keyword">sizeof</span>(client);</span><br><span class="line">    <span class="type">int</span> connfd = accept(sock, (<span class="keyword">struct</span> sockaddr *)&amp;client, &amp;client_addrlength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;errno is: %d\n&quot;</span>, errno);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">char</span> remote[INET_ADDRSTRLEN];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;connected with ip: %s and port: %d\n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;client.sin_addr, remote, INET_ADDRSTRLEN), ntohs(client.sin_port));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾—æœ¬ç«¯åœ°å€</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen = <span class="keyword">sizeof</span>(addr);</span><br><span class="line">        ret = getsockname(connfd, (sockaddr *)&amp;addr, &amp;addrlen);</span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getsockname info ip: %s and port: %d , addrlen is %d \n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;addr.sin_addr, remote, INET_ADDRSTRLEN), ntohs(addr.sin_port), addrlen);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾—è¿œç«¯åœ°å€</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr2</span>;</span></span><br><span class="line">        <span class="type">socklen_t</span> addrlen2 = <span class="keyword">sizeof</span>(addr2);</span><br><span class="line">        ret = getpeername(connfd, (sockaddr *)&amp;addr2, &amp;addrlen2);</span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;getpeername info ip: %s and port: %d , addrlen is %d \n&quot;</span>,</span><br><span class="line">               inet_ntop(AF_INET, &amp;addr2.sin_addr, remote, INET_ADDRSTRLEN), ntohs(addr2.sin_port), addrlen2);</span><br><span class="line"></span><br><span class="line">        close(connfd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813163338463.png" alt="image-20220813163338463"></p>
<h2 id="socketé€‰é¡¹"><a href="#socketé€‰é¡¹" class="headerlink" title="socketé€‰é¡¹"></a>socketé€‰é¡¹</h2><p>è¯»å–å’Œè®¾ç½®socketæ–‡ä»¶æè¿°çš„æ–¹æ³•å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">void</span> *optval, <span class="type">socklen_t</span> *optlen)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname, <span class="type">const</span> <span class="type">void</span> *optval, <span class="type">socklen_t</span> optlen)</span>;</span><br></pre></td></tr></table></figure>
<p><code>sockfd</code>å‚æ•°æŒ‡å®šè¢«æ“çºµçš„ç›®æ ‡socketï¼Œ<code>level</code>å‚æ•°æŒ‡å®šè¦æ“ä½œçš„åè®®é€‰é¡¹ï¼Œ<code>optname</code>å‚æ•°åˆ™æŒ‡å®šé€‰é¡¹çš„åå­—ï¼Œ<code>optval</code>å’Œ<code>optlen</code>å‚æ•°åˆ†åˆ«æ˜¯æ“ä½œé€‰é¡¹çš„å€¼å’Œé•¿åº¦ã€‚æˆªå›¾äº†ä¸€ä¸‹ä¹¦ä¸­çš„è¡¨æ ¼ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/socketé€‰é¡¹.png" alt="socketé€‰é¡¹"></p>
<p><code>getsockopt</code>å’Œ<code>setsockopt</code>è¿™ä¸¤ä¸ªå‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥æ—¶è¿”å›-1å¹¶è®¾ç½®<code>errno</code>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨æœåŠ¡å™¨ç«¯<code>setsockopt</code>æœ€å¥½åœ¨<code>listen</code>ä¹‹å‰è¿›è¡Œè°ƒç”¨ï¼ˆå› ä¸ºè¿æ¥socketåªèƒ½ç”±acceptè°ƒç”¨è¿”å›ï¼Œè€Œaccept ä» listen ç›‘å¬é˜Ÿåˆ—ä¸­æ¥å—çš„è¿æ¥è‡³å°‘å·²ç»å®Œæˆäº†TCPä¸‰æ¬¡æ¡æ‰‹çš„å‰ä¸¤ä¸ªæ­¥éª¤ï¼‰ã€‚åŒç†ï¼Œå¯¹å®¢æˆ·ç«¯è€Œè¨€ï¼Œè¿™äº›socketé€‰é¡¹åˆ™åº”è¯¥åœ¨è°ƒç”¨connect å‡½æ•°ä¹‹å‰è®¾ç½®ï¼Œå› ä¸ºconnectè°ƒç”¨æˆåŠŸè¿”å›ä¹‹åï¼ŒTCä¸‰æ¬¡æ¡æ‰‹å·²å®Œæˆã€‚</p>
<h3 id="SO-REUSEADDR"><a href="#SO-REUSEADDR" class="headerlink" title="SO_REUSEADDR"></a>SO_REUSEADDR</h3><p>è®¾ç½®æœåŠ¡å™¨å¯ä»¥ç«‹å³é‡å¯ï¼Œä¸éœ€è¦ç­‰å¾…<code>TIME_WAIT</code>çŠ¶æ€è¿‡å»ï¼Œå¯ä»¥ä½¿ç”¨<code>SO_REUSEADDR</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> sock = socket( PF_INET, SOCK_STREAM, <span class="number">0</span> );</span><br><span class="line">assert( sock &gt;= <span class="number">0</span> );</span><br><span class="line"><span class="type">int</span> reuse = <span class="number">1</span>;</span><br><span class="line">setsockopt( sock, SOL_SOCKET, SO_REUSEADDR, &amp;reuse, <span class="keyword">sizeof</span>( reuse ) );</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡setsockoptçš„è®¾ç½®ä¹‹åï¼Œå³ä½¿sockå¤„äºTIME_WAITçŠ¶æ€ï¼Œä¸ä¹‹ç»‘å®šçš„socketåœ°å€ä¹Ÿå¯ä»¥ç«‹å³è¢«é‡ç”¨ã€‚</p>
<h3 id="SO-RCVBUFå’ŒSO-SNDBUF"><a href="#SO-RCVBUFå’ŒSO-SNDBUF" class="headerlink" title="SO_RCVBUFå’ŒSO_SNDBUF"></a>SO_RCVBUFå’ŒSO_SNDBUF</h3><p><code>SO_RCVBUF</code>å’Œ<code>SO_SNDBUF</code>åˆ†åˆ«è®¾ç½®TCPæ¥æ”¶ç¼“å†²åŒºå’Œå‘é€ç¼“å†²åŒºçš„å¤§å°ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨<code>setsockopt</code>è®¾ç½®TCPç¼“å†²åŒºå¤§å°æ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šå°†å…¶å€¼è¿›è¡ŒåŠ å€ï¼Œå¹¶ä¸”ä¸ä¼šå°äºæŸä¸ªå€¼ã€‚TCPæ¥æ”¶ç¼“å†²åŒºæœ€å°å€¼æ˜¯256å­—èŠ‚ï¼Œå‘é€ç¼“å†²åŒºæœ€å°æ˜¯2048å­—èŠ‚ã€‚å°å€¼æ˜¯2048å­—èŠ‚(ä¸è¿‡ï¼Œä¸åŒçš„ç³»ç»Ÿå¯èƒ½æœ‰ä¸åŒçš„é»˜è®¤æœ€å°å€¼)ã€‚ç³»ç»Ÿè¿™æ ·åšçš„ç›®çš„ï¼Œä¸»è¦æ˜¯ç¡®ä¿ä¸€ä¸ªTCPè¿æ¥æ‹¥æœ‰è¶³å¤Ÿçš„ç©ºé—²ç¼“å†²åŒºæ¥å¤„ç†æ‹¥å¡ï¼ˆæ¯”å¦‚å¿«é€Ÿé‡ä¼ ç®—æ³•å°±æœŸæœ›TCPæ¥æ”¶ç¼“å†²åŒºèƒ½è‡³å°‘å®¹çº³4ä¸ªå¤§å°ä¸ºSMSSçš„TCPæŠ¥æ–‡æ®µ)ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFER_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">4</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;usage: %s ip_address port_number receive_buffer_size\n&quot;</span>, basename(argv[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    bzero(&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    inet_pton(AF_INET, ip, &amp;address.sin_addr);</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    assert(sock &gt;= <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> recvbuf = atoi(argv[<span class="number">3</span>]);</span><br><span class="line">    <span class="type">int</span> len = <span class="keyword">sizeof</span>(recvbuf);</span><br><span class="line">    setsockopt(sock, SOL_SOCKET, SO_RCVBUF, &amp;recvbuf, <span class="keyword">sizeof</span>(recvbuf));</span><br><span class="line">    getsockopt(sock, SOL_SOCKET, SO_RCVBUF, &amp;recvbuf, (<span class="type">socklen_t</span> *)&amp;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the receive buffer size after settting is %d\n&quot;</span>, recvbuf);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> sendbuf = atoi(argv[<span class="number">4</span>]);</span><br><span class="line">    len = <span class="keyword">sizeof</span>(sendbuf);</span><br><span class="line">    setsockopt(sock, SOL_SOCKET, SO_SNDBUF, &amp;sendbuf, <span class="keyword">sizeof</span>(sendbuf));</span><br><span class="line">    getsockopt(sock, SOL_SOCKET, SO_SNDBUF, &amp;sendbuf, (<span class="type">socklen_t</span> *)&amp;len);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;the tcp send buffer size after setting is %d\n&quot;</span>, sendbuf);</span><br><span class="line"></span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220813180440008.png" alt="image-20220813180440008"></p>
<p>emmmä¸çŸ¥é“ä¸ºå•¥å¤§å°æ˜¯è¿™æ ·ï¼Œåç»­å†çœ‹çœ‹ã€‚</p>
<h2 id="ç½‘ç»œä¿¡æ¯API"><a href="#ç½‘ç»œä¿¡æ¯API" class="headerlink" title="ç½‘ç»œä¿¡æ¯API"></a>ç½‘ç»œä¿¡æ¯API</h2><p>socketå½“ä¸­ä¸¤è¦ç´ ï¼šIPå’Œç«¯å£å·ï¼Œéƒ½æ˜¯ç”¨æ•°å€¼è¡¨ç¤ºçš„ã€‚ä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸»æœºåä»£æ›¿IPï¼Œä½¿ç”¨æœåŠ¡åä»£æ›¿ç«¯å£å·ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">telnet 127.0.0.1 80</span><br><span class="line">telnet localhost www</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªåŠŸèƒ½å°±æ˜¯ä½¿ç”¨ç½‘ç»œä¿¡æ¯APIå®ç°çš„ã€‚</p>
<h3 id="gethostbynameå’Œgethostbyaddr"><a href="#gethostbynameå’Œgethostbyaddr" class="headerlink" title="gethostbynameå’Œgethostbyaddr"></a>gethostbynameå’Œgethostbyaddr</h3><p><code>gethostbyname</code>å‡½æ•°æ ¹æ®ä¸»æœºåç§°è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ï¼Œ<code>gethostbyaddr</code>å‡½æ•°æ ¹æ®IPåœ°å€è·å–ä¸»æœºçš„å®Œæ•´ä¿¡æ¯ã€‚<code>gethostbyname</code>å‡½æ•°é€šå¸¸å…ˆåœ¨æœ¬åœ°çš„<code>/etc/hosts</code>é…ç½®æ–‡ä»¶ä¸­æŸ¥æ‰¾ä¸»æœºï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå†å»è®¿é—®DNSæœåŠ¡å™¨ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> h_errno;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> hostent *<span class="title function_">gethostbyname</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>       <span class="comment">/* for AF_INET */</span></span></span><br><span class="line"><span class="keyword">struct</span> hostent *<span class="title function_">gethostbyaddr</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *addr, <span class="type">socklen_t</span> len, <span class="type">int</span> type)</span>;</span><br></pre></td></tr></table></figure>
<p><code>name</code>å‚æ•°è¡¨ç¤ºç›®æ ‡ä¸»æœºçš„ä¸»æœºåã€‚</p>
<p><code>addr</code>å‚æ•°æŒ‡å®šç›®æ ‡ä¸»æœºçš„IPåœ°å€ï¼Œ<code>len</code>å‚æ•°æŒ‡å®š<code>addr</code>çš„æ‰€æŒ‡å®šIPçš„é•¿åº¦</p>
<p><code>type</code>å‚æ•°æŒ‡å®šIPåœ°å€çš„ç±»å‹ï¼Œæ¯”å¦‚<code>AF_INET</code>ç­‰</p>
<p>å…¶ä¸­<code>hostent</code>å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> &#123;</span></span><br><span class="line">   <span class="type">char</span>  *h_name;            <span class="comment">/* official name of host */</span></span><br><span class="line">   <span class="type">char</span> **h_aliases;         <span class="comment">/* alias list */</span></span><br><span class="line">   <span class="type">int</span>    h_addrtype;        <span class="comment">/* host address type */</span></span><br><span class="line">   <span class="type">int</span>    h_length;          <span class="comment">/* length of address */</span></span><br><span class="line">   <span class="type">char</span> **h_addr_list;       <span class="comment">/* list of addresses */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å‚æ•°ä»‹ç»</p>
<p><code>h_name</code>:ä¸»æœºå<br><code>h_aliases</code>:ä¸»æœºåˆ«ååˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ª<br><code>h_addrtype</code>:åœ°å€ç±»å‹ï¼ˆåœ°å€æ—ï¼‰<br><code>h_length</code>:åœ°å€é•¿åº¦<br><code>h_addr_list</code>:æŒ‰ç½‘ç»œå­—èŠ‚åºåˆ—å‡ºçš„ä¸»æœºIPåœ°å€åˆ—è¡¨</p>
<p>ä»ç½‘ä¸Šæ‰¾äº†ä¸ªå›¾æ˜¾ç¤ºäº†ä¸€ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/Center.png" alt="img"></p>
<p><code>gethostbyname</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s www.baidu.com\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *name = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hptr</span>;</span></span><br><span class="line"></span><br><span class="line">    hptr = gethostbyname(name);</span><br><span class="line">    <span class="keyword">if</span> (hptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;gethostbyname error for host: %s: %s\n&quot;</span>, name, hstrerror(h_errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºå</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\tofficial: %s\n&quot;</span>, hptr-&gt;h_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºçš„åˆ«å</span></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="type">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">for</span> (pptr = hptr-&gt;h_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\talias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºipåœ°å€</span></span><br><span class="line">    <span class="keyword">switch</span> (hptr-&gt;h_addrtype)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> AF_INET:</span><br><span class="line">        pptr = hptr-&gt;h_addr_list;</span><br><span class="line">        <span class="keyword">for</span> (; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\taddress: %s\n&quot;</span>,</span><br><span class="line">                   inet_ntop(hptr-&gt;h_addrtype, *pptr, str, <span class="keyword">sizeof</span>(str)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;unknown address type\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814105118617.png" alt="image-20220814105118617"></p>
<p><code>gethostbyaddr</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 127.0.0.1\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">addr</span>;</span></span><br><span class="line"></span><br><span class="line">    inet_pton(AF_INET, ip, &amp;addr);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">hptr</span>;</span></span><br><span class="line"></span><br><span class="line">    hptr = gethostbyaddr(&amp;addr, <span class="keyword">sizeof</span>(addr), AF_INET);</span><br><span class="line">    <span class="keyword">if</span> (hptr == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;gethostbyaddr error for host: %s: %s\n&quot;</span>, ip, hstrerror(h_errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºå</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\tofficial: %s\n&quot;</span>, hptr-&gt;h_name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºä¸»æœºçš„åˆ«å</span></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="type">char</span> str[INET_ADDRSTRLEN];</span><br><span class="line">    <span class="keyword">for</span> (pptr = hptr-&gt;h_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\talias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è¾“å‡ºipåœ°å€</span></span><br><span class="line">    <span class="keyword">switch</span> (hptr-&gt;h_addrtype)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> AF_INET:</span><br><span class="line">        pptr = hptr-&gt;h_addr_list;</span><br><span class="line">        <span class="keyword">for</span> (; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\taddress: %s\n&quot;</span>,</span><br><span class="line">                   inet_ntop(hptr-&gt;h_addrtype, *pptr, str, <span class="keyword">sizeof</span>(str)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;unknown address type\n&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814105222471.png" alt="image-20220814105222471"></p>
<h3 id="getservbynameå’Œgetservbyport"><a href="#getservbynameå’Œgetservbyport" class="headerlink" title="getservbynameå’Œgetservbyport"></a>getservbynameå’Œgetservbyport</h3><p><code>getservbyname</code>å‡½æ•°æ ¹æ®åç§°è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ï¼Œ<code>getservbyport</code>å‡½æ•°æ ¹æ®ç«¯å£å·è·å–æŸä¸ªæœåŠ¡çš„å®Œæ•´ä¿¡æ¯ã€‚å®ƒä»¬å®é™…ä¸Šéƒ½æ˜¯é€šè¿‡è¯»å–<code>/etc/services</code>æ–‡ä»¶æ¥è·å–æœåŠ¡çš„ä¿¡æ¯çš„ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> servent *<span class="title function_">getservbyname</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *proto)</span>;</span><br><span class="line"><span class="keyword">struct</span> servent *<span class="title function_">getservbyport</span><span class="params">(<span class="type">int</span> port, <span class="type">const</span> <span class="type">char</span> *proto)</span>;</span><br></pre></td></tr></table></figure>
<p><code>name</code>å‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡çš„åå­—ã€‚</p>
<p><code>port</code>å‚æ•°æŒ‡å®šç›®æ ‡æœåŠ¡å¯¹åº”çš„ç«¯å£å·ã€‚</p>
<p><code>proto</code>å‚æ•°æŒ‡å®šæœåŠ¡ç±»å‹ï¼Œç»™å®ƒä¼ é€’â€œtcpâ€è¡¨ç¤ºè·å–æµæœåŠ¡ï¼Œç»™å®ƒä¼ é€’â€œudpâ€è¡¨ç¤ºè·å–æ•°æ®æŠ¥æœåŠ¡ï¼Œç»™å®ƒä¼ é€’NULLåˆ™è¡¨ç¤ºè·å–æ‰€æœ‰ç±»å‹çš„æœåŠ¡ã€‚</p>
<p>å‡½æ•°è¿”å›çš„<code>servent</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">servent</span> &#123;</span></span><br><span class="line">   <span class="type">char</span>  *s_name;       <span class="comment">/* official service name */</span></span><br><span class="line">   <span class="type">char</span> **s_aliases;    <span class="comment">/* alias list */</span></span><br><span class="line">   <span class="type">int</span>    s_port;       <span class="comment">/* port number */</span></span><br><span class="line">   <span class="type">char</span>  *s_proto;      <span class="comment">/* protocol to use */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>s_name</code>ï¼šæœåŠ¡åç§°</p>
<p><code>s_aliases</code>ï¼šæœåŠ¡åˆ«ååˆ—è¡¨ï¼Œå¯èƒ½æœ‰å¤šä¸ª</p>
<p><code>s_port</code>ï¼šç«¯å£å·</p>
<p><code>s_proto</code>ï¼šæœåŠ¡ç±»å‹ï¼Œé€šå¸¸æ˜¯tcpæˆ–è€…udp</p>
<p><code>getservbyname</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">servent</span> *<span class="title">servinfo</span> =</span> getservbyname(<span class="string">&quot;ssh&quot;</span>, <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line">    assert(servinfo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name is %s\n&quot;</span>, servinfo-&gt;s_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="keyword">for</span> (pptr = servinfo-&gt;s_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %d\n&quot;</span>, ntohs(servinfo-&gt;s_port));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;protocol is %s\n&quot;</span>, servinfo-&gt;s_proto);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814141312451.png" alt="image-20220814141312451"></p>
<p><code>getservbyport</code>ä¸¾ä¾‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> port = <span class="number">80</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">servent</span> *<span class="title">servinfo</span> =</span> getservbyport(htons(port), <span class="string">&quot;tcp&quot;</span>);</span><br><span class="line">    assert(servinfo);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;name is %s\n&quot;</span>, servinfo-&gt;s_name);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> **pptr;</span><br><span class="line">    <span class="keyword">for</span> (pptr = servinfo-&gt;s_aliases; *pptr != <span class="literal">NULL</span>; pptr++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, *pptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %d\n&quot;</span>, ntohs(servinfo-&gt;s_port));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;protocol is %s\n&quot;</span>, servinfo-&gt;s_proto);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814142922859.png" alt="image-20220814142922859"></p>
<p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œä¸Šé¢è®¨è®ºçš„4ä¸ªå‡½æ•°éƒ½æ˜¯ä¸å¯é‡å…¥çš„ï¼Œå³éçº¿ç¨‹å®‰å…¨çš„ã€‚ä¸è¿‡<code>netdb.h</code>å¤´æ–‡ä»¶ç»™å‡ºäº†å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚æ­£å¦‚Linuxä¸‹æ‰€æœ‰å…¶ä»–å‡½æ•°çš„å¯é‡å…¥ç‰ˆæœ¬çš„å‘½åè§„åˆ™é‚£æ ·ï¼Œè¿™äº›å‡½æ•°çš„å‡½æ•°åæ˜¯åœ¨åŸå‡½æ•°åå°¾éƒ¨åŠ ä¸Š_<code>r (re-entrant)</code>ã€‚</p>
<h3 id="getaddrinfo"><a href="#getaddrinfo" class="headerlink" title="getaddrinfo"></a>getaddrinfo</h3><p><code>getaddrinfo</code>å‡½æ•°æ—¢èƒ½é€šè¿‡ä¸»æœºåè·å¾—IPåœ°å€ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>gethostbyname</code>å‡½æ•°),ä¹Ÿèƒ½é€šè¿‡æœåŠ¡åè·å¾—ç«¯å£å·ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>getservbyname</code>å‡½æ•°)ã€‚å®ƒæ˜¯å¦å¯é‡äººå–å†³äºå…¶å†…éƒ¨è°ƒç”¨çš„<code>gethostbyname</code>å’Œ<code>getservbyname</code>å‡½æ•°æ˜¯å¦æ˜¯å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚è¯¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getaddrinfo</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *node, <span class="type">const</span> <span class="type">char</span> *service, <span class="type">const</span> <span class="keyword">struct</span> addrinfo *hints, <span class="keyword">struct</span> addrinfo **res)</span>;</span><br></pre></td></tr></table></figure>
<p><code>node</code>å‚æ•°å¯ä»¥æ¥æ”¶ä¸»æœºåï¼Œä¹Ÿå¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„IPåœ°å€ï¼Œç”¨ç‚¹åˆ†ååˆ†åˆ¶ã€‚</p>
<p><code>service</code>å‚æ•°å¯ä»¥æ¥æ”¶æœåŠ¡åï¼Œä¹Ÿå¯ä»¥æ¥æ”¶å­—ç¬¦ä¸²è¡¨ç¤ºçš„åè¿›åˆ¶ç«¯å£ã€‚</p>
<p><code>hints</code>å‚æ•°æ˜¯ç»™<code>getaddrinfo</code>çš„ä¸€ä¸ªæç¤ºï¼Œä»¥å¯¹<code>getaddrinfo</code>çš„è¾“å‡ºè¿›è¡Œæ›´ç²¾ç¡®çš„æ§åˆ¶ã€‚<code>hints</code>å‚æ•°å¯ä»¥è®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºå…è®¸<code>getaddrinfo</code>åé¦ˆä»»ä½•å¯ç”¨çš„ç»“æœã€‚</p>
<p><code>res</code>å‚æ•°è¿”å›ä¸€ä¸ªé“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨ç”¨äºå­˜å‚¨<code>getaddrinfo</code>åé¦ˆçš„ç»“æœã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨æˆ‘ä»¬è°ƒç”¨å®Œ<code>getaddrinfo</code>ä¹‹åï¼Œéœ€è¦ä½¿ç”¨<code>freeaddrinfo</code>å¯¹resè¿›è¡Œå†…å­˜é‡Šæ”¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">freeaddrinfo</span><span class="params">(<span class="keyword">struct</span> addrinfo *res)</span>;</span><br></pre></td></tr></table></figure>
<p><code>addrinfo</code>çš„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> &#123;</span></span><br><span class="line">   <span class="type">int</span>              ai_flags;</span><br><span class="line">   <span class="type">int</span>              ai_family;</span><br><span class="line">   <span class="type">int</span>              ai_socktype;</span><br><span class="line">   <span class="type">int</span>              ai_protocol;</span><br><span class="line">   <span class="type">socklen_t</span>        ai_addrlen;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> *<span class="title">ai_addr</span>;</span></span><br><span class="line">   <span class="type">char</span>            *ai_canonname;</span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">ai_next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>ai_family</code>ï¼šåœ°å€æ—ï¼Œæ¯”å¦‚ï¼š<code>AF_INET</code></p>
<p><code>ai_socktype</code>ï¼šæœåŠ¡ç±»å‹ï¼Œæ¯”å¦‚ï¼š<code>SOCK_STREAM</code></p>
<p><code>ai_protocol</code>ï¼šæŒ‡å…·ä½“çš„ç½‘ç»œåè®®</p>
<p><code>ai_addrlen</code>ï¼šåœ°å€<code>ai_addr</code>çš„é•¿åº¦</p>
<p><code>ai_addr</code>ï¼šæŒ‡å‘socketçš„åœ°å€</p>
<p><code>ai_canonname</code>ï¼šä¸»æœºçš„åˆ«å</p>
<p><code>ai_next</code>ï¼šé“¾è¡¨çš„ä¸‹ä¸€ä¸ªå¯¹è±¡</p>
<p><code>ai_flags</code>å¯ä»¥å–ä¸‹è¡¨ä¸­æ ‡å¿—</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814160248251.png" alt="image-20220814160248251"></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨hintså‚æ•°çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®å…¶<code>ai_flags</code>ï¼Œ<code>ai_family</code>ï¼Œ<code>ai_socktype</code>å’Œ<code>ai_protocol</code>å››ä¸ªå­—æ®µï¼Œå…¶ä»–å­—æ®µåˆ™å¿…é¡»è¢«è®¾ç½®ä¸ºNULLã€‚</p>
<p><strong>æ ¹æ®ä¸»æœºåè·å–IPåœ°å€ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s www.baidu.com\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *name = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">res</span>, *<span class="title">cur</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">char</span> ipbuf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</span><br><span class="line">    hints.ai_family = AF_INET;   <span class="comment">/* Allow IPv4 */</span></span><br><span class="line">    hints.ai_flags = AI_PASSIVE; <span class="comment">/* For wildcard IP address */</span></span><br><span class="line">    hints.ai_protocol = <span class="number">0</span>;       <span class="comment">/* Any protocol */</span></span><br><span class="line">    hints.ai_socktype = SOCK_STREAM;</span><br><span class="line"></span><br><span class="line">    ret = getaddrinfo(name, <span class="literal">NULL</span>, &amp;hints, &amp;res);</span><br><span class="line">    assert(ret &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (cur = res; cur != <span class="literal">NULL</span>; cur = cur-&gt;ai_next)</span><br><span class="line">    &#123;</span><br><span class="line">        addr = (<span class="keyword">struct</span> sockaddr_in *)cur-&gt;ai_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip: %s\n&quot;</span>, inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, ipbuf, cur-&gt;ai_addrlen));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, cur-&gt;ai_canonname);</span><br><span class="line">    &#125;</span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814165923059.png" alt="image-20220814165923059"></p>
<p>ä¸è¿‡ä¸çŸ¥é“ä¸ºå•¥åˆ«åä¸ºnull</p>
<p><strong>æ ¹æ®ä¸»æœºåå’Œç«¯å£å·è·å–åœ°å€ä¿¡æ¯ï¼š</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 80\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *port = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> *hostname = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> <span class="title">hints</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">addrinfo</span> *<span class="title">res</span>, *<span class="title">cur</span>;</span></span><br><span class="line">    <span class="type">int</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span>;</span></span><br><span class="line">    <span class="type">char</span> ipbuf[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;hints, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> addrinfo));</span><br><span class="line">    hints.ai_family = AF_UNSPEC; <span class="comment">/* Allow IPv4 */</span></span><br><span class="line">    hints.ai_flags = AI_PASSIVE; <span class="comment">/* For wildcard IP address */</span></span><br><span class="line">    hints.ai_protocol = <span class="number">0</span>;       <span class="comment">/* Any protocol */</span></span><br><span class="line">    hints.ai_socktype = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ret = getaddrinfo(hostname, port, &amp;hints, &amp;res);</span><br><span class="line"></span><br><span class="line">    assert(ret &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (cur = res; cur != <span class="literal">NULL</span>; cur = cur-&gt;ai_next)</span><br><span class="line">    &#123;</span><br><span class="line">        addr = (<span class="keyword">struct</span> sockaddr_in *)cur-&gt;ai_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ip: %s\n&quot;</span>, inet_ntop(AF_INET, &amp;addr-&gt;sin_addr, ipbuf, cur-&gt;ai_addrlen));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;port: %d\n&quot;</span>, ntohs(addr-&gt;sin_port));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alias: %s\n&quot;</span>, cur-&gt;ai_canonname);</span><br><span class="line">    &#125;</span><br><span class="line">    freeaddrinfo(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814170106763.png" alt="image-20220814170106763"></p>
<p>ä¸è¿‡ä¸çŸ¥é“ä¸ºå•¥åˆ«åä¸ºnull</p>
<h3 id="getnameinfo"><a href="#getnameinfo" class="headerlink" title="getnameinfo"></a>getnameinfo</h3><p><code>getnameinfo</code>å‡½æ•°èƒ½é€šè¿‡socketåœ°å€åŒæ—¶è·å¾—ä»¥å­—ç¬¦ä¸²è¡¨ç¤ºçš„<strong>ä¸»æœºå</strong>ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>gethostbyaddr</code>å‡½æ•°ï¼‰å’Œ<strong>æœåŠ¡å</strong>ï¼ˆå†…éƒ¨ä½¿ç”¨çš„æ˜¯<code>getservbyport</code>å‡½æ•°)ã€‚å®ƒæ˜¯å¦å¯é‡å…¥å–å†³äºå…¶å†…éƒ¨è°ƒç”¨çš„gethostbyaddrå’Œ getservbyportå‡½æ•°æ˜¯å¦æ˜¯å®ƒä»¬çš„å¯é‡å…¥ç‰ˆæœ¬ã€‚è¯¥å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getnameinfo</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> addrlen,<span class="type">char</span> *host, <span class="type">socklen_t</span> hostlen,</span></span><br><span class="line"><span class="params">                <span class="type">char</span> *serv, <span class="type">socklen_t</span> servlen, <span class="type">int</span> flags)</span>;</span><br></pre></td></tr></table></figure>
<p><code>getnameinfo</code>å°†è¿”å›çš„ä¸»æœºåå­˜å‚¨åœ¨hostå‚æ•°æŒ‡å‘çš„ç¼“å­˜ä¸­ï¼Œå°†æœåŠ¡åå­˜å‚¨åœ¨servå‚æ•°æŒ‡å‘çš„ç¼“å­˜ä¸­ï¼Œ<code>hostlen</code>å’Œ <code>servlen</code>å‚æ•°åˆ†åˆ«æŒ‡å®šè¿™ä¸¤å—ç¼“å­˜çš„é•¿åº¦ã€‚flagså‚æ•°æ§åˆ¶<code>getnameinfo</code>çš„è¡Œä¸ºï¼Œå®ƒå¯ä»¥æ¥æ”¶ä¸‹è¡¨ä¸­çš„é€‰é¡¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814171842523.png" alt="image-20220814171842523"></p>
<p><code>getaddrinfo</code>å’Œ <code>getnameinfo</code>å‡½æ•°æˆåŠŸæ—¶è¿”å›0ï¼Œå¤±è´¥åˆ™è¿”å›é”™è¯¯ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Use example: %s 127.0.0.1 80\n&quot;</span>, *argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="type">char</span> hostname[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> servername[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr_dst</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr_dst, <span class="number">0</span>, <span class="keyword">sizeof</span>(addr_dst));</span><br><span class="line">    addr_dst.sin_family = AF_INET;</span><br><span class="line">    addr_dst.sin_addr.s_addr = inet_addr(ip);</span><br><span class="line">    addr_dst.sin_port = htons(port);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;addr_dst, <span class="keyword">sizeof</span>(addr_dst), hostname, <span class="keyword">sizeof</span>(hostname), servername, <span class="keyword">sizeof</span>(servername), <span class="number">0</span>);</span><br><span class="line">    assert(ret == <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hostname IP: %s \n&quot;</span>, hostname);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;servername : %s \n&quot;</span>, servername);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/bugcat9/blog-image-bed@main/Linux/image-20220814181037933.png" alt="image-20220814181037933"></p>
]]></content>
      <categories>
        <category>Linuxç½‘ç»œç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹</tag>
        <tag>è®¡ç®—æœºç½‘ç»œ</tag>
        <tag>Linuxç½‘ç»œç¼–ç¨‹</tag>
      </tags>
  </entry>
</search>
